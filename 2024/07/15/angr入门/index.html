<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="韩乔落">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
            <link rel="preconnect" href="https://evan.beee.top" crossorigin>
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://jelasin.github.io/2024/07/15/angr入门/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="Angr简介本文主要通过angr_ctf 入门 angr。 符号执行 符号执行 （Symbolic Execution）是一种程序分析技术，它可以通过分析程序来得到让特定代码区域执行的输入。顾名思义，使用符号执行分析一个程序时，该程序会使用符号值作为输入，而非一般执行程序时使用的具体值。在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值。 Angr A">
<meta property="og:type" content="article">
<meta property="og:title" content="angr入门">
<meta property="og:url" content="https://jelasin.github.io/2024/07/15/angr%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Jelasin">
<meta property="og:description" content="Angr简介本文主要通过angr_ctf 入门 angr。 符号执行 符号执行 （Symbolic Execution）是一种程序分析技术，它可以通过分析程序来得到让特定代码区域执行的输入。顾名思义，使用符号执行分析一个程序时，该程序会使用符号值作为输入，而非一般执行程序时使用的具体值。在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值。 Angr A">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jelasin.github.io/2024/07/15/angr%E5%85%A5%E9%97%A8/image-20240717101443828.png">
<meta property="article:published_time" content="2024-07-15T07:18:14.000Z">
<meta property="article:modified_time" content="2024-07-18T08:41:00.570Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="angr">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jelasin.github.io/2024/07/15/angr%E5%85%A5%E9%97%A8/image-20240717101443828.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            angr入门 -
        
        Jelasin
    </title>

    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/assets/build/styles.css">
    

    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"jelasin.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":false,"family":"Farsan","url":"https://fonts.googleapis.com/css2?family=Farsan&display=swap"},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":false,"site_uv":false,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"“会当身由己，婉转入江湖”","subtitle":{"text":["Loading..."],"hitokoto":{"enable":true,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":null,"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.7.1","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Links":{"icon":"fa-regular fa-link","submenus":{"看雪":"https://bbs.kanxue.com/homepage-958172.htm","吾爱破解":"https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space","中国诗歌网":"https://www.zgshige.com/c/2022-04-13/21151100.shtml"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Essays":{"path":"/essays","icon":"fa-regular fa-comment"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"AI":{"path":"/AI","icon":"fa-brands fa-python"},"IOT":{"path":"/IOT","icon":"fas fa-network-wired"},"CTF":{"path":"/CTF","icon":"fa-solid fa-snowflake"},"Web":{"path":"/Web","icon":"fa-solid fa-shield"},"Linux":{"path":"/Linux","icon":"fa-brands fa-linux"},"Android":{"path":"/Android","icon":"fa-brands fa-android"},"Windows":{"path":"/Windows","icon":"fa-brands fa-windows"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":4},"tags":{"enable":true,"limit":4}},"footerStart":"2023/9/20 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/favicon.ico">
                </a>
            
            <a class="logo-title" href="/">
                
                Jelasin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-link fa-fw"></i>
                                    LINKS
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">
                                                    看雪
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">
                                                    吾爱破解
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">
                                                    中国诗歌网
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-Links"
                        >
                            <span>
                                LINKS
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-Links">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">看雪</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">吾爱破解</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">中国诗歌网</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/essays"
                        >
                            <span>Essays</span>
                            <i class="fa-regular fa-comment fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/AI"
                        >
                            <span>AI</span>
                            <i class="fa-brands fa-python fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/IOT"
                        >
                            <span>IOT</span>
                            <i class="fas fa-network-wired fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/CTF"
                        >
                            <span>CTF</span>
                            <i class="fa-solid fa-snowflake fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Web"
                        >
                            <span>Web</span>
                            <i class="fa-solid fa-shield fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Linux"
                        >
                            <span>Linux</span>
                            <i class="fa-brands fa-linux fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Android"
                        >
                            <span>Android</span>
                            <i class="fa-brands fa-android fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Windows"
                        >
                            <span>Windows</span>
                            <i class="fa-brands fa-windows fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">34</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">18</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">45</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">angr入门</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/touxiang.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">韩乔落</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-07-15 15:18:14</span>
        <span class="mobile">2024-07-15 15:18:14</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-07-18 16:41</span>
            <span class="mobile">2024-07-18 16:41</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Binary/">Binary</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/angr/">angr</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="Angr简介"><a href="#Angr简介" class="headerlink" title="Angr简介"></a>Angr简介</h1><p>本文主要通过<a class="link"   target="_blank" rel="noopener" href="https://github.com/jakespringer/angr_ctf/tree/master" >angr_ctf <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>入门 angr。</p>
<p><strong>符号执行</strong></p>
<p>符号执行 （Symbolic Execution）是一种程序分析技术，它可以通过分析程序来得到让特定代码区域执行的输入。顾名思义，使用符号执行分析一个程序时，该程序会使用符号值作为输入，而非一般执行程序时使用的具体值。在达到目标代码时，分析器可以得到相应的路径约束，然后通过约束求解器来得到可以触发目标代码的具体值。</p>
<p><strong>Angr</strong></p>
<p>Angr是加州大学圣芭芭拉分校基于Python设计的工具，它结合了静态分析技术与动态分析技术是当前符号化执行领域较为先进的工具，其挖掘漏洞效果好，在许多竞赛中表现卓越。Angr总的来说是一个多架构的二进制分析平台，具备对二进制文件的动态符号执行能力和多种静态分析能力。在逆向中，一般使用的其动态符号执行解出Flag，但其实Angr还在诸多领域存在应用，比如对程序脆弱性的分析中。</p>
<h1 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h1><p>IDA 静态分析：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">9</span>]; <span class="comment">// [esp+23h] [ebp-15h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s1[i] = complex_function(s1[i], i);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;JACEJGCS&quot;</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理函数</span></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">complex_function</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">64</span> || a1 &gt; <span class="number">90</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="number">3</span> * a2 + a1 - <span class="string">&#x27;A&#x27;</span>) % <span class="number">26</span> + <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这题基础题主要是熟悉一下Angr的基本使用步骤,一般来说使用Angr的步骤可以分为：</p>
<ul>
<li>创建 project</li>
<li>设置 state</li>
<li>新建符号量 : BVS (bitvector symbolic ) 或 BVV (bitvector value)</li>
<li>把符号量设置到内存或者其他地方</li>
<li>设置 Simulation Managers ， 进行路径探索的对象</li>
<li>运行，探索满足路径需要的值</li>
<li>约束求解，获取执行结果</li>
</ul>
<p><strong>scaffold00.py</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  <span class="comment"># Create an Angr project.</span></span><br><span class="line">  <span class="comment"># If you want to be able to point to the binary from the command line, you can</span></span><br><span class="line">  <span class="comment"># use argv[1] as the parameter. Then, you can run the script from the command</span></span><br><span class="line">  <span class="comment"># line as follows:</span></span><br><span class="line">  <span class="comment"># python ./scaffold00.py [binary]</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  path_to_binary = <span class="string">&quot;./00_angr_find&quot;</span>  <span class="comment"># :string</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tell Angr where to start executing (should it start from the main()</span></span><br><span class="line">  <span class="comment"># function or somewhere else?) For now, use the entry_state function</span></span><br><span class="line">  <span class="comment"># to instruct Angr to start from the main() function.</span></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a simulation manager initialized with the starting state. It provides</span></span><br><span class="line">  <span class="comment"># a number of useful tools to search and execute the binary.</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Explore the binary to attempt to find the address that prints &quot;Good Job.&quot;</span></span><br><span class="line">  <span class="comment"># You will have to find the address you want to find and insert it here. </span></span><br><span class="line">  <span class="comment"># This function will keep executing until it either finds a solution or it </span></span><br><span class="line">  <span class="comment"># has explored every possible path through the executable.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  print_good_address = <span class="number">0x8048678</span>  <span class="comment"># :integer (probably in hexadecimal)</span></span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Check that we have found a solution. The simulation.explore() method will</span></span><br><span class="line">  <span class="comment"># set simulation.found to a list of the states that it could find that reach</span></span><br><span class="line">  <span class="comment"># the instruction we asked it to search for. Remember, in Python, if a list</span></span><br><span class="line">  <span class="comment"># is empty, it will be evaluated as false, otherwise true.</span></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    <span class="comment"># The explore method stops after it finds a single state that arrives at the</span></span><br><span class="line">    <span class="comment"># target address.</span></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print the string that Angr wrote to stdin to follow solution_state. This </span></span><br><span class="line">    <span class="comment"># is our solution.</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># If Angr could not find a path that reaches print_good_address, throw an</span></span><br><span class="line">    <span class="comment"># error. Perhaps you mistyped the print_good_address?</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; python3 scaffold00.py</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,672 | angr.storage.memory_mixins.default_filler_mixin | The program is accessing register with an unspecified value. This could indicate unwanted behavior.</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,672 | angr.storage.memory_mixins.default_filler_mixin | angr will cope with this by generating an unconstrained symbolic variable and continuing. You can resolve this by:</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,672 | angr.storage.memory_mixins.default_filler_mixin | 1) setting a value to the initial state</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,672 | angr.storage.memory_mixins.default_filler_mixin | 2) adding the state option ZERO_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to make unknown regions hold null</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,673 | angr.storage.memory_mixins.default_filler_mixin | 3) adding the state option SYMBOL_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to suppress these messages.</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,674 | angr.storage.memory_mixins.default_filler_mixin | Filling register edi with 4 unconstrained bytes referenced from 0x80486b1 (__libc_csu_init+0x1 in 00_angr_find (0x80486b1))</span><br><span class="line">WARNING  | 2024-07-15 15:50:18,678 | angr.storage.memory_mixins.default_filler_mixin | Filling register ebx with 4 unconstrained bytes referenced from 0x80486b3 (__libc_csu_init+0x3 in 00_angr_find (0x80486b3))</span><br><span class="line">WARNING  | 2024-07-15 15:50:23,213 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffeff60 with 4 unconstrained bytes referenced from 0x819fb90 (strcmp+0x0 in libc.so.6 (0x9fb90))</span><br><span class="line">b&#x27;JXWVXRKX&#x27;</span><br></pre></td></tr></table></figure></div>

<h2 id="创建-project"><a href="#创建-project" class="headerlink" title="创建 project"></a>创建 project</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create an Angr project.</span></span><br><span class="line">path_to_binary = <span class="string">&quot;./00_angr_find&quot;</span> </span><br><span class="line">project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>使用angr的首要步骤就是创建Project加载二进制文件。angr的二进制装载组件是CLE，它负责装载二进制对象（以及它依赖的任何库）和把这个对象以易于操作的方式交给angr的其他组件。angr将这些包含在Project类中。一个Project类是代表了你的二进制文件的实体。你与angr的大部分操作都会经过它。auto_load_libs 设置是否自动载入依赖的库。</p>
<blockquote>
<ul>
<li>如果<code>auto_load_libs</code>是<code>True</code>（默认值），真正的库函数会被执行。一些libc的函数分析起来过于复杂并且很有可能引起path对其的尝试执行过程中的state数量的爆炸增长。</li>
<li>如果<code>auto_load_libs</code>是<code>False</code>，且外部函数是无法找到的，并且Project会将它们引用到一个通用的叫做<code>ReturnUnconstrained</code>的<code>SimProcedure</code>上去，它就像它的名字所说的那样：它返回一个不受约束的值</li>
</ul>
</blockquote>
<h2 id="设置-state"><a href="#设置-state" class="headerlink" title="设置 state"></a>设置 state</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tell Angr where to start executing (should it start from the main()</span></span><br><span class="line"><span class="comment"># function or somewhere else?) For now, use the entry_state function</span></span><br><span class="line"><span class="comment"># to instruct Angr to start from the main() function.</span></span><br><span class="line">initial_state = project.factory.entry_state()</span><br></pre></td></tr></table></figure></div>

<p>state 代表程序的一个实例镜像，模拟执行某个时刻的状态，就类似于<strong>快照</strong>。保存运行状态的上下文信息，如内存&#x2F;寄存器等,我们这里使用<code>project.factory.entry_state()</code>告诉符号执行引擎从程序的入口点开始符号执行，除了使用<code>.entry_state()</code> 创建 state 对象, 我们还可以根据需要使用其他构造函数创建 state。</p>
<h2 id="设置-Simulation-Managers"><a href="#设置-Simulation-Managers" class="headerlink" title="设置 Simulation Managers"></a>设置 Simulation Managers</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a simulation manager initialized with the starting state. It provides</span></span><br><span class="line"><span class="comment"># a number of useful tools to search and execute the binary.</span></span><br><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure></div>

<p>Project  对象仅表示程序一开始的样子，而在执行时，我们实际上是对SimState对象进行操作，它代表程序的一个实例镜像，模拟执行某个时刻的状态。<code>SimState</code> 对象包含程序运行时信息，如内存&#x2F;寄存器&#x2F;文件系统数据等。SM（Simulation Managers）是angr中最重要的控制接口，它使你能够同时控制一组状态(state)的符号执行，应用搜索策略来探索程序的状态空间。</p>
<h2 id="运行，探索满足路径需要的值"><a href="#运行，探索满足路径需要的值" class="headerlink" title="运行，探索满足路径需要的值"></a>运行，探索满足路径需要的值</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Explore the binary to attempt to find the address that prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># You will have to find the address you want to find and insert it here. </span></span><br><span class="line"><span class="comment"># This function will keep executing until it either finds a solution or it </span></span><br><span class="line"><span class="comment"># has explored every possible path through the executable.</span></span><br><span class="line">print_good_address = <span class="number">0x8048678</span></span><br><span class="line">simulation.explore(find=print_good_address)</span><br></pre></td></tr></table></figure></div>

<p>符号执行最普遍的操作是找到能够到达某个地址的状态，同时丢弃其他不能到达这个地址的状态。SM为使用这种执行模式提供了<code>.explore()</code>方法。当使用<code>find</code>参数启动<code>.explore()</code>方法时，程序将会一直执行，直到发现了一个和<code>find</code>参数指定的条件相匹配的状态。<code>find</code>参数的内容可以是想要执行到的某个地址、或者想要执行到的地址列表、或者一个获取state作为参数并判断这个state是否满足某些条件的函数。当<code>active</code>stash中的任意状态和<code>find</code>中的条件匹配的时候，它们就会被放到<code>found stash</code>中，执行随即停止。之后你可以探索找到的状态，或者决定丢弃它，转而探索其它状态。若能输出正确的字符串”Good Job”即代表我们的执行路径是正确的</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:08048675                 sub     esp, 0Ch</span><br><span class="line">.text:08048678                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:0804867D                 call    _puts</span><br><span class="line">.text:08048682                 add     esp, 10h</span><br></pre></td></tr></table></figure></div>

<h2 id="获取执行结果"><a href="#获取执行结果" class="headerlink" title="获取执行结果"></a>获取执行结果</h2><div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check that we have found a solution. The simulation.explore() method will</span></span><br><span class="line"><span class="comment"># set simulation.found to a list of the states that it could find that reach</span></span><br><span class="line"><span class="comment"># the instruction we asked it to search for. Remember, in Python, if a list</span></span><br><span class="line"><span class="comment"># is empty, it will be evaluated as false, otherwise true.</span></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    <span class="comment"># The explore method stops after it finds a single state that arrives at the</span></span><br><span class="line">    <span class="comment"># target address.</span></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># Print the string that Angr wrote to stdin to follow solution_state. This</span></span><br><span class="line">    <span class="comment"># is our solution.</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># If Angr could not find a path that reaches print_good_address, throw an</span></span><br><span class="line">    <span class="comment"># error. Perhaps you mistyped the print_good_address?</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>此时相关的状态已经保存在了<code>simgr</code>当中，我们可以通过<code>simgr.found</code>来访问所有符合条件的分支，这里我们为了解题，就选择第一个符合条件的分支即可。</p>
<p>这里解释一下<code>sys.stdin.fileno()</code>,在UNIX中，按照惯例，三个文件描述符分别表示标准输入、标准输出和标准错误。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stdin.fileno()</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stdout.fileno()</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.stderr.fileno()</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></div>

<p>所以一般也可以写成：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h1><p>这题主要是引入了<code>.explore()</code>方法的另一个参数void，我们可以看看这个方法的原型：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">explore</span>(<span class="params">self, stash=<span class="string">&#x27;active&#x27;</span>, n=<span class="literal">None</span>, find=<span class="literal">None</span>, avoid=<span class="literal">None</span>, find_stash=<span class="string">&#x27;found&#x27;</span>, avoid_stash=<span class="string">&#x27;avoid&#x27;</span>, cfg=<span class="literal">None</span>,um_find=<span class="number">1</span>, **kwargs</span>):</span><br></pre></td></tr></table></figure></div>

<p>只需要让执行流只进入maybe_good函数，而避免进入avoid_me函数即可，现在需要拿到这两个函数的地址，只要用r2分析即可。</p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = <span class="string">&quot;./01_angr_avoid&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Explore the binary, but this time, instead of only looking for a state that</span></span><br><span class="line">  <span class="comment"># reaches the print_good_address, also find a state that does not reach</span></span><br><span class="line">  <span class="comment"># will_not_succeed_address. The binary is pretty large, to save you some time,</span></span><br><span class="line">  <span class="comment"># everything you will need to look at is near the beginning of the address</span></span><br><span class="line">  <span class="comment"># space.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  print_good_address = <span class="number">0x080485E0</span></span><br><span class="line">  will_not_succeed_address = <span class="number">0x080485A8</span></span><br><span class="line">  simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<h1 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h1><p>题目本意是教会我们如何根据程序本身的输出来告诉angr应避免或保留的内容。因为有时候打开二进制文件将看到有很多打印“ Good  Job”的块，或“Try  Again”的块。每次都记录下这些块的所有起始地址是一个麻烦的的问题，这时候我们可以直接根据打印到stdout的内容告诉angr保留或丢弃状态。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+18h] [ebp-40h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">20</span>]; <span class="comment">// [esp+24h] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">20</span>]; <span class="comment">// [esp+38h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    s2[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(s2, <span class="string">&quot;VXRRJEUR&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">    s1[j] = complex_function(s1[j], j + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, s2) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># It is very useful to be able to search for a state that reaches a certain</span></span><br><span class="line"><span class="comment"># instruction. However, in some cases, you may not know the address of the</span></span><br><span class="line"><span class="comment"># specific instruction you want to reach (or perhaps there is no single</span></span><br><span class="line"><span class="comment"># instruction goal.) In this challenge, you don&#x27;t know which instruction</span></span><br><span class="line"><span class="comment"># grants you success. Instead, you just know that you want to find a state where</span></span><br><span class="line"><span class="comment"># the binary prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Angr is powerful in that it allows you to search for a states that meets an</span></span><br><span class="line"><span class="comment"># arbitrary condition that you specify in Python, using a predicate you define</span></span><br><span class="line"><span class="comment"># as a function that takes a state and returns True if you have found what you</span></span><br><span class="line"><span class="comment"># are looking for, and False otherwise.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = <span class="string">&quot;./02_angr_find_condition&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Define a function that checks if you have found the state you are looking</span></span><br><span class="line">  <span class="comment"># for.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># Dump whatever has been printed out by the binary so far into a string.</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return whether &#x27;Good Job.&#x27; has been printed yet.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Same as above, but this time check if the state should abort. If you return</span></span><br><span class="line">  <span class="comment"># False, Angr will continue to step the state. In this specific challenge, the</span></span><br><span class="line">  <span class="comment"># only time at which you will know you should abort is when the program prints</span></span><br><span class="line">  <span class="comment"># &quot;Try again.&quot;</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tell Angr to explore the binary and find any state that is_successful identfies</span></span><br><span class="line">  <span class="comment"># as a successful state by returning True.</span></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<h1 id="03-angr-simbolic-registers"><a href="#03-angr-simbolic-registers" class="headerlink" title="03_angr_simbolic_registers"></a>03_angr_simbolic_registers</h1><p>这题主要是因为angr在处理复杂格式的字符串scanf()输入的时候不是很好，我们可以直接将符号注入寄存器，也就是主要学会符号化寄存器。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __cdecl main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 user_input; // rax</span><br><span class="line">  <span class="built_in">int</span> v5; // [esp+4h] [ebp-14h]</span><br><span class="line">  <span class="built_in">int</span> v6; // [esp+8h] [ebp-10h]</span><br><span class="line">  <span class="built_in">int</span> v7; // [esp+Ch] [ebp-Ch]</span><br><span class="line">  <span class="built_in">int</span> v8; // [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  printf(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  user_input = get_user_input();</span><br><span class="line">  v7 = HIDWORD(user_input);</span><br><span class="line">  v5 = complex_function_1(user_input);</span><br><span class="line">  v6 = complex_function_2();</span><br><span class="line">  v8 = complex_function_3(v7);</span><br><span class="line">  <span class="keyword">if</span> ( v5 || v6 || v8 )</span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> get_user_input()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> v1; // [esp+0h] [ebp-18h] BYREF</span><br><span class="line">  <span class="built_in">int</span> v2; // [esp+4h] [ebp-14h] BYREF</span><br><span class="line">  <span class="built_in">int</span> v3[<span class="number">4</span>]; // [esp+8h] [ebp-10h] BYREF</span><br><span class="line"></span><br><span class="line">  v3[<span class="number">1</span>] = __readgsdword(0x14u);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%x %x %x&quot;</span>, &amp;v1, &amp;v2, v3);</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br><span class="line">.text:0804891E                 lea     ecx, [ebp+var_10]</span><br><span class="line">.text:08048921                 push    ecx</span><br><span class="line">.text:08048922                 lea     ecx, [ebp+var_14]</span><br><span class="line">.text:08048925                 push    ecx</span><br><span class="line">.text:08048926                 lea     ecx, [ebp+var_18]</span><br><span class="line">.text:08048929                 push    ecx</span><br><span class="line">.text:0804892A                 push    offset aXXX     ; <span class="string">&quot;%x %x %x&quot;</span></span><br><span class="line">.text:0804892F                 call    ___isoc99_scanf</span><br><span class="line">.text:08048934                 add     esp, 10h</span><br><span class="line">.text:08048937                 mov     ecx, [ebp+var_18]</span><br><span class="line">.text:0804893A                 mov     eax, ecx ;</span><br><span class="line">.text:0804893C                 mov     ecx, [ebp+var_14]</span><br><span class="line">.text:0804893F                 mov     ebx, ecx ; </span><br><span class="line">.text:08048941                 mov     ecx, [ebp+var_10]</span><br><span class="line">.text:08048944                 mov     edx, ecx ; </span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Angr doesn&#x27;t currently support reading multiple things with scanf (Ex: </span></span><br><span class="line"><span class="comment"># scanf(&quot;%u %u).) You will have to tell the simulation engine to begin the</span></span><br><span class="line"><span class="comment"># program after scanf is called and manually inject the symbols into registers.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = <span class="string">&quot;./03_angr_symbolic_registers&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Sometimes, you want to specify where the program should start. The variable</span></span><br><span class="line">  <span class="comment"># start_address will specify where the symbolic execution engine should begin.</span></span><br><span class="line">  <span class="comment"># Note that we are using blank_state, not entry_state.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  start_address = <span class="number">0x08048980</span>  <span class="comment"># :integer (probably hexadecimal)</span></span><br><span class="line">  initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a symbolic bitvector (the datatype Angr uses to inject symbolic</span></span><br><span class="line">  <span class="comment"># values into the binary.) The first parameter is just a name Angr uses</span></span><br><span class="line">  <span class="comment"># to reference it.</span></span><br><span class="line">  <span class="comment"># You will have to construct multiple bitvectors. Copy the two lines below</span></span><br><span class="line">  <span class="comment"># and change the variable names. To figure out how many (and of what size)</span></span><br><span class="line">  <span class="comment"># you need, dissassemble the binary and determine the format parameter passed</span></span><br><span class="line">  <span class="comment"># to scanf.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_size_in_bits = <span class="number">32</span>  <span class="comment"># :integer</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password_size_in_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Set a register to a symbolic value. This is one way to inject symbols into</span></span><br><span class="line">  <span class="comment"># the program.</span></span><br><span class="line">  <span class="comment"># initial_state.regs stores a number of convenient attributes that reference</span></span><br><span class="line">  <span class="comment"># registers by name. For example, to set eax to password0, use:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># initial_state.regs.eax = password0</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># You will have to set multiple registers to distinct bitvectors. Copy and</span></span><br><span class="line">  <span class="comment"># paste the line below and change the register. To determine which registers</span></span><br><span class="line">  <span class="comment"># to inject which symbol, dissassemble the binary and look at the instructions</span></span><br><span class="line">  <span class="comment"># immediately following the call to scanf.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the symbolic values. If there are multiple solutions, we only</span></span><br><span class="line">    <span class="comment"># care about one, so we can use eval, which returns any (but only one)</span></span><br><span class="line">    <span class="comment"># solution. Pass eval the bitvector you want to solve for.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.se.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Aggregate and format the solutions you computed above, and then print</span></span><br><span class="line">    <span class="comment"># the full string. Pay attention to the order of the integers, and the</span></span><br><span class="line">    <span class="comment"># expected base (decimal, octal, hexadecimal, etc).</span></span><br><span class="line">    solution = <span class="built_in">hex</span>(solution0) + <span class="string">&quot; &quot;</span> + <span class="built_in">hex</span>(solution1) + <span class="string">&quot; &quot;</span> + <span class="built_in">hex</span>(solution2)  <span class="comment"># :string</span></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<h2 id="states"><a href="#states" class="headerlink" title="states"></a>states</h2><h3 id="状态预设"><a href="#状态预设" class="headerlink" title="状态预设"></a>状态预设</h3><p>除了使用<code>.entry_state()</code> 创建 state 对象, 我们还可以根据需要使用其他构造函数创建 <code>state</code>:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>.entry_state()</code></td>
<td>构造一个已经准备好从函数入口点执行的状态</td>
</tr>
<tr>
<td><code>.blank_state</code></td>
<td>构造一个“空状态”，它的大多数数据都是未初始化的。当使用未初始化的的数据时，一个不受约束的符号值将会被返回</td>
</tr>
<tr>
<td><code>.call_state</code></td>
<td>构造一个已经准备好执行某个函数的状态</td>
</tr>
<tr>
<td><code>.full_init_state</code></td>
<td>构造一个已经执行过所有与需要执行的初始化函数，并准备从函数入口点执行的状态。比如，共享库构造函数（constructor）或预初始化器。当这些执行完之后，程序将会跳到入口点</td>
</tr>
</tbody></table>
<h3 id="位向量-bitvector"><a href="#位向量-bitvector" class="headerlink" title="位向量(bitvector)"></a>位向量(bitvector)</h3><p>符号位向量是angr用于将符号值注入程序的数据类型。这些将是angr将解决的方程式的“ x”，也就是约束求解时的自变量。可以通过 <code>BVV(value,size)</code> 和 <code>BVS( name, size)</code> 接口创建位向量，也可以用 FPV 和 FPS 来创建浮点值和符号</p>
<p>在这里我们使用claripy通过<code>BVS()</code>方法生成三个位向量。此方法有两个参数：第一个是angr用来引用位向量的名称，第二个是位向量本身的大小（以位为单位）。由于符号值存储在寄存器中，并且寄存器的长度为32位，因此位向量的大小将为32位</p>
<h3 id="访问寄存器"><a href="#访问寄存器" class="headerlink" title="访问寄存器"></a>访问寄存器</h3><p><code>get_user_input()</code>对输入进行了解析并将其放入三个寄存器中，我们可以通过 <code>state.regs</code> 对象的属性访问以及修改寄存器的数据</p>
<p>是时候把我们之前创建的符号位向量（<code>bitvectors</code>）放入属于他们的地方：寄存器<code>EAX</code>，<code>EBX</code>和<code>EDX</code>。我们将修改<code>initial_state</code>之前创建的内容并更新寄存器的内容。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.eax = passwd0</span><br><span class="line">initial_state.regs.ebx = passwd1</span><br><span class="line">initial_state.regs.edx = passwd2</span><br></pre></td></tr></table></figure></div>

<h3 id="约束求解"><a href="#约束求解" class="headerlink" title="约束求解"></a>约束求解</h3><p>可以通过使用<code>state.solver.eval(symbol)</code>对各个断言进行评测来求出一个合法的符号值（若有多个合法值，返回其中的一个），我们根据<code>eval()</code>之前注入的三个符号值调用求解器引擎的方法。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">solution0 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd0), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">solution1 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd1), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">solution2 = <span class="built_in">format</span>(solution_state.solver.<span class="built_in">eval</span>(passwd2), <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">solution = solution0 + <span class="string">&quot; &quot;</span> + solution1 + <span class="string">&quot; &quot;</span> + solution2</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution))</span><br></pre></td></tr></table></figure></div>

<h1 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h1><p>这题主要是学习如何符号化栈上的值。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  handle_user();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">handle_user</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2[<span class="number">3</span>]; <span class="comment">// [esp+Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %u&quot;</span>, v2, &amp;v1);</span><br><span class="line">  v2[<span class="number">0</span>] = complex_function0(v2[<span class="number">0</span>]);</span><br><span class="line">  v1 = complex_function1(v1);</span><br><span class="line">  <span class="keyword">if</span> ( v2[<span class="number">0</span>] == <span class="number">1999643857</span> &amp;&amp; v1 == <span class="number">-1136455217</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">.text:<span class="number">08048682</span>                 lea     eax, [ebp+var_10]</span><br><span class="line">.text:<span class="number">08048685</span>                 push    eax</span><br><span class="line">.text:<span class="number">08048686</span>                 lea     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08048689</span>                 push    eax</span><br><span class="line">.text:<span class="number">0804868</span>A                 push    offset aUU      ; <span class="string">&quot;%u %u&quot;</span></span><br><span class="line">.text:<span class="number">0804868F</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08048694</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08048697</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">0804869</span>A                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804869</span>D                 push    eax</span><br><span class="line">.text:<span class="number">0804869</span>E                 call    complex_function0</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge will be more challenging than the previous challenges that you</span></span><br><span class="line"><span class="comment"># have encountered thus far. Since the goal of this CTF is to teach symbolic</span></span><br><span class="line"><span class="comment"># execution and not how to construct stack frames, these comments will work you</span></span><br><span class="line"><span class="comment"># through understanding what is on the stack.</span></span><br><span class="line"><span class="comment">#   ! ! !</span></span><br><span class="line"><span class="comment"># IMPORTANT: Any addresses in this script aren&#x27;t necessarily right! Dissassemble</span></span><br><span class="line"><span class="comment">#            the binary yourself to determine the correct addresses!</span></span><br><span class="line"><span class="comment">#   ! ! !</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = <span class="string">&quot;./04_angr_symbolic_stack&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># For this challenge, we want to begin after the call to scanf. Note that this</span></span><br><span class="line">  <span class="comment"># is in the middle of a function.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This challenge requires dealing with the stack, so you have to pay extra</span></span><br><span class="line">  <span class="comment"># careful attention to where you start, otherwise you will enter a condition</span></span><br><span class="line">  <span class="comment"># where the stack is set up incorrectly. In order to determine where after</span></span><br><span class="line">  <span class="comment"># scanf to start, we need to look at the dissassembly of the call and the</span></span><br><span class="line">  <span class="comment"># instruction immediately following it:</span></span><br><span class="line">  <span class="comment">#   sub    $0x4,%esp</span></span><br><span class="line">  <span class="comment">#   lea    -0x10(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   lea    -0xc(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   push   $0x80489c3</span></span><br><span class="line">  <span class="comment">#   call   8048370 &lt;__isoc99_scanf@plt&gt;</span></span><br><span class="line">  <span class="comment">#   add    $0x10,%esp</span></span><br><span class="line">  <span class="comment"># Now, the question is: do we start on the instruction immediately following</span></span><br><span class="line">  <span class="comment"># scanf (add $0x10,%esp), or the instruction following that (not shown)?</span></span><br><span class="line">  <span class="comment"># Consider what the &#x27;add $0x10,%esp&#x27; is doing. Hint: it has to do with the</span></span><br><span class="line">  <span class="comment"># scanf parameters that are pushed to the stack before calling the function.</span></span><br><span class="line">  <span class="comment"># Given that we are not calling scanf in our Angr simulation, where should we</span></span><br><span class="line">  <span class="comment"># start?</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  start_address = <span class="number">0x08048697</span></span><br><span class="line">  initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># We are jumping into the middle of a function! Therefore, we need to account</span></span><br><span class="line">  <span class="comment"># for how the function constructs the stack. The second instruction of the</span></span><br><span class="line">  <span class="comment"># function is:</span></span><br><span class="line">  <span class="comment">#   mov    %esp,%ebp</span></span><br><span class="line">  <span class="comment"># At which point it allocates the part of the stack frame we plan to target:</span></span><br><span class="line">  <span class="comment">#   sub    $0x18,%esp</span></span><br><span class="line">  <span class="comment"># Note the value of esp relative to ebp. The space between them is (usually)</span></span><br><span class="line">  <span class="comment"># the stack space. Since esp was decreased by 0x18</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#        /-------- The stack --------\</span></span><br><span class="line">  <span class="comment"># ebp -&gt; |                           |</span></span><br><span class="line">  <span class="comment">#        |---------------------------|</span></span><br><span class="line">  <span class="comment">#        |                           |</span></span><br><span class="line">  <span class="comment">#        |---------------------------|</span></span><br><span class="line">  <span class="comment">#         . . . (total of 0x18 bytes)</span></span><br><span class="line">  <span class="comment">#         . . . Somewhere in here is</span></span><br><span class="line">  <span class="comment">#         . . . the data that stores</span></span><br><span class="line">  <span class="comment">#         . . . the result of scanf.</span></span><br><span class="line">  <span class="comment"># esp -&gt; |                           |</span></span><br><span class="line">  <span class="comment">#        \---------------------------/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Since we are starting after scanf, we are skipping this stack construction</span></span><br><span class="line">  <span class="comment"># step. To make up for this, we need to construct the stack ourselves. Let us</span></span><br><span class="line">  <span class="comment"># start by initializing ebp in the exact same way the program does.</span></span><br><span class="line">  initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line">  <span class="comment"># scanf(&quot;%u %u&quot;) needs to be replaced by injecting two bitvectors. The</span></span><br><span class="line">  <span class="comment"># reason for this is that Angr does not (currently) automatically inject</span></span><br><span class="line">  <span class="comment"># symbols if scanf has more than one input parameter. This means Angr can</span></span><br><span class="line">  <span class="comment"># handle &#x27;scanf(&quot;%u&quot;)&#x27;, but not &#x27;scanf(&quot;%u %u&quot;)&#x27;.</span></span><br><span class="line">  <span class="comment"># You can either copy and paste the line below or use a Python list.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_size_in_bits = <span class="number">32</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_in_bits)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Here is the hard part. We need to figure out what the stack looks like, at</span></span><br><span class="line">  <span class="comment"># least well enough to inject our symbols where we want them. In order to do</span></span><br><span class="line">  <span class="comment"># that, let&#x27;s figure out what the parameters of scanf are:</span></span><br><span class="line">  <span class="comment">#   sub    $0x4,%esp</span></span><br><span class="line">  <span class="comment">#   lea    -0x10(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   lea    -0xc(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   push   $0x80489c3</span></span><br><span class="line">  <span class="comment">#   call   8048370 &lt;__isoc99_scanf@plt&gt;</span></span><br><span class="line">  <span class="comment">#   add    $0x10,%esp </span></span><br><span class="line">  <span class="comment"># As you can see, the call to scanf looks like this:</span></span><br><span class="line">  <span class="comment"># scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span></span><br><span class="line">  <span class="comment">#      format_string    password0    password1</span></span><br><span class="line">  <span class="comment">#  From this, we can construct our new, more accurate stack diagram:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#            /-------- The stack --------\</span></span><br><span class="line">  <span class="comment"># ebp -&gt;     |          padding          |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x01 |       more padding        |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x02 |     even more padding     |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .               &lt;- How much padding? Hint: how</span></span><br><span class="line">  <span class="comment">#            |---------------------------|      many bytes is password0?</span></span><br><span class="line">  <span class="comment"># ebp - 0x0b |   password0, second byte  |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x0c |   password0, first byte   |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x0d |   password1, last byte    |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x10 |   password1, first byte   |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># esp -&gt;     |                           |</span></span><br><span class="line">  <span class="comment">#            \---------------------------/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Figure out how much space there is and allocate the necessary padding to</span></span><br><span class="line">  <span class="comment"># the stack by decrementing esp before you push the password bitvectors.</span></span><br><span class="line">  padding_length_in_bytes = <span class="number">0x8</span>  <span class="comment"># :integer</span></span><br><span class="line">  initial_state.regs.esp -= padding_length_in_bytes</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Push the variables to the stack. Make sure to push them in the right order!</span></span><br><span class="line">  <span class="comment"># The syntax for the following function is:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># initial_state.stack_push(bitvector)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This will push the bitvector on the stack, and increment esp the correct</span></span><br><span class="line">  <span class="comment"># amount. You will need to push multiple bitvectors on the stack.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.stack_push(password0)  <span class="comment"># :bitvector (claripy.BVS, claripy.BVV, claripy.BV)</span></span><br><span class="line">  initial_state.stack_push(password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;0&#125; &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(solution0, solution1))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<h2 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h2><ul>
<li><code>solver.eval(expression)</code> 将会解出一个可行解</li>
<li><code>solver.eval_one(expression)</code>将会给出一个表达式的可行解，若有多个可行解，则抛出异常。</li>
<li><code>solver.eval_upto(expression, n)</code>将会给出最多n个可行解，如果不足n个就给出所有的可行解。</li>
<li><code>solver.eval_exact(expression, n)</code>将会给出n个可行解，如果解的个数不等于n个，将会抛出异常。</li>
<li><code>solver.min(expression)</code>将会给出最小可行解</li>
<li><code>solver.max(expression)</code>将会给出最大可行解</li>
</ul>
<p>另外还有还有<code>cast_to</code>可以接收一个参数来指定把结果映射到哪种数据类型。目前这个参数只能是<code>str</code>，它将会以字符串形式展示返回的结果</p>
<h1 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h1><p><strong>程序逻辑</strong></p>
<ul>
<li>程序将四个8字节长的字符串作为输入</li>
<li>字符串分别位于以下地址<code>[0xA1BA1C0, 0xA1BA1C8, 0xA1BA1D0, 0xA1BA1D8]</code></li>
<li>输入的字符串循环输入<code>complex_function()</code>函数进行变换</li>
<li>循环变换后的字符串与 <code>&quot;NJPURZPCDYEAXCSJZJMPSOMBFDDLHBVN&quot;</code>比较前0x20个字符</li>
</ul>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __cdecl main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> i; // [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  memset(user_input, <span class="number">0</span>, 0x21u);</span><br><span class="line">  printf(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s %8s %8s %8s&quot;</span>, user_input, &amp;unk_A1BA1C8, &amp;unk_A1BA1D0, &amp;unk_A1BA1D8);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">0xA1BA1C0</span>) = complex_function(*(char *)(i + <span class="number">169583040</span>), i);</span><br><span class="line">  <span class="keyword">if</span> ( !strncmp(user_input, <span class="string">&quot;NJPURZPCDYEAXCSJZJMPSOMBFDDLHBVN&quot;</span>, 0x20u) )</span><br><span class="line">    puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">  path_to_binary = <span class="string">&quot;./05_angr_symbolic_memory&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x8048601</span></span><br><span class="line">  initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s %8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_size_in_bits = <span class="number">64</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;passwd0&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;passwd1&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;passwd2&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password3 = claripy.BVS(<span class="string">&#x27;passwd3&#x27;</span>, password_size_in_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Determine the address of the global variable to which scanf writes the user</span></span><br><span class="line">  <span class="comment"># input. The function &#x27;initial_state.memory.store(address, value)&#x27; will write</span></span><br><span class="line">  <span class="comment"># &#x27;value&#x27; (a bitvector) to &#x27;address&#x27; (a memory location, as an integer.) The</span></span><br><span class="line">  <span class="comment"># &#x27;address&#x27; parameter can also be a bitvector (and can be symbolic!).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0_address = <span class="number">0xA1BA1C0</span></span><br><span class="line">  password1_address = <span class="number">0xA1BA1C8</span></span><br><span class="line">  password2_address = <span class="number">0xA1BA1D0</span></span><br><span class="line">  password3_address = <span class="number">0xA1BA1D8</span></span><br><span class="line">  initial_state.memory.store(password0_address, password0)</span><br><span class="line">  initial_state.memory.store(password1_address, password1)</span><br><span class="line">  initial_state.memory.store(password2_address, password2)</span><br><span class="line">  initial_state.memory.store(password3_address, password3)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># Solve for the symbolic values. We are trying to solve for a string.</span></span><br><span class="line">    <span class="comment"># Therefore, we will use eval, with named parameter cast_to=str</span></span><br><span class="line">    <span class="comment"># which returns a string instead of an integer.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    solution2 = solution_state.se.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    solution3 = solution_state.se.<span class="built_in">eval</span>(password3,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    solution = solution0 + <span class="string">b&quot; &quot;</span> + solution1 + <span class="string">b&quot; &quot;</span> + solution2 + <span class="string">b&quot; &quot;</span> + solution3</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure></div>

<h2 id="state-memery"><a href="#state-memery" class="headerlink" title="state.memery"></a>state.memery</h2><p>前面提到可以通过 <code>state.mem[index]</code> 访问内存，但对于一段连续内存的操作十分不方便。因此我们也可以使用 <code>state.memory</code>  的  <code>.load(addr, size) 或者 .store(addr, val)</code>  接口读写内存, size 以 bytes 为单位</p>
<p>这些函数的原型：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, addr, size=<span class="literal">None</span>, condition=<span class="literal">None</span>, fallback=<span class="literal">None</span>, add_constraints=<span class="literal">None</span>, action=<span class="literal">None</span>,                          endness=<span class="literal">None</span>,inspect=<span class="literal">True</span>, disable_actions=<span class="literal">False</span>, ret_on_segv=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Loads size bytes from dst.</span></span><br><span class="line"><span class="string">        :param addr:             The address to load from. #读取的地址</span></span><br><span class="line"><span class="string">        :param size:            The size (in bytes) of the load. #大小</span></span><br><span class="line"><span class="string">        :param condition:       A claripy expression representing a condition for a conditional load.</span></span><br><span class="line"><span class="string">        :param fallback:        A fallback value if the condition ends up being False. </span></span><br><span class="line"><span class="string">        :param add_constraints: Add constraints resulting from the merge (default: True).</span></span><br><span class="line"><span class="string">        :param action:          A SimActionData to fill out with the constraints.</span></span><br><span class="line"><span class="string">        :param endness:         The endness to load with. #端序</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">self, addr, data, size=<span class="literal">None</span>, condition=<span class="literal">None</span>, add_constraints=<span class="literal">None</span>, endness=<span class="literal">None</span>, action=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                inspect=<span class="literal">True</span>, priv=<span class="literal">None</span>, disable_actions=<span class="literal">False</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Stores content into memory.</span></span><br><span class="line"><span class="string">        :param addr:        A claripy expression representing the address to store at. #内存地址</span></span><br><span class="line"><span class="string">        :param data:        The data to store (claripy expression or something convertable to a claripy expression).#写入的数据</span></span><br><span class="line"><span class="string">        :param size:        A claripy expression representing the size of the data to store. #大小</span></span><br><span class="line"><span class="string">        ...</span></span><br></pre></td></tr></table></figure></div>

<h1 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h1><p>这题主要是学会符号化动态内存，这个题与上题没有太大区别，除了字符串的内存是通过<code>malloc()</code>分配的。</p>
<p><strong>程序逻辑</strong></p>
<ul>
<li>程序使用<code>malloc()</code>函数分配出了两个大小为9字节的缓冲区，并将其初始化为0</li>
<li>然后将两个字符串以<code>scanf(&quot;%8s %8s&quot;)</code>作为格式化字符串分别输入进缓冲区内</li>
<li>然后利用<code>complex_function()</code>函数分别对两个字符串进行变换</li>
<li>然后将变换后的字符串分别与**”UODXLZBI”<strong>和</strong>“UAORRAYF”**进行比较</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp-10h] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+0h] [ebp-Ch]</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * 我们可以看到malloc()分配了两个缓冲区，因为maclloc()函数只有一个参数，申请9字节大小不满一个chunk，</span></span><br><span class="line"><span class="comment">   * 会申请 0x20 大小的chunk。根据mov ds:buffer0, eax和mov ds:buffer1, </span></span><br><span class="line"><span class="comment">   * eax得知开辟后的缓冲区被复制到标识为buffer0和buffer1的两个存储区中</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  buffer0 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line">  buffer1 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer0, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer1, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s %8s&quot;</span>, buffer0, buffer1, v6);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = &amp;buffer0[i];</span><br><span class="line">    *v3 = complex_function(buffer0[i], i);</span><br><span class="line">    v4 = &amp;buffer1[i];</span><br><span class="line">    *v4 = complex_function(buffer1[i], i + <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buffer0, <span class="string">&quot;UODXLZBI&quot;</span>, <span class="number">8u</span>) &amp;&amp; !<span class="built_in">strncmp</span>(buffer1, <span class="string">&quot;UAORRAYF&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(buffer0);</span><br><span class="line">  <span class="built_in">free</span>(buffer1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&quot;./06_angr_symbolic_dynamic_memory&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  <span class="comment"># 跳过所有`malloc()`，稍后将在脚本中处理它们。</span></span><br><span class="line">  start_address = <span class="number">0x8048699</span></span><br><span class="line">  initial_state = project.factory.blank_state(addr=start_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="comment"># 因为缓冲区的大小是8字节，故换算成比特即为64比特的大小，最后我们初始化两个大小为64位的符号位向量</span></span><br><span class="line">  password_size_in_bits = <span class="number">64</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_in_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_in_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Instead of telling the binary to write to the address of the memory</span></span><br><span class="line">  <span class="comment"># allocated with malloc, we can simply fake an address to any unused block of</span></span><br><span class="line">  <span class="comment"># memory and overwrite the pointer to the data. This will point the pointer</span></span><br><span class="line">  <span class="comment"># with the address of pointer_to_malloc_memory_address0 to fake_heap_address.</span></span><br><span class="line">  <span class="comment"># Be aware, there is more than one pointer! Analyze the binary to determine</span></span><br><span class="line">  <span class="comment"># global location of each pointer.</span></span><br><span class="line">  <span class="comment"># Note: by default, Angr stores integers in memory with big-endianness. To</span></span><br><span class="line">  <span class="comment"># specify to use the endianness of your architecture, use the parameter</span></span><br><span class="line">  <span class="comment"># endness=project.arch.memory_endness. On x86, this is little-endian.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="comment"># 之前buffer指向的是malloc分配好的内存地址，string存在这里。现在是buffer指向的是我们伪造的地址，符号位向量存在这里。</span></span><br><span class="line">  fake_heap_address0 = <span class="number">0xffffc93c</span></span><br><span class="line">  pointer_to_malloc_memory_address0 = <span class="number">0xabcc8a4</span></span><br><span class="line">  fake_heap_address1 = <span class="number">0xffffc95c</span></span><br><span class="line">  pointer_to_malloc_memory_address1 = <span class="number">0xabcc8ac</span></span><br><span class="line">  <span class="comment"># 参数 endness 用于设置端序，angr默认为大端序，总共可选的值如下：</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  LE – 小端序(little endian, least significant byte is stored at lowest address)</span></span><br><span class="line"><span class="string">  BE – 大端序(big endian, most significant byte is stored at lowest address)</span></span><br><span class="line"><span class="string">  ME – 中间序(Middle-endian. Yep.)</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Store our symbolic values at our fake_heap_address. Look at the binary to</span></span><br><span class="line">  <span class="comment"># determine the offsets from the fake_heap_address where scanf writes.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">  initial_state.memory.store(fake_heap_address1, password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.se.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    solution1 = solution_state.se.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    solution = solution0 + <span class="string">b&quot; &quot;</span> + solution1</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h1><p>这题主要学习如何符号化一个文件里面的内容：</p>
<p><strong>程序逻辑</strong></p>
<p>我们可以得知程序使用<code>fread</code>函数从文件中加载密码，如果密码正确，则会打印<code>&quot;Good Job&quot;</code>。<code>ignore_me</code>主要是把第一个读取的内容存入<code>OJKSQYDP.txt</code>， 不用我们自己创建文件 ,然后从文件<code>OJKSQYDP.txt</code>读取数据存入<code>buff</code>。</p>
<ul>
<li>读取一个名叫’OJKSQYDP.txt’的文件作为密码</li>
<li>我们需要使用Angr模拟一个文件系统，其中该文件被我们自己的模拟文件所替代</li>
<li>然后将该文件进行符号化处理</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%64s&quot;</span>, buffer);</span><br><span class="line">  ignore_me((<span class="type">int</span>)buffer, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">  fp = fopen(<span class="string">&quot;OJKSQYDP.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  fread(buffer, <span class="number">1u</span>, <span class="number">0x40</span>u, fp);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  unlink(<span class="string">&quot;OJKSQYDP.txt&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">134520992</span>) = complex_function(*(<span class="type">char</span> *)(i + <span class="number">134520992</span>), i);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buffer, <span class="string">&quot;AQWLCTXB&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title function_">ignore_me</span><span class="params">(<span class="type">void</span> *a1, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v2; <span class="comment">// esp</span></span><br><span class="line">  _BYTE v4[<span class="number">12</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  <span class="type">void</span> *s; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  ptr = a1;</span><br><span class="line">  v9 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v6 = n - <span class="number">1</span>;</span><br><span class="line">  v2 = alloca(<span class="number">16</span> * ((n + <span class="number">15</span>) / <span class="number">0x10</span>));</span><br><span class="line">  s = v4;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, n);</span><br><span class="line">  unlink(<span class="string">&quot;OJKSQYDP.txt&quot;</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;OJKSQYDP.txt&quot;</span>, <span class="string">&quot;a+b&quot;</span>);</span><br><span class="line">  fwrite(ptr, <span class="number">1u</span>, n, stream);</span><br><span class="line">  fseek(stream, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  __isoc99_fscanf(stream, <span class="string">&quot;%64s&quot;</span>, s);</span><br><span class="line">  fseek(stream, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  fwrite(s, <span class="number">1u</span>, n, stream);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge could, in theory, be solved in multiple ways. However, for the</span></span><br><span class="line"><span class="comment"># sake of learning how to simulate an alternate filesystem, please solve this</span></span><br><span class="line"><span class="comment"># challenge according to structure provided below. As a challenge, once you have</span></span><br><span class="line"><span class="comment"># an initial solution, try solving this in an alternate way.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Problem description and general solution strategy:</span></span><br><span class="line"><span class="comment"># The binary loads the password from a file using the fread function. If the</span></span><br><span class="line"><span class="comment"># password is correct, it prints &quot;Good Job.&quot; In order to keep consistency with</span></span><br><span class="line"><span class="comment"># the other challenges, the input from the console is written to a file in the </span></span><br><span class="line"><span class="comment"># ignore_me function. As the name suggests, ignore it, as it only exists to</span></span><br><span class="line"><span class="comment"># maintain consistency with other challenges.</span></span><br><span class="line"><span class="comment"># We want to:</span></span><br><span class="line"><span class="comment"># 1. Determine the file from which fread reads.</span></span><br><span class="line"><span class="comment"># 2. Use Angr to simulate a filesystem where that file is replaced with our own</span></span><br><span class="line"><span class="comment">#    simulated file.</span></span><br><span class="line"><span class="comment"># 3. Initialize the file with a symbolic value, which will be read with fread</span></span><br><span class="line"><span class="comment">#    and propogated through the program.</span></span><br><span class="line"><span class="comment"># 4. Solve for the symbolic input to determine the password.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&quot;./07_angr_symbolic_file&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x80488EA</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specify some information needed to construct a simulated file. For this</span></span><br><span class="line">  <span class="comment"># challenge, the filename is hardcoded, but in theory, it could be symbolic. </span></span><br><span class="line">  <span class="comment"># Note: to read from the file, the binary calls</span></span><br><span class="line">  <span class="comment"># &#x27;fread(buffer, sizeof(char), 64, file)&#x27;.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  filename = <span class="string">&#x27;OJKSQYDP.txt&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  symbolic_file_size_bytes = <span class="number">64</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct a bitvector for the password and then store it in the file&#x27;s</span></span><br><span class="line">  <span class="comment"># backing memory. For example, imagine a simple file, &#x27;hello.txt&#x27;:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Hello world, my name is John.</span></span><br><span class="line">  <span class="comment"># ^                       ^</span></span><br><span class="line">  <span class="comment"># ^ address 0             ^ address 24 (count the number of characters)</span></span><br><span class="line">  <span class="comment"># In order to represent this in memory, we would want to write the string to</span></span><br><span class="line">  <span class="comment"># the beginning of the file:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># hello_txt_contents = claripy.BVV(&#x27;Hello world, my name is John.&#x27;, 30*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Perhaps, then, we would want to replace John with a</span></span><br><span class="line">  <span class="comment"># symbolic variable. We would call:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># name_bitvector = claripy.BVS(&#x27;symbolic_name&#x27;, 4*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Then, after the program calls fopen(&#x27;hello.txt&#x27;, &#x27;r&#x27;) and then</span></span><br><span class="line">  <span class="comment"># fread(buffer, sizeof(char), 30, hello_txt_file), the buffer would contain</span></span><br><span class="line">  <span class="comment"># the string from the file, except four symbolic bytes where the name would be</span></span><br><span class="line">  <span class="comment"># stored.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct the symbolic file. The file_options parameter specifies the Linux</span></span><br><span class="line">  <span class="comment"># file permissions (read, read/write, execute etc.) The content parameter</span></span><br><span class="line">  <span class="comment"># specifies from where the stream of data should be supplied. If content is</span></span><br><span class="line">  <span class="comment"># an instance of SimSymbolicMemory (we constructed one above), the stream will</span></span><br><span class="line">  <span class="comment"># contain the contents (including any symbolic contents) of the memory,</span></span><br><span class="line">  <span class="comment"># beginning from address zero.</span></span><br><span class="line">  <span class="comment"># Set the content parameter to our BVS instance that holds the symbolic data.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_file = angr.storage.SimFile(filename, content=password)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Add the symbolic file we created to the symbolic filesystem.</span></span><br><span class="line">  initial_state.fs.insert(filename, password_file)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h2 id="状态插件-state-plugin"><a href="#状态插件-state-plugin" class="headerlink" title="状态插件-state plugin"></a>状态插件-state plugin</h2><p>除了刚刚讨论过的选项集，所有存储在SimState中的东西实际上都存储在附加在state上的“插件”中。到目前为止我们讨论的几乎所有state的属性都是一个插件——<code>memory</code>、<code>registers</code>、<code>mem</code>、<code>regs</code>、<code>solver</code>等等。这种设计带来了代码的模块化和能够便捷地为模拟状态的其他方面实现新的数据存储，或者提供插件的替代实现能力。</p>
<p>比如说，通常<code>memory</code>插件模拟一个平坦地址空间，但是在分析中可以选择开启“抽象内存”插件来支持<code>state.memory</code>，“抽象内存”使用新的数据类型表示地址，以模拟浮动的独立内存空间映射。反过来，插件可以减少代码的复杂性：<code>state.memory</code>和<code>state.registers</code>实际上是同一个插件的不同实例，因为寄存器也是用一块地址空间模拟的。</p>
<p>能够控制仿真程序所看到的环境，包括如何从环境中引入符号数据，这一点非常重要！angr具有一系列可靠的抽象概念，可帮助您设置所需的环境。</p>
<h2 id="仿真文件系统-The-Emulated-Filesystem"><a href="#仿真文件系统-The-Emulated-Filesystem" class="headerlink" title="仿真文件系统-The Emulated Filesystem"></a>仿真文件系统-The Emulated Filesystem</h2><p>这题的关键是利用了angr强大的仿真文件系统。在angr中与文件系统，套接字，管道或终端的任何交互的根源都是SimFile对象。SimFile是一种存储抽象，它定义符号或其他形式的字节序列。您可以从某个位置读取文件，可以在某个位置写入文件，可以询问文件中当前存储了多少字节，还可以具体化文件，并为其生成测试用例。</p>
<p>简单来说利用<code>SimFile</code>形成符号化的文件的格式：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simgr_file = angr.storage.SimFile(filename, content=xxxxxx, size=file_size)</span><br></pre></td></tr></table></figure></div>

<p>然后需要传给state的初始化过程来影响对文件系统的使用。我们可以利用<code>fs</code>选项以文件名的字典来预配置SimFile对象，也可以<code>fs.insert</code>是将文件插入到文件系统中，需要文件名与符号化的文件</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.fs.insert(filename, simgr_file)</span><br></pre></td></tr></table></figure></div>

<h1 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h1><p>该题主要学习通过添加约束条件来解决路径爆炸问题。</p>
<p><strong>程序分析</strong></p>
<ul>
<li>用户输入的字符串存储在buffer，buffer的地址为：0x804A050</li>
<li>比较函数<code>check_equals_AUPDNNPROEZRJWKB</code>的地址为：0x08048565</li>
<li>其实只要当程序运行到地址0x08048565时，处于buffer地址内的字符串等于AUPDNNPROEZRJWKB即可</li>
<li>添加上述约束条件即可一步得出结果，而不用进入比较函数逐一字符比较而产生路径爆炸问题</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(&amp;password, <span class="string">&quot;AUPDNNPROEZRJWKB&quot;</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buffer, <span class="number">0</span>, <span class="number">0x11</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, &amp;buffer);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">134520912</span>) = complex_function(*(<span class="type">char</span> *)(i + <span class="number">134520912</span>), <span class="number">15</span> - i);</span><br><span class="line">  <span class="keyword">if</span> ( check_equals_AUPDNNPROEZRJWKB(&amp;buffer, <span class="number">16</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">_BOOL4 __cdecl <span class="title function_">check_equals_AUPDNNPROEZRJWKB</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == *(_BYTE *)(i + <span class="number">0x804A040</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="路径爆炸"><a href="#路径爆炸" class="headerlink" title="路径爆炸"></a>路径爆炸</h2><p>通过我们之前的学习体验感觉到angr这么强大的应用怎么没有在实际的测试生产中大规模应用，这是因为给符号执行技术在复杂程序的测试案例生成的应用中造成阻碍的两个大问题：一个是约束求解问题，另一个就是路径爆炸问题</p>
<p>所谓符号执行就是把程序中的变量符号化去模拟程序运行，搜集路径约束条件并使用约束求解器对其进行求解后得到结果。当一个程序存在循环结构时，即使逻辑十分简单也可能会产生规模十分巨大的执行路径。在符号执行的过程中，每个分支点都会产生两个实例，当程序中存在循环结构展开时，可能会导致程序分支路径数呈指数级增长，即路径爆炸问题。故我们需要提供更多的约束条件控制路径爆照问题。</p>
<p><code>check_equals_AUPDNNPROEZRJWKB()</code>函数就是一个字符一个字符的比较，就会产生路径爆炸问题，原始也是每次调用循环中的if语句（16次）时，计算机都需要产生判断分支，从而导致2 ^ 16 &#x3D;  65,536分支，这将花费很长时间来测试并获得我们的答案。我们解决这个问题的答案，直接用约束条件取代这个判断函数，用字符串直接比较约束，从而避免因为循环和判断语句逐一字符比较而产生分支引起路径爆炸问题</p>
<h2 id="约束求解-1"><a href="#约束求解-1" class="headerlink" title="约束求解"></a>约束求解</h2><p>在angr中提供了可以用加入一个约束条件到一个state中的方法（<code>state.solver.add</code>），将每一个符号化的布尔值作为一个关于符号变量合法性的断言。之后可以通过使用<code>state.solver.eval(symbol)</code>对各个断言进行评测来求出一个合法的符号值（若有多个合法值，返回其中的一个）。简单来说就是通过 <code>.add</code> 对 state 对象添加约束，并使用 <code>.eval</code> 接口求解，得到符号变量的可行解。</p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The binary asks for a 16 character password to which is applies a complex</span></span><br><span class="line"><span class="comment"># function and then compares with a reference string with the function</span></span><br><span class="line"><span class="comment"># check_equals_[reference string]. (Decompile the binary and take a look at it!)</span></span><br><span class="line"><span class="comment"># The source code for this function is provided here. However, the reference</span></span><br><span class="line"><span class="comment"># string in your version will be different than AABBCCDDEEFFGGHH:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #define REFERENCE_PASSWORD = &quot;AABBCCDDEEFFGGHH&quot;;</span></span><br><span class="line"><span class="comment"># int check_equals_AABBCCDDEEFFGGHH(char* to_check, size_t length) &#123;</span></span><br><span class="line"><span class="comment">#   uint32_t num_correct = 0;</span></span><br><span class="line"><span class="comment">#   for (int i=0; i&lt;length; ++i) &#123;</span></span><br><span class="line"><span class="comment">#     if (to_check[i] == REFERENCE_PASSWORD[i]) &#123;</span></span><br><span class="line"><span class="comment">#       num_correct += 1;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line"><span class="comment">#   return num_correct == length;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># char* input = user_input();</span></span><br><span class="line"><span class="comment"># char* encrypted_input = complex_function(input);</span></span><br><span class="line"><span class="comment"># if (check_equals_AABBCCDDEEFFGGHH(encrypted_input, 16)) &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Good Job.&quot;);</span></span><br><span class="line"><span class="comment"># &#125; else &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Try again.&quot;);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The function checks if *to_check == &quot;AABBCCDDEEFFGGHH&quot;. Verify this yourself.</span></span><br><span class="line"><span class="comment"># While you, as a human, can easily determine that this function is equivalent</span></span><br><span class="line"><span class="comment"># to simply comparing the strings, the computer cannot. Instead the computer </span></span><br><span class="line"><span class="comment"># would need to branch every time the if statement in the loop was called (16 </span></span><br><span class="line"><span class="comment"># times), resulting in 2^16 = 65,536 branches, which will take too long of a </span></span><br><span class="line"><span class="comment"># time to evaluate for our needs.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not know how the complex_function works, but we want to find an input</span></span><br><span class="line"><span class="comment"># that, when modified by complex_function, will produce the string:</span></span><br><span class="line"><span class="comment"># AABBCCDDEEFFGGHH.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In this puzzle, your goal will be to stop the program before this function is</span></span><br><span class="line"><span class="comment"># called and manually constrain the to_check variable to be equal to the</span></span><br><span class="line"><span class="comment"># password you identify by decompiling the binary. Since, you, as a human, know</span></span><br><span class="line"><span class="comment"># that if the strings are equal, the program will print &quot;Good Job.&quot;, you can</span></span><br><span class="line"><span class="comment"># be assured that if the program can solve for an input that makes them equal,</span></span><br><span class="line"><span class="comment"># the input will be the correct password.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&quot;./08_angr_constraints&quot;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x8048625</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  char_size_in_bits = <span class="number">8</span></span><br><span class="line">  password_len = <span class="number">16</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, char_size_in_bits * password_len)</span><br><span class="line"></span><br><span class="line">  password_address = <span class="number">0x0804A050</span></span><br><span class="line">  initial_state.memory.store(password_address, password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Angr will not be able to reach the point at which the binary prints out</span></span><br><span class="line">  <span class="comment"># &#x27;Good Job.&#x27;. We cannot use that as the target anymore.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  address_to_check_constraint = <span class="number">0x08048565</span></span><br><span class="line">  simulation.explore(find=address_to_check_constraint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recall that we need to constrain the to_check parameter (see top) of the </span></span><br><span class="line">    <span class="comment"># check_equals_ function. Determine the address that is being passed as the</span></span><br><span class="line">    <span class="comment"># parameter and load it into a bitvector so that we can constrain it.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    constrained_parameter_address = password_address</span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">      constrained_parameter_address,</span><br><span class="line">      constrained_parameter_size_bytes</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># We want to constrain the system to find an input that will make</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector equal the desired value.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    constrained_parameter_desired_value = <span class="string">&#x27;AUPDNNPROEZRJWKB&#x27;</span> <span class="comment"># :string (encoded)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Specify a claripy expression (using Pythonic syntax) that tests whether</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector == constrained_parameter_desired_value.</span></span><br><span class="line">    <span class="comment"># Add the constraint to the state to let z3 attempt to find an input that</span></span><br><span class="line">    <span class="comment"># will make this expression true.</span></span><br><span class="line">    solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the constrained_parameter_bitvector.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h1><p>这题如题目所言，主要就是学习使用angr的hook技术解决路径爆炸问题，与我们之前利用的约束条件不同，hook技术则更为强大。</p>
<p><strong>程序分析</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BOOL4 v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(password, <span class="string">&quot;XYMKBKUHNIQYNQXE&quot;</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">0x11</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">134520916</span>) = complex_function(*(<span class="type">char</span> *)(i + <span class="number">134520916</span>), <span class="number">18</span> - i);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  .text:080486B3  call    check_equals_XYMKBKUHNIQYNQXE</span></span><br><span class="line"><span class="comment">  .text:080486B8  add     esp, 10h</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  equals = check_equals_XYMKBKUHNIQYNQXE(buffer, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">    *(_BYTE *)(j + <span class="number">134520900</span>) = complex_function(*(<span class="type">char</span> *)(j + <span class="number">134520900</span>), j + <span class="number">9</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br><span class="line">  v3 = equals &amp;&amp; !<span class="built_in">strncmp</span>(buffer, password, <span class="number">0x10</span>u);</span><br><span class="line">  equals = v3;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">_BOOL4 __cdecl <span class="title function_">check_equals_XYMKBKUHNIQYNQXE</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(i + a1) == *(_BYTE *)(i + <span class="number">134520900</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == a2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">complex_function</span><span class="params">(<span class="type">signed</span> <span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">64</span> || a1 &gt; <span class="number">90</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (a1 - <span class="number">65</span> + <span class="number">23</span> * a2) % <span class="number">26</span> + <span class="number">65</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其实和上一题并没有什么太大的变化，主要是我们上一题是使用增加条件约束的方法减少路径分支，而这一题我们直接利用hook改写<code>complex_function</code>函数为我们自己的函数</p>
<p><strong>hook</strong></p>
<p>angr使用一系列引擎（SimEngine的子类）来模拟被执行代码对输入状态产生的影响。其中就有<code>hook engine</code>来处理hook的情况。默认情况下，angr 会使用 <code>SimProcedures</code> 中的符号摘要替换库函数，即设置 Hooking，这些 python 函数摘要高效地模拟库函数对状态的影响。可以通过 <code>angr.procedures</code>或 <code>angr.SimProcedures</code>  查看列表</p>
<p><code>SimProcedure</code>  其实就是 Hook 机制，可以通过 <code>proj.hook(addr,hook)</code> 设置，其中 hook 是一个 <code>SimProcedure</code> 实例，第一个参数即需要Hook的调用函数的地址，第二个参数<code>length</code>即指定执行引擎在完成挂钩后应跳过多少字节。具体多少字节由Hook处地址的指令长度确定。 通过 <code>.is_hooked / .unhook / .hook_by</code> 进行管理。将 <code>proj.hook(addr)</code> 作为函数装饰器，可以编写自己的 hook 函数。还可以通过  <code>proj.hook_symbol(name,hook)</code> hook 函数。</p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This level performs the following computations:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1. Get 16 bytes of user input and encrypt it.</span></span><br><span class="line"><span class="comment"># 2. Save the result of check_equals_AABBCCDDEEFFGGHH (or similar)</span></span><br><span class="line"><span class="comment"># 3. Get another 16 bytes from the user and encrypt it.</span></span><br><span class="line"><span class="comment"># 4. Check that it&#x27;s equal to a predefined password.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The ONLY part of this program that we have to worry about is #2. We will be</span></span><br><span class="line"><span class="comment"># replacing the call to check_equals_ with our own version, using a hook, since</span></span><br><span class="line"><span class="comment"># check_equals_ will run too slowly otherwise.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./09_angr_hooks&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Since Angr can handle the initial call to scanf, we can start from the</span></span><br><span class="line">  <span class="comment"># beginning.</span></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook the address of where check_equals_ is called.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_equals_called_address = <span class="number">0x80486B3</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The length parameter in angr.Hook specifies how many bytes the execution</span></span><br><span class="line">  <span class="comment"># engine should skip after completing the hook. This will allow hooks to</span></span><br><span class="line">  <span class="comment"># replace certain instructions (or groups of instructions). Determine the</span></span><br><span class="line">  <span class="comment"># instructions involved in calling check_equals_, and then determine how many</span></span><br><span class="line">  <span class="comment"># bytes are used to represent them in memory. This will be the skip length.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  instruction_to_skip_length = <span class="number">5</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  然后我们需要在在@project.hook语句之后书写我们的模拟函数。然后如上题一致，</span></span><br><span class="line"><span class="string">  我们利用使用 state.memory 的 .load(addr,     size)接口读出buffer处的内存数据，与答案进行比较</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">skip_check_equals_</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># Determine the address where user input is stored. It is passed as a</span></span><br><span class="line">    <span class="comment"># parameter ot the check_equals_ function. Then, load the string. Reminder:</span></span><br><span class="line">    <span class="comment"># int check_equals_(char* to_check, int length) &#123; ...</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x804A054</span>  <span class="comment"># :integer, probably hexadecimal</span></span><br><span class="line">    user_input_buffer_length = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reminder: state.memory.load will read the stored value at the address</span></span><br><span class="line">    <span class="comment"># user_input_buffer_address of byte length user_input_buffer_length.</span></span><br><span class="line">    <span class="comment"># It will return a bitvector holding the value. This value can either be</span></span><br><span class="line">    <span class="comment"># symbolic or concrete, depending on what was stored there in the program.</span></span><br><span class="line">    user_input_string = state.memory.load(</span><br><span class="line">      user_input_buffer_address, </span><br><span class="line">      user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Determine the string this function is checking the user input against.</span></span><br><span class="line">    <span class="comment"># It&#x27;s encoded in the name of this function; decompile the program to find</span></span><br><span class="line">    <span class="comment"># it.</span></span><br><span class="line">    check_against_string = <span class="string">&#x27;XKSPZSJKJYQCQXZV&#x27;</span> <span class="comment"># :string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gcc uses eax to store the return value, if it is an integer. We need to</span></span><br><span class="line">    <span class="comment"># set eax to 1 if check_against_string == user_input_string and 0 otherwise.</span></span><br><span class="line">    <span class="comment"># However, since we are describing an equation to be used by z3 (not to be</span></span><br><span class="line">    <span class="comment"># evaluated immediately), we cannot use Python if else syntax. Instead, we </span></span><br><span class="line">    <span class="comment"># have to use claripy&#x27;s built in function that deals with if statements.</span></span><br><span class="line">    <span class="comment"># claripy.If(expression, ret_if_true, ret_if_false) will output an </span></span><br><span class="line">    <span class="comment"># expression that evaluates to ret_if_true if expression is true and</span></span><br><span class="line">    <span class="comment"># ret_if_false otherwise. </span></span><br><span class="line">    <span class="comment"># Think of it like the Python &quot;value0 if expression else value1&quot;.</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    这个函数是利用EAX寄存器作为返回值，然后成功则返回1，不成功则返回0，</span></span><br><span class="line"><span class="string">    还需要注意在构建符号位向量的时候EAX寄存器是32位寄存器</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">      user_input_string == check_against_string, </span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Since we are allowing Angr to handle the input, retrieve it by printing</span></span><br><span class="line">    <span class="comment"># the contents of stdin. Use one of the early levels as a reference.</span></span><br><span class="line">    solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h1><p>这题主要学习如何利用函数名进行hook，而不是复杂的利用函数的调用地址。</p>
<p><strong>程序分析</strong></p>
<p>这一题与上一题相似， 我们必须替换check_equals函数  。但是，我们可以发现check_equals被调用了很多次，以致于无法通过地址Hook每个调用位置。  这时我们必须使用SimProcedure编写我们自己的check_equals实现，然后通过函数名Hook所有对<code>check_equals</code>的调用。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/07/15/angr%E5%85%A5%E9%97%A8/image-20240717101443828.png"
                      alt="image-20240717101443828"
                ></p>
<p><strong>hook sym</strong></p>
<p>每一个程序都有一个符号表，angr可以确保从每个导入符号都可以解析出地址，可以使用angr提供的<code>Project.hook_symbol</code>API来通过符号名来Hook函数所有的调用地址，但符号表也是可以被去除的（大多数程序都会去除符号表）。</p>
<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge is similar to the previous one. It operates under the same</span></span><br><span class="line"><span class="comment"># premise that you will have to replace the check_equals_ function. In this </span></span><br><span class="line"><span class="comment"># case, however, check_equals_ is called so many times that it wouldn&#x27;t make </span></span><br><span class="line"><span class="comment"># sense to hook where each one was called. Instead, use a SimProcedure to write</span></span><br><span class="line"><span class="comment"># your own check_equals_ implementation and then hook the check_equals_ symbol </span></span><br><span class="line"><span class="comment"># to replace all calls to scanf with a call to your SimProcedure.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You may be thinking: </span></span><br><span class="line"><span class="comment">#   Why can&#x27;t I just use hooks? The function is called many times, but if I hook</span></span><br><span class="line"><span class="comment">#   the address of the function itself (rather than the addresses where it is </span></span><br><span class="line"><span class="comment">#   called), I can replace its behavior everywhere. Furthermore, I can get the</span></span><br><span class="line"><span class="comment">#   parameters by reading them off the stack (with memory.load(regs.esp + xx)),</span></span><br><span class="line"><span class="comment">#   and return a value by simply setting eax! Since I know the length of the </span></span><br><span class="line"><span class="comment">#   function in bytes, I can return from the hook just before the &#x27;ret&#x27;</span></span><br><span class="line"><span class="comment">#   instruction is called, which will allow the program to jump back to where it</span></span><br><span class="line"><span class="comment">#   was before it called my hook.</span></span><br><span class="line"><span class="comment"># If you thought that, then congratulations! You have just invented the idea of</span></span><br><span class="line"><span class="comment"># SimProcedures! Instead of doing all of that by hand, you can let the already-</span></span><br><span class="line"><span class="comment"># implemented SimProcedures do the boring work for you so that you can focus on</span></span><br><span class="line"><span class="comment"># writing a replacement function in a Pythonic way.</span></span><br><span class="line"><span class="comment"># As a bonus, SimProcedures allow you to specify custom calling conventions, but</span></span><br><span class="line"><span class="comment"># unfortunately it is not covered in this CTF.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./10_angr_simprocedures&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Define a class that inherits angr.SimProcedure in order to take advantage</span></span><br><span class="line">  <span class="comment"># of Angr&#x27;s SimProcedures.</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  这里前面的部分都可以直接照抄上面一题的代码，关键是定义一个继承angr.SimProcedure的类，以利用Angr的SimProcedures。</span></span><br><span class="line"><span class="string">  SimProcedure用Python编写的我们自己的函数代替了原来函数。 除了用Python编写之外，该函数的行为与用C编写的任何函数基本相同。</span></span><br><span class="line"><span class="string">  self之后的任何参数都将被视为要替换的函数的参数， 参数将是符号位向量。 </span></span><br><span class="line"><span class="string">  另外，Python可以以常用的Python方式返回，Angr将以与原来函数相同的方式对待它</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReplacementCheckEquals</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment"># A SimProcedure replaces a function in the binary with a simulated one</span></span><br><span class="line">    <span class="comment"># written in Python. Other than it being written in Python, the function</span></span><br><span class="line">    <span class="comment"># acts largely the same as any function written in C. Any parameter after</span></span><br><span class="line">    <span class="comment"># &#x27;self&#x27; will be treated as a parameter to the function you are replacing.</span></span><br><span class="line">    <span class="comment"># The parameters will be bitvectors. Additionally, the Python can return in</span></span><br><span class="line">    <span class="comment"># the ususal Pythonic way. Angr will treat this in the same way it would</span></span><br><span class="line">    <span class="comment"># treat a native function in the binary returning. An example:</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># int add_if_positive(int a, int b) &#123;</span></span><br><span class="line">    <span class="comment">#   if (a &gt;= 0 &amp;&amp; b &gt;= 0) return a + b;</span></span><br><span class="line">    <span class="comment">#   else return 0;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># could be simulated with...</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># class ReplacementAddIfPositive(angr.SimProcedure):</span></span><br><span class="line">    <span class="comment">#   def run(self, a, b):</span></span><br><span class="line">    <span class="comment">#     if a &gt;= 0 and b &gt;=0:</span></span><br><span class="line">    <span class="comment">#       return a + b</span></span><br><span class="line">    <span class="comment">#     else:</span></span><br><span class="line">    <span class="comment">#       return 0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Finish the parameters to the check_equals_ function. Reminder:</span></span><br><span class="line">    <span class="comment"># int check_equals_AABBCCDDEEFFGGHH(char* to_check, int length) &#123; ...</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    check_equals_AABBCCDDEEFFGGHH(char* to_check, int length)函数的第一个参数是待检测字符串首地址指针，</span></span><br><span class="line"><span class="string">    然后就是字符串的长度，接下来我们就可以开始书写我们的模拟函数</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, to_check, length</span>):</span><br><span class="line">      <span class="comment"># We can almost copy and paste the solution from the previous challenge.</span></span><br><span class="line">      <span class="comment"># Hint: Don&#x27;t look up the address! It&#x27;s passed as a parameter.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      user_input_buffer_address = to_check</span><br><span class="line">      user_input_buffer_length = length</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Note the use of self.state to find the state of the system in a </span></span><br><span class="line">      <span class="comment"># SimProcedure.</span></span><br><span class="line">      user_input_string = self.state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      check_against_string = <span class="string">&#x27;ORSDDWXHZURJRBDH&#x27;</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># Finally, instead of setting eax, we can use a Pythonic return statement</span></span><br><span class="line">      <span class="comment"># to return the output of this function. </span></span><br><span class="line">      <span class="comment"># Hint: Look at the previous solution.</span></span><br><span class="line">      <span class="keyword">return</span> claripy.If(                </span><br><span class="line">                user_input_string == check_against_string, </span><br><span class="line">                claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">                claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">              )  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook the check_equals symbol. Angr automatically looks up the address </span></span><br><span class="line">  <span class="comment"># associated with the symbol. Alternatively, you can use &#x27;hook&#x27; instead</span></span><br><span class="line">  <span class="comment"># of &#x27;hook_symbol&#x27; and specify the address of the function. To find the </span></span><br><span class="line">  <span class="comment"># correct symbol, disassemble the binary.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_equals_symbol = <span class="string">&#x27;check_equals_ORSDDWXHZURJRBDH&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h1><p>这题主要是学习如何hook<code>scanf</code>函数，步骤其实与上一题是几乎一致的，得先找到需要hook的函数符号，然后编写一个继承angr.SimProcedure的类，然后利用<code>hook_symbol</code>对函数进行hook</p>
<p><strong>程序分析</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int i; // [esp+20h] [ebp-28h]</span><br><span class="line">  char s[20]; // [esp+28h] [ebp-20h] BYREF</span><br><span class="line">  unsigned int v7; // [esp+3Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(0x14u);</span><br><span class="line">  memset(s, 0, sizeof(s));</span><br><span class="line">  qmemcpy(s, &quot;SUQMKQFX&quot;, 8);</span><br><span class="line">  for ( i = 0; i &lt;= 7; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], i);</span><br><span class="line">  printf(&quot;Enter the password: &quot;);</span><br><span class="line">  __isoc99_scanf(&quot;%u %u&quot;, buffer0, buffer1);</span><br><span class="line">  if ( !strncmp(buffer0, s, 4u) &amp;&amp; !strncmp(buffer1, &amp;s[4], 4u) )</span><br><span class="line">    puts(&quot;Good Job.&quot;);</span><br><span class="line">  else</span><br><span class="line">    puts(&quot;Try again.&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This time, the solution involves simply replacing scanf with our own version,</span></span><br><span class="line"><span class="comment"># since Angr does not support requesting multiple parameters with scanf.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./11_angr_sim_scanf&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment"># Finish the parameters to the scanf function. Hint: &#x27;scanf(&quot;%u %u&quot;, ...)&#x27;.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># The scanf function writes user input to the buffers to which the </span></span><br><span class="line">      <span class="comment"># parameters point.</span></span><br><span class="line">      <span class="comment"># 这里Scanf是要向内存写入数据的，于是我们利用使用 state.memory 的 .store(addr, val) 接口</span></span><br><span class="line">      <span class="comment"># 将符号位向量写入两个字符串的内存区域</span></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Now, we want to &#x27;set aside&#x27; references to our symbolic values in the</span></span><br><span class="line">      <span class="comment"># globals plugin included by default with a state. You will need to</span></span><br><span class="line">      <span class="comment"># store multiple bitvectors. You can either use a list, tuple, or multiple</span></span><br><span class="line">      <span class="comment"># keys to reference the different bitvectors.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Grab whatever you set aside in the globals dict.</span></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0, cast_to=<span class="built_in">int</span>)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1, cast_to=<span class="built_in">int</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(solution0) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(solution1))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<p>这里的关键我们都知道Python的变量生存周期，在这里<code>scanf0</code>和<code>scanf1</code>是函数<code>ReplacementScanf</code>的局部变量，为了让函数外部也能获得我们输入的符号位向量，从而调用求解器获得答案，需要将这两个符号位向量变为全局变量，这里我们需要调用带有全局状态的globals插件中“保存”对我们的符号值的引用。globals插件允许使用列表，元组或多个键的字典来存储多个位向量</p>
<h1 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h1><p>主要学习使用<code>Veritesting</code>的技术解决路径爆炸问题。</p>
<p><strong>程序逻辑</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp-14h] [ebp-60h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp-10h] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [esp-Ch] [ebp-58h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp-8h] [ebp-54h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [esp-4h] [ebp-50h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> **v10; <span class="comment">// [esp+0h] [ebp-4Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [esp+4h] [ebp-48h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+8h] [ebp-44h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [esp+Ch] [ebp-40h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+10h] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp+10h] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp+14h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+14h] [ebp-38h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp+18h] [ebp-34h]</span></span><br><span class="line">  _DWORD v19[<span class="number">9</span>]; <span class="comment">// [esp+1Ch] [ebp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// [esp+40h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+44h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  v10 = argv;</span><br><span class="line">  v20 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)v19 + <span class="number">3</span>, <span class="number">0</span>, <span class="number">0x21</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  ((<span class="type">void</span> (__stdcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">const</span> <span class="type">char</span> **, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, _DWORD))__isoc99_scanf)(</span><br><span class="line">    <span class="string">&quot;%32s&quot;</span>,</span><br><span class="line">    (<span class="type">char</span> *)v19 + <span class="number">3</span>,</span><br><span class="line">    v5,</span><br><span class="line">    v6,</span><br><span class="line">    v7,</span><br><span class="line">    v8,</span><br><span class="line">    v9,</span><br><span class="line">    v10,</span><br><span class="line">    v11,</span><br><span class="line">    v12,</span><br><span class="line">    v13,</span><br><span class="line">    v14,</span><br><span class="line">    v16,</span><br><span class="line">    v18,</span><br><span class="line">    v19[<span class="number">0</span>]);</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *((<span class="type">char</span> *)v19 + i + <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v3 == complex_function(<span class="number">75</span>, i + <span class="number">93</span>) )</span><br><span class="line">      ++v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v15 != <span class="number">32</span> || (_BYTE)v20 )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>Veritesting</strong></p>
<p>动态符号执行（DSE）和静态符号执行（SSE）一个为路径生成公式，一个为语句生成公式。前者生成公式时会产生很高的负载，但生成的公式很容易解；后者生成公式很容易，公式也能覆盖更多的路径，但是公式更长更难解。方法上的区别在于DSE会摘要路径汇合点上两条分支的情况，而SSE为两条分支fork两条独立的执行路径</p>
<p>SSE目前还不能对大规模的程序分析（如Cloud9+state  merging），问题主要在于循环的表示、方程复杂度、缺少具体状态、和对syscall等的模拟。Veritesting可以在SSE和DSE之间切换，减少负载和公式求解难度，并解决静态方法需要摘要或其他方法才能处理的系统调用和间接跳转</p>
<p>简单来说就是Veritesting结合了静态符合执行与动态符号执行，减少了路径爆炸的影响，在angr里我们只要在构造模拟管理器时，启用Veritesting了就行。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.factory.simgr(initial_state, veritesting=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># When you construct a simulation manager, you will want to enable Veritesting:</span></span><br><span class="line"><span class="comment"># project.factory.simgr(initial_state, veritesting=True)</span></span><br><span class="line"><span class="comment"># Hint: use one of the first few levels&#x27; solutions as a reference.</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&#x27;./12_angr_veritesting&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line">    simgr = project.factory.simgr(initial_state, veritesting=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">    simgr.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(solution)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No solution found.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<h1 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h1><p>这题如题就是主要学习如何使用angr解出静态编译的题目，学习如何Hook静态库函数。</p>
<p><strong>程序逻辑</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+20h] [ebp-38h]</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">20</span>]; <span class="comment">// [esp+24h] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">20</span>]; <span class="comment">// [esp+38h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    v7[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(v7, <span class="string">&quot;PYIEFPIC&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, v6);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">    v6[j] = complex_function(v6[j], j);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v6, v7) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>hook static_bin</strong></p>
<p>通常，Angr会自动地用工作速度快得多的simprocedure代替标准库函数，但是这题中库函数都已经因为静态编译成了静态函数了，angr没法自动替换。要解决这题，需要手动Hook所有使用标准库的C函数，angr已经在simprocedure中为我们提供了这些静态函数。我们只需要手动找到程序中用到静态函数的地址，将其利用simprocedure提供的函数Hook掉即可。</p>
<p><strong>exp</strong></p>
<p>这题解题真正需要用的函数也就是<code>__libc_start_main``printf</code>，<code>scnaf</code>，<code>puts</code>，即完成了angr需要的输出、输入、路径选择的功能。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge is the exact same as the first challenge, except that it was</span></span><br><span class="line"><span class="comment"># compiled as a static binary. Normally, Angr automatically replaces standard</span></span><br><span class="line"><span class="comment"># library functions with SimProcedures that work much more quickly.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Here are a few SimProcedures Angr has already written for you. They implement</span></span><br><span class="line"><span class="comment"># standard library functions. You will not need all of them:</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fopen&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fclose&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fwrite&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;getchar&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strncmp&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strcmp&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;scanf&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;printf&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;puts&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;exit&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;glibc&#x27;][&#x27;__libc_start_main&#x27;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># As a reminder, you can hook functions with something similar to:</span></span><br><span class="line"><span class="comment"># project.hook(malloc_address, angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There are many more, see:</span></span><br><span class="line"><span class="comment"># https://github.com/angr/angr/tree/master/angr/procedures/libc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Additionally, note that, when the binary is executed, the main function is not</span></span><br><span class="line"><span class="comment"># the first piece of code called. In the _start function, __libc_start_main is </span></span><br><span class="line"><span class="comment"># called to start your program. The initialization that occurs in this function</span></span><br><span class="line"><span class="comment"># can take a long time with Angr, so you should replace it with a SimProcedure.</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;glibc&#x27;][&#x27;__libc_start_main&#x27;]</span></span><br><span class="line"><span class="comment"># Note &#x27;glibc&#x27; instead of &#x27;libc&#x27;.</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># Load the binary</span></span><br><span class="line">    path_to_binary = <span class="string">&#x27;./13_angr_static_binary&#x27;</span></span><br><span class="line">    project = angr.Project(path_to_binary, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">    project.hook(<span class="number">0x804ed40</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x804ed80</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x804f350</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">    project.hook(<span class="number">0x8048d10</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line"></span><br><span class="line">    simgr = project.factory.simulation_manager(initial_state)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Good Job.\n&#x27;</span> <span class="keyword">in</span> stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">should_abort</span>(<span class="params">state</span>):</span><br><span class="line">        stdout_output = state.posix.dumps(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;Try again.\n&#x27;</span> <span class="keyword">in</span>  stdout_output:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">    simgr.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        solution = solution_state.posix.dumps(<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(solution)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;No solution found.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<h1 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h1><p>这题如题主要是学习如何使用angr求解函数是外部导入在动态库(.so)里的题目，这题我们有了两个文件，一个是主程序<code>14_angr_shared_library</code>，另一个就是库文件<code>lib14_angr_shared_library.so</code>。</p>
<p><strong>程序分析</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">  print_msg();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( validate(&amp;s, <span class="number">8</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">_BOOL4 __cdecl <span class="title function_">validate</span><span class="params">(<span class="type">char</span> *s1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">4</span>]; <span class="comment">// [esp+4h] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+8h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    s2[i] = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)s2 = <span class="string">&#x27;GKLW&#x27;</span>;</span><br><span class="line">  v5 = <span class="string">&#x27;HWJL&#x27;</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = &amp;s1[j];</span><br><span class="line">    *v3 = complex_function(s1[j], j);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(s1, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The shared library has the function validate, which takes a string and returns</span></span><br><span class="line"><span class="comment"># either true (1) or false (0). The binary calls this function. If it returns</span></span><br><span class="line"><span class="comment"># true, the program prints &quot;Good Job.&quot; otherwise, it prints &quot;Try again.&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: When you run this script, make sure you run it on </span></span><br><span class="line"><span class="comment"># lib14_angr_shared_library.so, not the executable. This level is intended to </span></span><br><span class="line"><span class="comment"># teach how to analyse binary formats that are not typical executables.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./lib14_angr_shared_library.so&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The shared library is compiled with position-independent code. You will need</span></span><br><span class="line">  <span class="comment"># to specify the base address. All addresses in the shared library will be</span></span><br><span class="line">  <span class="comment"># base + offset, where offset is their address in the file.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  base = <span class="number">0x4000000</span></span><br><span class="line">  project = angr.Project(path_to_binary, load_options=&#123; </span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123; </span><br><span class="line">      <span class="string">&#x27;custom_base_addr&#x27;</span> : base </span><br><span class="line">    &#125; </span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Initialize any symbolic values here; you will need at least one to pass to</span></span><br><span class="line">  <span class="comment"># the validate function.</span></span><br><span class="line">  buffer_pointer = claripy.BVV(<span class="number">0x3000000</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Begin the state at the beginning of the validate function, as if it was</span></span><br><span class="line">  <span class="comment"># called by the program. Determine the parameters needed to call validate and</span></span><br><span class="line">  <span class="comment"># replace &#x27;parameters...&#x27; with bitvectors holding the values you wish to pass.</span></span><br><span class="line">  <span class="comment"># Recall that &#x27;claripy.BVV(value, size_in_bits)&#x27; constructs a bitvector </span></span><br><span class="line">  <span class="comment"># initialized to a single value.</span></span><br><span class="line">  <span class="comment"># Remember to add the base value you specified at the beginning to the</span></span><br><span class="line">  <span class="comment"># function address!</span></span><br><span class="line">  <span class="comment"># Hint: int validate(char* buffer, int length) &#123; ...</span></span><br><span class="line">  <span class="comment"># Another hint: the password is 8 bytes long.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  validate_function_address = base + <span class="number">0x6d7</span></span><br><span class="line">  initial_state = project.factory.call_state(validate_function_address, buffer_pointer, claripy.BVV(<span class="number">8</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment"># You will need to add code to inject a symbolic value into the program at the</span></span><br><span class="line">  <span class="comment"># end of the function that constrains eax to equal true (value of 1) just</span></span><br><span class="line">  <span class="comment"># before the function returns. There are multiple ways to do this:</span></span><br><span class="line">  <span class="comment"># 1. Use a hook.</span></span><br><span class="line">  <span class="comment"># 2. Search for the address just before the function returns and then</span></span><br><span class="line">  <span class="comment">#    constrain eax (this may require putting code elsewhere)</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)</span><br><span class="line">  initial_state.memory.store(buffer_pointer, password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  success_address = base + <span class="number">0x783</span></span><br><span class="line">  simulation.explore(find=success_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Determine where the program places the return value, and constrain it so</span></span><br><span class="line">    <span class="comment"># that it is true. Then, solve for the solution and print it.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution_state.add_constraints(solution_state.regs.eax != <span class="number">0</span>)</span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h1><p>主要是学习如何利用Angr实现内存地址的任意读。</p>
<p><strong>程序逻辑</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  s = try_again;</span><br><span class="line">  print_msg();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">19511649</span> )</span><br><span class="line">    <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(try_again);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//.rodata:484F4A47	0000000A	C	Good Job.</span></span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This binary takes both an integer and a string as a parameter. A certain</span></span><br><span class="line"><span class="comment"># integer input causes the program to reach a buffer overflow with which we can</span></span><br><span class="line"><span class="comment"># read a string from an arbitrary memory location. Our goal is to use Angr to </span></span><br><span class="line"><span class="comment"># search the program for this buffer overflow and then automatically generate</span></span><br><span class="line"><span class="comment"># an exploit to read the string &quot;Good Job.&quot; </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># What is the point of reading the string &quot;Good Job.&quot;?</span></span><br><span class="line"><span class="comment"># This CTF attempts to replicate a simplified version of a possible vulnerability</span></span><br><span class="line"><span class="comment"># where a user can exploit the program to print a secret, such as a password or</span></span><br><span class="line"><span class="comment"># a private key. In order to keep consistency with the other challenges and to</span></span><br><span class="line"><span class="comment"># simplify the challenge, the goal of this program will be to print &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># instead.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The general strategy for crafting this script will be to:</span></span><br><span class="line"><span class="comment"># 1) Search for calls of the &#x27;puts&#x27; function, which will eventually be exploited</span></span><br><span class="line"><span class="comment">#    to print out &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># 2) Determine if the first parameter of &#x27;puts&#x27;, a pointer to the string to be </span></span><br><span class="line"><span class="comment">#    printed, can be controlled by the user to be set to the location of the</span></span><br><span class="line"><span class="comment">#    &quot;Good Job.&quot; string.</span></span><br><span class="line"><span class="comment"># 3) Solve for the input that prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: The script is structured to implement step #2 before #1.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Some of the source code for this challenge:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># // This will all be in .rodata</span></span><br><span class="line"><span class="comment"># char msg[] = &quot;$&#123; description &#125;$&quot;;</span></span><br><span class="line"><span class="comment"># char* try_again = &quot;Try again.&quot;;</span></span><br><span class="line"><span class="comment"># char* good_job = &quot;Good Job.&quot;;</span></span><br><span class="line"><span class="comment"># uint32_t key;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># void print_msg() &#123;</span></span><br><span class="line"><span class="comment">#   printf(&quot;%s&quot;, msg);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># uint32_t complex_function(uint32_t input) &#123;</span></span><br><span class="line"><span class="comment">#   ...</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># struct overflow_me &#123;</span></span><br><span class="line"><span class="comment">#   char buffer[16];</span></span><br><span class="line"><span class="comment">#   char* to_print;</span></span><br><span class="line"><span class="comment"># &#125;; </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># int main(int argc, char* argv[]) &#123;</span></span><br><span class="line"><span class="comment">#   struct overflow_me locals;</span></span><br><span class="line"><span class="comment">#   locals.to_print = try_again;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   print_msg();</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   printf(&quot;Enter the password: &quot;);</span></span><br><span class="line"><span class="comment">#   scanf(&quot;%u %20s&quot;, &amp;key, locals.buffer);</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   key = complex_function(key);</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   switch (key) &#123;</span></span><br><span class="line"><span class="comment">#     case ?:</span></span><br><span class="line"><span class="comment">#       puts(try_again);</span></span><br><span class="line"><span class="comment">#       break;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     ...</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     case ?:</span></span><br><span class="line"><span class="comment">#       // Our goal is to trick this call to puts to print the &quot;secret</span></span><br><span class="line"><span class="comment">#       // password&quot; (which happens, in our case, to be the string</span></span><br><span class="line"><span class="comment">#       // &quot;Good Job.&quot;)</span></span><br><span class="line"><span class="comment">#       puts(locals.to_print);</span></span><br><span class="line"><span class="comment">#       break;</span></span><br><span class="line"><span class="comment">#     </span></span><br><span class="line"><span class="comment">#     ...</span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   return 0;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./15_angr_arbitrary_read&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># You can either use a blank state or an entry state; just make sure to start</span></span><br><span class="line">  <span class="comment"># at the beginning of the program.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state = initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Again, scanf needs to be replaced.</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment"># Hint: scanf(&quot;%u %20s&quot;)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, param0, param1</span>):</span><br><span class="line">      <span class="comment"># %u</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># %20s</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># The bitvector.chop(bits=n) function splits the bitvector into a Python</span></span><br><span class="line">      <span class="comment"># list containing the bitvector in segments of n bits each. In this case,</span></span><br><span class="line">      <span class="comment"># we are splitting them into segments of 8 bits (one byte.)</span></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        <span class="comment"># Ensure that each character in the string is printable. An interesting</span></span><br><span class="line">        <span class="comment"># experiment, once you have a working solution, would be to run the code</span></span><br><span class="line">        <span class="comment"># without constraining the characters to the capital letters.</span></span><br><span class="line">        <span class="comment"># Even though the solution will technically work without this, it&#x27;s more</span></span><br><span class="line">        <span class="comment"># difficult to enter in a solution that contains character you can&#x27;t</span></span><br><span class="line">        <span class="comment"># copy, paste, or type into your terminal or the web form that checks </span></span><br><span class="line">        <span class="comment"># your solution.</span></span><br><span class="line">        <span class="comment"># If you are using the web form to submit answers, your solution must be</span></span><br><span class="line">        <span class="comment"># entirely alphanumeric except for spaces.</span></span><br><span class="line">        <span class="comment"># (!)</span></span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Warning: Endianness only applies to integers. If you store a string in</span></span><br><span class="line">      <span class="comment"># memory and treat it as a little-endian integer, it will be backwards.</span></span><br><span class="line">      scanf0_address = param0</span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      scanf1_address = param1</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>] = (scanf0,scanf1)</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># We will call this whenever puts is called. The goal of this function is to</span></span><br><span class="line">  <span class="comment"># determine if the pointer passed to puts is controllable by the user, such</span></span><br><span class="line">  <span class="comment"># that we can rewrite it to point to the string &quot;Good Job.&quot;</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">check_puts</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># Recall that puts takes one parameter, a pointer to the string it will</span></span><br><span class="line">    <span class="comment"># print. If we load that pointer from memory, we can analyse it to determine</span></span><br><span class="line">    <span class="comment"># if it can be controlled by the user input in order to point it to the</span></span><br><span class="line">    <span class="comment"># location of the &quot;Good Job.&quot; string.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Treat the implementation of this function as if puts was just called.</span></span><br><span class="line">    <span class="comment"># The stack, registers, memory, etc should be set up as if the x86 call</span></span><br><span class="line">    <span class="comment"># instruction was just invoked (but, of course, the function hasn&#x27;t copied</span></span><br><span class="line">    <span class="comment"># the buffers yet.)</span></span><br><span class="line">    <span class="comment"># The stack will look as follows:</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># esp + 7 -&gt; /----------------\</span></span><br><span class="line">    <span class="comment"># esp + 6 -&gt; |      puts      |</span></span><br><span class="line">    <span class="comment"># esp + 5 -&gt; |    parameter   |</span></span><br><span class="line">    <span class="comment"># esp + 4 -&gt; \----------------/</span></span><br><span class="line">    <span class="comment"># esp + 3 -&gt; /----------------\</span></span><br><span class="line">    <span class="comment"># esp + 2 -&gt; |     return     |</span></span><br><span class="line">    <span class="comment"># esp + 1 -&gt; |     address    |</span></span><br><span class="line">    <span class="comment">#     esp -&gt; \----------------/</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Hint: Look at level 08, 09, or 10 to review how to load a value from a</span></span><br><span class="line">    <span class="comment"># memory address. Remember to use the correct endianness in the future when</span></span><br><span class="line">    <span class="comment"># loading integers; it has been included for you here.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    puts_parameter = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following function takes a bitvector as a parameter and checks if it</span></span><br><span class="line">    <span class="comment"># can take on more than one value. While this does not necessary tell us we</span></span><br><span class="line">    <span class="comment"># have found an exploitable state, it is a strong indication that the </span></span><br><span class="line">    <span class="comment"># bitvector we checked may be controllable by the user.</span></span><br><span class="line">    <span class="comment"># Use it to determine if the pointer passed to puts is symbolic.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">if</span> state.se.symbolic(puts_parameter):</span><br><span class="line">      <span class="comment"># Determine the location of the &quot;Good Job.&quot; string. We want to print it</span></span><br><span class="line">      <span class="comment"># out, and we will do so by attempting to constrain the puts parameter to</span></span><br><span class="line">      <span class="comment"># equal it. (Hint: look at .rodata).</span></span><br><span class="line">      <span class="comment"># Hint: use &#x27;objdump -s &lt;binary&gt;&#x27; to look for the string&#x27;s address.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      good_job_string_address = <span class="number">0x484F4A47</span> <span class="comment"># :integer, probably hexadecimal</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create an expression that will test if puts_parameter equals</span></span><br><span class="line">      <span class="comment"># good_job_string_address. If we add this as a constraint to our solver,</span></span><br><span class="line">      <span class="comment"># it will try and find an input to make this expression true. Take a look</span></span><br><span class="line">      <span class="comment"># at level 08 to remind yourself of the syntax of this.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      is_vulnerable_expression = puts_parameter == good_job_string_address <span class="comment"># :boolean bitvector expression</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Have Angr evaluate the state to determine if all the constraints can</span></span><br><span class="line">      <span class="comment"># be met, including the one we specified above. If it can be satisfied,</span></span><br><span class="line">      <span class="comment"># we have found our exploit!</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># When doing this, however, we do not want to edit our state in case we</span></span><br><span class="line">      <span class="comment"># have not yet found what we are looking for. To test if our expression</span></span><br><span class="line">      <span class="comment"># is satisfiable without editing the original, we need to clone the state.</span></span><br><span class="line">      copied_state = state.copy()</span><br><span class="line"></span><br><span class="line">      <span class="comment"># We can now play around with the copied state without changing the</span></span><br><span class="line">      <span class="comment"># original. We need to add our vulnerable expression as a state to test it.</span></span><br><span class="line">      <span class="comment"># Look at level 08 and compare this call to how it is called there.</span></span><br><span class="line">      copied_state.add_constraints(is_vulnerable_expression)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Finally, we test if we can satisfy the constraints of the state.</span></span><br><span class="line">      <span class="keyword">if</span> copied_state.satisfiable():</span><br><span class="line">        <span class="comment"># Before we return, let&#x27;s add the constraint to the solver for real.</span></span><br><span class="line">        state.add_constraints(is_vulnerable_expression)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># not state.se.symbolic(???)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># In order to determine if we have found a vulnerable call to &#x27;puts&#x27;,  we need</span></span><br><span class="line">  <span class="comment"># to run the function check_puts (defined above) whenever we reach a &#x27;puts&#x27;</span></span><br><span class="line">  <span class="comment"># call. To do this, we will look for the place where the instruction pointer,</span></span><br><span class="line">  <span class="comment"># state.addr, is equal to the beginning of the puts function.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># We are looking for puts. Check that the address is at the (very) beginning</span></span><br><span class="line">    <span class="comment"># of the puts function. Warning: while, in theory, you could look for</span></span><br><span class="line">    <span class="comment"># any address in puts, if you execute any instruction that adjusts the stack</span></span><br><span class="line">    <span class="comment"># pointer, the stack diagram above will be incorrect. Therefore, it is</span></span><br><span class="line">    <span class="comment"># recommended that you check for the very beginning of puts.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    puts_address = <span class="number">0x8048370</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == puts_address:</span><br><span class="line">      <span class="comment"># Return True if we determine this call to puts is exploitable.</span></span><br><span class="line">      <span class="keyword">return</span> check_puts(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="comment"># We have not yet found a call to puts; we should continue!</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    (scanf0, scanf1) = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>]</span><br><span class="line">    solution0 = (solution_state.solver.<span class="built_in">eval</span>(scanf0,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    solution1 = (solution_state.solver.<span class="built_in">eval</span>(scanf1,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="built_in">print</span>(solution0 + <span class="string">b&#x27; &#x27;</span> + solution1)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h1><p>学习如何任意写。</p>
<p><strong>程序分析</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [esp+Ch] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> *dest; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  dest = unimportant_buffer;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">strncpy</span>(password_buffer, <span class="string">&quot;PASSWORD&quot;</span>, <span class="number">0xC</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, s);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">0xB11403</span> )</span><br><span class="line">    <span class="built_in">strncpy</span>(dest, s, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strncpy</span>(unimportant_buffer, s, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(password_buffer, <span class="string">&quot;NDYNWEUJ&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Essentially, the program does the following:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># scanf(&quot;%d %20s&quot;, &amp;key, user_input);</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment">#   // if certain unknown conditions are true...</span></span><br><span class="line"><span class="comment">#   strncpy(random_buffer, user_input);</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># if (strncmp(secure_buffer, reference_string)) &#123;</span></span><br><span class="line"><span class="comment">#   // The secure_buffer does not equal the reference string.</span></span><br><span class="line"><span class="comment">#   puts(&quot;Try again.&quot;);</span></span><br><span class="line"><span class="comment"># &#125; else &#123;</span></span><br><span class="line"><span class="comment">#   // The two are equal.</span></span><br><span class="line"><span class="comment">#   puts(&quot;Good Job.&quot;);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If this program has no bugs in it, it would _always_ print &quot;Try again.&quot; since</span></span><br><span class="line"><span class="comment"># user_input copies into random_buffer, not secure_buffer.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The question is: can we find a buffer overflow that will allow us to overwrite</span></span><br><span class="line"><span class="comment"># the random_buffer pointer to point to secure_buffer? (Spoiler: we can, but we</span></span><br><span class="line"><span class="comment"># will need to use Angr.)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We want to identify a place in the binary, when strncpy is called, when we can:</span></span><br><span class="line"><span class="comment">#  1) Control the source contents (not the source pointer!)</span></span><br><span class="line"><span class="comment">#     * This will allow us to write arbitrary data to the destination.</span></span><br><span class="line"><span class="comment">#  2) Control the destination pointer</span></span><br><span class="line"><span class="comment">#     * This will allow us to write to an arbitrary location.</span></span><br><span class="line"><span class="comment"># If we can meet both of those requirements, we can write arbitrary data to an</span></span><br><span class="line"><span class="comment"># arbitrary location. Finally, we need to contrain the source contents to be</span></span><br><span class="line"><span class="comment"># equal to the reference_string and the destination pointer to be equal to the</span></span><br><span class="line"><span class="comment"># secure_buffer.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">  path_to_binary = <span class="string">&#x27;./16_angr_arbitrary_write&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># You can either use a blank state or an entry state; just make sure to start</span></span><br><span class="line">  <span class="comment"># at the beginning of the program.</span></span><br><span class="line">  initial_state = project.factory.entry_state()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ReplacementScanf</span>(angr.SimProcedure):</span><br><span class="line">    <span class="comment"># Hint: scanf(&quot;%u %20s&quot;)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, param0, param1</span>):</span><br><span class="line">      <span class="comment"># %u</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># %20s</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="string">&#x27;A&#x27;</span>, char &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      scanf0_address = param0</span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      scanf1_address = param1</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>] = (scanf0, scanf1)</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># In this challenge, we want to check strncpy to determine if we can control</span></span><br><span class="line">  <span class="comment"># both the source and the destination. It is common that we will be able to</span></span><br><span class="line">  <span class="comment"># control at least one of the parameters, (such as when the program copies a</span></span><br><span class="line">  <span class="comment"># string that it received via stdin).</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">check_strncpy</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="comment"># The stack will look as follows:</span></span><br><span class="line">    <span class="comment"># ...          ________________</span></span><br><span class="line">    <span class="comment"># esp + 15 -&gt; /                \</span></span><br><span class="line">    <span class="comment"># esp + 14 -&gt; |     param2     |</span></span><br><span class="line">    <span class="comment"># esp + 13 -&gt; |      len       |</span></span><br><span class="line">    <span class="comment"># esp + 12 -&gt; \________________/</span></span><br><span class="line">    <span class="comment"># esp + 11 -&gt; /                \</span></span><br><span class="line">    <span class="comment"># esp + 10 -&gt; |     param1     |</span></span><br><span class="line">    <span class="comment">#  esp + 9 -&gt; |      src       |</span></span><br><span class="line">    <span class="comment">#  esp + 8 -&gt; \________________/</span></span><br><span class="line">    <span class="comment">#  esp + 7 -&gt; /                \</span></span><br><span class="line">    <span class="comment">#  esp + 6 -&gt; |     param0     |</span></span><br><span class="line">    <span class="comment">#  esp + 5 -&gt; |      dest      |</span></span><br><span class="line">    <span class="comment">#  esp + 4 -&gt; \________________/</span></span><br><span class="line">    <span class="comment">#  esp + 3 -&gt; /                \</span></span><br><span class="line">    <span class="comment">#  esp + 2 -&gt; |     return     |</span></span><br><span class="line">    <span class="comment">#  esp + 1 -&gt; |     address    |</span></span><br><span class="line">    <span class="comment">#      esp -&gt; \________________/</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    strncpy_src = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line">    strncpy_dest = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line">    strncpy_len = state.memory.load(state.regs.esp + <span class="number">12</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We need to find out if src is symbolic, however, we care about the</span></span><br><span class="line">    <span class="comment"># contents, rather than the pointer itself. Therefore, we have to load the</span></span><br><span class="line">    <span class="comment"># the contents of src to determine if they are symbolic.</span></span><br><span class="line">    <span class="comment"># Hint: How many bytes is strncpy copying?</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    src_contents = state.memory.load(strncpy_src, strncpy_len)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Our goal is to determine if we can write arbitrary data to an arbitrary</span></span><br><span class="line">    <span class="comment"># location. This means determining if the source contents are symbolic </span></span><br><span class="line">    <span class="comment"># (arbitrary data) and the destination pointer is symbolic (arbitrary</span></span><br><span class="line">    <span class="comment"># destination).</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(src_contents) <span class="keyword">and</span> state.solver.symbolic(strncpy_dest):</span><br><span class="line">      <span class="comment"># Use ltrace to determine the reference string. Decompile the binary to </span></span><br><span class="line">      <span class="comment"># determine the address of the buffer it checks the password against. Our </span></span><br><span class="line">      <span class="comment"># goal is to overwrite that buffer to store the password.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      password_string = <span class="string">&#x27;NDYNWEUJ&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">      buffer_address = <span class="number">0x57584344</span> <span class="comment"># :integer, probably in hexadecimal</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create an expression that tests if the first n bytes is length. Warning:</span></span><br><span class="line">      <span class="comment"># while typical Python slices (array[start:end]) will work with bitvectors,</span></span><br><span class="line">      <span class="comment"># they are indexed in an odd way. The ranges must start with a high value</span></span><br><span class="line">      <span class="comment"># and end with a low value. Additionally, the bits are indexed from right</span></span><br><span class="line">      <span class="comment"># to left. For example, let a bitvector, b, equal &#x27;ABCDEFGH&#x27;, (64 bits).</span></span><br><span class="line">      <span class="comment"># The following will read bit 0-7 (total of 1 byte) from the right-most</span></span><br><span class="line">      <span class="comment"># bit (the end of the string).</span></span><br><span class="line">      <span class="comment">#  b[7:0] == &#x27;H&#x27;</span></span><br><span class="line">      <span class="comment"># To access the beginning of the string, we need to access the last 16</span></span><br><span class="line">      <span class="comment"># bits, or bits 48-63:</span></span><br><span class="line">      <span class="comment">#  b[63:48] == &#x27;AB&#x27;</span></span><br><span class="line">      <span class="comment"># In this specific case, since we don&#x27;t necessarily know the length of the</span></span><br><span class="line">      <span class="comment"># contents (unless you look at the binary), we can use the following:</span></span><br><span class="line">      <span class="comment">#  b[-1:-16] == &#x27;AB&#x27;, since, in Python, -1 is the end of the list, and -16</span></span><br><span class="line">      <span class="comment"># is the 16th element from the end of the list. The actual numbers should</span></span><br><span class="line">      <span class="comment"># correspond with the length of password_string.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      does_src_hold_password = src_contents[-<span class="number">1</span>:-<span class="number">64</span>] == password_string</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># Create an expression to check if the dest parameter can be set to</span></span><br><span class="line">      <span class="comment"># buffer_address. If this is true, then we have found our exploit!</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      does_dest_equal_buffer_address = strncpy_dest == buffer_address</span><br><span class="line"></span><br><span class="line">      <span class="comment"># In the previous challenge, we copied the state, added constraints to the</span></span><br><span class="line">      <span class="comment"># copied state, and then determined if the constraints of the new state </span></span><br><span class="line">      <span class="comment"># were satisfiable. Since that pattern is so common, Angr implemented a</span></span><br><span class="line">      <span class="comment"># parameter &#x27;extra_constraints&#x27; for the satisfiable function that does the</span></span><br><span class="line">      <span class="comment"># exact same thing:</span></span><br><span class="line">      <span class="keyword">if</span> state.satisfiable(extra_constraints=(does_src_hold_password, does_dest_equal_buffer_address)):</span><br><span class="line">        state.add_constraints(does_src_hold_password, does_dest_equal_buffer_address)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># not state.se.symbolic(???)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">is_successful</span>(<span class="params">state</span>):</span><br><span class="line">    strncpy_address = <span class="number">0x8048410</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">      <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    scanf0, scanf1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions&#x27;</span>]</span><br><span class="line">    solution0 = (solution_state.solver.<span class="built_in">eval</span>(scanf0))</span><br><span class="line">    solution1 = (solution_state.solver.<span class="built_in">eval</span>(scanf1,cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;0&#125; &#123;1&#125;&quot;</span>.<span class="built_in">format</span>(solution0, solution1))</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure></div>

<h1 id="17-angr-arbitrary-jump"><a href="#17-angr-arbitrary-jump" class="headerlink" title="17_angr_arbitrary_jump"></a>17_angr_arbitrary_jump</h1><p>这题主要是学会任意地址跳转，即利用Angr处理无约束状态。</p>
<p><strong>程序逻辑</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  read_input();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">read_input</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">32</span>]; <span class="comment">// [esp+28h] [ebp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, v1);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __noreturn <span class="title function_">print_good</span><span class="params">()</span> <span class="comment">//	0x42585249</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>exp</strong></p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    path_to_binary = <span class="string">&quot;./17_angr_arbitrary_jump&quot;</span></span><br><span class="line">    proj = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SimScanfProcedure</span>(angr.SimProcedure):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, fmtstr, input_addr</span>):</span><br><span class="line">            input_bvs = claripy.BVS(<span class="string">&#x27;input_addr&#x27;</span>, <span class="number">200</span> * <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span> <span class="built_in">chr</span> <span class="keyword">in</span> input_bvs.chop(bits = <span class="number">8</span>):</span><br><span class="line">                    self.state.add_constraints(<span class="built_in">chr</span> &gt;= <span class="string">&#x27;A&#x27;</span>, <span class="built_in">chr</span> &lt;= <span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">            self.state.memory.store(input_addr, input_bvs)</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;input_val&#x27;</span>] = input_bvs</span><br><span class="line"></span><br><span class="line">    proj.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, SimScanfProcedure())</span><br><span class="line">    init_state = proj.factory.entry_state()</span><br><span class="line">    <span class="comment"># 不丢弃unconstrained中的state</span></span><br><span class="line">    simgr = proj.factory.simgr(init_state,</span><br><span class="line">                              save_unconstrained=<span class="literal">True</span>,</span><br><span class="line">                              stashes=&#123;</span><br><span class="line">                                  <span class="string">&#x27;active&#x27;</span>: [init_state],</span><br><span class="line">                                  <span class="string">&#x27;unconstrained&#x27;</span>: [],</span><br><span class="line">                                  <span class="string">&#x27;found&#x27;</span>: [],</span><br><span class="line">                              &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下一条指令是print_good的情况下有解的state符合条件</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">filter_func</span>(<span class="params">state</span>):</span><br><span class="line">        print_good_addr = <span class="number">0x42585249</span></span><br><span class="line">        <span class="keyword">return</span> state.satisfiable(</span><br><span class="line">            extra_constraints=(state.regs.eip == print_good_addr,))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> simgr.found:</span><br><span class="line">        <span class="comment"># 如果没有可执行的state，或者没找到unconstrained的state，就退出</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> simgr.active) <span class="keyword">and</span> (<span class="keyword">not</span> simgr.unconstrained):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 把符合filter_func的unconstrained转移到found中</span></span><br><span class="line">        simgr.move(from_stash=<span class="string">&#x27;unconstrained&#x27;</span>,</span><br><span class="line">                  to_stash=<span class="string">&#x27;found&#x27;</span>,</span><br><span class="line">                  filter_func=filter_func)</span><br><span class="line"></span><br><span class="line">        simgr.step()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line"></span><br><span class="line">        solution_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        print_good_addr = <span class="number">0x42585249</span></span><br><span class="line">        solution_state.add_constraints(solution_state.regs.eip == print_good_addr)</span><br><span class="line">        input_val = solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;input_val&#x27;</span>],</span><br><span class="line">                                              cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;password: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(input_val))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>


        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> angr入门</li>
        <li><strong>Author:</strong> 韩乔落</li>
        <li><strong>Created at
                :</strong> 2024-07-15 15:18:14</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-07-18 16:41:00
            </li>
        
        <li>
            <strong>Link:</strong> https://jelasin.github.io/2024/07/15/angr入门/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/angr/">#angr</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/08/06/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BATEE/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">深入浅出TEE</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/05/30/Android%E5%AE%89%E5%85%A8-%E5%9F%BA%E7%A1%80%E7%AF%87/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Android安全-基础篇</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'jelasin/jelasin.github.io',
                'data-repo-id': 'R_kgDOKVydDA',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDOKVydDM4CZe2W',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'not-lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">angr入门</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Angr%E7%AE%80%E4%BB%8B"><span class="nav-text">Angr简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#00-angr-find"><span class="nav-text">00_angr_find</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-project"><span class="nav-text">创建 project</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE-state"><span class="nav-text">设置 state</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE-Simulation-Managers"><span class="nav-text">设置 Simulation Managers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%EF%BC%8C%E6%8E%A2%E7%B4%A2%E6%BB%A1%E8%B6%B3%E8%B7%AF%E5%BE%84%E9%9C%80%E8%A6%81%E7%9A%84%E5%80%BC"><span class="nav-text">运行，探索满足路径需要的值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-text">获取执行结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#01-angr-avoid"><span class="nav-text">01_angr_avoid</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#02-angr-find-condition"><span class="nav-text">02_angr_find_condition</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#03-angr-simbolic-registers"><span class="nav-text">03_angr_simbolic_registers</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#states"><span class="nav-text">states</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E9%A2%84%E8%AE%BE"><span class="nav-text">状态预设</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%8D%E5%90%91%E9%87%8F-bitvector"><span class="nav-text">位向量(bitvector)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">访问寄存器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3"><span class="nav-text">约束求解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#04-angr-symbolic-stack"><span class="nav-text">04_angr_symbolic_stack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#eval"><span class="nav-text">eval</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#05-angr-symbolic-memory"><span class="nav-text">05_angr_symbolic_memory</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#state-memery"><span class="nav-text">state.memery</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#06-angr-symbolic-dynamic-memory"><span class="nav-text">06_angr_symbolic_dynamic_memory</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#07-angr-symbolic-file"><span class="nav-text">07_angr_symbolic_file</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8A%B6%E6%80%81%E6%8F%92%E4%BB%B6-state-plugin"><span class="nav-text">状态插件-state plugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BF%E7%9C%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-The-Emulated-Filesystem"><span class="nav-text">仿真文件系统-The Emulated Filesystem</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#08-angr-constraints"><span class="nav-text">08_angr_constraints</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E7%88%86%E7%82%B8"><span class="nav-text">路径爆炸</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3-1"><span class="nav-text">约束求解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#09-angr-hooks"><span class="nav-text">09_angr_hooks</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-angr-simprocedures"><span class="nav-text">10_angr_simprocedures</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-angr-sim-scanf"><span class="nav-text">11_angr_sim_scanf</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#12-angr-veritesting"><span class="nav-text">12_angr_veritesting</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#13-angr-static-binary"><span class="nav-text">13_angr_static_binary</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#14-angr-shared-library"><span class="nav-text">14_angr_shared_library</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#15-angr-arbitrary-read"><span class="nav-text">15_angr_arbitrary_read</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#16-angr-arbitrary-write"><span class="nav-text">16_angr_arbitrary_write</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#17-angr-arbitrary-jump"><span class="nav-text">17_angr_arbitrary_jump</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">关山初度尘未洗，策马扬鞭再奋蹄。</div>
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-circle-info fa-beat-fade" style="--fa-beat-fade-opacity: 0.67; --fa-beat-fade-scale: 1.075;" ></i>&nbsp;&nbsp;<a href="/">韩乔落</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        45 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.1</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/Swup.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/SwupSlideTheme.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/SwupScriptsPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/SwupProgressPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/SwupScrollPlugin.min.js"></script><script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/SwupPreloadPlugin.min.js"></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>






<script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/imageViewer.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/utils.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/main.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/layouts/navbarShrink.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/scrollTopBottom.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/lightDarkSwitch.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/layouts/categoryList.js"></script>


    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/localSearch.js"></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/codeBlock.js"></script>



    <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/layouts/lazyload.js"></script>



    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/runtime.js"></script>
    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/odometer.min.js"></script>
    <link rel="stylesheet" href="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/assets/odometer-theme-minimal.css">



  <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/Typed.min.js"></script>
  <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/plugins/typed.js"></script>







    <script src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/libs/anime.min.js"></script>


<div class="post-scripts" data-swup-reload-script>
    
        <script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/tools/tocToggle.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/layouts/toc.js"></script><script type="module" src="https://evan.beee.top/projects/hexo-theme-redefine@2.7.1/source/js/plugins/tabs.js"></script>
    
</div>


</body>
</html>
