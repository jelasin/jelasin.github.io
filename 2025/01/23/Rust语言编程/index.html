<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="韩乔落">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
        
        
        
    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://jelasin.github.io/2025/01/23/rust语言编程/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
        
        <meta name="description" content="会当身由己，婉转入江湖">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust语言编程">
<meta property="og:url" content="https://jelasin.github.io/2025/01/23/Rust%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="Jelasin">
<meta property="og:description" content="会当身由己，婉转入江湖">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jelasin.github.io/images/touxiang.jpg">
<meta property="article:published_time" content="2025-01-23T06:48:23.000Z">
<meta property="article:modified_time" content="2025-12-31T08:45:59.902Z">
<meta property="article:author" content="Jelasin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jelasin.github.io/images/touxiang.jpg">
    
    
        <!-- Google tag (gtag.js) -->
        <script src="https://www.googletagmanager.com/gtag/js?id=G-3333333333"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3333333333');
        </script>
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/favicon.ico" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <!--- Page Info-->
    
    <title>
        
            Rust语言编程 | Jelasin
        
    </title>

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Chillax/chillax.css">

    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/css/build/tailwind.css">
    

    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/GeistMono/geist-mono.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fonts/Geist/geist.css">
    <!--- Font Part-->
    
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"jelasin.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":true,"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":"Noto Sans SC","url":"https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap"},"english":{"enable":false,"family":"Farsan","url":"https://fonts.googleapis.com/css2?family=Farsan&display=swap"},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js","enable":true,"site_pv":false,"site_uv":false,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":true,"image":"/images/touxiang.jpg","description":"会当身由己，婉转入江湖"},"google_analytics":{"enable":true,"id":"G-3333333333"}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"“会当身由己，婉转入江湖”","subtitle":{"text":["Loading..."],"hitokoto":{"enable":true,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":null,"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"About":{"icon":"fa-regular fa-user","submenus":{"kanxue":"https://bbs.kanxue.com/homepage-958172.htm","Github":"https://github.com/jelasin","中国诗歌网":"https://www.zgshige.com/c/2022-04-13/21151100.shtml"}}},"search":{"enable":true,"preload":false}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"AI":{"path":"/AI","icon":"fa-brands fa-python"},"IOT":{"path":"/IOT","icon":"fas fa-network-wired"},"CTF":{"path":"/CTF","icon":"fa-solid fa-snowflake"},"Web":{"path":"/Web","icon":"fa-solid fa-shield"},"Linux":{"path":"/Linux","icon":"fa-brands fa-linux"},"Android":{"path":"/Android","icon":"fa-brands fa-android"},"Windows":{"path":"/Windows","icon":"fa-brands fa-windows"}}},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":4},"tags":{"enable":true,"limit":4}},"footerStart":"2023/9/20 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/fontawesome.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/brands.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/solid.min.css">
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/fontawesome/regular.min.css">
    
    
    
    
<meta name="generator" content="Hexo 6.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
                <a class="logo-image h-8 w-8 sm:w-10 sm:h-10 mr-3" href="/">
                    <img src="/images/favicon.ico" class="w-full h-full rounded-xs">
                </a>
            
            <a class="logo-title" href="/">
                
                Jelasin
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    ABOUT
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">
                                                    KANXUE
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://github.com/jelasin">
                                                    GITHUB
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">
                                                    中国诗歌网
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                ABOUT
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-958172.htm">KANXUE</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://github.com/jelasin">GITHUB</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           target="_blank" rel="noopener" href="https://www.zgshige.com/c/2022-04-13/21151100.shtml">中国诗歌网</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/AI"
                        >
                            <span>AI</span>
                            <i class="fa-brands fa-python fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/IOT"
                        >
                            <span>IOT</span>
                            <i class="fas fa-network-wired fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/CTF"
                        >
                            <span>CTF</span>
                            <i class="fa-solid fa-snowflake fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Web"
                        >
                            <span>Web</span>
                            <i class="fa-solid fa-shield fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Linux"
                        >
                            <span>Linux</span>
                            <i class="fa-brands fa-linux fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Android"
                        >
                            <span>Android</span>
                            <i class="fa-brands fa-android fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/Windows"
                        >
                            <span>Windows</span>
                            <i class="fa-brands fa-windows fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">39</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">17</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">125</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Rust语言编程</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/touxiang.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">韩乔落</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-01-23 14:48:23</span>
        <span class="mobile">2025-01-23 14:48:23</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-12-31 16:45:59</span>
            <span class="mobile">2025-12-31 16:45:59</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文面向有编程经验的Rust学习者，使用 Cargo 作为包管理器。</p>
<p><strong>参考链接</strong></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://course.rs/basic/variable.html" >[0]Rust Course<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/rust-lang/rfcs/tree/master" >[1]rfcs<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://weread.qq.com/web/reader/89632740813ab9d0dg014a8f" >[2]Rust权威指南(第二版)<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://algo.course.rs/" >[3]Rust算法教程<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://rust-lang.org/learn/" >[4]rust-lang-learn<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.rust-lang.org/" >[5]rust-lang-blog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p><a href="">[6]claude-sonnet-4-5-20250929-thinking</a></p>
<h1 id="Rust中的变量"><a href="#Rust中的变量" class="headerlink" title="Rust中的变量"></a>Rust中的变量</h1><p><strong>Hello world!</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h2><p>在命名方面，和其它语言没有区别，不过当给变量命名时，需要遵循 <a class="link"   target="_blank" rel="noopener" href="https://github.com/rust-lang/rfcs/blob/master/text/0430-finalizing-naming-conventions.md" >Rust 命名规范<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>，也不能使用 <a class="link"   target="_blank" rel="noopener" href="https://course.rs/appendix/keywords.html" >Rust关键字<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="变量绑定"><a href="#变量绑定" class="headerlink" title="变量绑定"></a>变量绑定</h2><p>上面这条语句将 <code>&quot;hello world&quot;</code> 字符串绑定给了变量<code>a</code>，<code>&quot;hello world&quot;</code> 的所有权也就属于<code>a</code>。在Rust中任何内存对象都是有主人的，而且一般情况下完全属于它的主人，绑定就是把这个对象绑定给一个变量，让这个变量成为它的主人。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>所有权转移后，该对象之前的主人就会丧失对该对象的所有权。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 变量绑定 - &quot;hello world&quot; 的所有权属于 a</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a 的值: &#123;&#125;&quot;</span>, a);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 所有权转移 - 将 a 的所有权转移给 b</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = a;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b 的值: &#123;&#125;&quot;</span>, b);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 此时 a 已经失效，无法再使用</span></span><br><span class="line">    <span class="comment">// println!(&quot;a 的值: &#123;&#125;&quot;, a);  // ❌ 编译错误！</span></span><br><span class="line">    <span class="comment">// 错误信息: borrow of moved value: `a`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="变量可变性"><a href="#变量可变性" class="headerlink" title="变量可变性"></a>变量可变性</h2><p>Rust 的变量在默认情况下是<strong>不可变的</strong>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a is a number: &#123;&#125;&quot;</span>, a);</span><br><span class="line">    <span class="comment">// a = 20; // ❌ 编译错误！无法修改不可变变量</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a is a number: &#123;&#125;&quot;</span>, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>我们可以通过 <code>mut</code> 关键字让变量变为<strong>可变的</strong>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">a</span> = <span class="number">10</span>; <span class="comment">// 可变变量</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a is a number: &#123;&#125;&quot;</span>, a);</span><br><span class="line">    a = <span class="number">20</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a is a number: &#123;&#125;&quot;</span>, a); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="忽略未使用的变量"><a href="#忽略未使用的变量" class="headerlink" title="忽略未使用的变量"></a>忽略未使用的变量</h2><p>如果你创建了一个变量却不在任何地方使用它，Rust 通常会给你一个警告，因为这可能会是个 BUG。但是有时创建一个不会被使用的变量是有用的，比如你正在设计原型或刚刚开始一个项目。这时<strong>你希望告诉 Rust 不要警告未使用的变量，为此可以用下划线作为变量名的开头</strong>：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">10</span>; <span class="comment">// #[warn(unused_variables)]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="变量解构"><a href="#变量解构" class="headerlink" title="变量解构"></a>变量解构</h2><p><code>let</code> 表达式不仅仅用于变量的绑定，还能进行复杂变量的解构：从一个相对复杂的变量中，匹配出该变量的一部分内容：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (a, <span class="keyword">mut</span> b): (<span class="type">bool</span>,<span class="type">bool</span>) = (<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// a = true,不可变; b = false，可变</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a = &#123;:?&#125;, b = &#123;:?&#125;&quot;</span>, a, b);</span><br><span class="line"></span><br><span class="line">    b = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="解构式赋值"><a href="#解构式赋值" class="headerlink" title="解构式赋值"></a>解构式赋值</h3><p>在 Rust 1.59 版本后，我们可以在赋值语句的左式中使用元组、切片和结构体模式了。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Struct</span> &#123;</span><br><span class="line">    e: <span class="type">i32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (a, b, c, d, e); <span class="comment">// // ✅ 仅声明，不c初始化</span></span><br><span class="line"></span><br><span class="line">    (a, b) = (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// _ 代表匹配一个值，但是我们不关心具体的值是什么，因此没有使用一个变量名而是使用了 _</span></span><br><span class="line">    [c, .., d, _] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    Struct &#123; e, .. &#125; = Struct &#123; e: <span class="number">5</span> &#125;;</span><br><span class="line">    <span class="comment">// 1 2 1 4 5</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a = &#123;&#125;, b = &#123;&#125;, c = &#123;&#125;, d = &#123;&#125;, e = &#123;&#125;&quot;</span>, a, b, c, d, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="变量与常量"><a href="#变量与常量" class="headerlink" title="变量与常量"></a>变量与常量</h2><p>变量的值不能更改可能让你想起其他另一个很多语言都有的编程概念：<strong>常量</strong>(<em>constant</em>)。与不可变变量一样，常量也是绑定到一个常量名且不允许更改的值，但是常量和变量之间存在一些差异：</p>
<ul>
<li>常量不允许使用 <code>mut</code>。<strong>常量不仅仅默认不可变，而且自始至终不可变</strong>，因为常量在编译完成后，已经确定它的值。</li>
<li>常量使用 <code>const</code> 关键字而不是 <code>let</code> 关键字来声明，并且值的类型<strong>必须</strong>标注。</li>
</ul>
<p>下面是一个常量声明的例子，其常量名为 <code>MAX_POINTS</code>，值设置为 <code>100,000</code>。（Rust 常量的命名约定是全部字母都使用大写，并使用下划线分隔单词，另外对数字字面量可插入下划线以提高可读性）：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_POINTS: <span class="type">u32</span> = <span class="number">100_000</span>;</span><br></pre></td></tr></table></figure></div>

<p>常量可以在任意作用域内声明，包括全局作用域，在声明的作用域内，常量在程序运行的整个过程中都有效。对于需要在多处代码共享一个不可变的值时非常有用，例如游戏中允许玩家赚取的最大点数或光速。</p>
<h2 id="变量遮蔽"><a href="#变量遮蔽" class="headerlink" title="变量遮蔽"></a>变量遮蔽</h2><p>Rust 允许声明相同的变量名，在后面声明的变量会遮蔽掉前面声明的：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// 在main函数的作用域内对之前的x进行遮蔽</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = x + <span class="number">1</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 在当前的花括号作用域内，对之前的x进行遮蔽</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = x * <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// x = 12</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;The value of x in the inner scope is: &#123;&#125;&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// x = 6</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of x is: &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>变量遮蔽的用处在于，如果你在某个作用域内无需再使用之前的变量（在被遮蔽后，无法再访问到之前的同名变量）。</p>
<h1 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h1><p>Rust 每个值都有其确切的数据类型，总的来说可以分为两类：基本类型和复合类型。 基本类型意味着它们往往是一个最小化原子类型，无法解构为其它类型（一般意义上来说），由以下组成：</p>
<ul>
<li>数值类型：有符号整数 (<code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>isize</code>)、 无符号整数 (<code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>usize</code>) 、浮点数 (<code>f32</code>, <code>f64</code>)、以及有理数、复数</li>
<li>字符串：字符串字面量和字符串切片 <code>&amp;str</code></li>
<li>布尔类型：<code>true</code> 和 <code>false</code></li>
<li>字符类型：表示单个 Unicode 字符，存储为 4 个字节</li>
<li>单元类型：即 <code>()</code> ，其唯一的值也是 <code>()</code></li>
</ul>
<h2 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h2><h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><p><strong>整数</strong>是没有小数部分的数字。之前使用过的 <code>i32</code> 类型，表示有符号的 32 位整数（ <code>i</code> 是英文单词 <em>integer</em> 的首字母，与之相反的是 <code>u</code>，代表无符号 <code>unsigned</code> 类型）。下表显示了 Rust 中的内置的整数类型：</p>
<table>
<thead>
<tr>
<th>长度</th>
<th>有符号类型</th>
<th>无符号类型</th>
<th>范围</th>
</tr>
</thead>
<tbody><tr>
<td>8 位</td>
<td><code>i8</code></td>
<td><code>u8</code></td>
<td>-128 ~ 127 &#x2F; 0 ~ 255</td>
</tr>
<tr>
<td>16 位</td>
<td><code>i16</code></td>
<td><code>u16</code></td>
<td>-32,768 ~ 32,767 &#x2F; 0 ~ 65,535</td>
</tr>
<tr>
<td>32 位</td>
<td><code>i32</code></td>
<td><code>u32</code></td>
<td>-2³¹ ~ 2³¹-1 &#x2F; 0 ~ 2³²-1</td>
</tr>
<tr>
<td>64 位</td>
<td><code>i64</code></td>
<td><code>u64</code></td>
<td>-2⁶³ ~ 2⁶³-1 &#x2F; 0 ~ 2⁶⁴-1</td>
</tr>
<tr>
<td>128 位</td>
<td><code>i128</code></td>
<td><code>u128</code></td>
<td>-2¹²⁷ ~ 2¹²⁷-1 &#x2F; 0 ~ 2¹²⁸-1</td>
</tr>
<tr>
<td>视架构而定(32位&#x2F;64位)</td>
<td><code>isize</code></td>
<td><code>usize</code></td>
<td>同 i32&#x2F;u32 或 i64&#x2F;u64</td>
</tr>
</tbody></table>
<p><strong>有符号类型 (iN):</strong></p>
<ul>
<li>范围：<code>-2^(N-1)</code> ~ <code>2^(N-1) - 1</code></li>
</ul>
<p><strong>无符号类型 (uN):</strong></p>
<ul>
<li>范围：<code>0</code> ~ <code>2^N - 1</code></li>
</ul>
<p><strong>整型字面量可以用下表的形式书写：</strong></p>
<table>
<thead>
<tr>
<th>数字字面量</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>十进制</td>
<td><code>98_222</code></td>
</tr>
<tr>
<td>十六进制</td>
<td><code>0xff</code></td>
</tr>
<tr>
<td>八进制</td>
<td><code>0o77</code></td>
</tr>
<tr>
<td>二进制</td>
<td><code>0b1111_0000</code></td>
</tr>
<tr>
<td>字节 (仅限于 <code>u8</code>)</td>
<td><code>b&#39;A&#39;</code></td>
</tr>
</tbody></table>
<p>Rust 整型默认使用 <code>i32</code>，例如 <code>let i = 1</code>，那 <code>i</code> 就是 <code>i32</code> 类型，因此你可以首选它，同时该类型也往往是性能最好的。<code>isize</code> 和 <code>usize</code> 的主要应用场景是用作集合的索引。</p>
<p><strong>整型溢出</strong></p>
<p>假设有一个 <code>u8</code> ，它可以存放从 0 到 255 的值。那么当你将其修改为范围之外的值，比如 256，则会发生<strong>整型溢出</strong>。关于这一行为 Rust 有一些有趣的规则：当在 debug 模式编译时，Rust 会检查整型溢出，若存在这些问题，则使程序在编译时 <em>panic</em>(崩溃,Rust 使用这个术语来表明程序因错误而退出)。</p>
<p>在当使用 <code>--release</code> 参数进行 release 模式构建时，Rust <strong>不</strong>检测溢出。相反，当检测到整型溢出时，Rust 会按照补码循环溢出（<em>two’s complement wrapping</em>）的规则处理。简而言之，大于该类型最大值的数值会被补码转换成该类型能够支持的对应数字的最小值。比如在 <code>u8</code> 的情况下，256 变成 0，257 变成 1，依此类推。程序不会 <em>panic</em>，但是该变量的值可能不是你期望的值。依赖这种默认行为的代码都应该被认为是错误的代码。</p>
<p>要显式处理可能的溢出，可以使用标准库针对原始数字类型提供的这些方法：</p>
<ul>
<li>使用 <code>wrapping_*</code> 方法在所有模式下都按照补码循环溢出规则处理，例如 <code>wrapping_add</code></li>
<li>如果使用 <code>checked_*</code> 方法时发生溢出，则返回 <code>None</code> 值</li>
<li>使用 <code>overflowing_*</code> 方法返回该值和一个指示是否存在溢出的布尔值</li>
<li>使用 <code>saturating_*</code> 方法，可以限定计算后的结果不超过目标类型的最大值或低于最小值，例如:</li>
</ul>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">assert_eq!</span>(<span class="number">100u8</span>.<span class="title function_ invoke__">saturating_add</span>(<span class="number">1</span>), <span class="number">101</span>);</span><br><span class="line"><span class="built_in">assert_eq!</span>(<span class="type">u8</span>::MAX.<span class="title function_ invoke__">saturating_add</span>(<span class="number">127</span>), <span class="type">u8</span>::MAX);</span><br></pre></td></tr></table></figure></div>

<p>下面是一个演示<code>wrapping_*</code>方法的示例：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> : <span class="type">u8</span> = <span class="number">255</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = a.<span class="title function_ invoke__">wrapping_add</span>(<span class="number">20</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, b);  <span class="comment">// 19</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="浮点类型"><a href="#浮点类型" class="headerlink" title="浮点类型"></a>浮点类型</h3><p><strong>浮点类型数字</strong> 是带有小数点的数字，在 Rust 中浮点类型数字也有两种基本类型： <code>f32</code> 和 <code>f64</code>，分别为 32 位和 64 位大小。默认浮点类型是 <code>f64</code>，在现代的 CPU 中它的速度与 <code>f32</code> 几乎相同，但精度更高。</p>
<p>下面是一个演示浮点数的示例：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">2.0</span>; <span class="comment">// f64</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">f32</span> = <span class="number">3.0</span>; <span class="comment">// f32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>浮点数根据 <code>IEEE-754</code> 标准实现。<code>f32</code> 类型是单精度浮点型，<code>f64</code> 为双精度。</p>
<p><strong>浮点陷阱</strong></p>
<p>浮点数由于底层格式的特殊性，导致了如果在使用浮点数时不够谨慎，就可能造成危险，有两个原因：</p>
<ol>
<li><strong>浮点数往往是你想要数字的近似表达</strong> 浮点数类型是基于二进制实现的，但是我们想要计算的数字往往是基于十进制，例如 <code>0.1</code> 在二进制上并不存在精确的表达形式，但是在十进制上就存在。这种不匹配性导致一定的歧义性，更多的，虽然浮点数能代表真实的数值，但是由于底层格式问题，它往往受限于定长的浮点数精度，如果你想要表达完全精准的真实数字，只有使用无限精度的浮点数才行</li>
<li><strong>浮点数在某些特性上是反直觉的</strong> 例如大家都会觉得浮点数可以进行比较，对吧？是的，它们确实可以使用 <code>&gt;</code>，<code>&gt;=</code> 等进行比较，但是在某些场景下，这种直觉上的比较特性反而会害了你。因为 <code>f32</code> ， <code>f64</code> 上的比较运算实现的是 <code>std::cmp::PartialEq</code> 特征(类似其他语言的接口)，但是并没有实现 <code>std::cmp::Eq</code> 特征，但是后者在其它数值类型上都有定义，说了这么多，可能大家还是云里雾里，用一个例子来举例：</li>
</ol>
<p>Rust 的 <code>HashMap</code> 数据结构，是一个 KV 类型的 Hash Map 实现，它对于 <code>K</code> 没有特定类型的限制，但是要求能用作 <code>K</code> 的类型必须实现了 <code>std::cmp::Eq</code> 特征，因此这意味着你无法使用浮点数作为 <code>HashMap</code> 的 <code>Key</code>，来存储键值对，但是作为对比，Rust 的整数类型、字符串类型、布尔类型都实现了该特征，因此可以作为 <code>HashMap</code> 的 <code>Key</code>。</p>
<p>为了避免上面说的两个陷阱，你需要遵守以下准则：</p>
<ul>
<li>避免在浮点数上测试相等性</li>
<li>当结果在数学上可能存在未定义时，需要格外的小心。</li>
</ul>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">abc</span>: (<span class="type">f32</span>, <span class="type">f32</span>, <span class="type">f32</span>) = (<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">xyz</span>: (<span class="type">f64</span>, <span class="type">f64</span>, <span class="type">f64</span>) = (<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;abc (f32)&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;   0.1 + 0.2: &#123;:x&#125;&quot;</span>, (abc.<span class="number">0</span> + abc.<span class="number">1</span>).<span class="title function_ invoke__">to_bits</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;         0.3: &#123;:x&#125;&quot;</span>, (abc.<span class="number">2</span>).<span class="title function_ invoke__">to_bits</span>());</span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;xyz (f64)&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;   0.1 + 0.2: &#123;:x&#125;&quot;</span>, (xyz.<span class="number">0</span> + xyz.<span class="number">1</span>).<span class="title function_ invoke__">to_bits</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;         0.3: &#123;:x&#125;&quot;</span>, (xyz.<span class="number">2</span>).<span class="title function_ invoke__">to_bits</span>());</span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert!</span>(abc.<span class="number">0</span> + abc.<span class="number">1</span> == abc.<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">assert!</span>(xyz.<span class="number">0</span> + xyz.<span class="number">1</span> == xyz.<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// abc (f32)</span></span><br><span class="line"><span class="comment">//    0.1 + 0.2: 3e99999a</span></span><br><span class="line"><span class="comment">//          0.3: 3e99999a</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// xyz (f64)</span></span><br><span class="line"><span class="comment">//    0.1 + 0.2: 3fd3333333333334</span></span><br><span class="line"><span class="comment">//          0.3: 3fd3333333333333</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// thread &#x27;main&#x27; panicked at &#x27;assertion failed: xyz.0 + xyz.1 == xyz.2&#x27;,</span></span><br></pre></td></tr></table></figure></div>

<p>对 <code>f32</code> 类型做加法时，<code>0.1 + 0.2</code> 的结果是 <code>3e99999a</code>，<code>0.3</code> 也是 <code>3e99999a</code>，因此 <code>f32</code> 下的 <code>0.1 + 0.2 == 0.3</code> 通过测试，但是到了 <code>f64</code> 类型时，结果就不一样了，因为 <code>f64</code> 二进制精度高很多，导致了 0.1 + 0.2 并不严格等于 0.3，它们可能在小数点 N 位后存在误差。<code>0.1 + 0.2</code> 以 <code>4</code> 结尾，但是 <code>0.3</code> 以<code>3</code>结尾，这个区别导致 <code>f64</code> 下的测试失败了，并且抛出了异常。</p>
<p><strong>NaN</strong></p>
<p>对于数学上未定义的结果，例如对负数取平方根 <code>-42.1.sqrt()</code> ，会产生一个特殊的结果：Rust 的浮点数类型使用 <code>NaN</code> (not a number) 来处理这些情况。</p>
<p>**所有跟 <code>NaN</code> 交互的操作，都会返回一个 <code>NaN</code>**，而且 <code>NaN</code> 不能用来比较，下面的代码会崩溃：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">x</span> = (-<span class="number">42.0_f32</span>).<span class="title function_ invoke__">sqrt</span>();</span><br><span class="line">  <span class="built_in">assert_eq!</span>(x, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>出于防御性编程的考虑，可以使用 <code>is_nan()</code> 等方法，可以用来判断一个数值是否是 <code>NaN</code> ：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = (-<span class="number">42.0_f32</span>).<span class="title function_ invoke__">sqrt</span>();</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">is_nan</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;未定义的数学行为&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="数字运算"><a href="#数字运算" class="headerlink" title="数字运算"></a>数字运算</h3><p>Rust 支持所有数字类型的基本数学运算：加法、减法、乘法、除法和取模运算。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 三种类型标注方式</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">10</span>;           <span class="comment">// 自动推导为 i32</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: <span class="type">i32</span> = <span class="number">20</span>;      <span class="comment">// 类型标注</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="number">30i32</span>;        <span class="comment">// 类型后缀</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 基本运算（类型必须相同）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;加法: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, a, b, a + b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;减法: &#123;&#125; - &#123;&#125; = &#123;&#125;&quot;</span>, b, a, b - a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;乘法: &#123;&#125; * &#123;&#125; = &#123;&#125;&quot;</span>, a, c, a * c);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;除法: &#123;&#125; / &#123;&#125; = &#123;&#125;&quot;</span>, c, a, c / a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;取模: &#123;&#125; % &#123;&#125; = &#123;&#125;&quot;</span>, b, a, b % a);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数字分隔符（提升可读性）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">million</span>: <span class="type">i64</span> = <span class="number">1_000_000</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;百万的平方: &#123;&#125;&quot;</span>, million.<span class="title function_ invoke__">pow</span>(<span class="number">2</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 浮点数运算</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">10.0</span>;         <span class="comment">// 自动推导为 f64</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">3.5f32</span>;       <span class="comment">// 明确指定为 f32</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;浮点除法: &#123;:.2&#125;&quot;</span>, x / <span class="number">2.0</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;f32: &#123;:.3&#125;&quot;</span>, y * <span class="number">2.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h3><p>Rust 的位运算基本上和其他语言一样</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>&amp; 位与</td>
<td>相同位置均为1时则为1，否则为0</td>
</tr>
<tr>
<td>| 位或</td>
<td>相同位置只要有1时则为1，否则为0</td>
</tr>
<tr>
<td>^ 异或</td>
<td>相同位置不相同则为1，相同则为0</td>
</tr>
<tr>
<td>! 位非</td>
<td>把位中的0和1相互取反，即0置为1，1置为0</td>
</tr>
<tr>
<td>&lt;&lt; 左移</td>
<td>所有位向左移动指定位数，右位补0（会改变符号位）</td>
</tr>
<tr>
<td>&gt;&gt; 右移</td>
<td>所有位向右移动指定位数，<strong>行为取决于类型</strong>：<br>• 有符号类型（i8&#x2F;i16&#x2F;i32等）：算术右移，保持符号位<br>• 无符号类型（u8&#x2F;u16&#x2F;u32等）：逻辑右移，补0</td>
</tr>
</tbody></table>
<p><strong>重要说明：</strong></p>
<ul>
<li><p>Rust <strong>没有</strong>单独的逻辑右移运算符（如 Java 的 <code>&gt;&gt;&gt;</code>）</p>
</li>
<li><p>右移 <code>&gt;&gt;</code> 的行为完全由操作数的类型决定</p>
</li>
<li><p>如需对有符号数进行逻辑右移，可转换为无符号类型后再右移</p>
</li>
<li><p><strong>复合赋值</strong>：支持 <code>&amp;=</code>、<code>|=</code>、<code>^=</code>、<code>&lt;&lt;=</code>、<code>&gt;&gt;=</code></p>
</li>
<li><p><strong>左移溢出</strong>：超出类型范围的位会被丢弃</p>
</li>
</ul>
<p><strong>示例</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ========== 基本位运算 ==========</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">0b1100u8</span>;  <span class="comment">// 12 (二进制：1100)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="number">0b1010u8</span>;  <span class="comment">// 10 (二进制：1010)</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, a, a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, b, b);</span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line">    <span class="comment">// 位与 &amp;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a &amp; b  = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, a &amp; b, a &amp; b);  <span class="comment">// 1000 = 8</span></span><br><span class="line">    <span class="comment">// 位或 |</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a | b  = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, a | b, a | b);  <span class="comment">// 1110 = 14</span></span><br><span class="line">    <span class="comment">// 异或 ^</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a ^ b  = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, a ^ b, a ^ b);  <span class="comment">// 0110 = 6</span></span><br><span class="line">    <span class="comment">// 位非 !</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;!a     = &#123;:08b&#125; (&#123;&#125;)&quot;</span>, !a, !a);        <span class="comment">// 11110011 = 243</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>关于移位运算：</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">neg</span>: <span class="type">i8</span> = -<span class="number">120</span>;  <span class="comment">// 10001000</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;========== 移位操作对比 ==========\n&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;测试值: &#123;&#125; = &#123;:08b&#125;\n&quot;</span>, neg, neg <span class="keyword">as</span> <span class="type">u8</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 右移：核心区别</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;--- 右移2位 ---&quot;</span>);</span><br><span class="line">    <span class="comment">// 算术右移: -120 &gt;&gt; 2  = -30 = 11100010  (补1)</span></span><br><span class="line">    <span class="comment">// 逻辑右移: -120 &gt;&gt;&gt; 2 =  34 = 00100010  (补0)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;算术右移: &#123;&#125; &gt;&gt; 2  = &#123;:3&#125; = &#123;:08b&#125;  (补1)&quot;</span>, neg, neg &gt;&gt; <span class="number">2</span>, (neg &gt;&gt; <span class="number">2</span>) <span class="keyword">as</span> <span class="type">u8</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;逻辑右移: &#123;&#125; &gt;&gt;&gt; 2 = &#123;:3&#125; = &#123;:08b&#125;  (补0)&quot;</span>, neg, (neg <span class="keyword">as</span> <span class="type">u8</span>) &gt;&gt; <span class="number">2</span>, (neg <span class="keyword">as</span> <span class="type">u8</span>) &gt;&gt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 左移：完全相同</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;\n--- 左移2位 ---&quot;</span>);</span><br><span class="line">    <span class="comment">// 算术左移: -120 &lt;&lt; 2 =  32 = 00100000</span></span><br><span class="line">    <span class="comment">// 逻辑左移: -120 &lt;&lt;&lt; 2 =  32 = 00100000</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;算术左移: &#123;&#125; &lt;&lt; 2 = &#123;:3&#125; = &#123;:08b&#125;&quot;</span>, neg, neg &lt;&lt; <span class="number">2</span>, (neg &lt;&lt; <span class="number">2</span>) <span class="keyword">as</span> <span class="type">u8</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;逻辑左移: &#123;&#125; &lt;&lt;&lt; 2 = &#123;:3&#125; = &#123;:08b&#125;&quot;</span>, neg, (neg <span class="keyword">as</span> <span class="type">u8</span>) &lt;&lt; <span class="number">2</span>, (neg <span class="keyword">as</span> <span class="type">u8</span>) &lt;&lt; <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="序列-Range"><a href="#序列-Range" class="headerlink" title="序列(Range)"></a>序列(Range)</h3><p>Rust 提供了一个非常简洁的方式，用来生成连续的数值，例如 <code>1..5</code>，生成从 1 到 4 的连续数字，不包含 5 ；<code>1..=5</code>，生成从 1 到 5 的连续数字，包含 5，它的用途很简单，常常用于循环中：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>序列只允许用于数字或字符类型，原因是它们可以连续，同时编译器在编译期可以检查该序列是否为空，字符和数字值是 Rust 中仅有的可以用于判断是否为空的类型。如下是一个使用字符类型序列的例子：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="string">&#x27;a&#x27;</span>..=<span class="string">&#x27;z&#x27;</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="字符类型"><a href="#字符类型" class="headerlink" title="字符类型"></a>字符类型</h2><p>Rust 的字符不仅仅是 <code>ASCII</code>，所有的 <code>Unicode</code> 值都可以作为 Rust 字符，包括单个的中文、日文、韩文、emoji 表情符号等等，都是合法的字符类型。<code>Unicode</code> 值的范围从 <code>U+0000 ~ U+D7FF</code> 和 <code>U+E000 ~ U+10FFFF</code>。由于 <code>Unicode</code> 都是 4 个字节编码，因此Rust的字符类型也是占用 4 个字节。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = <span class="string">&#x27;ℤ&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">g</span> = <span class="string">&#x27;国&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">heart_eyed_cat</span> = &#x27;😻&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h2><p>Rust 中的布尔类型有两个可能的值：<code>true</code> 和 <code>false</code>，布尔值占用内存的大小为 <code>1</code> 个字节：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span>: <span class="type">bool</span> = <span class="literal">false</span>; <span class="comment">// 使用类型标注,显式指定f的类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> f &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;这是段毫无意义的代码&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="单元类型"><a href="#单元类型" class="headerlink" title="单元类型"></a>单元类型</h2><p>单元类型就是 <code>()</code>，唯一的值也是 <code>()</code> 。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✓ 返回单元类型 ()</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">normal</span>() <span class="punctuation">-&gt;</span> () &#123; &#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123; &#125;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✓ 发散函数（永不返回）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">diverge</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;crash!&quot;</span>);</span><br><span class="line">    <span class="comment">// 或 loop &#123;&#125;</span></span><br><span class="line">    <span class="comment">// 或 std::process::exit(0)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>定义</strong></td>
<td align="left"><code>()</code> 既是类型也是唯一的值</td>
</tr>
<tr>
<td align="left"><strong>大小</strong></td>
<td align="left">0 字节，不占内存</td>
</tr>
<tr>
<td align="left"><strong>main 返回</strong></td>
<td align="left">返回 <code>()</code>，不是”无返回值”</td>
</tr>
<tr>
<td align="left"><strong>用途</strong></td>
<td align="left">占位符、表示”不关心返回值”</td>
</tr>
<tr>
<td align="left"><strong>区别</strong></td>
<td align="left"><code>-&gt; ()</code> 有返回值，<code>-&gt; !</code> 才是永不返回（发散函数，即没有返回值）</td>
</tr>
</tbody></table>
<h2 id="语句和表达式"><a href="#语句和表达式" class="headerlink" title="语句和表达式"></a>语句和表达式</h2><p>Rust 的函数体是由一系列语句组成，最后由一个表达式来返回值，例如：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">add_with_extra</span>(x: <span class="type">i32</span>, y: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = x + <span class="number">1</span>; <span class="comment">// 语句</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = y + <span class="number">5</span>; <span class="comment">// 语句</span></span><br><span class="line">    x + y <span class="comment">// 表达式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>语句会执行一些操作但是不会返回一个值，而表达式会在求值后返回一个值，因此在上述函数体的三行代码中，前两行是语句，最后一行是表达式。</p>
<p>对于 Rust 语言而言，<strong>这种基于语句（statement）和表达式（expression）的方式是非常重要的，你需要能明确的区分这两个概念</strong>，但是对于很多其它语言而言，这两个往往无需区分。基于表达式是函数式语言的重要特征，<strong>表达式总要返回值</strong>。</p>
<h3 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = <span class="number">8</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">b</span>: <span class="type">Vec</span>&lt;<span class="type">f64</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> (a, c) = (<span class="string">&quot;hi&quot;</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></div>

<p>以上都是语句，它们完成了一个具体的操作，但是并没有返回值，因此是语句。</p>
<p>由于 <code>let</code> 是语句，因此不能将 <code>let</code> 语句赋值给其它值，如下形式是错误的：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">b</span> = (<span class="keyword">let</span> <span class="variable">a</span> = <span class="number">8</span>);<span class="comment">// variable declaration using `let` is a statement `let`是一条语句</span></span><br></pre></td></tr></table></figure></div>

<h3 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h3><p>表达式会进行求值，然后返回一个值。例如 <code>5 + 6</code>，在求值后，返回值 <code>11</code>，因此它就是一条表达式。</p>
<p>表达式可以成为语句的一部分，例如 <code>let y = 6</code> 中，<code>6</code> 就是一个表达式，它在求值后返回一个值 <code>6</code>。调用一个函数是表达式，因为会返回一个值，调用宏也是表达式，用花括号包裹最终返回一个值的语句块也是表达式，总之，能返回值，它就是表达式:</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">3</span>;</span><br><span class="line">        x + <span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of y is: &#123;&#125;&quot;</span>, y); <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>上面使用一个语句块表达式将值赋给 <code>y</code> 变量，语句块长这样：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">3</span>;</span><br><span class="line">    x + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>该语句块是表达式的原因是：它的最后一行是表达式，返回了 <code>x + 1</code> 的值，注意 <code>x + 1</code> 不能以分号结尾，否则就会从表达式变成语句， <strong>表达式不能包含分号</strong>。这一点非常重要，一旦你在表达式后加上分号，它就会变成一条语句，再也<strong>不会</strong>返回一个值，请牢记！</p>
<p>最后，表达式如果不返回任何值，会隐式地返回一个 <code>()</code> 。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">ret_unit_type</span>(), ())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">ret_unit_type</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// if 语句块也是一个表达式，因此可以用于赋值，也可以直接返回</span></span><br><span class="line">    <span class="comment">// 类似三元运算符，在Rust里我们可以这样写</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="string">&quot;odd&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">&quot;even&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 或者写成一行</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">1</span> &#123; <span class="string">&quot;odd&quot;</span> &#125; <span class="keyword">else</span> &#123; <span class="string">&quot;even&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>以 add 函数为例，声明函数的关键字 <code>fn</code>，函数名 <code>add()</code>，参数 <code>i: i32</code> 和 <code>j: i32</code>，参数类型和返回值类型都是 <code>i32</code>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>(i: <span class="type">i32</span>, j: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">   i + j</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>



<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/01/23/Rust%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B/v2-54b3a6d435d2482243edc4be9ab98153_1440w.png"
                      alt="img"
                ></p>
<p><strong>函数要点</strong></p>
<ul>
<li>函数名和变量名使用蛇形命名法<code>(snake_case)</code>，例如 <code>fn add_two() &#123;&#125;</code></li>
<li>函数的位置可以随便放，Rust 不关心我们在哪里定义了函数，只要有定义即可</li>
<li>每个函数参数都需要标注类型</li>
</ul>
<h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><p>Rust 是静态类型语言，因此需要你为每一个函数参数都标识出它的具体类型，例如：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">another_function</span>(<span class="number">5</span>, <span class="number">6.1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">another_function</span>(x: <span class="type">i32</span>, y: <span class="type">f32</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of x is: &#123;&#125;&quot;</span>, x);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of y is: &#123;&#125;&quot;</span>, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>another_function</code> 函数有两个参数，其中 <code>x</code> 是 <code>i32</code> 类型，<code>y</code> 是 <code>f32</code> 类型，然后在该函数内部，打印出这两个值。这里去掉 <code>x</code> 或者 <code>y</code> 的任何一个的类型，都会报错。</p>
<h3 id="函数返回"><a href="#函数返回" class="headerlink" title="函数返回"></a>函数返回</h3><p>在 Rust 中函数就是表达式，因此我们可以把函数的返回值直接赋给调用者。</p>
<p>函数的返回值就是函数体最后一条表达式的返回值，当然我们也可以使用 <code>return</code> 提前返回，下面的函数使用最后一条表达式来返回一个值：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_number</span>(x:<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        x + <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="title function_ invoke__">plus_number</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The value of x is: &#123;&#125;&quot;</span>, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>返回单元类型</strong></p>
<p>单元类型 <code>()</code>，是一个零长度的元组。它没啥作用，但是可以用来表达一个函数没有返回值：</p>
<ul>
<li>函数没有返回值，那么返回一个 <code>()</code></li>
<li>通过 <code>;</code> 结尾的语句返回一个 <code>()</code></li>
</ul>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_number</span>(x:<span class="type">i32</span>) &#123;</span><br><span class="line">    x + <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">plus_number</span>(x:<span class="type">i32</span>) <span class="punctuation">-&gt;</span> () &#123;</span><br><span class="line">    x + <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>永不返回的发散函数 !</strong></p>
<p>当用 <code>!</code> 作函数返回类型的时候，表示该函数永不返回( diverging functions )，特别的，这种语法往往用做会导致程序崩溃的函数：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">dead_end</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">  <span class="built_in">panic!</span>(<span class="string">&quot;dead_end&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>下面的函数创建了一个无限循环，该循环永不跳出，因此函数也永不返回：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">forever</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">  <span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="所有权和借用"><a href="#所有权和借用" class="headerlink" title="所有权和借用"></a>所有权和借用</h1><h2 id="所有权"><a href="#所有权" class="headerlink" title="所有权"></a>所有权</h2><p>Rust <strong>通过所有权来管理内存</strong>，这种检查只发生在编译期，因此对于程序运行期，不会有性能上的损失。</p>
<blockquote>
<ol>
<li>Rust 中每一个值都被一个变量所拥有，该变量被称为值的所有者</li>
<li>一个值同时只能被一个变量所拥有，或者说一个值只能拥有一个所有者</li>
<li>当所有者（变量）离开作用域范围时，这个值将被丢弃(drop)</li>
</ol>
</blockquote>
<h3 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h3><p>作用域是一个变量在程序中有效的范围，假如有这样一个变量：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;hello&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<p>变量 <code>s</code> 绑定到了一个字符串字面值，该字符串字面值是硬编码到程序代码中的。<code>s</code> 变量从声明的点开始直到当前作用域的结束都是有效的：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;                      <span class="comment">// s 在这里无效，它尚未声明</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;hello&quot;</span>;   <span class="comment">// 从此处起，s 是有效的</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 s</span></span><br><span class="line">&#125;                      <span class="comment">// 此作用域已结束，s不再有效</span></span><br></pre></td></tr></table></figure></div>

<p>简而言之，<code>s</code> 从创建开始就有效，然后有效期持续到它离开作用域为止，可以看出，就作用域来说，Rust 语言跟其他编程语言没有区别。</p>
<h3 id="所有权转移"><a href="#所有权转移" class="headerlink" title="所有权转移"></a>所有权转移</h3><p>先来看一段代码：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = x;</span><br></pre></td></tr></table></figure></div>

<p>这段代码并没有发生所有权的转移，原因很简单： 代码首先将 <code>5</code> 绑定到变量 <code>x</code>，接着<strong>拷贝</strong> <code>x</code> 的值赋给 <code>y</code>，最终 <code>x</code> 和 <code>y</code> 都等于 <code>5</code>，因为整数是 Rust 基本数据类型，是固定大小的简单值，因此这两个值都是通过<strong>自动拷贝</strong>的方式来赋值的，都被存在栈中，完全无需在堆上分配内存。整个过程中的赋值都是通过值拷贝的方式完成（发生在栈中），因此并不需要所有权转移。</p>
<p><strong>移动(move)</strong></p>
<p>然后再来看一段代码：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span> = s1;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, world!&quot;</span>, s1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>String</code> 类型是一个复杂类型，由存储在栈中的<strong>堆指针</strong>、<strong>字符串长度</strong>、<strong>字符串容量</strong>共同组成。<code>String</code> 类型指向了一个堆上的空间，这里存储着它的真实数据。<strong>当 <code>s1</code> 被赋予 <code>s2</code> 后，Rust 认为 <code>s1</code> 不再有效，因此也无需在 <code>s1</code> 离开作用域后 <code>drop</code> 任何东西，这就是把所有权从 <code>s1</code> 转移给了 <code>s2</code>，<code>s1</code> 在被赋予 <code>s2</code> 后就马上失效了</strong>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">String</span> &#123;</span><br><span class="line">    vec: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;,  <span class="comment">// 内部使用Vec&lt;u8&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Vec&lt;u8&gt; 的结构</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Vec</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: *<span class="keyword">mut</span> T,      <span class="comment">// 指向堆数据的指针 (8字节 on 64-bit)</span></span><br><span class="line">    len: <span class="type">usize</span>,       <span class="comment">// 当前长度 (8字节 on 64-bit)</span></span><br><span class="line">    cap: <span class="type">usize</span>,       <span class="comment">// 容量 (8字节 on 64-bit)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>深拷贝(clone)</strong></p>
<p>首先，<strong>Rust 永远也不会自动创建数据的 “深拷贝”</strong>。因此，任何<strong>自动</strong>的复制都不是深拷贝，可以被认为对运行时性能影响较小。</p>
<p>如果我们<strong>确实</strong>需要深度复制 <code>String</code> 中堆上的数据，而不仅仅是栈上的数据，可以使用一个叫做 <code>clone</code> 的方法。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">s1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s2</span> = s1.<span class="title function_ invoke__">clone</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;s1 = &#123;&#125;, s2 = &#123;&#125;&quot;</span>, s1, s2);</span><br></pre></td></tr></table></figure></div>

<p>这段代码能够正常运行，说明 <code>s2</code> 确实完整的复制了 <code>s1</code> 的数据。</p>
<p>如果代码性能无关紧要，例如初始化程序时或者在某段时间只会执行寥寥数次时，你可以使用 <code>clone</code> 来简化编程。但是对于执行较为频繁的代码（热点路径），使用 <code>clone</code> 会极大的降低程序性能，需要小心使用！</p>
<p><strong>浅拷贝(copy)</strong></p>
<blockquote>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>Copy</code> 类型在赋值时会<strong>按位复制</strong>（栈上复制）</li>
<li>实现 <code>Copy</code> 的类型<strong>不能</strong>拥有堆上的数据</li>
<li><code>Copy</code> 是<strong>隐式</strong>的，<code>Clone</code> 是<strong>显式</strong>的</li>
</ul>
</blockquote>
<p>Rust 有一个叫做 <code>Copy</code> 的特征，可以用在类似整型这样在栈中存储的类型。如果一个类型拥有 <code>Copy</code> 特征，一个旧的变量在被赋值给其他变量后仍然可用，也就是赋值的过程即是拷贝的过程。</p>
<p>如下是一些 <code>Copy</code> 的类型：</p>
<ul>
<li>所有整数类型，比如 <code>u32</code></li>
<li>布尔类型，<code>bool</code>，它的值是 <code>true</code> 和 <code>false</code></li>
<li>所有浮点数类型，比如 <code>f64</code></li>
<li>字符类型，<code>char</code></li>
<li>元组，当且仅当其包含的类型也都是 <code>Copy</code> 的时候。比如，<code>(i32, i32)</code> 是 <code>Copy</code> 的，但 <code>(i32, String)</code> 就不是</li>
<li>不可变引用 <code>&amp;T</code> ，但是注意：可变引用 <code>&amp;mut T</code> 是不可以 Copy的。</li>
</ul>
<p><strong>一个类型可以是 Copy 的，当且仅当</strong>：</p>
<ol>
<li>✅ 所有字段都实现了 <code>Copy</code></li>
<li>✅ 不拥有任何堆上的资源</li>
<li>✅ 没有实现 <code>Drop</code> trait</li>
<li>✅ 是固定大小的（<code>Sized</code>）</li>
</ol>
<h3 id="函数传值和返回"><a href="#函数传值和返回" class="headerlink" title="函数传值和返回"></a>函数传值和返回</h3><p>将值传递给函数，一样会发生 <code>移动</code> 或者 <code>复制</code>，就跟 <code>let</code> 语句一样，下面的代码展示了所有权、作用域的规则：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);  <span class="comment">// s 进入作用域</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">takes_ownership</span>(s);             <span class="comment">// s 的值移动到函数里 ...</span></span><br><span class="line">                                    <span class="comment">// ... 所以到这里不再有效</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;                      <span class="comment">// x 进入作用域</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">makes_copy</span>(x);                  <span class="comment">// x 应该移动函数里，</span></span><br><span class="line">                                    <span class="comment">// 但 i32 是 Copy 的，所以在后面可继续使用 x</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// 这里, x 先移出了作用域，然后是 s。但因为 s 的值已被移走，</span></span><br><span class="line">  <span class="comment">// 所以不会有特殊操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">takes_ownership</span>(some_string: <span class="type">String</span>) &#123; <span class="comment">// some_string 进入作用域</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, some_string);</span><br><span class="line">&#125; <span class="comment">// 这里，some_string 移出作用域并调用 `drop` 方法。占用的内存被释放</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">makes_copy</span>(some_integer: <span class="type">i32</span>) &#123; <span class="comment">// some_integer 进入作用域</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, some_integer);</span><br><span class="line">&#125; <span class="comment">// 这里，some_integer 移出作用域。不会有特殊操作</span></span><br></pre></td></tr></table></figure></div>

<p>同样的，函数返回值也有所有权，例如:</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span> = <span class="title function_ invoke__">gives_ownership</span>();         <span class="comment">// gives_ownership 将返回值</span></span><br><span class="line">                                        <span class="comment">// 移给 s1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);     <span class="comment">// s2 进入作用域</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s3</span> = <span class="title function_ invoke__">takes_and_gives_back</span>(s2);  <span class="comment">// s2 被移动到</span></span><br><span class="line">                                        <span class="comment">// takes_and_gives_back 中,</span></span><br><span class="line">                                        <span class="comment">// 它也将返回值移给 s3</span></span><br><span class="line">&#125; <span class="comment">// 这里, s3 移出作用域并被丢弃。s2 也移出作用域，但已被移走，</span></span><br><span class="line">  <span class="comment">// 所以什么也不会发生。s1 移出作用域并被丢弃</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">gives_ownership</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;             <span class="comment">// gives_ownership 将返回值移动给</span></span><br><span class="line">                                             <span class="comment">// 调用它的函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">some_string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>); <span class="comment">// some_string 进入作用域.</span></span><br><span class="line"></span><br><span class="line">    some_string                              <span class="comment">// 返回 some_string 并移出给调用的函数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// takes_and_gives_back 将传入字符串并返回该值</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">takes_and_gives_back</span>(a_string: <span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123; <span class="comment">// a_string 进入作用域</span></span><br><span class="line"></span><br><span class="line">    a_string  <span class="comment">// 返回 a_string 并移出给调用的函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>所有权很强大，避免了内存的不安全性，但是也带来了一个新麻烦： <strong>总是把一个值传来传去来使用它</strong>。 传入一个函数，很可能还要从该函数传出去，结果就是语言表达变得非常啰嗦，幸运的是，Rust 提供了新功能解决这个问题。</p>
<h2 id="引用和借用"><a href="#引用和借用" class="headerlink" title="引用和借用"></a>引用和借用</h2><h3 id="引用与解引用"><a href="#引用与解引用" class="headerlink" title="引用与解引用"></a>引用与解引用</h3><p>常规引用是一个指针类型，指向了对象存储的内存地址。在下面代码中，我们创建一个 <code>i32</code> 值的引用 <code>y</code>，然后使用解引用运算符来解出 <code>y</code> 所使用的值:</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = &amp;x;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, x);</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="number">5</span>, *y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>变量 <code>x</code> 存放了一个 <code>i32</code> 值 <code>5</code>。<code>y</code> 是 <code>x</code> 的一个引用。可以断言 <code>x</code> 等于 <code>5</code>。然而，如果希望对 <code>y</code> 的值做出断言，必须使用 <code>*y</code> 来解出引用所指向的值（也就是<strong>解引用</strong>）。一旦解引用了 <code>y</code>，就可以访问 <code>y</code> 所指向的整型值并可以与 <code>5</code> 做比较。</p>
<h3 id="不可变引用"><a href="#不可变引用" class="headerlink" title="不可变引用"></a>不可变引用</h3><p>下面的代码，我们用 <code>s1</code> 的引用作为参数传递给 <code>calculate_length</code> 函数，而不是把 <code>s1</code> 的所有权转移给该函数：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = <span class="title function_ invoke__">calculate_length</span>(&amp;s1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;The length of &#x27;&#123;&#125;&#x27; is &#123;&#125;.&quot;</span>, s1, len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 函数 calculate_length 使用 &amp; 来表明参数 s 的类型是一个引用：</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate_length</span>(s: &amp;<span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    s.<span class="title function_ invoke__">len</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里，<code>&amp;</code> 符号即是引用，它们允许你使用值，但是不获取所有权。通过 <code>&amp;s1</code> 语法，我们创建了一个<strong>指向 <code>s1</code> 的引用</strong>，但是并不拥有它。因为并不拥有这个值，当引用离开作用域后，其指向的值也不会被丢弃。</p>
<h3 id="可变引用"><a href="#可变引用" class="headerlink" title="可变引用"></a>可变引用</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">change</span>(&amp;<span class="keyword">mut</span> s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">change</span>(some_string: &amp;<span class="keyword">mut</span> <span class="type">String</span>) &#123;</span><br><span class="line">    some_string.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;, world&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先，声明 <code>s</code> 是可变类型，其次创建一个可变的引用 <code>&amp;mut s</code> 和接受可变引用参数 <code>some_string: &amp;mut String</code> 的函数。可变引用同时只能存在一个，可变引用并不是随心所欲、想用就用的，它有一个很大的限制： <strong>同一作用域，特定数据只能有一个可变引用</strong>：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">r1</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">r2</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, &#123;&#125;&quot;</span>, r1, r2);</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">error[E0499]: cannot borrow `s` <span class="keyword">as</span> mutable more than once at a time 同一时间无法对 `s` 进行两次可变借用</span><br><span class="line"> -<span class="punctuation">-&gt;</span> src/main.rs:<span class="number">5</span>:<span class="number">14</span></span><br><span class="line">  |</span><br><span class="line"><span class="number">4</span> |     <span class="keyword">let</span> <span class="variable">r1</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line">  |              ------ first mutable borrow occurs here 首个可变引用在这里借用</span><br><span class="line"><span class="number">5</span> |     <span class="keyword">let</span> <span class="variable">r2</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line">  |              ^^^^^^ second mutable borrow occurs here 第二个可变引用在这里借用</span><br><span class="line"><span class="number">6</span> |</span><br><span class="line"><span class="number">7</span> |     <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, &#123;&#125;&quot;</span>, r1, r2);</span><br><span class="line">  |                        -- first borrow later used here 第一个借用在这里使用</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>在数据被可变借用期间，<strong>原所有者完全失去对数据的访问权</strong>，既不能读也不能写。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">r1</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line">s.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;, world!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, r1);</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error[E0499]: cannot borrow `s` <span class="keyword">as</span> mutable more than once at a time</span><br><span class="line"> -<span class="punctuation">-&gt;</span> src/main.rs:<span class="number">5</span>:<span class="number">5</span></span><br><span class="line">  |</span><br><span class="line"><span class="number">4</span> |     <span class="keyword">let</span> <span class="variable">r1</span> = &amp;<span class="keyword">mut</span> s;</span><br><span class="line">  |              ------ first mutable borrow occurs here</span><br><span class="line"><span class="number">5</span> |     s.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;, world!&quot;</span>);</span><br><span class="line">  |     ^ second mutable borrow occurs here</span><br><span class="line"><span class="number">6</span> |     </span><br><span class="line"><span class="number">7</span> |     <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, r1);</span><br><span class="line">  |                    -- first borrow later used here</span><br></pre></td></tr></table></figure></div>

<h2 id="NLL（非词法生命周期）"><a href="#NLL（非词法生命周期）" class="headerlink" title="NLL（非词法生命周期）"></a>NLL（非词法生命周期）</h2><table>
<thead>
<tr>
<th align="left">概念</th>
<th align="left">何时结束</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>借用的生命周期</strong></td>
<td align="left">最后一次使用后</td>
<td align="left">NLL 智能推断</td>
</tr>
<tr>
<td align="left"><strong>值的所有权</strong></td>
<td align="left">作用域 <code>&#125;</code> 结束</td>
<td align="left">drop 时机</td>
</tr>
</tbody></table>
<h1 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h1><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>Rust 中的字符串主要有两种核心类型：<code>String</code> 和 <code>&amp;str</code>。</p>
<h3 id="两种核心字符串类型"><a href="#两种核心字符串类型" class="headerlink" title="两种核心字符串类型"></a>两种核心字符串类型</h3><h4 id="str（字符串切片）"><a href="#str（字符串切片）" class="headerlink" title="&amp;str（字符串切片）"></a><code>&amp;str</code>（字符串切片）</h4><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串字面量，存储在程序的只读内存区</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s1</span>: &amp;<span class="type">str</span> = <span class="string">&quot;Hello, Rust!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以是 String 的切片引用</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s2</span>: &amp;<span class="type">str</span> = &amp;string[<span class="number">0</span>..<span class="number">3</span>];  <span class="comment">// &quot;Hel&quot;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>特点：</strong></p>
<ul>
<li>不可变引用（borrowed）</li>
<li>固定大小的视图</li>
<li>通常作为函数参数使用</li>
</ul>
<h4 id="String（可增长字符串）"><a href="#String（可增长字符串）" class="headerlink" title="String（可增长字符串）"></a><code>String</code>（可增长字符串）</h4><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建空字符串</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从字面量创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;Hello&quot;</span>.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带容量预分配</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">100</span>);</span><br></pre></td></tr></table></figure></div>

<p><strong>特点：</strong></p>
<ul>
<li>堆上分配，可增长</li>
<li>拥有所有权（owned）</li>
<li>可修改</li>
</ul>
<h3 id="内存布局对比"><a href="#内存布局对比" class="headerlink" title="内存布局对比"></a>内存布局对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         String 内存布局                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   栈上 (Stack)                      堆上 (Heap)                      │</span><br><span class="line">│   ┌────────────────┐               ┌───┬───┬───┬───┬───┐            │</span><br><span class="line">│   │ ptr ──────────────────────────►│ H │ e │ l │ l │ o │            │</span><br><span class="line">│   ├────────────────┤               └───┴───┴───┴───┴───┘            │</span><br><span class="line">│   │ len = 5        │                                                │</span><br><span class="line">│   ├────────────────┤                                                │</span><br><span class="line">│   │ capacity = 8   │                                                │</span><br><span class="line">│   └────────────────┘                                                │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          &amp;str 内存布局                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   栈上 (Stack)                      只读内存/堆                       │</span><br><span class="line">│   ┌────────────────┐               ┌───┬───┬───┬───┬───┐            │</span><br><span class="line">│   │ ptr ──────────────────────────►│ H │ e │ l │ l │ o │            │</span><br><span class="line">│   ├────────────────┤               └───┴───┴───┴───┴───┘            │</span><br><span class="line">│   │ len = 5        │               (胖指针: ptr + len)               │</span><br><span class="line">│   └────────────────┘                                                │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="String-常用操作"><a href="#String-常用操作" class="headerlink" title="String 常用操作"></a>String 常用操作</h3><p><strong>创建与修改</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 追加字符串</span></span><br><span class="line">    s.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;, World&quot;</span>);   <span class="comment">// &quot;Hello, World&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 追加单个字符</span></span><br><span class="line">    s.<span class="title function_ invoke__">push</span>(<span class="string">&#x27;!&#x27;</span>);             <span class="comment">// &quot;Hello, World!&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 插入</span></span><br><span class="line">    s.<span class="title function_ invoke__">insert</span>(<span class="number">0</span>, &#x27;🎉&#x27;);       <span class="comment">// &quot;🎉Hello, World!&quot;</span></span><br><span class="line">    s.<span class="title function_ invoke__">insert_str</span>(<span class="number">1</span>, <span class="string">&quot; &quot;</span>);    <span class="comment">// &quot;🎉 Hello, World!&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 替换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_s</span> = s.<span class="title function_ invoke__">replace</span>(<span class="string">&quot;World&quot;</span>, <span class="string">&quot;Rust&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    s.<span class="title function_ invoke__">pop</span>();                 <span class="comment">// 移除最后一个字符</span></span><br><span class="line">    s.<span class="title function_ invoke__">remove</span>(<span class="number">0</span>);             <span class="comment">// 移除指定索引的字符（按字节）</span></span><br><span class="line">    s.<span class="title function_ invoke__">truncate</span>(<span class="number">5</span>);           <span class="comment">// 截断到指定长度</span></span><br><span class="line">    s.<span class="title function_ invoke__">clear</span>();               <span class="comment">// 清空</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>字符串连接</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;World&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式1: + 运算符 (注意所有权转移)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s3</span> = s1 + <span class="string">&quot; &quot;</span> + &amp;s2;  <span class="comment">// s1 被移动，不能再使用</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式2: format! 宏 (推荐，不转移所有权)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s4</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; &#123;&#125; &#123;&#125;&quot;</span>, s1, s2, <span class="string">&quot;Rust&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式3: push_str</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s5</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    s5.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot; World&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式4: concat (适用于数组/切片)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s6</span> = [<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot;World&quot;</span>].<span class="title function_ invoke__">concat</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式5: join</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s7</span> = [<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>].<span class="title function_ invoke__">join</span>(<span class="string">&quot; &quot;</span>);  <span class="comment">// &quot;Hello World&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="UTF-8-编码特性"><a href="#UTF-8-编码特性" class="headerlink" title="UTF-8 编码特性"></a>UTF-8 编码特性</h3><p>Rust 字符串强制使用 <strong>UTF-8</strong> 编码，这带来一些特殊行为：</p>
<p><strong>字符与字节的区别</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;你好Rust&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;字节长度: &#123;&#125;&quot;</span>, s.<span class="title function_ invoke__">len</span>());           <span class="comment">// 10 (中文3字节×2 + 4字节)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;字符数量: &#123;&#125;&quot;</span>, s.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">count</span>()); <span class="comment">// 6</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 三种视图</span></span><br><span class="line">    <span class="comment">// 字节视图</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">b</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">bytes</span>() &#123;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; &quot;</span>, b);  <span class="comment">// 228 189 160 229 165 189 82 117 115 116</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 字符视图</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">c</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">chars</span>() &#123;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; &quot;</span>, c);  <span class="comment">// 你 好 R u s t</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 字形簇 (需要外部 crate)</span></span><br><span class="line">    <span class="comment">// use unicode_segmentation::UnicodeSegmentation;</span></span><br><span class="line">    <span class="comment">// for g in s.graphemes(true) &#123; ... &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>索引限制</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;你好&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 编译错误！不能直接索引</span></span><br><span class="line">    <span class="comment">// let c = s[0];</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 正确方式：使用切片（必须在有效字符边界）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;s[<span class="number">0</span>..<span class="number">3</span>];  <span class="comment">// &quot;你&quot; (3字节)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 运行时 panic！无效的字符边界</span></span><br><span class="line">    <span class="comment">// let bad = &amp;s[0..2];  // 截断了UTF-8字符</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 安全的获取字符</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first_char</span> = s.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">nth</span>(<span class="number">0</span>);  <span class="comment">// Some(&#x27;你&#x27;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// &amp;str -&gt; String</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: <span class="type">String</span> = <span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: <span class="type">String</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: <span class="type">String</span> = <span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">to_owned</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: <span class="type">String</span> = <span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// String -&gt; &amp;str</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="type">str</span> = &amp;string;           <span class="comment">// 解引用强制转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="type">str</span> = string.<span class="title function_ invoke__">as_str</span>();   <span class="comment">// 显式转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="type">str</span> = &amp;string[..];       <span class="comment">// 完整切片</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// String &lt;-&gt; Vec&lt;u8&gt;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span>: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt; = s.<span class="title function_ invoke__">into_bytes</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from_utf8</span>(bytes).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// &amp;str &lt;-&gt; &amp;[u8]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span>: &amp;[<span class="type">u8</span>] = s.<span class="title function_ invoke__">as_bytes</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = std::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(bytes).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 数字转字符串</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = n.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, n);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 字符串转数字</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span>: <span class="type">i32</span> = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = <span class="string">&quot;42&quot;</span>.parse::&lt;<span class="type">i32</span>&gt;().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Deref-强制转换"><a href="#Deref-强制转换" class="headerlink" title="Deref 强制转换"></a>Deref 强制转换</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// String 实现了 Deref&lt;Target=str&gt;</span></span><br><span class="line"><span class="comment">// 这意味着 String 可以自动转换为 &amp;str</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_str</span>(s: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">owned</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">borrowed</span> = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">print_str</span>(&amp;owned);    <span class="comment">// ✅ &amp;String 自动转为 &amp;str</span></span><br><span class="line">    <span class="title function_ invoke__">print_str</span>(borrowed);  <span class="comment">// ✅ &amp;str</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 因此函数参数推荐使用 &amp;str，更通用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="性能与实践"><a href="#性能与实践" class="headerlink" title="性能与实践"></a>性能与实践</h3><p><strong>容量预分配</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ❌ 频繁扩容</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">1000</span> &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">push_str</span>(&amp;i.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 预分配容量</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">4000</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">1000</span> &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">push_str</span>(&amp;i.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Capacity: &#123;&#125;&quot;</span>, s.<span class="title function_ invoke__">capacity</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>避免不必要的克隆</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 不必要的克隆</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process</span>(s: <span class="type">String</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">process</span>(s.<span class="title function_ invoke__">clone</span>());  <span class="comment">// 如果之后不用 s，这是浪费</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 如果只需要读取，用引用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_ref</span>(s: &amp;<span class="type">str</span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="title function_ invoke__">process_ref</span>(&amp;s);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 使用 Cow 实现按需克隆</span></span><br><span class="line"><span class="keyword">use</span> std::borrow::Cow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">maybe_modify</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> Cow&lt;<span class="type">str</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> s.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;old&quot;</span>) &#123;</span><br><span class="line">        Cow::<span class="title function_ invoke__">Owned</span>(s.<span class="title function_ invoke__">replace</span>(<span class="string">&quot;old&quot;</span>, <span class="string">&quot;new&quot;</span>))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Cow::<span class="title function_ invoke__">Borrowed</span>(s)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>函数参数建议</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 推荐：接受 &amp;str，兼容性最好</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">greet</span>(name: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;&quot;</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可接受 &amp;str 和 &amp;String</span></span><br><span class="line"><span class="title function_ invoke__">greet</span>(<span class="string">&quot;World&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">greet</span>(&amp;<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Rust&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要所有权时才用 String</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">take_ownership</span>(s: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>常见陷阱总结</strong></p>
<table>
<thead>
<tr>
<th>陷阱</th>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody><tr>
<td>直接索引</td>
<td><code>s[0]</code> 编译错误</td>
<td>使用 <code>s.chars().nth(0)</code></td>
</tr>
<tr>
<td>无效切片边界</td>
<td><code>&amp;s[0..2]</code> panic（中文）</td>
<td>确保在字符边界切分</td>
</tr>
<tr>
<td><code>+</code> 运算符</td>
<td>左侧所有权被移动</td>
<td>使用 <code>format!</code> 或 <code>clone()</code></td>
</tr>
<tr>
<td>比较长度</td>
<td><code>len()</code> 返回字节数</td>
<td>使用 <code>chars().count()</code></td>
</tr>
<tr>
<td>空字符串检查</td>
<td>多种方式</td>
<td>优先用 <code>is_empty()</code></td>
</tr>
</tbody></table>
<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>切片（Slice）是 Rust 中非常核心的概念，它是对<strong>连续内存序列</strong>的一个<strong>引用视图</strong>，不拥有数据所有权。</p>
<h3 id="切片基本概念"><a href="#切片基本概念" class="headerlink" title="切片基本概念"></a>切片基本概念</h3><p><strong>什么是切片</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 切片：对数组部分或全部元素的引用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr[<span class="number">1</span>..<span class="number">4</span>];  <span class="comment">// [2, 3, 4]</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, slice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>切片的本质</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        切片是&quot;胖指针&quot;                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   普通指针 (8 bytes)          切片/胖指针 (16 bytes)                  │</span><br><span class="line">│   ┌──────────────┐           ┌──────────────┐                       │</span><br><span class="line">│   │     ptr      │           │     ptr      │ ──► 指向数据起始位置   │</span><br><span class="line">│   └──────────────┘           ├──────────────┤                       │</span><br><span class="line">│                              │     len      │ ──► 元素数量           │</span><br><span class="line">│                              └──────────────┘                       │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="切片的内存布局"><a href="#切片的内存布局" class="headerlink" title="切片的内存布局"></a>切片的内存布局</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">5</span>] = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr[<span class="number">1</span>..<span class="number">4</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;数组地址: &#123;:p&#125;&quot;</span>, &amp;arr);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;切片指向: &#123;:p&#125;&quot;</span>, slice.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;切片长度: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;切片大小: &#123;&#125; bytes&quot;</span>, std::mem::<span class="title function_ invoke__">size_of_val</span>(&amp;slice));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">内存示意图:</span><br><span class="line"></span><br><span class="line">arr (栈上连续内存):</span><br><span class="line">┌──────┬──────┬──────┬──────┬──────┐</span><br><span class="line">│  10  │  20  │  30  │  40  │  50  │</span><br><span class="line">└──────┴──────┴──────┴──────┴──────┘</span><br><span class="line">  [0]    [1]    [2]    [3]    [4]</span><br><span class="line">          ▲             │</span><br><span class="line">          │             │</span><br><span class="line">          └─────────────┘</span><br><span class="line">          slice 覆盖范围 [1..4]</span><br><span class="line"></span><br><span class="line">slice (胖指针):</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ ptr ──────────────► 指向 arr[1] 的地址</span><br><span class="line">├─────────────────┤</span><br><span class="line">│ len = 3         │</span><br><span class="line">└─────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="切片语法详解"><a href="#切片语法详解" class="headerlink" title="切片语法详解"></a>切片语法详解</h3><p><strong>Range 语法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 各种切片范围</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = &amp;arr[<span class="number">2</span>..<span class="number">5</span>];    <span class="comment">// [2, 3, 4]        半开区间 [2, 5)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = &amp;arr[<span class="number">2</span>..=<span class="number">5</span>];   <span class="comment">// [2, 3, 4, 5]     闭区间   [2, 5]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = &amp;arr[..<span class="number">4</span>];     <span class="comment">// [0, 1, 2, 3]     从开头到索引4（不含）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">d</span> = &amp;arr[<span class="number">6</span>..];     <span class="comment">// [6, 7, 8, 9]     从索引6到结尾</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">e</span> = &amp;arr[..];      <span class="comment">// 全部元素          完整切片</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等价写法</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">full</span> = &amp;arr[<span class="number">0</span>..arr.<span class="title function_ invoke__">len</span>()];  <span class="comment">// 与 &amp;arr[..] 相同</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a: &#123;:?&#125;&quot;</span>, a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b: &#123;:?&#125;&quot;</span>, b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;c: &#123;:?&#125;&quot;</span>, c);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;d: &#123;:?&#125;&quot;</span>, d);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;e: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>范围类型对照表</strong></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>类型</th>
<th>含义</th>
<th>示例结果</th>
</tr>
</thead>
<tbody><tr>
<td><code>start..end</code></td>
<td><code>Range</code></td>
<td>[start, end)</td>
<td><code>[1..4]</code> → 索引1,2,3</td>
</tr>
<tr>
<td><code>start..=end</code></td>
<td><code>RangeInclusive</code></td>
<td>[start, end]</td>
<td><code>[1..=4]</code> → 索引1,2,3,4</td>
</tr>
<tr>
<td><code>start..</code></td>
<td><code>RangeFrom</code></td>
<td>[start, 末尾]</td>
<td><code>[2..]</code> → 从索引2到末尾</td>
</tr>
<tr>
<td><code>..end</code></td>
<td><code>RangeTo</code></td>
<td>[0, end)</td>
<td><code>[..3]</code> → 索引0,1,2</td>
</tr>
<tr>
<td><code>..=end</code></td>
<td><code>RangeToInclusive</code></td>
<td>[0, end]</td>
<td><code>[..=3]</code> → 索引0,1,2,3</td>
</tr>
<tr>
<td><code>..</code></td>
<td><code>RangeFull</code></td>
<td>全部</td>
<td><code>[..]</code> → 所有元素</td>
</tr>
</tbody></table>
<h3 id="常见切片类型"><a href="#常见切片类型" class="headerlink" title="常见切片类型"></a>常见切片类型</h3><p><strong>数组切片 <code>&amp;[T]</code></strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 从数组创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr[..];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从 Vec 创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;vec[<span class="number">1</span>..<span class="number">4</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从另一个切片创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sub_slice</span>: &amp;[<span class="type">i32</span>] = &amp;slice[<span class="number">0</span>..<span class="number">2</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, sub_slice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>字符串切片 <code>&amp;str</code></strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 字符串字面量本身就是 &amp;str</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span>: &amp;<span class="type">str</span> = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从 String 创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello, Rust!&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span>: &amp;<span class="type">str</span> = &amp;string[<span class="number">0</span>..<span class="number">5</span>];  <span class="comment">// &quot;Hello&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 注意：必须在有效 UTF-8 边界切分</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">chinese</span> = <span class="string">&quot;你好世界&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s3</span> = &amp;chinese[<span class="number">0</span>..<span class="number">3</span>];  <span class="comment">// &quot;你&quot; (一个中文字符占3字节)</span></span><br><span class="line">    <span class="comment">// let bad = &amp;chinese[0..2];  // panic! 无效边界</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>可变切片 <code>&amp;mut [T]</code></strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建可变切片</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="keyword">mut</span> [<span class="type">i32</span>] = &amp;<span class="keyword">mut</span> arr[<span class="number">1</span>..<span class="number">4</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 通过可变切片修改原数据</span></span><br><span class="line">    slice[<span class="number">0</span>] = <span class="number">20</span>;</span><br><span class="line">    slice[<span class="number">1</span>] = <span class="number">30</span>;</span><br><span class="line">    slice[<span class="number">2</span>] = <span class="number">40</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [1, 20, 30, 40, 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="切片与所有权类型的关系"><a href="#切片与所有权类型的关系" class="headerlink" title="切片与所有权类型的关系"></a>切片与所有权类型的关系</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      所有权类型 vs 借用类型                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────┐                    ┌─────────────┐                │</span><br><span class="line">│   │   Owned     │                    │  Borrowed   │                │</span><br><span class="line">│   │  (拥有数据)  │   ──Deref──►       │  (借用视图)  │                 │</span><br><span class="line">│   └─────────────┘                    └─────────────┘                │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────┐                    ┌─────────────┐                │</span><br><span class="line">│   │   String    │   ──────────────►  │   &amp;str      │                │</span><br><span class="line">│   └─────────────┘                    └─────────────┘                │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────┐                    ┌─────────────┐                │</span><br><span class="line">│   │  Vec&lt;T&gt;     │   ──────────────►  │   &amp;[T]      │                │</span><br><span class="line">│   └─────────────┘                    └─────────────┘                │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────┐                    ┌─────────────┐                │</span><br><span class="line">│   │  [T; N]     │   ──────────────►  │   &amp;[T]      │                │</span><br><span class="line">│   │  (数组)      │                    │             │                │</span><br><span class="line">│   └─────────────┘                    └─────────────┘                │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Vec&lt;T&gt; -&gt; &amp;[T]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;vec;           <span class="comment">// 自动 Deref</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = vec.<span class="title function_ invoke__">as_slice</span>(); <span class="comment">// 显式转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;vec[..];       <span class="comment">// 范围切片</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// [T; N] -&gt; &amp;[T]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: [<span class="type">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr;           <span class="comment">// 自动转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr[..];       <span class="comment">// 范围切片</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// String -&gt; &amp;str</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">string</span>: <span class="type">String</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="type">str</span> = &amp;string;          <span class="comment">// 自动 Deref</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;<span class="type">str</span> = string.<span class="title function_ invoke__">as_str</span>();  <span class="comment">// 显式转换</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="切片常用方法"><a href="#切片常用方法" class="headerlink" title="切片常用方法"></a>切片常用方法</h3><p><strong>基础方法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;[<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 长度与判空</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;长度: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">len</span>());           <span class="comment">// 5</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是否为空: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">is_empty</span>());  <span class="comment">// false</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取元素</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第一个: &#123;:?&#125;&quot;</span>, slice.<span class="title function_ invoke__">first</span>());     <span class="comment">// Some(&amp;10)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最后一个: &#123;:?&#125;&quot;</span>, slice.<span class="title function_ invoke__">last</span>());    <span class="comment">// Some(&amp;50)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;索引2: &#123;:?&#125;&quot;</span>, slice.<span class="title function_ invoke__">get</span>(<span class="number">2</span>));       <span class="comment">// Some(&amp;30)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;索引10: &#123;:?&#125;&quot;</span>, slice.<span class="title function_ invoke__">get</span>(<span class="number">10</span>));     <span class="comment">// None (安全访问)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 直接索引（可能 panic）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;slice[2] = &#123;&#125;&quot;</span>, slice[<span class="number">2</span>]);         <span class="comment">// 30</span></span><br><span class="line">    <span class="comment">// println!(&quot;&#123;&#125;&quot;, slice[10]);                // panic!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>迭代与遍历</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 不可变迭代</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> slice.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; &quot;</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带索引迭代</span></span><br><span class="line">    <span class="title function_ invoke__">for</span> (index, item) <span class="keyword">in</span> slice.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;[&#123;&#125;] = &#123;&#125;&quot;</span>, index, item);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 可变迭代</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;<span class="keyword">mut</span> arr[..];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> slice.<span class="title function_ invoke__">iter_mut</span>() &#123;</span><br><span class="line">        *item *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [2, 4, 6, 8, 10]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>查找与搜索</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;[<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 包含检查</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;包含 4: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">contains</span>(&amp;<span class="number">4</span>));          <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查找位置</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;4 的位置: &#123;:?&#125;&quot;</span>, slice.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">position</span>(|&amp;x| x == <span class="number">4</span>));  <span class="comment">// Some(2)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 开头/结尾检查</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;以 [3,1] 开头: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">starts_with</span>(&amp;[<span class="number">3</span>, <span class="number">1</span>]));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;以 [2,6] 结尾: &#123;&#125;&quot;</span>, slice.<span class="title function_ invoke__">ends_with</span>(&amp;[<span class="number">2</span>, <span class="number">6</span>]));    <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 二分查找（需要已排序）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sorted</span> = &amp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;二分查找 5: &#123;:?&#125;&quot;</span>, sorted.<span class="title function_ invoke__">binary_search</span>(&amp;<span class="number">5</span>));  <span class="comment">// Ok(4)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;二分查找 10: &#123;:?&#125;&quot;</span>, sorted.<span class="title function_ invoke__">binary_search</span>(&amp;<span class="number">10</span>)); <span class="comment">// Err(9)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>分割与连接</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 分成两半</span></span><br><span class="line">    <span class="keyword">let</span> (left, right) = slice.<span class="title function_ invoke__">split_at</span>(<span class="number">4</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;左: &#123;:?&#125;, 右: &#123;:?&#125;&quot;</span>, left, right);  <span class="comment">// [1,2,3,4], [5,6,7,8]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 按条件分割</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">parts</span>: <span class="type">Vec</span>&lt;&amp;[<span class="type">i32</span>]&gt; = slice.<span class="title function_ invoke__">split</span>(|&amp;x| x % <span class="number">3</span> == <span class="number">0</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, parts);  <span class="comment">// [[1, 2], [4, 5], [7, 8]]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 分块 (chunks)</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">chunk</span> <span class="keyword">in</span> slice.<span class="title function_ invoke__">chunks</span>(<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;块: &#123;:?&#125;&quot;</span>, chunk);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 块: [1, 2, 3]</span></span><br><span class="line">    <span class="comment">// 块: [4, 5, 6]</span></span><br><span class="line">    <span class="comment">// 块: [7, 8]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 固定大小窗口</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">window</span> <span class="keyword">in</span> slice.<span class="title function_ invoke__">windows</span>(<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;窗口: &#123;:?&#125;&quot;</span>, window);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 窗口: [1, 2, 3]</span></span><br><span class="line">    <span class="comment">// 窗口: [2, 3, 4]</span></span><br><span class="line">    <span class="comment">// 窗口: [3, 4, 5]</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>排序与反转（需要可变切片）</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;<span class="keyword">mut</span> arr[..];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    slice.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;排序后: &#123;:?&#125;&quot;</span>, slice);  <span class="comment">// [1, 1, 2, 3, 4, 5, 6, 9]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 反转</span></span><br><span class="line">    slice.<span class="title function_ invoke__">reverse</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;反转后: &#123;:?&#125;&quot;</span>, slice);  <span class="comment">// [9, 6, 5, 4, 3, 2, 1, 1]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>复制与填充</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">src</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">dst</span> = [<span class="number">0</span>; <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 复制切片</span></span><br><span class="line">    dst[..<span class="number">3</span>].<span class="title function_ invoke__">copy_from_slice</span>(&amp;src);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, dst);  <span class="comment">// [1, 2, 3, 0, 0]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 填充</span></span><br><span class="line">    dst.<span class="title function_ invoke__">fill</span>(<span class="number">7</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, dst);  <span class="comment">// [7, 7, 7, 7, 7]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 用迭代器填充</span></span><br><span class="line">    dst.<span class="title function_ invoke__">fill_with</span>(|| <span class="number">42</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, dst);  <span class="comment">// [42, 42, 42, 42, 42]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 交换元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    arr.<span class="title function_ invoke__">swap</span>(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [5, 2, 3, 4, 1]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="函数参数中的切片"><a href="#函数参数中的切片" class="headerlink" title="函数参数中的切片"></a>函数参数中的切片</h3><p><strong>切片作为参数</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 推荐：接受切片，更通用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">sum</span>(numbers: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    numbers.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">sum</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不推荐：只能接受特定类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">sum_vec</span>(numbers: &amp;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    numbers.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">sum</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vec</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 切片参数可以接受多种来源</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;数组求和: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum</span>(&amp;arr));        <span class="comment">// ✅</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Vec求和: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum</span>(&amp;vec));         <span class="comment">// ✅</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;部分求和: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum</span>(&amp;arr[<span class="number">1</span>..<span class="number">4</span>]));  <span class="comment">// ✅</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;部分求和: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum</span>(&amp;vec[..<span class="number">3</span>]));   <span class="comment">// ✅</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>可变切片参数</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">double_values</span>(slice: &amp;<span class="keyword">mut</span> [<span class="type">i32</span>]) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> slice.<span class="title function_ invoke__">iter_mut</span>() &#123;</span><br><span class="line">        *item *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改部分</span></span><br><span class="line">    <span class="title function_ invoke__">double_values</span>(&amp;<span class="keyword">mut</span> arr[<span class="number">1</span>..<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [1, 4, 6, 8, 5]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改全部</span></span><br><span class="line">    <span class="title function_ invoke__">double_values</span>(&amp;<span class="keyword">mut</span> arr);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [2, 8, 12, 16, 10]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>返回切片</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回切片必须关联生命周期</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">first_half</span>(slice: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> &amp;[<span class="type">i32</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mid</span> = slice.<span class="title function_ invoke__">len</span>() / <span class="number">2</span>;</span><br><span class="line">    &amp;slice[..mid]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回可变切片</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">first_half_mut</span>(slice: &amp;<span class="keyword">mut</span> [<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> [<span class="type">i32</span>] &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mid</span> = slice.<span class="title function_ invoke__">len</span>() / <span class="number">2</span>;</span><br><span class="line">    &amp;<span class="keyword">mut</span> slice[..mid]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">half</span> = <span class="title function_ invoke__">first_half</span>(&amp;arr);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, half);  <span class="comment">// [1, 2, 3]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h2><p>元组是 Rust 中一种重要的复合类型，可以将<strong>多个不同类型</strong>的值组合成一个单一的复合值。</p>
<h3 id="元组基本概念"><a href="#元组基本概念" class="headerlink" title="元组基本概念"></a>元组基本概念</h3><p><strong>什么是元组</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 元组：固定长度、可包含不同类型的值的集合</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple</span>: (<span class="type">i32</span>, <span class="type">f64</span>, <span class="type">char</span>, &amp;<span class="type">str</span>) = (<span class="number">42</span>, <span class="number">3.14</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&quot;Rust&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, tuple);  <span class="comment">// (42, 3.14, &#x27;R&#x27;, &quot;Rust&quot;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>元组的特点</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          元组特性                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ✓ 固定长度     - 一旦声明，长度不可改变                             │</span><br><span class="line">│   ✓ 异构类型     - 每个元素可以是不同类型                             │</span><br><span class="line">│   ✓ 有序集合     - 元素按位置索引访问                                 │</span><br><span class="line">│   ✓ 值类型       - 存储在栈上（如果所有元素都是栈类型）                │</span><br><span class="line">│   ✓ 可解构       - 支持模式匹配解构                                   │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="元组的创建与类型"><a href="#元组的创建与类型" class="headerlink" title="元组的创建与类型"></a>元组的创建与类型</h3><p><strong>基本创建方式</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 显式类型标注</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t1</span>: (<span class="type">i32</span>, <span class="type">f64</span>, <span class="type">bool</span>) = (<span class="number">100</span>, <span class="number">2.5</span>, <span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 类型推断</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t2</span> = (<span class="number">100</span>, <span class="number">2.5</span>, <span class="literal">true</span>);  <span class="comment">// (i32, f64, bool)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 单元素元组（注意逗号）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">t3</span>: (<span class="type">i32</span>,) = (<span class="number">42</span>,);     <span class="comment">// 这是元组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">not_tuple</span> = (<span class="number">42</span>);       <span class="comment">// 这只是 i32，不是元组！</span></span><br><span class="line"><span class="comment">// = note: `#[warn(unused_parens)]` (part of `#[warn(unused)]`) on by default</span></span><br><span class="line"><span class="comment">// help: remove these parentheses</span></span><br><span class="line"><span class="comment">// |</span></span><br><span class="line"><span class="comment">// 3 -     let _not_tuple = (42);       // 这只是 i32，不是元组！</span></span><br><span class="line"><span class="comment">// 3 +     let _not_tuple = 42 ;       // 这只是 i32，不是元组！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空元组（单元类型）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">unit</span>: () = ();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 嵌套元组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">nested</span>: ((<span class="type">i32</span>, <span class="type">i32</span>), (<span class="type">f64</span>, <span class="type">f64</span>)) = ((<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3.0</span>, <span class="number">4.0</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;t1: &#123;:?&#125;&quot;</span>, t1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;t3: &#123;:?&#125;&quot;</span>, t3);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;nested: &#123;:?&#125;&quot;</span>, nested);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>元组类型签名</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 每种元素组合都是独特的类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: (<span class="type">i32</span>, <span class="type">i32</span>) = (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: (<span class="type">i32</span>, <span class="type">i64</span>) = (<span class="number">1</span>, <span class="number">2</span>);     <span class="comment">// 不同类型！</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span>: (<span class="type">i64</span>, <span class="type">i32</span>) = (<span class="number">1</span>, <span class="number">2</span>);     <span class="comment">// 顺序不同也是不同类型！</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 以下会编译错误：类型不匹配</span></span><br><span class="line">    <span class="comment">// let d: (i32, i32) = (1, 2, 3);  // 长度不同</span></span><br><span class="line">    <span class="comment">// let e: (i32, i32) = b;          // 元素类型不同</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内存布局"><a href="#内存布局" class="headerlink" title="内存布局"></a>内存布局</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple</span>: (<span class="type">u8</span>, <span class="type">u32</span>, <span class="type">u8</span>) = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;元组大小: &#123;&#125; bytes&quot;</span>, std::mem::<span class="title function_ invoke__">size_of_val</span>(&amp;tuple));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;元组对齐: &#123;&#125; bytes&quot;</span>, std::mem::<span class="title function_ invoke__">align_of_val</span>(&amp;tuple));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│              (u8, u32, u8) 实际内存布局                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   声明顺序: (u8, u32, u8)                                           │</span><br><span class="line">│   理论大小: 1 + 3(padding) + 4 + 1 + 3(padding) = 12 bytes          │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ═══════════════════════════════════════════════════════════       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   实际布局（Rust 编译器重排优化后）:                                  │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌────────────────────────────┬──────┬──────┬──────────────┐       │</span><br><span class="line">│   │           u32              │  u8  │  u8  │   padding    │       │</span><br><span class="line">│   │         4 bytes            │  1B  │  1B  │    2 bytes   │       │</span><br><span class="line">│   └────────────────────────────┴──────┴──────┴──────────────┘       │</span><br><span class="line">│   offset: 0                    4      5      6              8       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   实际大小: 4 + 1 + 1 + 2(padding) = 8 bytes                        │</span><br><span class="line">│   对齐要求: 4 bytes (最大成员 u32 的对齐)                            │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 #[repr(C)] 按 C 语言布局</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TupleC</span>(<span class="type">u8</span>, <span class="type">u32</span>, <span class="type">u8</span>);</span><br><span class="line"><span class="comment">// 默认布局（Rust 重排）</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TupleRust</span>(<span class="type">u8</span>, <span class="type">u32</span>, <span class="type">u8</span>);</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;repr(C) 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;TupleC&gt;());    <span class="comment">// 12</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;repr(Rust) 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;TupleRust&gt;()); <span class="comment">// 8</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// repr(C) 严格按声明顺序，不优化</span></span><br><span class="line">    <span class="comment">// ┌────┬─────────┬────────────────┬────┬─────────┐</span></span><br><span class="line">    <span class="comment">// │ u8 │ padding │      u32       │ u8 │ padding │</span></span><br><span class="line">    <span class="comment">// │ 1B │   3B    │      4B        │ 1B │   3B    │</span></span><br><span class="line">    <span class="comment">// └────┴─────────┴────────────────┴────┴─────────┘</span></span><br><span class="line">    <span class="comment">// 总共: 1 + 3 + 4 + 1 + 3 = 12 bytes</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="访问元组元素"><a href="#访问元组元素" class="headerlink" title="访问元组元素"></a>访问元组元素</h3><p><strong>索引访问（点号语法）</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple</span> = (<span class="number">500</span>, <span class="number">6.4</span>, <span class="string">&quot;hello&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用 .索引 访问（索引从 0 开始）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first</span> = tuple.<span class="number">0</span>;    <span class="comment">// 500</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">second</span> = tuple.<span class="number">1</span>;   <span class="comment">// 6.4</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">third</span> = tuple.<span class="number">2</span>;    <span class="comment">// &quot;hello&quot;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fourth</span> = tuple.<span class="number">3</span>;   <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第一个元素: &#123;&#125;&quot;</span>, first);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第二个元素: &#123;&#125;&quot;</span>, second);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第三个元素: &#123;&#125;&quot;</span>, third);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第四个元素: &#123;&#125;&quot;</span>, fourth);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 注意：索引必须是编译期常量</span></span><br><span class="line">    <span class="comment">// let index = 0;</span></span><br><span class="line">    <span class="comment">// let value = tuple.index;  // ❌ 编译错误！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>解构（Destructuring）</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple</span> = (<span class="number">1</span>, <span class="number">2.0</span>, <span class="string">&quot;three&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 完全解构</span></span><br><span class="line">    <span class="keyword">let</span> (x, y, z) = tuple;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x=&#123;&#125;, y=&#123;&#125;, z=&#123;&#125;&quot;</span>, x, y, z);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 部分解构（使用 _ 忽略不需要的值）</span></span><br><span class="line">    <span class="keyword">let</span> (a, _, c) = tuple;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a=&#123;&#125;, c=&#123;&#125;&quot;</span>, a, c);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 忽略多个值</span></span><br><span class="line">    <span class="keyword">let</span> (first, ..) = tuple;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;first=&#123;&#125;&quot;</span>, first);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取首尾</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple5</span> = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> (head, .., tail) = tuple5;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;head=&#123;&#125;, tail=&#123;&#125;&quot;</span>, head, tail);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 嵌套解构</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">nested</span> = ((<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">4</span>));</span><br><span class="line">    <span class="keyword">let</span> ((a, b), (c, d)) = nested;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a=&#123;&#125;, b=&#123;&#125;, c=&#123;&#125;, d=&#123;&#125;&quot;</span>, a, b, c, d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>可变元组</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 声明可变元组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tuple</span> = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改单个元素</span></span><br><span class="line">    tuple.<span class="number">0</span> = <span class="number">100</span>;</span><br><span class="line">    tuple.<span class="number">1</span> = <span class="number">200</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, tuple);  <span class="comment">// (100, 200, 3)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 通过解构修改</span></span><br><span class="line">    <span class="keyword">let</span> (<span class="keyword">ref</span> <span class="keyword">mut</span> a, <span class="keyword">ref</span> <span class="keyword">mut</span> b, _) = tuple;</span><br><span class="line">    *a = <span class="number">1000</span>;</span><br><span class="line">    *b = <span class="number">2000</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, tuple);  <span class="comment">// (1000, 2000, 3)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="单元类型-1"><a href="#单元类型-1" class="headerlink" title="单元类型 ()"></a>单元类型 <code>()</code></h3><p>我们之间讲到的单元类型也是一种特殊的元组。</p>
<p><strong>单元类型的概念</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// () 是一种特殊的元组，称为单元类型（unit type）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">unit</span>: () = ();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 单元类型的大小为 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;() 的大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;()&gt;());  <span class="comment">// 0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 单元类型只有一个值，也是 ()</span></span><br><span class="line">    <span class="built_in">assert_eq!</span>(unit, ());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>单元类型的用途</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 函数无返回值时，实际返回 ()</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">no_return</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;这个函数没有显式返回值&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">explicit_unit</span>() <span class="punctuation">-&gt;</span> () &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;显式声明返回 ()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 表达式语句的值</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">no_return</span>();  <span class="comment">// result 的类型是 ()</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;result: &#123;:?&#125;&quot;</span>, result);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 语句的值是 ()</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">5</span>;</span><br><span class="line">        <span class="comment">// 没有返回表达式，块的值是 ()</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x: &#123;:?&#125;&quot;</span>, x);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 赋值表达式的值是 ()</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">a</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = (a = <span class="number">5</span>);  <span class="comment">// b 是 ()</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b: &#123;:?&#125;&quot;</span>, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 泛型中作为占位符</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Container</span>&lt;T&gt; &#123;</span><br><span class="line">    value: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 当不需要存储值时，使用 ()</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">empty</span>: Container&lt;()&gt; = Container &#123; value: () &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Result 中表示无有意义的返回值</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">might_fail</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 成功时返回 Ok(())</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="元组与函数"><a href="#元组与函数" class="headerlink" title="元组与函数"></a>元组与函数</h3><p><strong>作为函数参数</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接受元组参数</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_point</span>(point: (<span class="type">i32</span>, <span class="type">i32</span>)) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Point: (&#123;&#125;, &#123;&#125;)&quot;</span>, point.<span class="number">0</span>, point.<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解构参数</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_point_destructured</span>((x, y): (<span class="type">i32</span>, <span class="type">i32</span>)) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Point: (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = (<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="title function_ invoke__">print_point</span>(p);</span><br><span class="line">    <span class="title function_ invoke__">print_point_destructured</span>(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>作为返回值（多返回值）</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回多个值</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">min_max</span>(numbers: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;(<span class="type">i32</span>, <span class="type">i32</span>)&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> numbers.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">min</span> = numbers[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">max</span> = numbers[<span class="number">0</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> &amp;num <span class="keyword">in</span> numbers.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">skip</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> num &lt; min &#123; min = num; &#125;</span><br><span class="line">        <span class="keyword">if</span> num &gt; max &#123; max = num; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Some</span>((min, max))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回带状态的结果</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">divide_with_remainder</span>(dividend: <span class="type">i32</span>, divisor: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> (<span class="type">i32</span>, <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">quotient</span> = dividend / divisor;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">remainder</span> = dividend % divisor;</span><br><span class="line">    (quotient, remainder)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 使用多返回值</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>((min, max)) = <span class="title function_ invoke__">min_max</span>(&amp;[<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>]) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;最小值: &#123;&#125;, 最大值: &#123;&#125;&quot;</span>, min, max);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> (quotient, remainder) = <span class="title function_ invoke__">divide_with_remainder</span>(<span class="number">17</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;17 / 5 = &#123;&#125; 余 &#123;&#125;&quot;</span>, quotient, remainder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>交换值的惯用法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">a</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span> = <span class="number">2</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;交换前: a=&#123;&#125;, b=&#123;&#125;&quot;</span>, a, b);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用元组交换值（Rust 惯用法）</span></span><br><span class="line">    (a, b) = (b, a);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;交换后: a=&#123;&#125;, b=&#123;&#125;&quot;</span>, a, b);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 也可以用 std::mem::swap</span></span><br><span class="line">    std::mem::<span class="title function_ invoke__">swap</span>(&amp;<span class="keyword">mut</span> a, &amp;<span class="keyword">mut</span> b);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;再次交换: a=&#123;&#125;, b=&#123;&#125;&quot;</span>, a, b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><p>结构体是 Rust 中创建自定义数据类型的基本方式，将多个相关值组合成一个整体。</p>
<h3 id="结构体形式"><a href="#结构体形式" class="headerlink" title="结构体形式"></a>结构体形式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 常规结构体 - 有命名字段（最常用）</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">u32</span>,</span><br><span class="line">    active: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 元组结构体 - 字段无名称，通过索引访问</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Color</span>(<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>(<span class="type">f64</span>, <span class="type">f64</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UserId</span>(<span class="type">u64</span>);         <span class="comment">// New Type 模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 单元结构体 - 无字段，大小为 0</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Marker</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建常规结构体</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = User &#123;</span><br><span class="line">        username: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;alice&quot;</span>),</span><br><span class="line">        email: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;alice@example.com&quot;</span>),</span><br><span class="line">        age: <span class="number">25</span>,</span><br><span class="line">        active: <span class="literal">true</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建元组结构体</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">red</span> = <span class="title function_ invoke__">Color</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">origin</span> = <span class="title function_ invoke__">Point</span>(<span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">id</span> = <span class="title function_ invoke__">UserId</span>(<span class="number">12345</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建单元结构体</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">marker</span> = Marker;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 访问字段</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;用户名: &#123;&#125;&quot;</span>, user.username);   <span class="comment">// 常规结构体用字段名</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;红色值: &#123;&#125;&quot;</span>, red.<span class="number">0</span>);           <span class="comment">// 元组结构体用索引</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;用户ID: &#123;&#125;&quot;</span>, id.<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Marker大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;Marker&gt;());  <span class="comment">// 0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────┬─────────────────┬─────────────────┬──────────────────┐</span><br><span class="line">│      特性      │   常规结构体    │   元组结构体    │    单元结构体    │</span><br><span class="line">├────────────────┼─────────────────┼─────────────────┼──────────────────┤</span><br><span class="line">│   字段名称     │      有         │      无         │       无         │</span><br><span class="line">│   访问方式     │    .name        │    .0 .1 .2     │      N/A         │</span><br><span class="line">│   内存大小     │  字段和+对齐    │   字段和+对齐   │       0          │</span><br><span class="line">│   主要用途     │   数据建模      │  NewType/简单   │    标记/trait    │</span><br><span class="line">└────────────────┴─────────────────┴─────────────────┴──────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="创建与初始化"><a href="#创建与初始化" class="headerlink" title="创建与初始化"></a>创建与初始化</h3><p><strong>基本创建与字段简写</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 基本创建（字段顺序可以不同）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Point &#123; x: <span class="number">10</span>, y: <span class="number">20</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = Point &#123; y: <span class="number">50</span>, x: <span class="number">30</span> &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 字段简写：变量名与字段名相同时</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3</span> = Point &#123; x, y &#125;;  <span class="comment">// 等同于 Point &#123; x: x, y: y &#125;</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;p1: (&#123;&#125;, &#123;&#125;)&quot;</span>, p1.x, p1.y);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;p3: (&#123;&#125;, &#123;&#125;)&quot;</span>, p3.x, p3.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>结构体更新语法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    host: <span class="type">String</span>,</span><br><span class="line">    port: <span class="type">u16</span>,</span><br><span class="line">    timeout: <span class="type">u32</span>,</span><br><span class="line">    debug: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">config1</span> = Config &#123;</span><br><span class="line">        host: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;localhost&quot;</span>),</span><br><span class="line">        port: <span class="number">8080</span>,</span><br><span class="line">        timeout: <span class="number">30</span>,</span><br><span class="line">        debug: <span class="literal">true</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 用 ..config1 复制剩余字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">config2</span> = Config &#123;</span><br><span class="line">        port: <span class="number">3000</span>,        <span class="comment">// 只修改 port</span></span><br><span class="line">        ..config1          <span class="comment">// 其余从 config1 复制</span></span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ⚠️ 注意所有权！String 被移动了</span></span><br><span class="line">    <span class="comment">// println!(&quot;&#123;&#125;&quot;, config1.host);  // ❌ host 已移动</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, config1.port);     <span class="comment">// ✅ u16 是 Copy 类型</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, config1.debug);    <span class="comment">// ✅ bool 是 Copy 类型</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;config2 port: &#123;&#125;&quot;</span>, config2.port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="字段访问与修改"><a href="#字段访问与修改" class="headerlink" title="字段访问与修改"></a>字段访问与修改</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    width: <span class="type">u32</span>,</span><br><span class="line">    height: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 读取字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rect</span> = Rectangle &#123; width: <span class="number">30</span>, height: <span class="number">50</span> &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;宽: &#123;&#125;, 高: &#123;&#125;&quot;</span>, rect.width, rect.height);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">area</span> = rect.width * rect.height;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;面积: &#123;&#125;&quot;</span>, area);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改字段 - 整个结构体必须是 mut</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">rect2</span> = Rectangle &#123; width: <span class="number">10</span>, height: <span class="number">20</span> &#125;;</span><br><span class="line">    rect2.width = <span class="number">100</span>;</span><br><span class="line">    rect2.height = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;修改后: &#123;&#125;x&#123;&#125;&quot;</span>, rect2.width, rect2.height);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 通过引用访问（自动解引用）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rect_ref</span> = &amp;rect;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;通过引用: &#123;&#125;&quot;</span>, rect_ref.width);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 通过可变引用修改</span></span><br><span class="line">    <span class="title function_ invoke__">modify_rect</span>(&amp;<span class="keyword">mut</span> rect2);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;函数修改后: &#123;&#125;x&#123;&#125;&quot;</span>, rect2.width, rect2.height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">modify_rect</span>(r: &amp;<span class="keyword">mut</span> Rectangle) &#123;</span><br><span class="line">    r.width *= <span class="number">2</span>;</span><br><span class="line">    r.height *= <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="所有权与借用"><a href="#所有权与借用" class="headerlink" title="所有权与借用"></a>所有权与借用</h3><p><strong>字段的移动</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Container</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    count: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = Container &#123;</span><br><span class="line">        data: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>),</span><br><span class="line">        count: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 移动单个字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = c.data;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// println!(&quot;&#123;&#125;&quot;, c.data);  // ❌ data 已移动</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, c.count);    <span class="comment">// ✅ u32 是 Copy，仍可用</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>部分借用</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">    field1: <span class="type">String</span>,</span><br><span class="line">    field2: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = Data &#123;</span><br><span class="line">        field1: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;one&quot;</span>),</span><br><span class="line">        field2: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;two&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 可以同时借用不同字段（Rust 能追踪）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r1</span> = &amp;data.field1;      <span class="comment">// 不可变借用 field1</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r2</span> = &amp;<span class="keyword">mut</span> data.field2;  <span class="comment">// 可变借用 field2</span></span><br><span class="line">  </span><br><span class="line">    r2.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot; modified&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, &#123;&#125;&quot;</span>, r1, r2);  <span class="comment">// ✅ 借用不同字段，允许</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内存布局-1"><a href="#内存布局-1" class="headerlink" title="内存布局"></a>内存布局</h3><p><strong>默认布局</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,    <span class="comment">// 1 byte</span></span><br><span class="line">    b: <span class="type">u32</span>,   <span class="comment">// 4 bytes</span></span><br><span class="line">    c: <span class="type">u8</span>,    <span class="comment">// 1 byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;Example&gt;());  <span class="comment">// 8</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;对齐: &#123;&#125; bytes&quot;</span>, std::mem::align_of::&lt;Example&gt;()); <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Rust 编译器可能重排字段以优化内存：</span><br><span class="line"></span><br><span class="line">┌────────────────────────────┬──────┬──────┬──────────────┐</span><br><span class="line">│         b (u32)            │  a   │  c   │   padding    │</span><br><span class="line">│         4 bytes            │  1B  │  1B  │    2 bytes   │</span><br><span class="line">└────────────────────────────┴──────┴──────┴──────────────┘</span><br><span class="line">总大小: 8 bytes（优化后）</span><br></pre></td></tr></table></figure></div>

<p><strong>repr</strong> 属性控制布局</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,    <span class="comment">// 1 byte</span></span><br><span class="line">    b: <span class="type">u32</span>,   <span class="comment">// 4 bytes</span></span><br><span class="line">    c: <span class="type">u8</span>,    <span class="comment">// 1 byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C 语言布局（不重排，FFI 兼容）</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CLayout</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,</span><br><span class="line">    b: <span class="type">u32</span>,</span><br><span class="line">    c: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 紧凑布局（无填充）</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Packed</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,</span><br><span class="line">    b: <span class="type">u32</span>,</span><br><span class="line">    c: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;默认: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;Example&gt;());  <span class="comment">// 8</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;repr(C): &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;CLayout&gt;()); <span class="comment">// 12</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;packed: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;Packed&gt;());   <span class="comment">// 6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="打印结构体"><a href="#打印结构体" class="headerlink" title="打印结构体"></a>打印结构体</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 派生 Debug trait 才能打印</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = Point &#123; x: <span class="number">10</span>, y: <span class="number">20</span> &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p);   <span class="comment">// Point &#123; x: 10, y: 20 &#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:#?&#125;&quot;</span>, p);  <span class="comment">// 美化输出（多行）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>枚举是 Rust 中定义”多选一”类型的方式，一个值在某一时刻只能是其中一个变体。</p>
<h3 id="基本枚举定义"><a href="#基本枚举定义" class="headerlink" title="基本枚举定义"></a>基本枚举定义</h3><p><strong>简单枚举</strong>（无关联数据）</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Direction</span> &#123;</span><br><span class="line">    Up,</span><br><span class="line">    Down,</span><br><span class="line">    Left,</span><br><span class="line">    Right,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Status</span> &#123;</span><br><span class="line">    Pending,</span><br><span class="line">    Running,</span><br><span class="line">    Completed,</span><br><span class="line">    Failed,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建枚举值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dir</span> = Direction::Up;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Status::Running;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用 match 匹配（枚举必须穷尽所有变体）</span></span><br><span class="line">    <span class="keyword">match</span> dir &#123;</span><br><span class="line">        Direction::Up =&gt; <span class="built_in">println!</span>(<span class="string">&quot;向上&quot;</span>),</span><br><span class="line">        Direction::Down =&gt; <span class="built_in">println!</span>(<span class="string">&quot;向下&quot;</span>),</span><br><span class="line">        Direction::Left =&gt; <span class="built_in">println!</span>(<span class="string">&quot;向左&quot;</span>),</span><br><span class="line">        Direction::Right =&gt; <span class="built_in">println!</span>(<span class="string">&quot;向右&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// if let 匹配单个变体</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Status</span>::Running = status &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;正在运行中...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>带关联数据的枚举</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个变体可以携带不同类型、不同数量的数据</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Quit,                         <span class="comment">// 无数据（类似单元结构体）</span></span><br><span class="line">    Move &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;,      <span class="comment">// 命名字段（类似结构体）</span></span><br><span class="line">    <span class="title function_ invoke__">Write</span>(<span class="type">String</span>),                <span class="comment">// 单个值（类似元组结构体）</span></span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>),      <span class="comment">// 多个值（类似元组结构体）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建不同变体</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m1</span> = Message::Quit;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m2</span> = Message::Move &#123; x: <span class="number">10</span>, y: <span class="number">20</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m3</span> = Message::<span class="title function_ invoke__">Write</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m4</span> = Message::<span class="title function_ invoke__">ChangeColor</span>(<span class="number">255</span>, <span class="number">128</span>, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 匹配并提取数据</span></span><br><span class="line">    <span class="keyword">match</span> m2 &#123;</span><br><span class="line">        Message::Quit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;退出&quot;</span>),</span><br><span class="line">        Message::Move &#123; x, y &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;移动到 (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y),</span><br><span class="line">        Message::<span class="title function_ invoke__">Write</span>(text) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;消息: &#123;&#125;&quot;</span>, text),</span><br><span class="line">        Message::<span class="title function_ invoke__">ChangeColor</span>(r, g, b) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;颜色: RGB(&#123;&#125;,&#123;&#125;,&#123;&#125;)&quot;</span>, r, g, b),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>三种变体形式</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 单元变体（无数据）</span></span><br><span class="line">    Unit,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 元组变体（匿名字段）</span></span><br><span class="line">    <span class="title function_ invoke__">Tuple</span>(<span class="type">i32</span>, <span class="type">String</span>),</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 结构体变体（命名字段）</span></span><br><span class="line">    Struct &#123; id: <span class="type">u32</span>, name: <span class="type">String</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Example::Unit;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = Example::<span class="title function_ invoke__">Tuple</span>(<span class="number">42</span>, <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = Example::Struct &#123; id: <span class="number">1</span>, name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;test&quot;</span>) &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 匹配提取</span></span><br><span class="line">    <span class="keyword">match</span> b &#123;</span><br><span class="line">        Example::Unit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;单元变体&quot;</span>),</span><br><span class="line">        Example::<span class="title function_ invoke__">Tuple</span>(num, text) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;元组: &#123;&#125;, &#123;&#125;&quot;</span>, num, text),</span><br><span class="line">        Example::Struct &#123; id, name &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;结构体: &#123;&#125; - &#123;&#125;&quot;</span>, id, name),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┬────────────────────┬─────────────────────────────┐</span><br><span class="line">│    变体类型     │       语法         │           示例              │</span><br><span class="line">├─────────────────┼────────────────────┼─────────────────────────────┤</span><br><span class="line">│   单元变体      │   Name             │   Quit, None, Empty         │</span><br><span class="line">│   元组变体      │   Name(T1, T2)     │   Some(42), Move(10, 20)    │</span><br><span class="line">│   结构体变体    │   Name &#123; f: T &#125;    │   Point &#123; x: 1, y: 2 &#125;      │</span><br><span class="line">└─────────────────┴────────────────────┴─────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="枚举的判别值"><a href="#枚举的判别值" class="headerlink" title="枚举的判别值"></a>枚举的判别值</h3><p><strong>默认判别值</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Number</span> &#123;</span><br><span class="line">    Zero,   <span class="comment">// 0</span></span><br><span class="line">    One,    <span class="comment">// 1</span></span><br><span class="line">    Two,    <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 转换为整数</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Zero = &#123;&#125;&quot;</span>, Number::Zero <span class="keyword">as</span> <span class="type">i32</span>);  <span class="comment">// 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;One = &#123;&#125;&quot;</span>, Number::One <span class="keyword">as</span> <span class="type">i32</span>);    <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Two = &#123;&#125;&quot;</span>, Number::Two <span class="keyword">as</span> <span class="type">i32</span>);    <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>自定义判别值</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">HttpStatus</span> &#123;</span><br><span class="line">    <span class="literal">Ok</span> = <span class="number">200</span>,</span><br><span class="line">    NotFound = <span class="number">404</span>,</span><br><span class="line">    InternalError = <span class="number">500</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    Red = <span class="number">0xFF0000</span>,</span><br><span class="line">    Green = <span class="number">0x00FF00</span>,</span><br><span class="line">    Blue = <span class="number">0x0000FF</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定底层类型</span></span><br><span class="line"><span class="meta">#[repr(u8)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Flag</span> &#123;</span><br><span class="line">    A = <span class="number">1</span>,</span><br><span class="line">    B = <span class="number">2</span>,</span><br><span class="line">    C = <span class="number">4</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;OK = &#123;&#125;&quot;</span>, HttpStatus::<span class="literal">Ok</span> <span class="keyword">as</span> <span class="type">i32</span>);           <span class="comment">// 200</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;NotFound = &#123;&#125;&quot;</span>, HttpStatus::NotFound <span class="keyword">as</span> <span class="type">i32</span>); <span class="comment">// 404</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Red = 0x&#123;:06X&#125;&quot;</span>, Color::Red <span class="keyword">as</span> <span class="type">i32</span>);  <span class="comment">// 0xFF0000</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Flag 大小: &#123;&#125; byte&quot;</span>, std::mem::size_of::&lt;Flag&gt;());  <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>部分指定</strong>（自动递增）</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Mixed</span> &#123;</span><br><span class="line">    A,        <span class="comment">// 0</span></span><br><span class="line">    B = <span class="number">10</span>,   <span class="comment">// 10</span></span><br><span class="line">    C,        <span class="comment">// 11（从上一个递增）</span></span><br><span class="line">    D,        <span class="comment">// 12</span></span><br><span class="line">    E = <span class="number">100</span>,  <span class="comment">// 100</span></span><br><span class="line">    F,        <span class="comment">// 101</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;A=&#123;&#125;, B=&#123;&#125;, C=&#123;&#125;, D=&#123;&#125;, E=&#123;&#125;, F=&#123;&#125;&quot;</span>, </span><br><span class="line">        Mixed::A <span class="keyword">as</span> <span class="type">i32</span>, Mixed::B <span class="keyword">as</span> <span class="type">i32</span>, Mixed::C <span class="keyword">as</span> <span class="type">i32</span>,</span><br><span class="line">        Mixed::D <span class="keyword">as</span> <span class="type">i32</span>, Mixed::E <span class="keyword">as</span> <span class="type">i32</span>, Mixed::F <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">    <span class="comment">// 输出: A=0, B=10, C=11, D=12, E=100, F=101</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="核心枚举"><a href="#核心枚举" class="headerlink" title="核心枚举"></a>核心枚举</h3><p>Option 和 Result 是 Rust 中最重要的两个枚举，用于处理<strong>空值</strong>和<strong>错误</strong>，替代了其他语言中的 null 和异常机制。</p>
<h4 id="Option-可选值"><a href="#Option-可选值" class="headerlink" title="Option&lt;T&gt; - 可选值"></a>Option&lt;T&gt; - 可选值</h4><p><strong>定义</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准库中的定义</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Option</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(T),   <span class="comment">// 有值，包含一个 T 类型的值</span></span><br><span class="line">    <span class="literal">None</span>,      <span class="comment">// 无值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>为什么需要 Option？</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其他语言中的问题：null/nil 导致的崩溃</span></span><br><span class="line"><span class="comment">// Java:  String s = null; s.length();  → NullPointerException</span></span><br><span class="line"><span class="comment">// C:     int* p = NULL; *p = 10;       → 段错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rust 没有 null！用 Option 明确表示&quot;可能没有值&quot;</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 明确告诉编译器：这个变量可能没有值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">maybe_number</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">no_number</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 编译器强制你处理 None 的情况，避免空指针错误</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>创建 Option</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 有值：Some(值)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">Some</span>(<span class="string">&quot;hello&quot;</span>);           <span class="comment">// 自动推断 Option&lt;&amp;str&gt;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">Some</span>(<span class="number">3.14</span>);              <span class="comment">// 自动推断 Option&lt;f64&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 无值：None（通常需要类型标注）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">d</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">e</span>: <span class="type">Option</span>&lt;<span class="type">String</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打印</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a = &#123;:?&#125;&quot;</span>, a);   <span class="comment">// Some(5)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;d = &#123;:?&#125;&quot;</span>, d);   <span class="comment">// None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>Option 不能直接使用内部值</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">i32</span> = <span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 错误：Option&lt;i32&gt; 不是 i32，不能直接运算</span></span><br><span class="line">    <span class="comment">// let sum = x + y;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 必须先&quot;解包&quot;取出里面的值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span> = x.<span class="title function_ invoke__">unwrap</span>() + y;  <span class="comment">// unwrap 取出 Some 里的值</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sum = &#123;&#125;&quot;</span>, sum); <span class="comment">// 15</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>基本方法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">some_val</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">none_val</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 检查状态 =====</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;some_val.is_some() = &#123;&#125;&quot;</span>, some_val.<span class="title function_ invoke__">is_some</span>());  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;some_val.is_none() = &#123;&#125;&quot;</span>, some_val.<span class="title function_ invoke__">is_none</span>());  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;none_val.is_some() = &#123;&#125;&quot;</span>, none_val.<span class="title function_ invoke__">is_some</span>());  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;none_val.is_none() = &#123;&#125;&quot;</span>, none_val.<span class="title function_ invoke__">is_none</span>());  <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 获取值（危险方法，None 会 panic）=====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v1</span> = some_val.<span class="title function_ invoke__">unwrap</span>();          <span class="comment">// 返回 10</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;unwrap = &#123;&#125;&quot;</span>, v1);</span><br><span class="line">    <span class="comment">// none_val.unwrap();                // ❌ panic!</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v2</span> = some_val.<span class="title function_ invoke__">expect</span>(<span class="string">&quot;错误信息&quot;</span>); <span class="comment">// 同 unwrap，但可自定义错误信息</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;expect = &#123;&#125;&quot;</span>, v2);</span><br><span class="line">    <span class="comment">// none_val.expect(&quot;值不存在&quot;);       // ❌ panic: &quot;值不存在&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 安全获取值 =====</span></span><br><span class="line">    <span class="comment">// unwrap_or: None 时返回指定默认值</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;some.unwrap_or(0) = &#123;&#125;&quot;</span>, some_val.<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>));  <span class="comment">// 10</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;none.unwrap_or(0) = &#123;&#125;&quot;</span>, none_val.<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>));  <span class="comment">// 0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// unwrap_or_default: None 时返回类型的默认值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: <span class="type">Option</span>&lt;<span class="type">String</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;default = &#x27;&#123;&#125;&#x27;&quot;</span>, s.<span class="title function_ invoke__">unwrap_or_default</span>());  <span class="comment">// &quot;&quot;（空字符串）</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;default = &#123;&#125;&quot;</span>, n.<span class="title function_ invoke__">unwrap_or_default</span>());    <span class="comment">// 0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>常见使用场景</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 场景1：查找可能不存在的元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first</span>: <span class="type">Option</span>&lt;&amp;<span class="type">i32</span>&gt; = numbers.<span class="title function_ invoke__">first</span>();   <span class="comment">// Some(&amp;1)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tenth</span>: <span class="type">Option</span>&lt;&amp;<span class="type">i32</span>&gt; = numbers.<span class="title function_ invoke__">get</span>(<span class="number">10</span>);   <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;first = &#123;:?&#125;&quot;</span>, first);   <span class="comment">// Some(1)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;tenth = &#123;:?&#125;&quot;</span>, tenth);   <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 场景2：字符串解析可能失败</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">good</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, _&gt; = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bad</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, _&gt; = <span class="string">&quot;abc&quot;</span>.<span class="title function_ invoke__">parse</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// parse 返回 Result，可以用 .ok() 转为 Option</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">good_opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">ok</span>();   <span class="comment">// Some(42)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bad_opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="string">&quot;abc&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">ok</span>();   <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;good_opt = &#123;:?&#125;&quot;</span>, good_opt);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;bad_opt = &#123;:?&#125;&quot;</span>, bad_opt);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 场景3：HashMap 查找</span></span><br><span class="line">    <span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">val</span>: <span class="type">Option</span>&lt;&amp;<span class="type">i32</span>&gt; = map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;a&quot;</span>);  <span class="comment">// Some(&amp;1)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">none</span>: <span class="type">Option</span>&lt;&amp;<span class="type">i32</span>&gt; = map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;b&quot;</span>); <span class="comment">// None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Result-错误处理"><a href="#Result-错误处理" class="headerlink" title="Result&lt;T, E&gt; - 错误处理"></a>Result&lt;T, E&gt; - 错误处理</h4><p><strong>定义</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准库中的定义</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(T),    <span class="comment">// 成功，包含成功值 T</span></span><br><span class="line">    <span class="title function_ invoke__">Err</span>(E),   <span class="comment">// 失败，包含错误值 E</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>为什么需要 Result？</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其他语言的问题：异常可能被忽略或遗漏</span></span><br><span class="line"><span class="comment">// Java:  可能忘记 catch</span></span><br><span class="line"><span class="comment">// C:     可能忘记检查返回值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Rust 的 Result 强制你处理错误</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;除数不能为零&quot;</span>))  <span class="comment">// 返回错误</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(a / b)  <span class="comment">// 返回成功结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">divide</span>(<span class="number">10</span>, <span class="number">2</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 编译器强制你处理两种情况</span></span><br><span class="line">    <span class="comment">// 不能直接使用 result，必须检查是 Ok 还是 Err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>创建 Result</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 成功：Ok(值)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">success</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ok_str</span>: <span class="type">Result</span>&lt;&amp;<span class="type">str</span>, <span class="type">i32</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 失败：Err(错误)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">failure</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;失败了&quot;</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">err_num</span>: <span class="type">Result</span>&lt;&amp;<span class="type">str</span>, <span class="type">i32</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="number">404</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打印</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;success = &#123;:?&#125;&quot;</span>, success);  <span class="comment">// Ok(42)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;failure = &#123;:?&#125;&quot;</span>, failure);  <span class="comment">// Err(&quot;失败了&quot;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>基本方法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ok_val</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">err_val</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;错误&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 检查状态 =====</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok_val.is_ok() = &#123;&#125;&quot;</span>, ok_val.<span class="title function_ invoke__">is_ok</span>());    <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok_val.is_err() = &#123;&#125;&quot;</span>, ok_val.<span class="title function_ invoke__">is_err</span>());  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err_val.is_ok() = &#123;&#125;&quot;</span>, err_val.<span class="title function_ invoke__">is_ok</span>());  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err_val.is_err() = &#123;&#125;&quot;</span>, err_val.<span class="title function_ invoke__">is_err</span>()); <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 获取值（危险方法）=====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v1</span> = ok_val.<span class="title function_ invoke__">unwrap</span>();            <span class="comment">// 返回 10</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;unwrap = &#123;&#125;&quot;</span>, v1);</span><br><span class="line">    <span class="comment">// err_val.unwrap();                 // ❌ panic!</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v2</span> = ok_val.<span class="title function_ invoke__">expect</span>(<span class="string">&quot;失败了&quot;</span>);     <span class="comment">// 同 unwrap</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;expect = &#123;&#125;&quot;</span>, v2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取错误值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">e</span> = err_val.<span class="title function_ invoke__">unwrap_err</span>();        <span class="comment">// 返回 &quot;错误&quot;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;unwrap_err = &#123;&#125;&quot;</span>, e);</span><br><span class="line">    <span class="comment">// ok_val.unwrap_err();              // ❌ panic!</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 安全获取值 =====</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok.unwrap_or(0) = &#123;&#125;&quot;</span>, ok_val.<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>));   <span class="comment">// 10</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err.unwrap_or(0) = &#123;&#125;&quot;</span>, err_val.<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>)); <span class="comment">// 0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 转换为 Option =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt1</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = ok_val.<span class="title function_ invoke__">ok</span>();   <span class="comment">// Some(10)，丢弃错误</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt2</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = err_val.<span class="title function_ invoke__">ok</span>();  <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt3</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = err_val.<span class="title function_ invoke__">err</span>(); <span class="comment">// Some(&quot;错误&quot;)，丢弃成功值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt4</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = ok_val.<span class="title function_ invoke__">err</span>();  <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok_val.ok() = &#123;:?&#125;&quot;</span>, opt1);   <span class="comment">// Some(10)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err_val.ok() = &#123;:?&#125;&quot;</span>, opt2);  <span class="comment">// None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>常见使用场景</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::Read;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 场景1：文件操作</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file_result</span>: <span class="type">Result</span>&lt;File, std::io::Error&gt; = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 必须处理可能的错误</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = file_result.<span class="title function_ invoke__">unwrap_or_else</span>(|error| &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;打开文件失败: &#123;:?&#125;&quot;</span>, error);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 场景2：字符串解析</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, _&gt; = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bad</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, _&gt; = <span class="string">&quot;abc&quot;</span>.<span class="title function_ invoke__">parse</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;num = &#123;:?&#125;&quot;</span>, num);  <span class="comment">// Ok(42)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;bad = &#123;:?&#125;&quot;</span>, bad);  <span class="comment">// Err(ParseIntError)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 场景3：自定义函数返回 Result</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">validate_age</span>(age: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> age &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;年龄不能为负&quot;</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> age &gt; <span class="number">150</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;年龄不合理&quot;</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(age)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">validate_age</span>(<span class="number">25</span>));   <span class="comment">// Ok(25)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">validate_age</span>(-<span class="number">5</span>));   <span class="comment">// Err(&quot;年龄不能为负&quot;)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="title function_ invoke__">validate_age</span>(<span class="number">200</span>));  <span class="comment">// Err(&quot;年龄不合理&quot;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="相互转换"><a href="#相互转换" class="headerlink" title="相互转换"></a>相互转换</h4><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ===== Option → Result =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">none</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ok_or: 把 None 转换为指定的 Err</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">res1</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = opt.<span class="title function_ invoke__">ok_or</span>(<span class="string">&quot;无值&quot;</span>);   <span class="comment">// Ok(5)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">res2</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = none.<span class="title function_ invoke__">ok_or</span>(<span class="string">&quot;无值&quot;</span>);  <span class="comment">// Err(&quot;无值&quot;)</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;opt.ok_or() = &#123;:?&#125;&quot;</span>, res1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;none.ok_or() = &#123;:?&#125;&quot;</span>, res2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== Result → Option =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ok</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">err</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;错误&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ok(): 丢弃错误，Err → None</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt1</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = ok.<span class="title function_ invoke__">ok</span>();    <span class="comment">// Some(10)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt2</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = err.<span class="title function_ invoke__">ok</span>();   <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok.ok() = &#123;:?&#125;&quot;</span>, opt1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err.ok() = &#123;:?&#125;&quot;</span>, opt2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// err(): 丢弃成功值，Ok → None</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt3</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = ok.<span class="title function_ invoke__">err</span>();   <span class="comment">// None</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt4</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = err.<span class="title function_ invoke__">err</span>();  <span class="comment">// Some(&quot;错误&quot;)</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ok.err() = &#123;:?&#125;&quot;</span>, opt3);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;err.err() = &#123;:?&#125;&quot;</span>, opt4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内存布局-2"><a href="#内存布局-2" class="headerlink" title="内存布局"></a>内存布局</h3><p><strong>基本原理</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Simple</span> &#123;</span><br><span class="line">    A,</span><br><span class="line">    B,</span><br><span class="line">    C,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">WithData</span> &#123;</span><br><span class="line">    Empty,</span><br><span class="line">    <span class="title function_ invoke__">Number</span>(<span class="type">i32</span>),</span><br><span class="line">    <span class="title function_ invoke__">Text</span>(<span class="type">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 简单枚举：只需存储判别值</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Simple 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;Simple&gt;());  <span class="comment">// 1</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带数据枚举：判别值 + 最大变体的大小</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;WithData 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;WithData&gt;());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;String 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;<span class="type">String</span>&gt;());  <span class="comment">// 24</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">枚举内存布局 = 判别值（tag）+ 数据（payload）</span><br><span class="line"></span><br><span class="line">WithData 布局示意：</span><br><span class="line">┌──────────┬─────────────────────────────────────────┐</span><br><span class="line">│   tag    │              payload                    │</span><br><span class="line">│  (8B)    │        (最大变体的大小)                 │</span><br><span class="line">├──────────┼─────────────────────────────────────────┤</span><br><span class="line">│    0     │  (Empty: 无数据，但空间仍保留)          │</span><br><span class="line">│    1     │  Number: i32 (4B) + padding             │</span><br><span class="line">│    2     │  Text: String (24B)                     │</span><br><span class="line">└──────────┴─────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><p>数组是固定长度、存储在栈上的同类型元素集合，长度是类型的一部分。</p>
<h3 id="基本定义与创建"><a href="#基本定义与创建" class="headerlink" title="基本定义与创建"></a>基本定义与创建</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 显式类型标注：[类型; 长度]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr1</span>: [<span class="type">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 类型推断</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr2</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];          <span class="comment">// 推断为 [i32; 5]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr3</span> = [<span class="number">1.0</span>, <span class="number">2.0</span>, <span class="number">3.0</span>];          <span class="comment">// 推断为 [f64; 3]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr4</span> = [<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>];       <span class="comment">// 推断为 [&amp;str; 2]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 重复值初始化：[初始值; 长度]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">zeros</span> = [<span class="number">0</span>; <span class="number">10</span>];                  <span class="comment">// 10 个 0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ones</span> = [<span class="number">1u8</span>; <span class="number">100</span>];               <span class="comment">// 100 个 1u8</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">spaces</span> = [<span class="string">&#x27; &#x27;</span>; <span class="number">20</span>];              <span class="comment">// 20 个空格</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. 空数组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">empty</span>: [<span class="type">i32</span>; <span class="number">0</span>] = [];</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;arr1: &#123;:?&#125;&quot;</span>, arr1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;zeros: &#123;:?&#125;&quot;</span>, zeros);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;empty 长度: &#123;&#125;&quot;</span>, empty.<span class="title function_ invoke__">len</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>长度是类型的一部分</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: [<span class="type">i32</span>; <span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: [<span class="type">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// a 和 b 是不同类型！</span></span><br><span class="line">    <span class="comment">// [i32; 3] ≠ [i32; 5]</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;[i32; 3] 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;[<span class="type">i32</span>; <span class="number">3</span>]&gt;());  <span class="comment">// 12</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;[i32; 5] 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;[<span class="type">i32</span>; <span class="number">5</span>]&gt;());  <span class="comment">// 20</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 函数参数必须指定具体长度</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">print_three</span>(arr: [<span class="type">i32</span>; <span class="number">3</span>]) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">print_three</span>(a);  <span class="comment">// ✅</span></span><br><span class="line">    <span class="comment">// print_three(b);  // ❌ 类型不匹配</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│  数组类型 = 元素类型 + 长度                              │</span><br><span class="line">│                                                         │</span><br><span class="line">│  [i32; 3]  →  3 个 i32，共 12 bytes                     │</span><br><span class="line">│  [i32; 5]  →  5 个 i32，共 20 bytes                     │</span><br><span class="line">│  [u8; 100] →  100 个 u8，共 100 bytes                   │</span><br><span class="line">│                                                         │</span><br><span class="line">│  这三个是完全不同的类型！                                │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="元素访问"><a href="#元素访问" class="headerlink" title="元素访问"></a>元素访问</h3><p><strong>索引访问</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取元素（索引从 0 开始）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first</span> = arr[<span class="number">0</span>];   <span class="comment">// 10</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">third</span> = arr[<span class="number">2</span>];   <span class="comment">// 30</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">last</span> = arr[<span class="number">4</span>];    <span class="comment">// 50</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第一个: &#123;&#125;, 第三个: &#123;&#125;, 最后一个: &#123;&#125;&quot;</span>, first, third, last);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改元素（需要 mut）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr2</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    arr2[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line">    arr2[<span class="number">2</span>] = <span class="number">300</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;修改后: &#123;:?&#125;&quot;</span>, arr2);  <span class="comment">// [100, 2, 300]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>越界检查</strong>（运行时 panic）</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 编译时已知越界 → 编译警告/错误</span></span><br><span class="line">    <span class="comment">// let x = arr[10];  // 编译器直接报错</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 运行时越界 → panic</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">index</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = arr[index];  <span class="comment">// panic: index out of bounds</span></span><br><span class="line"><span class="comment">//     error: this operation will panic at runtime</span></span><br><span class="line"><span class="comment">//     --&gt; ./main.rs:9:13</span></span><br><span class="line"><span class="comment">//      |</span></span><br><span class="line"><span class="comment">//    9 |     let x = arr[index];  // panic: index out of bounds</span></span><br><span class="line"><span class="comment">//      |             ^^^^^^^^^^ index out of bounds: the length is 5 but the index is 10</span></span><br><span class="line"><span class="comment">//      |</span></span><br><span class="line"><span class="comment">//      = note: `#[deny(unconditional_panic)]` on by default</span></span><br><span class="line">    <span class="comment">// 安全访问：使用 get() 返回 Option</span></span><br><span class="line">    <span class="keyword">match</span> arr.<span class="title function_ invoke__">get</span>(<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(value) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;索引 2 的值: &#123;&#125;&quot;</span>, value),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;索引越界&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">match</span> arr.<span class="title function_ invoke__">get</span>(<span class="number">10</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(value) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;值: &#123;&#125;&quot;</span>, value),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;索引 10 越界&quot;</span>),  <span class="comment">// 这个会执行</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 简洁写法</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(v) = arr.<span class="title function_ invoke__">get</span>(<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;值: &#123;&#125;&quot;</span>, v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式 1：for 循环（借用元素）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;遍历引用:&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;arr &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;  &#123;&#125;&quot;</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式 2：for 循环（获取所有权，Copy 类型会复制）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;遍历值:&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> arr &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;  &#123;&#125;&quot;</span>, item);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式 3：带索引遍历</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;带索引:&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">for</span> (index, value) <span class="keyword">in</span> arr.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;  arr[&#123;&#125;] = &#123;&#125;&quot;</span>, index, value);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式 4：索引遍历</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;索引遍历:&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..arr.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;  arr[&#123;&#125;] = &#123;&#125;&quot;</span>, i, arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式 5：可变遍历</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr2</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;<span class="keyword">mut</span> arr2 &#123;</span><br><span class="line">        *item *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;翻倍后: &#123;:?&#125;&quot;</span>, arr2);  <span class="comment">// [2, 4, 6]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 基本信息</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;长度: &#123;&#125;&quot;</span>, arr.<span class="title function_ invoke__">len</span>());           <span class="comment">// 8</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是否为空: &#123;&#125;&quot;</span>, arr.<span class="title function_ invoke__">is_empty</span>());  <span class="comment">// false</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取元素</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;第一个: &#123;:?&#125;&quot;</span>, arr.<span class="title function_ invoke__">first</span>());     <span class="comment">// Some(3)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最后一个: &#123;:?&#125;&quot;</span>, arr.<span class="title function_ invoke__">last</span>());    <span class="comment">// Some(6)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;get(2): &#123;:?&#125;&quot;</span>, arr.<span class="title function_ invoke__">get</span>(<span class="number">2</span>));      <span class="comment">// Some(4)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;get(100): &#123;:?&#125;&quot;</span>, arr.<span class="title function_ invoke__">get</span>(<span class="number">100</span>));  <span class="comment">// None</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 切片操作</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span> = &amp;arr[<span class="number">2</span>..<span class="number">5</span>];                    <span class="comment">// [4, 1, 5]</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;切片 [2..5]: &#123;:?&#125;&quot;</span>, slice);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 包含检查</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;包含 5: &#123;&#125;&quot;</span>, arr.<span class="title function_ invoke__">contains</span>(&amp;<span class="number">5</span>));  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;包含 7: &#123;&#125;&quot;</span>, arr.<span class="title function_ invoke__">contains</span>(&amp;<span class="number">7</span>));  <span class="comment">// false</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 迭代器</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span>: <span class="type">i32</span> = arr.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">sum</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;总和: &#123;&#125;&quot;</span>, sum);                 <span class="comment">// 31</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">max</span> = arr.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">max</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最大值: &#123;:?&#125;&quot;</span>, max);             <span class="comment">// Some(9)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查找</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pos</span> = arr.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">position</span>(|&amp;x| x == <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;5 的位置: &#123;:?&#125;&quot;</span>, pos);           <span class="comment">// Some(4)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>排序与修改</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">6</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    arr.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;升序: &#123;:?&#125;&quot;</span>, arr);       <span class="comment">// [1, 1, 2, 3, 4, 5, 6, 9]</span></span><br><span class="line">  </span><br><span class="line">    arr.<span class="title function_ invoke__">sort_by</span>(|a, b| b.<span class="title function_ invoke__">cmp</span>(a));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;降序: &#123;:?&#125;&quot;</span>, arr);       <span class="comment">// [9, 6, 5, 4, 3, 2, 1, 1]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 反转</span></span><br><span class="line">    arr.<span class="title function_ invoke__">reverse</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;反转: &#123;:?&#125;&quot;</span>, arr);       <span class="comment">// [1, 1, 2, 3, 4, 5, 6, 9]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 填充</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr2</span> = [<span class="number">0</span>; <span class="number">5</span>];</span><br><span class="line">    arr2.<span class="title function_ invoke__">fill</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;填充: &#123;:?&#125;&quot;</span>, arr2);      <span class="comment">// [42, 42, 42, 42, 42]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 交换元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr3</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    arr3.<span class="title function_ invoke__">swap</span>(<span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;交换后: &#123;:?&#125;&quot;</span>, arr3);    <span class="comment">// [5, 2, 3, 4, 1]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 旋转</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr4</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    arr4.<span class="title function_ invoke__">rotate_left</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;左旋 2: &#123;:?&#125;&quot;</span>, arr4);    <span class="comment">// [3, 4, 5, 1, 2]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>数组与切片</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 数组可以隐式转换为切片引用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">slice</span>: &amp;[<span class="type">i32</span>] = &amp;arr;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 部分切片</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">part</span>: &amp;[<span class="type">i32</span>] = &amp;arr[<span class="number">1</span>..<span class="number">4</span>];    <span class="comment">// [2, 3, 4]</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;部分切片: &#123;:?&#125;&quot;</span>, part);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 切片的优势：函数可以接受任意长度</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">sum_slice</span>(data: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">        data.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">sum</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr3</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr5</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 不同长度的数组都能传入</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sum arr3: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum_slice</span>(&amp;arr3));  <span class="comment">// 6</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sum arr5: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum_slice</span>(&amp;arr5));  <span class="comment">// 15</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sum part: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum_slice</span>(&amp;arr5[<span class="number">2</span>..])); <span class="comment">// 12</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│   数组 [T; N]              vs        切片 &amp;[T]          │</span><br><span class="line">├─────────────────────────────────────────────────────────┤</span><br><span class="line">│   长度编译时固定                     长度运行时确定      │</span><br><span class="line">│   存储在栈上                         是引用（胖指针）    │</span><br><span class="line">│   大小 = N * sizeof(T)               大小 = 2 * 指针    │</span><br><span class="line">│   类型包含长度                       类型不包含长度      │</span><br><span class="line">│   [i32; 3] ≠ [i32; 5]               &amp;[i32] 通用        │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 二维数组：3 行 4 列</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">matrix</span>: [[<span class="type">i32</span>; <span class="number">4</span>]; <span class="number">3</span>] = [</span><br><span class="line">        [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">        [<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>],</span><br><span class="line">        [<span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>],</span><br><span class="line">    ];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 访问元素</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;matrix[1][2] = &#123;&#125;&quot;</span>, matrix[<span class="number">1</span>][<span class="number">2</span>]);  <span class="comment">// 7</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 遍历二维数组</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> &amp;matrix &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> row &#123;</span><br><span class="line">            <span class="built_in">print!</span>(<span class="string">&quot;&#123;:3&#125; &quot;</span>, col);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">println!</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 初始化为零</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">zeros</span>: [[<span class="type">i32</span>; <span class="number">4</span>]; <span class="number">3</span>] = [[<span class="number">0</span>; <span class="number">4</span>]; <span class="number">3</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;零矩阵: &#123;:?&#125;&quot;</span>, zeros);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 三维数组</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cube</span>: [[[<span class="type">i32</span>; <span class="number">2</span>]; <span class="number">3</span>]; <span class="number">4</span>] = [[[<span class="number">0</span>; <span class="number">2</span>]; <span class="number">3</span>]; <span class="number">4</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;三维数组大小: &#123;&#125; bytes&quot;</span>, std::mem::<span class="title function_ invoke__">size_of_val</span>(&amp;cube));  <span class="comment">// 96</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内存布局-3"><a href="#内存布局-3" class="headerlink" title="内存布局"></a>内存布局</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1i32</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 连续内存存储</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;数组地址: &#123;:p&#125;&quot;</span>, &amp;arr);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;arr[0] 地址: &#123;:p&#125;&quot;</span>, &amp;arr[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;arr[1] 地址: &#123;:p&#125;&quot;</span>, &amp;arr[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;arr[2] 地址: &#123;:p&#125;&quot;</span>, &amp;arr[<span class="number">2</span>]);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 每个元素间隔 4 bytes (i32 大小)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 数组大小 = 元素大小 × 长度</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;i32 大小: &#123;&#125; bytes&quot;</span>, std::mem::size_of::&lt;<span class="type">i32</span>&gt;());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;数组大小: &#123;&#125; bytes&quot;</span>, std::mem::<span class="title function_ invoke__">size_of_val</span>(&amp;arr));  <span class="comment">// 20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">内存布局（栈上连续存储）：</span><br><span class="line"></span><br><span class="line">arr: [1i32, 2, 3, 4, 5]</span><br><span class="line"></span><br><span class="line">地址:  0x1000   0x1004   0x1008   0x100C   0x1010</span><br><span class="line">       ┌────────┬────────┬────────┬────────┬────────┐</span><br><span class="line">       │   1    │   2    │   3    │   4    │   5    │</span><br><span class="line">       │ (i32)  │ (i32)  │ (i32)  │ (i32)  │ (i32)  │</span><br><span class="line">       └────────┴────────┴────────┴────────┴────────┘</span><br><span class="line">       │◄──────────────── 20 bytes ───────────────►│</span><br></pre></td></tr></table></figure></div>

<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         Rust 流程控制                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   条件判断              循环                 模式匹配                    │</span><br><span class="line">│   ├── if/else          ├── loop            ├── match                   │</span><br><span class="line">│   ├── if let           ├── while           ├── if let / while let      │</span><br><span class="line">│   ├── let else         ├── while let       ├── @ 绑定                  │</span><br><span class="line">│   └── matches!         └── for             └── 模式语法                 │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   跳转控制              错误处理            表达式                       │</span><br><span class="line">│   ├── break            ├── ? 运算符        └── 块表达式                 │</span><br><span class="line">│   ├── continue         ├── panic!                                       │</span><br><span class="line">│   ├── return           └── unwrap/expect                                │</span><br><span class="line">│   └── &#x27;label 标签                                                       │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h2><h3 id="if-else-表达式"><a href="#if-else-表达式" class="headerlink" title="if&#x2F;else 表达式"></a>if&#x2F;else 表达式</h3><p>Rust 中 <code>if</code> 是表达式而非语句，可以返回值。条件必须是 <code>bool</code> 类型，不会自动转换。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">number</span> = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 基本用法</span></span><br><span class="line">    <span class="keyword">if</span> number &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;正数&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> number &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;负数&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;零&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 作为表达式返回值（各分支类型必须一致）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">description</span> = <span class="keyword">if</span> number % <span class="number">2</span> == <span class="number">0</span> &#123; <span class="string">&quot;偶数&quot;</span> &#125; <span class="keyword">else</span> &#123; <span class="string">&quot;奇数&quot;</span> &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;description: &#123;&#125;&quot;</span>, description);</span><br><span class="line">    <span class="comment">// 在 let 语句中使用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">abs_value</span> = <span class="keyword">if</span> number &gt;= <span class="number">0</span> &#123; number &#125; <span class="keyword">else</span> &#123; -number &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;abs_value: &#123;&#125;&quot;</span>, abs_value);</span><br><span class="line">    <span class="comment">// 嵌套条件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">category</span> = <span class="keyword">if</span> number &gt; <span class="number">100</span> &#123;</span><br><span class="line">        <span class="string">&quot;大&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> number &gt; <span class="number">10</span> &#123; <span class="string">&quot;中&quot;</span> &#125; <span class="keyword">else</span> &#123; <span class="string">&quot;小&quot;</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;category: &#123;&#125;&quot;</span>, category);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="if-let-表达式"><a href="#if-let-表达式" class="headerlink" title="if let 表达式"></a>if let 表达式</h3><p>当只关心一种匹配情况时，<code>if let</code> 比 <code>match</code> 更简洁。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">some_value</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 替代冗长的 match</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(x) = some_value &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;值为: &#123;&#125;&quot;</span>, x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;无值&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等价的 match 写法</span></span><br><span class="line">    <span class="keyword">match</span> some_value &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(x) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;值为: &#123;&#125;&quot;</span>, x),</span><br><span class="line">        _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;无值&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 可以结合 else if / else if let</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">config</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, &amp;<span class="type">str</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(value) = config &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;配置值: &#123;&#125;&quot;</span>, value);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = config &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;配置错误: &#123;&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 解构复杂类型</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Point</span> &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">point</span> = <span class="title function_ invoke__">Some</span>(Point &#123; x: <span class="number">10</span>, y: <span class="number">20</span> &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(Point &#123; x, y &#125;) = point &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;坐标: (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="let-else-表达式"><a href="#let-else-表达式" class="headerlink" title="let else 表达式"></a>let else 表达式</h3><p>Rust 1.65 引入，用于匹配失败时必须发散（提前退出）的场景。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 必须以 return/break/continue/panic 等发散表达式结尾</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_username</span>(id: <span class="type">Option</span>&lt;<span class="type">u32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(user_id) = id <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;anonymous&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">&quot;user_&#123;&#125;&quot;</span>, user_id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在循环中使用 break</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">find_first_even</span>(numbers: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> &amp;n <span class="keyword">in</span> numbers &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="number">0</span> = n % <span class="number">2</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span>;  <span class="comment">// 不是偶数，跳过</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>(n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">None</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多层解构</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_data</span>(data: <span class="type">Option</span>&lt;<span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;&gt;) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(result) = data <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Ok</span>(content) = result <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">username</span> = <span class="title function_ invoke__">get_username</span>(<span class="title function_ invoke__">Some</span>(<span class="number">123</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;username: &#123;&#125;&quot;</span>, username);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">even</span> = <span class="title function_ invoke__">find_first_even</span>(&amp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;even: &#123;:?&#125;&quot;</span>, even);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="title function_ invoke__">process_data</span>(<span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Ok</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello, world!&quot;</span>))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;data: &#123;&#125;&quot;</span>, data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="title function_ invoke__">process_data</span>(<span class="title function_ invoke__">Some</span>(<span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Error&quot;</span>))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;data: &#123;&#125;&quot;</span>, data);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="title function_ invoke__">process_data</span>(<span class="literal">None</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;data: &#123;&#125;&quot;</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="matches-宏"><a href="#matches-宏" class="headerlink" title="matches! 宏"></a>matches! 宏</h3><p>返回 <code>bool</code> 的模式匹配，适合在条件判断中使用。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="string">&#x27;f&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否匹配模式</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_lowercase</span> = matches!(c, <span class="string">&#x27;a&#x27;</span>..=<span class="string">&#x27;z&#x27;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_lowercase: &#123;&#125;&quot;</span>, is_lowercase);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_letter</span> = matches!(c, <span class="string">&#x27;a&#x27;</span>..=<span class="string">&#x27;z&#x27;</span> | <span class="string">&#x27;A&#x27;</span>..=<span class="string">&#x27;Z&#x27;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_letter: &#123;&#125;&quot;</span>, is_letter);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_hex</span> = matches!(c, <span class="string">&#x27;0&#x27;</span>..=<span class="string">&#x27;9&#x27;</span> | <span class="string">&#x27;a&#x27;</span>..=<span class="string">&#x27;f&#x27;</span> | <span class="string">&#x27;A&#x27;</span>..=<span class="string">&#x27;F&#x27;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_hex: &#123;&#125;&quot;</span>, is_hex);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带守卫条件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt</span> = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_positive</span> = matches!(opt, <span class="title function_ invoke__">Some</span>(x) <span class="keyword">if</span> x &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_large</span> = matches!(opt, <span class="title function_ invoke__">Some</span>(x) <span class="keyword">if</span> x &gt; <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_positive: &#123;&#125;&quot;</span>, is_positive);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_large: &#123;&#125;&quot;</span>, is_large);</span><br><span class="line">    <span class="comment">// 匹配枚举变体</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Status</span> &#123; Active, Inactive, <span class="title function_ invoke__">Pending</span>(<span class="type">u32</span>) &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Status::<span class="title function_ invoke__">Pending</span>(<span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_pending</span> = matches!(status, Status::<span class="title function_ invoke__">Pending</span>(_));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">is_urgent</span> = matches!(status, Status::<span class="title function_ invoke__">Pending</span>(x) <span class="keyword">if</span> x &lt; <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_pending: &#123;&#125;&quot;</span>, is_pending);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;is_urgent: &#123;&#125;&quot;</span>, is_urgent);</span><br><span class="line">    <span class="comment">// 在 filter 中使用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">numbers</span> = <span class="built_in">vec!</span>[<span class="title function_ invoke__">Some</span>(<span class="number">1</span>), <span class="literal">None</span>, <span class="title function_ invoke__">Some</span>(<span class="number">3</span>), <span class="literal">None</span>, <span class="title function_ invoke__">Some</span>(<span class="number">5</span>)];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">valid</span>: <span class="type">Vec</span>&lt;_&gt; = numbers.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(|x| matches!(x, <span class="title function_ invoke__">Some</span>(_)))</span><br><span class="line">        .<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;valid: &#123;:?&#125;&quot;</span>, valid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="循环控制"><a href="#循环控制" class="headerlink" title="循环控制"></a>循环控制</h2><h3 id="loop-无限循环"><a href="#loop-无限循环" class="headerlink" title="loop 无限循环"></a>loop 无限循环</h3><p><code>loop</code> 创建无限循环，必须通过 <code>break</code> 退出，可以返回值。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本无限循环</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">loop</span> &#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> count == <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 break 返回值</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">counter</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">    counter += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> counter == <span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">break</span> counter * <span class="number">2</span>;  <span class="comment">// 返回 20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试逻辑</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">attempts</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">connection</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">    attempts += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">match</span> <span class="title function_ invoke__">try_connect</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(conn) =&gt; <span class="keyword">break</span> conn,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) <span class="keyword">if</span> attempts &lt; <span class="number">3</span> =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;重试 &#123;&#125;/3...&quot;</span>, attempts);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;连接失败: &#123;&#125;&quot;</span>, e),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态机</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">State</span> &#123; Start, Running, Finished &#125;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">state</span> = State::Start;</span><br><span class="line"></span><br><span class="line"><span class="keyword">loop</span> &#123;</span><br><span class="line">    state = <span class="keyword">match</span> state &#123;</span><br><span class="line">        State::Start =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;启动&quot;</span>);</span><br><span class="line">            State::Running</span><br><span class="line">        &#125;</span><br><span class="line">        State::Running =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;运行中&quot;</span>);</span><br><span class="line">            State::Finished</span><br><span class="line">        &#125;</span><br><span class="line">        State::Finished =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;完成&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="while-条件循环"><a href="#while-条件循环" class="headerlink" title="while 条件循环"></a>while 条件循环</h3><p>条件为真时持续执行。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本用法</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> n &lt; <span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, n);</span><br><span class="line">    n += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取输入直到特定条件</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">input</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">while</span> input.<span class="title function_ invoke__">trim</span>() != <span class="string">&quot;quit&quot;</span> &#123;</span><br><span class="line">    input.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">    std::io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> input).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;你输入了: &#123;&#125;&quot;</span>, input.<span class="title function_ invoke__">trim</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理可变状态</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stack</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">while</span> !stack.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">top</span> = stack.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;弹出: &#123;&#125;&quot;</span>, top);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="while-let-模式匹配循环"><a href="#while-let-模式匹配循环" class="headerlink" title="while let 模式匹配循环"></a>while let 模式匹配循环</h3><p>结合模式匹配的条件循环，常用于迭代器和 Option&#x2F;Result。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历 Option</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">optional</span> = <span class="title function_ invoke__">Some</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(i) = optional &#123;</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="number">5</span> &#123;</span><br><span class="line">        optional = <span class="literal">None</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);</span><br><span class="line">        optional = <span class="title function_ invoke__">Some</span>(i + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费栈</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stack</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(top) = stack.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;处理: &#123;&#125;&quot;</span>, top);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通道接收</span></span><br><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在另一个线程中发送数据...</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>(msg) = rx.<span class="title function_ invoke__">recv</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;收到: &#123;&#125;&quot;</span>, msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解构复杂类型</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pairs</span> = <span class="built_in">vec!</span>[(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>), (<span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>), (<span class="number">3</span>, <span class="string">&#x27;c&#x27;</span>)];</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>((num, ch)) = pairs.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, num, ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="for-迭代循环"><a href="#for-迭代循环" class="headerlink" title="for 迭代循环"></a>for 迭代循环</h3><p>Rust 最常用的循环，遍历任何实现了 <code>IntoIterator</code> 的类型。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 范围迭代</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);   <span class="comment">// 0, 1, 2, 3, 4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..=<span class="number">5</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);   <span class="comment">// 0, 1, 2, 3, 4, 5（包含结尾）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反向迭代</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> (<span class="number">0</span>..<span class="number">5</span>).<span class="title function_ invoke__">rev</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);   <span class="comment">// 4, 3, 2, 1, 0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历集合（三种方式）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;v &#123;         <span class="comment">// 借用，item: &amp;i32</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;<span class="keyword">mut</span> v &#123;     <span class="comment">// 可变借用，item: &amp;mut i32</span></span><br><span class="line">    *item += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> v &#123;          <span class="comment">// 获取所有权，item: i32</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带索引遍历</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">colors</span> = <span class="built_in">vec!</span>[<span class="string">&quot;红&quot;</span>, <span class="string">&quot;绿&quot;</span>, <span class="string">&quot;蓝&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">for</span> (index, color) <span class="keyword">in</span> colors.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, index, color);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历 HashMap</span></span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">scores</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">scores.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;Alice&quot;</span>, <span class="number">100</span>);</span><br><span class="line">scores.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;Bob&quot;</span>, <span class="number">85</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">for</span> (name, score) <span class="keyword">in</span> &amp;scores &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, name, score);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步进迭代</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> (<span class="number">0</span>..<span class="number">10</span>).<span class="title function_ invoke__">step_by</span>(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);   <span class="comment">// 0, 2, 4, 6, 8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并行迭代（使用 zip）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">names</span> = <span class="built_in">vec!</span>[<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;Bob&quot;</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="variable">ages</span> = <span class="built_in">vec!</span>[<span class="number">25</span>, <span class="number">30</span>];</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">for</span> (name, age) <span class="keyword">in</span> names.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">zip</span>(ages.<span class="title function_ invoke__">iter</span>()) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; is &#123;&#125; years old&quot;</span>, name, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="跳转控制"><a href="#跳转控制" class="headerlink" title="跳转控制"></a>跳转控制</h2><h3 id="break-退出循环"><a href="#break-退出循环" class="headerlink" title="break 退出循环"></a>break 退出循环</h3><p>退出当前循环，可携带返回值，可指定标签跳出多层循环。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本 break</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// break 携带值（仅限 loop）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = <span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = <span class="title function_ invoke__">compute</span>();</span><br><span class="line">    <span class="keyword">if</span> value &gt; <span class="number">100</span> &#123;</span><br><span class="line">        <span class="keyword">break</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带标签的 break（跳出外层循环）</span></span><br><span class="line"><span class="symbol">&#x27;outer</span>: <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> i * j &gt; <span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;在 (&#123;&#125;, &#123;&#125;) 处退出&quot;</span>, i, j);</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;outer</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标签 + 返回值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = <span class="symbol">&#x27;search</span>: <span class="keyword">loop</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> matrix[row][col] == target &#123;</span><br><span class="line">                <span class="keyword">break</span> <span class="symbol">&#x27;search</span> (row, col);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span> <span class="symbol">&#x27;search</span> (-<span class="number">1</span>, -<span class="number">1</span>);  <span class="comment">// 未找到</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h3 id="continue-跳过迭代"><a href="#continue-跳过迭代" class="headerlink" title="continue 跳过迭代"></a>continue 跳过迭代</h3><p>跳过当前迭代的剩余部分，进入下一次迭代。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本 continue</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;  <span class="comment">// 跳过偶数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, i);  <span class="comment">// 只打印奇数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带标签的 continue</span></span><br><span class="line"><span class="symbol">&#x27;outer</span>: <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span> <span class="symbol">&#x27;outer</span>;  <span class="comment">// 跳到外层下一次迭代</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, i, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤处理</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">items</span> = <span class="built_in">vec!</span>[<span class="title function_ invoke__">Some</span>(<span class="number">1</span>), <span class="literal">None</span>, <span class="title function_ invoke__">Some</span>(<span class="number">2</span>), <span class="literal">None</span>, <span class="title function_ invoke__">Some</span>(<span class="number">3</span>)];</span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> items &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(value) = item <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;  <span class="comment">// 跳过 None</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;处理: &#123;&#125;&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="return-函数返回"><a href="#return-函数返回" class="headerlink" title="return 函数返回"></a>return 函数返回</h3><p>从函数中提前返回，可携带返回值。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提前返回</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">f64</span>, b: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>;  <span class="comment">// 提前返回</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(a / b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在嵌套结构中返回</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">find_in_matrix</span>(matrix: &amp;[<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;], target: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;(<span class="type">usize</span>, <span class="type">usize</span>)&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">for</span> (i, row) <span class="keyword">in</span> matrix.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">for</span> (j, &amp;value) <span class="keyword">in</span> row.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> value == target &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Some</span>((i, j));  <span class="comment">// 找到后立即返回</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">None</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 隐式返回（最后一个表达式，不加分号）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">square</span>(x: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    x * x  <span class="comment">// 等价于 return x * x;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在闭包中使用（注意：return 只返回闭包，不返回外层函数）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process</span>(numbers: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    numbers.<span class="title function_ invoke__">into_iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">filter_map</span>(|n| &#123;</span><br><span class="line">            <span class="keyword">if</span> n &lt; <span class="number">0</span> &#123; <span class="keyword">return</span> <span class="literal">None</span>; &#125;  <span class="comment">// 返回闭包</span></span><br><span class="line">            <span class="title function_ invoke__">Some</span>(n * <span class="number">2</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="标签块表达式"><a href="#标签块表达式" class="headerlink" title="标签块表达式"></a>标签块表达式</h3><p>从任意代码块中返回值，不仅限于循环。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本标签块</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = <span class="symbol">&#x27;block</span>: &#123;</span><br><span class="line">    <span class="keyword">if</span> condition_a &#123;</span><br><span class="line">        <span class="keyword">break</span> <span class="symbol">&#x27;block</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> condition_b &#123;</span><br><span class="line">        <span class="keyword">break</span> <span class="symbol">&#x27;block</span> <span class="string">&quot;B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;default&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替代复杂的嵌套 if</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">categorize</span>(value: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="symbol">&#x27;check</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;check</span> <span class="string">&quot;negative&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> value == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;check</span> <span class="string">&quot;zero&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;check</span> <span class="string">&quot;small&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> value &lt; <span class="number">100</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> <span class="symbol">&#x27;check</span> <span class="string">&quot;medium&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">&quot;large&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提前退出复杂逻辑</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">validated</span> = <span class="symbol">&#x27;validation</span>: &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(name) = <span class="title function_ invoke__">get_name</span>() <span class="keyword">else</span> &#123; <span class="keyword">break</span> <span class="symbol">&#x27;validation</span> <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Some</span>(age) = <span class="title function_ invoke__">get_age</span>() <span class="keyword">else</span> &#123; <span class="keyword">break</span> <span class="symbol">&#x27;validation</span> <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> age &lt; <span class="number">18</span> &#123; <span class="keyword">break</span> <span class="symbol">&#x27;validation</span> <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h2><h3 id="match-表达式"><a href="#match-表达式" class="headerlink" title="match 表达式"></a>match 表达式</h3><p>Rust 最强大的控制流结构，必须穷尽所有可能。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">number</span> = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本匹配</span></span><br><span class="line"><span class="keyword">match</span> number &#123;</span><br><span class="line">    <span class="number">1</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;一&quot;</span>),</span><br><span class="line">    <span class="number">2</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;二&quot;</span>),</span><br><span class="line">    <span class="number">3</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;三&quot;</span>),</span><br><span class="line">    _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;其他&quot;</span>),  <span class="comment">// 通配符，匹配剩余所有</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或模式</span></span><br><span class="line"><span class="keyword">match</span> number &#123;</span><br><span class="line">    <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;小数字&quot;</span>),</span><br><span class="line">    <span class="number">4</span>..=<span class="number">10</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;中等数字&quot;</span>),   <span class="comment">// 范围模式（包含边界）</span></span><br><span class="line">    _ =&gt; <span class="built_in">println!</span>(<span class="string">&quot;大数字&quot;</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 守卫条件</span></span><br><span class="line"><span class="keyword">match</span> number &#123;</span><br><span class="line">    n <span class="keyword">if</span> n &lt; <span class="number">0</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;负数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n <span class="keyword">if</span> n == <span class="number">0</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;零&quot;</span>),</span><br><span class="line">    n <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">0</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;正偶数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n =&gt; <span class="built_in">println!</span>(<span class="string">&quot;正奇数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;,</span><br><span class="line">    <span class="title function_ invoke__">Write</span>(<span class="type">String</span>),</span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">msg</span> = Message::<span class="title function_ invoke__">ChangeColor</span>(<span class="number">255</span>, <span class="number">128</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> msg &#123;</span><br><span class="line">    Message::Quit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;退出&quot;</span>),</span><br><span class="line">    Message::Move &#123; x, y &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;移动到 (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y),</span><br><span class="line">    Message::<span class="title function_ invoke__">Write</span>(text) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;写入: &#123;&#125;&quot;</span>, text),</span><br><span class="line">    Message::<span class="title function_ invoke__">ChangeColor</span>(r, g, b) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;颜色: RGB(&#123;&#125;, &#123;&#125;, &#123;&#125;)&quot;</span>, r, g, b),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匹配返回值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">description</span> = <span class="keyword">match</span> number &#123;</span><br><span class="line">    <span class="number">0</span> =&gt; <span class="string">&quot;零&quot;</span>,</span><br><span class="line">    <span class="number">1</span>..=<span class="number">9</span> =&gt; <span class="string">&quot;个位数&quot;</span>,</span><br><span class="line">    <span class="number">10</span>..=<span class="number">99</span> =&gt; <span class="string">&quot;两位数&quot;</span>,</span><br><span class="line">    _ =&gt; <span class="string">&quot;更大的数&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h3 id="绑定"><a href="#绑定" class="headerlink" title="@ 绑定"></a>@ 绑定</h3><p>在匹配的同时将值绑定到变量。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">num</span> = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本 @ 绑定</span></span><br><span class="line"><span class="keyword">match</span> num &#123;</span><br><span class="line">    n @ <span class="number">1</span>..=<span class="number">5</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;1-5 范围内: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n @ <span class="number">6</span>..=<span class="number">10</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;6-10 范围内: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n =&gt; <span class="built_in">println!</span>(<span class="string">&quot;范围外: &#123;&#125;&quot;</span>, n),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或模式中的绑定</span></span><br><span class="line"><span class="keyword">match</span> num &#123;</span><br><span class="line">    n @ (<span class="number">1</span> | <span class="number">3</span> | <span class="number">5</span> | <span class="number">7</span> | <span class="number">9</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;奇数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n @ (<span class="number">2</span> | <span class="number">4</span> | <span class="number">6</span> | <span class="number">8</span> | <span class="number">10</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;偶数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    n =&gt; <span class="built_in">println!</span>(<span class="string">&quot;其他: &#123;&#125;&quot;</span>, n),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 枚举中的 @ 绑定</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Hello &#123; id: <span class="type">i32</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">msg</span> = Message::Hello &#123; id: <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> msg &#123;</span><br><span class="line">    Message::Hello &#123; id: id_var @ <span class="number">3</span>..=<span class="number">7</span> &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;id 在 3-7 范围内: &#123;&#125;&quot;</span>, id_var);</span><br><span class="line">    &#125;</span><br><span class="line">    Message::Hello &#123; id: <span class="number">10</span>..=<span class="number">12</span> &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;id 在 10-12 范围内&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Message::Hello &#123; id &#125; =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;其他 id: &#123;&#125;&quot;</span>, id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结合守卫</span></span><br><span class="line"><span class="keyword">match</span> <span class="title function_ invoke__">Some</span>(<span class="number">42</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(n @ <span class="number">1</span>..=<span class="number">100</span>) <span class="keyword">if</span> n % <span class="number">2</span> == <span class="number">0</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;1-100 的偶数: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(n) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;其他: &#123;&#125;&quot;</span>, n),</span><br><span class="line">    <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;无值&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="模式语法详解"><a href="#模式语法详解" class="headerlink" title="模式语法详解"></a>模式语法详解</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解构元组</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">point</span> = (<span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">match</span> point &#123;</span><br><span class="line">    (<span class="number">0</span>, <span class="number">0</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;原点&quot;</span>),</span><br><span class="line">    (x, <span class="number">0</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;x轴上, x = &#123;&#125;&quot;</span>, x),</span><br><span class="line">    (<span class="number">0</span>, y) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;y轴上, y = &#123;&#125;&quot;</span>, y),</span><br><span class="line">    (x, y) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;点 (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解构结构体</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Point &#123; x: <span class="number">0</span>, y: <span class="number">7</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> p &#123;</span><br><span class="line">    Point &#123; x: <span class="number">0</span>, y &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;y轴上, y = &#123;&#125;&quot;</span>, y),</span><br><span class="line">    Point &#123; x, y: <span class="number">0</span> &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;x轴上, x = &#123;&#125;&quot;</span>, x),</span><br><span class="line">    Point &#123; x, y &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;点 (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// .. 忽略剩余字段/元素</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point3D</span> &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span>, z: <span class="type">i32</span> &#125;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Point3D &#123; x: <span class="number">1</span>, y: <span class="number">2</span>, z: <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">Point3D</span> &#123; x, .. &#125; = p;  <span class="comment">// 只取 x，忽略 y 和 z</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 切片模式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">match</span> &amp;arr[..] &#123;</span><br><span class="line">    [] =&gt; <span class="built_in">println!</span>(<span class="string">&quot;空&quot;</span>),</span><br><span class="line">    [single] =&gt; <span class="built_in">println!</span>(<span class="string">&quot;单元素: &#123;&#125;&quot;</span>, single),</span><br><span class="line">    [first, second] =&gt; <span class="built_in">println!</span>(<span class="string">&quot;两个元素: &#123;&#125;, &#123;&#125;&quot;</span>, first, second),</span><br><span class="line">    [first, .., last] =&gt; <span class="built_in">println!</span>(<span class="string">&quot;首: &#123;&#125;, 尾: &#123;&#125;&quot;</span>, first, last),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @ 绑定切片剩余部分</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">numbers</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"><span class="keyword">match</span> numbers &#123;</span><br><span class="line">    [first, rest @ ..] =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;首: &#123;&#125;, 剩余: &#123;:?&#125;&quot;</span>, first, rest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ref 和 ref mut - 创建引用</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pair</span> = (<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>), <span class="number">42</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> pair &#123;</span><br><span class="line">    (<span class="keyword">ref</span> s, <span class="keyword">ref</span> <span class="keyword">mut</span> n) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;字符串: &#123;&#125;&quot;</span>, s);  <span class="comment">// s: &amp;String</span></span><br><span class="line">        *n += <span class="number">1</span>;                    <span class="comment">// n: &amp;mut i32</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 嵌套解构</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Rgb</span>(<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>),</span><br><span class="line">    <span class="title function_ invoke__">Hsv</span>(<span class="type">u8</span>, <span class="type">u8</span>, <span class="type">u8</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">ChangeColor</span>(Color),</span><br><span class="line">    Quit,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">msg</span> = Message::<span class="title function_ invoke__">ChangeColor</span>(Color::<span class="title function_ invoke__">Rgb</span>(<span class="number">255</span>, <span class="number">128</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span> msg &#123;</span><br><span class="line">    Message::<span class="title function_ invoke__">ChangeColor</span>(Color::<span class="title function_ invoke__">Rgb</span>(r, g, b)) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;RGB: (&#123;&#125;, &#123;&#125;, &#123;&#125;)&quot;</span>, r, g, b);</span><br><span class="line">    &#125;</span><br><span class="line">    Message::<span class="title function_ invoke__">ChangeColor</span>(Color::<span class="title function_ invoke__">Hsv</span>(h, s, v)) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;HSV: (&#123;&#125;, &#123;&#125;, &#123;&#125;)&quot;</span>, h, s, v);</span><br><span class="line">    &#125;</span><br><span class="line">    Message::Quit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;退出&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><h3 id="运算符"><a href="#运算符" class="headerlink" title="? 运算符"></a>? 运算符</h3><p>简化错误传播，遇到 <code>Err</code> 或 <code>None</code> 时提前返回。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Read&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传播 Result 错误</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_file</span>(path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(path)?;  <span class="comment">// 失败则返回 Err</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">content</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> content)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 链式调用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_file_compact</span>(path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, io::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">content</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    File::<span class="title function_ invoke__">open</span>(path)?.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> content)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传播 Option 的 None</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">first_char</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">char</span>&gt; &#123;</span><br><span class="line">    s.<span class="title function_ invoke__">lines</span>().<span class="title function_ invoke__">next</span>()?.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 main 中使用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">content</span> = <span class="title function_ invoke__">read_file</span>(<span class="string">&quot;config.txt&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, content);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换错误类型（配合 From trait）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), MyError&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">content</span> = std::fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;file.txt&quot;</span>)?;  <span class="comment">// io::Error -&gt; MyError</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span>: Data = serde_json::<span class="title function_ invoke__">from_str</span>(&amp;content)?;    <span class="comment">// serde::Error -&gt; MyError</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="panic-宏"><a href="#panic-宏" class="headerlink" title="panic! 宏"></a>panic! 宏</h3><p>不可恢复错误，终止程序（或在 panic&#x3D;abort 模式下直接中止）。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本用法</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;除数不能为零!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a / b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 格式化消息</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_item</span>(index: <span class="type">usize</span>, items: &amp;[&amp;<span class="type">str</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> index &gt;= items.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;索引 &#123;&#125; 越界，数组长度为 &#123;&#125;&quot;</span>, index, items.<span class="title function_ invoke__">len</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标记不可达代码</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_type</span>(t: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> t &#123;</span><br><span class="line">        <span class="string">&quot;a&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;b&quot;</span> =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;c&quot;</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        _ =&gt; <span class="built_in">unreachable!</span>(<span class="string">&quot;未知类型: &#123;&#125;&quot;</span>, t),  <span class="comment">// 不应该到达这里</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标记待实现</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">complex_algorithm</span>() &#123;</span><br><span class="line">    todo!(<span class="string">&quot;待实现复杂算法&quot;</span>);  <span class="comment">// 会 panic 并显示文件位置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">placeholder</span>() &#123;</span><br><span class="line">    <span class="built_in">unimplemented!</span>(<span class="string">&quot;此功能尚未实现&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="unwrap-和-expect"><a href="#unwrap-和-expect" class="headerlink" title="unwrap 和 expect"></a>unwrap 和 expect</h3><p>快速提取值的方法，失败时 panic。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unwrap - 失败时 panic，无自定义消息</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">value</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = value.<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">none</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="literal">None</span>;</span><br><span class="line"><span class="comment">// let v = none.unwrap();  // panic: called `Option::unwrap()` on a `None` value</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// expect - 失败时 panic，带自定义消息</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">config</span> = std::fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;config.txt&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;无法读取配置文件&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适用场景：确信不会失败</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">num</span>: <span class="type">i32</span> = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;硬编码的字符串应该能解析&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全替代方案</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">value</span> = some_option.<span class="title function_ invoke__">unwrap_or</span>(<span class="number">0</span>);           <span class="comment">// 默认值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">value</span> = some_option.<span class="title function_ invoke__">unwrap_or_else</span>(|| <span class="title function_ invoke__">compute_default</span>());  <span class="comment">// 惰性默认值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">value</span> = some_option.<span class="title function_ invoke__">unwrap_or_default</span>();    <span class="comment">// 类型的 Default 值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Result 的变体</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">ok_value</span> = result.<span class="title function_ invoke__">unwrap_or</span>(default);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">ok_value</span> = result.<span class="title function_ invoke__">unwrap_or_else</span>(|e| <span class="title function_ invoke__">handle_error</span>(e));</span><br><span class="line"><span class="keyword">let</span> <span class="variable">err_value</span> = result.<span class="title function_ invoke__">unwrap_err</span>();  <span class="comment">// 期望是 Err，提取错误</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="块表达式"><a href="#块表达式" class="headerlink" title="块表达式"></a>块表达式</h2><p>Rust 中几乎所有代码块都是表达式，最后一行无分号即为返回值。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本块表达式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="number">2</span>;</span><br><span class="line">    a + b  <span class="comment">// 无分号，返回 3</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 与加分号的区别</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">unit</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="number">2</span>;</span><br><span class="line">    a + b;  <span class="comment">// 加分号，返回 ()</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 限制变量作用域</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">message</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">temp</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    temp.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;Hello, &quot;</span>);</span><br><span class="line">    temp.<span class="title function_ invoke__">push_str</span>(<span class="string">&quot;World!&quot;</span>);</span><br><span class="line">    temp</span><br><span class="line">&#125;;  <span class="comment">// temp 在此处被释放，message 获得所有权</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂初始化</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">connection</span> = &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">config</span> = <span class="title function_ invoke__">load_config</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool</span> = <span class="title function_ invoke__">create_pool</span>(&amp;config);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">conn</span> = pool.<span class="title function_ invoke__">get_connection</span>();</span><br><span class="line">    conn.<span class="title function_ invoke__">configure</span>(&amp;config);</span><br><span class="line">    conn</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 match 分支中</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">description</span> = <span class="keyword">match</span> status_code &#123;</span><br><span class="line">    <span class="number">200</span> =&gt; <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">    <span class="number">404</span> =&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">log_not_found</span>();</span><br><span class="line">        <span class="string">&quot;未找到&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">500</span>..=<span class="number">599</span> =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = <span class="built_in">format!</span>(<span class="string">&quot;服务器错误: &#123;&#125;&quot;</span>, status_code);</span><br><span class="line">        <span class="title function_ invoke__">log_error</span>(&amp;msg);</span><br><span class="line">        <span class="string">&quot;服务器错误&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    _ =&gt; <span class="string">&quot;未知状态&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unsafe 块也是表达式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">ptr_value</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = some_raw_ptr;</span><br><span class="line">    *ptr</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<h1 id="方法-Method"><a href="#方法-Method" class="headerlink" title="方法 Method"></a>方法 Method</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>方法</strong>是定义在结构体、枚举或 trait 对象上下文中的函数，第一个参数始终是 <code>self</code>，代表调用该方法的实例。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│                    方法 vs 函数                      │</span><br><span class="line">├─────────────────────────────────────────────────────┤</span><br><span class="line">│  函数 (fn)     │  独立存在，不依附于任何类型          │</span><br><span class="line">│  方法 (method) │  定义在 impl 块中，绑定到特定类型    │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    width: <span class="type">u32</span>,</span><br><span class="line">    height: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="comment">// 👇 方法：第一个参数是 self</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">area</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.width * <span class="keyword">self</span>.height</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 👇 关联函数：没有 self 参数（类似其他语言的静态方法）</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(width: <span class="type">u32</span>, height: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Rectangle &#123; width, height &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(<span class="number">30</span>, <span class="number">50</span>);  <span class="comment">// 关联函数调用：::</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;面积: &#123;&#125;&quot;</span>, rect.<span class="title function_ invoke__">area</span>());   <span class="comment">// 方法调用：.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="self-的三种形式"><a href="#self-的三种形式" class="headerlink" title="self 的三种形式"></a><code>self</code> 的三种形式</h2><table>
<thead>
<tr>
<th>形式</th>
<th>含义</th>
<th>所有权</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>&amp;self</code></td>
<td>不可变借用</td>
<td>借用</td>
<td>只读访问（最常用）</td>
</tr>
<tr>
<td><code>&amp;mut self</code></td>
<td>可变借用</td>
<td>借用</td>
<td>需要修改实例</td>
</tr>
<tr>
<td><code>self</code></td>
<td>获取所有权</td>
<td>转移</td>
<td>转换类型或消费实例</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="comment">// 不可变借用：只读</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">area</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.width * <span class="keyword">self</span>.height</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 可变借用：可修改</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">scale</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, factor: <span class="type">u32</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.width *= factor;</span><br><span class="line">        <span class="keyword">self</span>.height *= factor;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取所有权：消费自身，返回新类型</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">to_square</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Rectangle &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">side</span> = <span class="keyword">self</span>.width.<span class="title function_ invoke__">max</span>(<span class="keyword">self</span>.height);</span><br><span class="line">        Rectangle &#123; width: side, height: side &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="自动引用和解引用"><a href="#自动引用和解引用" class="headerlink" title="自动引用和解引用"></a>自动引用和解引用</h2><p>Rust 会<strong>自动添加</strong> <code>&amp;</code>、<code>&amp;mut</code> 或 <code>*</code>，使方法调用更简洁：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下两种写法等价：</span></span><br><span class="line">rect.<span class="title function_ invoke__">area</span>();</span><br><span class="line">(&amp;rect).<span class="title function_ invoke__">area</span>();    <span class="comment">// Rust 自动推导</span></span><br></pre></td></tr></table></figure></div>

<h2 id="多个-impl-块"><a href="#多个-impl-块" class="headerlink" title="多个 impl 块"></a>多个 impl 块</h2><p>一个类型可以有多个 <code>impl</code> 块（常用于 trait 实现分离）：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">area</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">perimeter</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 trait</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">std</span>::fmt::Display <span class="keyword">for</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;&#123;&#125;x&#123;&#125;&quot;</span>, <span class="keyword">self</span>.width, <span class="keyword">self</span>.height)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="枚举上的方法"><a href="#枚举上的方法" class="headerlink" title="枚举上的方法"></a>枚举上的方法</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    Quit,</span><br><span class="line">    Move &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;,</span><br><span class="line">    <span class="title function_ invoke__">Write</span>(<span class="type">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">call</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Message::Quit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;退出&quot;</span>),</span><br><span class="line">            Message::Move &#123; x, y &#125; =&gt; <span class="built_in">println!</span>(<span class="string">&quot;移动到 (&#123;&#125;, &#123;&#125;)&quot;</span>, x, y),</span><br><span class="line">            Message::<span class="title function_ invoke__">Write</span>(s) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;消息: &#123;&#125;&quot;</span>, s),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="方法链式调用"><a href="#方法链式调用" class="headerlink" title="方法链式调用"></a>方法链式调用</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set_width</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, width: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.width = width;</span><br><span class="line">        <span class="keyword">self</span>  <span class="comment">// 返回自身，支持链式调用</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set_height</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, height: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.height = height;</span><br><span class="line">        <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 链式调用</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">rect</span> = Rectangle::<span class="title function_ invoke__">new</span>(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_ invoke__">set_width</span>(<span class="number">100</span>)</span><br><span class="line">    .<span class="title function_ invoke__">set_height</span>(<span class="number">50</span>);</span><br></pre></td></tr></table></figure></div>

<h1 id="泛型-Generics"><a href="#泛型-Generics" class="headerlink" title="泛型 Generics"></a>泛型 Generics</h1><h2 id="核心概念-1"><a href="#核心概念-1" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>泛型</strong>是一种参数化类型的机制，让代码可以处理多种数据类型，而无需重复编写。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      泛型的价值                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  ✗ 没有泛型：fn max_i32(a: i32, b: i32) -&gt; i32             │</span><br><span class="line">│              fn max_f64(a: f64, b: f64) -&gt; f64   重复代码！  │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  ✓ 使用泛型：fn max&lt;T&gt;(a: T, b: T) -&gt; T          一份代码！  │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="函数泛型"><a href="#函数泛型" class="headerlink" title="函数泛型"></a>函数泛型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// T 是类型参数，可以是任意名称（惯例用大写字母）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">largest</span>&lt;T: <span class="built_in">PartialOrd</span>&gt;(a: T, b: T) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    <span class="keyword">if</span> a &gt; b &#123; a &#125; <span class="keyword">else</span> &#123; b &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">largest</span>(<span class="number">5</span>, <span class="number">10</span>));       <span class="comment">// T = i32</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">largest</span>(<span class="number">3.14</span>, <span class="number">2.71</span>));  <span class="comment">// T = f64</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">largest</span>(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;z&#x27;</span>));    <span class="comment">// T = char</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="结构体泛型"><a href="#结构体泛型" class="headerlink" title="结构体泛型"></a>结构体泛型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个类型参数</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个类型参数</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Pair</span>&lt;T, U&gt; &#123;</span><br><span class="line">    first: T,</span><br><span class="line">    second: U,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">int_point</span> = Point &#123; x: <span class="number">5</span>, y: <span class="number">10</span> &#125;;           <span class="comment">// Point&lt;i32&gt;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">float_point</span> = Point &#123; x: <span class="number">1.0</span>, y: <span class="number">4.0</span> &#125;;      <span class="comment">// Point&lt;f64&gt;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mixed</span> = Pair &#123; first: <span class="number">5</span>, second: <span class="string">&quot;hello&quot;</span> &#125;;  <span class="comment">// Pair&lt;i32, &amp;str&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="枚举泛型"><a href="#枚举泛型" class="headerlink" title="枚举泛型"></a>枚举泛型</h2><p>标准库中最经典的两个泛型枚举：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Option&lt;T&gt; - 表示可能存在的值</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Option</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(T),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result&lt;T, E&gt; - 表示可能失败的操作</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Result</span>&lt;T, E&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(T),</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(E),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">number</span>: <span class="type">Option</span>&lt;<span class="type">i32</span>&gt; = <span class="title function_ invoke__">Some</span>(<span class="number">42</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">text</span>: <span class="type">Option</span>&lt;&amp;<span class="type">str</span>&gt; = <span class="literal">None</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">success</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; = <span class="title function_ invoke__">Ok</span>(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">failure</span>: <span class="type">Result</span>&lt;<span class="type">i32</span>, <span class="type">String</span>&gt; = <span class="title function_ invoke__">Err</span>(<span class="string">&quot;错误&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="方法泛型"><a href="#方法泛型" class="headerlink" title="方法泛型"></a>方法泛型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&lt;T&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为所有 Point&lt;T&gt; 实现方法</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Point&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(x: T, y: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Point &#123; x, y &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">x</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.x</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅为 Point&lt;f64&gt; 实现特定方法</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Point</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">distance_from_origin</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">f64</span> &#123;</span><br><span class="line">        (<span class="keyword">self</span>.x.<span class="title function_ invoke__">powi</span>(<span class="number">2</span>) + <span class="keyword">self</span>.y.<span class="title function_ invoke__">powi</span>(<span class="number">2</span>)).<span class="title function_ invoke__">sqrt</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法自身也可以有额外的泛型参数</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Point&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">mixup</span>&lt;U&gt;(<span class="keyword">self</span>, other: Point&lt;U&gt;) <span class="punctuation">-&gt;</span> Point&lt;T, U&gt; &#123;</span><br><span class="line">        Point &#123;</span><br><span class="line">            x: <span class="keyword">self</span>.x,</span><br><span class="line">            y: other.y,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Trait-Bounds（特征约束）"><a href="#Trait-Bounds（特征约束）" class="headerlink" title="Trait Bounds（特征约束）"></a>Trait Bounds（特征约束）</h2><h3 id="基本语法-1"><a href="#基本语法-1" class="headerlink" title="基本语法"></a>基本语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 语法1：冒号约束</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_info</span>&lt;T: std::fmt::Display&gt;(item: T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 语法2：where 子句（更清晰）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">complex_function</span>&lt;T, U&gt;(t: T, u: U) <span class="punctuation">-&gt;</span> <span class="type">i32</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Display + <span class="built_in">Clone</span>,</span><br><span class="line">    U: <span class="built_in">Debug</span> + <span class="built_in">PartialOrd</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="常见约束模式"><a href="#常见约束模式" class="headerlink" title="常见约束模式"></a>常见约束模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────┬────────────────────────────────────────┐</span><br><span class="line">│ 约束形式          │ 含义                                   │</span><br><span class="line">├──────────────────┼────────────────────────────────────────┤</span><br><span class="line">│ T: <span class="built_in">Clone</span>         │ T 必须实现 <span class="built_in">Clone</span>                        │</span><br><span class="line">│ T: <span class="built_in">Clone</span> + <span class="built_in">Debug</span> │ T 必须同时实现 <span class="built_in">Clone</span> 和 <span class="built_in">Debug</span>           │</span><br><span class="line">│ T: <span class="symbol">&#x27;static</span>       │ T 不包含非静态引用                      │</span><br><span class="line">│ T: ?<span class="built_in">Sized</span>        │ T 可以是动态大小类型                    │</span><br><span class="line">│ T: <span class="built_in">Default</span>       │ T 可以有默认值                          │</span><br><span class="line">└──────────────────┴────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="实际示例"><a href="#实际示例" class="headerlink" title="实际示例"></a>实际示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::&#123;Display, <span class="built_in">Debug</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要比较大小，需要 PartialOrd</span></span><br><span class="line"><span class="comment">// 要返回值，需要 Copy（或用引用）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">largest</span>&lt;T: <span class="built_in">PartialOrd</span> + <span class="built_in">Copy</span>&gt;(list: &amp;[T]) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">largest</span> = list[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> &amp;item <span class="keyword">in</span> list &#123;</span><br><span class="line">        <span class="keyword">if</span> item &gt; largest &#123;</span><br><span class="line">            largest = item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    largest</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 where 子句</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T&gt;(item: &amp;T) </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    T: Display + <span class="built_in">Clone</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;通知: &#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="impl-Trait-语法糖"><a href="#impl-Trait-语法糖" class="headerlink" title="impl Trait 语法糖"></a>impl Trait 语法糖</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数位置：接受任何实现了 Display 的类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print</span>(item: <span class="keyword">impl</span> <span class="title class_">Display</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回位置：返回某个实现了 Iterator 的类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">counter</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Iterator</span>&lt;Item = <span class="type">i32</span>&gt; &#123;</span><br><span class="line">    (<span class="number">0</span>..<span class="number">10</span>).<span class="title function_ invoke__">filter</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="const-泛型（常量泛型）"><a href="#const-泛型（常量泛型）" class="headerlink" title="const 泛型（常量泛型）"></a>const 泛型（常量泛型）</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// N 是常量泛型参数</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Array</span>&lt;T, <span class="keyword">const</span> N: <span class="type">usize</span>&gt; &#123;</span><br><span class="line">    data: [T; N],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T, <span class="keyword">const</span> N: <span class="type">usize</span>&gt; Array&lt;T, N&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">len</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        N</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: Array&lt;<span class="type">i32</span>, <span class="number">5</span>&gt; = Array &#123; data: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;长度: &#123;&#125;&quot;</span>, arr.<span class="title function_ invoke__">len</span>());  <span class="comment">// 5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="默认类型参数"><a href="#默认类型参数" class="headerlink" title="默认类型参数"></a>默认类型参数</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准库 Add trait 的定义</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Add</span>&lt;Rhs = <span class="keyword">Self</span>&gt; &#123;  <span class="comment">// Rhs 默认为 Self</span></span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, rhs: Rhs) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>::Output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认类型</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Add</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = Point;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, other: Point) <span class="punctuation">-&gt;</span> Point &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="单态化（零成本抽象）"><a href="#单态化（零成本抽象）" class="headerlink" title="单态化（零成本抽象）"></a>单态化（零成本抽象）</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    编译时单态化                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  源代码:                                                     │</span><br><span class="line">│    fn id&lt;T&gt;(x: T) -&gt; T &#123; x &#125;                                │</span><br><span class="line">│    id(5);    // 调用1                                        │</span><br><span class="line">│    id(3.14); // 调用2                                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  编译后生成:                                                 │</span><br><span class="line">│    fn id_i32(x: i32) -&gt; i32 &#123; x &#125;                           │</span><br><span class="line">│    fn id_f64(x: f64) -&gt; f64 &#123; x &#125;                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  ✓ 运行时零开销                                              │</span><br><span class="line">│  ✗ 可能增加二进制体积                                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见使用模式"><a href="#常见使用模式" class="headerlink" title="常见使用模式"></a>常见使用模式</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 构造函数模式</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="type">Vec</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;T&gt; &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 转换模式</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">convert</span>&lt;T: <span class="built_in">Into</span>&lt;<span class="type">String</span>&gt;&gt;(value: T) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    value.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 条件实现</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: Display&gt; <span class="built_in">ToString</span> <span class="keyword">for</span> <span class="title class_">T</span> &#123;</span><br><span class="line">    <span class="comment">// 所有实现 Display 的类型自动获得 ToString</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 关联类型 vs 泛型参数</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;  <span class="comment">// 关联类型：每个实现只有一种 Item</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Container</span>&lt;T&gt; &#123;  <span class="comment">// 泛型参数：可为同一类型多次实现</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">contains</span>(&amp;<span class="keyword">self</span>, item: &amp;T) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="特征-Trait"><a href="#特征-Trait" class="headerlink" title="特征 Trait"></a>特征 Trait</h1><h2 id="核心概念-2"><a href="#核心概念-2" class="headerlink" title="核心概念"></a>核心概念</h2><p><strong>Trait</strong> 定义了类型应该具备的<strong>行为</strong>（方法集合），类似于其他语言的接口（Interface），但更强大。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Trait 的本质                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  • 定义共享行为的抽象                                        │</span><br><span class="line">│  • 实现多态（编译时/运行时）                                 │</span><br><span class="line">│  • 约束泛型参数                                              │</span><br><span class="line">│  • 扩展现有类型的能力                                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="基本语法-2"><a href="#基本语法-2" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="定义-Trait"><a href="#定义-Trait" class="headerlink" title="定义 Trait"></a>定义 Trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 trait</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>;  <span class="comment">// 必须实现的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="实现-Trait"><a href="#实现-Trait" class="headerlink" title="实现 Trait"></a>实现 Trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">    title: <span class="type">String</span>,</span><br><span class="line">    author: <span class="type">String</span>,</span><br><span class="line">    content: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Tweet</span> &#123;</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    content: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 Article 实现 Summary</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; by &#123;&#125;&quot;</span>, <span class="keyword">self</span>.title, <span class="keyword">self</span>.author)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 Tweet 实现 Summary</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Tweet</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;@&#123;&#125;: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">article</span> = Article &#123;</span><br><span class="line">        title: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Rust入门&quot;</span>),</span><br><span class="line">        author: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;张三&quot;</span>),</span><br><span class="line">        content: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;...&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, article.<span class="title function_ invoke__">summarize</span>());  <span class="comment">// &quot;Rust入门 by 张三&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="默认实现"><a href="#默认实现" class="headerlink" title="默认实现"></a>默认实现</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="comment">// 默认实现</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;(阅读更多...)&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带默认实现的方法可以调用其他方法</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize_author</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">full_summary</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;作者: &#123;&#125; - &#123;&#125;&quot;</span>, <span class="keyword">self</span>.<span class="title function_ invoke__">summarize_author</span>(), <span class="keyword">self</span>.<span class="title function_ invoke__">summarize</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Article</span> &#123;</span><br><span class="line">    <span class="comment">// 使用默认的 summarize()</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize_author</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.author.<span class="title function_ invoke__">clone</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Summary</span> <span class="keyword">for</span> <span class="title class_">Tweet</span> &#123;</span><br><span class="line">    <span class="comment">// 覆盖默认实现</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;@&#123;&#125;: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.username, <span class="keyword">self</span>.content)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">summarize_author</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;@&#123;&#125;&quot;</span>, <span class="keyword">self</span>.username)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Trait-作为参数"><a href="#Trait-作为参数" class="headerlink" title="Trait 作为参数"></a>Trait 作为参数</h2><h3 id="三种等价写法"><a href="#三种等价写法" class="headerlink" title="三种等价写法"></a>三种等价写法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. impl Trait 语法（最简洁）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify</span>(item: &amp;<span class="keyword">impl</span> <span class="title class_">Summary</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;速报: &#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Trait Bound 语法</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T: Summary&gt;(item: &amp;T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;速报: &#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. where 子句（复杂约束时更清晰）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">notify</span>&lt;T&gt;(item: &amp;T) </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    T: Summary </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;速报: &#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="多重约束"><a href="#多重约束" class="headerlink" title="多重约束"></a>多重约束</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::&#123;Display, <span class="built_in">Debug</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 +</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_info</span>(item: &amp;(<span class="keyword">impl</span> <span class="title class_">Summary</span> + Display)) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item.<span class="title function_ invoke__">summarize</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trait Bound 形式</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_info</span>&lt;T: Summary + Display&gt;(item: &amp;T) &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// where 子句形式</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">complex</span>&lt;T, U&gt;(t: &amp;T, u: &amp;U) <span class="punctuation">-&gt;</span> <span class="type">String</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    T: Summary + <span class="built_in">Clone</span>,</span><br><span class="line">    U: Display + <span class="built_in">Debug</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125; - &#123;:?&#125;&quot;</span>, t.<span class="title function_ invoke__">summarize</span>(), u)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Trait-作为返回值"><a href="#Trait-作为返回值" class="headerlink" title="Trait 作为返回值"></a>Trait 作为返回值</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回实现了 Summary 的某个类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_summary</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    Tweet &#123;</span><br><span class="line">        username: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;test&quot;</span>),</span><br><span class="line">        content: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 限制：只能返回单一类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_summary</span>(switch: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Summary</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> switch &#123;</span><br><span class="line">        Article &#123; <span class="comment">/* ... */</span> &#125;  <span class="comment">// ❌ 错误！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Tweet &#123; <span class="comment">/* ... */</span> &#125;    <span class="comment">// 不能返回不同类型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="常用标准库-Trait"><a href="#常用标准库-Trait" class="headerlink" title="常用标准库 Trait"></a>常用标准库 Trait</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┬────────────────────────────────────────────┐</span><br><span class="line">│ Trait           │ 用途                                        │</span><br><span class="line">├─────────────────┼────────────────────────────────────────────┤</span><br><span class="line">│ Clone           │ 显式深拷贝 (.clone())                       │</span><br><span class="line">│ Copy            │ 隐式按位复制（栈上简单类型）                │</span><br><span class="line">│ Debug           │ 调试格式化 (&#123;:?&#125;)                           │</span><br><span class="line">│ Display         │ 用户友好格式化 (&#123;&#125;)                         │</span><br><span class="line">│ Default         │ 默认值                                      │</span><br><span class="line">│ PartialEq / Eq  │ 相等比较 (== !=)                           │</span><br><span class="line">│ PartialOrd / Ord│ 排序比较 (&lt; &gt; &lt;= &gt;=)                       │</span><br><span class="line">│ Hash            │ 哈希计算                                    │</span><br><span class="line">│ Drop            │ 析构函数                                    │</span><br><span class="line">│ From / Into     │ 类型转换                                    │</span><br><span class="line">│ AsRef / AsMut   │ 引用转换                                    │</span><br><span class="line">│ Deref / DerefMut│ 解引用运算符重载                           │</span><br><span class="line">│ Iterator        │ 迭代器                                      │</span><br><span class="line">│ Fn/FnMut/FnOnce │ 闭包                                        │</span><br><span class="line">│ Send / Sync     │ 线程安全标记                                │</span><br><span class="line">└─────────────────┴────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="派生宏-derive"><a href="#派生宏-derive" class="headerlink" title="派生宏 (derive)"></a>派生宏 (derive)</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动实现常见 trait</span></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, PartialEq, Eq, Hash, Default)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = p1.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p1);           <span class="comment">// Debug</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, p1 == p2);       <span class="comment">// PartialEq → true</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3</span> = Point::<span class="title function_ invoke__">default</span>();      <span class="comment">// Default → Point &#123; x: 0, y: 0 &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="可派生的-Trait"><a href="#可派生的-Trait" class="headerlink" title="可派生的 Trait"></a>可派生的 Trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(</span></span><br><span class="line"><span class="meta">    Debug,      // 调试输出</span></span><br><span class="line"><span class="meta">    Clone,      // 克隆</span></span><br><span class="line"><span class="meta">    Copy,       // 复制（需要 Clone）</span></span><br><span class="line"><span class="meta">    PartialEq,  // 部分相等</span></span><br><span class="line"><span class="meta">    Eq,         // 完全相等（需要 PartialEq）</span></span><br><span class="line"><span class="meta">    PartialOrd, // 部分排序</span></span><br><span class="line"><span class="meta">    Ord,        // 完全排序（需要 PartialOrd + Eq）</span></span><br><span class="line"><span class="meta">    Hash,       // 哈希（需要 Eq）</span></span><br><span class="line"><span class="meta">    Default,    // 默认值</span></span><br><span class="line"><span class="meta">)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Data</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="关联类型"><a href="#关联类型" class="headerlink" title="关联类型"></a>关联类型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用关联类型（每个实现只有一种类型）</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;  <span class="comment">// 关联类型</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    count: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">u32</span>;  <span class="comment">// 指定具体类型</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.count += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.count &lt;= <span class="number">5</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.count)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="关联类型-vs-泛型参数"><a href="#关联类型-vs-泛型参数" class="headerlink" title="关联类型 vs 泛型参数"></a>关联类型 vs 泛型参数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关联类型：一个类型只能实现一次</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型参数：一个类型可以多次实现</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">From</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String 可以实现多个 From</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;&amp;<span class="type">str</span>&gt; <span class="keyword">for</span> <span class="title class_">String</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;<span class="type">char</span>&gt; <span class="keyword">for</span> <span class="title class_">String</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;<span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;&gt; <span class="keyword">for</span> <span class="title class_">String</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="孤儿规则-Orphan-Rule"><a href="#孤儿规则-Orphan-Rule" class="headerlink" title="孤儿规则 (Orphan Rule)"></a>孤儿规则 (Orphan Rule)</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 可以：为自己的类型实现外部 trait</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Display</span> <span class="keyword">for</span> <span class="title class_">MyStruct</span> &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 可以：为外部类型实现自己的 trait</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MyTrait</span> <span class="keyword">for</span> <span class="title class_">Vec</span>&lt;<span class="type">i32</span>&gt; &#123; <span class="comment">/*...*/</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不行：为外部类型实现外部 trait</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Display</span> <span class="keyword">for</span> <span class="title class_">Vec</span>&lt;<span class="type">i32</span>&gt; &#123; <span class="comment">/*...*/</span> &#125;  <span class="comment">// 编译错误！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 绕过方式：Newtype 模式</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>(<span class="type">Vec</span>&lt;<span class="type">String</span>&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Display</span> <span class="keyword">for</span> <span class="title class_">Wrapper</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;[&#123;&#125;]&quot;</span>, <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">join</span>(<span class="string">&quot;, &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Supertraits（特征继承）"><a href="#Supertraits（特征继承）" class="headerlink" title="Supertraits（特征继承）"></a>Supertraits（特征继承）</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::Display;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OutlinePrint 要求类型必须也实现 Display</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">OutlinePrint</span>: Display &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">outline_print</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">output</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">to_string</span>();  <span class="comment">// 可以使用 Display 的方法</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = output.<span class="title function_ invoke__">len</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">4</span>));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;* &#123;&#125; *&quot;</span>, output);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="string">&quot;*&quot;</span>.<span class="title function_ invoke__">repeat</span>(len + <span class="number">4</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现时必须同时满足 Display</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123; x: <span class="type">i32</span>, y: <span class="type">i32</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Display</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">OutlinePrint</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;&#125;  <span class="comment">// 现在可以实现</span></span><br></pre></td></tr></table></figure></div>

<h2 id="完全限定语法"><a href="#完全限定语法" class="headerlink" title="完全限定语法"></a>完全限定语法</h2><p><strong>完全限定语法</strong>用于明确指定调用哪个类型或 trait 的方法&#x2F;函数，解决名称冲突问题。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Pilot</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Wizard</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Human</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Pilot</span> <span class="keyword">for</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;飞机起飞&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Wizard</span> <span class="keyword">for</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;魔法飞行&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Human</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fly</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;挥动双臂&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">person</span> = Human;</span><br><span class="line">  </span><br><span class="line">    person.<span class="title function_ invoke__">fly</span>();              <span class="comment">// 调用 Human::fly → &quot;挥动双臂&quot;</span></span><br><span class="line">    Pilot::<span class="title function_ invoke__">fly</span>(&amp;person);       <span class="comment">// 调用 Pilot::fly → &quot;飞机起飞&quot;</span></span><br><span class="line">    Wizard::<span class="title function_ invoke__">fly</span>(&amp;person);      <span class="comment">// 调用 Wizard::fly → &quot;魔法飞行&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 完全限定语法（用于关联函数）</span></span><br><span class="line">    <span class="comment">// &lt;Type as Trait&gt;::function(args)</span></span><br><span class="line">    &lt;Human <span class="keyword">as</span> Pilot&gt;::<span class="title function_ invoke__">fly</span>(&amp;person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="关联常量"><a href="#关联常量" class="headerlink" title="关联常量"></a>关联常量</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Greet</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> GREETING: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Hello&quot;</span>;  <span class="comment">// 可有默认值</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">greet</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="keyword">Self</span>::GREETING);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Japanese</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Greet</span> <span class="keyword">for</span> <span class="title class_">Japanese</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> GREETING: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;こんにちは&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="条件实现-Blanket-Implementation"><a href="#条件实现-Blanket-Implementation" class="headerlink" title="条件实现 (Blanket Implementation)"></a>条件实现 (Blanket Implementation)</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::Display;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为所有实现了 Display 的类型自动实现 ToString</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: Display&gt; <span class="built_in">ToString</span> <span class="keyword">for</span> <span class="title class_">T</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">to_string</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 条件方法实现</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Pair</span>&lt;T&gt; &#123;</span><br><span class="line">    x: T,</span><br><span class="line">    y: T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Pair&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(x: T, y: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Pair &#123; x, y &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅当 T 实现了 Display + PartialOrd 时才有 cmp_display</span></span><br><span class="line"><span class="keyword">impl</span>&lt;T: Display + <span class="built_in">PartialOrd</span>&gt; Pair&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cmp_display</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.x &gt;= <span class="keyword">self</span>.y &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;最大: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;最大: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h1><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┬──────────────┬───────────┬─────────────────────────┐</span><br><span class="line">│      类型       │   底层结构   │   有序    │        主要用途         │</span><br><span class="line">├─────────────────┼──────────────┼───────────┼─────────────────────────┤</span><br><span class="line">│ Vec&lt;T&gt;          │   动态数组   │  插入序   │ 通用序列                │</span><br><span class="line">│ VecDeque&lt;T&gt;     │   环形缓冲   │  插入序   │ 双端队列                │</span><br><span class="line">│ LinkedList&lt;T&gt;   │   双向链表   │  插入序   │ 频繁分割合并            │</span><br><span class="line">├─────────────────┼──────────────┼───────────┼─────────────────────────┤</span><br><span class="line">│ HashMap&lt;K,V&gt;    │    哈希表    │    ✗     │ 快速键值查找            │</span><br><span class="line">│ BTreeMap&lt;K,V&gt;   │    B-Tree    │  键有序   │ 有序映射/范围查询       │</span><br><span class="line">├─────────────────┼──────────────┼───────────┼─────────────────────────┤</span><br><span class="line">│ HashSet&lt;T&gt;      │    哈希表    │    ✗     │ 快速去重/集合运算       │</span><br><span class="line">│ BTreeSet&lt;T&gt;     │    B-Tree    │   有序    │ 有序集合/范围查询       │</span><br><span class="line">├─────────────────┼──────────────┼───────────┼─────────────────────────┤</span><br><span class="line">│ BinaryHeap&lt;T&gt;   │    二叉堆    │   堆序    │ 优先队列/Top K          │</span><br><span class="line">└─────────────────┴──────────────┴───────────┴─────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="序列"><a href="#序列" class="headerlink" title="序列"></a>序列</h2><h3 id="Vec"><a href="#Vec" class="headerlink" title="Vec&lt;T&gt;"></a>Vec&lt;T&gt;</h3><p><strong>动态数组</strong>，连续内存存储，最常用的集合类型。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v1</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v2</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];           <span class="comment">// 宏创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v3</span> = <span class="built_in">vec!</span>[<span class="number">0</span>; <span class="number">5</span>];                  <span class="comment">// [0, 0, 0, 0, 0]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v4</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">10</span>);      <span class="comment">// 预分配容量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增删</span></span><br><span class="line">    v2.<span class="title function_ invoke__">push</span>(<span class="number">4</span>);                           <span class="comment">// 尾部添加</span></span><br><span class="line">    v2.<span class="title function_ invoke__">pop</span>();                             <span class="comment">// 尾部弹出 → Some(4)</span></span><br><span class="line">    v2.<span class="title function_ invoke__">insert</span>(<span class="number">0</span>, <span class="number">0</span>);                      <span class="comment">// 指定位置插入</span></span><br><span class="line">    v2.<span class="title function_ invoke__">remove</span>(<span class="number">0</span>);                         <span class="comment">// 指定位置删除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">third</span> = &amp;v2[<span class="number">2</span>];                   <span class="comment">// 索引（越界 panic）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">third</span> = v2.<span class="title function_ invoke__">get</span>(<span class="number">2</span>);                <span class="comment">// 返回 Option（安全）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;v2 &#123; <span class="comment">/* 只读 */</span> &#125;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;<span class="keyword">mut</span> v2 &#123; *item += <span class="number">1</span>; &#125;   <span class="comment">// 可修改</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>push &#x2F; pop</td>
<td>O(1) 均摊</td>
</tr>
<tr>
<td>insert &#x2F; remove</td>
<td>O(n)</td>
</tr>
<tr>
<td>索引访问</td>
<td>O(1)</td>
</tr>
</tbody></table>
<hr>
<h3 id="VecDeque"><a href="#VecDeque" class="headerlink" title="VecDeque&lt;T&gt;"></a>VecDeque&lt;T&gt;</h3><p><strong>双端队列</strong>，基于环形缓冲区，两端操作高效。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::VecDeque;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">deque</span>: VecDeque&lt;<span class="type">i32</span>&gt; = VecDeque::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">deque</span> = VecDeque::<span class="title function_ invoke__">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双端操作</span></span><br><span class="line">deque.<span class="title function_ invoke__">push_front</span>(<span class="number">0</span>);                  <span class="comment">// 头部添加</span></span><br><span class="line">deque.<span class="title function_ invoke__">push_back</span>(<span class="number">4</span>);                   <span class="comment">// 尾部添加</span></span><br><span class="line">deque.<span class="title function_ invoke__">pop_front</span>();                    <span class="comment">// 头部弹出 → Some(0)</span></span><br><span class="line">deque.<span class="title function_ invoke__">pop_back</span>();                     <span class="comment">// 尾部弹出 → Some(4)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">first</span> = deque.<span class="title function_ invoke__">front</span>();            <span class="comment">// 查看头部</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">last</span> = deque.<span class="title function_ invoke__">back</span>();              <span class="comment">// 查看尾部</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">item</span> = deque.<span class="title function_ invoke__">get</span>(<span class="number">1</span>);              <span class="comment">// 索引访问</span></span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>push_front &#x2F; push_back</td>
<td>O(1) 均摊</td>
</tr>
<tr>
<td>pop_front &#x2F; pop_back</td>
<td>O(1)</td>
</tr>
<tr>
<td>索引访问</td>
<td>O(1)</td>
</tr>
</tbody></table>
<p><strong>适用场景</strong>：队列、滑动窗口、需要两端频繁操作</p>
<hr>
<h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList&lt;T&gt;"></a>LinkedList&lt;T&gt;</h3><p><strong>双向链表</strong>，非连续存储，任意位置插入删除高效。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">list</span>: LinkedList&lt;<span class="type">i32</span>&gt; = LinkedList::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">list</span> = LinkedList::<span class="title function_ invoke__">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双端操作</span></span><br><span class="line">list.<span class="title function_ invoke__">push_front</span>(<span class="number">0</span>);</span><br><span class="line">list.<span class="title function_ invoke__">push_back</span>(<span class="number">4</span>);</span><br><span class="line">list.<span class="title function_ invoke__">pop_front</span>();</span><br><span class="line">list.<span class="title function_ invoke__">pop_back</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 链表特有操作</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">other</span> = LinkedList::<span class="title function_ invoke__">from</span>([<span class="number">5</span>, <span class="number">6</span>]);</span><br><span class="line">list.<span class="title function_ invoke__">append</span>(&amp;<span class="keyword">mut</span> other);              <span class="comment">// 合并链表（O(1)）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 游标操作（nightly）</span></span><br><span class="line"><span class="comment">// let mut cursor = list.cursor_front_mut();</span></span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>push &#x2F; pop（两端）</td>
<td>O(1)</td>
</tr>
<tr>
<td>append（合并）</td>
<td>O(1)</td>
</tr>
<tr>
<td>索引访问</td>
<td>O(n) ⚠️</td>
</tr>
</tbody></table>
<h3 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┬────────────┬────────────┬──────────────┐</span><br><span class="line">│    操作      │   Vec&lt;T&gt;   │ VecDeque&lt;T&gt;│ LinkedList&lt;T&gt;│</span><br><span class="line">├──────────────┼────────────┼────────────┼──────────────┤</span><br><span class="line">│ 头部插入/删除│    O(n)    │    O(1)    │     O(1)     │</span><br><span class="line">│ 尾部插入/删除│    O(1)    │    O(1)    │     O(1)     │</span><br><span class="line">│ 中间插入/删除│    O(n)    │    O(n)    │     O(1)*    │</span><br><span class="line">│ 随机访问     │    O(1)    │    O(1)    │     O(n)     │</span><br><span class="line">│ 内存布局     │   连续     │   连续     │    分散      │</span><br><span class="line">│ 缓存友好     │    ✓✓      │     ✓      │     ✗       │</span><br><span class="line">└──────────────┴────────────┴────────────┴──────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap&lt;K, V&gt;"></a>HashMap&lt;K, V&gt;</h3><p><strong>哈希映射</strong>，基于哈希表实现，无序存储，查找极快。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span>: HashMap&lt;<span class="type">String</span>, <span class="type">i32</span>&gt; = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span> = HashMap::<span class="title function_ invoke__">from</span>([(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>), (<span class="string">&quot;b&quot;</span>, <span class="number">2</span>)]);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">map</span>: HashMap&lt;_, _&gt; = <span class="built_in">vec!</span>[(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>), (<span class="string">&quot;b&quot;</span>, <span class="number">2</span>)].<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入与更新</span></span><br><span class="line">map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>);                         <span class="comment">// 插入/覆盖</span></span><br><span class="line">map.<span class="title function_ invoke__">entry</span>(<span class="string">&quot;d&quot;</span>).<span class="title function_ invoke__">or_insert</span>(<span class="number">4</span>);                <span class="comment">// 不存在才插入</span></span><br><span class="line">map.<span class="title function_ invoke__">entry</span>(<span class="string">&quot;c&quot;</span>).<span class="title function_ invoke__">or_insert_with</span>(|| <span class="title function_ invoke__">expensive_calc</span>());  <span class="comment">// 惰性计算</span></span><br><span class="line">map.<span class="title function_ invoke__">entry</span>(<span class="string">&quot;c&quot;</span>).<span class="title function_ invoke__">and_modify</span>(|v| *v += <span class="number">10</span>);    <span class="comment">// 存在则修改</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">val</span> = map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;a&quot;</span>);                     <span class="comment">// Option&lt;&amp;V&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">val</span> = map.<span class="title function_ invoke__">get_mut</span>(<span class="string">&quot;a&quot;</span>);                 <span class="comment">// Option&lt;&amp;mut V&gt;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">val</span> = map[<span class="string">&quot;a&quot;</span>];                         <span class="comment">// 直接取值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">has</span> = map.<span class="title function_ invoke__">contains_key</span>(<span class="string">&quot;a&quot;</span>);            <span class="comment">// 判断存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">map.<span class="title function_ invoke__">remove</span>(<span class="string">&quot;a&quot;</span>);                            <span class="comment">// 删除键</span></span><br><span class="line">map.<span class="title function_ invoke__">remove_entry</span>(<span class="string">&quot;b&quot;</span>);                      <span class="comment">// 删除并返回键值对</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历（顺序不确定）</span></span><br><span class="line"><span class="title function_ invoke__">for</span> (key, val) <span class="keyword">in</span> &amp;map &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="keyword">for</span> <span class="variable">key</span> <span class="keyword">in</span> map.<span class="title function_ invoke__">keys</span>() &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> map.<span class="title function_ invoke__">values_mut</span>() &#123; *val += <span class="number">1</span>; &#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>平均复杂度</th>
<th>最差复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>插入 &#x2F; 删除</td>
<td>O(1)</td>
<td>O(n)</td>
</tr>
<tr>
<td>查找</td>
<td>O(1)</td>
<td>O(n)</td>
</tr>
<tr>
<td>遍历</td>
<td>O(n)</td>
<td>O(n)</td>
</tr>
</tbody></table>
<p><strong>键的要求</strong>：必须实现 <code>Eq + Hash</code></p>
<blockquote>
<p><strong>惰性计算</strong></p>
<p>or_insert(value)</p>
<p>────────────────────────────────────────</p>
<ol>
<li><p>先计算 value        ← 总是执行！</p>
</li>
<li><p>检查 key 是否存在</p>
</li>
<li><p>不存在 → 插入 value</p>
<p>存在   → 丢弃 value（浪费了计算）</p>
</li>
</ol>
<p>or_insert_with(|| closure)</p>
<p>────────────────────────────────────────</p>
<ol>
<li><p>检查 key 是否存在</p>
</li>
<li><p>不存在 → 执行闭包 → 插入结果</p>
<p>存在   → 什么都不做 ← 节省计算！</p>
</li>
</ol>
</blockquote>
<hr>
<h3 id="BTreeMap"><a href="#BTreeMap" class="headerlink" title="BTreeMap&lt;K, V&gt;"></a>BTreeMap&lt;K, V&gt;</h3><p><strong>B树映射</strong>，基于 B-Tree 实现，<strong>有序存储</strong>，范围查询高效。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::BTreeMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span>: BTreeMap&lt;<span class="type">String</span>, <span class="type">i32</span>&gt; = BTreeMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span> = BTreeMap::<span class="title function_ invoke__">from</span>([(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>), (<span class="string">&quot;c&quot;</span>, <span class="number">3</span>), (<span class="string">&quot;b&quot;</span>, <span class="number">2</span>)]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本操作（与 HashMap 相同）</span></span><br><span class="line">map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;d&quot;</span>, <span class="number">4</span>);</span><br><span class="line">map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">map.<span class="title function_ invoke__">remove</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">map.<span class="title function_ invoke__">entry</span>(<span class="string">&quot;e&quot;</span>).<span class="title function_ invoke__">or_insert</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有序特性</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">first</span> = map.<span class="title function_ invoke__">first_key_value</span>();          <span class="comment">// 最小键值对</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">last</span> = map.<span class="title function_ invoke__">last_key_value</span>();            <span class="comment">// 最大键值对</span></span><br><span class="line">map.<span class="title function_ invoke__">pop_first</span>();                            <span class="comment">// 弹出最小</span></span><br><span class="line">map.<span class="title function_ invoke__">pop_last</span>();                             <span class="comment">// 弹出最大</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 范围查询（独有优势）</span></span><br><span class="line"><span class="title function_ invoke__">for</span> (k, v) <span class="keyword">in</span> map.<span class="title function_ invoke__">range</span>(<span class="string">&quot;b&quot;</span>..<span class="string">&quot;d&quot;</span>) &#123;         <span class="comment">// 左闭右开</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, k, v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">for</span> (k, v) <span class="keyword">in</span> map.<span class="title function_ invoke__">range</span>(<span class="string">&quot;b&quot;</span>..=<span class="string">&quot;d&quot;</span>) &#123;        <span class="comment">// 左闭右闭</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125;&quot;</span>, k, v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历（按键升序）</span></span><br><span class="line"><span class="title function_ invoke__">for</span> (key, val) <span class="keyword">in</span> &amp;map &#123; <span class="comment">/* 有序遍历 */</span> &#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>插入 &#x2F; 删除</td>
<td>O(log n)</td>
</tr>
<tr>
<td>查找</td>
<td>O(log n)</td>
</tr>
<tr>
<td>范围查询</td>
<td>O(log n + k)*</td>
</tr>
<tr>
<td>最小&#x2F;最大</td>
<td>O(log n)</td>
</tr>
</tbody></table>
<p>*k 为范围内元素数量</p>
<p><strong>键的要求</strong>：必须实现 <code>Ord</code></p>
<hr>
<h3 id="对比总结-1"><a href="#对比总结-1" class="headerlink" title="对比总结"></a>对比总结</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────┬─────────────────┬─────────────────┐</span><br><span class="line">│      特性        │  HashMap&lt;K,V&gt;   │  BTreeMap&lt;K,V&gt;  │</span><br><span class="line">├──────────────────┼─────────────────┼─────────────────┤</span><br><span class="line">│ 底层结构         │    哈希表       │     B-Tree      │</span><br><span class="line">│ 元素顺序         │     无序        │    按键有序     │</span><br><span class="line">│ 查找复杂度       │     O(1)        │    O(log n)     │</span><br><span class="line">│ 插入复杂度       │     O(1)        │    O(log n)     │</span><br><span class="line">│ 范围查询         │      ✗         │       ✓         │</span><br><span class="line">│ 最小/最大键      │     O(n)        │    O(log n)     │</span><br><span class="line">│ 键的约束         │   Eq + Hash     │      Ord        │</span><br><span class="line">│ 内存占用         │     较大        │      较小       │</span><br><span class="line">│ 缓存友好         │      ✓         │       ✓         │</span><br><span class="line">└──────────────────┴─────────────────┴─────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>选择建议</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td>快速查找，顺序无关</td>
<td><code>HashMap</code></td>
</tr>
<tr>
<td>需要有序遍历</td>
<td><code>BTreeMap</code></td>
</tr>
<tr>
<td>范围查询（如区间统计）</td>
<td><code>BTreeMap</code></td>
</tr>
<tr>
<td>频繁取最大&#x2F;最小</td>
<td><code>BTreeMap</code></td>
</tr>
<tr>
<td>键不支持 Hash</td>
<td><code>BTreeMap</code></td>
</tr>
<tr>
<td>默认选择</td>
<td><code>HashMap</code></td>
</tr>
</tbody></table>
<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet&lt;T&gt;"></a>HashSet&lt;T&gt;</h3><p><strong>哈希集合</strong>，基于 HashMap 实现，无序存储，元素唯一，查找极快。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashSet;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">set</span>: HashSet&lt;<span class="type">i32</span>&gt; = HashSet::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">set</span> = HashSet::<span class="title function_ invoke__">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">set</span>: HashSet&lt;_&gt; = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>].<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">collect</span>();  <span class="comment">// 自动去重</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 增删</span></span><br><span class="line">set.<span class="title function_ invoke__">insert</span>(<span class="number">4</span>);                              <span class="comment">// 插入，返回 bool（是否新增）</span></span><br><span class="line">set.<span class="title function_ invoke__">remove</span>(&amp;<span class="number">2</span>);                             <span class="comment">// 删除，返回 bool</span></span><br><span class="line">set.<span class="title function_ invoke__">take</span>(&amp;<span class="number">3</span>);                               <span class="comment">// 删除并返回 Option&lt;T&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line">set.<span class="title function_ invoke__">contains</span>(&amp;<span class="number">1</span>);                           <span class="comment">// 是否存在</span></span><br><span class="line">set.<span class="title function_ invoke__">get</span>(&amp;<span class="number">1</span>);                                <span class="comment">// 获取引用 Option&lt;&amp;T&gt;</span></span><br><span class="line">set.<span class="title function_ invoke__">len</span>();                                  <span class="comment">// 元素数量</span></span><br><span class="line">set.<span class="title function_ invoke__">is_empty</span>();                             <span class="comment">// 是否为空</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历（顺序不确定）</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;set &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>集合运算</strong>（HashSet 独有优势）：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a</span>: HashSet&lt;_&gt; = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].<span class="title function_ invoke__">into</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">b</span>: HashSet&lt;_&gt; = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>].<span class="title function_ invoke__">into</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交集</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">intersection</span>: HashSet&lt;_&gt; = a.<span class="title function_ invoke__">intersection</span>(&amp;b).<span class="title function_ invoke__">collect</span>();  <span class="comment">// &#123;3, 4&#125;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">intersection</span>: HashSet&lt;_&gt; = &amp;a &amp; &amp;b;                       <span class="comment">// 运算符形式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 并集</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">union</span>: HashSet&lt;_&gt; = a.<span class="title function_ invoke__">union</span>(&amp;b).<span class="title function_ invoke__">collect</span>();                <span class="comment">// &#123;1,2,3,4,5,6&#125;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">union</span>: HashSet&lt;_&gt; = &amp;a | &amp;b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 差集</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">difference</span>: HashSet&lt;_&gt; = a.<span class="title function_ invoke__">difference</span>(&amp;b).<span class="title function_ invoke__">collect</span>();      <span class="comment">// &#123;1, 2&#125;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">difference</span>: HashSet&lt;_&gt; = &amp;a - &amp;b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对称差集（并集 - 交集）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sym_diff</span>: HashSet&lt;_&gt; = a.<span class="title function_ invoke__">symmetric_difference</span>(&amp;b).<span class="title function_ invoke__">collect</span>(); <span class="comment">// &#123;1,2,5,6&#125;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sym_diff</span>: HashSet&lt;_&gt; = &amp;a ^ &amp;b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子集/超集判断</span></span><br><span class="line">a.<span class="title function_ invoke__">is_subset</span>(&amp;b);                            <span class="comment">// a ⊆ b ?</span></span><br><span class="line">a.<span class="title function_ invoke__">is_superset</span>(&amp;b);                          <span class="comment">// a ⊇ b ?</span></span><br><span class="line">a.<span class="title function_ invoke__">is_disjoint</span>(&amp;b);                          <span class="comment">// 是否无交集</span></span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>平均复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>插入 &#x2F; 删除</td>
<td>O(1)</td>
</tr>
<tr>
<td>查找</td>
<td>O(1)</td>
</tr>
<tr>
<td>集合运算</td>
<td>O(n)</td>
</tr>
</tbody></table>
<p><strong>元素要求</strong>：必须实现 <code>Eq + Hash</code></p>
<hr>
<h3 id="BTreeSet"><a href="#BTreeSet" class="headerlink" title="BTreeSet&lt;T&gt;"></a>BTreeSet&lt;T&gt;</h3><p><strong>B树集合</strong>，基于 BTreeMap 实现，<strong>有序存储</strong>，元素唯一。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::BTreeSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">set</span> = BTreeSet::<span class="title function_ invoke__">from</span>([<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>]);  <span class="comment">// 自动去重排序</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;set: &#123;:?&#125;&quot;</span>, set);</span><br><span class="line">    <span class="comment">// 基本操作（与 HashSet 相同）</span></span><br><span class="line">    set.<span class="title function_ invoke__">insert</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;set: &#123;:?&#125;&quot;</span>, set);</span><br><span class="line">    set.<span class="title function_ invoke__">remove</span>(&amp;<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;set: &#123;:?&#125;&quot;</span>, set);</span><br><span class="line">    <span class="keyword">if</span> set.<span class="title function_ invoke__">contains</span>(&amp;<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;set contains 1&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;set does not contain 1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有序特性</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first</span> = set.<span class="title function_ invoke__">first</span>();                    <span class="comment">// 最小元素</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">last</span> = set.<span class="title function_ invoke__">last</span>();  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;first: &#123;:?&#125;, last: &#123;:?&#125;&quot;</span>, first, last);</span><br><span class="line">    set.<span class="title function_ invoke__">pop_first</span>();                            <span class="comment">// 弹出最小</span></span><br><span class="line">    set.<span class="title function_ invoke__">pop_last</span>();                             <span class="comment">// 弹出最大</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;set: &#123;:?&#125;&quot;</span>, set);</span><br><span class="line">    <span class="comment">// 范围查询（独有优势）</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> set.<span class="title function_ invoke__">range</span>(<span class="number">2</span>..<span class="number">5</span>) &#123;                  <span class="comment">// 范围遍历</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">num</span> <span class="keyword">in</span> <span class="number">0</span>..=<span class="number">5</span>  &#123;</span><br><span class="line">        set.<span class="title function_ invoke__">insert</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分割</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;set: &#123;:?&#125;&quot;</span>, set);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">high</span> = set.<span class="title function_ invoke__">split_off</span>(&amp;<span class="number">3</span>);           <span class="comment">// 分割成 [..3) 和 [3..]</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;high: &#123;:?&#125;&quot;</span>, high);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">low</span> = set;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;low: &#123;:?&#125;&quot;</span>, low);</span><br><span class="line">    <span class="comment">// 集合运算（同样支持）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = BTreeSet::<span class="title function_ invoke__">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = BTreeSet::<span class="title function_ invoke__">from</span>([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">union</span>: BTreeSet&lt;_&gt; = a.<span class="title function_ invoke__">union</span>(&amp;b).<span class="title function_ invoke__">cloned</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;union: &#123;:?&#125;&quot;</span>, union);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>插入 &#x2F; 删除</td>
<td>O(log n)</td>
</tr>
<tr>
<td>查找</td>
<td>O(log n)</td>
</tr>
<tr>
<td>最小 &#x2F; 最大</td>
<td>O(log n)</td>
</tr>
<tr>
<td>范围查询</td>
<td>O(log n + k)</td>
</tr>
</tbody></table>
<p><strong>元素要求</strong>：必须实现 <code>Ord</code></p>
<hr>
<h3 id="集合对比"><a href="#集合对比" class="headerlink" title="集合对比"></a>集合对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────┬─────────────────┬─────────────────┐</span><br><span class="line">│      特性        │   HashSet&lt;T&gt;    │   BTreeSet&lt;T&gt;   │</span><br><span class="line">├──────────────────┼─────────────────┼─────────────────┤</span><br><span class="line">│ 底层结构         │    哈希表       │     B-Tree      │</span><br><span class="line">│ 元素顺序         │     无序        │      有序       │</span><br><span class="line">│ 查找复杂度       │     O(1)        │    O(log n)     │</span><br><span class="line">│ 插入复杂度       │     O(1)        │    O(log n)     │</span><br><span class="line">│ 范围查询         │      ✗         │       ✓         │</span><br><span class="line">│ 最小/最大        │     O(n)        │    O(log n)     │</span><br><span class="line">│ 元素约束         │   Eq + Hash     │      Ord        │</span><br><span class="line">└──────────────────┴─────────────────┴─────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="BinaryHeap"><a href="#BinaryHeap" class="headerlink" title="BinaryHeap&lt;T&gt;"></a>BinaryHeap&lt;T&gt;</h3><p><strong>二叉堆</strong>，基于数组的完全二叉树，实现<strong>优先队列</strong>，默认<strong>最大堆</strong>。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::BinaryHeap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">heap</span>: BinaryHeap&lt;<span class="type">i32</span>&gt; = BinaryHeap::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">heap</span> = BinaryHeap::<span class="title function_ invoke__">from</span>([<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">5</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入堆出堆</span></span><br><span class="line">heap.<span class="title function_ invoke__">push</span>(<span class="number">9</span>);                               <span class="comment">// 添加元素</span></span><br><span class="line">heap.<span class="title function_ invoke__">pop</span>();                                 <span class="comment">// 弹出最大值 → Some(9)</span></span><br><span class="line">heap.<span class="title function_ invoke__">peek</span>();                                <span class="comment">// 查看最大值（不弹出）</span></span><br><span class="line">heap.<span class="title function_ invoke__">peek_mut</span>();                            <span class="comment">// 可修改的最大值引用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 容量操作</span></span><br><span class="line">heap.<span class="title function_ invoke__">len</span>();</span><br><span class="line">heap.<span class="title function_ invoke__">is_empty</span>();</span><br><span class="line">heap.<span class="title function_ invoke__">capacity</span>();</span><br><span class="line">heap.<span class="title function_ invoke__">reserve</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">vec</span> = heap.<span class="title function_ invoke__">into_vec</span>();                  <span class="comment">// 转为无序 Vec</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sorted</span> = heap.<span class="title function_ invoke__">into_sorted_vec</span>();        <span class="comment">// 转为升序 Vec</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历（⚠️ 顺序不保证完全有序）</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;heap &#123; <span class="comment">/* 不保证顺序 */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有序消费</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(max) = heap.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, max);                    <span class="comment">// 从大到小</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>最小堆实现</strong>：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::BinaryHeap;</span><br><span class="line"><span class="keyword">use</span> std::cmp::Reverse;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法1：使用 Reverse 包装</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">min_heap</span> = BinaryHeap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">min_heap.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Reverse</span>(<span class="number">3</span>));</span><br><span class="line">min_heap.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Reverse</span>(<span class="number">1</span>));</span><br><span class="line">min_heap.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Reverse</span>(<span class="number">4</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(<span class="title function_ invoke__">Reverse</span>(min)) = min_heap.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最小值: &#123;&#125;&quot;</span>, min);            <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法2：自定义类型实现反向 Ord</span></span><br><span class="line"><span class="meta">#[derive(Eq, PartialEq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MinInt</span>(<span class="type">i32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Ord</span> <span class="keyword">for</span> <span class="title class_">MinInt</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cmp</span>(&amp;<span class="keyword">self</span>, other: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> std::cmp::Ordering &#123;</span><br><span class="line">        other.<span class="number">0</span>.<span class="title function_ invoke__">cmp</span>(&amp;<span class="keyword">self</span>.<span class="number">0</span>)                <span class="comment">// 反向比较</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PartialOrd</span> <span class="keyword">for</span> <span class="title class_">MinInt</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">partial_cmp</span>(&amp;<span class="keyword">self</span>, other: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;std::cmp::Ordering&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">cmp</span>(other))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>经典应用</strong>：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Top K 问题：找最大的 K 个元素</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">top_k</span>(nums: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;, k: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">heap</span> = BinaryHeap::<span class="title function_ invoke__">from</span>(nums);</span><br><span class="line">    (<span class="number">0</span>..k).<span class="title function_ invoke__">filter_map</span>(|_| heap.<span class="title function_ invoke__">pop</span>()).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并 K 个有序数组</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">merge_k_sorted</span>(arrays: <span class="type">Vec</span>&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">heap</span> = BinaryHeap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// (Reverse(值), 数组索引, 元素索引)</span></span><br><span class="line">    <span class="title function_ invoke__">for</span> (i, arr) <span class="keyword">in</span> arrays.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> !arr.<span class="title function_ invoke__">is_empty</span>() &#123;</span><br><span class="line">            heap.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Reverse</span>((arr[<span class="number">0</span>], i, <span class="number">0</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(<span class="title function_ invoke__">Reverse</span>((val, arr_idx, elem_idx))) = heap.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">        result.<span class="title function_ invoke__">push</span>(val);</span><br><span class="line">        <span class="keyword">if</span> elem_idx + <span class="number">1</span> &lt; arrays[arr_idx].<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">            heap.<span class="title function_ invoke__">push</span>(<span class="title function_ invoke__">Reverse</span>((arrays[arr_idx][elem_idx + <span class="number">1</span>], arr_idx, elem_idx + <span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 任务调度（按优先级）</span></span><br><span class="line"><span class="meta">#[derive(Eq, PartialEq)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    priority: <span class="type">u32</span>,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Ord</span> <span class="keyword">for</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">cmp</span>(&amp;<span class="keyword">self</span>, other: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> std::cmp::Ordering &#123;</span><br><span class="line">        <span class="keyword">self</span>.priority.<span class="title function_ invoke__">cmp</span>(&amp;other.priority)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PartialOrd</span> <span class="keyword">for</span> <span class="title class_">Task</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">partial_cmp</span>(&amp;<span class="keyword">self</span>, other: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;std::cmp::Ordering&gt; &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.<span class="title function_ invoke__">cmp</span>(other))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tasks</span> = BinaryHeap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">tasks.<span class="title function_ invoke__">push</span>(Task &#123; priority: <span class="number">1</span>, name: <span class="string">&quot;低优先级&quot;</span>.<span class="title function_ invoke__">into</span>() &#125;);</span><br><span class="line">tasks.<span class="title function_ invoke__">push</span>(Task &#123; priority: <span class="number">10</span>, name: <span class="string">&quot;高优先级&quot;</span>.<span class="title function_ invoke__">into</span>() &#125;);</span><br><span class="line"><span class="comment">// pop 时先取出高优先级任务</span></span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>操作</th>
<th>时间复杂度</th>
</tr>
</thead>
<tbody><tr>
<td>push</td>
<td>O(log n)</td>
</tr>
<tr>
<td>pop</td>
<td>O(log n)</td>
</tr>
<tr>
<td>peek</td>
<td>O(1)</td>
</tr>
<tr>
<td>heapify (from)</td>
<td>O(n)</td>
</tr>
</tbody></table>
<p><strong>元素要求</strong>：必须实现 <code>Ord</code></p>
<h1 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h1><h2 id="一句话定义"><a href="#一句话定义" class="headerlink" title="一句话定义"></a>一句话定义</h2><blockquote>
<p><strong>生命周期 &#x3D; 引用保持有效的作用域范围</strong></p>
</blockquote>
<p>编译器用它确保：<strong>引用永远不会比它指向的数据活得更久</strong></p>
<h2 id="为什么需要生命周期？"><a href="#为什么需要生命周期？" class="headerlink" title="为什么需要生命周期？"></a>为什么需要生命周期？</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span>;                <span class="comment">// ---------+-- &#x27;a</span></span><br><span class="line">    &#123;                     <span class="comment">//          |</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;        <span class="comment">// -+-- &#x27;b  |</span></span><br><span class="line">        r = &amp;x;           <span class="comment">//  |       |  ❌ x 的生命周期 &#x27;b 比 r 的 &#x27;a 短</span></span><br><span class="line">    &#125;                     <span class="comment">// -+       |</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, r);    <span class="comment">// 悬垂引用！|</span></span><br><span class="line">&#125;                         <span class="comment">// ---------+</span></span><br></pre></td></tr></table></figure></div>

<p>编译器通过生命周期分析，<strong>在编译期阻止悬垂引用</strong>。</p>
<h2 id="生命周期注解语法"><a href="#生命周期注解语法" class="headerlink" title="生命周期注解语法"></a>生命周期注解语法</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="type">i32</span>        <span class="comment">// 普通引用</span></span><br><span class="line">&amp;<span class="symbol">&#x27;a</span> <span class="type">i32</span>     <span class="comment">// 带生命周期 &#x27;a 的引用</span></span><br><span class="line">&amp;<span class="symbol">&#x27;a</span> <span class="keyword">mut</span> <span class="type">i32</span> <span class="comment">// 带生命周期 &#x27;a 的可变引用</span></span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>注解<strong>不改变</strong>生命周期长短，只是<strong>告诉编译器</strong>多个引用之间的关系</p>
</blockquote>
<h2 id="函数中的生命周期"><a href="#函数中的生命周期" class="headerlink" title="函数中的生命周期"></a>函数中的生命周期</h2><h3 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 编译失败：返回值的生命周期是什么？</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>(x: &amp;<span class="type">str</span>, y: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123; x &#125; <span class="keyword">else</span> &#123; y &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 告诉编译器：返回值的生命周期与输入相同</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; y.<span class="title function_ invoke__">len</span>() &#123; x &#125; <span class="keyword">else</span> &#123; y &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="理解-a-的含义"><a href="#理解-a-的含义" class="headerlink" title="理解 &#39;a 的含义"></a>理解 <code>&#39;a</code> 的含义</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span></span><br><span class="line"><span class="comment">//         ↑      ↑           ↑            ↑</span></span><br><span class="line"><span class="comment">//      声明     x 至少活 &#x27;a   y 至少活 &#x27;a   返回值在 &#x27;a 内有效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际调用时，&#x27;a = x 和 y 生命周期的交集（较短者）</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x: |=================|</span><br><span class="line">y: |==========|</span><br><span class="line">&#x27;a:|==========|        ← 取交集</span><br></pre></td></tr></table></figure></div>

<h2 id="结构体中的生命周期"><a href="#结构体中的生命周期" class="headerlink" title="结构体中的生命周期"></a>结构体中的生命周期</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 结构体持有引用时必须标注生命周期</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Excerpt</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    part: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,  <span class="comment">// part 引用的数据必须比 Excerpt 实例活得久</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">novel</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Call.me.Ishmael&quot;</span>);</span><br><span class="line">    <span class="comment">//  ↑ novel 所有权开始</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">first</span> = novel.<span class="title function_ invoke__">split</span>(<span class="string">&#x27;.&#x27;</span>).<span class="title function_ invoke__">next</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="comment">//  ↑ first: &amp;str，借用 novel（不可变借用开始）</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, first);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">excerpt</span> = Excerpt &#123; part: first &#125;;</span><br><span class="line">    <span class="comment">//  ↑ excerpt.part 继承了对 novel 的借用</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, excerpt.part);</span><br><span class="line">    <span class="comment">//  ↑ 最后一次使用借用</span></span><br><span class="line">    <span class="comment">//  ↓ NLL: 借用在这里结束</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 此时可以这样做（如果 novel 是 mut）：</span></span><br><span class="line">    <span class="comment">// novel.push_str(&quot;...&quot;);  ✅ 借用已结束</span></span><br><span class="line">    </span><br><span class="line">&#125;   <span class="comment">// ← novel 被 drop，所有权结束</span></span><br></pre></td></tr></table></figure></div>

<h2 id="生命周期省略规则"><a href="#生命周期省略规则" class="headerlink" title="生命周期省略规则"></a>生命周期省略规则</h2><p>编译器自动推断的三条规则：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 规则1：每个引用参数获得独立的生命周期</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>(x: &amp;<span class="type">str</span>, y: &amp;<span class="type">str</span>)</span><br><span class="line"><span class="comment">// 推断为</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 规则2：只有一个输入生命周期，它被赋给所有输出</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>(x: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span></span><br><span class="line"><span class="comment">// 推断为</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 规则3：方法中 &amp;self 的生命周期赋给所有输出</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">bar</span>(&amp;<span class="keyword">self</span>, x: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span></span><br><span class="line">    <span class="comment">// 推断为</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">bar</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;(&amp;<span class="symbol">&#x27;a</span> <span class="keyword">self</span>, x: &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="何时必须手动标注？"><a href="#何时必须手动标注？" class="headerlink" title="何时必须手动标注？"></a>何时必须手动标注？</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 可省略：只有一个输入引用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">first_word</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 必须标注：多个输入，编译器不知道输出跟谁关联</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>(x: &amp;<span class="type">str</span>, y: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123; ... &#125;  <span class="comment">// 报错</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">longest</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123; ... &#125;  <span class="comment">// ✅</span></span><br></pre></td></tr></table></figure></div>

<h2 id="静态生命周期-static"><a href="#静态生命周期-static" class="headerlink" title="静态生命周期 &#39;static"></a>静态生命周期 <code>&#39;static</code></h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x27;static = 整个程序运行期间都有效</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span>: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;hello&quot;</span>;  <span class="comment">// 字符串字面量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 常见场景</span></span><br><span class="line"><span class="keyword">const</span> NAME: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;Rust&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> VERSION: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 不要滥用 &#x27;static 来&quot;解决&quot;生命周期问题</span></span><br></pre></td></tr></table></figure></div>

<h2 id="常见模式速查"><a href="#常见模式速查" class="headerlink" title="常见模式速查"></a>常见模式速查</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模式1：返回输入之一</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">pick</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, flag: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> flag &#123; x &#125; <span class="keyword">else</span> &#123; y &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模式2：只关联部分输入</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">first</span>&lt;<span class="symbol">&#x27;a</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, _y: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">    x  <span class="comment">// 返回值只与 x 关联</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模式3：返回新创建的数据（无需生命周期）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create</span>(x: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    x.<span class="title function_ invoke__">to_uppercase</span>()  <span class="comment">// 返回 owned 数据，不是引用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模式4：结构体 + impl</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Parser</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    input: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;a</span>&gt; Parser&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(input: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Parser &#123; input &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">parse</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span> &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.input[<span class="number">0</span>..<span class="number">5</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="生命周期子类型"><a href="#生命周期子类型" class="headerlink" title="生命周期子类型"></a>生命周期子类型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#x27;a: &#x27;b 表示 &#x27;a 至少和 &#x27;b 一样长</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>&lt;<span class="symbol">&#x27;a</span>, <span class="symbol">&#x27;b</span>&gt;(x: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, y: &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;b</span> <span class="type">str</span></span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    <span class="symbol">&#x27;a</span>: <span class="symbol">&#x27;b</span>,  <span class="comment">// &#x27;a 不短于 &#x27;b</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> x.<span class="title function_ invoke__">len</span>() &gt; <span class="number">0</span> &#123; y &#125; <span class="keyword">else</span> &#123; y &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="常见错误与修复"><a href="#常见错误与修复" class="headerlink" title="常见错误与修复"></a>常见错误与修复</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：返回局部变量的引用</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bad</span>() <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &amp;s  <span class="comment">// s 在函数结束时被释放</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 修复：返回 owned 数据</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">good</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 错误：结构体比数据活得久</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bad_struct</span>() <span class="punctuation">-&gt;</span> Excerpt &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    Excerpt &#123; part: &amp;s &#125;  <span class="comment">// s 即将被释放</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 修复：确保数据在外部</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">good_struct</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> Excerpt &#123;</span><br><span class="line">    Excerpt &#123; part: s &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="心智模型"><a href="#心智模型" class="headerlink" title="心智模型"></a>心智模型</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│  生命周期 = 编译器的&quot;借用有效期检查器&quot;         │</span><br><span class="line">├─────────────────────────────────────────────┤</span><br><span class="line">│  1. 所有引用都有生命周期（大多自动推断）        │</span><br><span class="line">│  2. 注解只是描述关系，不改变实际生命周期        │</span><br><span class="line">│  3. 目的：编译期消除悬垂引用                  │</span><br><span class="line">│  4. 遇到报错 → 思考&quot;谁应该活得更久？&quot;          │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>场景</th>
<th>是否需要标注</th>
</tr>
</thead>
<tbody><tr>
<td>函数单个引用输入输出</td>
<td>❌ 自动推断</td>
</tr>
<tr>
<td>函数多个引用输入 + 引用输出</td>
<td>✅ 需要</td>
</tr>
<tr>
<td>结构体持有引用</td>
<td>✅ 需要</td>
</tr>
<tr>
<td>返回 owned 数据</td>
<td>❌ 无需</td>
</tr>
<tr>
<td><code>&amp;&#39;static</code></td>
<td>全局&#x2F;字面量</td>
</tr>
</tbody></table>
<h1 id="包和模块"><a href="#包和模块" class="headerlink" title="包和模块"></a>包和模块</h1><h2 id="层级关系"><a href="#层级关系" class="headerlink" title="层级关系"></a>层级关系</h2><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Package（包）</span><br><span class="line">    ├── Cargo.toml（包的配置）</span><br><span class="line">    └── Crate（编译单元）</span><br><span class="line">            ├── src/main.rs（二进制 crate 根）</span><br><span class="line">            ├── src/lib.rs（库 crate 根）</span><br><span class="line">            └── Module（模块，代码组织单元）</span><br><span class="line">                    └── 函数、结构体、枚举...</span><br></pre></td></tr></table></figure></div>

<h2 id="Package（包）"><a href="#Package（包）" class="headerlink" title="Package（包）"></a>Package（包）</h2><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new my_project   <span class="comment"># 创建包</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml        <span class="comment"># 包配置（名称、依赖等）</span></span><br><span class="line">├── src/</span><br><span class="line">│   ├── main.rs       <span class="comment"># 二进制 crate（可选）</span></span><br><span class="line">│   └── lib.rs        <span class="comment"># 库 crate（可选）</span></span><br><span class="line">└── src/bin/          <span class="comment"># 多个二进制 crate（可选）</span></span><br><span class="line">    ├── tool1.rs</span><br><span class="line">    └── tool2.rs</span><br></pre></td></tr></table></figure></div>

<p><strong>规则</strong>：一个包最多 1 个库 crate，可以有多个二进制 crate</p>
<h2 id="Module（模块）"><a href="#Module（模块）" class="headerlink" title="Module（模块）"></a>Module（模块）</h2><h3 id="定义方式"><a href="#定义方式" class="headerlink" title="定义方式"></a>定义方式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式1：内联定义</span></span><br><span class="line"><span class="keyword">mod</span> math &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; a + b &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> advanced &#123;  <span class="comment">// 嵌套模块</span></span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pow</span>(base: <span class="type">i32</span>, exp: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; base.<span class="title function_ invoke__">pow</span>(exp) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：从文件加载（见后文）</span></span><br><span class="line"><span class="keyword">mod</span> utils;  <span class="comment">// 加载 utils.rs 或 utils/mod.rs</span></span><br></pre></td></tr></table></figure></div>

<h3 id="模块树"><a href="#模块树" class="headerlink" title="模块树"></a>模块树</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">mod</span> front &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> hosting &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">seat</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">mod</span> serving &#123;       <span class="comment">// 私有模块</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">serve</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成的模块树：</span></span><br><span class="line"><span class="comment">// crate (根)</span></span><br><span class="line"><span class="comment">//  └── front</span></span><br><span class="line"><span class="comment">//       ├── hosting</span></span><br><span class="line"><span class="comment">//       │    └── seat</span></span><br><span class="line"><span class="comment">//       └── serving (私有)</span></span><br><span class="line"><span class="comment">//            └── serve (私有)</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="路径与可见性"><a href="#路径与可见性" class="headerlink" title="路径与可见性"></a>路径与可见性</h2><h3 id="路径类型"><a href="#路径类型" class="headerlink" title="路径类型"></a>路径类型</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 绝对路径：从 crate 根开始</span></span><br><span class="line">crate::front::hosting::<span class="title function_ invoke__">seat</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 相对路径：从当前模块开始</span></span><br><span class="line">front::hosting::<span class="title function_ invoke__">seat</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// self：当前模块</span></span><br><span class="line">self::<span class="title function_ invoke__">some_function</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// super：父模块</span></span><br><span class="line">super::<span class="title function_ invoke__">parent_function</span>();</span><br></pre></td></tr></table></figure></div>

<h3 id="可见性规则"><a href="#可见性规则" class="headerlink" title="可见性规则"></a>可见性规则</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> outer &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> inner &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">public_fn</span>() &#123;&#125;      <span class="comment">// ✅ 外部可访问</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">private_fn</span>() &#123;&#125;         <span class="comment">// ❌ 仅 inner 内可访问</span></span><br><span class="line">      </span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">            <span class="keyword">pub</span> x: <span class="type">i32</span>,            <span class="comment">// ✅ 公开字段</span></span><br><span class="line">            y: <span class="type">i32</span>,                <span class="comment">// ❌ 私有字段</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Status</span> &#123;          <span class="comment">// 枚举变体自动公开</span></span><br><span class="line">            Active,                <span class="comment">// ✅</span></span><br><span class="line">            Inactive,              <span class="comment">// ✅</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">outer_fn</span>() &#123;</span><br><span class="line">        inner::<span class="title function_ invoke__">public_fn</span>();        <span class="comment">// ✅</span></span><br><span class="line">        inner::<span class="title function_ invoke__">private_fn</span>();       <span class="comment">// ✅ 父模块可访问子模块私有项？</span></span><br><span class="line">                                   <span class="comment">// ❌ 错！私有就是私有</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="高级可见性"><a href="#高级可见性" class="headerlink" title="高级可见性"></a>高级可见性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">crate_only</span>() &#123;&#125;      <span class="comment">// 仅当前 crate 内可见</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">super</span>) <span class="keyword">fn</span> <span class="title function_">parent_only</span>() &#123;&#125;     <span class="comment">// 仅父模块可见</span></span><br><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">in</span> crate::path) <span class="keyword">fn</span> <span class="title function_">limited</span>() &#123;&#125; <span class="comment">// 指定路径内可见</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="use-关键字"><a href="#use-关键字" class="headerlink" title="use 关键字"></a>use 关键字</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本引入</span></span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 嵌套引入</span></span><br><span class="line"><span class="keyword">use</span> std::collections::&#123;HashMap, HashSet&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Read, Write&#125;;  <span class="comment">// self = std::io</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全部引入（谨慎使用）</span></span><br><span class="line"><span class="keyword">use</span> std::collections::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重命名</span></span><br><span class="line"><span class="keyword">use</span> std::io::<span class="type">Result</span> <span class="keyword">as</span> IoResult;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重导出（pub use）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> crate::utils::helper;  <span class="comment">// 外部可通过此路径访问</span></span><br></pre></td></tr></table></figure></div>

<h3 id="惯用法"><a href="#惯用法" class="headerlink" title="惯用法"></a>惯用法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数：引入父模块</span></span><br><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line">io::<span class="title function_ invoke__">stdin</span>();  <span class="comment">// 清晰表明来源</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型：直接引入</span></span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">map</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br></pre></td></tr></table></figure></div>

<h2 id="常见模式"><a href="#常见模式" class="headerlink" title="常见模式"></a>常见模式</h2><h3 id="预导入模式"><a href="#预导入模式" class="headerlink" title="预导入模式"></a>预导入模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> prelude &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> crate::types::&#123;Error, <span class="type">Result</span>&#125;;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">use</span> crate::traits::&#123;Read, Write&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用者</span></span><br><span class="line"><span class="keyword">use</span> my_crate::prelude::*;</span><br></pre></td></tr></table></figure></div>

<h3 id="重导出简化路径"><a href="#重导出简化路径" class="headerlink" title="重导出简化路径"></a>重导出简化路径</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs（内部结构复杂）</span></span><br><span class="line"><span class="keyword">mod</span> deep &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">mod</span> nested &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Important</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在顶层重导出</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> deep::nested::Important;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外部直接使用</span></span><br><span class="line"><span class="keyword">use</span> my_crate::Important;  <span class="comment">// 而非 my_crate::deep::nested::Important</span></span><br></pre></td></tr></table></figure></div>

<h3 id="测试模块"><a href="#测试模块" class="headerlink" title="测试模块"></a>测试模块</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; a + b &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;  <span class="comment">// 引入父模块所有项</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="速查表"><a href="#速查表" class="headerlink" title="速查表"></a>速查表</h2><table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>mod x</code></td>
<td>定义&#x2F;加载模块 x</td>
</tr>
<tr>
<td><code>pub</code></td>
<td>公开可见</td>
</tr>
<tr>
<td><code>use</code></td>
<td>引入路径</td>
</tr>
<tr>
<td><code>pub use</code></td>
<td>重导出</td>
</tr>
<tr>
<td><code>crate::</code></td>
<td>绝对路径</td>
</tr>
<tr>
<td><code>self::</code></td>
<td>当前模块</td>
</tr>
<tr>
<td><code>super::</code></td>
<td>父模块</td>
</tr>
</tbody></table>
<hr>
<h2 id="心智模型-1"><a href="#心智模型-1" class="headerlink" title="心智模型"></a>心智模型</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────┐</span><br><span class="line">│                   Package                        │</span><br><span class="line">│  ┌─────────────────────────────────────────────┐ │</span><br><span class="line">│  │   Crate (lib.rs / main.rs)                  │ │</span><br><span class="line">│  │  ┌─────────────────────────────────────────┐│ │</span><br><span class="line">│  │  │  crate (根模块)                         ││ │</span><br><span class="line">│  │  │  ├── mod A (pub)                        ││ │</span><br><span class="line">│  │  │  │   ├── fn x (pub) ← crate::A::x       ││ │</span><br><span class="line">│  │  │  │   └── fn y      ← 私有               ││ │</span><br><span class="line">│  │  │  └── mod B                              ││ │</span><br><span class="line">│  │  │      └── mod C (pub)                    ││ │</span><br><span class="line">│  │  │          └── fn z ← crate::B::C::z      ││ │</span><br><span class="line">│  │  └─────────────────────────────────────────┘│ │</span><br><span class="line">│  └─────────────────────────────────────────────┘ │</span><br><span class="line">└──────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">访问规则：</span><br><span class="line">1. 默认私有，需要 pub 公开</span><br><span class="line">2. 父可访问子的公开项</span><br><span class="line">3. 子可访问父（及祖先）的所有项</span><br></pre></td></tr></table></figure></div>

<h1 id="格式化输出"><a href="#格式化输出" class="headerlink" title="格式化输出"></a>格式化输出</h1><h2 id="核心宏家族"><a href="#核心宏家族" class="headerlink" title="核心宏家族"></a>核心宏家族</h2><table>
<thead>
<tr>
<th>宏</th>
<th>用途</th>
<th>输出位置</th>
</tr>
</thead>
<tbody><tr>
<td><code>print!</code></td>
<td>输出不换行</td>
<td>stdout</td>
</tr>
<tr>
<td><code>println!</code></td>
<td>输出并换行</td>
<td>stdout</td>
</tr>
<tr>
<td><code>eprint!</code></td>
<td>错误输出不换行</td>
<td>stderr</td>
</tr>
<tr>
<td><code>eprintln!</code></td>
<td>错误输出并换行</td>
<td>stderr</td>
</tr>
<tr>
<td><code>format!</code></td>
<td>返回 <code>String</code></td>
<td>不输出</td>
</tr>
<tr>
<td><code>write!</code></td>
<td>写入 buffer</td>
<td>指定位置</td>
</tr>
</tbody></table>
<hr>
<h2 id="基础占位符"><a href="#基础占位符" class="headerlink" title="基础占位符"></a>基础占位符</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">name</span> = <span class="string">&quot;Rust&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">version</span> = <span class="number">1.75</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;&#125; - Display 格式（用户友好）</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, name);           <span class="comment">// Hello, Rust!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;:?&#125; - Debug 格式（调试用）</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);         <span class="comment">// [1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;:#?&#125; - Debug 美化格式</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:#?&#125;&quot;</span>, <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"><span class="comment">// [</span></span><br><span class="line"><span class="comment">//     1,</span></span><br><span class="line"><span class="comment">//     2,</span></span><br><span class="line"><span class="comment">//     3,</span></span><br><span class="line"><span class="comment">// ]</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="参数引用方式"><a href="#参数引用方式" class="headerlink" title="参数引用方式"></a>参数引用方式</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 顺序引用</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);        <span class="comment">// 1 + 2 = 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 位置索引</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;0&#125; vs &#123;0&#125;, &#123;1&#125; wins&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>); <span class="comment">// A vs A, B wins</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 命名参数</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;name&#125; is &#123;age&#125; years old&quot;</span>, </span><br><span class="line">         name = <span class="string">&quot;Alice&quot;</span>, </span><br><span class="line">         age = <span class="number">30</span>);                        <span class="comment">// Alice is 30 years old</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 变量捕获（Rust 1.58+）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">name</span> = <span class="string">&quot;Bob&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">age</span> = <span class="number">25</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;name&#125; is &#123;age&#125; years old&quot;</span>);     <span class="comment">// Bob is 25 years old</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="数值格式"><a href="#数值格式" class="headerlink" title="数值格式"></a>数值格式</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">num</span> = <span class="number">255</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进制转换</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;十进制: &#123;&#125;&quot;</span>, num);       <span class="comment">// 255</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;二进制: &#123;:b&#125;&quot;</span>, num);     <span class="comment">// 11111111</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;八进制: &#123;:o&#125;&quot;</span>, num);     <span class="comment">// 377</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;十六进制: &#123;:x&#125;&quot;</span>, num);   <span class="comment">// ff</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;十六进制: &#123;:X&#125;&quot;</span>, num);   <span class="comment">// FF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带前缀</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:#b&#125;&quot;</span>, num);            <span class="comment">// 0b11111111</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:#o&#125;&quot;</span>, num);            <span class="comment">// 0o377</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:#x&#125;&quot;</span>, num);            <span class="comment">// 0xff</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 指针地址</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">42</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:p&#125;&quot;</span>, &amp;x);              <span class="comment">// 0x7ffd5e8e1234</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 科学计数法</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">f</span> = <span class="number">1234.567</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:e&#125;&quot;</span>, f);               <span class="comment">// 1.234567e3</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:E&#125;&quot;</span>, f);               <span class="comment">// 1.234567E3</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="宽度与对齐"><a href="#宽度与对齐" class="headerlink" title="宽度与对齐"></a>宽度与对齐</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;Hi&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">n</span> = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 宽度指定</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:10&#125;]&quot;</span>, s);       <span class="comment">// [Hi        ]  默认左对齐（字符串）</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:10&#125;]&quot;</span>, n);       <span class="comment">// [        42]  默认右对齐（数字）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对齐方式</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:&lt;10&#125;]&quot;</span>, s);      <span class="comment">// [Hi        ]  左对齐</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:&gt;10&#125;]&quot;</span>, s);      <span class="comment">// [        Hi]  右对齐</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:^10&#125;]&quot;</span>, s);      <span class="comment">// [    Hi    ]  居中</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义填充字符</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:*&lt;10&#125;]&quot;</span>, s);     <span class="comment">// [Hi********]</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:0&gt;10&#125;]&quot;</span>, n);     <span class="comment">// [0000000042]</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:-^10&#125;]&quot;</span>, s);     <span class="comment">// [----Hi----]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态宽度</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">width</span> = <span class="number">8</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:&gt;width$&#125;]&quot;</span>, s);  <span class="comment">// [      Hi]</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;[&#123;:&gt;1$&#125;]&quot;</span>, s, width); <span class="comment">// [      Hi]</span></span><br></pre></td></tr></table></figure></div>

<h2 id="精度控制"><a href="#精度控制" class="headerlink" title="精度控制"></a>精度控制</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 浮点数精度</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">pi</span> = <span class="number">3.14159265358979</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.2&#125;&quot;</span>, pi);        <span class="comment">// 3.14</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.0&#125;&quot;</span>, pi);        <span class="comment">// 3</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.6&#125;&quot;</span>, pi);        <span class="comment">// 3.141593</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 宽度 + 精度</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:10.2&#125;&quot;</span>, pi);      <span class="comment">// &quot;      3.14&quot;</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:010.2&#125;&quot;</span>, pi);     <span class="comment">// &quot;0000003.14&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串截断</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.5&#125;&quot;</span>, s);         <span class="comment">// Hello</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态精度</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">precision</span> = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.prec$&#125;&quot;</span>, pi, prec = precision);  <span class="comment">// 3.142</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:.1$&#125;&quot;</span>, pi, precision);             <span class="comment">// 3.142</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;pi:.precision$&#125;&quot;</span>);                  <span class="comment">// 3.142</span></span><br></pre></td></tr></table></figure></div>

<h2 id="符号与特殊格式"><a href="#符号与特殊格式" class="headerlink" title="符号与特殊格式"></a>符号与特殊格式</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">pos</span> = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">neg</span> = -<span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正数显示符号</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:+&#125;&quot;</span>, pos);        <span class="comment">// +42</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:+&#125;&quot;</span>, neg);        <span class="comment">// -42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数字分隔（需 nightly 或手动）</span></span><br><span class="line"><span class="comment">// println!(&quot;&#123;:_&#125;&quot;, 1000000);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合使用</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:+010.2&#125;&quot;</span>, <span class="number">3.14</span>);  <span class="comment">// +000003.14</span></span><br><span class="line"><span class="comment">//          │││││└── 精度 2 位小数</span></span><br><span class="line"><span class="comment">//          ││││└─── 总宽度 10</span></span><br><span class="line"><span class="comment">//          │││└──── 用 0 填充</span></span><br><span class="line"><span class="comment">//          ││└───── 强制显示符号</span></span><br><span class="line"><span class="comment">//          │└────── 对齐（默认右）</span></span><br><span class="line"><span class="comment">//          └─────── 格式说明符开始</span></span><br></pre></td></tr></table></figure></div>

<h2 id="Debug-与-Display-Trait"><a href="#Debug-与-Display-Trait" class="headerlink" title="Debug 与 Display Trait"></a>Debug 与 Display Trait</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Display（用户友好输出）</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Debug（调试输出）- 通常用 derive</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point2</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = Point &#123; x: <span class="number">3</span>, y: <span class="number">4</span> &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, p);        <span class="comment">// (3, 4)      - Display</span></span><br><span class="line">    <span class="comment">// println!(&quot;&#123;:?&#125;&quot;, p);   // 需要手动实现 Debug</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = Point2 &#123; x: <span class="number">3</span>, y: <span class="number">4</span> &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, p2);     <span class="comment">// Point2 &#123; x: 3, y: 4 &#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:#?&#125;&quot;</span>, p2);    <span class="comment">// 美化输出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="自定义格式化细节"><a href="#自定义格式化细节" class="headerlink" title="自定义格式化细节"></a>自定义格式化细节</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="comment">// 可以访问格式化选项</span></span><br><span class="line">        <span class="keyword">if</span> f.<span class="title function_ invoke__">alternate</span>() &#123;  <span class="comment">// &#123;:#&#125; 被使用时</span></span><br><span class="line">            <span class="built_in">write!</span>(f, <span class="string">&quot;Point[x=&#123;&#125;, y=&#123;&#125;]&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">write!</span>(f, <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">p</span> = Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, p);    <span class="comment">// (1, 2)</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:#&#125;&quot;</span>, p);  <span class="comment">// Point[x=1, y=2]</span></span><br></pre></td></tr></table></figure></div>

<h2 id="转义与原始输出"><a href="#转义与原始输出" class="headerlink" title="转义与原始输出"></a>转义与原始输出</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转义大括号</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#123;&#125;&#125;&quot;</span>);             <span class="comment">// &#123;&#125;</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#123;&#123;&#125;&#125;&#125;&quot;</span>, <span class="number">42</span>);       <span class="comment">// &#123;42&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原始字符串</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">r&quot;C:\Users\name&quot;</span>);   <span class="comment">// C:\Users\name</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">r#&quot;She said &quot;Hi&quot;&quot;#</span>); <span class="comment">// She said &quot;Hi&quot;</span></span><br></pre></td></tr></table></figure></div>

<h1 id="注释与文档"><a href="#注释与文档" class="headerlink" title="注释与文档"></a>注释与文档</h1><h2 id="注释类型总览"><a href="#注释类型总览" class="headerlink" title="注释类型总览"></a>注释类型总览</h2><table>
<thead>
<tr>
<th>类型</th>
<th>语法</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>行注释</td>
<td><code>//</code></td>
<td>代码说明</td>
</tr>
<tr>
<td>块注释</td>
<td><code>/* */</code></td>
<td>多行代码说明</td>
</tr>
<tr>
<td>文档注释（外部）</td>
<td><code>///</code></td>
<td>为下方项生成文档</td>
</tr>
<tr>
<td>文档注释（内部）</td>
<td><code>//!</code></td>
<td>为所在项生成文档</td>
</tr>
</tbody></table>
<hr>
<h2 id="普通注释"><a href="#普通注释" class="headerlink" title="普通注释"></a>普通注释</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是行注释，延伸到行尾</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这是块注释</span></span><br><span class="line"><span class="comment">   可以跨越多行 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">1</span> <span class="comment">/* 块注释可以内联 */</span> + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 块注释</span></span><br><span class="line"><span class="comment">   <span class="comment">/* 可以嵌套 */</span></span></span><br><span class="line"><span class="comment">   这在临时注释代码块时很有用</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="文档注释"><a href="#文档注释" class="headerlink" title="文档注释"></a>文档注释</h2><h3 id="外部文档（为下方项生成文档）"><a href="#外部文档（为下方项生成文档）" class="headerlink" title="/// 外部文档（为下方项生成文档）"></a><code>///</code> 外部文档（为下方项生成文档）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算两个数的和</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// let result = my_crate::add(2, 3);</span></span><br><span class="line"><span class="comment">/// assert_eq!(result, 5);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 表示二维平面上的点</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Fields</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// * `x` - X 坐标</span></span><br><span class="line"><span class="comment">/// * `y` - Y 坐标</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> x: <span class="type">f64</span>,</span><br><span class="line">    <span class="keyword">pub</span> y: <span class="type">f64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内部文档（为所在项生成文档）"><a href="#内部文档（为所在项生成文档）" class="headerlink" title="//! 内部文档（为所在项生成文档）"></a><code>//!</code> 内部文档（为所在项生成文档）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs 顶部</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//! # My Awesome Crate</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! `my_crate` 提供了一系列实用工具函数。</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! ## 快速开始</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! ```rust</span></span><br><span class="line"><span class="comment">//! use my_crate::add;</span></span><br><span class="line"><span class="comment">//! let sum = add(1, 2);</span></span><br><span class="line"><span class="comment">//! ```</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模块内部文档</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> utils &#123;</span><br><span class="line">    <span class="comment">//! 工具函数模块</span></span><br><span class="line">    <span class="comment">//!</span></span><br><span class="line">    <span class="comment">//! 提供字符串处理、数值计算等实用功能。</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/// 将字符串转为大写</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">to_upper</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">to_uppercase</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Markdown-支持"><a href="#Markdown-支持" class="headerlink" title="Markdown 支持"></a>Markdown 支持</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// # 一级标题</span></span><br><span class="line"><span class="comment">/// ## 二级标题</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 普通段落，支持 **粗体**、*斜体*、`行内代码`。</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ## 列表</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - 无序列表项 1</span></span><br><span class="line"><span class="comment">/// - 无序列表项 2</span></span><br><span class="line"><span class="comment">///   - 嵌套项</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 1. 有序列表项 1</span></span><br><span class="line"><span class="comment">/// 2. 有序列表项 2</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ## 代码块</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// let x = 42;</span></span><br><span class="line"><span class="comment">/// println!(&quot;&#123;&#125;&quot;, x);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ## 链接</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// [Rust 官网](https://www.rust-lang.org)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ## 文档内链接</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 参见 [`HashMap`](std::collections::HashMap)</span></span><br><span class="line"><span class="comment">/// 或者 [`crate::utils::helper`]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">example</span>() &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常用文档节（Sections）"><a href="#常用文档节（Sections）" class="headerlink" title="常用文档节（Sections）"></a>常用文档节（Sections）</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 执行网络请求</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Arguments</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// * `url` - 请求的目标 URL</span></span><br><span class="line"><span class="comment">/// * `timeout` - 超时时间（秒）</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Returns</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 返回响应内容的字符串</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// # fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; &#123;</span></span><br><span class="line"><span class="comment">/// let response = my_crate::fetch(&quot;https://example.com&quot;, 30)?;</span></span><br><span class="line"><span class="comment">/// println!(&quot;&#123;&#125;&quot;, response);</span></span><br><span class="line"><span class="comment">/// # Ok(())</span></span><br><span class="line"><span class="comment">/// # &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Panics</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 当 `timeout` 为 0 时会 panic</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Errors</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - 网络不可达时返回 `NetworkError`</span></span><br><span class="line"><span class="comment">/// - URL 无效时返回 `InvalidUrlError`</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # Safety</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// （用于 unsafe 函数）说明安全使用的前提条件</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # See Also</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - [`fetch_async`] - 异步版本</span></span><br><span class="line"><span class="comment">/// - [`post`] - POST 请求</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">fetch</span>(url: &amp;<span class="type">str</span>, timeout: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="标准节名称"><a href="#标准节名称" class="headerlink" title="标准节名称"></a>标准节名称</h3><table>
<thead>
<tr>
<th>节名</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code># Examples</code></td>
<td>使用示例（<strong>可被测试</strong>）</td>
</tr>
<tr>
<td><code># Panics</code></td>
<td>何时会 panic</td>
</tr>
<tr>
<td><code># Errors</code></td>
<td>返回的错误类型及条件</td>
</tr>
<tr>
<td><code># Safety</code></td>
<td>unsafe 代码的安全条件</td>
</tr>
<tr>
<td><code># Arguments</code></td>
<td>参数说明</td>
</tr>
<tr>
<td><code># Returns</code></td>
<td>返回值说明</td>
</tr>
<tr>
<td><code># See Also</code></td>
<td>相关项引用</td>
</tr>
</tbody></table>
<hr>
<h2 id="代码块与文档测试"><a href="#代码块与文档测试" class="headerlink" title="代码块与文档测试"></a>代码块与文档测试</h2><h3 id="基本文档测试"><a href="#基本文档测试" class="headerlink" title="基本文档测试"></a>基本文档测试</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算阶乘</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// assert_eq!(my_crate::factorial(5), 120);</span></span><br><span class="line"><span class="comment">/// assert_eq!(my_crate::factorial(0), 1);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">factorial</span>(n: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    (<span class="number">1</span>..=n).<span class="title function_ invoke__">product</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span> --doc   <span class="comment"># 运行文档测试</span></span><br></pre></td></tr></table></figure></div>

<h3 id="代码块标记"><a href="#代码块标记" class="headerlink" title="代码块标记"></a>代码块标记</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ```rust</span></span><br><span class="line"><span class="comment">/// // 明确指定语言（可省略，默认 Rust）</span></span><br><span class="line"><span class="comment">/// let x = 1;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```ignore</span></span><br><span class="line"><span class="comment">/// // 不编译、不运行（语法可能无效）</span></span><br><span class="line"><span class="comment">/// this is not valid rust!</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```no_run</span></span><br><span class="line"><span class="comment">/// // 编译但不运行（如无限循环、需要网络等）</span></span><br><span class="line"><span class="comment">/// loop &#123; /* 永远运行 */ &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```compile_fail</span></span><br><span class="line"><span class="comment">/// // 预期编译失败（演示错误）</span></span><br><span class="line"><span class="comment">/// let x: i32 = &quot;string&quot;;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```should_panic</span></span><br><span class="line"><span class="comment">/// // 预期 panic</span></span><br><span class="line"><span class="comment">/// panic!(&quot;This should panic&quot;);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```text</span></span><br><span class="line"><span class="comment">/// 这是纯文本，不会被当作代码处理</span></span><br><span class="line"><span class="comment">/// 用于展示输出结果等</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">example</span>() &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="隐藏辅助代码"><a href="#隐藏辅助代码" class="headerlink" title="隐藏辅助代码"></a>隐藏辅助代码</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 读取配置文件</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// # // 以 # 开头的行在文档中隐藏，但会被编译和测试</span></span><br><span class="line"><span class="comment">/// # use std::fs;</span></span><br><span class="line"><span class="comment">/// # fn main() -&gt; Result&lt;(), std::io::Error&gt; &#123;</span></span><br><span class="line"><span class="comment">/// let config = my_crate::read_config(&quot;app.toml&quot;)?;</span></span><br><span class="line"><span class="comment">/// println!(&quot;&#123;:?&#125;&quot;, config);</span></span><br><span class="line"><span class="comment">/// # Ok(())</span></span><br><span class="line"><span class="comment">/// # &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">read_config</span>(path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;Config, std::io::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>渲染结果只显示：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">config</span> = my_crate::<span class="title function_ invoke__">read_config</span>(<span class="string">&quot;app.toml&quot;</span>)?;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, config);</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="文档链接"><a href="#文档链接" class="headerlink" title="文档链接"></a>文档链接</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 使用 [`Vec`] 存储数据</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 也可以用 [`Option`] 和 [`Result`]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 自定义类型链接：[`MyStruct`]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 指定方法：[`Vec::push`]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 完整路径：[`std::collections::HashMap`]</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// 带显示文本：[点击这里](crate::module::function)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MyStruct</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 链接到其他项</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// - 关联函数：[`String::from`]</span></span><br><span class="line"><span class="comment">/// - 方法：[`String::len`]</span></span><br><span class="line"><span class="comment">/// - 模块：[`std::collections`]</span></span><br><span class="line"><span class="comment">/// - 宏：[`println!`]</span></span><br><span class="line"><span class="comment">/// - 外部链接：[Rust Book](https://doc.rust-lang.org/book/)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">doc_links</span>() &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="属性与配置"><a href="#属性与配置" class="headerlink" title="属性与配置"></a>属性与配置</h2><h3 id="doc-属性"><a href="#doc-属性" class="headerlink" title="#[doc] 属性"></a><code>#[doc]</code> 属性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等价于 /// 文档内容</span></span><br><span class="line"><span class="meta">#[doc = <span class="string">&quot;这是文档注释&quot;</span>]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">foo</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 包含外部文件作为文档</span></span><br><span class="line"><span class="meta">#[doc = include_str!(<span class="string">&quot;../README.md&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MyLib</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 隐藏项（不在文档中显示）</span></span><br><span class="line"><span class="meta">#[doc(hidden)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">internal_use_only</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给文档添加别名（搜索时可用）</span></span><br><span class="line"><span class="meta">#[doc(alias = <span class="string">&quot;create&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[doc(alias = <span class="string">&quot;make&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Cargo-toml-文档配置"><a href="#Cargo-toml-文档配置" class="headerlink" title="Cargo.toml 文档配置"></a>Cargo.toml 文档配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_crate&quot;</span></span><br><span class="line"><span class="attr">documentation</span> = <span class="string">&quot;https://docs.rs/my_crate&quot;</span></span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package.metadata.docs.rs]</span></span><br><span class="line"><span class="attr">all-features</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">rustdoc-args</span> = [<span class="string">&quot;--cfg&quot;</span>, <span class="string">&quot;docsrs&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="生成与查看文档"><a href="#生成与查看文档" class="headerlink" title="生成与查看文档"></a>生成与查看文档</h2><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成文档</span></span><br><span class="line">cargo doc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成并打开浏览器</span></span><br><span class="line">cargo doc --open</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含私有项</span></span><br><span class="line">cargo doc --document-private-items</span><br><span class="line"></span><br><span class="line"><span class="comment"># 包含依赖的文档</span></span><br><span class="line">cargo doc --no-deps   <span class="comment"># 不包含依赖（默认包含）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行文档测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --doc</span><br></pre></td></tr></table></figure></div>

<h1 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h1><h2 id="核心概念-3"><a href="#核心概念-3" class="headerlink" title="核心概念"></a>核心概念</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">函数式编程三要素</span><br><span class="line">├── 闭包（Closure）     → 匿名函数，可捕获环境</span><br><span class="line">├── 迭代器（Iterator）  → 惰性序列处理</span><br><span class="line">└── 组合器（Combinator）→ 链式数据转换</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="闭包（Closure）"><a href="#闭包（Closure）" class="headerlink" title="闭包（Closure）"></a>闭包（Closure）</h2><h3 id="基本语法-3"><a href="#基本语法-3" class="headerlink" title="基本语法"></a>基本语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完整形式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">add</span> = |a: <span class="type">i32</span>, b: <span class="type">i32</span>| <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; a + b &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简化形式（类型推断）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">add</span> = |a, b| a + b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无参数</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">greet</span> = || <span class="built_in">println!</span>(<span class="string">&quot;Hello!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多行</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">complex</span> = |x| &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = x * <span class="number">2</span>;</span><br><span class="line">    y + <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>));  <span class="comment">// 5</span></span><br><span class="line"><span class="title function_ invoke__">greet</span>();                     <span class="comment">// Hello!</span></span><br></pre></td></tr></table></figure></div>

<h3 id="捕获环境变量"><a href="#捕获环境变量" class="headerlink" title="捕获环境变量"></a>捕获环境变量</h3><p>Rust 编译器<strong>根据闭包内如何使用变量</strong>自动决定捕获方式，选择”刚好够用”的最小权限。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">x</span> = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">y</span> = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动捕获外部变量</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sum</span> = || x + y;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">sum</span>());  <span class="comment">// 30</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 带参数 + 捕获</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">add_x</span> = |n| n + x;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add_x</span>(<span class="number">5</span>));  <span class="comment">// 15</span></span><br></pre></td></tr></table></figure></div>

<h3 id="三种捕获方式"><a href="#三种捕获方式" class="headerlink" title="三种捕获方式"></a>三种捕获方式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 不可变借用（Fn）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">print</span> = || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);  <span class="comment">// 借用 s</span></span><br><span class="line"><span class="title function_ invoke__">print</span>();</span><br><span class="line"><span class="title function_ invoke__">print</span>();  <span class="comment">// ✅ 可多次调用</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);  <span class="comment">// ✅ s 仍可用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 可变借用（FnMut）</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">count</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">inc</span> = || count += <span class="number">1</span>;  <span class="comment">// 可变借用 count</span></span><br><span class="line"><span class="title function_ invoke__">inc</span>();</span><br><span class="line"><span class="title function_ invoke__">inc</span>();</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, count);  <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 获取所有权（FnOnce）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">consume</span> = || <span class="title function_ invoke__">drop</span>(s);  <span class="comment">// 消耗 s</span></span><br><span class="line"><span class="title function_ invoke__">consume</span>();</span><br><span class="line"><span class="comment">// consume();  // ❌ 不能再次调用</span></span><br><span class="line"><span class="comment">// println!(&quot;&#123;&#125;&quot;, s);  // ❌ s 已被移动</span></span><br></pre></td></tr></table></figure></div>

<h3 id="Trait-对应关系"><a href="#Trait-对应关系" class="headerlink" title="Trait 对应关系"></a>Trait 对应关系</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────┐</span><br><span class="line">│  捕获方式        Trait       可调用次数    签名      │</span><br><span class="line">├─────────────────────────────────────────────────────┤</span><br><span class="line">│  不可变借用 &amp;T   Fn          多次         &amp;self     │</span><br><span class="line">│  可变借用 &amp;mut T FnMut       多次         &amp;mut self │</span><br><span class="line">│  所有权 T        FnOnce      一次         self      │</span><br><span class="line">├─────────────────────────────────────────────────────┤</span><br><span class="line">│  继承关系: Fn : FnMut : FnOnce                      │</span><br><span class="line">│  （实现 Fn 的自动实现 FnMut 和 FnOnce）              │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="move-关键字"><a href="#move-关键字" class="headerlink" title="move 关键字"></a>move 关键字</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 强制获取所有权</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">closure</span> = <span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line"><span class="comment">// println!(&quot;&#123;&#125;&quot;, s);  // ❌ s 已移动到闭包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 常用于线程</span></span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">data</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data);  <span class="comment">// data 所有权移入线程</span></span><br><span class="line">&#125;);</span><br><span class="line">handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br></pre></td></tr></table></figure></div>

<h3 id="闭包作为参数"><a href="#闭包作为参数" class="headerlink" title="闭包作为参数"></a>闭包作为参数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型方式（推荐）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">apply</span>&lt;F&gt;(f: F) <span class="keyword">where</span> F: <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">f</span>(<span class="number">10</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或简写</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">apply2</span>&lt;F: <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>&gt;(f: F) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">f</span>(<span class="number">10</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 impl Trait</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">apply3</span>(f: <span class="keyword">impl</span> <span class="title class_">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">f</span>(<span class="number">10</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态分发（有性能开销）（智能指针会讲）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">apply_dyn</span>(f: &amp;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">f</span>(<span class="number">10</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="title function_ invoke__">apply</span>(|x| x * <span class="number">2</span>);       <span class="comment">// 20</span></span><br><span class="line"><span class="title function_ invoke__">apply</span>(|x| x + <span class="number">5</span>);       <span class="comment">// 15</span></span><br></pre></td></tr></table></figure></div>

<h3 id="闭包作为返回值"><a href="#闭包作为返回值" class="headerlink" title="闭包作为返回值"></a>闭包作为返回值</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 必须用 impl 或 Box</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">make_adder</span>(n: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">move</span> |x| x + n  <span class="comment">// move 捕获 n</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态返回不同闭包 (智能指针会讲)</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">make_op</span>(op: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>, <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">match</span> op &#123;</span><br><span class="line">        <span class="string">&quot;add&quot;</span> =&gt; <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(|a, b| a + b),</span><br><span class="line">        <span class="string">&quot;mul&quot;</span> =&gt; <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(|a, b| a * b),</span><br><span class="line">        _ =&gt; <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(|a, _| a),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">add5</span> = <span class="title function_ invoke__">make_adder</span>(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">add5</span>(<span class="number">10</span>));  <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">mul</span> = <span class="title function_ invoke__">make_op</span>(<span class="string">&quot;mul&quot;</span>);</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="title function_ invoke__">mul</span>(<span class="number">3</span>, <span class="number">4</span>)); <span class="comment">// 12</span></span><br></pre></td></tr></table></figure></div>

<h2 id="迭代器（Iterator）"><a href="#迭代器（Iterator）" class="headerlink" title="迭代器（Iterator）"></a>迭代器（Iterator）</h2><h3 id="Iterator-Trait"><a href="#Iterator-Trait" class="headerlink" title="Iterator Trait"></a>Iterator Trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;  <span class="comment">// 关联类型</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt;;</span><br><span class="line">    <span class="comment">// ... 大量默认方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="创建迭代器"><a href="#创建迭代器" class="headerlink" title="创建迭代器"></a>创建迭代器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 三种方式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">iter1</span> = v.<span class="title function_ invoke__">iter</span>();       <span class="comment">// 不可变引用 &amp;T</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">iter2</span> = v.<span class="title function_ invoke__">iter_mut</span>();   <span class="comment">// 可变引用 &amp;mut T（需 mut v）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">iter3</span> = v.<span class="title function_ invoke__">into_iter</span>();  <span class="comment">// 获取所有权 T</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 区别</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">iter</span>() &#123; &#125;       <span class="comment">// x: &amp;i32, v 仍可用</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">into_iter</span>() &#123; &#125;  <span class="comment">// x: i32, v 被消耗</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他创建方式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">range</span> = <span class="number">0</span>..<span class="number">10</span>;                    <span class="comment">// Range</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">repeat</span> = std::iter::<span class="title function_ invoke__">repeat</span>(<span class="number">1</span>);    <span class="comment">// 无限重复</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">once</span> = std::iter::<span class="title function_ invoke__">once</span>(<span class="number">42</span>);       <span class="comment">// 单元素</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">empty</span>: std::iter::Empty&lt;<span class="type">i32</span>&gt; = std::iter::<span class="title function_ invoke__">empty</span>();</span><br></pre></td></tr></table></figure></div>

<h3 id="惰性求值"><a href="#惰性求值" class="headerlink" title="惰性求值"></a>惰性求值</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迭代器是惰性的，不消费不执行！</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">mapped</span> = v.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;mapping &#123;&#125;&quot;</span>, x);  <span class="comment">// 不会打印！</span></span><br><span class="line">        x * <span class="number">2</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有消费时才执行</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span>: <span class="type">Vec</span>&lt;_&gt; = mapped.<span class="title function_ invoke__">collect</span>();  <span class="comment">// 现在打印</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="迭代器适配器（Adapter）"><a href="#迭代器适配器（Adapter）" class="headerlink" title="迭代器适配器（Adapter）"></a>迭代器适配器（Adapter）</h2><p>适配器返回新迭代器，<strong>惰性求值</strong>：</p>
<h3 id="常用适配器"><a href="#常用适配器" class="headerlink" title="常用适配器"></a>常用适配器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// map - 转换每个元素</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x * <span class="number">2</span>);  <span class="comment">// [2, 4, 6, 8, 10, 12]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// filter - 过滤元素</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">filter</span>(|x| *x % <span class="number">2</span> == <span class="number">0</span>);  <span class="comment">// [2, 4, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// filter_map - 过滤 + 转换</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">filter_map</span>(|x| &#123;</span><br><span class="line">    <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span> &#123; <span class="title function_ invoke__">Some</span>(x * <span class="number">10</span>) &#125; <span class="keyword">else</span> &#123; <span class="literal">None</span> &#125;</span><br><span class="line">&#125;);  <span class="comment">// [20, 40, 60]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// take / skip</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">take</span>(<span class="number">3</span>);   <span class="comment">// [1, 2, 3]</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">skip</span>(<span class="number">3</span>);   <span class="comment">// [4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// take_while / skip_while</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">take_while</span>(|x| **x &lt; <span class="number">4</span>);  <span class="comment">// [1, 2, 3]</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">skip_while</span>(|x| **x &lt; <span class="number">4</span>);  <span class="comment">// [4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// enumerate - 带索引</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>();  <span class="comment">// [(0,1), (1,2), (2,3), ...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// zip - 合并两个迭代器</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> <span class="variable">b</span> = [<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>];</span><br><span class="line">a.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">zip</span>(b.<span class="title function_ invoke__">iter</span>());  <span class="comment">// [(1,&quot;a&quot;), (2,&quot;b&quot;), (3,&quot;c&quot;)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// chain - 连接迭代器</span></span><br><span class="line">a.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">chain</span>(b.<span class="title function_ invoke__">iter</span>());  <span class="comment">// [1, 2, 3, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;] (类型需相同)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// flatten - 展平嵌套</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">nested</span> = <span class="built_in">vec!</span>[<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>], <span class="built_in">vec!</span>[<span class="number">3</span>, <span class="number">4</span>]];</span><br><span class="line">nested.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">flatten</span>();  <span class="comment">// [1, 2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// flat_map - map + flatten</span></span><br><span class="line">nested.<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">flat_map</span>(|v| v.<span class="title function_ invoke__">into_iter</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// rev - 反转（需 DoubleEndedIterator）</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">rev</span>();  <span class="comment">// [6, 5, 4, 3, 2, 1]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// peekable - 可预览下一个</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">iter</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">peekable</span>();</span><br><span class="line">iter.<span class="title function_ invoke__">peek</span>();  <span class="comment">// Some(&amp;1)，不消耗</span></span><br><span class="line">iter.<span class="title function_ invoke__">next</span>();  <span class="comment">// Some(&amp;1)，消耗</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cycle - 无限循环</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">cycle</span>();  <span class="comment">// 1, 2, 3, 4, 5, 6, 1, 2, ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cloned / copied - 从引用创建值</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">cloned</span>();  <span class="comment">// 等同于 .map(|x| x.clone())</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">copied</span>();  <span class="comment">// 用于 Copy 类型</span></span><br></pre></td></tr></table></figure></div>

<h2 id="消费者（Consumer）"><a href="#消费者（Consumer）" class="headerlink" title="消费者（Consumer）"></a>消费者（Consumer）</h2><p>消费者<strong>消耗</strong>迭代器，产生最终结果：</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// collect - 收集到集合</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">doubled</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|x| x * <span class="number">2</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">set</span>: HashSet&lt;_&gt; = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line"><span class="keyword">let</span> <span class="variable">s</span>: <span class="type">String</span> = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>].<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// sum / product - 求和/积</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">total</span>: <span class="type">i32</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">sum</span>();          <span class="comment">// 15</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">product</span>: <span class="type">i32</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">product</span>();    <span class="comment">// 120</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// count - 计数</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">count</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">count</span>();             <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// fold - 折叠（最灵活）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sum</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">fold</span>(<span class="number">0</span>, |acc, x| acc + x);        <span class="comment">// 15</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">concat</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">fold</span>(<span class="type">String</span>::<span class="title function_ invoke__">new</span>(), |<span class="keyword">mut</span> acc, x| &#123;</span><br><span class="line">    acc.<span class="title function_ invoke__">push_str</span>(&amp;x.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">    acc</span><br><span class="line">&#125;);  <span class="comment">// &quot;12345&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// reduce - 类似 fold，但用第一个元素作初始值</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">max</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">copied</span>().<span class="title function_ invoke__">reduce</span>(|a, b| a.<span class="title function_ invoke__">max</span>(b));  <span class="comment">// Some(5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// for_each - 对每个元素执行操作</span></span><br><span class="line">v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">for_each</span>(|x| <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x));</span><br><span class="line"></span><br><span class="line"><span class="comment">// find / position - 查找</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">found</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">find</span>(|&amp;&amp;x| x &gt; <span class="number">3</span>);       <span class="comment">// Some(&amp;4)</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">pos</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">position</span>(|&amp;x| x == <span class="number">3</span>);     <span class="comment">// Some(2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// any / all - 存在/全部判断</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">has_even</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">any</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>);  <span class="comment">// true</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">all_pos</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">all</span>(|x| *x &gt; <span class="number">0</span>);       <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// min / max</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">min</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">min</span>();  <span class="comment">// Some(&amp;1)</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">max</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">max</span>();  <span class="comment">// Some(&amp;5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// min_by / max_by - 自定义比较</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">max_by_abs</span> = [-<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>].<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">max_by</span>(|a, b| a.<span class="title function_ invoke__">abs</span>().<span class="title function_ invoke__">cmp</span>(&amp;b.<span class="title function_ invoke__">abs</span>()));  <span class="comment">// Some(&amp;-3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// nth - 取第 n 个（消耗前面的）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">third</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">nth</span>(<span class="number">2</span>);  <span class="comment">// Some(&amp;3)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// last - 取最后一个</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">last</span> = v.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">last</span>();   <span class="comment">// Some(&amp;5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// partition - 分割</span></span><br><span class="line"><span class="keyword">let</span> (even, odd): (<span class="type">Vec</span>&lt;_&gt;, <span class="type">Vec</span>&lt;_&gt;) = v.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">partition</span>(|x| *x % <span class="number">2</span> == <span class="number">0</span>);</span><br><span class="line"><span class="comment">// even: [2, 4], odd: [1, 3, 5]</span></span><br></pre></td></tr></table></figure></div>

<h2 id="自定义迭代器"><a href="#自定义迭代器" class="headerlink" title="自定义迭代器"></a>自定义迭代器</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    current: <span class="type">u32</span>,</span><br><span class="line">    max: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(max: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Counter &#123; current: <span class="number">0</span>, max &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Iterator</span> <span class="keyword">for</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span> = <span class="type">u32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">next</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="keyword">Self</span>::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.current &lt; <span class="keyword">self</span>.max &#123;</span><br><span class="line">            <span class="keyword">self</span>.current += <span class="number">1</span>;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="keyword">self</span>.current)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">counter</span> = Counter::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span>: <span class="type">Vec</span>&lt;_&gt; = counter.<span class="title function_ invoke__">collect</span>();  <span class="comment">// [1, 2, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获得所有适配器方法！</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sum</span>: <span class="type">u32</span> = Counter::<span class="title function_ invoke__">new</span>(<span class="number">5</span>)</span><br><span class="line">    .<span class="title function_ invoke__">filter</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| x * <span class="number">10</span>)</span><br><span class="line">    .<span class="title function_ invoke__">sum</span>();  <span class="comment">// 60 (2*10 + 4*10)</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="性能：零成本抽象"><a href="#性能：零成本抽象" class="headerlink" title="性能：零成本抽象"></a>性能：零成本抽象</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这两种写法性能相同！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">sum</span>: <span class="type">i32</span> = (<span class="number">1</span>..=<span class="number">100</span>)</span><br><span class="line">    .<span class="title function_ invoke__">filter</span>(|x| x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|x| x * x)</span><br><span class="line">    .<span class="title function_ invoke__">sum</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命令式</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">sum</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> <span class="number">1</span>..=<span class="number">100</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">        sum += x * x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译器会将函数式版本优化成与命令式相同的机器码</span></span><br></pre></td></tr></table></figure></div>

<h3 id="何时迭代器更快"><a href="#何时迭代器更快" class="headerlink" title="何时迭代器更快"></a>何时迭代器更快</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迭代器可以避免边界检查</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带边界检查</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..v.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, v[i]);  <span class="comment">// 每次访问都检查边界</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无边界检查</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">x</span> <span class="keyword">in</span> &amp;v &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x);  <span class="comment">// 直接访问，更快</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见模式-1"><a href="#常见模式-1" class="headerlink" title="常见模式"></a>常见模式</h2><h3 id="错误处理收集"><a href="#错误处理收集" class="headerlink" title="错误处理收集"></a>错误处理收集</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">strings</span> = <span class="built_in">vec!</span>[<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;three&quot;</span>, <span class="string">&quot;4&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收集所有结果（遇错即停）</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span>: <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;, _&gt; = strings</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">map</span>(|s| s.parse::&lt;<span class="type">i32</span>&gt;())</span><br><span class="line">    .<span class="title function_ invoke__">collect</span>();  <span class="comment">// Err(ParseIntError)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只收集成功的</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">numbers</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = strings</span><br><span class="line">    .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">filter_map</span>(|s| s.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">ok</span>())</span><br><span class="line">    .<span class="title function_ invoke__">collect</span>();  <span class="comment">// [1, 2, 4]</span></span><br></pre></td></tr></table></figure></div>

<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">data</span> = <span class="built_in">vec!</span>[(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>), (<span class="string">&quot;b&quot;</span>, <span class="number">2</span>), (<span class="string">&quot;a&quot;</span>, <span class="number">3</span>), (<span class="string">&quot;b&quot;</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="variable">grouped</span>: HashMap&lt;&amp;<span class="type">str</span>, <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt; = data</span><br><span class="line">    .<span class="title function_ invoke__">into_iter</span>()</span><br><span class="line">    .<span class="title function_ invoke__">fold</span>(HashMap::<span class="title function_ invoke__">new</span>(), |<span class="keyword">mut</span> map, (k, v)| &#123;</span><br><span class="line">        map.<span class="title function_ invoke__">entry</span>(k).<span class="title function_ invoke__">or_default</span>().<span class="title function_ invoke__">push</span>(v);</span><br><span class="line">        map</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// &#123;&quot;a&quot;: [1, 3], &quot;b&quot;: [2, 4]&#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="窗口-块处理"><a href="#窗口-块处理" class="headerlink" title="窗口&#x2F;块处理"></a>窗口&#x2F;块处理</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">v</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// chunks - 固定大小块</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">chunk</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">chunks</span>(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, chunk);  <span class="comment">// [1,2], [3,4], [5]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// windows - 滑动窗口</span></span><br><span class="line"><span class="keyword">for</span> <span class="variable">window</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">windows</span>(<span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, window);  <span class="comment">// [1,2,3], [2,3,4], [3,4,5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h1><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        智能指针全景图                               │</span><br><span class="line">├────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                    │</span><br><span class="line">│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     │</span><br><span class="line">│   │  Box&lt;T&gt; │     │  Rc&lt;T&gt;  │     │ Arc&lt;T&gt;  │     │RefCell&lt;T&gt;│     │</span><br><span class="line">│   │ 堆分配   │     │ 引用计数 │     │原子引用  │      │内部可变  │     │</span><br><span class="line">│   │ 单一所有 │     │ 共享所有 │     │线程安全  │      │运行时借用│     │</span><br><span class="line">│   └─────────┘     └─────────┘     └─────────┘     └─────────┘     │</span><br><span class="line">│                                                                    │</span><br><span class="line">│   ┌─────────┐     ┌─────────┐     ┌─────────┐                     │</span><br><span class="line">│   │ Cell&lt;T&gt; │     │ Weak&lt;T&gt; │     │ Cow&lt;T&gt;  │                     │</span><br><span class="line">│   │Copy可变 │     │ 弱引用   │     │写时复制  │                     │</span><br><span class="line">│   └─────────┘     └─────────┘     └─────────┘                     │</span><br><span class="line">│                                                                    │</span><br><span class="line">│   智能指针 = 数据 + 元数据 + 自动行为（Deref + Drop）               │</span><br><span class="line">└────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Box-—-堆上分配"><a href="#Box-—-堆上分配" class="headerlink" title="Box&lt;T&gt; — 堆上分配"></a>Box&lt;T&gt; — 堆上分配</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Box 的简化内部实现</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Box</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,                              <span class="comment">// 支持动态大小类型 (如 dyn Trait, [T])</span></span><br><span class="line">    A: Allocator = Global,                  <span class="comment">// 分配器，默认为全局分配器</span></span><br><span class="line">&gt;(Unique&lt;T&gt;, A);</span><br><span class="line"><span class="comment">// Unique&lt;T&gt; 的定义 - 表示唯一所有权的指针</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Unique</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    pointer: NonNull&lt;T&gt;,                    <span class="comment">// 非空指针</span></span><br><span class="line">    _marker: PhantomData&lt;T&gt;,                <span class="comment">// 拥有 T 的所有权（影响 drop 检查）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NonNull&lt;T&gt; 的定义 - 非空指针</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NonNull</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    pointer: *<span class="keyword">const</span> T,                      <span class="comment">// 裸指针（但保证非空）</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Global 分配器（零大小类型）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Global</span>;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 基本用法：在堆上分配数据</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;b = &#123;&#125;&quot;</span>, b);  <span class="comment">// 自动解引用</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 递归类型（编译时大小未知）</span></span><br><span class="line">    <span class="meta">#[derive(Debug)]</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">List</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Cons</span>(<span class="type">i32</span>, <span class="type">Box</span>&lt;List&gt;),</span><br><span class="line">        Nil,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">use</span> List::&#123;Cons, Nil&#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">list</span> = <span class="title function_ invoke__">Cons</span>(<span class="number">1</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">2</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">Cons</span>(<span class="number">3</span>, <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Nil))))));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, list);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. trait 对象</span></span><br><span class="line">    <span class="keyword">trait</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Dog</span>;</span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;Woof!&quot;</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">animal</span>: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Animal&gt; = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Dog);</span><br><span class="line">    animal.<span class="title function_ invoke__">speak</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. 大数据避免栈溢出</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">large_array</span>: <span class="type">Box</span>&lt;[<span class="type">i32</span>; <span class="number">1000000</span>]&gt; = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0</span>; <span class="number">1000000</span>]);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Array length: &#123;&#125;&quot;</span>, large_array.<span class="title function_ invoke__">len</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Box-内存布局"><a href="#Box-内存布局" class="headerlink" title="Box 内存布局"></a>Box 内存布局</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">栈 (Stack)                    堆 (Heap)</span><br><span class="line">┌─────────────────┐          ┌─────────────────┐</span><br><span class="line">│ MyBox&lt;T&gt;        │          │                 │</span><br><span class="line">│ ┌─────────────┐ │          │    T (value)    │</span><br><span class="line">│ │ ptr ────────┼─┼─────────►│       42        │</span><br><span class="line">│ └─────────────┘ │          │                 │</span><br><span class="line">│ ┌─────────────┐ │          └─────────────────┘</span><br><span class="line">│ │ _marker     │ │           size = size_of::&lt;T&gt;()</span><br><span class="line">│ │ (0 bytes)   │ │</span><br><span class="line">│ └─────────────┘ │</span><br><span class="line">└─────────────────┘</span><br><span class="line">  size = 8 bytes</span><br><span class="line">  (仅一个指针)</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Rc-—-引用计数"><a href="#Rc-—-引用计数" class="headerlink" title="Rc&lt;T&gt; — 引用计数"></a>Rc&lt;T&gt; — 引用计数</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rc 的简化内部实现</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Rc</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,                              <span class="comment">// 支持动态大小类型</span></span><br><span class="line">    A: Allocator = Global,                  <span class="comment">// 分配器，默认全局</span></span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;RcInner&lt;T&gt;&gt;,               <span class="comment">// 指向堆上的 RcInner</span></span><br><span class="line">    phantom: PhantomData&lt;RcInner&lt;T&gt;&gt;,       <span class="comment">// 表示拥有 RcInner&lt;T&gt;</span></span><br><span class="line">    alloc: A,                               <span class="comment">// 分配器实例</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RcInner (也叫 RcBox) 的定义 - 堆上的实际数据</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: Cell&lt;<span class="type">usize</span>&gt;,                    <span class="comment">// 强引用计数</span></span><br><span class="line">    weak: Cell&lt;<span class="type">usize</span>&gt;,                      <span class="comment">// 弱引用计数</span></span><br><span class="line">    value: T,                               <span class="comment">// 实际存储的数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Weak 的定义</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;RcInner&lt;T&gt;&gt;,               <span class="comment">// 指向同一个 RcInner</span></span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 基本共享所有权</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Hello&quot;</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;引用计数: &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));  <span class="comment">// 1</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;a);  <span class="comment">// 增加引用计数，不是深拷贝</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;引用计数: &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));  <span class="comment">// 2</span></span><br><span class="line">  </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">c</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;a);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;引用计数: &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));  <span class="comment">// 3</span></span><br><span class="line">    &#125;  <span class="comment">// c 离开作用域</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;引用计数: &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a));  <span class="comment">// 2</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 共享图结构</span></span><br><span class="line">    <span class="meta">#[derive(Debug)]</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        value: <span class="type">i32</span>,</span><br><span class="line">        children: <span class="type">Vec</span>&lt;Rc&lt;Node&gt;&gt;,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">leaf</span> = Rc::<span class="title function_ invoke__">new</span>(Node &#123; value: <span class="number">3</span>, children: <span class="built_in">vec!</span>[] &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">branch1</span> = Rc::<span class="title function_ invoke__">new</span>(Node &#123;</span><br><span class="line">        value: <span class="number">1</span>,</span><br><span class="line">        children: <span class="built_in">vec!</span>[Rc::<span class="title function_ invoke__">clone</span>(&amp;leaf)],</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">branch2</span> = Rc::<span class="title function_ invoke__">new</span>(Node &#123;</span><br><span class="line">        value: <span class="number">2</span>,</span><br><span class="line">        children: <span class="built_in">vec!</span>[Rc::<span class="title function_ invoke__">clone</span>(&amp;leaf)],  <span class="comment">// leaf 被两个节点共享</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;leaf 引用计数: &#123;&#125;&quot;</span>, Rc::<span class="title function_ invoke__">strong_count</span>(&amp;leaf));  <span class="comment">// 3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Rc-内存布局"><a href="#Rc-内存布局" class="headerlink" title="Rc 内存布局"></a>Rc 内存布局</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">栈                        堆</span><br><span class="line">┌──────┐                 ┌─────────────────┐</span><br><span class="line">│  a   │────────────────►│  RcBox&lt;T&gt;       │</span><br><span class="line">├──────┤                 │ ┌─────────────┐ │</span><br><span class="line">│  b   │────────────────►│ │strong: 3    │ │</span><br><span class="line">├──────┤                 │ │weak:   1    │ │</span><br><span class="line">│  c   │────────────────►│ │data: &quot;Hello&quot;│ │</span><br><span class="line">└──────┘                 │ └─────────────┘ │</span><br><span class="line">                         └─────────────────┘</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Rc&lt;T&gt; 使用默认 Global 分配器时:</span><br><span class="line">栈上 (Stack)                                    堆上 (Heap)</span><br><span class="line">┌────────────────────────────────────┐         ┌────────────────────────────────┐</span><br><span class="line">│  Rc&lt;T, Global&gt;                     │         │  RcInner&lt;T&gt;                    │</span><br><span class="line">│  ┌──────────────────────────────┐  │         │  ┌──────────────────────────┐  │</span><br><span class="line">│  │  ptr: NonNull&lt;RcInner&lt;T&gt;&gt;    │  │         │  │  strong: Cell&lt;usize&gt;     │  │</span><br><span class="line">│  │    └── pointer: *const   8B  │──┼────────►│  │    value: usize     8B   │  │</span><br><span class="line">│  ├──────────────────────────────┤  │         │  ├──────────────────────────┤  │</span><br><span class="line">│  │  phantom: PhantomData    0B  │  │         │  │  weak: Cell&lt;usize&gt;       │  │</span><br><span class="line">│  ├──────────────────────────────┤  │         │  │    value: usize     8B   │  │</span><br><span class="line">│  │  alloc: Global           0B  │  │         │  ├──────────────────────────┤  │</span><br><span class="line">│  └──────────────────────────────┘  │         │  │  value: T                │  │</span><br><span class="line">├────────────────────────────────────┤         │  │    (实际数据)             │  │</span><br><span class="line">│  Total: 8 bytes                    │         │  └──────────────────────────┘  │</span><br><span class="line">└────────────────────────────────────┘         │  Total: 16 + size_of::&lt;T&gt;()    │</span><br><span class="line">                                               └────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Arc-—-原子引用计数"><a href="#Arc-—-原子引用计数" class="headerlink" title="Arc&lt;T&gt; — 原子引用计数"></a>Arc&lt;T&gt; — 原子引用计数</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Arc</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,                              <span class="comment">// 支持动态大小类型</span></span><br><span class="line">    A: Allocator = Global,                  <span class="comment">// 分配器，默认全局</span></span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,              <span class="comment">// 指向堆上的 ArcInner</span></span><br><span class="line">    phantom: PhantomData&lt;ArcInner&lt;T&gt;&gt;,      <span class="comment">// 表示拥有 ArcInner&lt;T&gt;</span></span><br><span class="line">    alloc: A,                               <span class="comment">// 分配器实例</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ArcInner 的定义 - 堆上的实际数据</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ArcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: AtomicUsize,                    <span class="comment">// 原子强引用计数 ← 关键区别！</span></span><br><span class="line">    weak: AtomicUsize,                      <span class="comment">// 原子弱引用计数</span></span><br><span class="line">    value: T,                               <span class="comment">// 实际存储的数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Weak 的定义</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;,              <span class="comment">// 指向同一个 ArcInner</span></span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 跨线程共享数据</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Arc::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data_clone</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;data);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;线程 &#123;&#125;: &#123;:?&#125;&quot;</span>, i, data_clone);</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最终引用计数: &#123;&#125;&quot;</span>, Arc::<span class="title function_ invoke__">strong_count</span>(&amp;data));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 配合 Mutex 实现可变共享</span></span><br><span class="line">    <span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;计数器: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());  <span class="comment">// 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Arc-内存布局"><a href="#Arc-内存布局" class="headerlink" title="Arc 内存布局"></a>Arc 内存布局</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Arc&lt;T&gt; 使用默认 Global 分配器时:</span><br><span class="line">栈上 (Stack)                                    堆上 (Heap)</span><br><span class="line">┌────────────────────────────────────┐         ┌────────────────────────────────┐</span><br><span class="line">│  Arc&lt;T, Global&gt;                    │         │  ArcInner&lt;T&gt;                   │</span><br><span class="line">│  ┌──────────────────────────────┐  │         │  ┌──────────────────────────┐  │</span><br><span class="line">│  │  ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;   │  │         │  │  strong: AtomicUsize     │  │</span><br><span class="line">│  │    └── pointer: *const   8B  │──┼────────►│  │    value: usize     8B   │  │</span><br><span class="line">│  ├──────────────────────────────┤  │         │  ├──────────────────────────┤  │</span><br><span class="line">│  │  phantom: PhantomData    0B  │  │         │  │  weak: AtomicUsize       │  │</span><br><span class="line">│  ├──────────────────────────────┤  │         │  │    value: usize     8B   │  │</span><br><span class="line">│  │  alloc: Global           0B  │  │         │  ├──────────────────────────┤  │</span><br><span class="line">│  └──────────────────────────────┘  │         │  │  value: T                │  │</span><br><span class="line">├────────────────────────────────────┤         │  │    (实际数据)             │  │</span><br><span class="line">│  Total: 8 bytes                    │         │  └──────────────────────────┘  │</span><br><span class="line">└────────────────────────────────────┘         │  Total: 16 + size_of::&lt;T&gt;()    │</span><br><span class="line">                                               └────────────────────────────────┘</span><br><span class="line">注: AtomicUsize 和 usize 大小相同，都是 8 bytes (64位系统)</span><br><span class="line">    原子性是通过 CPU 指令保证的，不需要额外空间</span><br><span class="line"></span><br><span class="line">Arc&lt;T, A&gt;</span><br><span class="line">    │</span><br><span class="line">    ├── ptr: NonNull&lt;ArcInner&lt;T&gt;&gt;</span><br><span class="line">    │         │</span><br><span class="line">    │         └── *const ArcInner&lt;T&gt; ─────────────────────┐</span><br><span class="line">    │                                                     │</span><br><span class="line">    ├── phantom: PhantomData&lt;ArcInner&lt;T&gt;&gt;                 │</span><br><span class="line">    │         └── 零大小，表示逻辑上拥有 ArcInner&lt;T&gt;       │</span><br><span class="line">    │                                                     │</span><br><span class="line">    └── alloc: A                                          │</span><br><span class="line">              └── 默认 Global (零大小)                     │</span><br><span class="line">                                                          ▼</span><br><span class="line">                                             ┌──────────────────────────┐</span><br><span class="line">                                             │ ArcInner&lt;T&gt; (堆上)       │</span><br><span class="line">Weak&lt;T, A&gt;                                   │                          │</span><br><span class="line">    │                                        │ strong: AtomicUsize ◄────┼── 原子操作</span><br><span class="line">    ├── ptr: NonNull&lt;ArcInner&lt;T&gt;&gt; ──────────►│ weak:   AtomicUsize ◄────┼── 原子操作</span><br><span class="line">    │                                        │ value:  T                │</span><br><span class="line">    └── alloc: A                             └──────────────────────────┘</span><br><span class="line">                        所有权与线程安全</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                         │</span><br><span class="line">│  Arc&lt;T&gt; ──────► ArcInner&lt;T&gt; ──────► T                                   │</span><br><span class="line">│    │              │                 │                                   │</span><br><span class="line">│    │              │                 └── 多线程共享只读访问 (&amp;T)          │</span><br><span class="line">│    │              │                                                     │</span><br><span class="line">│    │              └── 引用计数通过原子操作保护                            │</span><br><span class="line">│    │                                                                    │</span><br><span class="line">│    └── 可以 Send 到其他线程 (当 T: Send + Sync)                          │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  要修改 T，需要:                                                         │</span><br><span class="line">│    - Arc&lt;Mutex&lt;T&gt;&gt; 或 Arc&lt;RwLock&lt;T&gt;&gt;                                    │</span><br><span class="line">│    - Arc::make_mut (会克隆)                                             │</span><br><span class="line">│    - Arc::get_mut (需要唯一引用)                                         │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>多线程共享示例</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Thread <span class="number">1</span>                Thread <span class="number">2</span>                Thread <span class="number">3</span></span><br><span class="line">┌──────────────┐       ┌──────────────┐        ┌──────────────┐</span><br><span class="line">│ arc1: Arc    │       │ arc2: Arc    │        │ arc3: Arc    │</span><br><span class="line">│ ┌──────────┐ │       │ ┌──────────┐ │        │ ┌──────────┐ │</span><br><span class="line">│ │ ptr ─────┼─┼───┐   │ │ ptr ─────┼─┼───┐    │ │ ptr ─────┼─┼───┐</span><br><span class="line">│ └──────────┘ │   │   │ └──────────┘ │   │    │ └──────────┘ │   │</span><br><span class="line">└──────────────┘   │   └──────────────┘   │    └──────────────┘   │</span><br><span class="line">                   │                      │                       │</span><br><span class="line">                   │                      │                       │</span><br><span class="line">                   ▼                      ▼                       ▼</span><br><span class="line">              ┌─────────────────────────────────────────────────────┐</span><br><span class="line">              │              ArcInner&lt;<span class="type">i32</span>&gt;  (堆上，共享)             │</span><br><span class="line">              │  ┌───────────────────────────────────────────────┐  │</span><br><span class="line">              │  │  strong: AtomicUsize = <span class="number">3</span>                      │  │</span><br><span class="line">              │  │         ▲                                     │  │</span><br><span class="line">              │  │         │ 原子操作: fetch_add / fetch_sub     │  │</span><br><span class="line">              │  │         │ 多线程同时修改也安全                 │  │</span><br><span class="line">              │  ├───────────────────────────────────────────────┤  │</span><br><span class="line">              │  │  weak: AtomicUsize = <span class="number">1</span>                        │  │</span><br><span class="line">              │  ├───────────────────────────────────────────────┤  │</span><br><span class="line">              │  │  value: <span class="type">i32</span> = <span class="number">42</span>                              │  │</span><br><span class="line">              │  └───────────────────────────────────────────────┘  │</span><br><span class="line">              └─────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="Rc-vs-Arc-对比"><a href="#Rc-vs-Arc-对比" class="headerlink" title="Rc vs Arc 对比"></a>Rc vs Arc 对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         Rc vs Arc 内部结构对比                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  RcInner&lt;T&gt;                          ArcInner&lt;T&gt;                            │</span><br><span class="line">│  ┌─────────────────────────┐         ┌─────────────────────────┐            │</span><br><span class="line">│  │ strong: Cell&lt;usize&gt;     │         │ strong: AtomicUsize     │            │</span><br><span class="line">│  │   普通读写              │         │   原子操作              │            │</span><br><span class="line">│  │   cell.get() / set()   │         │   atomic.load() / fetch_sub()        │</span><br><span class="line">│  ├─────────────────────────┤         ├─────────────────────────┤            │</span><br><span class="line">│  │ weak: Cell&lt;usize&gt;       │         │ weak: AtomicUsize       │            │</span><br><span class="line">│  │   普通读写              │         │   原子操作              │            │</span><br><span class="line">│  ├─────────────────────────┤         ├─────────────────────────┤            │</span><br><span class="line">│  │ value: T                │         │ value: T                │            │</span><br><span class="line">│  └─────────────────────────┘         └─────────────────────────┘            │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  ❌ !Send, !Sync                     ✅ Send + Sync (当 T: Send + Sync)     │</span><br><span class="line">│  ✅ 更快 (无同步开销)                 ❌ 有原子操作开销                        │</span><br><span class="line">│  📍 单线程使用                        📍 多线程共享                           │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="RefCell-—-内部可变性"><a href="#RefCell-—-内部可变性" class="headerlink" title="RefCell&lt;T&gt; — 内部可变性"></a>RefCell&lt;T&gt; — 内部可变性</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部简化数据结构</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RefCell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    borrow: Cell&lt;BorrowFlag&gt;,               <span class="comment">// 借用状态计数器</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;debug_refcell&quot;</span>)]</span></span><br><span class="line">    borrowed_at: Cell&lt;<span class="type">Option</span>&lt;&amp;<span class="symbol">&#x27;static</span> Location&lt;<span class="symbol">&#x27;static</span>&gt;&gt;&gt;,  <span class="comment">// 调试用：借用位置</span></span><br><span class="line">    value: UnsafeCell&lt;T&gt;,                   <span class="comment">// 实际存储的值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 借用标志类型 (实际是 isize)</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">BorrowFlag</span> = <span class="type">isize</span>;</span><br><span class="line"><span class="keyword">const</span> UNUSED: BorrowFlag = <span class="number">0</span>;               <span class="comment">// 未借用</span></span><br><span class="line"><span class="keyword">const</span> WRITING: BorrowFlag = -<span class="number">1</span>;             <span class="comment">// 可变借用中 (只能有一个)</span></span><br><span class="line"><span class="comment">// 正数表示不可变借用的数量</span></span><br><span class="line"><span class="comment">// Ref&lt;T&gt; - 不可变借用的守卫</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Ref</span>&lt;<span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span> + <span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    value: NonNull&lt;T&gt;,                      <span class="comment">// 指向数据的指针</span></span><br><span class="line">    borrow: BorrowRef&lt;<span class="symbol">&#x27;b</span>&gt;,                  <span class="comment">// 借用计数的引用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BorrowRef</span>&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;,           <span class="comment">// 指向 RefCell.borrow 的引用</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RefMut&lt;T&gt; - 可变借用的守卫</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RefMut</span>&lt;<span class="symbol">&#x27;b</span>, T: ?<span class="built_in">Sized</span> + <span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    value: NonNull&lt;T&gt;,                      <span class="comment">// 指向数据的指针</span></span><br><span class="line">    borrow: BorrowRefMut&lt;<span class="symbol">&#x27;b</span>&gt;,               <span class="comment">// 可变借用计数的引用</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;debug_refcell&quot;</span>)]</span></span><br><span class="line">    marker: PhantomData&lt;&amp;<span class="symbol">&#x27;b</span> <span class="keyword">mut</span> T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BorrowRefMut</span>&lt;<span class="symbol">&#x27;b</span>&gt; &#123;</span><br><span class="line">    borrow: &amp;<span class="symbol">&#x27;b</span> Cell&lt;BorrowFlag&gt;,           <span class="comment">// 指向 RefCell.borrow 的引用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 基本用法：运行时借用检查</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = RefCell::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取可变借用</span></span><br><span class="line">    *data.<span class="title function_ invoke__">borrow_mut</span>() += <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;data = &#123;&#125;&quot;</span>, data.<span class="title function_ invoke__">borrow</span>());  <span class="comment">// 6</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 不可变结构中的可变字段</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">        data: RefCell&lt;<span class="type">Option</span>&lt;<span class="type">String</span>&gt;&gt;,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            Cache &#123; data: RefCell::<span class="title function_ invoke__">new</span>(<span class="literal">None</span>) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// &amp;self 但可以修改内部数据</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cache</span> = <span class="keyword">self</span>.data.<span class="title function_ invoke__">borrow_mut</span>();</span><br><span class="line">            <span class="keyword">if</span> cache.<span class="title function_ invoke__">is_none</span>() &#123;</span><br><span class="line">                *cache = <span class="title function_ invoke__">Some</span>(<span class="string">&quot;computed value&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            cache.<span class="title function_ invoke__">clone</span>().<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cache</span> = Cache::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, cache.<span class="title function_ invoke__">get</span>());  <span class="comment">// 计算并缓存</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, cache.<span class="title function_ invoke__">get</span>());  <span class="comment">// 直接返回缓存</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. ⚠️ 运行时借用规则检查</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = RefCell::<span class="title function_ invoke__">new</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_borrow1</span> = value.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_borrow2</span> = value.<span class="title function_ invoke__">borrow</span>();      <span class="comment">// ✅ 多个不可变借用</span></span><br><span class="line">    <span class="comment">// let _borrow3 = value.borrow_mut(); // ❌ panic! 已有不可变借用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="RefCell-借用规则"><a href="#RefCell-借用规则" class="headerlink" title="RefCell 借用规则"></a>RefCell 借用规则</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">demonstrate_refcell_rules</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cell</span> = RefCell::<span class="title function_ invoke__">new</span>(<span class="number">42</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 多个不可变借用</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">r1</span> = cell.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">r2</span> = cell.<span class="title function_ invoke__">borrow</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, r1, r2);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 单个可变借用</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">w</span> = cell.<span class="title function_ invoke__">borrow_mut</span>();</span><br><span class="line">        *w += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 不可变和可变同时存在 -&gt; panic!</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     let r = cell.borrow();</span></span><br><span class="line">    <span class="comment">//     let w = cell.borrow_mut();  // panic at runtime!</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 安全检查方法</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(r) = cell.<span class="title function_ invoke__">try_borrow</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;借用成功: &#123;&#125;&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(w) = cell.<span class="title function_ invoke__">try_borrow_mut</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;可变借用成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="RefCell-内存布局"><a href="#RefCell-内存布局" class="headerlink" title="RefCell 内存布局"></a>RefCell 内存布局</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">RefCell&lt;T&gt; 布局 (release 模式):</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│  RefCell&lt;T&gt;                                                 │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  borrow: Cell&lt;BorrowFlag&gt;                             │  │</span><br><span class="line">│  │    └── value: UnsafeCell&lt;isize&gt;                  8B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  value: UnsafeCell&lt;T&gt;                                 │  │</span><br><span class="line">│  │    └── value: T                          size_of&lt;T&gt;   │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────┘  │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  Total: 8 + size_of::&lt;T&gt;() (+ 对齐填充)                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">RefCell&lt;i32&gt; 具体布局:</span><br><span class="line">┌──────────────────────────────────────┐</span><br><span class="line">│  offset 0:  borrow: isize       8B   │  借用计数</span><br><span class="line">├──────────────────────────────────────┤</span><br><span class="line">│  offset 8:  value: i32          4B   │  实际数据</span><br><span class="line">├──────────────────────────────────────┤</span><br><span class="line">│  offset 12: padding             4B   │  对齐填充</span><br><span class="line">├──────────────────────────────────────┤</span><br><span class="line">│  Total: 16 bytes                     │</span><br><span class="line">└──────────────────────────────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<h3 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          RefCell 不是线程安全的!                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  RefCell&lt;T&gt;: !<span class="built_in">Sync</span>                                                          │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  原因: borrow 计数使用 Cell&lt;<span class="type">isize</span>&gt;，不是原子操作                              │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Thread <span class="number">1</span>                  Thread <span class="number">2</span>                                         │</span><br><span class="line">│  ─────────                 ─────────                                        │</span><br><span class="line">│  b = borrow.<span class="title function_ invoke__">get</span>()  <span class="comment">// 0                                                     │</span></span><br><span class="line">│                            b = borrow.<span class="title function_ invoke__">get</span>()  <span class="comment">// 0                           │</span></span><br><span class="line">│  borrow.<span class="title function_ invoke__">set</span>(b-<span class="number">1</span>)   <span class="comment">// -1                                                    │</span></span><br><span class="line">│                            borrow.<span class="title function_ invoke__">set</span>(b-<span class="number">1</span>)   <span class="comment">// -1  ← 两个都认为自己成功了！  │</span></span><br><span class="line">│  写入数据...                                                                 │</span><br><span class="line">│                            写入数据...       ← 数据竞争！UB！                 │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  解决方案:                                                                   │</span><br><span class="line">│    - 单线程: 使用 RefCell                                                   │</span><br><span class="line">│    - 多线程: 使用 Mutex 或 RwLock                                           │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">对比表:</span><br><span class="line">┌────────────────┬─────────────┬─────────────┬─────────────────────────────────┐</span><br><span class="line">│                │  <span class="built_in">Send</span>       │  <span class="built_in">Sync</span>       │  说明                           │</span><br><span class="line">├────────────────┼─────────────┼─────────────┼─────────────────────────────────┤</span><br><span class="line">│  Cell&lt;T&gt;       │  ✅ *       │  ❌         │  不能共享引用到其他线程          │</span><br><span class="line">├────────────────┼─────────────┼─────────────┼─────────────────────────────────┤</span><br><span class="line">│  RefCell&lt;T&gt;    │  ✅ *       │  ❌         │  不能共享引用到其他线程          │</span><br><span class="line">├────────────────┼─────────────┼─────────────┼─────────────────────────────────┤</span><br><span class="line">│  Mutex&lt;T&gt;      │  ✅ *       │  ✅ *       │  原子锁，可以跨线程共享          │</span><br><span class="line">├────────────────┼─────────────┼─────────────┼─────────────────────────────────┤</span><br><span class="line">│  RwLock&lt;T&gt;     │  ✅ *       │  ✅ *       │  原子锁，可以跨线程共享          │</span><br><span class="line">└────────────────┴─────────────┴─────────────┴─────────────────────────────────┘</span><br><span class="line">  * 当 T: <span class="built_in">Send</span> 时</span><br></pre></td></tr></table></figure></div>

<h2 id="Cell-—-Copy-类型的内部可变性"><a href="#Cell-—-Copy-类型的内部可变性" class="headerlink" title="Cell&lt;T&gt; — Copy 类型的内部可变性"></a>Cell&lt;T&gt; — Copy 类型的内部可变性</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Cell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,  <span class="comment">// 就这一个字段，没有任何额外开销</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// UnsafeCell - 内部可变性的根基</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UnsafeCell</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    value: T,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::Cell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 基本用法：适用于 Copy 类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cell</span> = Cell::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">  </span><br><span class="line">    cell.<span class="title function_ invoke__">set</span>(<span class="number">10</span>);              <span class="comment">// 设置新值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = cell.<span class="title function_ invoke__">get</span>();    <span class="comment">// 获取值的副本</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;value = &#123;&#125;&quot;</span>, value);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 计数器示例</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">        count: Cell&lt;<span class="type">u32</span>&gt;,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            Counter &#123; count: Cell::<span class="title function_ invoke__">new</span>(<span class="number">0</span>) &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">increment</span>(&amp;<span class="keyword">self</span>) &#123;  <span class="comment">// 注意：&amp;self 而非 &amp;mut self</span></span><br><span class="line">            <span class="keyword">self</span>.count.<span class="title function_ invoke__">set</span>(<span class="keyword">self</span>.count.<span class="title function_ invoke__">get</span>() + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.count.<span class="title function_ invoke__">get</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Counter::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    counter.<span class="title function_ invoke__">increment</span>();</span><br><span class="line">    counter.<span class="title function_ invoke__">increment</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count = &#123;&#125;&quot;</span>, counter.<span class="title function_ invoke__">get</span>());  <span class="comment">// 2</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. Cell vs RefCell</span></span><br><span class="line">    <span class="comment">// Cell: 更轻量，只适用于 Copy 类型，无运行时借用检查</span></span><br><span class="line">    <span class="comment">// RefCell: 适用于任何类型，有运行时借用检查开销</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Cell-vs-RefCell-对比"><a href="#Cell-vs-RefCell-对比" class="headerlink" title="Cell vs RefCell 对比"></a>Cell vs RefCell 对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Cell&lt;T&gt; 是零开销抽象！</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          Cell&lt;T&gt; 内存布局                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Cell&lt;i32&gt;:                      普通 i32:                                  │</span><br><span class="line">│  ┌───────────────────┐           ┌───────────────────┐                      │</span><br><span class="line">│  │  value: i32  4B   │    ===    │  value: i32  4B   │                      │</span><br><span class="line">│  └───────────────────┘           └───────────────────┘                      │</span><br><span class="line">│       Total: 4B                       Total: 4B                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Cell&lt;u8&gt;:                                                                  │</span><br><span class="line">│  ┌───────────────────┐                                                      │</span><br><span class="line">│  │  value: u8   1B   │           size_of::&lt;Cell&lt;T&gt;&gt;() == size_of::&lt;T&gt;()     │</span><br><span class="line">│  └───────────────────┘           align_of::&lt;Cell&lt;T&gt;&gt;() == align_of::&lt;T&gt;()   │</span><br><span class="line">│       Total: 1B                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Cell&lt;[i32; 4]&gt;:                                                            │</span><br><span class="line">│  ┌───────────────────┐                                                      │</span><br><span class="line">│  │  [i32; 4]   16B   │                                                      │</span><br><span class="line">│  └───────────────────┘                                                      │</span><br><span class="line">│       Total: 16B                                                            │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">对比 RefCell&lt;T&gt;:</span><br><span class="line">┌──────────────────────────────────────────────────────┐</span><br><span class="line">│  RefCell&lt;i32&gt;:                                       │</span><br><span class="line">│  ┌──────────────────────────────────────────────┐    │</span><br><span class="line">│  │  borrow: Cell&lt;isize&gt;                    8B   │    │  ← 额外开销！</span><br><span class="line">│  ├──────────────────────────────────────────────┤    │</span><br><span class="line">│  │  value: UnsafeCell&lt;i32&gt;                 4B   │    │</span><br><span class="line">│  ├──────────────────────────────────────────────┤    │</span><br><span class="line">│  │  padding                                4B   │    │</span><br><span class="line">│  └──────────────────────────────────────────────┘    │</span><br><span class="line">│       Total: 16B  (Cell&lt;i32&gt; 的 4 倍!)               │</span><br><span class="line">└──────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Weak-—-弱引用"><a href="#Weak-—-弱引用" class="headerlink" title="Weak&lt;T&gt; — 弱引用"></a>Weak&lt;T&gt; — 弱引用</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Weak</span>&lt;</span><br><span class="line">    T: ?<span class="built_in">Sized</span>,</span><br><span class="line">    A: Allocator = Global,</span><br><span class="line">&gt; &#123;</span><br><span class="line">    <span class="comment">// 这是 NonNull 以便在 enum 中优化大小</span></span><br><span class="line">    <span class="comment">// 但它不一定是有效指针！</span></span><br><span class="line">    <span class="comment">// Weak::new() 将其设为 usize::MAX，这样不需要堆分配</span></span><br><span class="line">    <span class="comment">// 这不会与真实指针冲突，因为 RcInner 至少有 2 字节对齐</span></span><br><span class="line">    ptr: NonNull&lt;RcInner&lt;T&gt;&gt;,</span><br><span class="line">    alloc: A,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RcInner 的定义（与 Rc 共享）</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RcInner</span>&lt;T: ?<span class="built_in">Sized</span>&gt; &#123;</span><br><span class="line">    strong: Cell&lt;<span class="type">usize</span>&gt;,    <span class="comment">// 强引用计数</span></span><br><span class="line">    weak: Cell&lt;<span class="type">usize</span>&gt;,      <span class="comment">// 弱引用计数</span></span><br><span class="line">    value: T,               <span class="comment">// 实际数据</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 特殊的&quot;空&quot;Weak 标记</span></span><br><span class="line"><span class="comment">// RcInner 的对齐至少为 2，所以 usize::MAX 永远不是有效地址</span></span><br><span class="line"><span class="keyword">const</span> WEAK_EMPTY: <span class="type">usize</span> = <span class="type">usize</span>::MAX;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 树结构：父子双向引用</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">    parent: RefCell&lt;Weak&lt;Node&gt;&gt;,      <span class="comment">// 弱引用父节点</span></span><br><span class="line">    children: RefCell&lt;<span class="type">Vec</span>&lt;Rc&lt;Node&gt;&gt;&gt;, <span class="comment">// 强引用子节点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建树结构</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">leaf</span> = Rc::<span class="title function_ invoke__">new</span>(Node &#123;</span><br><span class="line">        value: <span class="number">3</span>,</span><br><span class="line">        parent: RefCell::<span class="title function_ invoke__">new</span>(Weak::<span class="title function_ invoke__">new</span>()),</span><br><span class="line">        children: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[]),</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;leaf strong = &#123;&#125;, weak = &#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;leaf), </span><br><span class="line">             Rc::<span class="title function_ invoke__">weak_count</span>(&amp;leaf));</span><br><span class="line">  </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">branch</span> = Rc::<span class="title function_ invoke__">new</span>(Node &#123;</span><br><span class="line">            value: <span class="number">5</span>,</span><br><span class="line">            parent: RefCell::<span class="title function_ invoke__">new</span>(Weak::<span class="title function_ invoke__">new</span>()),</span><br><span class="line">            children: RefCell::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[Rc::<span class="title function_ invoke__">clone</span>(&amp;leaf)]),</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置 leaf 的父节点（弱引用）</span></span><br><span class="line">        *leaf.parent.<span class="title function_ invoke__">borrow_mut</span>() = Rc::<span class="title function_ invoke__">downgrade</span>(&amp;branch);</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;branch strong = &#123;&#125;, weak = &#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;branch), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;branch));</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 通过弱引用访问父节点</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(parent) = leaf.parent.<span class="title function_ invoke__">borrow</span>().<span class="title function_ invoke__">upgrade</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;leaf&#x27;s parent value = &#123;&#125;&quot;</span>, parent.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  <span class="comment">// branch 离开作用域被释放</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// branch 已释放，弱引用升级失败</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;leaf&#x27;s parent = &#123;:?&#125;&quot;</span>, leaf.parent.<span class="title function_ invoke__">borrow</span>().<span class="title function_ invoke__">upgrade</span>());  <span class="comment">// None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="weak-内存布局"><a href="#weak-内存布局" class="headerlink" title="weak 内存布局"></a>weak 内存布局</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Weak&lt;T&gt; 有两种状态：</span><br><span class="line">状态 <span class="number">1</span>: 空的 Weak（Weak::<span class="title function_ invoke__">new</span>() 创建）</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Weak&lt;T, Global&gt; 栈上布局                                                   │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  ptr: NonNull&lt;RcInner&lt;T&gt;&gt;                                             │  │</span><br><span class="line">│  │    └── pointer = <span class="number">0xFFFF_FFFF_FFFF_FFFF</span> (<span class="type">usize</span>::MAX)              <span class="number">8</span>B   │  │</span><br><span class="line">│  │        这是一个标记值，表示<span class="string">&quot;没有指向任何东西&quot;</span>                          │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  alloc: Global                                                   <span class="number">0</span>B   │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│  Total: <span class="number">8</span> bytes                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  堆上: 无！不需要分配任何内存                                                │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">状态 <span class="number">2</span>: 指向 RcInner 的 Weak（从 Rc::downgrade 创建）</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Weak&lt;T, Global&gt; 栈上布局                                                   │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  ptr: NonNull&lt;RcInner&lt;T&gt;&gt;                                             │  │</span><br><span class="line">│  │    └── pointer = <span class="number">0x7fff_</span>xxxx_xxxx (有效堆地址)                   <span class="number">8</span>B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  alloc: Global                                                   <span class="number">0</span>B   │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│  Total: <span class="number">8</span> bytes                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                          │                                                  │</span><br><span class="line">│                          ▼                                                  │</span><br><span class="line">│                 ┌─────────────────────────────────────┐                     │</span><br><span class="line">│                 │  RcInner&lt;T&gt; (堆上，与 Rc 共享)      │                     │</span><br><span class="line">│                 │  ┌─────────────────────────────┐    │                     │</span><br><span class="line">│                 │  │  strong: Cell&lt;<span class="type">usize</span>&gt;   <span class="number">8</span>B   │    │                     │</span><br><span class="line">│                 │  ├─────────────────────────────┤    │                     │</span><br><span class="line">│                 │  │  weak: Cell&lt;<span class="type">usize</span>&gt;     <span class="number">8</span>B   │    │                     │</span><br><span class="line">│                 │  ├─────────────────────────────┤    │                     │</span><br><span class="line">│                 │  │  value: T                   │    │  ← 可能已被 drop！  │</span><br><span class="line">│                 │  └─────────────────────────────┘    │                     │</span><br><span class="line">│                 └─────────────────────────────────────┘                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>
<hr>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          Rc 和 Weak 共享同一个 RcInner                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line"></span><br><span class="line">  Rc&lt;T&gt;                     Weak&lt;T&gt;                   Weak&lt;T&gt;</span><br><span class="line">  ┌──────────┐             ┌──────────┐             ┌──────────┐</span><br><span class="line">  │ ptr ─────┼─────┐       │ ptr ─────┼─────┐       │ ptr ─────┼─────┐</span><br><span class="line">  │ phantom  │     │       │ alloc    │     │       │ alloc    │     │</span><br><span class="line">  │ alloc    │     │       └──────────┘     │       └──────────┘     │</span><br><span class="line">  └──────────┘     │                        │                        │</span><br><span class="line">                   │                        │                        │</span><br><span class="line">                   │                        │                        │</span><br><span class="line">                   ▼                        ▼                        ▼</span><br><span class="line">              ┌──────────────────────────────────────────────────────────┐</span><br><span class="line">              │  RcInner&lt;T&gt;  (堆上)                                       │</span><br><span class="line">              │  ┌────────────────────────────────────────────────────┐  │</span><br><span class="line">              │  │  strong: Cell&lt;<span class="type">usize</span>&gt; = <span class="number">1</span>                           │  │</span><br><span class="line">              │  │          ▲                                         │  │</span><br><span class="line">              │  │          │ Rc 数量                                 │  │</span><br><span class="line">              │  ├────────────────────────────────────────────────────┤  │</span><br><span class="line">              │  │  weak: Cell&lt;<span class="type">usize</span>&gt; = <span class="number">3</span>                             │  │</span><br><span class="line">              │  │          ▲                                         │  │</span><br><span class="line">              │  │          │ Weak 数量 + <span class="number">1</span>（有 Rc 时额外 +<span class="number">1</span>）         │  │</span><br><span class="line">              │  ├────────────────────────────────────────────────────┤  │</span><br><span class="line">              │  │  value: T                                          │  │</span><br><span class="line">              │  │          ▲                                         │  │</span><br><span class="line">              │  │          │ 当 strong → <span class="number">0</span> 时被 drop                 │  │</span><br><span class="line">              │  │          │ 但 RcInner 还在（因为 Weak 存在）        │  │</span><br><span class="line">              │  └────────────────────────────────────────────────────┘  │</span><br><span class="line">              └──────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">                         当 strong = <span class="number">0</span> 且 weak = <span class="number">1</span> 时释放 RcInner</span><br><span class="line"></span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="Cow-—-写时复制"><a href="#Cow-—-写时复制" class="headerlink" title="Cow&lt;T&gt; — 写时复制"></a>Cow&lt;T&gt; — 写时复制</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cow = Clone on Write（写时复制）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Cow</span>&lt;<span class="symbol">&#x27;a</span>, B: ?<span class="built_in">Sized</span> + <span class="symbol">&#x27;a</span>&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    B: <span class="built_in">ToOwned</span>,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/// 借用的数据</span></span><br><span class="line">    <span class="title function_ invoke__">Borrowed</span>(&amp;<span class="symbol">&#x27;a</span> B),</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// 拥有的数据</span></span><br><span class="line">    <span class="title function_ invoke__">Owned</span>(&lt;B <span class="keyword">as</span> <span class="built_in">ToOwned</span>&gt;::Owned),</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ToOwned trait - 定义借用类型和拥有类型的关系</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">ToOwned</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Owned</span>: Borrow&lt;<span class="keyword">Self</span>&gt;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">to_owned</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>::Owned;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone_into</span>(&amp;<span class="keyword">self</span>, target: &amp;<span class="keyword">mut</span> <span class="keyword">Self</span>::Owned) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::borrow::Cow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 1. 基本用法</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s1</span>: Cow&lt;<span class="type">str</span>&gt; = Cow::<span class="title function_ invoke__">Borrowed</span>(<span class="string">&quot;hello&quot;</span>);  <span class="comment">// 借用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span>: Cow&lt;<span class="type">str</span>&gt; = Cow::<span class="title function_ invoke__">Owned</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;world&quot;</span>));  <span class="comment">// 拥有</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; &#123;&#125;&quot;</span>, s1, s2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 实际应用：条件修改</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">process_text</span>(text: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> Cow&lt;<span class="type">str</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> text.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;bad&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// 需要修改时才分配新内存</span></span><br><span class="line">            Cow::<span class="title function_ invoke__">Owned</span>(text.<span class="title function_ invoke__">replace</span>(<span class="string">&quot;bad&quot;</span>, <span class="string">&quot;good&quot;</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不需要修改，零成本借用</span></span><br><span class="line">            Cow::<span class="title function_ invoke__">Borrowed</span>(text)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">text1</span> = <span class="string">&quot;this is good&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">text2</span> = <span class="string">&quot;this is bad&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result1</span> = <span class="title function_ invoke__">process_text</span>(text1);  <span class="comment">// Borrowed，无分配</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result2</span> = <span class="title function_ invoke__">process_text</span>(text2);  <span class="comment">// Owned，有分配</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, result1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, result2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 转为可变时自动克隆</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cow</span>: Cow&lt;<span class="type">str</span>&gt; = Cow::<span class="title function_ invoke__">Borrowed</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// to_mut() 会在必要时克隆</span></span><br><span class="line">    cow.<span class="title function_ invoke__">to_mut</span>().<span class="title function_ invoke__">push_str</span>(<span class="string">&quot; world&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, cow);  <span class="comment">// &quot;hello world&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. 函数参数灵活性</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">print_cow</span>&lt;<span class="symbol">&#x27;a</span>&gt;(s: <span class="keyword">impl</span> <span class="title class_">Into</span>&lt;Cow&lt;<span class="symbol">&#x27;a</span>, <span class="type">str</span>&gt;&gt;) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cow</span>: Cow&lt;<span class="type">str</span>&gt; = s.<span class="title function_ invoke__">into</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, cow);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">print_cow</span>(<span class="string">&quot;borrowed str&quot;</span>);           <span class="comment">// &amp;str</span></span><br><span class="line">    <span class="title function_ invoke__">print_cow</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;owned&quot;</span>));    <span class="comment">// String</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="Cow-内存布局"><a href="#Cow-内存布局" class="headerlink" title="Cow 内存布局"></a>Cow 内存布局</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Cow::<span class="title function_ invoke__">Borrowed</span>(&amp;<span class="type">str</span>):                                                       │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  [<span class="number">0</span>..<span class="number">8</span>]   ptr: 指向字符串数据                                    <span class="number">8</span>B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  [<span class="number">8</span>..<span class="number">16</span>]  len: 字符串长度                                        <span class="number">8</span>B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  [<span class="number">16</span>..<span class="number">24</span>] marker: <span class="type">usize</span>::<span class="title function_ invoke__">MAX</span> (<span class="number">0xFFFF_FFFF_FFFF_FFFF</span>)             <span class="number">8</span>B   │  │</span><br><span class="line">│  │           ▲                                                           │  │</span><br><span class="line">│  │           └── 这个特殊值表示 <span class="string">&quot;我是 Borrowed&quot;</span>                          │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Cow::<span class="title function_ invoke__">Owned</span>(<span class="type">String</span>):                                                        │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  [<span class="number">0</span>..<span class="number">8</span>]   ptr: 指向堆上数据                                      <span class="number">8</span>B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  [<span class="number">8</span>..<span class="number">16</span>]  len: 字符串长度                                        <span class="number">8</span>B   │  │</span><br><span class="line">│  ├───────────────────────────────────────────────────────────────────────┤  │</span><br><span class="line">│  │  [<span class="number">16</span>..<span class="number">24</span>] cap: 分配的容量 (永远 &lt; <span class="type">usize</span>::MAX)                    <span class="number">8</span>B   │  │</span><br><span class="line">│  │           ▲                                                           │  │</span><br><span class="line">│  │           └── 真实的容量值，不会是 MAX                                │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line">判断逻辑:</span><br><span class="line">┌────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                │</span><br><span class="line">│   <span class="keyword">fn</span> <span class="title function_">is_borrowed</span>(cow: &amp;Cow&lt;<span class="type">str</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;                     │</span><br><span class="line">│       <span class="comment">// 伪代码，展示内部判断逻辑                               │</span></span><br><span class="line">│       cow.cap_or_marker == <span class="type">usize</span>::MAX                          │</span><br><span class="line">│   &#125;                                                            │</span><br><span class="line">│                                                                │</span><br><span class="line">│   <span class="keyword">if</span> cap_or_marker == <span class="type">usize</span>::MAX &#123;                             │</span><br><span class="line">│       <span class="comment">// 是 Borrowed，ptr 和 len 构成 &amp;str                      │</span></span><br><span class="line">│   &#125; <span class="keyword">else</span> &#123;                                                     │</span><br><span class="line">│       <span class="comment">// 是 Owned，ptr, len, cap 构成 String                    │</span></span><br><span class="line">│   &#125;                                                            │</span><br><span class="line">│                                                                │</span><br><span class="line">└────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="引用计数与数据释放"><a href="#引用计数与数据释放" class="headerlink" title="引用计数与数据释放"></a>引用计数与数据释放</h2><h3 id="Rust-中用到引用计数的类型"><a href="#Rust-中用到引用计数的类型" class="headerlink" title="Rust 中用到引用计数的类型"></a>Rust 中用到引用计数的类型</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Rust 引用计数类型                                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │  类型              │  模块              │  适用场景                 │   │</span><br><span class="line">│   ├─────────────────────────────────────────────────────────────────────┤   │</span><br><span class="line">│   │  Rc&lt;T&gt;             │  std::rc           │  单线程共享所有权         │   │</span><br><span class="line">│   │  Weak&lt;T&gt;           │  std::rc           │  Rc 的弱引用              │   │</span><br><span class="line">│   ├─────────────────────────────────────────────────────────────────────┤   │</span><br><span class="line">│   │  Arc&lt;T&gt;            │  std::sync         │  多线程共享所有权         │   │</span><br><span class="line">│   │  Weak&lt;T&gt;           │  std::sync         │  Arc 的弱引用             │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   Rc = Reference Counted                                                    │</span><br><span class="line">│   Arc = Atomically Reference Counted                                        │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="内存布局-4"><a href="#内存布局-4" class="headerlink" title="内存布局"></a>内存布局</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Rc&lt;T&gt; / Arc&lt;T&gt; 内存结构                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   栈上                        堆上                                          │</span><br><span class="line">│   ┌─────────┐                ┌──────────────────────────────┐               │</span><br><span class="line">│   │ Rc&lt;T&gt;   │                │         RcBox&lt;T&gt;             │               │</span><br><span class="line">│   │         │                ├──────────────────────────────┤               │</span><br><span class="line">│   │  ptr ───┼───────────────►│  strong: Cell&lt;usize&gt;         │ ← 强引用计数  │</span><br><span class="line">│   │         │                │  weak:   Cell&lt;usize&gt;         │ ← 弱引用计数  │</span><br><span class="line">│   └─────────┘                ├──────────────────────────────┤               │</span><br><span class="line">│                              │                              │               │</span><br><span class="line">│   ┌─────────┐                │          value: T            │ ← 实际数据    │</span><br><span class="line">│   │ Weak&lt;T&gt; │                │                              │               │</span><br><span class="line">│   │         │                │                              │               │</span><br><span class="line">│   │  ptr ───┼───────────────►└──────────────────────────────┘               │</span><br><span class="line">│   │         │                                                               │</span><br><span class="line">│   └─────────┘                                                               │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   Arc&lt;T&gt; 结构相同，但计数器使用 AtomicUsize（原子操作）                      │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="计数变化规则"><a href="#计数变化规则" class="headerlink" title="计数变化规则"></a>计数变化规则</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="comment">// 创建：strong=1, weak=0</span></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;创建后: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a));</span><br><span class="line">    <span class="comment">// 输出: strong=1, weak=0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="comment">// Rc::clone(): strong += 1</span></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;a);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;clone 两次: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a));</span><br><span class="line">    <span class="comment">// 输出: strong=3, weak=0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="comment">// Rc::downgrade(): weak += 1</span></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">w1</span>: Weak&lt;<span class="type">String</span>&gt; = Rc::<span class="title function_ invoke__">downgrade</span>(&amp;a);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">w2</span>: Weak&lt;<span class="type">String</span>&gt; = Rc::<span class="title function_ invoke__">downgrade</span>(&amp;a);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;downgrade 两次: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a));</span><br><span class="line">    <span class="comment">// 输出: strong=3, weak=2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="comment">// drop(Rc): strong -= 1</span></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(b);</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(c);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;drop 两个 Rc: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a));</span><br><span class="line">    <span class="comment">// 输出: strong=1, weak=2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="comment">// drop(Weak): weak -= 1</span></span><br><span class="line">    <span class="comment">// ═══════════════════════════════════════════════════</span></span><br><span class="line">    <span class="title function_ invoke__">drop</span>(w1);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;drop 一个 Weak: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">             Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a));</span><br><span class="line">    <span class="comment">// 输出: strong=1, weak=1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="释放时机"><a href="#释放时机" class="headerlink" title="释放时机"></a>释放时机</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          数据释放时机                                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │                                                                     │   │</span><br><span class="line">│   │   strong_count → 0  ══════►  value: T 被 drop（析构函数执行）       │   │</span><br><span class="line">│   │                                                                     │   │</span><br><span class="line">│   │   weak_count → 0    ══════►  整个控制块被释放（需 strong 也为 0）   │   │</span><br><span class="line">│   │                                                                     │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   状态流转:                                                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│     s&gt;0, w≥0          s=0, w&gt;0            s=0, w=0                          │</span><br><span class="line">│   ┌──────────┐      ┌──────────┐        ┌──────────┐                        │</span><br><span class="line">│   │ 数据存活 │ ───► │ 数据已释放│ ───►  │ 全部释放 │                        │</span><br><span class="line">│   │ 控制块在 │      │ 控制块在  │        │          │                        │</span><br><span class="line">│   └──────────┘      └──────────┘        └──────────┘                        │</span><br><span class="line">│       │                  │                                                  │</span><br><span class="line">│       │                  └── Weak.upgrade() 返回 None                       │</span><br><span class="line">│       └── 可正常访问数据                                                     │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="释放过程演示"><a href="#释放过程演示" class="headerlink" title="释放过程演示"></a>释放过程演示</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Data</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;  💥 Data(&#123;&#125;) 被析构&quot;</span>, <span class="keyword">self</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">weak</span>: Weak&lt;Data&gt;;</span><br><span class="line">  </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">rc1</span> = Rc::<span class="title function_ invoke__">new</span>(Data &#123; value: <span class="number">42</span> &#125;);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">rc2</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;rc1);</span><br><span class="line">        weak = Rc::<span class="title function_ invoke__">downgrade</span>(&amp;rc1);</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;作用域内: strong=&#123;&#125;, weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;rc1), Rc::<span class="title function_ invoke__">weak_count</span>(&amp;rc1));</span><br><span class="line">        <span class="comment">// 输出: strong=2, weak=1</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// rc1, rc2 离开作用域</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出: 💥 Data(42) 被析构</span></span><br><span class="line">    <span class="comment">// strong 变为 0，数据被释放</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// weak 还在，但数据已经没了</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;作用域外: weak.strong_count()=&#123;&#125;&quot;</span>, weak.<span class="title function_ invoke__">strong_count</span>());</span><br><span class="line">    <span class="comment">// 输出: weak.strong_count()=0</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">match</span> weak.<span class="title function_ invoke__">upgrade</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(rc) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;数据: &#123;&#125;&quot;</span>, rc.value),</span><br><span class="line">        <span class="literal">None</span> =&gt; <span class="built_in">println!</span>(<span class="string">&quot;upgrade 失败，数据已释放&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出: upgrade 失败，数据已释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="stong-0-weak-0"><a href="#stong-0-weak-0" class="headerlink" title="stong&#x3D;0,weak&gt;0"></a>stong&#x3D;0,weak&gt;0</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         内存状态对比                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   strong &gt; 0 时                        strong = 0, weak &gt; 0 时              │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   Weak ───► ┌─────────────────┐        Weak ───► ┌─────────────────┐        │</span><br><span class="line">│             │  strong: 1      │                  │  strong: 0      │        │</span><br><span class="line">│             │  weak:   1      │                  │  weak:   1      │        │</span><br><span class="line">│             ├─────────────────┤                  ├─────────────────┤        │</span><br><span class="line">│             │                 │                  │                 │        │</span><br><span class="line">│             │  Data(42)  ✅   │                  │  (已释放)  ❌   │        │</span><br><span class="line">│             │                 │                  │                 │        │</span><br><span class="line">│             └─────────────────┘                  └─────────────────┘        │</span><br><span class="line">│                                                         │                   │</span><br><span class="line">│   upgrade():                           upgrade():       │                   │</span><br><span class="line">│   1. 读 strong → 1                     1. 读 strong → 0 │ 控制块还在        │</span><br><span class="line">│   2. strong &gt; 0                        2. strong == 0   │ 所以能读取        │</span><br><span class="line">│   3. 返回 Some(Rc)                     3. 返回 None     │                   │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        谁负责释放什么                                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   操作                │  行为                                               │</span><br><span class="line">│   ────────────────────┼───────────────────────────────────────────────────  │</span><br><span class="line">│   drop(Rc)            │  strong--                                           │</span><br><span class="line">│                       │  若 strong→0：释放数据 T                            │</span><br><span class="line">│                       │  若 strong→0 且 weak=0：释放控制块                  │</span><br><span class="line">│   ────────────────────┼───────────────────────────────────────────────────  │</span><br><span class="line">│   drop(Weak)          │  weak--                                             │</span><br><span class="line">│                       │  若 strong=0 且 weak→0：释放控制块                  │</span><br><span class="line">│   ────────────────────┼───────────────────────────────────────────────────  │</span><br><span class="line">│   weak.upgrade()      │  只读取 strong_count，返回 Option                   │</span><br><span class="line">│                       │  不修改计数，不释放任何东西                         │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><code>strong = 0, weak &gt; 0 </code>时，控制块的存在意义就是为了 weak 不访问也指针。</p>
<h2 id="智能指针对比"><a href="#智能指针对比" class="headerlink" title="智能指针对比"></a>智能指针对比</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┬──────────┬──────────┬──────────┬─────────────────────┐</span><br><span class="line">│   智能指针   │ 所有权   │ 可变性   │ 线程安全 │      主要用途        │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│   Box&lt;T&gt;    │   独占   │  继承    │    ✅    │ 堆分配、递归类型     │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│   Rc&lt;T&gt;     │   共享   │  不可变  │    ❌    │ 单线程共享所有权     │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│   Arc&lt;T&gt;    │   共享   │  不可变  │    ✅    │ 多线程共享所有权     │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│  RefCell&lt;T&gt; │   独占   │内部可变  │    ❌    │ 运行时借用检查       │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│   Cell&lt;T&gt;   │   独占   │内部可变  │    ❌    │ Copy类型内部可变     │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│  Weak&lt;T&gt;    │    无    │  不可变  │  同Rc/Arc │ 打破循环引用        │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│   Cow&lt;T&gt;    │  按需    │  按需    │    ✅    │ 写时复制优化         │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│  Mutex&lt;T&gt;   │   共享   │内部可变  │    ✅    │ 多线程互斥访问       │</span><br><span class="line">├─────────────┼──────────┼──────────┼──────────┼─────────────────────┤</span><br><span class="line">│  RwLock&lt;T&gt;  │   共享   │内部可变  │    ✅    │ 多线程读写锁         │</span><br><span class="line">└─────────────┴──────────┴──────────┴──────────┴─────────────────────┘</span><br></pre></td></tr></table></figure></div>
<hr>
<h2 id="选择决策流程"><a href="#选择决策流程" class="headerlink" title="选择决策流程"></a>选择决策流程</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">需要智能指针?</span><br><span class="line">    │</span><br><span class="line">    ├─► 需要堆分配? ──► Box&lt;T&gt;</span><br><span class="line">    │</span><br><span class="line">    ├─► 需要共享所有权?</span><br><span class="line">    │       │</span><br><span class="line">    │       ├─► 单线程 ──► Rc&lt;T&gt;</span><br><span class="line">    │       │               │</span><br><span class="line">    │       │               └─► 需要可变? ──► Rc&lt;RefCell&lt;T&gt;&gt;</span><br><span class="line">    │       │</span><br><span class="line">    │       └─► 多线程 ──► Arc&lt;T&gt;</span><br><span class="line">    │                       │</span><br><span class="line">    │                       └─► 需要可变? ──► Arc&lt;Mutex&lt;T&gt;&gt; 或 Arc&lt;RwLock&lt;T&gt;&gt;</span><br><span class="line">    │</span><br><span class="line">    ├─► 需要内部可变性?</span><br><span class="line">    │       │</span><br><span class="line">    │       ├─► T: Copy ──► Cell&lt;T&gt;</span><br><span class="line">    │       │</span><br><span class="line">    │       └─► 其他 ──► RefCell&lt;T&gt;</span><br><span class="line">    │</span><br><span class="line">    └─► 需要避免克隆? ──► Cow&lt;T&gt;</span><br></pre></td></tr></table></figure></div>

<h2 id="循环引用-Cyclic-References"><a href="#循环引用-Cyclic-References" class="headerlink" title="循环引用 (Cyclic References)"></a>循环引用 (Cyclic References)</h2><h3 id="问题本质"><a href="#问题本质" class="headerlink" title="问题本质"></a>问题本质</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        使用 Rc (循环引用 - 泄漏!)                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   栈变量 a                        栈变量 b                                  │</span><br><span class="line">│      │                               │                                      │</span><br><span class="line">│      ▼                               ▼                                      │</span><br><span class="line">│   ┌──────────────────┐          ┌──────────────────┐                        │</span><br><span class="line">│   │  Rc&lt;RefCell&lt;Node&gt;&gt;│          │  Rc&lt;RefCell&lt;Node&gt;&gt;│                       │</span><br><span class="line">│   │  strong_count: 2 │          │  strong_count: 2 │  ← 都是 2!             │</span><br><span class="line">│   │  weak_count:   0 │          │  weak_count:   0 │                        │</span><br><span class="line">│   ├──────────────────┤          ├──────────────────┤                        │</span><br><span class="line">│   │  Node &#123;          │          │  Node &#123;          │                        │</span><br><span class="line">│   │    value: 1      │          │    value: 2      │                        │</span><br><span class="line">│   │    next: Some ───┼── Rc ───►│    next: Some ───┼── Rc ──┐               │</span><br><span class="line">│   │  &#125;               │          │  &#125;               │        │               │</span><br><span class="line">│   └──────────────────┘          └──────────────────┘        │               │</span><br><span class="line">│            ▲                                                │               │</span><br><span class="line">│            └────────────────────────────────────────────────┘               │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   离开作用域后:                                                              │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐               │</span><br><span class="line">│   │  a 析构: strong_count 2 → 1 (b.next 还持有)             │               │</span><br><span class="line">│   │  b 析构: strong_count 2 → 1 (a.next 还持有)             │               │</span><br><span class="line">│   │  两者都不为 0，永远无法 drop!  💥 内存泄漏               │               │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘               │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="Rc-导致的内存泄漏"><a href="#Rc-导致的内存泄漏" class="headerlink" title="Rc 导致的内存泄漏"></a>Rc 导致的内存泄漏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">    next: <span class="type">Option</span>&lt;Rc&lt;RefCell&lt;Node&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;🗑️  Dropping Node with value: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;=== 创建循环引用 ===&quot;</span>);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node &#123; value: <span class="number">1</span>, next: <span class="literal">None</span> &#125;));</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">b</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node &#123; value: <span class="number">2</span>, next: <span class="literal">None</span> &#125;));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, b strong=&#123;&#125; a weak=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line">        a.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;b));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, b strong=&#123;&#125; a weak=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line"></span><br><span class="line">        b.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">clone</span>(&amp;a)); <span class="comment">// 循环!</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, b strong=&#123;&#125; a weak=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;=== 离开作用域 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;(如果没看到 Drop 消息，说明泄漏了!)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="解决方案：Weak"><a href="#解决方案：Weak" class="headerlink" title="解决方案：Weak"></a>解决方案：Weak</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::&#123;Rc, Weak&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    value: <span class="type">i32</span>,</span><br><span class="line">    next: <span class="type">Option</span>&lt;Weak&lt;RefCell&lt;Node&gt;&gt;&gt;,  <span class="comment">// 改用 Weak</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;🗑️  Dropping Node with value: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;=== 使用 Weak 打破循环 ===&quot;</span>);</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">a</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node &#123; value: <span class="number">1</span>, next: <span class="literal">None</span> &#125;));</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">b</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(Node &#123; value: <span class="number">2</span>, next: <span class="literal">None</span> &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, a weak=&#123;&#125;\nb strong=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line">        a.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">downgrade</span>(&amp;b));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, a weak=&#123;&#125;\nb strong=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line">        b.<span class="title function_ invoke__">borrow_mut</span>().next = <span class="title function_ invoke__">Some</span>(Rc::<span class="title function_ invoke__">downgrade</span>(&amp;a));</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;a strong=&#123;&#125;, a weak=&#123;&#125;\nb strong=&#123;&#125;, b weak=&#123;&#125;&quot;</span>, </span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;a), </span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;a),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">strong_count</span>(&amp;b),</span><br><span class="line">                 Rc::<span class="title function_ invoke__">weak_count</span>(&amp;b));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;=== 离开作用域 ===&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        使用 Weak (打破循环 - 正常释放)                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   栈变量 a                        栈变量 b                                  │</span><br><span class="line">│      │                               │                                      │</span><br><span class="line">│      ▼                               ▼                                      │</span><br><span class="line">│   ┌──────────────────┐          ┌──────────────────┐                        │</span><br><span class="line">│   │  Rc&lt;RefCell&lt;Node&gt;&gt;│          │  Rc&lt;RefCell&lt;Node&gt;&gt;│                       │</span><br><span class="line">│   │  strong_count: 1 │          │  strong_count: 1 │  ← 都是 1!             │</span><br><span class="line">│   │  weak_count:   1 │          │  weak_count:   1 │                        │</span><br><span class="line">│   ├──────────────────┤          ├──────────────────┤                        │</span><br><span class="line">│   │  Node &#123;          │          │  Node &#123;          │                        │</span><br><span class="line">│   │    value: 1      │          │    value: 2      │                        │</span><br><span class="line">│   │    next: Some ───┼─ Weak ─ ─│─ ─next: Some ───┼─ Weak ─ ┐              │</span><br><span class="line">│   │  &#125;               │   弱!    │  &#125;               │   弱!   │              │</span><br><span class="line">│   └──────────────────┘          └──────────────────┘         │              │</span><br><span class="line">│            ▲                                                 │              │</span><br><span class="line">│            └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘              │</span><br><span class="line">│                        (虚线 = Weak，不增加 strong_count)                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>完整的 Weak 方案析构过程</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Weak 方案的完整析构过程                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  初始状态:                                                                   │</span><br><span class="line">│  ══════════                                                                 │</span><br><span class="line">│       a                                    b                                │</span><br><span class="line">│       │                                    │                                │</span><br><span class="line">│       ▼                                    ▼                                │</span><br><span class="line">│   ┌─────────────────┐   Weak         ┌─────────────────┐                    │</span><br><span class="line">│   │ 控制块          │                │ 控制块          │                    │</span><br><span class="line">│   │ strong: 1       │◄─ ─ ─ ─ ─ ─ ─ ─│ strong: 1       │                    │</span><br><span class="line">│   │ weak:   1       │                │ weak:   1       │                    │</span><br><span class="line">│   ├─────────────────┤                ├─────────────────┤                    │</span><br><span class="line">│   │ Node 1 数据     │─ ─ ─ ─ ─ ─ ─ ─►│ Node 2 数据     │                    │</span><br><span class="line">│   │ (next: Weak)    │   Weak         │ (next: Weak)    │                    │</span><br><span class="line">│   └─────────────────┘                └─────────────────┘                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Step 1: 栈变量 a 离开作用域，drop(Rc&lt;Node1&gt;)                                │</span><br><span class="line">│  ════════════════════════════════════════════                               │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   1a. Node1 的 strong: 1→0                                                  │</span><br><span class="line">│                                            b                                │</span><br><span class="line">│                                            │                                │</span><br><span class="line">│                                            ▼                                │</span><br><span class="line">│   ┌─────────────────┐                ┌─────────────────┐                    │</span><br><span class="line">│   │ 控制块          │                │ 控制块          │                    │</span><br><span class="line">│   │ strong: 0 ←改变 │◄─ ─ ─ ─ ─ ─ ─ ─│ strong: 1       │                    │</span><br><span class="line">│   │ weak:   1       │                │ weak:   1       │                    │</span><br><span class="line">│   ├─────────────────┤                ├─────────────────┤                    │</span><br><span class="line">│   │ Node 1 数据     │─ ─ ─ ─ ─ ─ ─ ─►│ Node 2 数据     │                    │</span><br><span class="line">│   │ (next: Weak)    │                │ (next: Weak)    │                    │</span><br><span class="line">│   └─────────────────┘                └─────────────────┘                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   1b. strong=0，触发 drop(Node1 数据)，内部 Weak&lt;Node2&gt; 也被 drop            │</span><br><span class="line">│       → Node2 的 weak: 1→0                                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                            b                                │</span><br><span class="line">│                                            │                                │</span><br><span class="line">│                                            ▼                                │</span><br><span class="line">│   ┌─────────────────┐                ┌─────────────────┐                    │</span><br><span class="line">│   │ 控制块          │                │ 控制块          │                    │</span><br><span class="line">│   │ strong: 0       │◄─ ─ ─ ─ ─ ─ ─ ─│ strong: 1       │                    │</span><br><span class="line">│   │ weak:   1       │                │ weak:   0 ←改变 │                    │</span><br><span class="line">│   ├─────────────────┤                ├─────────────────┤                    │</span><br><span class="line">│   │   🗑️ 已释放     │                │ Node 2 数据     │                    │</span><br><span class="line">│   │                 │                │ (next: Weak)    │                    │</span><br><span class="line">│   └─────────────────┘                └─────────────────┘                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   1c. 检查 Node1：strong=0, weak=1 (&gt;0) → 控制块保留 ✓                       │</span><br><span class="line">│       检查 Node2：strong=1, weak=0      → 控制块保留 ✓（strong&gt;0）           │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  Step 2: 栈变量 b 离开作用域，drop(Rc&lt;Node2&gt;)                                │</span><br><span class="line">│  ════════════════════════════════════════════                               │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   2a. Node2 的 strong: 1→0                                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────┐                ┌─────────────────┐                    │</span><br><span class="line">│   │ 控制块          │                │ 控制块          │                    │</span><br><span class="line">│   │ strong: 0       │◄─ ─ ─ ─ ─ ─ ─ ─│ strong: 0 ←改变 │                    │</span><br><span class="line">│   │ weak:   1       │                │ weak:   0       │                    │</span><br><span class="line">│   ├─────────────────┤                ├─────────────────┤                    │</span><br><span class="line">│   │   (已释放)      │                │ Node 2 数据     │                    │</span><br><span class="line">│   │                 │                │ (next: Weak)    │                    │</span><br><span class="line">│   └─────────────────┘                └─────────────────┘                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   2b. strong=0，触发 drop(Node2 数据)，内部 Weak&lt;Node1&gt; 也被 drop            │</span><br><span class="line">│       → Node1 的 weak: 1→0                                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────┐                ┌─────────────────┐                    │</span><br><span class="line">│   │ 控制块          │                │ 控制块          │                    │</span><br><span class="line">│   │ strong: 0       │                │ strong: 0       │                    │</span><br><span class="line">│   │ weak:   0 ←改变 │                │ weak:   0       │                    │</span><br><span class="line">│   ├─────────────────┤                ├─────────────────┤                    │</span><br><span class="line">│   │   (已释放)      │                │   🗑️ 已释放     │                    │</span><br><span class="line">│   │                 │                │                 │                    │</span><br><span class="line">│   └─────────────────┘                └─────────────────┘                    │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   2c. 检查 Node1：strong=0, weak=0 → 🗑️ 释放控制块！                        │</span><br><span class="line">│       检查 Node2：strong=0, weak=0 → 🗑️ 释放控制块！                        │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  最终状态:                                                                   │</span><br><span class="line">│  ══════════                                                                 │</span><br><span class="line">│                                                                             │</span><br><span class="line">│       🗑️                                   🗑️                               │</span><br><span class="line">│   (完全释放)                           (完全释放)                            │</span><br><span class="line">│                                                                             │</span><br><span class="line">│                                                                             │</span><br><span class="line">│  ✅ 数据 + 控制块 全部正常释放，无泄漏!                                      │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>释放规则总结</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                           释放时机                                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────┐       │</span><br><span class="line">│   │                        内存布局                                  │       │</span><br><span class="line">│   │   ┌─────────────────┐                                           │       │</span><br><span class="line">│   │   │ 控制块          │  ← weak_count 保护                        │       │</span><br><span class="line">│   │   │ strong_count    │                                           │       │</span><br><span class="line">│   │   │ weak_count      │                                           │       │</span><br><span class="line">│   │   ├─────────────────┤                                           │       │</span><br><span class="line">│   │   │ 数据 T          │  ← strong_count 保护                      │       │</span><br><span class="line">│   │   └─────────────────┘                                           │       │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────┘       │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   释放数据 T：    strong → 0 时                                             │</span><br><span class="line">│   释放控制块：    strong = 0 且 weak → 0 时                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ═══════════════════════════════════════════════════════════════════       │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   事件             │  数据 T      │  控制块                                  │</span><br><span class="line">│   ─────────────────┼──────────────┼────────────────────────────────         │</span><br><span class="line">│   strong: 1→0      │  🗑️ 释放     │  检查 weak                              │</span><br><span class="line">│   weak:   1→0      │  (已释放)    │  若 strong=0 则 🗑️ 释放                 │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>关键点</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                  │</span><br><span class="line">│  为什么 Step 1 后 Node1 控制块还在？                              │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  → Node2 的 Weak 还指向 Node1                                    │</span><br><span class="line">│  → Node1 的 weak_count = 1                                       │</span><br><span class="line">│  → 控制块必须保留，否则 Node2 的 Weak 变野指针                    │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  ────────────────────────────────────────────────────────────    │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  什么时候 Node1 控制块才释放？                                    │</span><br><span class="line">│                                                                  │</span><br><span class="line">│  → Step 2 中 drop(Node2 数据) 时                                 │</span><br><span class="line">│  → Node2 内部的 Weak&lt;Node1&gt; 被 drop                              │</span><br><span class="line">│  → Node1 的 weak: 1→0                                            │</span><br><span class="line">│  → 此时 strong=0, weak=0 → 释放控制块                            │</span><br><span class="line">│                                                                  │</span><br><span class="line">└──────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h2 id="自引用-Self-Referential-Structs"><a href="#自引用-Self-Referential-Structs" class="headerlink" title="自引用 (Self-Referential Structs)"></a>自引用 (Self-Referential Structs)</h2><h3 id="问题本质-1"><a href="#问题本质-1" class="headerlink" title="问题本质"></a>问题本质</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 这段代码无法编译</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SelfRef</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    ptr: &amp;<span class="type">str</span>,  <span class="comment">// 想要指向 data 的内容</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为什么不行？</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = SelfRef &#123;</span><br><span class="line">        data: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>),</span><br><span class="line">        ptr: ???,  <span class="comment">// 此时 data 还不存在，无法获取引用</span></span><br><span class="line">    &#125;;</span><br><span class="line">    s.ptr = &amp;s.data;  <span class="comment">// data 的地址</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s2</span> = s;  <span class="comment">// 移动! data 地址变了，ptr 成了悬垂指针!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        移动导致自引用失效                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  移动前 (栈地址 0x1000):              移动后 (栈地址 0x2000):                │</span><br><span class="line">│  ┌────────────────────────┐           ┌────────────────────────┐            │</span><br><span class="line">│  │ data: String           │           │ data: String           │            │</span><br><span class="line">│  │   ptr ─────────────────┼──┐        │   ptr ─────────────────┼──┐         │</span><br><span class="line">│  │   len: 5               │  │        │   len: 5               │  │         │</span><br><span class="line">│  │   cap: 5               │  │        │   cap: 5               │  │         │</span><br><span class="line">│  ├────────────────────────┤  │        ├────────────────────────┤  │         │</span><br><span class="line">│  │ ptr: &amp;str ─────────────┼──┤        │ ptr: &amp;str ─────────────┼──┼── 悬垂! │</span><br><span class="line">│  │   (指向 0x1000.data)   │  │        │   (仍指向 0x1000!)     │  │         │</span><br><span class="line">│  └────────────────────────┘  │        └────────────────────────┘  │         │</span><br><span class="line">│             ▲                │                                    │         │</span><br><span class="line">│             └────────────────┘                                    │         │</span><br><span class="line">│             ✓ 有效                                 ✗ 无效! ────────┘         │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          移动 = memcpy                                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   栈 (高地址 → 低地址)                                                       │</span><br><span class="line">│   ═══════════════════                                                       │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   移动前:                           移动后:                                  │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────┐ 0x2000       ┌─────────────────┐ 0x2000               │</span><br><span class="line">│   │     s2: ???     │              │  s2 (有效)      │ ◄── 字节被复制到这里  │</span><br><span class="line">│   │                 │              │  [完整的数据]   │                       │</span><br><span class="line">│   └─────────────────┘              └─────────────────┘                       │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   ┌─────────────────┐ 0x1000       ┌─────────────────┐ 0x1000               │</span><br><span class="line">│   │  s (有效)       │    ════►     │  s (无效)       │ ◄── 编译器禁止访问    │</span><br><span class="line">│   │  [完整的数据]   │   memcpy     │  [数据还在!]    │     但字节仍在内存中  │</span><br><span class="line">│   └─────────────────┘              └─────────────────┘                       │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   堆 (不变)                         堆 (不变)                                │</span><br><span class="line">│   ═════════                         ═════════                                │</span><br><span class="line">│   ┌─────────────────┐ 0x8000       ┌─────────────────┐ 0x8000               │</span><br><span class="line">│   │ &quot;hello&quot;         │              │ &quot;hello&quot;         │                       │</span><br><span class="line">│   └─────────────────┘              └─────────────────┘                       │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        移动后的真实内存状态                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   let s1 = String::from(&quot;hello&quot;);                                           │</span><br><span class="line">│   let s2 = s1;  // 移动                                                     │</span><br><span class="line">│                                                                             │</span><br><span class="line">│   栈内存 (物理真实状态):                                                     │</span><br><span class="line">│   ┌─────────────────────┐ 0x2000                                            │</span><br><span class="line">│   │ s2:                 │                                                   │</span><br><span class="line">│   │   ptr: 0x8000 ──────┼───┐    ✅ 有效，编译器允许访问                    │</span><br><span class="line">│   │   len: 5            │   │                                               │</span><br><span class="line">│   │   cap: 5            │   │                                               │</span><br><span class="line">│   └─────────────────────┘   │                                               │</span><br><span class="line">│                             │                                               │</span><br><span class="line">│   ┌─────────────────────┐ 0x1000                                            │</span><br><span class="line">│   │ s1 (残留数据):      │   │                                               │</span><br><span class="line">│   │   ptr: 0x8000 ──────┼───┤    ❌ 无效，编译器禁止访问                    │</span><br><span class="line">│   │   len: 5            │   │       但字节确实还在！                        │</span><br><span class="line">│   │   cap: 5            │   │                                               │</span><br><span class="line">│   └─────────────────────┘   │                                               │</span><br><span class="line">│                             │                                               │</span><br><span class="line">│   堆内存:                   │                                               │</span><br><span class="line">│   ┌─────────────────────┐ 0x8000                                            │</span><br><span class="line">│   │ &quot;hello&quot;             │◄──┴── 两个指针都指向这里                          │</span><br><span class="line">│   └─────────────────────┘       但只有 s2 能用                              │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="使用索引代替引用"><a href="#使用索引代替引用" class="headerlink" title="使用索引代替引用"></a>使用索引代替引用</h4><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 简单有效的方案</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Document</span> &#123;</span><br><span class="line">    buffer: <span class="type">String</span>,</span><br><span class="line">    tokens: <span class="type">Vec</span>&lt;(<span class="type">usize</span>, <span class="type">usize</span>)&gt;,  <span class="comment">// (start, end) 索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Document</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_token</span>(&amp;<span class="keyword">self</span>, idx: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (start, end) = <span class="keyword">self</span>.tokens[idx];</span><br><span class="line">        &amp;<span class="keyword">self</span>.buffer[start..end]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Pin-PhantomPinned"><a href="#Pin-PhantomPinned" class="headerlink" title="Pin + PhantomPinned"></a>Pin + PhantomPinned</h4><p><strong>两个组件的作用</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::pin::Pin;            <span class="comment">// 包装器，承诺不移动内部数据</span></span><br><span class="line"><span class="keyword">use</span> std::marker::PhantomPinned; <span class="comment">// 标记类型，使 Pin 真正生效</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                 │</span><br><span class="line">│   Pin&lt;P&gt;          →  &quot;我保证不会移动 P 指向的数据&quot;               │</span><br><span class="line">│   PhantomPinned   →  &quot;我需要被钉住，移动我会出问题&quot;              │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   两者配合：Pin 才能真正阻止移动                                 │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>完整示例</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::pin::Pin;</span><br><span class="line"><span class="keyword">use</span> std::marker::PhantomPinned;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SelfRef</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    ptr: *<span class="keyword">const</span> <span class="type">String</span>,   <span class="comment">// 裸指针指向 data</span></span><br><span class="line">    _pin: PhantomPinned,  <span class="comment">// 关键：标记为不可移动</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SelfRef</span> &#123;</span><br><span class="line">    <span class="comment">// 第一步：创建（ptr 暂时为空）</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(data: <span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        SelfRef &#123;</span><br><span class="line">            data,</span><br><span class="line">            ptr: std::ptr::<span class="title function_ invoke__">null</span>(),</span><br><span class="line">            _pin: PhantomPinned,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 第二步：钉住后初始化自引用</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">init</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">this</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">get_unchecked_mut</span>();</span><br><span class="line">            this.ptr = &amp;this.data;  <span class="comment">// 现在安全了，不会再移动</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 访问方法</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">Self</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 使用 Box::pin 钉在堆上</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pinned</span> = <span class="type">Box</span>::<span class="title function_ invoke__">pin</span>(SelfRef::<span class="title function_ invoke__">new</span>(<span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>()));</span><br><span class="line">    pinned.<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">init</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, pinned.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">get_data</span>()); <span class="comment">// &quot;hello&quot;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// let moved = *pinned;  // ❌ 编译错误！无法移出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>为什么需要 PhantomPinned？</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有 PhantomPinned 的类型默认实现 Unpin</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Normal</span> &#123; data: <span class="type">String</span> &#125;  <span class="comment">// Normal: Unpin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin 对 Unpin 类型没有限制</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">n</span> = Normal &#123; data: <span class="string">&quot;hi&quot;</span>.<span class="title function_ invoke__">into</span>() &#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">pinned</span> = Pin::<span class="title function_ invoke__">new</span>(&amp;<span class="keyword">mut</span> n);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">moved</span> = *pinned.<span class="title function_ invoke__">get_mut</span>();  <span class="comment">// ✅ 可以移动！Pin 形同虚设</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 有 PhantomPinned 则不实现 Unpin</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Pinned</span> &#123; </span><br><span class="line">    data: <span class="type">String</span>, </span><br><span class="line">    _pin: PhantomPinned  <span class="comment">// Pinned: !Unpin</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pin 真正生效</span></span><br><span class="line"><span class="comment">// pinned.get_mut()  // ❌ 方法不存在，只有 get_unchecked_mut()</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h4 id="ouroboros"><a href="#ouroboros" class="headerlink" title="ouroboros"></a>ouroboros</h4><p><strong>添加依赖</strong></p>
<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">ouroboros</span> = <span class="string">&quot;0.18.5&quot;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>基本用法</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> ouroboros::self_referencing;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[self_referencing]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SelfRef</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[borrows(data)]</span></span><br><span class="line">    data_ref: &amp;<span class="symbol">&#x27;this</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = SelfRefBuilder &#123;</span><br><span class="line">        data: <span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        data_ref_builder: |data| data.<span class="title function_ invoke__">as_str</span>(),</span><br><span class="line">    &#125;.<span class="title function_ invoke__">build</span>();</span><br><span class="line">    </span><br><span class="line">    s.<span class="title function_ invoke__">with_data_ref</span>(|r| <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, r));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>可变访问</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> ouroboros::self_referencing;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[self_referencing]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MutableSelf</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="meta">#[borrows(mut data)]</span>   <span class="comment">// 注意：mut 在这里</span></span><br><span class="line">    slice: &amp;<span class="symbol">&#x27;this</span> <span class="keyword">mut</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = MutableSelfBuilder &#123;</span><br><span class="line">        data: <span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        slice_builder: |data| data.<span class="title function_ invoke__">as_mut_str</span>(),</span><br><span class="line">    &#125;.<span class="title function_ invoke__">build</span>();</span><br><span class="line">    </span><br><span class="line">    s.<span class="title function_ invoke__">with_slice_mut</span>(|s| &#123;</span><br><span class="line">        s.<span class="title function_ invoke__">make_ascii_uppercase</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    s.<span class="title function_ invoke__">with_slice</span>(|s| <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s));  <span class="comment">// &quot;HELLO&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>ouroboros 宏展开解析</strong></p>
<p><strong>这些都是 ouroboros 宏自动生成的</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  &#x27;this          →  ouroboros 定义的特殊生命周期占位符           │</span><br><span class="line">│  SelfRefBuilder →  宏根据结构体名生成的 Builder 结构体          │</span><br><span class="line">│  data_ref_builder → 宏根据字段名生成的初始化闭包字段            │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p>感兴趣的同学可以使用 <code>cargo expand</code> 来查看展开后的代码。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cargo install cargo-expand</span><br><span class="line">cargo <span class="built_in">expand</span>  </span><br></pre></td></tr></table></figure></div>

<p><strong>命名规则</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  对于 #[self_referencing] struct Foo &#123; ... &#125;                      │</span><br><span class="line">├────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                    │</span><br><span class="line">│  类型名               作用                                         │</span><br><span class="line">│  ─────────────────────────────────────────────────────────────     │</span><br><span class="line">│  Foo                  主结构体                                     │</span><br><span class="line">│  FooBuilder           Builder 结构体                               │</span><br><span class="line">│  FooHeads             非借用字段的所有权集合                        │</span><br><span class="line">│  BorrowedFields       with() 中使用的引用集合                       │</span><br><span class="line">│  BorrowedMutFields    with_mut() 中使用的可变引用集合               │</span><br><span class="line">│                                                                    │</span><br><span class="line">├────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                    │</span><br><span class="line">│  方法名               作用                                         │</span><br><span class="line">│  ─────────────────────────────────────────────────────────────     │</span><br><span class="line">│  Foo::new()           直接构造                                     │</span><br><span class="line">│  Foo::try_new()       可能失败的构造                               │</span><br><span class="line">│  Foo::try_new_or_recover()  失败时返回 heads                       │</span><br><span class="line">│  FooBuilder::build()  从 builder 构造                              │</span><br><span class="line">│                                                                    │</span><br><span class="line">│  .with_xxx()          访问字段 xxx                                 │</span><br><span class="line">│  .with_xxx_mut()      可变访问字段 xxx                             │</span><br><span class="line">│  .with()              访问所有字段                                 │</span><br><span class="line">│  .with_mut()          可变访问所有字段                             │</span><br><span class="line">│  .borrow_xxx()        直接引用 xxx（仅非自引用字段）                │</span><br><span class="line">│  .borrow_xxx_mut()    直接可变引用 xxx                             │</span><br><span class="line">│  .into_heads()        消耗 self，返回 heads                        │</span><br><span class="line">│                                                                    │</span><br><span class="line">└───────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure></div>

<p><strong>完整对照示例</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> ouroboros::self_referencing;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[self_referencing]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Parser</span> &#123;           <span class="comment">// → 生成 ParserBuilder</span></span><br><span class="line">    source: <span class="type">String</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[borrows(source)]</span></span><br><span class="line">    tokens: <span class="type">Vec</span>&lt;&amp;<span class="symbol">&#x27;this</span> <span class="type">str</span>&gt;,  <span class="comment">// → 生成 tokens_builder 字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 使用生成的 Builder</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = ParserBuilder &#123;</span><br><span class="line">        source: <span class="string">&quot;hello world&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// tokens_builder: 一个闭包，接收 &amp;source，返回 tokens</span></span><br><span class="line">        tokens_builder: |src: &amp;<span class="type">String</span>| &#123;</span><br><span class="line">            src.<span class="title function_ invoke__">split_whitespace</span>().<span class="title function_ invoke__">collect</span>()</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;.<span class="title function_ invoke__">build</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用生成的访问方法</span></span><br><span class="line">    p.<span class="title function_ invoke__">with_tokens</span>(|tokens| &#123;          <span class="comment">// with_tokens 来自字段名 tokens</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, tokens);     <span class="comment">// [&quot;hello&quot;, &quot;world&quot;]</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    p.<span class="title function_ invoke__">with_source</span>(|s| &#123;               <span class="comment">// 普通字段也有 with_xxx</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, s);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>为什么需要闭包 builder？</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  问题：自引用字段依赖其他字段，必须按顺序初始化                   │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  tokens 引用 source → source 必须先存在                         │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  解决：用闭包延迟执行                                            │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ParserBuilder &#123;                                                │</span><br><span class="line">│      source: &quot;...&quot;,           // 1. 先有 source                 │</span><br><span class="line">│      tokens_builder: |src| &#123;  // 2. 闭包等 source 就位后调用     │</span><br><span class="line">│          src.split()...       //    此时 src 地址已固定          │</span><br><span class="line">│      &#125;                                                          │</span><br><span class="line">│  &#125;.build()                    // 3. build 时按顺序执行           │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>总结</strong>：<code>&#39;this</code>、<code>XxxBuilder</code>、<code>xxx_builder</code>、<code>with_xxx()</code> 全部是 ouroboros 宏生成的。</p>
<h1 id="深入类型"><a href="#深入类型" class="headerlink" title="深入类型"></a>深入类型</h1><h2 id="dyn-trait"><a href="#dyn-trait" class="headerlink" title="dyn trait"></a>dyn trait</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><code>dyn Trait</code> 是 <strong>trait 对象</strong>，用于实现<strong>运行时多态</strong>（动态分发）。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dyn 关键字表示&quot;动态的&quot;，后面跟 trait 名</span></span><br><span class="line"><span class="comment">// dyn Trait 本身是一个 DST（动态大小类型）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 必须通过指针使用：&amp;dyn Trait、Box&lt;dyn Trait&gt;、Rc&lt;dyn Trait&gt; 等</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: &amp;<span class="keyword">dyn</span> std::fmt::<span class="built_in">Debug</span> = &amp;<span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::fmt::<span class="built_in">Debug</span>&gt; = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="静态分发-vs-动态分发"><a href="#静态分发-vs-动态分发" class="headerlink" title="静态分发 vs 动态分发"></a>静态分发 vs 动态分发</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dog</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;Woof!&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;Meow!&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 静态分发（泛型）============</span></span><br><span class="line"><span class="comment">// 编译时确定具体类型，为每个类型生成专门的代码（单态化）</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">static_speak</span>&lt;T: Animal&gt;(animal: &amp;T) &#123;</span><br><span class="line">    animal.<span class="title function_ invoke__">speak</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 编译器生成：</span></span><br><span class="line"><span class="comment">// fn static_speak_dog(animal: &amp;Dog) &#123; ... &#125;</span></span><br><span class="line"><span class="comment">// fn static_speak_cat(animal: &amp;Cat) &#123; ... &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 动态分发（dyn Trait）============</span></span><br><span class="line"><span class="comment">// 运行时通过 vtable 查找方法</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">dynamic_speak</span>(animal: &amp;<span class="keyword">dyn</span> Animal) &#123;</span><br><span class="line">    animal.<span class="title function_ invoke__">speak</span>();  <span class="comment">// 运行时查表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dog</span> = Dog;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cat</span> = Cat;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 静态分发</span></span><br><span class="line">    <span class="title function_ invoke__">static_speak</span>(&amp;dog);</span><br><span class="line">    <span class="title function_ invoke__">static_speak</span>(&amp;cat);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 动态分发</span></span><br><span class="line">    <span class="title function_ invoke__">dynamic_speak</span>(&amp;dog);</span><br><span class="line">    <span class="title function_ invoke__">dynamic_speak</span>(&amp;cat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    静态分发 vs 动态分发                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  特性              静态分发 (impl Trait/泛型)    动态分发 (dyn Trait)│</span><br><span class="line">│  ─────────────────────────────────────────────────────────────────  │</span><br><span class="line">│  类型确定时机      编译时                        运行时              │</span><br><span class="line">│  性能              更快（可内联）                有虚表查找开销       │</span><br><span class="line">│  二进制大小        更大（每类型一份代码）        更小（共享代码）     │</span><br><span class="line">│  异构集合          ❌ 不支持                     ✅ 支持             │</span><br><span class="line">│  编译时间          更长                          更短                │</span><br><span class="line">│  语法              impl Trait 或 &lt;T: Trait&gt;      dyn Trait           │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="Trait-对象的内存结构"><a href="#Trait-对象的内存结构" class="headerlink" title="Trait 对象的内存结构"></a>Trait 对象的内存结构</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::mem::size_of;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 普通引用：8 字节（64位系统）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;<span class="type">i32</span>&gt;());       <span class="comment">// 8</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// trait 对象引用：16 字节（胖指针）</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;<span class="keyword">dyn</span> <span class="built_in">Send</span>&gt;());  <span class="comment">// 16</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="built_in">Send</span>&gt;&gt;()); <span class="comment">// 16</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  &amp;dyn Trait 胖指针结构                                              │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  data_ptr (8 bytes)  │  vtable_ptr (8 bytes)                 │  │</span><br><span class="line">│  │  指向实际数据         │  指向虚函数表                         │  │</span><br><span class="line">│  └──────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  vtable（虚函数表）内容：                                           │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │  drop_fn       │  析构函数指针                               │  │</span><br><span class="line">│  │  size          │  类型大小                                   │  │</span><br><span class="line">│  │  align         │  类型对齐                                   │  │</span><br><span class="line">│  │  method_1      │  trait 方法 1 的函数指针                    │  │</span><br><span class="line">│  │  method_2      │  trait 方法 2 的函数指针                    │  │</span><br><span class="line">│  │  ...           │                                             │  │</span><br><span class="line">│  └──────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="为什么需要-dyn-Trait"><a href="#为什么需要-dyn-Trait" class="headerlink" title="为什么需要 dyn Trait"></a>为什么需要 dyn Trait</h3><p><strong>异构集合</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Drawable</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">draw</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Circle</span> &#123; radius: <span class="type">f64</span> &#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Rectangle</span> &#123; width: <span class="type">f64</span>, height: <span class="type">f64</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drawable</span> <span class="keyword">for</span> <span class="title class_">Circle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">draw</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;Drawing circle r=&#123;&#125;&quot;</span>, <span class="keyword">self</span>.radius); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drawable</span> <span class="keyword">for</span> <span class="title class_">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">draw</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;Drawing rect &#123;&#125;x&#123;&#125;&quot;</span>, <span class="keyword">self</span>.width, <span class="keyword">self</span>.height); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ❌ 泛型方式：Vec 只能存一种类型</span></span><br><span class="line">    <span class="comment">// let shapes: Vec&lt;impl Drawable&gt; = vec![Circle&#123;&#125;, Rectangle&#123;&#125;];  // 错误！</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ trait 对象：可以存不同类型</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">shapes</span>: <span class="type">Vec</span>&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> Drawable&gt;&gt; = <span class="built_in">vec!</span>[</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Circle &#123; radius: <span class="number">1.0</span> &#125;),</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Rectangle &#123; width: <span class="number">2.0</span>, height: <span class="number">3.0</span> &#125;),</span><br><span class="line">    ];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">shape</span> <span class="keyword">in</span> &amp;shapes &#123;</span><br><span class="line">        shape.<span class="title function_ invoke__">draw</span>();  <span class="comment">// 运行时多态</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>返回不同类型</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dog</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123; <span class="string">&quot;Woof&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Animal</span> <span class="keyword">for</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">speak</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123; <span class="string">&quot;Meow&quot;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据条件返回不同类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_animal</span>(is_dog: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Animal&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> is_dog &#123;</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Dog)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Cat)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">animal</span> = <span class="title function_ invoke__">get_animal</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, animal.<span class="title function_ invoke__">speak</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>存储回调&#x2F;闭包</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 闭包每个都是独特的类型，需要 dyn 来统一存储</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Button</span> &#123;</span><br><span class="line">    on_click: <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>()&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Button</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(callback: <span class="keyword">impl</span> <span class="title class_">Fn</span>() + <span class="symbol">&#x27;static</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Button &#123;</span><br><span class="line">            on_click: <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(callback),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">click</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        (<span class="keyword">self</span>.on_click)();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">btn1</span> = Button::<span class="title function_ invoke__">new</span>(|| <span class="built_in">println!</span>(<span class="string">&quot;Button 1 clicked&quot;</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">btn2</span> = Button::<span class="title function_ invoke__">new</span>(|| <span class="built_in">println!</span>(<span class="string">&quot;Button 2 clicked&quot;</span>));</span><br><span class="line">  </span><br><span class="line">    btn1.<span class="title function_ invoke__">click</span>();</span><br><span class="line">    btn2.<span class="title function_ invoke__">click</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="对象安全（Object-Safety）"><a href="#对象安全（Object-Safety）" class="headerlink" title="对象安全（Object Safety）"></a>对象安全（Object Safety）</h3><p>**不是所有 trait 都能变成 <code>dyn Trait</code>**，必须是”对象安全”的。</p>
<p><strong>对象安全的要求</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 对象安全的 trait</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Safe</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">method</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">method_with_param</span>(&amp;<span class="keyword">self</span>, x: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不安全：有泛型方法</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">NotSafe1</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generic_method</span>&lt;T&gt;(&amp;<span class="keyword">self</span>, t: T);  <span class="comment">// 无法确定 vtable 大小</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不安全：返回 Self</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">NotSafe2</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">clone</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;  <span class="comment">// 不知道 Self 的具体大小</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不安全：方法需要 Self: Sized</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">NotSafe3</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">by_value</span>(<span class="keyword">self</span>);  <span class="comment">// 需要知道 Self 大小</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 不安全：关联函数（没有 self 参数）</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">NotSafe4</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">associated</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span>;  <span class="comment">// 不知道是哪个类型的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  对象安全规则（所有方法必须满足）                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  1. 不能有泛型类型参数                                              │</span><br><span class="line">│  2. 第一个参数必须是 self 相关类型：                                 │</span><br><span class="line">│     - &amp;self                                                         │</span><br><span class="line">│     - &amp;mut self                                                     │</span><br><span class="line">│     - self: Box&lt;Self&gt;                                               │</span><br><span class="line">│     - self: Rc&lt;Self&gt;                                                │</span><br><span class="line">│     - self: Arc&lt;Self&gt;                                               │</span><br><span class="line">│     - self: Pin&lt;&amp;Self&gt;                                              │</span><br><span class="line">│  3. 返回值不能是 Self                                               │</span><br><span class="line">│  4. 没有 where Self: Sized 约束                                     │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>绕过限制的技巧</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">MyTrait</span> &#123;</span><br><span class="line">    <span class="comment">// 泛型方法加 where Self: Sized，从 dyn 中排除</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generic</span>&lt;T&gt;(&amp;<span class="keyword">self</span>, t: T) <span class="keyword">where</span> <span class="keyword">Self</span>: <span class="built_in">Sized</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 其他方法仍可用于 dyn</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">normal</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MyTrait</span> <span class="keyword">for</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">generic</span>&lt;T&gt;(&amp;<span class="keyword">self</span>, t: T) &#123; &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">normal</span>(&amp;<span class="keyword">self</span>) &#123; <span class="built_in">println!</span>(<span class="string">&quot;normal&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">obj</span>: &amp;<span class="keyword">dyn</span> MyTrait = &amp;Foo;</span><br><span class="line">    obj.<span class="title function_ invoke__">normal</span>();      <span class="comment">// ✅ 可以调用</span></span><br><span class="line">    <span class="comment">// obj.generic(1); // ❌ 不能通过 dyn 调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="常见的-dyn-Trait-用法"><a href="#常见的-dyn-Trait-用法" class="headerlink" title="常见的 dyn Trait 用法"></a>常见的 dyn Trait 用法</h3><p><strong>错误处理</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::error::Error;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Box&lt;dyn Error&gt; 可以包装任何错误类型</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">might_fail</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_file</span> = std::fs::File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;nonexistent.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_num</span>: <span class="type">i32</span> = <span class="string">&quot;not a number&quot;</span>.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="title function_ invoke__">might_fail</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Error: &#123;&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>闭包存储</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Callback</span> = <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>&gt;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">AsyncCallback</span> = <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>() + <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt;;  <span class="comment">// 可跨线程</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">EventHandler</span> &#123;</span><br><span class="line">    callbacks: <span class="type">Vec</span>&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>(&amp;<span class="type">str</span>)&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">EventHandler</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        EventHandler &#123; callbacks: <span class="built_in">vec!</span>[] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add_callback</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, cb: <span class="keyword">impl</span> <span class="title class_">Fn</span>(&amp;<span class="type">str</span>) + <span class="symbol">&#x27;static</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.callbacks.<span class="title function_ invoke__">push</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(cb));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">trigger</span>(&amp;<span class="keyword">self</span>, event: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">cb</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.callbacks &#123;</span><br><span class="line">            <span class="title function_ invoke__">cb</span>(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>插件系统</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> <span class="title class_">Plugin</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">name</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">execute</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PluginManager</span> &#123;</span><br><span class="line">    plugins: <span class="type">Vec</span>&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> Plugin&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PluginManager</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        PluginManager &#123; plugins: <span class="built_in">vec!</span>[] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">register</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, plugin: <span class="keyword">impl</span> <span class="title class_">Plugin</span> + <span class="symbol">&#x27;static</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.plugins.<span class="title function_ invoke__">push</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(plugin));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">run_all</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">plugin</span> <span class="keyword">in</span> &amp;<span class="keyword">self</span>.plugins &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Running: &#123;&#125;&quot;</span>, plugin.<span class="title function_ invoke__">name</span>());</span><br><span class="line">            plugin.<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>多个 trait 约束</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt::<span class="built_in">Debug</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 + 组合多个 trait</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_debug</span>(val: &amp;(<span class="keyword">dyn</span> <span class="built_in">Debug</span> + <span class="built_in">Send</span> + <span class="built_in">Sync</span>)) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Box 版本</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">boxed_multi</span>() <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="built_in">Debug</span> + <span class="built_in">Send</span> + <span class="built_in">Sync</span>&gt; &#123;</span><br><span class="line">    <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Sized-与动态大小类型-DST"><a href="#Sized-与动态大小类型-DST" class="headerlink" title="Sized 与动态大小类型 (DST)"></a>Sized 与动态大小类型 (DST)</h2><h3 id="Sized-Trait-基础"><a href="#Sized-Trait-基础" class="headerlink" title="Sized Trait 基础"></a>Sized Trait 基础</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sized 是一个自动实现的 marker trait</span></span><br><span class="line"><span class="comment">// 表示类型在编译时有已知固定大小</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">foo</span>&lt;T&gt;(t: T) &#123;&#125;           <span class="comment">// 等价于 fn foo&lt;T: Sized&gt;(t: T) &#123;&#125;</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bar</span>&lt;T: ?<span class="built_in">Sized</span>&gt;(t: &amp;T) &#123;&#125;  <span class="comment">// ?Sized 表示&quot;可能不是 Sized&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="类型大小分类"><a href="#类型大小分类" class="headerlink" title="类型大小分类"></a>类型大小分类</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Rust 类型大小分类                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  Sized 类型（编译时已知大小）                                        │</span><br><span class="line">│  ├── 原始类型: i32, f64, bool, char                                │</span><br><span class="line">│  ├── 固定数组: [T; N]                                              │</span><br><span class="line">│  ├── 元组: (A, B, C)                                               │</span><br><span class="line">│  ├── 结构体/枚举（所有字段都是 Sized）                              │</span><br><span class="line">│  └── 指针/引用: &amp;T, &amp;mut T, *const T, Box&lt;T&gt;                       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  DST - 动态大小类型（编译时大小未知）                                │</span><br><span class="line">│  ├── str        字符串切片                                         │</span><br><span class="line">│  ├── [T]        数组切片                                           │</span><br><span class="line">│  └── dyn Trait  trait 对象                                         │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  ZST - 零大小类型                                                   │</span><br><span class="line">│  ├── ()         单元类型                                           │</span><br><span class="line">│  ├── struct Foo;    空结构体                                       │</span><br><span class="line">│  └── PhantomData&lt;T&gt;                                                │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="DST-与胖指针"><a href="#DST-与胖指针" class="headerlink" title="DST 与胖指针"></a>DST 与胖指针</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::mem::size_of;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ===== 普通指针（瘦指针）=====</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;<span class="type">i32</span>&gt;());        <span class="comment">// 8 (64位系统)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;[<span class="type">i32</span>; <span class="number">10</span>]&gt;());  <span class="comment">// 8</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;<span class="type">Box</span>&lt;<span class="type">i32</span>&gt;&gt;());    <span class="comment">// 8</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 胖指针（包含额外元数据）=====</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;<span class="type">str</span>&gt;());        <span class="comment">// 16 = 指针 + 长度</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;[<span class="type">i32</span>]&gt;());      <span class="comment">// 16 = 指针 + 长度</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;&amp;<span class="keyword">dyn</span> <span class="built_in">Send</span>&gt;());   <span class="comment">// 16 = 指针 + vtable指针</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;<span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="built_in">Send</span>&gt;&gt;()); <span class="comment">// 16</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  胖指针内部结构                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  &amp;[T] / &amp;str:                                                       │</span><br><span class="line">│  ┌──────────────────┬──────────────────┐                           │</span><br><span class="line">│  │   data pointer   │     length       │                           │</span><br><span class="line">│  │     (8 bytes)    │    (8 bytes)     │                           │</span><br><span class="line">│  └──────────────────┴──────────────────┘                           │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  &amp;dyn Trait:                                                        │</span><br><span class="line">│  ┌──────────────────┬──────────────────┐                           │</span><br><span class="line">│  │   data pointer   │  vtable pointer  │                           │</span><br><span class="line">│  │     (8 bytes)    │    (8 bytes)     │                           │</span><br><span class="line">│  └──────────────────┴──────────────────┘                           │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="Sized-约束的使用"><a href="#Sized-约束的使用" class="headerlink" title="?Sized 约束的使用"></a>?Sized 约束的使用</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认 T: Sized，不能接受 DST</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_sized</span>&lt;T: std::fmt::<span class="built_in">Debug</span>&gt;(val: &amp;T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ?Sized 允许 DST</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_any</span>&lt;T: std::fmt::<span class="built_in">Debug</span> + ?<span class="built_in">Sized</span>&gt;(val: &amp;T) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span>: &amp;<span class="type">str</span> = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span>: &amp;[<span class="type">i32</span>] = &amp;[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// print_sized(s);  // ❌ str 不是 Sized</span></span><br><span class="line">    <span class="title function_ invoke__">print_any</span>(s);       <span class="comment">// ✅</span></span><br><span class="line">    <span class="title function_ invoke__">print_any</span>(arr);     <span class="comment">// ✅</span></span><br><span class="line">    <span class="title function_ invoke__">print_any</span>(&amp;<span class="number">42i32</span>);  <span class="comment">// ✅ Sized 类型也可以</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="结构体中的-DST"><a href="#结构体中的-DST" class="headerlink" title="结构体中的 DST"></a>结构体中的 DST</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DST 只能作为结构体的最后一个字段</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MySlice</span>&lt;T&gt; &#123;</span><br><span class="line">    len: <span class="type">usize</span>,</span><br><span class="line">    data: [T],  <span class="comment">// DST 必须在最后</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常见用法：自定义切片类型</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Path</span> &#123;</span><br><span class="line">    inner: std::ffi::OsStr,  <span class="comment">// DST</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建方式：通常通过指针转换</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Path</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>&lt;S: <span class="built_in">AsRef</span>&lt;std::ffi::OsStr&gt; + ?<span class="built_in">Sized</span>&gt;(s: &amp;S) <span class="punctuation">-&gt;</span> &amp;Path &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*(s.<span class="title function_ invoke__">as_ref</span>() <span class="keyword">as</span> *<span class="keyword">const</span> std::ffi::OsStr <span class="keyword">as</span> *<span class="keyword">const</span> Path) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="零大小类型-ZST"><a href="#零大小类型-ZST" class="headerlink" title="零大小类型 (ZST)"></a>零大小类型 (ZST)</h2><h3 id="ZST-类型示例"><a href="#ZST-类型示例" class="headerlink" title="ZST 类型示例"></a>ZST 类型示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::mem::size_of;</span><br><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 各种 ZST</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Empty</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NoFields</span> &#123;&#125;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Marker</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;()&gt;());              <span class="comment">// 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;Empty&gt;());           <span class="comment">// 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;NoFields&gt;());        <span class="comment">// 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;PhantomData&lt;<span class="type">i32</span>&gt;&gt;()); <span class="comment">// 0</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, size_of::&lt;[<span class="type">i32</span>; <span class="number">0</span>]&gt;());        <span class="comment">// 0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ZST 不占内存，但有唯一地址</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = Empty;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = Empty;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:p&#125;&quot;</span>, &amp;a);  <span class="comment">// 有地址</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:p&#125;&quot;</span>, &amp;b);  <span class="comment">// 不同地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="PhantomData-用途"><a href="#PhantomData-用途" class="headerlink" title="PhantomData 用途"></a>PhantomData 用途</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途1：标记未使用的类型参数 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Slice</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    ptr: *<span class="keyword">const</span> T,</span><br><span class="line">    len: <span class="type">usize</span>,</span><br><span class="line">    _marker: PhantomData&lt;&amp;<span class="symbol">&#x27;a</span> T&gt;,  <span class="comment">// 告诉编译器：我们&quot;拥有&quot; &amp;&#x27;a T</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途2：添加生命周期约束 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Iter</span>&lt;<span class="symbol">&#x27;a</span>, T&gt; &#123;</span><br><span class="line">    ptr: *<span class="keyword">const</span> T,</span><br><span class="line">    end: *<span class="keyword">const</span> T,</span><br><span class="line">    _marker: PhantomData&lt;&amp;<span class="symbol">&#x27;a</span> T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途3：类型状态模式 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Builder</span>&lt;State&gt; &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    _state: PhantomData&lt;State&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Initial</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Configured</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Built</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Builder</span>&lt;Initial&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Builder &#123; data: <span class="type">String</span>::<span class="title function_ invoke__">new</span>(), _state: PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">configure</span>(<span class="keyword">self</span>, data: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> Builder&lt;Configured&gt; &#123;</span><br><span class="line">        Builder &#123; data: data.<span class="title function_ invoke__">into</span>(), _state: PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Builder</span>&lt;Configured&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">build</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Builder&lt;Built&gt; &#123;</span><br><span class="line">        Builder &#123; data: <span class="keyword">self</span>.data, _state: PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途4：Drop 检查 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DropChecker</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: *<span class="keyword">mut</span> T,</span><br><span class="line">    _marker: PhantomData&lt;T&gt;,  <span class="comment">// 表示我们逻辑上拥有 T</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">DropChecker</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// 析构时可能访问 T 的内容</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123; std::ptr::<span class="title function_ invoke__">drop_in_place</span>(<span class="keyword">self</span>.ptr); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="PhantomData-变体"><a href="#PhantomData-变体" class="headerlink" title="PhantomData 变体"></a>PhantomData 变体</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Container</span>&lt;T&gt; &#123;</span><br><span class="line">    ptr: *<span class="keyword">const</span> T,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 不同的所有权语义</span></span><br><span class="line">    _owned: PhantomData&lt;T&gt;,       <span class="comment">// 拥有 T（会影响 drop check）</span></span><br><span class="line">    _<span class="keyword">ref</span>: PhantomData&lt;&amp;<span class="symbol">&#x27;static</span> T&gt;, <span class="comment">// 只是引用 T</span></span><br><span class="line">    _<span class="keyword">fn</span>: PhantomData&lt;<span class="title function_ invoke__">fn</span>(T)&gt;,      <span class="comment">// 协变</span></span><br><span class="line">    _fn_ret: PhantomData&lt;<span class="title function_ invoke__">fn</span>() <span class="punctuation">-&gt;</span> T&gt;, <span class="comment">// 逆变</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Newtype-模式"><a href="#Newtype-模式" class="headerlink" title="Newtype 模式"></a>Newtype 模式</h2><h3 id="基本定义"><a href="#基本定义" class="headerlink" title="基本定义"></a>基本定义</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Newtype：用元组结构体包装现有类型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">f64</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Seconds</span>(<span class="type">f64</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UserId</span>(<span class="type">u64</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Email</span>(<span class="type">String</span>);</span><br></pre></td></tr></table></figure></div>

<h3 id="核心用途"><a href="#核心用途" class="headerlink" title="核心用途"></a>核心用途</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ===== 用途1：类型安全，防止混淆 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">f64</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Feet</span>(<span class="type">f64</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">calculate_distance</span>(m: Meters) <span class="punctuation">-&gt;</span> Meters &#123;</span><br><span class="line">    <span class="title function_ invoke__">Meters</span>(m.<span class="number">0</span> * <span class="number">2.0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = <span class="title function_ invoke__">Meters</span>(<span class="number">100.0</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">f</span> = <span class="title function_ invoke__">Feet</span>(<span class="number">100.0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">calculate_distance</span>(m);  <span class="comment">// ✅</span></span><br><span class="line">    <span class="comment">// calculate_distance(f);  // ❌ 类型不匹配</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途2：为外部类型实现外部 trait（绕过孤儿规则）=====</span></span><br><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>(<span class="type">Vec</span>&lt;<span class="type">String</span>&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Wrapper</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;[&#123;&#125;]&quot;</span>, <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">join</span>(<span class="string">&quot;, &quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途3：隐藏内部实现 =====</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PublicApi</span>(InternalType);  <span class="comment">// InternalType 是私有的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途4：添加语义约束 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NonEmpty</span>&lt;T&gt;(<span class="type">Vec</span>&lt;T&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; NonEmpty&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(first: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">NonEmpty</span>(<span class="built_in">vec!</span>[first])</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">first</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span>[<span class="number">0</span>]  <span class="comment">// 永远安全，因为构造时保证非空</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 用途5：细化类型约束 =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SortedVec</span>&lt;T: <span class="built_in">Ord</span>&gt;(<span class="type">Vec</span>&lt;T&gt;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T: <span class="built_in">Ord</span>&gt; SortedVec&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(<span class="keyword">mut</span> v: <span class="type">Vec</span>&lt;T&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        v.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">        <span class="title function_ invoke__">SortedVec</span>(v)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">binary_search</span>(&amp;<span class="keyword">self</span>, x: &amp;T) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">binary_search</span>(x).<span class="title function_ invoke__">ok</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Newtype-便捷实现"><a href="#Newtype-便捷实现" class="headerlink" title="Newtype 便捷实现"></a>Newtype 便捷实现</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::&#123;Deref, DerefMut, Add&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Copy, PartialEq, PartialOrd)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">f64</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Deref 可透明访问内部值</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Deref</span> <span class="keyword">for</span> <span class="title class_">Meters</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = <span class="type">f64</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">f64</span> &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现运算符</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Add</span> <span class="keyword">for</span> <span class="title class_">Meters</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span> = <span class="keyword">Self</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(<span class="keyword">self</span>, other: <span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Meters</span>(<span class="keyword">self</span>.<span class="number">0</span> + other.<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From/Into 转换</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;<span class="type">f64</span>&gt; <span class="keyword">for</span> <span class="title class_">Meters</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(v: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Meters</span>(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;Meters&gt; <span class="keyword">for</span> <span class="title class_">f64</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(m: Meters) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        m.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span> = <span class="title function_ invoke__">Meters</span>(<span class="number">10.0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Deref 让我们可以直接调用 f64 的方法</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, m.<span class="title function_ invoke__">abs</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, m.<span class="title function_ invoke__">sin</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 运算</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">total</span> = <span class="title function_ invoke__">Meters</span>(<span class="number">10.0</span>) + <span class="title function_ invoke__">Meters</span>(<span class="number">20.0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span>: Meters = <span class="number">5.0</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span>: <span class="type">f64</span> = m.<span class="title function_ invoke__">into</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-derive-more-简化"><a href="#使用-derive-more-简化" class="headerlink" title="使用 derive_more 简化"></a>使用 derive_more 简化</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">derive_more</span> = <span class="string">&quot;0.99&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> derive_more::&#123;<span class="built_in">From</span>, <span class="built_in">Into</span>, Deref, DerefMut, Add, Display&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Clone, Copy, From, Into, Deref, Add, Display)]</span></span><br><span class="line"><span class="meta">#[display(fmt = <span class="string">&quot;&#123;&#125;m&quot;</span>, _0)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">f64</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m</span>: Meters = <span class="number">10.0</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span> = m + <span class="title function_ invoke__">Meters</span>(<span class="number">5.0</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, sum);  <span class="comment">// &quot;15m&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><h3 id="基本语法-4"><a href="#基本语法-4" class="headerlink" title="基本语法"></a>基本语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// type 关键字定义类型别名</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Kilometers</span> = <span class="type">i32</span>;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Thunk</span> = <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>() + <span class="built_in">Send</span> + <span class="symbol">&#x27;static</span>&gt;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Result</span>&lt;T&gt; = std::result::<span class="type">Result</span>&lt;T, std::io::Error&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: Kilometers = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">i32</span> = <span class="number">10</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 类型别名与原类型完全等价，可以互操作</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = x + y;  <span class="comment">// ✅ 都是 i32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="类型别名常见用途"><a href="#类型别名常见用途" class="headerlink" title="类型别名常见用途"></a>类型别名常见用途</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ===== 简化复杂类型 =====</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Callback</span> = <span class="type">Box</span>&lt;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> + <span class="built_in">Send</span> + <span class="built_in">Sync</span> + <span class="symbol">&#x27;static</span>&gt;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ParseResult</span>&lt;<span class="symbol">&#x27;a</span>&gt; = <span class="type">Result</span>&lt;(&amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>, Token), ParseError&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 模块级 Result 别名（std 库常用模式）=====</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">Result</span>&lt;T&gt; = std::result::<span class="type">Result</span>&lt;T, MyError&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">foo</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>&gt; &#123;  <span class="comment">// 等价于 Result&lt;i32, MyError&gt;</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 泛型别名 =====</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Pair</span>&lt;T&gt; = (T, T);</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">StringMap</span>&lt;V&gt; = std::collections::HashMap&lt;<span class="type">String</span>, V&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span>: Pair&lt;<span class="type">i32</span>&gt; = (<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">m</span>: StringMap&lt;<span class="type">i32</span>&gt; = StringMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    m.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;a&quot;</span>.<span class="title function_ invoke__">into</span>(), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== trait 关联类型别名 =====</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Container</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Item</span>;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Iter</span>&lt;<span class="symbol">&#x27;a</span>&gt;: <span class="built_in">Iterator</span>&lt;Item = &amp;<span class="symbol">&#x27;a</span> <span class="keyword">Self</span>::Item&gt; <span class="keyword">where</span> <span class="keyword">Self</span>: <span class="symbol">&#x27;a</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== never 类型别名 =====</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Never</span> = !;  <span class="comment">// 仅在 nightly</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="类型转换-1"><a href="#类型转换-1" class="headerlink" title="类型转换"></a>类型转换</h2><h3 id="as-强制转换"><a href="#as-强制转换" class="headerlink" title="as 强制转换"></a>as 强制转换</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ===== 数值类型转换 =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: <span class="type">i32</span> = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: <span class="type">i64</span> = a <span class="keyword">as</span> <span class="type">i64</span>;      <span class="comment">// 扩展</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span>: <span class="type">i16</span> = a <span class="keyword">as</span> <span class="type">i16</span>;      <span class="comment">// 截断（可能丢失数据）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">d</span>: <span class="type">f64</span> = a <span class="keyword">as</span> <span class="type">f64</span>;      <span class="comment">// 整数转浮点</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">e</span>: <span class="type">i32</span> = <span class="number">3.14</span> <span class="keyword">as</span> <span class="type">i32</span>;   <span class="comment">// 浮点转整数（截断小数）</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 指针转换 =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span>: *<span class="keyword">const</span> <span class="type">i32</span> = &amp;<span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span>: <span class="type">usize</span> = ptr <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr2</span>: *<span class="keyword">const</span> <span class="type">i32</span> = addr <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 引用转裸指针 =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span>: &amp;<span class="type">i32</span> = &amp;<span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span>: *<span class="keyword">const</span> <span class="type">i32</span> = r <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 枚举转整数 =====</span></span><br><span class="line">    <span class="meta">#[repr(u8)]</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Color</span> &#123; Red = <span class="number">1</span>, Green = <span class="number">2</span>, Blue = <span class="number">3</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span>: <span class="type">u8</span> = Color::Red <span class="keyword">as</span> <span class="type">u8</span>;  <span class="comment">// 1</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ===== 字符转换 =====</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span>: <span class="type">char</span> = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span>: <span class="type">u32</span> = c <span class="keyword">as</span> <span class="type">u32</span>;  <span class="comment">// 65</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c2</span>: <span class="type">char</span> = <span class="number">66u8</span> <span class="keyword">as</span> <span class="type">char</span>;  <span class="comment">// &#x27;B&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="From-Into-trait"><a href="#From-Into-trait" class="headerlink" title="From&#x2F;Into trait"></a>From&#x2F;Into trait</h3><ul>
<li><strong>消耗原值</strong>：调用 <em>.into()</em> 会获取所有权并转换为目标类型。</li>
<li><strong>自动实现</strong>：实现了 <em>From&lt;T&gt;</em> 的类型会自动拥有 *Into&lt;T&gt;*。</li>
<li><strong>泛型约束常用</strong>：在泛型函数中使用 <em>T: Into&lt;U&gt;</em> 可以让函数接受更多可转换的类型。</li>
</ul>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::convert::<span class="built_in">From</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 实现 From，自动获得 Into =====</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meters</span>(<span class="type">f64</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;<span class="type">f64</span>&gt; <span class="keyword">for</span> <span class="title class_">Meters</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(v: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Meters</span>(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">From</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">for</span> <span class="title class_">Meters</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from</span>(v: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Meters</span>(v <span class="keyword">as</span> <span class="type">f64</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// From</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m1</span> = Meters::<span class="title function_ invoke__">from</span>(<span class="number">10.5</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m2</span> = Meters::<span class="title function_ invoke__">from</span>(<span class="number">10</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Into（自动实现）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m3</span>: Meters = <span class="number">10.5</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">m4</span>: Meters = <span class="number">10</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 函数参数中使用 Into</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">process</span>(m: <span class="keyword">impl</span> <span class="title class_">Into</span>&lt;Meters&gt;) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">meters</span> = m.<span class="title function_ invoke__">into</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, meters.<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">process</span>(<span class="number">10.5</span>);   <span class="comment">// f64</span></span><br><span class="line">    <span class="title function_ invoke__">process</span>(<span class="number">10i32</span>);  <span class="comment">// i32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="TryFrom-TryInto（可能失败的转换）"><a href="#TryFrom-TryInto（可能失败的转换）" class="headerlink" title="TryFrom&#x2F;TryInto（可能失败的转换）"></a>TryFrom&#x2F;TryInto（可能失败的转换）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::convert::TryFrom;</span><br><span class="line"><span class="keyword">use</span> std::num::TryFromIntError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 标准库中的 TryFrom =====</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 可能失败的整数转换</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: <span class="type">i32</span> = <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: <span class="type">Result</span>&lt;<span class="type">u8</span>, _&gt; = <span class="type">u8</span>::<span class="title function_ invoke__">try_from</span>(a);  <span class="comment">// Err，溢出</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span>: <span class="type">i32</span> = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">d</span>: <span class="type">u8</span> = <span class="type">u8</span>::<span class="title function_ invoke__">try_from</span>(c).<span class="title function_ invoke__">unwrap</span>();    <span class="comment">// Ok(100)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// TryInto</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">e</span>: <span class="type">Result</span>&lt;<span class="type">u8</span>, _&gt; = a.<span class="title function_ invoke__">try_into</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 自定义 TryFrom =====</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PositiveInt</span>(<span class="type">i32</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NegativeError</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TryFrom</span>&lt;<span class="type">i32</span>&gt; <span class="keyword">for</span> <span class="title class_">PositiveInt</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Error</span> = NegativeError;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">try_from</span>(value: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="keyword">Self</span>, <span class="keyword">Self</span>::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> value &gt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">PositiveInt</span>(value))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(NegativeError)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">example</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span>: <span class="type">Result</span>&lt;PositiveInt, _&gt; = <span class="number">42</span>.<span class="title function_ invoke__">try_into</span>();      <span class="comment">// Ok</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span>: <span class="type">Result</span>&lt;PositiveInt, _&gt; = (-<span class="number">1</span>).<span class="title function_ invoke__">try_into</span>();    <span class="comment">// Err</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="AsRef-AsMut（廉价引用转换）"><a href="#AsRef-AsMut（廉价引用转换）" class="headerlink" title="AsRef&#x2F;AsMut（廉价引用转换）"></a>AsRef&#x2F;AsMut（廉价引用转换）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AsRef：借用转换，零成本</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_path</span>&lt;P: <span class="built_in">AsRef</span>&lt;std::path::Path&gt;&gt;(path: P) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">display</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">print_bytes</span>&lt;B: <span class="built_in">AsRef</span>&lt;[<span class="type">u8</span>]&gt;&gt;(bytes: B) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, bytes.<span class="title function_ invoke__">as_ref</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 多种类型都实现了 AsRef&lt;Path&gt;</span></span><br><span class="line">    <span class="title function_ invoke__">print_path</span>(<span class="string">&quot;hello.txt&quot;</span>);                    <span class="comment">// &amp;str</span></span><br><span class="line">    <span class="title function_ invoke__">print_path</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello.txt&quot;</span>));      <span class="comment">// String</span></span><br><span class="line">    <span class="title function_ invoke__">print_path</span>(std::path::Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;hello.txt&quot;</span>)); <span class="comment">// Path</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多种类型都实现了 AsRef&lt;[u8]&gt;</span></span><br><span class="line">    <span class="title function_ invoke__">print_bytes</span>(<span class="string">&quot;hello&quot;</span>);                       <span class="comment">// &amp;str</span></span><br><span class="line">    <span class="title function_ invoke__">print_bytes</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);                 <span class="comment">// Vec&lt;u8&gt;</span></span><br><span class="line">    <span class="title function_ invoke__">print_bytes</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);                     <span class="comment">// [u8; 3]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义实现</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyString</span>(<span class="type">String</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AsRef</span>&lt;<span class="type">str</span>&gt; <span class="keyword">for</span> <span class="title class_">MyString</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">as_ref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">AsRef</span>&lt;[<span class="type">u8</span>]&gt; <span class="keyword">for</span> <span class="title class_">MyString</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">as_ref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;[<span class="type">u8</span>] &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="number">0</span>.<span class="title function_ invoke__">as_bytes</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Borrow-BorrowMut"><a href="#Borrow-BorrowMut" class="headerlink" title="Borrow&#x2F;BorrowMut"></a>Borrow&#x2F;BorrowMut</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::borrow::Borrow;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Borrow 主要用于集合类型的键查找</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span>: HashMap&lt;<span class="type">String</span>, <span class="type">i32</span>&gt; = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;hello&quot;</span>.<span class="title function_ invoke__">into</span>(), <span class="number">42</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 可以用 &amp;str 查找 String 键</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;hello&quot;</span>);  <span class="comment">// 不需要创建 String</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 这得益于 String: Borrow&lt;str&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Borrow vs AsRef</span></span><br><span class="line"><span class="comment">// - Borrow 有额外约束：Hash/Eq/Ord 必须一致</span></span><br><span class="line"><span class="comment">// - AsRef 是纯粹的引用转换</span></span><br></pre></td></tr></table></figure></div>

<h3 id="Deref-强制转换-1"><a href="#Deref-强制转换-1" class="headerlink" title="Deref 强制转换"></a>Deref 强制转换</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ops::Deref;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyBox</span>&lt;T&gt;(T);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Deref <span class="keyword">for</span> <span class="title class_">MyBox</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Target</span> = T;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">deref</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">hello</span>(name: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;&quot;</span>, name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="title function_ invoke__">MyBox</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;world&quot;</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Deref 强制转换链：</span></span><br><span class="line">    <span class="comment">// &amp;MyBox&lt;String&gt; -&gt; &amp;String -&gt; &amp;str</span></span><br><span class="line">    <span class="title function_ invoke__">hello</span>(&amp;s);  <span class="comment">// ✅ 自动解引用</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等价于</span></span><br><span class="line">    <span class="title function_ invoke__">hello</span>(&amp;(*s)[..]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="类型转换总结"><a href="#类型转换总结" class="headerlink" title="类型转换总结"></a>类型转换总结</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      类型转换方式对比                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  方式          成本      安全性    用途                             │</span><br><span class="line">│  ──────────────────────────────────────────────────────────────     │</span><br><span class="line">│  as            零/低     不安全    原始类型转换、指针转换            │</span><br><span class="line">│  From/Into     可变      安全      值类型转换（不会失败）            │</span><br><span class="line">│  TryFrom/Into  可变      安全      可能失败的转换                    │</span><br><span class="line">│  AsRef/AsMut   零        安全      引用借用                          │</span><br><span class="line">│  Borrow        零        安全      集合键查找                        │</span><br><span class="line">│  Deref         零        安全      智能指针透明访问                  │</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│  转换关系链：                                                       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│  From&lt;T&gt; ──自动实现──&gt; Into&lt;T&gt;                                      │</span><br><span class="line">│  TryFrom&lt;T&gt; ──自动实现──&gt; TryInto&lt;T&gt;                                │</span><br><span class="line">│  Deref ──启用──&gt; 自动解引用强制转换                                  │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="进阶模式"><a href="#进阶模式" class="headerlink" title="进阶模式"></a>进阶模式</h2><h3 id="类型状态模式（Typestate-Pattern）"><a href="#类型状态模式（Typestate-Pattern）" class="headerlink" title="类型状态模式（Typestate Pattern）"></a>类型状态模式（Typestate Pattern）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态类型（零大小）</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Locked</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Unlocked</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Door</span>&lt;State&gt; &#123;</span><br><span class="line">    _state: PhantomData&lt;State&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Door</span>&lt;Locked&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">unlock</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Door&lt;Unlocked&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Unlocking...&quot;</span>);</span><br><span class="line">        Door &#123; _state: PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Door</span>&lt;Unlocked&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">lock</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Door&lt;Locked&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Locking...&quot;</span>);</span><br><span class="line">        Door &#123; _state: PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">open</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Opening door&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">new_door</span>() <span class="punctuation">-&gt;</span> Door&lt;Locked&gt; &#123;</span><br><span class="line">    Door &#123; _state: PhantomData &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">door</span> = <span class="title function_ invoke__">new_door</span>();        <span class="comment">// Locked</span></span><br><span class="line">    <span class="comment">// door.open();               // ❌ 编译错误！</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">door</span> = door.<span class="title function_ invoke__">unlock</span>();     <span class="comment">// Unlocked</span></span><br><span class="line">    door.<span class="title function_ invoke__">open</span>();                  <span class="comment">// ✅</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">door</span> = door.<span class="title function_ invoke__">lock</span>();       <span class="comment">// Locked</span></span><br><span class="line">    <span class="comment">// door.open();               // ❌ 又不能开了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="透明-Newtype"><a href="#透明-Newtype" class="headerlink" title="透明 Newtype"></a>透明 Newtype</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[repr(transparent)]</span>  <span class="comment">// 保证与内部类型有相同的内存布局</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>(<span class="type">u32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这允许安全的指针转换</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Wrapper</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_ref</span>(r: &amp;<span class="type">u32</span>) <span class="punctuation">-&gt;</span> &amp;Wrapper &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*(r <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span> <span class="keyword">as</span> *<span class="keyword">const</span> Wrapper) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_slice</span>(s: &amp;[<span class="type">u32</span>]) <span class="punctuation">-&gt;</span> &amp;[Wrapper] &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; std::mem::<span class="title function_ invoke__">transmute</span>(s) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="不可构造类型"><a href="#不可构造类型" class="headerlink" title="不可构造类型"></a>不可构造类型</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用枚举创建不可构造的类型</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Void</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用 never 类型（nightly）</span></span><br><span class="line"><span class="comment">// type Never = !;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用途：标记不可能发生的情况</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">diverge</span>() <span class="punctuation">-&gt;</span> Void &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;  <span class="comment">// 永不返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result&lt;T, Void&gt; 表示不可能失败</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">always_works</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, Void&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(<span class="number">42</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 可以安全地 unwrap，因为 Err 情况不可能发生</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = <span class="title function_ invoke__">always_works</span>().<span class="title function_ invoke__">unwrap_or_else</span>(|void| <span class="keyword">match</span> void &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h1 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h1><h2 id="核心概念对比"><a href="#核心概念对比" class="headerlink" title="核心概念对比"></a>核心概念对比</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Rust 全局变量方案                                │</span><br><span class="line">├──────────────┬──────────────┬───────────────┬──────────────────────┤</span><br><span class="line">│    方案       │   可变性     │   初始化时机   │      线程安全        │</span><br><span class="line">├──────────────┼──────────────┼───────────────┼──────────────────────┤</span><br><span class="line">│ const        │   不可变     │   编译期       │      ✓              │</span><br><span class="line">│ static       │   不可变     │   编译期       │      ✓              │</span><br><span class="line">│ static mut   │   可变       │   编译期       │      ✗ (unsafe)     │</span><br><span class="line">│ lazy_static! │   不可变*    │   首次访问     │      ✓              │</span><br><span class="line">│ OnceLock     │   不可变*    │   首次访问     │      ✓ (std 1.70+)  │</span><br><span class="line">│ Mutex/RwLock │   可变       │   首次访问     │      ✓              │</span><br><span class="line">└──────────────┴──────────────┴───────────────┴──────────────────────┘</span><br><span class="line">                              * 内部可变性除外</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="基础：const-vs-static"><a href="#基础：const-vs-static" class="headerlink" title="基础：const vs static"></a>基础：const vs static</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ const：编译期常量（内联替换）============</span></span><br><span class="line"><span class="keyword">const</span> MAX_SIZE: <span class="type">usize</span> = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">const</span> PI: <span class="type">f64</span> = <span class="number">3.14159265359</span>;</span><br><span class="line"><span class="keyword">const</span> GREETING: &amp;<span class="type">str</span> = <span class="string">&quot;Hello, Rust!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ static：固定内存地址 ============</span></span><br><span class="line"><span class="keyword">static</span> VERSION: &amp;<span class="type">str</span> = <span class="string">&quot;1.0.0&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> COUNTER_INIT: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// const 会被内联，每次使用可能复制值</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Max: &#123;&#125;&quot;</span>, MAX_SIZE);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// static 有固定地址，可以取引用</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ver_ptr</span>: &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> = VERSION;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Version at &#123;:p&#125;&quot;</span>, ver_ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>选择原则</strong>：</p>
<ul>
<li>简单标量&#x2F;字符串 → 优先用 <code>const</code></li>
<li>需要固定地址或大型数据 → 用 <code>static</code></li>
</ul>
<hr>
<h2 id="可变全局变量（危险区域）"><a href="#可变全局变量（危险区域）" class="headerlink" title="可变全局变量（危险区域）"></a>可变全局变量（危险区域）</h2><h3 id="static-mut（不推荐）"><a href="#static-mut（不推荐）" class="headerlink" title="static mut（不推荐）"></a>static mut（不推荐）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> COUNTER: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        COUNTER += <span class="number">1</span>;  <span class="comment">// 必须在 unsafe 块中</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Counter: &#123;&#125;&quot;</span>, COUNTER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ⚠️ 问题：多线程下是数据竞争，完全由程序员保证安全</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="安全的运行时初始化方案"><a href="#安全的运行时初始化方案" class="headerlink" title="安全的运行时初始化方案"></a>安全的运行时初始化方案</h2><h3 id="std-sync-OnceLock"><a href="#std-sync-OnceLock" class="headerlink" title="std::sync::OnceLock"></a>std::sync::OnceLock</h3><p><strong>Rust 1.70+ 推荐：</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::OnceLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂类型的全局变量</span></span><br><span class="line"><span class="keyword">static</span> CONFIG: OnceLock&lt;Config&gt; = OnceLock::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">    db_url: <span class="type">String</span>,</span><br><span class="line">    max_conn: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_config</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> Config &#123;</span><br><span class="line">    CONFIG.<span class="title function_ invoke__">get_or_init</span>(|| &#123;</span><br><span class="line">        <span class="comment">// 只执行一次，线程安全</span></span><br><span class="line">        Config &#123;</span><br><span class="line">            db_url: std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;DB_URL&quot;</span>).<span class="title function_ invoke__">unwrap_or_default</span>(),</span><br><span class="line">            max_conn: <span class="number">100</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;DB: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">get_config</span>().db_url);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Max: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">get_config</span>().max_conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="lazy-static"><a href="#lazy-static" class="headerlink" title="lazy_static!"></a>lazy_static!</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: lazy_static = &quot;1.4&quot;</span></span><br><span class="line"><span class="keyword">use</span> lazy_static::lazy_static;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> CACHE: HashMap&lt;&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>, <span class="type">i32</span>&gt; = &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">m</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        m.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;one&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        m.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;two&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        m</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> REGEX: regex::Regex = </span><br><span class="line">        regex::Regex::<span class="title function_ invoke__">new</span>(<span class="string">r&quot;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;$&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;one = &#123;&#125;&quot;</span>, CACHE.<span class="title function_ invoke__">get</span>(<span class="string">&quot;one&quot;</span>).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Valid: &#123;&#125;&quot;</span>, REGEX.<span class="title function_ invoke__">is_match</span>(<span class="string">&quot;2024-01-15&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="once-cell"><a href="#once-cell" class="headerlink" title="once_cell"></a>once_cell</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: once_cell = &quot;1.19&quot;</span></span><br><span class="line"><span class="keyword">use</span> once_cell::sync::Lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> LOGGER: Lazy&lt;Logger&gt; = Lazy::<span class="title function_ invoke__">new</span>(|| &#123;</span><br><span class="line">    Logger::<span class="title function_ invoke__">new</span>(<span class="string">&quot;app.log&quot;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部懒加载也可以</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">expensive_computation</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> RESULT: Lazy&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt; = Lazy::<span class="title function_ invoke__">new</span>(|| &#123;</span><br><span class="line">        (<span class="number">0</span>..<span class="number">1000000</span>).<span class="title function_ invoke__">collect</span>()</span><br><span class="line">    &#125;);</span><br><span class="line">    &amp;RESULT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="线程安全的可变全局变量"><a href="#线程安全的可变全局变量" class="headerlink" title="线程安全的可变全局变量"></a>线程安全的可变全局变量</h2><h3 id="Mutex-方案"><a href="#Mutex-方案" class="headerlink" title="Mutex 方案"></a>Mutex 方案</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">use</span> std::sync::OnceLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> GLOBAL_STATE: OnceLock&lt;Mutex&lt;AppState&gt;&gt; = OnceLock::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AppState</span> &#123;</span><br><span class="line">    count: <span class="type">u64</span>,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">state</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> Mutex&lt;AppState&gt; &#123;</span><br><span class="line">    GLOBAL_STATE.<span class="title function_ invoke__">get_or_init</span>(|| &#123;</span><br><span class="line">        Mutex::<span class="title function_ invoke__">new</span>(AppState &#123;</span><br><span class="line">            count: <span class="number">0</span>,</span><br><span class="line">            name: <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;App&quot;</span>),</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 安全地修改全局状态</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="title function_ invoke__">state</span>().<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        s.count += <span class="number">1</span>;</span><br><span class="line">        s.name = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;Updated&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Count: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">state</span>().<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>().count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="RwLock"><a href="#RwLock" class="headerlink" title="RwLock"></a>RwLock</h3><p>读多写少场景。</p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::RwLock;</span><br><span class="line"><span class="keyword">use</span> once_cell::sync::Lazy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> SETTINGS: Lazy&lt;RwLock&lt;Settings&gt;&gt; = Lazy::<span class="title function_ invoke__">new</span>(|| &#123;</span><br><span class="line">    RwLock::<span class="title function_ invoke__">new</span>(Settings::<span class="title function_ invoke__">default</span>())</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Default)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Settings</span> &#123;</span><br><span class="line">    debug: <span class="type">bool</span>,</span><br><span class="line">    level: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 多线程可同时读</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">debug</span> = SETTINGS.<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">unwrap</span>().debug;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 独占写</span></span><br><span class="line">    SETTINGS.<span class="title function_ invoke__">write</span>().<span class="title function_ invoke__">unwrap</span>().level = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="原子类型"><a href="#原子类型" class="headerlink" title="原子类型"></a>原子类型</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicU64, Ordering&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> REQUEST_COUNT: AtomicU64 = AtomicU64::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">handle_request</span>() &#123;</span><br><span class="line">    REQUEST_COUNT.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::Relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">handle_request</span>();</span><br><span class="line">    <span class="title function_ invoke__">handle_request</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Total requests: &#123;&#125;&quot;</span>, REQUEST_COUNT.<span class="title function_ invoke__">load</span>(Ordering::Relaxed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="方案选择流程图"><a href="#方案选择流程图" class="headerlink" title="方案选择流程图"></a>方案选择流程图</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">需要全局变量？</span><br><span class="line">    │</span><br><span class="line">    ├── 编译期已知值？</span><br><span class="line">    │       ├── 是 → const（简单值）或 static（需要地址）</span><br><span class="line">    │       └── 否 ↓</span><br><span class="line">    │</span><br><span class="line">    ├── 运行时初始化，只读？</span><br><span class="line">    │       └── OnceLock / Lazy / lazy_static!</span><br><span class="line">    │</span><br><span class="line">    ├── 需要可变？</span><br><span class="line">    │       ├── 简单整数 → AtomicXxx</span><br><span class="line">    │       ├── 读多写少 → RwLock&lt;T&gt;</span><br><span class="line">    │       └── 一般情况 → Mutex&lt;T&gt;</span><br><span class="line">    │</span><br><span class="line">    └── 避免全局变量？</span><br><span class="line">            └── 依赖注入 / 传参（最佳实践）</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>⚠️ <strong>黄金法则</strong>：尽量避免全局可变状态，优先使用依赖注入传递配置和状态。全局变量会增加代码耦合度和测试难度。</p>
</blockquote>
<h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><h2 id="核心概念总览"><a href="#核心概念总览" class="headerlink" title="核心概念总览"></a>核心概念总览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Rust 并发安全保证                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│   编译期检查: Send + Sync trait → 消除数据竞争                           │</span><br><span class="line">│   运行时保护: Mutex / RwLock / Atomic → 安全共享可变状态                  │</span><br><span class="line">│   所有权转移: move 闭包 → 明确数据归属                                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌──────────────┐     ┌──────────────┐     ┌──────────────┐</span><br><span class="line">│   消息传递    │     │   共享状态    │     │   原子操作    │</span><br><span class="line">│   (Channel)  │     │ (Mutex/Arc)  │     │  (Atomic*)   │</span><br><span class="line">├──────────────┤     ├──────────────┤     ├──────────────┤</span><br><span class="line">│ 无共享，安全  │     │ 锁保护，灵活  │     │ 无锁，高性能  │</span><br><span class="line">│ 适合流水线    │     │ 适合复杂状态  │     │ 适合简单计数  │</span><br><span class="line">└──────────────┘     └──────────────┘     └──────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="线程基础"><a href="#线程基础" class="headerlink" title="线程基础"></a>线程基础</h2><h3 id="创建与等待"><a href="#创建与等待" class="headerlink" title="创建与等待"></a>创建与等待</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建线程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">5</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;子线程: &#123;&#125;&quot;</span>, i);</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="number">42</span>  <span class="comment">// 返回值</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主线程工作</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">1</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;主线程: &#123;&#125;&quot;</span>, i);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">150</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待并获取返回值</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;子线程返回: &#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="move-闭包-——-转移所有权"><a href="#move-闭包-——-转移所有权" class="headerlink" title="move 闭包 —— 转移所有权"></a>move 闭包 —— 转移所有权</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 错误：闭包可能比 data 活得久</span></span><br><span class="line">    <span class="comment">// let handle = thread::spawn(|| &#123;</span></span><br><span class="line">    <span class="comment">//     println!(&quot;&#123;:?&#125;&quot;, data);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 正确：move 转移所有权</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, data);  <span class="comment">// data 现在属于子线程</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// println!(&quot;&#123;:?&#125;&quot;, data);  // ❌ data 已被移动</span></span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="线程配置"><a href="#线程配置" class="headerlink" title="线程配置"></a>线程配置</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">builder</span> = thread::Builder::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">name</span>(<span class="string">&quot;worker-1&quot;</span>.<span class="title function_ invoke__">into</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stack_size</span>(<span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>);  <span class="comment">// 4MB 栈</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle</span> = builder.<span class="title function_ invoke__">spawn</span>(|| &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;线程名: &#123;:?&#125;&quot;</span>, thread::<span class="title function_ invoke__">current</span>().<span class="title function_ invoke__">name</span>());</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;线程ID: &#123;:?&#125;&quot;</span>, thread::<span class="title function_ invoke__">current</span>().<span class="title function_ invoke__">id</span>());</span><br><span class="line">    &#125;).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取 CPU 核心数</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;CPU 核心数: &#123;&#125;&quot;</span>, thread::<span class="title function_ invoke__">available_parallelism</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="消息传递（Channel）"><a href="#消息传递（Channel）" class="headerlink" title="消息传递（Channel）"></a>消息传递（Channel）</h2><h3 id="多生产者单消费者（mpsc）"><a href="#多生产者单消费者（mpsc）" class="headerlink" title="多生产者单消费者（mpsc）"></a>多生产者单消费者（mpsc）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建通道</span></span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生产者线程</span></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">messages</span> = <span class="built_in">vec!</span>[<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;from&quot;</span>, <span class="string">&quot;thread&quot;</span>];</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">msg</span> <span class="keyword">in</span> messages &#123;</span><br><span class="line">            tx.<span class="title function_ invoke__">send</span>(msg).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// tx 被 drop，通道关闭</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 消费者（主线程）</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">received</span> <span class="keyword">in</span> rx &#123;  <span class="comment">// 迭代器方式接收</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;收到: &#123;&#125;&quot;</span>, received);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="多生产者"><a href="#多生产者" class="headerlink" title="多生产者"></a>多生产者</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 克隆发送端给多个生产者</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">id</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tx_clone</span> = tx.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            tx_clone.<span class="title function_ invoke__">send</span>(<span class="built_in">format!</span>(<span class="string">&quot;来自线程 &#123;&#125;&quot;</span>, id)).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">drop</span>(tx);  <span class="comment">// 重要：丢弃原始发送端</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">msg</span> <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="同步通道（有界）"><a href="#同步通道（有界）" class="headerlink" title="同步通道（有界）"></a>同步通道（有界）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 容量为 2 的有界通道</span></span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">sync_channel</span>(<span class="number">2</span>);</span><br><span class="line">  </span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">5</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;发送 &#123;&#125;&quot;</span>, i);</span><br><span class="line">            tx.<span class="title function_ invoke__">send</span>(i).<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 满了会阻塞</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;已发送 &#123;&#125;&quot;</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">val</span> <span class="keyword">in</span> rx &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;收到: &#123;&#125;&quot;</span>, val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Channel-方法对比"><a href="#Channel-方法对比" class="headerlink" title="Channel 方法对比"></a>Channel 方法对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┬─────────────────────────────────────────────┐</span><br><span class="line">│    方法      │                   行为                      │</span><br><span class="line">├─────────────┼─────────────────────────────────────────────┤</span><br><span class="line">│ send()      │ 发送，通道关闭返回 Err                        │</span><br><span class="line">│ recv()      │ 阻塞接收，通道关闭返回 Err                    │</span><br><span class="line">│ try_recv()  │ 非阻塞，无数据返回 Err(TryRecvError::Empty)  │</span><br><span class="line">│ recv_timeout() │ 超时接收                                  │</span><br><span class="line">│ iter()      │ 阻塞迭代器，通道关闭结束                      │</span><br><span class="line">│ try_iter()  │ 非阻塞迭代器                                 │</span><br><span class="line">└─────────────┴─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="共享状态"><a href="#共享状态" class="headerlink" title="共享状态"></a>共享状态</h2><h3 id="Arc-Mutex"><a href="#Arc-Mutex" class="headerlink" title="Arc + Mutex"></a>Arc + Mutex</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Arc: 原子引用计数，跨线程共享</span></span><br><span class="line">    <span class="comment">// Mutex: 互斥锁，保护内部数据</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);  <span class="comment">// 克隆 Arc（引用计数+1）</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">handle</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">num</span> = counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 获取锁</span></span><br><span class="line">            *num += <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 锁在 num 离开作用域时自动释放</span></span><br><span class="line">        &#125;);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(handle);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">handle</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        handle.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;结果: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>());  <span class="comment">// 输出: 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="RwLock-1"><a href="#RwLock-1" class="headerlink" title="RwLock"></a>RwLock</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, RwLock&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Arc::<span class="title function_ invoke__">new</span>(RwLock::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]));</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多个读者</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;data);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">read_guard</span> = data.<span class="title function_ invoke__">read</span>().<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 共享读锁</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;读者 &#123;&#125;: &#123;:?&#125;&quot;</span>, i, *read_guard);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 一个写者</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">data</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;data);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">write_guard</span> = data.<span class="title function_ invoke__">write</span>().<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 独占写锁</span></span><br><span class="line">            write_guard.<span class="title function_ invoke__">push</span>(<span class="number">4</span>);</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;写者: 已添加 4&quot;</span>);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">h</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        h.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="锁的注意事项"><a href="#锁的注意事项" class="headerlink" title="锁的注意事项"></a>锁的注意事项</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">5</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 死锁示例：同一线程重复获取非可重入锁</span></span><br><span class="line">    <span class="comment">// let _a = data.lock().unwrap();</span></span><br><span class="line">    <span class="comment">// let _b = data.lock().unwrap();  // 死锁！</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 正确：尽快释放锁</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        *guard += <span class="number">1</span>;</span><br><span class="line">    &#125;  <span class="comment">// 锁在这里释放</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 处理中毒的锁（某线程 panic 时锁会中毒）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = data.<span class="title function_ invoke__">lock</span>();</span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(guard) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;值: &#123;&#125;&quot;</span>, *guard),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(poisoned) =&gt; &#123;</span><br><span class="line">            <span class="comment">// 选择恢复或传播</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">guard</span> = poisoned.<span class="title function_ invoke__">into_inner</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;恢复中毒锁，值: &#123;&#125;&quot;</span>, *guard);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicUsize, AtomicBool, Ordering&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">running</span> = Arc::<span class="title function_ invoke__">new</span>(AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">true</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 工作线程</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">4</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">running</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;running);</span><br><span class="line">      </span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">while</span> running.<span class="title function_ invoke__">load</span>(Ordering::Relaxed) &#123;</span><br><span class="line">                counter.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">                <span class="keyword">if</span> counter.<span class="title function_ invoke__">load</span>(Ordering::SeqCst) &gt;= <span class="number">100</span> &#123;</span><br><span class="line">                    running.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::Relaxed);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">h</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        h.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最终计数: &#123;&#125;&quot;</span>, counter.<span class="title function_ invoke__">load</span>(Ordering::SeqCst));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Ordering-说明"><a href="#Ordering-说明" class="headerlink" title="Ordering 说明"></a>Ordering 说明</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┬────────────────────────────────────────────┐</span><br><span class="line">│   Ordering   │                 语义                        │</span><br><span class="line">├──────────────┼────────────────────────────────────────────┤</span><br><span class="line">│ Relaxed      │ 最弱，仅保证原子性，不保证顺序               │</span><br><span class="line">│ Acquire      │ 读操作，阻止后续操作重排到此之前             │</span><br><span class="line">│ Release      │ 写操作，阻止之前操作重排到此之后             │</span><br><span class="line">│ AcqRel       │ 同时 Acquire + Release                     │</span><br><span class="line">│ SeqCst       │ 最强，全局顺序一致（默认安全选择）            │</span><br><span class="line">└──────────────┴────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="同步原语"><a href="#同步原语" class="headerlink" title="同步原语"></a>同步原语</h2><h3 id="Barrier（屏障）"><a href="#Barrier（屏障）" class="headerlink" title="Barrier（屏障）"></a>Barrier（屏障）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Barrier&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">barrier</span> = Arc::<span class="title function_ invoke__">new</span>(Barrier::<span class="title function_ invoke__">new</span>(<span class="number">3</span>));  <span class="comment">// 等待 3 个线程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">handles</span> = <span class="built_in">vec!</span>[];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">barrier</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;barrier);</span><br><span class="line">        handles.<span class="title function_ invoke__">push</span>(thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;线程 &#123;&#125; 阶段1完成&quot;</span>, i);</span><br><span class="line">            barrier.<span class="title function_ invoke__">wait</span>();  <span class="comment">// 所有线程都到达后才继续</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;线程 &#123;&#125; 阶段2开始&quot;</span>, i);</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">h</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        h.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Condvar（条件变量）"><a href="#Condvar（条件变量）" class="headerlink" title="Condvar（条件变量）"></a>Condvar（条件变量）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::&#123;Arc, Mutex, Condvar&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pair</span> = Arc::<span class="title function_ invoke__">new</span>((Mutex::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>), Condvar::<span class="title function_ invoke__">new</span>()));</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待线程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pair_clone</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;pair);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">waiter</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">let</span> (lock, cvar) = &amp;*pair_clone;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ready</span> = lock.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">while</span> !*ready &#123;</span><br><span class="line">            ready = cvar.<span class="title function_ invoke__">wait</span>(ready).<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 释放锁并等待</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;收到通知，继续执行！&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 通知线程</span></span><br><span class="line">    thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">let</span> (lock, cvar) = &amp;*pair;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ready</span> = lock.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        *ready = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cvar.<span class="title function_ invoke__">notify_one</span>();  <span class="comment">// 或 notify_all()</span></span><br><span class="line">  </span><br><span class="line">    waiter.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="线程池（Rayon）"><a href="#线程池（Rayon）" class="headerlink" title="线程池（Rayon）"></a>线程池（Rayon）</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: rayon = &quot;1.8&quot;</span></span><br><span class="line"><span class="keyword">use</span> rayon::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 并行迭代器</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span>: <span class="type">i64</span> = (<span class="number">1</span>..<span class="number">1_000_000i64</span>)</span><br><span class="line">        .<span class="title function_ invoke__">into_par_iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(|&amp;x| x % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|x| x * x)</span><br><span class="line">        .<span class="title function_ invoke__">sum</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;平方和: &#123;&#125;&quot;</span>, sum);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 并行排序</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = (<span class="number">0</span>..<span class="number">100000</span>).<span class="title function_ invoke__">rev</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    data.<span class="title function_ invoke__">par_sort</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 并行执行两个任务</span></span><br><span class="line">    <span class="keyword">let</span> (a, b) = rayon::<span class="title function_ invoke__">join</span>(</span><br><span class="line">        || <span class="title function_ invoke__">expensive_computation_a</span>(),</span><br><span class="line">        || <span class="title function_ invoke__">expensive_computation_b</span>(),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">expensive_computation_a</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; <span class="number">1</span> &#125;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">expensive_computation_b</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Send-和-Sync"><a href="#Send-和-Sync" class="headerlink" title="Send 和 Sync"></a>Send 和 Sync</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">┌─────────────────────────────────────────────────────────────────┐</span></span><br><span class="line"><span class="comment">│  Send: 类型可以安全地转移到另一个线程                             │</span></span><br><span class="line"><span class="comment">│  Sync: 类型可以安全地被多个线程同时引用（&amp;T 是 Send）              │</span></span><br><span class="line"><span class="comment">├─────────────────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">│  T: Send + Sync    →  可以跨线程移动和共享                       │</span></span><br><span class="line"><span class="comment">│  T: Send + !Sync   →  可以跨线程移动，不能共享引用（如 Cell）      │</span></span><br><span class="line"><span class="comment">│  T: !Send + Sync   →  罕见                                      │</span></span><br><span class="line"><span class="comment">│  T: !Send + !Sync  →  只能单线程使用（如 Rc, *mut T）            │</span></span><br><span class="line"><span class="comment">└─────────────────────────────────────────────────────────────────┘</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ❌ Rc 不是 Send，不能跨线程</span></span><br><span class="line">    <span class="comment">// let rc = Rc::new(5);</span></span><br><span class="line">    <span class="comment">// thread::spawn(move || println!(&quot;&#123;&#125;&quot;, rc));</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ Arc 是 Send + Sync</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arc</span> = Arc::<span class="title function_ invoke__">new</span>(<span class="number">5</span>);</span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, arc)).<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ RefCell 不是 Sync，不能多线程共享引用</span></span><br><span class="line">    <span class="comment">// 如需要，使用 Mutex&lt;T&gt; 或 RwLock&lt;T&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见模式-2"><a href="#常见模式-2" class="headerlink" title="常见模式"></a>常见模式</h2><h3 id="生产者-消费者"><a href="#生产者-消费者" class="headerlink" title="生产者-消费者"></a>生产者-消费者</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = mpsc::<span class="title function_ invoke__">channel</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多个生产者</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tx</span> = tx.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">j</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">                tx.<span class="title function_ invoke__">send</span>((i, j)).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(tx);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 单个消费者</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>((producer, item)) = rx.<span class="title function_ invoke__">recv</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;生产者 &#123;&#125; 产出 &#123;&#125;&quot;</span>, producer, item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="工作窃取模式（crossbeam）"><a href="#工作窃取模式（crossbeam）" class="headerlink" title="工作窃取模式（crossbeam）"></a>工作窃取模式（crossbeam）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: crossbeam = &quot;0.8&quot;</span></span><br><span class="line"><span class="keyword">use</span> crossbeam::channel;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = channel::<span class="title function_ invoke__">unbounded</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 分发任务</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(i).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(tx);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多个 worker 从同一队列取任务</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handles</span>: <span class="type">Vec</span>&lt;_&gt; = (<span class="number">0</span>..<span class="number">4</span>).<span class="title function_ invoke__">map</span>(|id| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">rx</span> = rx.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>(task) = rx.<span class="title function_ invoke__">recv</span>() &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Worker &#123;&#125; 处理任务 &#123;&#125;&quot;</span>, id, task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">h</span> <span class="keyword">in</span> handles &#123;</span><br><span class="line">        h.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="总结对比"><a href="#总结对比" class="headerlink" title="总结对比"></a>总结对比</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────┬─────────────────┬─────────────────┬─────────────────┐</span><br><span class="line">│     方案        │      适用场景    │      性能       │     复杂度      │</span><br><span class="line">├────────────────┼─────────────────┼─────────────────┼─────────────────┤</span><br><span class="line">│ thread::spawn  │ 少量长期任务     │ 中等            │ 低              │</span><br><span class="line">│ mpsc::channel  │ 生产者-消费者    │ 中等            │ 低              │</span><br><span class="line">│ Arc&lt;Mutex&lt;T&gt;&gt;  │ 共享可变状态     │ 中等            │ 中              │</span><br><span class="line">│ Arc&lt;RwLock&lt;T&gt;&gt; │ 读多写少         │ 较高            │ 中              │</span><br><span class="line">│ Atomic*        │ 简单计数/标志    │ 高              │ 中              │</span><br><span class="line">│ Rayon          │ 数据并行         │ 高              │ 低              │</span><br><span class="line">│ crossbeam      │ 复杂并发         │ 高              │ 中              │</span><br><span class="line">└────────────────┴─────────────────┴─────────────────┴─────────────────┘</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>黄金法则</strong>：优先消息传递，必要时再用共享状态；优先用高级抽象（Rayon），避免手动管理线程。</p>
</blockquote>
<h1 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h1><h2 id="核心概念总览-1"><a href="#核心概念总览-1" class="headerlink" title="核心概念总览"></a>核心概念总览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Rust 多进程体系                                   │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  std::process::Command  →  创建和管理子进程                              │</span><br><span class="line">│  std::process::Child    →  子进程句柄                                    │</span><br><span class="line">│  std::process::Stdio    →  标准输入/输出/错误配置                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">┌──────────────┐     ┌──────────────┐     ┌──────────────┐</span><br><span class="line">│    管道       │     │   共享内存    │     │  Socket/文件  │</span><br><span class="line">│   (Pipe)     │     │ (SharedMem)  │     │   (IPC)      │</span><br><span class="line">├──────────────┤     ├──────────────┤     ├──────────────┤</span><br><span class="line">│ 父子进程通信  │     │ 高性能数据    │     │ 任意进程通信  │</span><br><span class="line">│ 简单易用      │     │ 交换          │     │ 灵活通用      │</span><br><span class="line">└──────────────┘     └──────────────┘     └──────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="创建子进程"><a href="#创建子进程" class="headerlink" title="创建子进程"></a>创建子进程</h2><h3 id="简单执行命令"><a href="#简单执行命令" class="headerlink" title="简单执行命令"></a>简单执行命令</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 最简单的方式：执行并等待</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;echo&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;Hello, Rust!&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;执行失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;退出状态: &#123;&#125;&quot;</span>, status);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;成功: &#123;&#125;&quot;</span>, status.<span class="title function_ invoke__">success</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取退出码</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(code) = status.<span class="title function_ invoke__">code</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;退出码: &#123;&#125;&quot;</span>, code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="获取输出"><a href="#获取输出" class="headerlink" title="获取输出"></a>获取输出</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// output() 捕获 stdout 和 stderr</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-la&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;/tmp&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">output</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;执行失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;状态: &#123;&#125;&quot;</span>, output.status);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;stdout:\n&#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;stderr:\n&#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stderr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="命令构建详解"><a href="#命令构建详解" class="headerlink" title="命令构建详解"></a>命令构建详解</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"><span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line"><span class="keyword">use</span> std::path::Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cmd</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;python3&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 添加参数</span></span><br><span class="line">    cmd.<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-c&quot;</span>)</span><br><span class="line">       .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;import os; print(os.getcwd())&quot;</span>)</span><br><span class="line">       <span class="comment">// 或批量添加</span></span><br><span class="line">       .<span class="title function_ invoke__">args</span>([<span class="string">&quot;-v&quot;</span>, <span class="string">&quot;--version&quot;</span>]);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 设置环境变量</span></span><br><span class="line">    cmd.<span class="title function_ invoke__">env</span>(<span class="string">&quot;MY_VAR&quot;</span>, <span class="string">&quot;my_value&quot;</span>)</span><br><span class="line">       .<span class="title function_ invoke__">env</span>(<span class="string">&quot;PATH&quot;</span>, <span class="string">&quot;/usr/bin:/bin&quot;</span>)</span><br><span class="line">       <span class="comment">// 清除所有环境变量后添加</span></span><br><span class="line">       .<span class="title function_ invoke__">env_clear</span>()</span><br><span class="line">       .<span class="title function_ invoke__">envs</span>([(<span class="string">&quot;KEY1&quot;</span>, <span class="string">&quot;VAL1&quot;</span>), (<span class="string">&quot;KEY2&quot;</span>, <span class="string">&quot;VAL2&quot;</span>)]);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 设置工作目录</span></span><br><span class="line">    cmd.<span class="title function_ invoke__">current_dir</span>(<span class="string">&quot;/tmp&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 执行</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span> = cmd.<span class="title function_ invoke__">output</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Stdio-控制"><a href="#Stdio-控制" class="headerlink" title="Stdio 控制"></a>Stdio 控制</h2><h3 id="重定向配置"><a href="#重定向配置" class="headerlink" title="重定向配置"></a>重定向配置</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio&#125;;</span><br><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ Stdio 选项 ============</span></span><br><span class="line">    <span class="comment">// Stdio::inherit()  - 继承父进程（默认）</span></span><br><span class="line">    <span class="comment">// Stdio::piped()    - 创建管道</span></span><br><span class="line">    <span class="comment">// Stdio::null()     - 丢弃（/dev/null）</span></span><br><span class="line">    <span class="comment">// Stdio::from(file) - 重定向到文件</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 示例：静默执行</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 示例：输出到文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;/tmp/output.txt&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;echo&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;写入文件&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">from</span>(file))</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 示例：从文件读取输入</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input_file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;/etc/hosts&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;head&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-n5&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">from</span>(input_file))</span><br><span class="line">        .<span class="title function_ invoke__">output</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="管道通信"><a href="#管道通信" class="headerlink" title="管道通信"></a>管道通信</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Write, BufRead, BufReader&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 创建可交互的子进程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;cat&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;启动失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取 stdin 句柄</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stdin</span> = child.stdin.<span class="title function_ invoke__">take</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;获取 stdin 失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 在单独线程写入（避免死锁）</span></span><br><span class="line">    std::thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        stdin.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello\nWorld\n&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="comment">// stdin 在这里被 drop，发送 EOF</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取 stdout</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stdout</span> = child.stdout.<span class="title function_ invoke__">take</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;获取 stdout 失败&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(stdout);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">line</span> <span class="keyword">in</span> reader.<span class="title function_ invoke__">lines</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;收到: &#123;&#125;&quot;</span>, line.<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待子进程结束</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = child.<span class="title function_ invoke__">wait</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;子进程退出: &#123;&#125;&quot;</span>, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="进程管道链"><a href="#进程管道链" class="headerlink" title="进程管道链"></a>进程管道链</h2><h3 id="命令管道（类似-shell-）"><a href="#命令管道（类似-shell-）" class="headerlink" title="命令管道（类似 shell |）"></a>命令管道（类似 shell |）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 模拟: ls -la | grep &quot;.rs&quot; | head -5</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 第一个命令</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ls</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-la&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 第二个命令，stdin 连接到第一个的 stdout</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">grep</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;grep&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;.rs&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">from</span>(ls.stdout.<span class="title function_ invoke__">unwrap</span>()))</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 第三个命令</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">head</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;head&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-5&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">from</span>(grep.stdout.<span class="title function_ invoke__">unwrap</span>()))</span><br><span class="line">        .<span class="title function_ invoke__">output</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;head.stdout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="封装管道函数"><a href="#封装管道函数" class="headerlink" title="封装管道函数"></a>封装管道函数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio, Child&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::<span class="type">Result</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">pipe_commands</span>(commands: <span class="type">Vec</span>&lt;<span class="type">Vec</span>&lt;&amp;<span class="type">str</span>&gt;&gt;) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">prev_stdout</span>: <span class="type">Option</span>&lt;std::process::ChildStdout&gt; = <span class="literal">None</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">children</span>: <span class="type">Vec</span>&lt;Child&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">for</span> (i, cmd_args) <span class="keyword">in</span> commands.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> (cmd, args) = cmd_args.<span class="title function_ invoke__">split_first</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">command</span> = Command::<span class="title function_ invoke__">new</span>(cmd);</span><br><span class="line">        command.<span class="title function_ invoke__">args</span>(args);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置 stdin</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(stdout) = prev_stdout.<span class="title function_ invoke__">take</span>() &#123;</span><br><span class="line">            command.<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">from</span>(stdout));</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 非最后一个命令，stdout 用管道</span></span><br><span class="line">        <span class="keyword">if</span> i &lt; commands.<span class="title function_ invoke__">len</span>() - <span class="number">1</span> &#123;</span><br><span class="line">            command.<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">piped</span>());</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child</span> = command.<span class="title function_ invoke__">spawn</span>()?;</span><br><span class="line">        prev_stdout = child.stdout;</span><br><span class="line">        children.<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待所有子进程</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">final_output</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(last) = children.<span class="title function_ invoke__">last_mut</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">output</span> = last.<span class="title function_ invoke__">wait_with_output</span>()?;</span><br><span class="line">        final_output = <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout).<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(final_output)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">pipe_commands</span>(<span class="built_in">vec!</span>[</span><br><span class="line">        <span class="built_in">vec!</span>[<span class="string">&quot;echo&quot;</span>, <span class="string">&quot;hello\nworld\nrust&quot;</span>],</span><br><span class="line">        <span class="built_in">vec!</span>[<span class="string">&quot;grep&quot;</span>, <span class="string">&quot;o&quot;</span>],</span><br><span class="line">        <span class="built_in">vec!</span>[<span class="string">&quot;wc&quot;</span>, <span class="string">&quot;-l&quot;</span>],</span><br><span class="line">    ]).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;结果: &#123;&#125;&quot;</span>, result.<span class="title function_ invoke__">trim</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="子进程管理"><a href="#子进程管理" class="headerlink" title="子进程管理"></a>子进程管理</h2><h3 id="Child-句柄操作"><a href="#Child-句柄操作" class="headerlink" title="Child 句柄操作"></a>Child 句柄操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio&#125;;</span><br><span class="line"><span class="keyword">use</span> std::time::Duration;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;sleep&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;10&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;启动失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;子进程 PID: &#123;&#125;&quot;</span>, child.<span class="title function_ invoke__">id</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 非阻塞检查状态</span></span><br><span class="line">    <span class="keyword">match</span> child.<span class="title function_ invoke__">try_wait</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">Some</span>(status)) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;已退出: &#123;&#125;&quot;</span>, status),</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="literal">None</span>) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;仍在运行&quot;</span>),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;错误: &#123;&#125;&quot;</span>, e),</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待一段时间后强制终止</span></span><br><span class="line">    thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">2</span>));</span><br><span class="line">  </span><br><span class="line">    child.<span class="title function_ invoke__">kill</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;终止失败&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;已发送 SIGKILL&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 必须 wait 回收资源（避免僵尸进程）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">status</span> = child.<span class="title function_ invoke__">wait</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;等待失败&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;最终状态: &#123;&#125;&quot;</span>, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="超时执行"><a href="#超时执行" class="headerlink" title="超时执行"></a>超时执行</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"><span class="keyword">use</span> std::time::&#123;Duration, Instant&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">run_with_timeout</span>(cmd: &amp;<span class="type">str</span>, args: &amp;[&amp;<span class="type">str</span>], timeout: Duration) </span><br><span class="line">    <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(cmd)</span><br><span class="line">        .<span class="title function_ invoke__">args</span>(args)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(std::process::Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(std::process::Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map_err</span>(|e| e.<span class="title function_ invoke__">to_string</span>())?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">start</span> = Instant::<span class="title function_ invoke__">now</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> child.<span class="title function_ invoke__">try_wait</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">Some</span>(status)) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">output</span> = child.<span class="title function_ invoke__">wait_with_output</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                <span class="keyword">if</span> status.<span class="title function_ invoke__">success</span>() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(<span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout).<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stderr).<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="literal">None</span>) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> start.<span class="title function_ invoke__">elapsed</span>() &gt; timeout &#123;</span><br><span class="line">                    child.<span class="title function_ invoke__">kill</span>().<span class="title function_ invoke__">ok</span>();</span><br><span class="line">                    child.<span class="title function_ invoke__">wait</span>().<span class="title function_ invoke__">ok</span>();</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(<span class="string">&quot;执行超时&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">                &#125;</span><br><span class="line">                thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(e.<span class="title function_ invoke__">to_string</span>()),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">match</span> <span class="title function_ invoke__">run_with_timeout</span>(<span class="string">&quot;sleep&quot;</span>, &amp;[<span class="string">&quot;5&quot;</span>], Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(output) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;输出: &#123;&#125;&quot;</span>, output),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;错误: &#123;&#125;&quot;</span>, e),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="进程间通信（IPC）"><a href="#进程间通信（IPC）" class="headerlink" title="进程间通信（IPC）"></a>进程间通信（IPC）</h2><h3 id="匿名管道（父子进程）"><a href="#匿名管道（父子进程）" class="headerlink" title="匿名管道（父子进程）"></a>匿名管道（父子进程）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上面的 Stdio::piped() 示例即是匿名管道</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Stdio&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;BufRead, BufReader, Write&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;sh&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;read line; echo \&quot;子进程收到: $line\&quot;&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdin</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">piped</span>())</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入子进程</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(<span class="keyword">ref</span> <span class="keyword">mut</span> stdin) = child.stdin &#123;</span><br><span class="line">        <span class="built_in">writeln!</span>(stdin, <span class="string">&quot;Hello from parent&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    child.stdin.<span class="title function_ invoke__">take</span>(); <span class="comment">// 关闭 stdin</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取子进程输出</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(stdout) = child.stdout.<span class="title function_ invoke__">take</span>() &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">line</span> <span class="keyword">in</span> BufReader::<span class="title function_ invoke__">new</span>(stdout).<span class="title function_ invoke__">lines</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;父进程收到: &#123;&#125;&quot;</span>, line.<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    child.<span class="title function_ invoke__">wait</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="命名管道（FIFO）-Unix"><a href="#命名管道（FIFO）-Unix" class="headerlink" title="命名管道（FIFO）- Unix"></a>命名管道（FIFO）- Unix</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="keyword">mod</span> unix_fifo &#123;</span><br><span class="line">    <span class="keyword">use</span> std::fs::&#123;File, OpenOptions&#125;;</span><br><span class="line">    <span class="keyword">use</span> std::io::&#123;Read, Write&#125;;</span><br><span class="line">    <span class="keyword">use</span> std::os::unix::fs::OpenOptionsExt;</span><br><span class="line">    <span class="keyword">use</span> std::process::Command;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">demo</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">fifo_path</span> = <span class="string">&quot;/tmp/my_fifo&quot;</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 创建命名管道</span></span><br><span class="line">        Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;mkfifo&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">arg</span>(fifo_path)</span><br><span class="line">            .<span class="title function_ invoke__">status</span>()</span><br><span class="line">            .<span class="title function_ invoke__">ok</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 写者进程</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">writer</span> = std::thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">                .<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">                .<span class="title function_ invoke__">open</span>(fifo_path)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            file.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello via FIFO&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 读者进程</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">reader</span> = std::thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(fifo_path).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> buf).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;读取: &#123;&#125;&quot;</span>, buf);</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        writer.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        reader.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 清理</span></span><br><span class="line">        std::fs::<span class="title function_ invoke__">remove_file</span>(fifo_path).<span class="title function_ invoke__">ok</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="共享内存"><a href="#共享内存" class="headerlink" title="共享内存"></a>共享内存</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: shared_memory = &quot;0.12&quot;</span></span><br><span class="line"><span class="keyword">use</span> shared_memory::*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">shmem_name</span> = <span class="string">&quot;my_shared_mem&quot;</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建共享内存</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">shmem</span> = ShmemConf::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">size</span>(<span class="number">4096</span>)</span><br><span class="line">        .<span class="title function_ invoke__">os_id</span>(shmem_name)</span><br><span class="line">        .<span class="title function_ invoke__">create</span>()?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = shmem.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">        std::ptr::<span class="title function_ invoke__">copy_nonoverlapping</span>(</span><br><span class="line">            <span class="string">b&quot;Hello Shared Memory&quot;</span>.<span class="title function_ invoke__">as_ptr</span>(),</span><br><span class="line">            ptr,</span><br><span class="line">            <span class="number">20</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;共享内存已创建，其他进程可通过 &#x27;&#123;&#125;&#x27; 访问&quot;</span>, shmem_name);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 另一个进程打开已存在的共享内存</span></span><br><span class="line">    <span class="comment">// let existing = ShmemConf::new().os_id(shmem_name).open()?;</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Unix-Domain-Socket"><a href="#Unix-Domain-Socket" class="headerlink" title="Unix Domain Socket"></a>Unix Domain Socket</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="keyword">mod</span> unix_socket &#123;</span><br><span class="line">    <span class="keyword">use</span> std::os::unix::net::&#123;UnixListener, UnixStream&#125;;</span><br><span class="line">    <span class="keyword">use</span> std::io::&#123;Read, Write&#125;;</span><br><span class="line">    <span class="keyword">use</span> std::thread;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">demo</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">socket_path</span> = <span class="string">&quot;/tmp/my_socket.sock&quot;</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 清理旧的 socket 文件</span></span><br><span class="line">        std::fs::<span class="title function_ invoke__">remove_file</span>(socket_path).<span class="title function_ invoke__">ok</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 服务端</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">server</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">listener</span> = UnixListener::<span class="title function_ invoke__">bind</span>(socket_path).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;服务端监听中...&quot;</span>);</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">for</span> <span class="variable">stream</span> <span class="keyword">in</span> listener.<span class="title function_ invoke__">incoming</span>() &#123;</span><br><span class="line">                <span class="keyword">match</span> stream &#123;</span><br><span class="line">                    <span class="title function_ invoke__">Ok</span>(<span class="keyword">mut</span> stream) =&gt; &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">n</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buf).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                        <span class="built_in">println!</span>(<span class="string">&quot;服务端收到: &#123;&#125;&quot;</span>, </span><br><span class="line">                            <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;buf[..n]));</span><br><span class="line">                        stream.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello from server&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_ invoke__">Err</span>(e) =&gt; eprintln!(<span class="string">&quot;错误: &#123;&#125;&quot;</span>, e),</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 客户端</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">client</span> = thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stream</span> = UnixStream::<span class="title function_ invoke__">connect</span>(socket_path).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            stream.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello from client&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">n</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buf).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;客户端收到: &#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;buf[..n]));</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        server.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        client.<span class="title function_ invoke__">join</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">      </span><br><span class="line">        std::fs::<span class="title function_ invoke__">remove_file</span>(socket_path).<span class="title function_ invoke__">ok</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="IPC-方案对比"><a href="#IPC-方案对比" class="headerlink" title="IPC 方案对比"></a>IPC 方案对比</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┬──────────────┬──────────────┬────────────────────────┐</span><br><span class="line">│      方案        │    性能      │   使用范围    │         特点            │</span><br><span class="line">├─────────────────┼──────────────┼──────────────┼────────────────────────┤</span><br><span class="line">│ 匿名管道         │ 高           │ 父子进程     │ 简单，单向              │</span><br><span class="line">│ 命名管道(FIFO)   │ 高           │ 任意进程     │ 文件系统可见            │</span><br><span class="line">│ Unix Socket     │ 高           │ 同一主机     │ 双向，支持多连接         │</span><br><span class="line">│ TCP Socket      │ 中           │ 跨网络       │ 通用，开销较大          │</span><br><span class="line">│ 共享内存         │ 最高         │ 同一主机     │ 需要同步机制            │</span><br><span class="line">│ 内存映射文件     │ 高           │ 同一主机     │ 持久化，大数据          │</span><br><span class="line">│ 消息队列         │ 中           │ 同一主机     │ 解耦，异步              │</span><br><span class="line">└─────────────────┴──────────────┴──────────────┴────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h2><h3 id="使用-ctrlc-库"><a href="#使用-ctrlc-库" class="headerlink" title="使用 ctrlc 库"></a>使用 ctrlc 库</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: ctrlc = &quot;3.4&quot;</span></span><br><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicBool, Ordering&#125;;</span><br><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">running</span> = Arc::<span class="title function_ invoke__">new</span>(AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span> = running.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">  </span><br><span class="line">    ctrlc::<span class="title function_ invoke__">set_handler</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;\n收到 Ctrl+C，正在优雅退出...&quot;</span>);</span><br><span class="line">        r.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::SeqCst);</span><br><span class="line">    &#125;).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;设置处理器失败&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;运行中... 按 Ctrl+C 退出&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> running.<span class="title function_ invoke__">load</span>(Ordering::SeqCst) &#123;</span><br><span class="line">        std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">        <span class="comment">// 做一些工作...</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;清理完成，退出&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-signal-hook-库"><a href="#使用-signal-hook-库" class="headerlink" title="使用 signal-hook 库"></a>使用 signal-hook 库</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: signal-hook = &quot;0.3&quot;</span></span><br><span class="line"><span class="keyword">use</span> signal_hook::&#123;consts::*, iterator::Signals&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">signals</span> = Signals::<span class="title function_ invoke__">new</span>(&amp;[</span><br><span class="line">        SIGTERM,</span><br><span class="line">        SIGINT,</span><br><span class="line">        SIGHUP,</span><br><span class="line">        SIGQUIT,</span><br><span class="line">    ]).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 在单独线程处理信号</span></span><br><span class="line">    thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">sig</span> <span class="keyword">in</span> signals.<span class="title function_ invoke__">forever</span>() &#123;</span><br><span class="line">            <span class="keyword">match</span> sig &#123;</span><br><span class="line">                SIGTERM | SIGINT =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;收到终止信号，退出&quot;</span>);</span><br><span class="line">                    std::process::<span class="title function_ invoke__">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                SIGHUP =&gt; &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;收到 SIGHUP，重新加载配置&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                _ =&gt; <span class="built_in">unreachable!</span>(),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 主线程工作</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;工作中...&quot;</span>);</span><br><span class="line">        thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="发送信号给子进程"><a href="#发送信号给子进程" class="headerlink" title="发送信号给子进程"></a>发送信号给子进程</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">send_signal_demo</span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> std::process::Command;</span><br><span class="line">    <span class="keyword">use</span> nix::sys::signal::&#123;<span class="keyword">self</span>, Signal&#125;;</span><br><span class="line">    <span class="keyword">use</span> nix::unistd::Pid;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;sleep&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;100&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">spawn</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pid</span> = Pid::<span class="title function_ invoke__">from_raw</span>(child.<span class="title function_ invoke__">id</span>() <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 发送 SIGTERM</span></span><br><span class="line">    signal::<span class="title function_ invoke__">kill</span>(pid, Signal::SIGTERM).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;已发送 SIGTERM 给 PID &#123;&#125;&quot;</span>, child.<span class="title function_ invoke__">id</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h2><h3 id="使用-daemonize-库"><a href="#使用-daemonize-库" class="headerlink" title="使用 daemonize 库"></a>使用 daemonize 库</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml: daemonize = &quot;0.5&quot;</span></span><br><span class="line"><span class="meta">#[cfg(unix)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">daemonize_demo</span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> daemonize::Daemonize;</span><br><span class="line">    <span class="keyword">use</span> std::fs::File;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stdout</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;/tmp/daemon.out&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stderr</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;/tmp/daemon.err&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">daemonize</span> = Daemonize::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">pid_file</span>(<span class="string">&quot;/tmp/daemon.pid&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">chown_pid_file</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">working_directory</span>(<span class="string">&quot;/tmp&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">user</span>(<span class="string">&quot;nobody&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">group</span>(<span class="string">&quot;daemon&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(stdout)</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(stderr)</span><br><span class="line">        .<span class="title function_ invoke__">privileged_action</span>(|| <span class="string">&quot;执行特权操作&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">match</span> daemonize.<span class="title function_ invoke__">start</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(_) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;守护进程启动成功&quot;</span>);</span><br><span class="line">            <span class="comment">// 守护进程主循环</span></span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">10</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; eprintln!(<span class="string">&quot;守护进程启动失败: &#123;&#125;&quot;</span>, e),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="进程池模式"><a href="#进程池模式" class="headerlink" title="进程池模式"></a>进程池模式</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Child, Stdio&#125;;</span><br><span class="line"><span class="keyword">use</span> std::collections::VecDeque;</span><br><span class="line"><span class="keyword">use</span> std::io::Write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ProcessPool</span> &#123;</span><br><span class="line">    workers: <span class="type">Vec</span>&lt;Child&gt;,</span><br><span class="line">    max_workers: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ProcessPool</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(max_workers: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            workers: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            max_workers,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">spawn_worker</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, task: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="comment">// 清理已完成的 worker</span></span><br><span class="line">        <span class="keyword">self</span>.workers.<span class="title function_ invoke__">retain_mut</span>(|child| &#123;</span><br><span class="line">            <span class="keyword">match</span> child.<span class="title function_ invoke__">try_wait</span>() &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">Some</span>(_)) =&gt; <span class="literal">false</span>,  <span class="comment">// 已结束，移除</span></span><br><span class="line">                _ =&gt; <span class="literal">true</span>,             <span class="comment">// 仍在运行，保留</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 等待有空闲槽位</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.workers.<span class="title function_ invoke__">len</span>() &gt;= <span class="keyword">self</span>.max_workers &#123;</span><br><span class="line">            std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">100</span>));</span><br><span class="line">            <span class="keyword">self</span>.workers.<span class="title function_ invoke__">retain_mut</span>(|child| &#123;</span><br><span class="line">                child.<span class="title function_ invoke__">try_wait</span>().<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">is_none</span>()).<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">true</span>)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 启动新 worker</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">child</span> = Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;sh&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">arg</span>(<span class="string">&quot;-c&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">arg</span>(task)</span><br><span class="line">            .<span class="title function_ invoke__">spawn</span>()?;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">self</span>.workers.<span class="title function_ invoke__">push</span>(child);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">wait_all</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">child</span> <span class="keyword">in</span> &amp;<span class="keyword">mut</span> <span class="keyword">self</span>.workers &#123;</span><br><span class="line">            child.<span class="title function_ invoke__">wait</span>().<span class="title function_ invoke__">ok</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.workers.<span class="title function_ invoke__">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">pool</span> = ProcessPool::<span class="title function_ invoke__">new</span>(<span class="number">4</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 提交任务</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">task</span> = <span class="built_in">format!</span>(<span class="string">&quot;echo &#x27;任务 &#123;&#125;&#x27;; sleep 1&quot;</span>, i);</span><br><span class="line">        pool.<span class="title function_ invoke__">spawn_worker</span>(&amp;task).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;提交任务 &#123;&#125;&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    pool.<span class="title function_ invoke__">wait_all</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;所有任务完成&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="实用工具函数"><a href="#实用工具函数" class="headerlink" title="实用工具函数"></a>实用工具函数</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::&#123;Command, Output, ExitStatus&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="type">Result</span>, Error, ErrorKind&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 执行命令并返回 stdout，失败时返回 stderr</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">exec</span>(cmd: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">output</span> = <span class="keyword">if</span> <span class="built_in">cfg!</span>(target_os = <span class="string">&quot;windows&quot;</span>) &#123;</span><br><span class="line">        Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;cmd&quot;</span>).<span class="title function_ invoke__">args</span>([<span class="string">&quot;/C&quot;</span>, cmd]).<span class="title function_ invoke__">output</span>()?</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;sh&quot;</span>).<span class="title function_ invoke__">args</span>([<span class="string">&quot;-c&quot;</span>, cmd]).<span class="title function_ invoke__">output</span>()?</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> output.status.<span class="title function_ invoke__">success</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stdout).<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(Error::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            ErrorKind::Other,</span><br><span class="line">            <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;output.stderr).<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">        ))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 检查命令是否存在</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">command_exists</span>(cmd: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;which&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">arg</span>(cmd)</span><br><span class="line">        .<span class="title function_ invoke__">stdout</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">stderr</span>(Stdio::<span class="title function_ invoke__">null</span>())</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">success</span>())</span><br><span class="line">        .<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 获取当前进程信息</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">process_info</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;PID: &#123;&#125;&quot;</span>, std::process::<span class="title function_ invoke__">id</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;当前目录: &#123;:?&#125;&quot;</span>, std::env::<span class="title function_ invoke__">current_dir</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;可执行文件: &#123;:?&#125;&quot;</span>, std::env::<span class="title function_ invoke__">current_exe</span>().<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;参数: &#123;:?&#125;&quot;</span>, std::env::<span class="title function_ invoke__">args</span>().collect::&lt;<span class="type">Vec</span>&lt;_&gt;&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 使用示例</span></span><br><span class="line">    <span class="keyword">match</span> <span class="title function_ invoke__">exec</span>(<span class="string">&quot;uname -a&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(output) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;系统信息: &#123;&#125;&quot;</span>, output),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; eprintln!(<span class="string">&quot;错误: &#123;&#125;&quot;</span>, e),</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;git 存在: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">command_exists</span>(<span class="string">&quot;git&quot;</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">process_info</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="总结对比-1"><a href="#总结对比-1" class="headerlink" title="总结对比"></a>总结对比</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    多线程 vs 多进程 选择指南                             │</span><br><span class="line">├─────────────────┬───────────────────────┬───────────────────────────────┤</span><br><span class="line">│      维度        │       多线程          │          多进程               │</span><br><span class="line">├─────────────────┼───────────────────────┼───────────────────────────────┤</span><br><span class="line">│ 内存共享         │ 直接共享              │ 需要 IPC                      │</span><br><span class="line">│ 创建开销         │ 小                    │ 大                           │</span><br><span class="line">│ 通信开销         │ 小                    │ 大                           │</span><br><span class="line">│ 隔离性           │ 弱（崩溃影响整体）     │ 强（独立地址空间）            │</span><br><span class="line">│ 调试难度         │ 高（竞态条件）         │ 中                           │</span><br><span class="line">│ 适用场景         │ CPU 密集、共享状态    │ 隔离执行、调用外部程序         │</span><br><span class="line">│ Rust 安全性      │ 编译期保证            │ 运行时                        │</span><br><span class="line">└─────────────────┴───────────────────────┴───────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>推荐库</strong></p>
<table>
<thead>
<tr>
<th>用途</th>
<th>库</th>
</tr>
</thead>
<tbody><tr>
<td>基础进程</td>
<td><code>std::process</code></td>
</tr>
<tr>
<td>Unix 系统调用</td>
<td><code>nix</code></td>
</tr>
<tr>
<td>信号处理</td>
<td><code>signal-hook</code>, <code>ctrlc</code></td>
</tr>
<tr>
<td>共享内存</td>
<td><code>shared_memory</code></td>
</tr>
<tr>
<td>守护进程</td>
<td><code>daemonize</code></td>
</tr>
<tr>
<td>跨平台 IPC</td>
<td><code>ipc-channel</code></td>
</tr>
</tbody></table>
<blockquote>
<p><strong>选择原则</strong>：优先使用多线程处理 CPU 密集任务；需要隔离、调用外部程序、或利用多核避免 GIL（其他语言）时使用多进程。</p>
</blockquote>
<h1 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h1><h2 id="核心概念总览-2"><a href="#核心概念总览-2" class="headerlink" title="核心概念总览"></a>核心概念总览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Rust 异步编程架构                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   ┌─────────────────┐                                           │</span><br><span class="line">│   │   async/await   │  ← 语法糖（语言内置）                        │</span><br><span class="line">│   └────────┬────────┘                                           │</span><br><span class="line">│            │                                                    │</span><br><span class="line">│   ┌────────▼────────┐                                           │</span><br><span class="line">│   │  Future Trait   │  ← 核心抽象（标准库）                        │</span><br><span class="line">│   └────────┬────────┘                                           │</span><br><span class="line">│            │                                                    │</span><br><span class="line">│   ┌────────▼────────┐                                           │</span><br><span class="line">│   │    Runtime      │  ← 执行引擎（第三方：tokio/async-std）       │</span><br><span class="line">│   │  (Executor +    │                                           │</span><br><span class="line">│   │   Reactor)      │                                           │</span><br><span class="line">│   └─────────────────┘                                           │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>关键点：Rust 只提供语法和抽象，不提供运行时！</strong></p>
<hr>
<h2 id="标准库内置支持"><a href="#标准库内置支持" class="headerlink" title="标准库内置支持"></a>标准库内置支持</h2><h3 id="Future-Trait（核心）"><a href="#Future-Trait（核心）" class="headerlink" title="Future Trait（核心）"></a>Future Trait（核心）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准库定义 (简化版)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">Future</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">Output</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">poll</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">mut</span> <span class="keyword">Self</span>&gt;, cx: &amp;<span class="keyword">mut</span> Context&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> Poll&lt;<span class="keyword">Self</span>::Output&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Poll</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ready</span>(T),   <span class="comment">// 已完成，返回结果</span></span><br><span class="line">    Pending,    <span class="comment">// 未完成，稍后再试</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="async-await-语法"><a href="#async-await-语法" class="headerlink" title="async&#x2F;await 语法"></a>async&#x2F;await 语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// async fn 返回一个实现 Future 的匿名类型</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">fetch_data</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="comment">// await 暂停执行，让出控制权</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">response</span> = <span class="title function_ invoke__">make_request</span>().<span class="keyword">await</span>;</span><br><span class="line">    response.body</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价于（概念上）：</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fetch_data</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Future</span>&lt;Output = <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">response</span> = <span class="title function_ invoke__">make_request</span>().<span class="keyword">await</span>;</span><br><span class="line">        response.body</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="惰性执行特性"><a href="#惰性执行特性" class="headerlink" title="惰性执行特性"></a>惰性执行特性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">hello</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">future</span> = <span class="title function_ invoke__">hello</span>();  <span class="comment">// ⚠️ 什么都不会发生！</span></span><br><span class="line">    <span class="comment">// Future 是惰性的，必须被 poll 才会执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="为什么需要-Runtime"><a href="#为什么需要-Runtime" class="headerlink" title="为什么需要 Runtime"></a>为什么需要 Runtime</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     异步运行时职责                           │</span><br><span class="line">├────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                            │</span><br><span class="line">│  ┌──────────────┐     ┌──────────────┐                     │</span><br><span class="line">│  │   Executor   │     │   Reactor    │                     │</span><br><span class="line">│  │  (执行器)     │     │  (反应器)    │                      │</span><br><span class="line">│  ├──────────────┤     ├──────────────┤                     │</span><br><span class="line">│  │ • 调度任务    │     │ • I/O 事件   │                      │</span><br><span class="line">│  │ • 调用 poll  │     │   监听       │                      │</span><br><span class="line">│  │ • 任务切换    │     │ • 唤醒任务   │                       │</span><br><span class="line">│  └──────────────┘     └──────────────┘                     │</span><br><span class="line">│           │                   │                            │</span><br><span class="line">│           └───────┬───────────┘                            │</span><br><span class="line">│                   ▼                                        │</span><br><span class="line">│          ┌────────────────┐                                │</span><br><span class="line">│          │  异步任务队列   │                                 │</span><br><span class="line">│          └────────────────┘                                │</span><br><span class="line">│                                                            │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Tokio-详解"><a href="#Tokio-详解" class="headerlink" title="Tokio 详解"></a>Tokio 详解</h2><h3 id="基础设置"><a href="#基础设置" class="headerlink" title="基础设置"></a>基础设置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="comment"># 或按需选择</span></span><br><span class="line"><span class="comment"># tokio = &#123; version = &quot;1&quot;, features = [&quot;rt&quot;, &quot;rt-multi-thread&quot;, &quot;macros&quot;, &quot;net&quot;, &quot;io-util&quot;, &quot;time&quot;] &#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="入口点"><a href="#入口点" class="headerlink" title="入口点"></a>入口点</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式1: 宏（推荐）</span></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello from tokio!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2: 手动构建 Runtime</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rt</span> = tokio::runtime::Runtime::<span class="title function_ invoke__">new</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    rt.<span class="title function_ invoke__">block_on</span>(<span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello from tokio!&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3: 单线程运行时</span></span><br><span class="line"><span class="meta">#[tokio::main(flavor = <span class="string">&quot;current_thread&quot;</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 适合轻量级应用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="任务生成-spawn"><a href="#任务生成-spawn" class="headerlink" title="任务生成 (spawn)"></a>任务生成 (spawn)</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::task;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 生成并发任务</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle1</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="comment">// 独立运行的任务</span></span><br><span class="line">        <span class="title function_ invoke__">expensive_computation</span>().<span class="keyword">await</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle2</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">fetch_from_network</span>().<span class="keyword">await</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待任务完成</span></span><br><span class="line">    <span class="keyword">let</span> (result1, result2) = tokio::join!(handle1, handle2);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Results: &#123;:?&#125;, &#123;:?&#125;&quot;</span>, result1, result2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="核心异步原语"><a href="#核心异步原语" class="headerlink" title="核心异步原语"></a>核心异步原语</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::time::&#123;sleep, timeout, Duration&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio::sync::&#123;mpsc, Mutex, RwLock, oneshot&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// 时间操作</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">time_examples</span>() &#123;</span><br><span class="line">    <span class="comment">// 异步睡眠</span></span><br><span class="line">    <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>)).<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 超时控制</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">timeout</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>), <span class="title function_ invoke__">slow_operation</span>()).<span class="keyword">await</span>;</span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(value) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;完成: &#123;&#125;&quot;</span>, value),</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="built_in">println!</span>(<span class="string">&quot;超时!&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// 通道 (Channel)</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">channel_example</span>() &#123;</span><br><span class="line">    <span class="comment">// MPSC: 多生产者单消费者</span></span><br><span class="line">    <span class="keyword">let</span> (tx, <span class="keyword">mut</span> rx) = mpsc::channel::&lt;<span class="type">String</span>&gt;(<span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">    tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(<span class="string">&quot;Hello&quot;</span>.<span class="title function_ invoke__">to_string</span>()).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(msg) = rx.<span class="title function_ invoke__">recv</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;收到: &#123;&#125;&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Oneshot: 一次性通道</span></span><br><span class="line">    <span class="keyword">let</span> (tx, rx) = oneshot::channel::&lt;<span class="type">i32</span>&gt;();</span><br><span class="line">    tx.<span class="title function_ invoke__">send</span>(<span class="number">42</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = rx.<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// 异步锁</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">lock_example</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = Mutex::<span class="title function_ invoke__">new</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">        guard.<span class="title function_ invoke__">push</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;  <span class="comment">// 锁在这里释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="异步-I-O"><a href="#异步-I-O" class="headerlink" title="异步 I&#x2F;O"></a>异步 I&#x2F;O</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::net::&#123;TcpListener, TcpStream&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio::io::&#123;AsyncReadExt, AsyncWriteExt&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TCP 服务器示例</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">tcp_server</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (socket, addr) = listener.<span class="title function_ invoke__">accept</span>().<span class="keyword">await</span>?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;新连接: &#123;&#125;&quot;</span>, addr);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 为每个连接生成独立任务</span></span><br><span class="line">        tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">handle_connection</span>(socket).<span class="keyword">await</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">handle_connection</span>(<span class="keyword">mut</span> socket: TcpStream) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">n</span> = <span class="keyword">match</span> socket.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buffer).<span class="keyword">await</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>) =&gt; <span class="keyword">return</span>,  <span class="comment">// 连接关闭</span></span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(n) =&gt; n,</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="keyword">return</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// Echo 回去</span></span><br><span class="line">        socket.<span class="title function_ invoke__">write_all</span>(&amp;buffer[..n]).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::fs;</span><br><span class="line"><span class="keyword">use</span> tokio::io::&#123;AsyncBufReadExt, BufReader&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">file_operations</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 读取整个文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">content</span> = fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;config.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入文件</span></span><br><span class="line">    fs::<span class="title function_ invoke__">write</span>(<span class="string">&quot;output.txt&quot;</span>, <span class="string">&quot;Hello, World!&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 逐行读取</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = fs::File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(file);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">lines</span> = reader.<span class="title function_ invoke__">lines</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(line) = lines.<span class="title function_ invoke__">next_line</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, line);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="并发控制模式"><a href="#并发控制模式" class="headerlink" title="并发控制模式"></a>并发控制模式</h2><h3 id="并发-vs-顺序执行"><a href="#并发-vs-顺序执行" class="headerlink" title="并发 vs 顺序执行"></a>并发 vs 顺序执行</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">concurrent_operations</span>() &#123;</span><br><span class="line">    <span class="comment">// ❌ 顺序执行 - 总时间 = A + B + C</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="title function_ invoke__">fetch_a</span>().<span class="keyword">await</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = <span class="title function_ invoke__">fetch_b</span>().<span class="keyword">await</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c</span> = <span class="title function_ invoke__">fetch_c</span>().<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 并发执行 - 总时间 = max(A, B, C)</span></span><br><span class="line">    <span class="keyword">let</span> (a, b, c) = tokio::join!(</span><br><span class="line">        <span class="title function_ invoke__">fetch_a</span>(),</span><br><span class="line">        <span class="title function_ invoke__">fetch_b</span>(),</span><br><span class="line">        <span class="title function_ invoke__">fetch_c</span>()</span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 竞争执行 - 返回最先完成的</span></span><br><span class="line">    tokio::<span class="built_in">select!</span> &#123;</span><br><span class="line">        result = <span class="title function_ invoke__">fetch_a</span>() =&gt; <span class="built_in">println!</span>(<span class="string">&quot;A 先完成: &#123;:?&#125;&quot;</span>, result),</span><br><span class="line">        result = <span class="title function_ invoke__">fetch_b</span>() =&gt; <span class="built_in">println!</span>(<span class="string">&quot;B 先完成: &#123;:?&#125;&quot;</span>, result),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Select-用法"><a href="#Select-用法" class="headerlink" title="Select 用法"></a>Select 用法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::sync::mpsc;</span><br><span class="line"><span class="keyword">use</span> tokio::time::&#123;sleep, Duration&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">select_example</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, <span class="keyword">mut</span> rx) = mpsc::channel::&lt;<span class="type">i32</span>&gt;(<span class="number">10</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        tokio::<span class="built_in">select!</span> &#123;</span><br><span class="line">            <span class="comment">// 优先级：按顺序检查</span></span><br><span class="line">            <span class="title function_ invoke__">Some</span>(msg) = rx.<span class="title function_ invoke__">recv</span>() =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;收到消息: &#123;&#125;&quot;</span>, msg);</span><br><span class="line">            &#125;</span><br><span class="line">            _ = <span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1</span>)) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;心跳...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 可取消</span></span><br><span class="line">            _ = tokio::signal::<span class="title function_ invoke__">ctrl_c</span>() =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;收到退出信号&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见陷阱"><a href="#常见陷阱" class="headerlink" title="常见陷阱"></a>常见陷阱</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// ❌ 陷阱1: 在异步中使用 std::sync::Mutex</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// 错误：可能导致死锁</span></span><br><span class="line"><span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">bad_lock</span>(data: &amp;Mutex&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="title function_ invoke__">some_async_fn</span>().<span class="keyword">await</span>;  <span class="comment">// ⚠️ 持有锁时 await</span></span><br><span class="line">    guard.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：使用 tokio::sync::Mutex 或减少锁持有时间</span></span><br><span class="line"><span class="keyword">use</span> tokio::sync::Mutex;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">good_lock</span>(data: &amp;Mutex&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">    guard.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">&#125;  <span class="comment">// 在 await 前释放锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// ❌ 陷阱2: 阻塞操作</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// 错误：阻塞整个执行器线程</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">bad_blocking</span>() &#123;</span><br><span class="line">    std::thread::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">10</span>));  <span class="comment">// ⚠️ 同步阻塞</span></span><br><span class="line">    std::fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;file.txt&quot;</span>);          <span class="comment">// ⚠️ 同步 I/O</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">good_async</span>() &#123;</span><br><span class="line">    tokio::time::<span class="title function_ invoke__">sleep</span>(Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">10</span>)).<span class="keyword">await</span>;</span><br><span class="line">    tokio::fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;file.txt&quot;</span>).<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 不可避免的阻塞操作</span></span><br><span class="line">    tokio::task::<span class="title function_ invoke__">spawn_blocking</span>(|| &#123;</span><br><span class="line">        <span class="title function_ invoke__">heavy_cpu_computation</span>()</span><br><span class="line">    &#125;).<span class="keyword">await</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="comment">// ❌ 陷阱3: 忘记 .await</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">forget_await</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_</span> = <span class="title function_ invoke__">async_operation</span>();  <span class="comment">// ⚠️ 编译通过但不执行！</span></span><br><span class="line">    <span class="title function_ invoke__">async_operation</span>().<span class="keyword">await</span>;    <span class="comment">// ✅ 正确</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="为什么异步编程需要-Lock-和-Mutex"><a href="#为什么异步编程需要-Lock-和-Mutex" class="headerlink" title="为什么异步编程需要 Lock 和 Mutex"></a>为什么异步编程需要 Lock 和 Mutex</h2><h3 id="核心原因图解"><a href="#核心原因图解" class="headerlink" title="核心原因图解"></a>核心原因图解</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    为什么异步也需要锁？                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   原因1: Tokio 默认是多线程运行时                                     │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐       │</span><br><span class="line">│   │  Thread 1         Thread 2         Thread 3             │       │</span><br><span class="line">│   │  ┌───────┐        ┌───────┐        ┌───────┐            │       │</span><br><span class="line">│   │  │Task A │        │Task B │        │Task C │            │       │</span><br><span class="line">│   │  └───┬───┘        └───┬───┘        └───┬───┘            │       │</span><br><span class="line">│   │      │                │                │                │       │</span><br><span class="line">│   │      └────────────────┼────────────────┘                │       │</span><br><span class="line">│   │                       ▼                                 │       │</span><br><span class="line">│   │              ┌────────────────┐                         │       │</span><br><span class="line">│   │              │  共享数据 Vec   │  ← 真正的并行访问！       │       │</span><br><span class="line">│   │              └────────────────┘                         │       │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘       │</span><br><span class="line">│                                                                     │</span><br><span class="line">│   原因2: 即使单线程，await 点也会切换任务                              │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐       │</span><br><span class="line">│   │  时间线 ──────────────────────────────────────────────►  │       │</span><br><span class="line">│   │                                                         │       │</span><br><span class="line">│   │  Task A: [读取 x=5] ──await──────────────► [写入 x=6]    │       │</span><br><span class="line">│   │                           ↓                             │       │</span><br><span class="line">│   │  Task B:            [读取 x=5] [写入 x=10]               │       │</span><br><span class="line">│   │                                                         │       │</span><br><span class="line">│   │  结果: x 最终是 6 还是 10？取决于执行顺序！                  │       │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘       │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="具体场景演示"><a href="#具体场景演示" class="headerlink" title="具体场景演示"></a>具体场景演示</h3><p><strong>场景1：多线程运行时</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::sync::Arc;</span><br><span class="line"><span class="keyword">use</span> tokio::task;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 错误：编译不通过 != Rust 保护你</span></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">wrong_example</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">counter</span> = <span class="number">0</span>;  <span class="comment">// 非线程安全</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle1</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> &#123;</span><br><span class="line">        counter += <span class="number">1</span>;  <span class="comment">// ❌ 无法捕获可变引用</span></span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle2</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> &#123;</span><br><span class="line">        counter += <span class="number">1</span>;  <span class="comment">// ❌ </span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：使用 Arc + Mutex</span></span><br><span class="line"><span class="keyword">use</span> tokio::sync::Mutex;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">correct_example</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter</span> = Arc::<span class="title function_ invoke__">new</span>(Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter1</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle1</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = counter1.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">        *guard += <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">counter2</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;counter);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">handle2</span> = task::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = counter2.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">        *guard += <span class="number">1</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    handle1.<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    handle2.<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Counter: &#123;&#125;&quot;</span>, *counter.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>);  <span class="comment">// 保证是 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>场景2：单线程但有逻辑竞争</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::RefCell;</span><br><span class="line"><span class="keyword">use</span> std::rc::Rc;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 即使单线程，也有问题！</span></span><br><span class="line"><span class="meta">#[tokio::main(flavor = <span class="string">&quot;current_thread&quot;</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">single_thread_problem</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">balance</span> = Rc::<span class="title function_ invoke__">new</span>(RefCell::<span class="title function_ invoke__">new</span>(<span class="number">100</span>));  <span class="comment">// 银行账户余额</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 模拟两个并发的取款操作</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b1</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;balance);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">withdraw1</span> = <span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">current</span> = *b1.<span class="title function_ invoke__">borrow</span>();  <span class="comment">// 读取: 100</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ⚠️ 在这个 await 期间，另一个任务可能修改 balance</span></span><br><span class="line">        tokio::time::<span class="title function_ invoke__">sleep</span>(tokio::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>)).<span class="keyword">await</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> current &gt;= <span class="number">80</span> &#123;</span><br><span class="line">            *b1.<span class="title function_ invoke__">borrow_mut</span>() = current - <span class="number">80</span>;  <span class="comment">// 写入: 20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b2</span> = Rc::<span class="title function_ invoke__">clone</span>(&amp;balance);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">withdraw2</span> = <span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">current</span> = *b2.<span class="title function_ invoke__">borrow</span>();  <span class="comment">// 也读取到: 100</span></span><br><span class="line">      </span><br><span class="line">        tokio::time::<span class="title function_ invoke__">sleep</span>(tokio::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">5</span>)).<span class="keyword">await</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> current &gt;= <span class="number">80</span> &#123;</span><br><span class="line">            *b2.<span class="title function_ invoke__">borrow_mut</span>() = current - <span class="number">80</span>;  <span class="comment">// 写入: 20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    tokio::join!(withdraw1, withdraw2);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ❌ 结果: balance = 20，但实际取了 160！</span></span><br><span class="line">    <span class="comment">// 这就是 Race Condition（竞态条件）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="关键概念区分"><a href="#关键概念区分" class="headerlink" title="关键概念区分"></a>关键概念区分</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    两种不同的&quot;竞争&quot;问题                              │</span><br><span class="line">├──────────────────────────┬─────────────────────────────────────────┤</span><br><span class="line">│      Data Race           │         Race Condition                  │</span><br><span class="line">│      (数据竞争)           │         (竞态条件)                       │</span><br><span class="line">├──────────────────────────┼─────────────────────────────────────────┤</span><br><span class="line">│ • 多线程同时访问同一内存   │ • 操作的执行顺序不确定                    │</span><br><span class="line">│ • 至少一个是写操作        │ • 导致逻辑结果不正确                      │</span><br><span class="line">│ • 没有同步机制            │ • 单线程也可能发生                        │</span><br><span class="line">├──────────────────────────┼─────────────────────────────────────────┤</span><br><span class="line">│ Rust 编译器完全阻止 ✅    │ Rust 编译器无法检测 ⚠️                   │</span><br><span class="line">├──────────────────────────┼─────────────────────────────────────────┤</span><br><span class="line">│ 需要：Mutex, RwLock      │ 需要：Mutex + 正确的锁粒度                │</span><br><span class="line">└──────────────────────────┴─────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="await-的危险性"><a href="#await-的危险性" class="headerlink" title="await 的危险性"></a>await 的危险性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 展示 await 如何&quot;撕裂&quot;原子操作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">transfer</span>(from: &amp;Mutex&lt;<span class="type">i32</span>&gt;, to: &amp;Mutex&lt;<span class="type">i32</span>&gt;, amount: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="comment">// ❌ 危险的写法</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">from_guard</span> = from.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">    *from_guard -= amount;</span><br><span class="line">    <span class="title function_ invoke__">drop</span>(from_guard);  <span class="comment">// 释放锁</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ⚠️ 这里有个&quot;窗口期&quot;！</span></span><br><span class="line">    <span class="comment">// 钱已经从 from 扣除，但还没加到 to</span></span><br><span class="line">    <span class="comment">// 如果此时系统崩溃或其他任务读取，数据不一致</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">do_something_slow</span>().<span class="keyword">await</span>;  <span class="comment">// 💥 更糟糕！</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">to_guard</span> = to.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">    *to_guard += amount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 更安全的写法：减少 await 跨越的锁操作</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">safe_transfer</span>(from: &amp;Mutex&lt;<span class="type">i32</span>&gt;, to: &amp;Mutex&lt;<span class="type">i32</span>&gt;, amount: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="comment">// 方案1: 同时持有两把锁</span></span><br><span class="line">    <span class="keyword">let</span> (<span class="keyword">mut</span> from_guard, <span class="keyword">mut</span> to_guard) = tokio::join!(</span><br><span class="line">        from.<span class="title function_ invoke__">lock</span>(),</span><br><span class="line">        to.<span class="title function_ invoke__">lock</span>()</span><br><span class="line">    );</span><br><span class="line">    *from_guard -= amount;</span><br><span class="line">    *to_guard += amount;</span><br><span class="line">    <span class="comment">// 同时释放</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="何时需要-不需要锁"><a href="#何时需要-不需要锁" class="headerlink" title="何时需要&#x2F;不需要锁"></a>何时需要&#x2F;不需要锁</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     决策流程图                                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">                    有共享可变状态吗？</span><br><span class="line">                          │</span><br><span class="line">              ┌───────────┴───────────┐</span><br><span class="line">              ▼                       ▼</span><br><span class="line">             YES                      NO</span><br><span class="line">              │                       │</span><br><span class="line">              ▼                       ▼</span><br><span class="line">        跨多个任务吗？            不需要锁 ✅</span><br><span class="line">              │                  （每个任务有自己的数据）</span><br><span class="line">    ┌─────────┴─────────┐</span><br><span class="line">    ▼                   ▼</span><br><span class="line">   YES                  NO</span><br><span class="line">    │                   │</span><br><span class="line">    ▼                   ▼</span><br><span class="line"> 需要锁 🔒          可能不需要</span><br><span class="line">    │             （但要小心 await）</span><br><span class="line">    │</span><br><span class="line">    ▼</span><br><span class="line"> 多线程运行时？</span><br><span class="line">    │</span><br><span class="line"> ┌──┴──┐</span><br><span class="line"> ▼     ▼</span><br><span class="line">YES    NO (current_thread)</span><br><span class="line"> │      │</span><br><span class="line"> ▼      ▼</span><br><span class="line">Arc +   Rc + RefCell 可行</span><br><span class="line">Mutex   但仍建议用 Mutex</span><br></pre></td></tr></table></figure></div>

<p><strong>不需要锁的情况</strong></p>
<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 消息传递代替共享状态</span></span><br><span class="line"><span class="keyword">use</span> tokio::sync::mpsc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">no_lock_needed</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> (tx, <span class="keyword">mut</span> rx) = mpsc::<span class="title function_ invoke__">channel</span>(<span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生产者</span></span><br><span class="line">    tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        tx.<span class="title function_ invoke__">send</span>(<span class="number">42</span>).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 消费者：独占所有权，无需锁</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(value) = rx.<span class="title function_ invoke__">recv</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 任务内部状态：无共享</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">process_item</span>(item: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">local_data</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();  <span class="comment">// 任务私有</span></span><br><span class="line">    local_data.<span class="title function_ invoke__">push</span>(item);</span><br><span class="line">    <span class="comment">// 不需要锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 只读共享</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">read_only_sharing</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">config</span> = Arc::<span class="title function_ invoke__">new</span>(Config::<span class="title function_ invoke__">load</span>());  <span class="comment">// 不可变</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c1</span> = Arc::<span class="title function_ invoke__">clone</span>(&amp;config);</span><br><span class="line">    tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, c1.name);  <span class="comment">// 只读，无需锁</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h3 id="std-sync-Mutex-vs-tokio-sync-Mutex"><a href="#std-sync-Mutex-vs-tokio-sync-Mutex" class="headerlink" title="std::sync::Mutex vs tokio::sync::Mutex"></a>std::sync::Mutex vs tokio::sync::Mutex</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ═══════════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment">//  关键区别</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════════════════════════</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// std::sync::Mutex - 阻塞式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">std_mutex</span> = std::sync::Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">guard</span> = std_mutex.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// 🔴 阻塞当前线程！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tokio::sync::Mutex - 异步式</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">tokio_mutex</span> = tokio::sync::Mutex::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">guard</span> = tokio_mutex.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;   <span class="comment">// 🟢 让出执行权，不阻塞线程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment">//  什么时候用哪个？</span></span><br><span class="line"><span class="comment">// ═══════════════════════════════════════════════════════════════</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 用 std::sync::Mutex：锁内无 await，且锁持有时间很短</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">use_std_mutex</span>(data: &amp;std::sync::Mutex&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;) &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        guard.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);  <span class="comment">// 快速操作</span></span><br><span class="line">    &#125;  <span class="comment">// 立即释放</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">do_async_work</span>().<span class="keyword">await</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 用 tokio::sync::Mutex：锁内有 await，或锁持有时间长</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">use_tokio_mutex</span>(data: &amp;tokio::sync::Mutex&lt;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guard</span> = data.<span class="title function_ invoke__">lock</span>().<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 可以在持有锁时 await（虽然通常不推荐）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">fetch_data</span>().<span class="keyword">await</span>;</span><br><span class="line">    guard.<span class="title function_ invoke__">push</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<table>
<thead>
<tr>
<th>误解</th>
<th>事实</th>
</tr>
</thead>
<tbody><tr>
<td>“异步是单线程的”</td>
<td>Tokio 默认多线程，任务可能并行</td>
</tr>
<tr>
<td>“单线程不需要锁”</td>
<td>await 点会切换任务，造成竞态条件</td>
</tr>
<tr>
<td>“用 channel 就不需要锁”</td>
<td>channel 内部也用了锁，但封装好了</td>
</tr>
<tr>
<td>“锁会影响性能”</td>
<td>正确使用锁的开销很小，数据损坏更可怕</td>
</tr>
</tbody></table>
<p><strong>黄金法则：如果多个任务需要修改同一数据，就需要同步机制（Mutex&#x2F;Channel&#x2F;Atomic）</strong></p>
<h2 id="总结对比表"><a href="#总结对比表" class="headerlink" title="总结对比表"></a>总结对比表</h2><table>
<thead>
<tr>
<th>特性</th>
<th>标准库</th>
<th>Tokio</th>
</tr>
</thead>
<tbody><tr>
<td>async&#x2F;await</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Future trait</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Runtime</td>
<td>❌</td>
<td>✅ 多线程&#x2F;单线程</td>
</tr>
<tr>
<td>异步 I&#x2F;O</td>
<td>❌</td>
<td>✅ TCP&#x2F;UDP&#x2F;Unix</td>
</tr>
<tr>
<td>定时器</td>
<td>❌</td>
<td>✅ sleep&#x2F;timeout</td>
</tr>
<tr>
<td>通道</td>
<td>❌</td>
<td>✅ mpsc&#x2F;broadcast&#x2F;watch</td>
</tr>
<tr>
<td>异步锁</td>
<td>❌</td>
<td>✅ Mutex&#x2F;RwLock&#x2F;Semaphore</td>
</tr>
<tr>
<td>文件 I&#x2F;O</td>
<td>❌</td>
<td>✅</td>
</tr>
</tbody></table>
<p><strong>选择建议：</strong></p>
<ul>
<li>网络服务&#x2F;高并发 → <strong>Tokio</strong></li>
<li>简单异步需求 → <strong>async-std</strong> (更简单的 API)</li>
<li>嵌入式&#x2F;WASM → <strong>smol</strong> 或自定义</li>
</ul>
<h1 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h1><h2 id="核心概念架构"><a href="#核心概念架构" class="headerlink" title="核心概念架构"></a>核心概念架构</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Rust 网络编程生态                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  应用层框架    │ actix-web │ axum │ rocket │ warp │ hyper      │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  异步运行时    │     tokio      │    async-std    │   smol     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  标准库        │         std::net (同步阻塞式)                   │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  协议层        │   TCP   │   UDP   │   HTTP   │  WebSocket     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="标准库同步网络编程-std-net"><a href="#标准库同步网络编程-std-net" class="headerlink" title="标准库同步网络编程 (std::net)"></a>标准库同步网络编程 (std::net)</h2><h3 id="TCP-服务端-客户端"><a href="#TCP-服务端-客户端" class="headerlink" title="TCP 服务端&#x2F;客户端"></a>TCP 服务端&#x2F;客户端</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::&#123;TcpListener, TcpStream&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Read, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> std::thread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ TCP 服务端 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">tcp_server</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Server listening on port 8080&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">stream</span> <span class="keyword">in</span> listener.<span class="title function_ invoke__">incoming</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">stream</span> = stream?;</span><br><span class="line">        <span class="comment">// 为每个连接创建新线程</span></span><br><span class="line">        thread::<span class="title function_ invoke__">spawn</span>(<span class="keyword">move</span> || &#123;</span><br><span class="line">            <span class="title function_ invoke__">handle_client</span>(stream).<span class="title function_ invoke__">unwrap_or_else</span>(|e| eprintln!(<span class="string">&quot;Error: &#123;&#125;&quot;</span>, e));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">handle_client</span>(<span class="keyword">mut</span> stream: TcpStream) <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes_read</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buffer)?;</span><br><span class="line">        <span class="keyword">if</span> bytes_read == <span class="number">0</span> &#123; <span class="keyword">break</span>; &#125;  <span class="comment">// 连接关闭</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// Echo: 原样返回数据</span></span><br><span class="line">        stream.<span class="title function_ invoke__">write_all</span>(&amp;buffer[..bytes_read])?;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ TCP 客户端 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">tcp_client</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stream</span> = TcpStream::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    stream.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello, Server!&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buffer)?;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Received: &#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;buffer[..n]));</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="UDP-通信"><a href="#UDP-通信" class="headerlink" title="UDP 通信"></a>UDP 通信</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::net::UdpSocket;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UDP 服务端</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">udp_server</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">socket</span> = UdpSocket::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (len, src_addr) = socket.<span class="title function_ invoke__">recv_from</span>(&amp;<span class="keyword">mut</span> buf)?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Received &#123;&#125; bytes from &#123;&#125;&quot;</span>, len, src_addr);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 回复</span></span><br><span class="line">        socket.<span class="title function_ invoke__">send_to</span>(&amp;buf[..len], src_addr)?;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UDP 客户端</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">udp_client</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">socket</span> = UdpSocket::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;0.0.0.0:0&quot;</span>)?;  <span class="comment">// 随机端口</span></span><br><span class="line">    socket.<span class="title function_ invoke__">connect</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    socket.<span class="title function_ invoke__">send</span>(<span class="string">b&quot;Hello UDP!&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = socket.<span class="title function_ invoke__">recv</span>(&amp;<span class="keyword">mut</span> buf)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Response: &#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;buf[..len]));</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="异步网络编程"><a href="#异步网络编程" class="headerlink" title="异步网络编程"></a>异步网络编程</h2><h3 id="Cargo-toml-配置"><a href="#Cargo-toml-配置" class="headerlink" title="Cargo.toml 配置"></a>Cargo.toml 配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="异步-TCP-服务端"><a href="#异步-TCP-服务端" class="headerlink" title="异步 TCP 服务端"></a>异步 TCP 服务端</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::net::&#123;TcpListener, TcpStream&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio::io::&#123;AsyncReadExt, AsyncWriteExt&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Async server listening on 8080&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> (socket, addr) = listener.<span class="title function_ invoke__">accept</span>().<span class="keyword">await</span>?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;New connection from: &#123;&#125;&quot;</span>, addr);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 异步任务处理连接（无需线程）</span></span><br><span class="line">        tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">handle_connection</span>(socket).<span class="keyword">await</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">handle_connection</span>(<span class="keyword">mut</span> socket: TcpStream) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">match</span> socket.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buffer).<span class="keyword">await</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(<span class="number">0</span>) =&gt; <span class="keyword">break</span>,  <span class="comment">// 连接关闭</span></span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(n) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> socket.<span class="title function_ invoke__">write_all</span>(&amp;buffer[..n]).<span class="keyword">await</span>.<span class="title function_ invoke__">is_err</span>() &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="keyword">break</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="异步-TCP-客户端"><a href="#异步-TCP-客户端" class="headerlink" title="异步 TCP 客户端"></a>异步 TCP 客户端</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::net::TcpStream;</span><br><span class="line"><span class="keyword">use</span> tokio::io::&#123;AsyncReadExt, AsyncWriteExt&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stream</span> = TcpStream::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;127.0.0.1:8080&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    stream.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello Async!&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = <span class="built_in">vec!</span>[<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = stream.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> buffer).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Received: &#123;&#125;&quot;</span>, <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(&amp;buffer[..n]));</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="HTTP-客户端"><a href="#HTTP-客户端" class="headerlink" title="HTTP 客户端"></a>HTTP 客户端</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">reqwest</span> = &#123; version = <span class="string">&quot;0.11&quot;</span>, features = [<span class="string">&quot;json&quot;</span>] &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> reqwest;</span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Post</span> &#123;</span><br><span class="line">    id: <span class="type">Option</span>&lt;<span class="type">u32</span>&gt;,</span><br><span class="line">    title: <span class="type">String</span>,</span><br><span class="line">    body: <span class="type">String</span>,</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;userId&quot;</span>)]</span></span><br><span class="line">    user_id: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), reqwest::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// GET 请求</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">response</span> = reqwest::<span class="title function_ invoke__">get</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span>)</span><br><span class="line">        .<span class="keyword">await</span>?</span><br><span class="line">        .json::&lt;Post&gt;()</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;GET: &#123;:?&#125;&quot;</span>, response);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// POST 请求</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_post</span> = Post &#123;</span><br><span class="line">        id: <span class="literal">None</span>,</span><br><span class="line">        title: <span class="string">&quot;foo&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        body: <span class="string">&quot;bar&quot;</span>.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">        user_id: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">client</span> = reqwest::Client::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">res</span> = client</span><br><span class="line">        .<span class="title function_ invoke__">post</span>(<span class="string">&quot;https://jsonplaceholder.typicode.com/posts&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">json</span>(&amp;new_post)</span><br><span class="line">        .<span class="title function_ invoke__">send</span>()</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;POST Status: &#123;&#125;&quot;</span>, res.<span class="title function_ invoke__">status</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Web-服务器框架"><a href="#Web-服务器框架" class="headerlink" title="Web 服务器框架"></a>Web 服务器框架</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">axum</span> = <span class="string">&quot;0.7&quot;</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br><span class="line"><span class="attr">serde_json</span> = <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> axum::&#123;</span><br><span class="line">    routing::&#123;get, post&#125;,</span><br><span class="line">    Router, Json, extract::Path,</span><br><span class="line">    http::StatusCode,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> std::net::SocketAddr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    id: <span class="type">u64</span>,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CreateUser</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">root</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">    <span class="string">&quot;Hello, World!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET /users/:id</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">get_user</span>(<span class="title function_ invoke__">Path</span>(id): Path&lt;<span class="type">u64</span>&gt;) <span class="punctuation">-&gt;</span> Json&lt;User&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Json</span>(User &#123; id, name: <span class="string">&quot;Alice&quot;</span>.<span class="title function_ invoke__">into</span>() &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST /users</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">create_user</span>(<span class="title function_ invoke__">Json</span>(payload): Json&lt;CreateUser&gt;) <span class="punctuation">-&gt;</span> (StatusCode, Json&lt;User&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = User &#123;</span><br><span class="line">        id: <span class="number">1</span>,</span><br><span class="line">        name: payload.name,</span><br><span class="line">    &#125;;</span><br><span class="line">    (StatusCode::CREATED, <span class="title function_ invoke__">Json</span>(user))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">app</span> = Router::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">route</span>(<span class="string">&quot;/&quot;</span>, <span class="title function_ invoke__">get</span>(root))</span><br><span class="line">        .<span class="title function_ invoke__">route</span>(<span class="string">&quot;/users/:id&quot;</span>, <span class="title function_ invoke__">get</span>(get_user))</span><br><span class="line">        .<span class="title function_ invoke__">route</span>(<span class="string">&quot;/users&quot;</span>, <span class="title function_ invoke__">post</span>(create_user));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span> = SocketAddr::<span class="title function_ invoke__">from</span>(([<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>], <span class="number">3000</span>));</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Server running at http://&#123;&#125;&quot;</span>, addr);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = tokio::net::TcpListener::<span class="title function_ invoke__">bind</span>(addr).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    axum::<span class="title function_ invoke__">serve</span>(listener, app).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">tokio-tungstenite</span> = <span class="string">&quot;0.21&quot;</span></span><br><span class="line"><span class="attr">futures-util</span> = <span class="string">&quot;0.3&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::net::TcpListener;</span><br><span class="line"><span class="keyword">use</span> tokio_tungstenite::accept_async;</span><br><span class="line"><span class="keyword">use</span> futures_util::&#123;StreamExt, SinkExt&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">listener</span> = TcpListener::<span class="title function_ invoke__">bind</span>(<span class="string">&quot;127.0.0.1:9000&quot;</span>).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;WebSocket server on ws://127.0.0.1:9000&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Ok</span>((stream, addr)) = listener.<span class="title function_ invoke__">accept</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">        tokio::<span class="title function_ invoke__">spawn</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ws_stream</span> = <span class="title function_ invoke__">accept_async</span>(stream).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;WebSocket connection from: &#123;&#125;&quot;</span>, addr);</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">let</span> (<span class="keyword">mut</span> write, <span class="keyword">mut</span> read) = ws_stream.<span class="title function_ invoke__">split</span>();</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// Echo 服务</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(msg) = read.<span class="title function_ invoke__">next</span>().<span class="keyword">await</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(msg) = msg &#123;</span><br><span class="line">                    <span class="keyword">if</span> msg.<span class="title function_ invoke__">is_text</span>() || msg.<span class="title function_ invoke__">is_binary</span>() &#123;</span><br><span class="line">                        write.<span class="title function_ invoke__">send</span>(msg).<span class="keyword">await</span>.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="关键对比总结"><a href="#关键对比总结" class="headerlink" title="关键对比总结"></a>关键对比总结</h2><table>
<thead>
<tr>
<th>特性</th>
<th>std::net</th>
<th>tokio</th>
<th>async-std</th>
</tr>
</thead>
<tbody><tr>
<td><strong>模型</strong></td>
<td>同步阻塞</td>
<td>异步非阻塞</td>
<td>异步非阻塞</td>
</tr>
<tr>
<td><strong>并发方式</strong></td>
<td>多线程</td>
<td>任务(Task)</td>
<td>任务(Task)</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>中等</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td><strong>复杂度</strong></td>
<td>简单</td>
<td>中等</td>
<td>中等</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>简单工具&#x2F;学习</td>
<td>高并发服务</td>
<td>高并发服务</td>
</tr>
</tbody></table>
<hr>
<h2 id="生态库推荐"><a href="#生态库推荐" class="headerlink" title="生态库推荐"></a>生态库推荐</h2><table>
<thead>
<tr>
<th>用途</th>
<th>推荐库</th>
</tr>
</thead>
<tbody><tr>
<td>HTTP 客户端</td>
<td><code>reqwest</code></td>
</tr>
<tr>
<td>HTTP 服务器</td>
<td><code>axum</code>, <code>actix-web</code></td>
</tr>
<tr>
<td>WebSocket</td>
<td><code>tokio-tungstenite</code></td>
</tr>
<tr>
<td>gRPC</td>
<td><code>tonic</code></td>
</tr>
<tr>
<td>底层 HTTP</td>
<td><code>hyper</code></td>
</tr>
<tr>
<td>DNS 解析</td>
<td><code>trust-dns</code></td>
</tr>
<tr>
<td>TLS</td>
<td><code>rustls</code>, <code>native-tls</code></td>
</tr>
</tbody></table>
<h1 id="文件操作-1"><a href="#文件操作-1" class="headerlink" title="文件操作"></a>文件操作</h1><h2 id="核心概念架构-1"><a href="#核心概念架构-1" class="headerlink" title="核心概念架构"></a>核心概念架构</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Rust 文件操作体系                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  路径处理      │  std::path::Path  │  std::path::PathBuf        │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  文件系统      │  std::fs (同步)   │  tokio::fs (异步)          │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  I/O Traits    │  Read │ Write │ Seek │ BufRead │ BufWriter    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  高级封装      │  读: read_to_string │ 写: write │ 追加: append │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="快速文件读写"><a href="#快速文件读写" class="headerlink" title="快速文件读写"></a>快速文件读写</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 读取文件 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. 一次性读取为 String（最常用）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">content</span> = fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;config.txt&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, content);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 一次性读取为字节 Vec&lt;u8&gt;（二进制文件）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span> = fs::<span class="title function_ invoke__">read</span>(<span class="string">&quot;image.png&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;File size: &#123;&#125; bytes&quot;</span>, bytes.<span class="title function_ invoke__">len</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 写入文件 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 写入字符串（覆盖已有内容）</span></span><br><span class="line">    fs::<span class="title function_ invoke__">write</span>(<span class="string">&quot;output.txt&quot;</span>, <span class="string">&quot;Hello, Rust!&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. 写入字节数据</span></span><br><span class="line">    fs::<span class="title function_ invoke__">write</span>(<span class="string">&quot;data.bin&quot;</span>, &amp;[<span class="number">0x48</span>, <span class="number">0x65</span>, <span class="number">0x6c</span>, <span class="number">0x6c</span>, <span class="number">0x6f</span>])?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="File-结构体操作"><a href="#File-结构体操作" class="headerlink" title="File 结构体操作"></a>File 结构体操作</h2><h3 id="打开和创建文件"><a href="#打开和创建文件" class="headerlink" title="打开和创建文件"></a>打开和创建文件</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::&#123;File, OpenOptions&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Read, Write, Seek, SeekFrom&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 基本打开方式 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 只读打开（文件必须存在）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;input.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建/覆盖写入（文件不存在则创建）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;output.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ OpenOptions 精细控制 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 追加模式</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">append</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">&quot;log.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读写模式</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">read</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建新文件（如已存在则报错）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">create_new</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">&quot;new_file.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 完整选项示例</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">read</span>(<span class="literal">true</span>)          <span class="comment">// 可读</span></span><br><span class="line">        .<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)         <span class="comment">// 可写</span></span><br><span class="line">        .<span class="title function_ invoke__">create</span>(<span class="literal">true</span>)        <span class="comment">// 不存在则创建</span></span><br><span class="line">        .<span class="title function_ invoke__">truncate</span>(<span class="literal">false</span>)     <span class="comment">// 不清空原内容</span></span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">&quot;config.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="读取操作"><a href="#读取操作" class="headerlink" title="读取操作"></a>读取操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Read, BufRead, BufReader&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 方式1: 读取到 String ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">content</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> content)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式2: 读取到 Vec&lt;u8&gt; ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.bin&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buffer</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_end</span>(&amp;<span class="keyword">mut</span> buffer)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式3: 读取固定大小块 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;large.bin&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">chunk</span> = [<span class="number">0u8</span>; <span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes_read</span> = file.<span class="title function_ invoke__">read</span>(&amp;<span class="keyword">mut</span> chunk)?;</span><br><span class="line">        <span class="keyword">if</span> bytes_read == <span class="number">0</span> &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">        <span class="comment">// 处理 chunk[..bytes_read]</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Read &#123;&#125; bytes&quot;</span>, bytes_read);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式4: 按行读取（推荐大文件）============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;log.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(file);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">line</span> <span class="keyword">in</span> reader.<span class="title function_ invoke__">lines</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">line</span> = line?;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, line);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式5: 按行读取（保留换行符）============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(file);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">line</span> <span class="keyword">in</span> reader.<span class="title function_ invoke__">split</span>(<span class="string">b&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">line</span> = line?;</span><br><span class="line">        <span class="comment">// line: Vec&lt;u8&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="写入操作"><a href="#写入操作" class="headerlink" title="写入操作"></a>写入操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Write, BufWriter&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 基本写入 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;output.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入字节</span></span><br><span class="line">    file.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello, World!\n&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 格式化写入</span></span><br><span class="line">    <span class="built_in">writeln!</span>(file, <span class="string">&quot;Number: &#123;&#125;&quot;</span>, <span class="number">42</span>)?;</span><br><span class="line">    <span class="built_in">writeln!</span>(file, <span class="string">&quot;Name: &#123;&#125;&quot;</span>, <span class="string">&quot;Alice&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 确保数据写入磁盘</span></span><br><span class="line">    file.<span class="title function_ invoke__">sync_all</span>()?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 缓冲写入（推荐大量写入）============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;large_output.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">writer</span> = BufWriter::<span class="title function_ invoke__">new</span>(file);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10000</span> &#123;</span><br><span class="line">        <span class="built_in">writeln!</span>(writer, <span class="string">&quot;Line &#123;&#125;&quot;</span>, i)?;</span><br><span class="line">    &#125;</span><br><span class="line">    writer.<span class="title function_ invoke__">flush</span>()?;  <span class="comment">// 刷新缓冲区</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 自定义缓冲区大小 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;data.txt&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">writer</span> = BufWriter::<span class="title function_ invoke__">with_capacity</span>(<span class="number">64</span> * <span class="number">1024</span>, file);  <span class="comment">// 64KB</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="文件指针定位-Seek"><a href="#文件指针定位-Seek" class="headerlink" title="文件指针定位 (Seek)"></a>文件指针定位 (Seek)</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::OpenOptions;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;Read, Write, Seek, SeekFrom&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = OpenOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">read</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">write</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">open</span>(<span class="string">&quot;data.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 移动到文件开头</span></span><br><span class="line">    file.<span class="title function_ invoke__">seek</span>(SeekFrom::<span class="title function_ invoke__">Start</span>(<span class="number">0</span>))?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 移动到文件末尾</span></span><br><span class="line">    file.<span class="title function_ invoke__">seek</span>(SeekFrom::<span class="title function_ invoke__">End</span>(<span class="number">0</span>))?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 相对当前位置移动</span></span><br><span class="line">    file.<span class="title function_ invoke__">seek</span>(SeekFrom::<span class="title function_ invoke__">Current</span>(<span class="number">10</span>))?;   <span class="comment">// 向前10字节</span></span><br><span class="line">    file.<span class="title function_ invoke__">seek</span>(SeekFrom::<span class="title function_ invoke__">Current</span>(-<span class="number">5</span>))?;   <span class="comment">// 向后5字节</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取当前位置</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pos</span> = file.<span class="title function_ invoke__">stream_position</span>()?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Current position: &#123;&#125;&quot;</span>, pos);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 回到开头并读取</span></span><br><span class="line">    file.<span class="title function_ invoke__">rewind</span>()?;  <span class="comment">// 等价于 seek(SeekFrom::Start(0))</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="路径操作-Path-PathBuf"><a href="#路径操作-Path-PathBuf" class="headerlink" title="路径操作 (Path&#x2F;PathBuf)"></a>路径操作 (Path&#x2F;PathBuf)</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::path::&#123;Path, PathBuf&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ffi::OsStr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ 创建路径 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Path: 不可变引用（类似 &amp;str）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;/home/user/file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// PathBuf: 可变拥有（类似 String）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">path_buf</span> = PathBuf::<span class="title function_ invoke__">from</span>(<span class="string">&quot;/home/user&quot;</span>);</span><br><span class="line">    path_buf.<span class="title function_ invoke__">push</span>(<span class="string">&quot;documents&quot;</span>);</span><br><span class="line">    path_buf.<span class="title function_ invoke__">push</span>(<span class="string">&quot;file.txt&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, path_buf.<span class="title function_ invoke__">display</span>());  <span class="comment">// /home/user/documents/file.txt</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 路径组件提取 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;/home/user/document.tar.gz&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;文件名: &#123;:?&#125;&quot;</span>, path.<span class="title function_ invoke__">file_name</span>());        <span class="comment">// Some(&quot;document.tar.gz&quot;)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;文件干名: &#123;:?&#125;&quot;</span>, path.<span class="title function_ invoke__">file_stem</span>());      <span class="comment">// Some(&quot;document.tar&quot;)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;扩展名: &#123;:?&#125;&quot;</span>, path.<span class="title function_ invoke__">extension</span>());        <span class="comment">// Some(&quot;gz&quot;)</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;父目录: &#123;:?&#125;&quot;</span>, path.<span class="title function_ invoke__">parent</span>());           <span class="comment">// Some(&quot;/home/user&quot;)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 路径判断 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;./config.toml&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是否绝对路径: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">is_absolute</span>());  <span class="comment">// false</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是否相对路径: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">is_relative</span>());  <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是否存在: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">exists</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是文件: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">is_file</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是目录: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">is_dir</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是符号链接: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">is_symlink</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 路径操作 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">path</span> = PathBuf::<span class="title function_ invoke__">from</span>(<span class="string">&quot;/home/user/file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改文件名</span></span><br><span class="line">    path.<span class="title function_ invoke__">set_file_name</span>(<span class="string">&quot;new_file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改扩展名</span></span><br><span class="line">    path.<span class="title function_ invoke__">set_extension</span>(<span class="string">&quot;md&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 拼接路径</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">full_path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;/home&quot;</span>).<span class="title function_ invoke__">join</span>(<span class="string">&quot;user&quot;</span>).<span class="title function_ invoke__">join</span>(<span class="string">&quot;file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 规范化路径 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;/home/user/../user/./file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取规范路径（解析 .. 和 .）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(canonical) = path.<span class="title function_ invoke__">canonicalize</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;规范路径: &#123;&#125;&quot;</span>, canonical.<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 遍历路径组件 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;/home/user/docs/file.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">component</span> <span class="keyword">in</span> path.<span class="title function_ invoke__">components</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, component);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 输出: RootDir, Normal(&quot;home&quot;), Normal(&quot;user&quot;), Normal(&quot;docs&quot;), Normal(&quot;file.txt&quot;)</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 遍历祖先路径</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">ancestor</span> <span class="keyword">in</span> path.<span class="title function_ invoke__">ancestors</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, ancestor.<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::&#123;<span class="keyword">self</span>, DirEntry&#125;;</span><br><span class="line"><span class="keyword">use</span> std::path::Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 创建目录 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建单级目录</span></span><br><span class="line">    fs::<span class="title function_ invoke__">create_dir</span>(<span class="string">&quot;new_dir&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 递归创建多级目录</span></span><br><span class="line">    fs::<span class="title function_ invoke__">create_dir_all</span>(<span class="string">&quot;path/to/nested/dir&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 删除目录 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 删除空目录</span></span><br><span class="line">    fs::<span class="title function_ invoke__">remove_dir</span>(<span class="string">&quot;empty_dir&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 递归删除目录及内容</span></span><br><span class="line">    fs::<span class="title function_ invoke__">remove_dir_all</span>(<span class="string">&quot;dir_with_contents&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 读取目录内容 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式1: 简单遍历</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> fs::<span class="title function_ invoke__">read_dir</span>(<span class="string">&quot;.&quot;</span>)? &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">entry</span> = entry?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">path</span> = entry.<span class="title function_ invoke__">path</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">file_type</span> = entry.<span class="title function_ invoke__">file_type</span>()?;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> file_type.<span class="title function_ invoke__">is_dir</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[DIR]  &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">display</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> file_type.<span class="title function_ invoke__">is_file</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[FILE] &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">display</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> file_type.<span class="title function_ invoke__">is_symlink</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[LINK] &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">display</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式2: 递归遍历目录</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">visit_dirs</span>(dir: &amp;Path, depth: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> dir.<span class="title function_ invoke__">is_dir</span>() &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> fs::<span class="title function_ invoke__">read_dir</span>(dir)? &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">entry</span> = entry?;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">path</span> = entry.<span class="title function_ invoke__">path</span>();</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">indent</span> = <span class="string">&quot;  &quot;</span>.<span class="title function_ invoke__">repeat</span>(depth);</span><br><span class="line">              </span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, indent, path.<span class="title function_ invoke__">file_name</span>().<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">to_string_lossy</span>());</span><br><span class="line">              </span><br><span class="line">                <span class="keyword">if</span> path.<span class="title function_ invoke__">is_dir</span>() &#123;</span><br><span class="line">                    <span class="title function_ invoke__">visit_dirs</span>(&amp;path, depth + <span class="number">1</span>)?;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">visit_dirs</span>(Path::<span class="title function_ invoke__">new</span>(<span class="string">&quot;.&quot;</span>), <span class="number">0</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 获取特殊目录 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 当前工作目录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cwd</span> = std::env::<span class="title function_ invoke__">current_dir</span>()?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;当前目录: &#123;&#125;&quot;</span>, cwd.<span class="title function_ invoke__">display</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 切换工作目录</span></span><br><span class="line">    std::env::<span class="title function_ invoke__">set_current_dir</span>(<span class="string">&quot;/tmp&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 临时目录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">temp_dir</span> = std::env::<span class="title function_ invoke__">temp_dir</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;临时目录: &#123;&#125;&quot;</span>, temp_dir.<span class="title function_ invoke__">display</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="文件元数据"><a href="#文件元数据" class="headerlink" title="文件元数据"></a>文件元数据</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::&#123;<span class="keyword">self</span>, Metadata, Permissions&#125;;</span><br><span class="line"><span class="keyword">use</span> std::os::unix::fs::PermissionsExt;  <span class="comment">// Unix 特定</span></span><br><span class="line"><span class="keyword">use</span> std::time::SystemTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">metadata</span> = fs::<span class="title function_ invoke__">metadata</span>(<span class="string">&quot;file.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 基本信息 ============</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是文件: &#123;&#125;&quot;</span>, metadata.<span class="title function_ invoke__">is_file</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是目录: &#123;&#125;&quot;</span>, metadata.<span class="title function_ invoke__">is_dir</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;是符号链接: &#123;&#125;&quot;</span>, metadata.<span class="title function_ invoke__">is_symlink</span>());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;文件大小: &#123;&#125; bytes&quot;</span>, metadata.<span class="title function_ invoke__">len</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 时间戳 ============</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(modified) = metadata.<span class="title function_ invoke__">modified</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;修改时间: &#123;:?&#125;&quot;</span>, modified);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(accessed) = metadata.<span class="title function_ invoke__">accessed</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;访问时间: &#123;:?&#125;&quot;</span>, accessed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(created) = metadata.<span class="title function_ invoke__">created</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;创建时间: &#123;:?&#125;&quot;</span>, created);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 权限操作 (Unix) ============</span></span><br><span class="line">    <span class="meta">#[cfg(unix)]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">permissions</span> = metadata.<span class="title function_ invoke__">permissions</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mode</span> = permissions.<span class="title function_ invoke__">mode</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;权限: &#123;:o&#125;&quot;</span>, mode);  <span class="comment">// 八进制显示</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;只读: &#123;&#125;&quot;</span>, permissions.<span class="title function_ invoke__">readonly</span>());</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置权限</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">perms</span> = fs::<span class="title function_ invoke__">metadata</span>(<span class="string">&quot;file.txt&quot;</span>)?.<span class="title function_ invoke__">permissions</span>();</span><br><span class="line">        perms.<span class="title function_ invoke__">set_mode</span>(<span class="number">0o644</span>);  <span class="comment">// rw-r--r--</span></span><br><span class="line">        fs::<span class="title function_ invoke__">set_permissions</span>(<span class="string">&quot;file.txt&quot;</span>, perms)?;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置只读</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">perms</span> = fs::<span class="title function_ invoke__">metadata</span>(<span class="string">&quot;file.txt&quot;</span>)?.<span class="title function_ invoke__">permissions</span>();</span><br><span class="line">        perms.<span class="title function_ invoke__">set_readonly</span>(<span class="literal">true</span>);</span><br><span class="line">        fs::<span class="title function_ invoke__">set_permissions</span>(<span class="string">&quot;file.txt&quot;</span>, perms)?;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 符号链接元数据 ============</span></span><br><span class="line">    <span class="comment">// metadata() 跟随符号链接</span></span><br><span class="line">    <span class="comment">// symlink_metadata() 获取链接本身的信息</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">link_metadata</span> = fs::<span class="title function_ invoke__">symlink_metadata</span>(<span class="string">&quot;symlink&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="文件系统操作"><a href="#文件系统操作" class="headerlink" title="文件系统操作"></a>文件系统操作</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs;</span><br><span class="line"><span class="keyword">use</span> std::path::Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 复制文件 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes_copied</span> = fs::<span class="title function_ invoke__">copy</span>(<span class="string">&quot;source.txt&quot;</span>, <span class="string">&quot;dest.txt&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;复制了 &#123;&#125; 字节&quot;</span>, bytes_copied);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 重命名/移动文件 ============</span></span><br><span class="line">    fs::<span class="title function_ invoke__">rename</span>(<span class="string">&quot;old_name.txt&quot;</span>, <span class="string">&quot;new_name.txt&quot;</span>)?;</span><br><span class="line">    fs::<span class="title function_ invoke__">rename</span>(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;subdir/file.txt&quot;</span>)?;  <span class="comment">// 移动</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 删除文件 ============</span></span><br><span class="line">    fs::<span class="title function_ invoke__">remove_file</span>(<span class="string">&quot;to_delete.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 创建硬链接 ============</span></span><br><span class="line">    fs::<span class="title function_ invoke__">hard_link</span>(<span class="string">&quot;original.txt&quot;</span>, <span class="string">&quot;hardlink.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 创建符号链接 ============</span></span><br><span class="line">    <span class="meta">#[cfg(unix)]</span></span><br><span class="line">    std::os::unix::fs::<span class="title function_ invoke__">symlink</span>(<span class="string">&quot;target.txt&quot;</span>, <span class="string">&quot;symlink.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[cfg(windows)]</span></span><br><span class="line">    std::os::windows::fs::<span class="title function_ invoke__">symlink_file</span>(<span class="string">&quot;target.txt&quot;</span>, <span class="string">&quot;symlink.txt&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 读取符号链接目标 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target</span> = fs::<span class="title function_ invoke__">read_link</span>(<span class="string">&quot;symlink.txt&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;链接指向: &#123;&#125;&quot;</span>, target.<span class="title function_ invoke__">display</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="异步文件操作-Tokio"><a href="#异步文件操作-Tokio" class="headerlink" title="异步文件操作 (Tokio)"></a>异步文件操作 (Tokio)</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio::fs::&#123;<span class="keyword">self</span>, File&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio::io::&#123;AsyncReadExt, AsyncWriteExt, BufReader, AsyncBufReadExt&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 快捷方法 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">content</span> = fs::<span class="title function_ invoke__">read_to_string</span>(<span class="string">&quot;config.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span> = fs::<span class="title function_ invoke__">read</span>(<span class="string">&quot;data.bin&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入文件</span></span><br><span class="line">    fs::<span class="title function_ invoke__">write</span>(<span class="string">&quot;output.txt&quot;</span>, <span class="string">&quot;Hello Async!&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ File 操作 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打开文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;input.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">content</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> content).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = File::<span class="title function_ invoke__">create</span>(<span class="string">&quot;output.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    file.<span class="title function_ invoke__">write_all</span>(<span class="string">b&quot;Hello!&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    file.<span class="title function_ invoke__">sync_all</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 按行读取 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = File::<span class="title function_ invoke__">open</span>(<span class="string">&quot;log.txt&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reader</span> = BufReader::<span class="title function_ invoke__">new</span>(file);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">lines</span> = reader.<span class="title function_ invoke__">lines</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(line) = lines.<span class="title function_ invoke__">next_line</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, line);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 目录操作 ============</span></span><br><span class="line">    fs::<span class="title function_ invoke__">create_dir_all</span>(<span class="string">&quot;path/to/dir&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    fs::<span class="title function_ invoke__">remove_dir_all</span>(<span class="string">&quot;old_dir&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">entries</span> = fs::<span class="title function_ invoke__">read_dir</span>(<span class="string">&quot;.&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(entry) = entries.<span class="title function_ invoke__">next_entry</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, entry.<span class="title function_ invoke__">path</span>().<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="实用工具库"><a href="#实用工具库" class="headerlink" title="实用工具库"></a>实用工具库</h2><h3 id="walkdir-递归目录遍历"><a href="#walkdir-递归目录遍历" class="headerlink" title="walkdir - 递归目录遍历"></a>walkdir - 递归目录遍历</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">walkdir</span> = <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> walkdir::WalkDir;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 递归遍历</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> WalkDir::<span class="title function_ invoke__">new</span>(<span class="string">&quot;.&quot;</span>).<span class="title function_ invoke__">into_iter</span>().<span class="title function_ invoke__">filter_map</span>(|e| e.<span class="title function_ invoke__">ok</span>()) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, entry.<span class="title function_ invoke__">path</span>().<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 限制深度 + 过滤</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> WalkDir::<span class="title function_ invoke__">new</span>(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">max_depth</span>(<span class="number">3</span>)</span><br><span class="line">        .<span class="title function_ invoke__">into_iter</span>()</span><br><span class="line">        .<span class="title function_ invoke__">filter_entry</span>(|e| !e.<span class="title function_ invoke__">file_name</span>().<span class="title function_ invoke__">to_str</span>().<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">starts_with</span>(<span class="string">&quot;.&quot;</span>)).<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>))</span><br><span class="line">        .<span class="title function_ invoke__">filter_map</span>(|e| e.<span class="title function_ invoke__">ok</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> entry.<span class="title function_ invoke__">file_type</span>().<span class="title function_ invoke__">is_file</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, entry.<span class="title function_ invoke__">path</span>().<span class="title function_ invoke__">display</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="glob-文件模式匹配"><a href="#glob-文件模式匹配" class="headerlink" title="glob - 文件模式匹配"></a>glob - 文件模式匹配</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">glob</span> = <span class="string">&quot;0.3&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> glob::glob;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">    <span class="comment">// 匹配所有 .rs 文件</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> <span class="title function_ invoke__">glob</span>(<span class="string">&quot;src/**/*.rs&quot;</span>)? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, entry?.<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 匹配多种模式</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">entry</span> <span class="keyword">in</span> <span class="title function_ invoke__">glob</span>(<span class="string">&quot;*.&#123;txt,md,toml&#125;&quot;</span>)? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, entry?.<span class="title function_ invoke__">display</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="tempfile-临时文件"><a href="#tempfile-临时文件" class="headerlink" title="tempfile - 临时文件"></a>tempfile - 临时文件</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">tempfile</span> = <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tempfile::&#123;tempfile, tempdir, NamedTempFile&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::Write;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> std::io::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 匿名临时文件（自动删除）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = <span class="title function_ invoke__">tempfile</span>()?;</span><br><span class="line">    <span class="built_in">writeln!</span>(file, <span class="string">&quot;temporary data&quot;</span>)?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 命名临时文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">named_file</span> = NamedTempFile::<span class="title function_ invoke__">new</span>()?;</span><br><span class="line">    <span class="built_in">writeln!</span>(named_file, <span class="string">&quot;data&quot;</span>)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;临时文件路径: &#123;&#125;&quot;</span>, named_file.<span class="title function_ invoke__">path</span>().<span class="title function_ invoke__">display</span>());</span><br><span class="line">    <span class="comment">// 离开作用域自动删除</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 保留临时文件</span></span><br><span class="line">    <span class="keyword">let</span> (file, path) = NamedTempFile::<span class="title function_ invoke__">new</span>()?.<span class="title function_ invoke__">keep</span>()?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 临时目录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">temp_dir</span> = <span class="title function_ invoke__">tempdir</span>()?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file_path</span> = temp_dir.<span class="title function_ invoke__">path</span>().<span class="title function_ invoke__">join</span>(<span class="string">&quot;temp.txt&quot;</span>);</span><br><span class="line">    std::fs::<span class="title function_ invoke__">write</span>(&amp;file_path, <span class="string">&quot;data&quot;</span>)?;</span><br><span class="line">    <span class="comment">// temp_dir 离开作用域时自动删除</span></span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="错误处理-1"><a href="#错误处理-1" class="headerlink" title="错误处理"></a>错误处理</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fs::File;</span><br><span class="line"><span class="keyword">use</span> std::io::&#123;<span class="keyword">self</span>, Read, ErrorKind&#125;;</span><br><span class="line"><span class="keyword">use</span> std::path::Path;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 详细错误处理 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_file_verbose</span>(path: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">file</span> = <span class="keyword">match</span> File::<span class="title function_ invoke__">open</span>(path) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(f) =&gt; f,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">match</span> e.<span class="title function_ invoke__">kind</span>() &#123;</span><br><span class="line">            ErrorKind::NotFound =&gt; &#123;</span><br><span class="line">                eprintln!(<span class="string">&quot;文件不存在: &#123;&#125;&quot;</span>, path);</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            ErrorKind::PermissionDenied =&gt; &#123;</span><br><span class="line">                eprintln!(<span class="string">&quot;权限不足: &#123;&#125;&quot;</span>, path);</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; &#123;</span><br><span class="line">                eprintln!(<span class="string">&quot;打开文件失败: &#123;&#125;&quot;</span>, e);</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">content</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    file.<span class="title function_ invoke__">read_to_string</span>(&amp;<span class="keyword">mut</span> content)?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(content)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 使用 anyhow 简化 ============</span></span><br><span class="line"><span class="keyword">use</span> anyhow::&#123;Context, <span class="type">Result</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">read_config</span>(path: &amp;Path) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    std::fs::<span class="title function_ invoke__">read_to_string</span>(path)</span><br><span class="line">        .<span class="title function_ invoke__">with_context</span>(|| <span class="built_in">format!</span>(<span class="string">&quot;无法读取配置文件: &#123;&#125;&quot;</span>, path.<span class="title function_ invoke__">display</span>()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 检查文件存在后操作 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">safe_read</span>(path: &amp;Path) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> !path.<span class="title function_ invoke__">exists</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(io::Error::<span class="title function_ invoke__">new</span>(ErrorKind::NotFound, <span class="string">&quot;文件不存在&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !path.<span class="title function_ invoke__">is_file</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(io::Error::<span class="title function_ invoke__">new</span>(ErrorKind::InvalidInput, <span class="string">&quot;不是文件&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    std::fs::<span class="title function_ invoke__">read_to_string</span>(path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="数据库编程"><a href="#数据库编程" class="headerlink" title="数据库编程"></a>数据库编程</h1><h2 id="核心生态架构"><a href="#核心生态架构" class="headerlink" title="核心生态架构"></a>核心生态架构</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Rust 数据库生态                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  ORM 框架       │  Diesel (同步)  │  SeaORM (异步)  │  rbatis       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  SQL 工具库     │  SQLx (异步/编译时检查)  │  rusqlite (SQLite)     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  NoSQL          │  mongodb  │  redis  │  sled (嵌入式)              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  连接池         │        deadpool   │   r2d2   │   bb8             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  支持数据库     │  PostgreSQL │ MySQL │ SQLite │ MSSQL │ MongoDB   │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<p><strong>库选择指南</strong></p>
<table>
<thead>
<tr>
<th>库</th>
<th>类型</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>SQLx</strong></td>
<td>SQL工具</td>
<td>编译时检查、异步、轻量</td>
<td>需要原生SQL控制</td>
</tr>
<tr>
<td><strong>Diesel</strong></td>
<td>ORM</td>
<td>类型安全、同步、成熟</td>
<td>传统同步应用</td>
</tr>
<tr>
<td><strong>SeaORM</strong></td>
<td>ORM</td>
<td>异步、动态查询、ActiveRecord</td>
<td>异步Web服务</td>
</tr>
<tr>
<td><strong>rusqlite</strong></td>
<td>SQLite</td>
<td>同步、嵌入式、简单</td>
<td>本地应用&#x2F;测试</td>
</tr>
</tbody></table>
<hr>
<h2 id="SQLx-异步-SQL-工具库"><a href="#SQLx-异步-SQL-工具库" class="headerlink" title="SQLx - 异步 SQL 工具库"></a>SQLx - 异步 SQL 工具库</h2><h3 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">sqlx</span> = &#123; version = <span class="string">&quot;0.7&quot;</span>, features = [</span><br><span class="line">    <span class="string">&quot;runtime-tokio&quot;</span>,      <span class="comment"># 异步运行时</span></span><br><span class="line">    <span class="string">&quot;tls-rustls&quot;</span>,         <span class="comment"># TLS支持</span></span><br><span class="line">    <span class="string">&quot;postgres&quot;</span>,           <span class="comment"># PostgreSQL</span></span><br><span class="line">    <span class="comment"># &quot;mysql&quot;,            # MySQL</span></span><br><span class="line">    <span class="comment"># &quot;sqlite&quot;,           # SQLite</span></span><br><span class="line">    <span class="string">&quot;macros&quot;</span>,             <span class="comment"># 宏支持</span></span><br><span class="line">    <span class="string">&quot;chrono&quot;</span>,             <span class="comment"># 时间类型</span></span><br><span class="line">    <span class="string">&quot;uuid&quot;</span>,               <span class="comment"># UUID类型</span></span><br><span class="line">] &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">chrono</span> = &#123; version = <span class="string">&quot;0.4&quot;</span>, features = [<span class="string">&quot;serde&quot;</span>] &#125;</span><br><span class="line"><span class="attr">uuid</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;v4&quot;</span>, <span class="string">&quot;serde&quot;</span>] &#125;</span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="连接与连接池"><a href="#连接与连接池" class="headerlink" title="连接与连接池"></a>连接与连接池</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sqlx::&#123;PgPool, Pool, Postgres&#125;;</span><br><span class="line"><span class="keyword">use</span> sqlx::postgres::PgPoolOptions;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 方式1: 快速连接 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool</span> = PgPool::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;postgres://user:pass@localhost/dbname&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式2: 详细配置连接池 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool</span> = PgPoolOptions::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">max_connections</span>(<span class="number">10</span>)              <span class="comment">// 最大连接数</span></span><br><span class="line">        .<span class="title function_ invoke__">min_connections</span>(<span class="number">2</span>)               <span class="comment">// 最小连接数</span></span><br><span class="line">        .<span class="title function_ invoke__">acquire_timeout</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">30</span>))</span><br><span class="line">        .<span class="title function_ invoke__">idle_timeout</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">600</span>))</span><br><span class="line">        .<span class="title function_ invoke__">max_lifetime</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">1800</span>))</span><br><span class="line">        .<span class="title function_ invoke__">connect</span>(<span class="string">&quot;postgres://user:pass@localhost/dbname&quot;</span>)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 方式3: 从环境变量 ============</span></span><br><span class="line">    <span class="comment">// DATABASE_URL=postgres://user:pass@localhost/dbname</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pool</span> = PgPool::<span class="title function_ invoke__">connect</span>(&amp;std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;DATABASE_URL&quot;</span>)?).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查连接</span></span><br><span class="line">    sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT 1&quot;</span>).<span class="title function_ invoke__">execute</span>(&amp;pool).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;数据库连接成功!&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="基本-CRUD-操作"><a href="#基本-CRUD-操作" class="headerlink" title="基本 CRUD 操作"></a>基本 CRUD 操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sqlx::&#123;PgPool, Row, FromRow&#125;;</span><br><span class="line"><span class="keyword">use</span> chrono::&#123;DateTime, Utc&#125;;</span><br><span class="line"><span class="keyword">use</span> uuid::Uuid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义模型</span></span><br><span class="line"><span class="meta">#[derive(Debug, FromRow)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    id: <span class="type">i32</span>,</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">    created_at: DateTime&lt;Utc&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CreateUser</span> &#123;</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">crud_examples</span>(pool: &amp;PgPool) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ CREATE ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式1: execute 返回影响行数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = sqlx::<span class="title function_ invoke__">query</span>(</span><br><span class="line">        <span class="string">&quot;INSERT INTO users (username, email) VALUES ($1, $2)&quot;</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="string">&quot;alice&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="string">&quot;alice@example.com&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">execute</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;插入 &#123;&#125; 行&quot;</span>, result.<span class="title function_ invoke__">rows_affected</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 方式2: 返回插入的ID</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">id</span>: (<span class="type">i32</span>,) = sqlx::<span class="title function_ invoke__">query_as</span>(</span><br><span class="line">        <span class="string">&quot;INSERT INTO users (username, email) VALUES ($1, $2) RETURNING id&quot;</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="string">&quot;bob&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="string">&quot;bob@example.com&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;新用户ID: &#123;&#125;&quot;</span>, id.<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ READ ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询单条记录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span>: User = sqlx::<span class="title function_ invoke__">query_as</span>(<span class="string">&quot;SELECT * FROM users WHERE id = $1&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;用户: &#123;:?&#125;&quot;</span>, user);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询可能不存在的记录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span>: <span class="type">Option</span>&lt;User&gt; = sqlx::<span class="title function_ invoke__">query_as</span>(<span class="string">&quot;SELECT * FROM users WHERE id = $1&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(<span class="number">999</span>)</span><br><span class="line">        .<span class="title function_ invoke__">fetch_optional</span>(pool)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询多条记录</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">users</span>: <span class="type">Vec</span>&lt;User&gt; = sqlx::<span class="title function_ invoke__">query_as</span>(<span class="string">&quot;SELECT * FROM users LIMIT $1&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(<span class="number">10i64</span>)</span><br><span class="line">        .<span class="title function_ invoke__">fetch_all</span>(pool)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 流式查询（大数据集）</span></span><br><span class="line">    <span class="keyword">use</span> futures::TryStreamExt;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stream</span> = sqlx::query_as::&lt;_, User&gt;(<span class="string">&quot;SELECT * FROM users&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">fetch</span>(pool);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(user) = stream.<span class="title function_ invoke__">try_next</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;流式: &#123;:?&#125;&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ UPDATE ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = sqlx::<span class="title function_ invoke__">query</span>(</span><br><span class="line">        <span class="string">&quot;UPDATE users SET email = $1 WHERE id = $2&quot;</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="string">&quot;newemail@example.com&quot;</span>)</span><br><span class="line">    .<span class="title function_ invoke__">bind</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_ invoke__">execute</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;更新 &#123;&#125; 行&quot;</span>, result.<span class="title function_ invoke__">rows_affected</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ DELETE ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;DELETE FROM users WHERE id = $1&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_ invoke__">execute</span>(pool)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;删除 &#123;&#125; 行&quot;</span>, result.<span class="title function_ invoke__">rows_affected</span>());</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="编译时检查宏"><a href="#编译时检查宏" class="headerlink" title="编译时检查宏"></a>编译时检查宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sqlx::&#123;PgPool, FromRow&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, FromRow)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    id: <span class="type">i32</span>,</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要设置 DATABASE_URL 环境变量，编译时检查SQL</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">compile_time_checked</span>(pool: &amp;PgPool) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ query! 宏 - 返回匿名类型 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">row</span> = sqlx::query!(</span><br><span class="line">        <span class="string">&quot;SELECT id, username, email FROM users WHERE id = $1&quot;</span>,</span><br><span class="line">        <span class="number">1i32</span>  <span class="comment">// 参数类型会被检查</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 字段名在编译时已知</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;ID: &#123;&#125;, Username: &#123;&#125;&quot;</span>, row.id, row.username);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ query_as! 宏 - 映射到结构体 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = sqlx::query_as!(</span><br><span class="line">        User,</span><br><span class="line">        <span class="string">&quot;SELECT id, username, email FROM users WHERE id = $1&quot;</span>,</span><br><span class="line">        <span class="number">1i32</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 可空字段处理 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">row</span> = sqlx::query!(</span><br><span class="line">        <span class="string">r#&quot;SELECT id, username, bio as &quot;bio?&quot; FROM users WHERE id = $1&quot;#</span>,</span><br><span class="line">        <span class="number">1i32</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="comment">// row.bio 类型为 Option&lt;String&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 强制非空 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">row</span> = sqlx::query!(</span><br><span class="line">        <span class="string">r#&quot;SELECT id, username as &quot;username!&quot; FROM users WHERE id = $1&quot;#</span>,</span><br><span class="line">        <span class="number">1i32</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 类型转换 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">row</span> = sqlx::query!(</span><br><span class="line">        <span class="string">r#&quot;SELECT COUNT(*) as &quot;count!: i64&quot; FROM users&quot;#</span></span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_ invoke__">fetch_one</span>(pool)</span><br><span class="line">    .<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;总数: &#123;&#125;&quot;</span>, row.count);</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 离线模式（CI/CD用）</span></span><br><span class="line"><span class="comment">// 1. cargo sqlx prepare  生成 .sqlx 目录</span></span><br><span class="line"><span class="comment">// 2. 设置 SQLX_OFFLINE=true</span></span><br></pre></td></tr></table></figure></div>

<h3 id="事务处理"><a href="#事务处理" class="headerlink" title="事务处理"></a>事务处理</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sqlx::PgPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">transfer_money</span>(</span><br><span class="line">    pool: &amp;PgPool,</span><br><span class="line">    from_id: <span class="type">i32</span>,</span><br><span class="line">    to_id: <span class="type">i32</span>,</span><br><span class="line">    amount: <span class="type">f64</span>,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ============ 方式1: 简单事务 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tx</span> = pool.<span class="title function_ invoke__">begin</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 扣款</span></span><br><span class="line">    sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;UPDATE accounts SET balance = balance - $1 WHERE id = $2&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(amount)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(from_id)</span><br><span class="line">        .<span class="title function_ invoke__">execute</span>(&amp;<span class="keyword">mut</span> *tx)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 入账</span></span><br><span class="line">    sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;UPDATE accounts SET balance = balance + $1 WHERE id = $2&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(amount)</span><br><span class="line">        .<span class="title function_ invoke__">bind</span>(to_id)</span><br><span class="line">        .<span class="title function_ invoke__">execute</span>(&amp;<span class="keyword">mut</span> *tx)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 提交（如果函数提前返回Err，事务自动回滚）</span></span><br><span class="line">    tx.<span class="title function_ invoke__">commit</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 方式2: 嵌套事务（Savepoint）============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">nested_transaction</span>(pool: &amp;PgPool) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">tx</span> = pool.<span class="title function_ invoke__">begin</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;INSERT INTO logs (msg) VALUES (&#x27;outer&#x27;)&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">execute</span>(&amp;<span class="keyword">mut</span> *tx)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建保存点</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">savepoint</span> = tx.<span class="title function_ invoke__">begin</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = sqlx::<span class="title function_ invoke__">query</span>(<span class="string">&quot;INSERT INTO users (name) VALUES (&#x27;test&#x27;)&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">execute</span>(&amp;<span class="keyword">mut</span> *savepoint)</span><br><span class="line">        .<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(_) =&gt; savepoint.<span class="title function_ invoke__">commit</span>().<span class="keyword">await</span>?,</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(_) =&gt; &#123;</span><br><span class="line">            <span class="comment">// 只回滚到保存点，外层事务继续</span></span><br><span class="line">            savepoint.<span class="title function_ invoke__">rollback</span>().<span class="keyword">await</span>?;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    tx.<span class="title function_ invoke__">commit</span>().<span class="keyword">await</span>?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Diesel-类型安全-ORM"><a href="#Diesel-类型安全-ORM" class="headerlink" title="Diesel - 类型安全 ORM"></a>Diesel - 类型安全 ORM</h2><h3 id="项目配置-1"><a href="#项目配置-1" class="headerlink" title="项目配置"></a>项目配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">diesel</span> = &#123; version = <span class="string">&quot;2&quot;</span>, features = [<span class="string">&quot;postgres&quot;</span>, <span class="string">&quot;r2d2&quot;</span>, <span class="string">&quot;chrono&quot;</span>] &#125;</span><br><span class="line"><span class="attr">dotenvy</span> = <span class="string">&quot;0.15&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies.diesel_migrations]</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装CLI</span></span><br><span class="line">cargo install diesel_cli --no-default-features --features postgres</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">diesel setup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建迁移</span></span><br><span class="line">diesel migration generate create_users</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行迁移</span></span><br><span class="line">diesel migration run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line">diesel migration revert</span><br></pre></td></tr></table></figure></div>

<h3 id="迁移文件"><a href="#迁移文件" class="headerlink" title="迁移文件"></a>迁移文件</h3><div class="code-container" data-rel="Sql"><figure class="iseeu highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- migrations/2024xxx_create_users/up.sql</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">    id SERIAL <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    username <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">UNIQUE</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> NOW()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- migrations/2024xxx_create_users/down.sql</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> users;</span><br></pre></td></tr></table></figure></div>

<h3 id="Schema-和模型"><a href="#Schema-和模型" class="headerlink" title="Schema 和模型"></a>Schema 和模型</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/schema.rs (diesel自动生成)</span></span><br><span class="line">diesel::table! &#123;</span><br><span class="line">    <span class="title function_ invoke__">users</span> (id) &#123;</span><br><span class="line">        id <span class="punctuation">-&gt;</span> Int4,</span><br><span class="line">        username <span class="punctuation">-&gt;</span> Varchar,</span><br><span class="line">        email <span class="punctuation">-&gt;</span> Varchar,</span><br><span class="line">        created_at <span class="punctuation">-&gt;</span> Timestamp,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/models.rs</span></span><br><span class="line"><span class="keyword">use</span> diesel::prelude::*;</span><br><span class="line"><span class="keyword">use</span> chrono::NaiveDateTime;</span><br><span class="line"><span class="keyword">use</span> crate::schema::users;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询用模型</span></span><br><span class="line"><span class="meta">#[derive(Debug, Queryable, Selectable)]</span></span><br><span class="line"><span class="meta">#[diesel(table_name = users)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="type">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> username: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> email: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> created_at: NaiveDateTime,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入用模型</span></span><br><span class="line"><span class="meta">#[derive(Debug, Insertable)]</span></span><br><span class="line"><span class="meta">#[diesel(table_name = users)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NewUser</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> username: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">    <span class="keyword">pub</span> email: &amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新用模型</span></span><br><span class="line"><span class="meta">#[derive(Debug, AsChangeset)]</span></span><br><span class="line"><span class="meta">#[diesel(table_name = users)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UpdateUser</span>&lt;<span class="symbol">&#x27;a</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> username: <span class="type">Option</span>&lt;&amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>&gt;,</span><br><span class="line">    <span class="keyword">pub</span> email: <span class="type">Option</span>&lt;&amp;<span class="symbol">&#x27;a</span> <span class="type">str</span>&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CRUD-操作"><a href="#CRUD-操作" class="headerlink" title="CRUD 操作"></a>CRUD 操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> diesel::prelude::*;</span><br><span class="line"><span class="keyword">use</span> diesel::pg::PgConnection;</span><br><span class="line"><span class="keyword">use</span> diesel::r2d2::&#123;<span class="keyword">self</span>, ConnectionManager&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">DbPool</span> = r2d2::Pool&lt;ConnectionManager&lt;PgConnection&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接池</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">establish_pool</span>() <span class="punctuation">-&gt;</span> DbPool &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">database_url</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;DATABASE_URL&quot;</span>).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;DATABASE_URL must be set&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">manager</span> = ConnectionManager::&lt;PgConnection&gt;::<span class="title function_ invoke__">new</span>(database_url);</span><br><span class="line">    r2d2::Pool::<span class="title function_ invoke__">builder</span>()</span><br><span class="line">        .<span class="title function_ invoke__">max_size</span>(<span class="number">10</span>)</span><br><span class="line">        .<span class="title function_ invoke__">build</span>(manager)</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to create pool&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ CREATE ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_user</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, name: &amp;<span class="type">str</span>, mail: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_user</span> = NewUser &#123;</span><br><span class="line">        username: name,</span><br><span class="line">        email: mail,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    diesel::<span class="title function_ invoke__">insert_into</span>(users::table)</span><br><span class="line">        .<span class="title function_ invoke__">values</span>(&amp;new_user)</span><br><span class="line">        .<span class="title function_ invoke__">returning</span>(User::<span class="title function_ invoke__">as_returning</span>())</span><br><span class="line">        .<span class="title function_ invoke__">get_result</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量插入</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">create_users</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, new_users: &amp;[NewUser]) <span class="punctuation">-&gt;</span> QueryResult&lt;<span class="type">Vec</span>&lt;User&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users;</span><br><span class="line">  </span><br><span class="line">    diesel::<span class="title function_ invoke__">insert_into</span>(users::table)</span><br><span class="line">        .<span class="title function_ invoke__">values</span>(new_users)</span><br><span class="line">        .<span class="title function_ invoke__">returning</span>(User::<span class="title function_ invoke__">as_returning</span>())</span><br><span class="line">        .<span class="title function_ invoke__">get_results</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ READ ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_user</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, user_id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    users.<span class="title function_ invoke__">find</span>(user_id).<span class="title function_ invoke__">first</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_user_by_name</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, name: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;<span class="type">Option</span>&lt;User&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    users</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(username.<span class="title function_ invoke__">eq</span>(name))</span><br><span class="line">        .<span class="title function_ invoke__">first</span>(conn)</span><br><span class="line">        .<span class="title function_ invoke__">optional</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">list_users</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, page: <span class="type">i64</span>, per_page: <span class="type">i64</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;<span class="type">Vec</span>&lt;User&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    users</span><br><span class="line">        .<span class="title function_ invoke__">order</span>(created_at.<span class="title function_ invoke__">desc</span>())</span><br><span class="line">        .<span class="title function_ invoke__">limit</span>(per_page)</span><br><span class="line">        .<span class="title function_ invoke__">offset</span>(page * per_page)</span><br><span class="line">        .<span class="title function_ invoke__">load</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂查询</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">search_users</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, query: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;<span class="type">Vec</span>&lt;User&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    users</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(username.<span class="title function_ invoke__">ilike</span>(<span class="built_in">format!</span>(<span class="string">&quot;%&#123;&#125;%&quot;</span>, query)))</span><br><span class="line">        .<span class="title function_ invoke__">or_filter</span>(email.<span class="title function_ invoke__">ilike</span>(<span class="built_in">format!</span>(<span class="string">&quot;%&#123;&#125;%&quot;</span>, query)))</span><br><span class="line">        .<span class="title function_ invoke__">order</span>(username.<span class="title function_ invoke__">asc</span>())</span><br><span class="line">        .<span class="title function_ invoke__">load</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ UPDATE ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">update_user</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, user_id: <span class="type">i32</span>, update: UpdateUser) <span class="punctuation">-&gt;</span> QueryResult&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    diesel::<span class="title function_ invoke__">update</span>(users.<span class="title function_ invoke__">find</span>(user_id))</span><br><span class="line">        .<span class="title function_ invoke__">set</span>(&amp;update)</span><br><span class="line">        .<span class="title function_ invoke__">returning</span>(User::<span class="title function_ invoke__">as_returning</span>())</span><br><span class="line">        .<span class="title function_ invoke__">get_result</span>(conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ DELETE ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">delete_user</span>(conn: &amp;<span class="keyword">mut</span> PgConnection, user_id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> QueryResult&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> crate::schema::users::dsl::*;</span><br><span class="line">  </span><br><span class="line">    diesel::<span class="title function_ invoke__">delete</span>(users.<span class="title function_ invoke__">find</span>(user_id)).<span class="title function_ invoke__">execute</span>(conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">transfer_in_transaction</span>(conn: &amp;<span class="keyword">mut</span> PgConnection) <span class="punctuation">-&gt;</span> QueryResult&lt;()&gt; &#123;</span><br><span class="line">    conn.<span class="title function_ invoke__">transaction</span>(|conn| &#123;</span><br><span class="line">        <span class="comment">// 所有操作在同一事务中</span></span><br><span class="line">        diesel::<span class="title function_ invoke__">update</span>(accounts.<span class="title function_ invoke__">find</span>(<span class="number">1</span>))</span><br><span class="line">            .<span class="title function_ invoke__">set</span>(balance.<span class="title function_ invoke__">eq</span>(balance - <span class="number">100</span>))</span><br><span class="line">            .<span class="title function_ invoke__">execute</span>(conn)?;</span><br><span class="line">      </span><br><span class="line">        diesel::<span class="title function_ invoke__">update</span>(accounts.<span class="title function_ invoke__">find</span>(<span class="number">2</span>))</span><br><span class="line">            .<span class="title function_ invoke__">set</span>(balance.<span class="title function_ invoke__">eq</span>(balance + <span class="number">100</span>))</span><br><span class="line">            .<span class="title function_ invoke__">execute</span>(conn)?;</span><br><span class="line">      </span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="SeaORM-异步-ORM"><a href="#SeaORM-异步-ORM" class="headerlink" title="SeaORM - 异步 ORM"></a>SeaORM - 异步 ORM</h2><h3 id="项目配置-2"><a href="#项目配置-2" class="headerlink" title="项目配置"></a>项目配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">sea-orm</span> = &#123; version = <span class="string">&quot;0.12&quot;</span>, features = [</span><br><span class="line">    <span class="string">&quot;runtime-tokio-rustls&quot;</span>,</span><br><span class="line">    <span class="string">&quot;sqlx-postgres&quot;</span>,</span><br><span class="line">    <span class="string">&quot;macros&quot;</span>,</span><br><span class="line">] &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Entity-定义"><a href="#Entity-定义" class="headerlink" title="Entity 定义"></a>Entity 定义</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// entity/user.rs</span></span><br><span class="line"><span class="keyword">use</span> sea_orm::entity::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Clone, Debug, PartialEq, DeriveEntityModel)]</span></span><br><span class="line"><span class="meta">#[sea_orm(table_name = <span class="string">&quot;users&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Model</span> &#123;</span><br><span class="line">    <span class="meta">#[sea_orm(primary_key)]</span></span><br><span class="line">    <span class="keyword">pub</span> id: <span class="type">i32</span>,</span><br><span class="line">    <span class="meta">#[sea_orm(unique)]</span></span><br><span class="line">    <span class="keyword">pub</span> username: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> email: <span class="type">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> created_at: DateTimeUtc,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Relation</span> &#123;</span><br><span class="line">    <span class="meta">#[sea_orm(has_many = <span class="string">&quot;super::post::Entity&quot;</span>)]</span></span><br><span class="line">    Posts,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Related</span>&lt;super::post::Entity&gt; <span class="keyword">for</span> <span class="title class_">Entity</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">to</span>() <span class="punctuation">-&gt;</span> RelationDef &#123;</span><br><span class="line">        Relation::Posts.<span class="title function_ invoke__">def</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ActiveModelBehavior</span> <span class="keyword">for</span> <span class="title class_">ActiveModel</span> &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CRUD-操作-1"><a href="#CRUD-操作-1" class="headerlink" title="CRUD 操作"></a>CRUD 操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> sea_orm::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 连接 ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">connect</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;DatabaseConnection, DbErr&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">db</span> = Database::<span class="title function_ invoke__">connect</span>(<span class="string">&quot;postgres://user:pass@localhost/db&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(db)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ CREATE ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">create_user</span>(db: &amp;DatabaseConnection) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;user::Model, DbErr&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_user</span> = user::ActiveModel &#123;</span><br><span class="line">        username: <span class="title function_ invoke__">Set</span>(<span class="string">&quot;alice&quot;</span>.<span class="title function_ invoke__">to_owned</span>()),</span><br><span class="line">        email: <span class="title function_ invoke__">Set</span>(<span class="string">&quot;alice@example.com&quot;</span>.<span class="title function_ invoke__">to_owned</span>()),</span><br><span class="line">        ..<span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    new_user.<span class="title function_ invoke__">insert</span>(db).<span class="keyword">await</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ READ ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">find_user</span>(db: &amp;DatabaseConnection, id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Option</span>&lt;user::Model&gt;, DbErr&gt; &#123;</span><br><span class="line">    User::<span class="title function_ invoke__">find_by_id</span>(id).<span class="title function_ invoke__">one</span>(db).<span class="keyword">await</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">find_users</span>(db: &amp;DatabaseConnection) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">Vec</span>&lt;user::Model&gt;, DbErr&gt; &#123;</span><br><span class="line">    User::<span class="title function_ invoke__">find</span>()</span><br><span class="line">        .<span class="title function_ invoke__">filter</span>(user::Column::Username.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;a&quot;</span>))</span><br><span class="line">        .<span class="title function_ invoke__">order_by_asc</span>(user::Column::Id)</span><br><span class="line">        .<span class="title function_ invoke__">limit</span>(<span class="number">10</span>)</span><br><span class="line">        .<span class="title function_ invoke__">all</span>(db)</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ UPDATE ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">update_user</span>(db: &amp;DatabaseConnection, id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;user::Model, DbErr&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span>: user::ActiveModel = User::<span class="title function_ invoke__">find_by_id</span>(id)</span><br><span class="line">        .<span class="title function_ invoke__">one</span>(db)</span><br><span class="line">        .<span class="keyword">await</span>?</span><br><span class="line">        .<span class="title function_ invoke__">ok_or</span>(DbErr::<span class="title function_ invoke__">RecordNotFound</span>(<span class="string">&quot;User not found&quot;</span>.<span class="title function_ invoke__">into</span>()))?</span><br><span class="line">        .<span class="title function_ invoke__">into</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">user</span> = user;</span><br><span class="line">    user.email = <span class="title function_ invoke__">Set</span>(<span class="string">&quot;new@example.com&quot;</span>.<span class="title function_ invoke__">to_owned</span>());</span><br><span class="line">    user.<span class="title function_ invoke__">update</span>(db).<span class="keyword">await</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ DELETE ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">delete_user</span>(db: &amp;DatabaseConnection, id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;DeleteResult, DbErr&gt; &#123;</span><br><span class="line">    User::<span class="title function_ invoke__">delete_by_id</span>(id).<span class="title function_ invoke__">exec</span>(db).<span class="keyword">await</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 事务 ============</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">transaction_example</span>(db: &amp;DatabaseConnection) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), DbErr&gt; &#123;</span><br><span class="line">    db.transaction::&lt;_, (), DbErr&gt;(|txn| &#123;</span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">pin</span>(<span class="keyword">async</span> <span class="keyword">move</span> &#123;</span><br><span class="line">            <span class="comment">// 事务内操作</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">user</span> = user::ActiveModel &#123;</span><br><span class="line">                username: <span class="title function_ invoke__">Set</span>(<span class="string">&quot;bob&quot;</span>.<span class="title function_ invoke__">to_owned</span>()),</span><br><span class="line">                email: <span class="title function_ invoke__">Set</span>(<span class="string">&quot;bob@example.com&quot;</span>.<span class="title function_ invoke__">to_owned</span>()),</span><br><span class="line">                ..<span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>()</span><br><span class="line">            &#125;;</span><br><span class="line">            user.<span class="title function_ invoke__">insert</span>(txn).<span class="keyword">await</span>?;</span><br><span class="line">          </span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="keyword">await</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rusqlite</span> = &#123; version = <span class="string">&quot;0.31&quot;</span>, features = [<span class="string">&quot;bundled&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> rusqlite::&#123;Connection, <span class="type">Result</span>, params&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    id: <span class="type">i32</span>,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 连接（内存数据库或文件）</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">conn</span> = Connection::<span class="title function_ invoke__">open</span>(<span class="string">&quot;app.db&quot;</span>)?;</span><br><span class="line">    <span class="comment">// let conn = Connection::open_in_memory()?;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建表</span></span><br><span class="line">    conn.<span class="title function_ invoke__">execute</span>(</span><br><span class="line">        <span class="string">&quot;CREATE TABLE IF NOT EXISTS users (</span></span><br><span class="line"><span class="string">            id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="string">            name TEXT NOT NULL,</span></span><br><span class="line"><span class="string">            email TEXT NOT NULL UNIQUE</span></span><br><span class="line"><span class="string">        )&quot;</span>,</span><br><span class="line">        [],</span><br><span class="line">    )?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ CREATE ============</span></span><br><span class="line">    conn.<span class="title function_ invoke__">execute</span>(</span><br><span class="line">        <span class="string">&quot;INSERT INTO users (name, email) VALUES (?1, ?2)&quot;</span>,</span><br><span class="line">        params![<span class="string">&quot;Alice&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>],</span><br><span class="line">    )?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">last_id</span> = conn.<span class="title function_ invoke__">last_insert_rowid</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ READ ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stmt</span> = conn.<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT id, name, email FROM users WHERE id = ?1&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = stmt.<span class="title function_ invoke__">query_row</span>([<span class="number">1</span>], |row| &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(User &#123;</span><br><span class="line">            id: row.<span class="title function_ invoke__">get</span>(<span class="number">0</span>)?,</span><br><span class="line">            name: row.<span class="title function_ invoke__">get</span>(<span class="number">1</span>)?,</span><br><span class="line">            email: row.<span class="title function_ invoke__">get</span>(<span class="number">2</span>)?,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询多条</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">stmt</span> = conn.<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT id, name, email FROM users&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">users</span> = stmt.<span class="title function_ invoke__">query_map</span>([], |row| &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(User &#123;</span><br><span class="line">            id: row.<span class="title function_ invoke__">get</span>(<span class="number">0</span>)?,</span><br><span class="line">            name: row.<span class="title function_ invoke__">get</span>(<span class="number">1</span>)?,</span><br><span class="line">            email: row.<span class="title function_ invoke__">get</span>(<span class="number">2</span>)?,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">user</span> <span class="keyword">in</span> users &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user?);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 事务 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tx</span> = conn.<span class="title function_ invoke__">transaction</span>()?;</span><br><span class="line">    tx.<span class="title function_ invoke__">execute</span>(<span class="string">&quot;INSERT INTO users (name, email) VALUES (?1, ?2)&quot;</span>, </span><br><span class="line">               params![<span class="string">&quot;Bob&quot;</span>, <span class="string">&quot;bob@example.com&quot;</span>])?;</span><br><span class="line">    tx.<span class="title function_ invoke__">commit</span>()?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">redis</span> = &#123; version = <span class="string">&quot;0.25&quot;</span>, features = [<span class="string">&quot;tokio-comp&quot;</span>, <span class="string">&quot;connection-manager&quot;</span>] &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> redis::AsyncCommands;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> redis::RedisResult&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 连接</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">client</span> = redis::Client::<span class="title function_ invoke__">open</span>(<span class="string">&quot;redis://127.0.0.1/&quot;</span>)?;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">con</span> = client.<span class="title function_ invoke__">get_multiplexed_async_connection</span>().<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 字符串 ============</span></span><br><span class="line">    con.<span class="title function_ invoke__">set</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">val</span>: <span class="type">String</span> = con.<span class="title function_ invoke__">get</span>(<span class="string">&quot;key&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带过期时间</span></span><br><span class="line">    con.<span class="title function_ invoke__">set_ex</span>(<span class="string">&quot;temp_key&quot;</span>, <span class="string">&quot;temp_value&quot;</span>, <span class="number">60</span>).<span class="keyword">await</span>?;  <span class="comment">// 60秒</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 哈希 ============</span></span><br><span class="line">    con.<span class="title function_ invoke__">hset</span>(<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Alice&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    con.<span class="title function_ invoke__">hset</span>(<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;email&quot;</span>, <span class="string">&quot;alice@example.com&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span>: <span class="type">String</span> = con.<span class="title function_ invoke__">hget</span>(<span class="string">&quot;user:1&quot;</span>, <span class="string">&quot;name&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">all</span>: std::collections::HashMap&lt;<span class="type">String</span>, <span class="type">String</span>&gt; = con.<span class="title function_ invoke__">hgetall</span>(<span class="string">&quot;user:1&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 列表 ============</span></span><br><span class="line">    con.<span class="title function_ invoke__">rpush</span>(<span class="string">&quot;queue&quot;</span>, <span class="string">&quot;item1&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    con.<span class="title function_ invoke__">rpush</span>(<span class="string">&quot;queue&quot;</span>, <span class="string">&quot;item2&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">item</span>: <span class="type">String</span> = con.<span class="title function_ invoke__">lpop</span>(<span class="string">&quot;queue&quot;</span>, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 集合 ============</span></span><br><span class="line">    con.<span class="title function_ invoke__">sadd</span>(<span class="string">&quot;tags&quot;</span>, <span class="string">&quot;rust&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    con.<span class="title function_ invoke__">sadd</span>(<span class="string">&quot;tags&quot;</span>, <span class="string">&quot;database&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">members</span>: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; = con.<span class="title function_ invoke__">smembers</span>(<span class="string">&quot;tags&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 有序集合 ============</span></span><br><span class="line">    con.<span class="title function_ invoke__">zadd</span>(<span class="string">&quot;leaderboard&quot;</span>, <span class="string">&quot;player1&quot;</span>, <span class="number">100</span>).<span class="keyword">await</span>?;</span><br><span class="line">    con.<span class="title function_ invoke__">zadd</span>(<span class="string">&quot;leaderboard&quot;</span>, <span class="string">&quot;player2&quot;</span>, <span class="number">200</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">top</span>: <span class="type">Vec</span>&lt;(<span class="type">String</span>, <span class="type">i32</span>)&gt; = con.<span class="title function_ invoke__">zrevrange_withscores</span>(<span class="string">&quot;leaderboard&quot;</span>, <span class="number">0</span>, <span class="number">9</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 管道 ============</span></span><br><span class="line">    <span class="keyword">let</span> (k1, k2): (<span class="type">String</span>, <span class="type">String</span>) = redis::<span class="title function_ invoke__">pipe</span>()</span><br><span class="line">        .<span class="title function_ invoke__">get</span>(<span class="string">&quot;key1&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">get</span>(<span class="string">&quot;key2&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">query_async</span>(&amp;<span class="keyword">mut</span> con)</span><br><span class="line">        .<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">mongodb</span> = <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br><span class="line"><span class="attr">futures</span> = <span class="string">&quot;0.3&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> mongodb::&#123;Client, Collection, bson::doc&#125;;</span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> futures::TryStreamExt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="string">&quot;_id&quot;</span>, skip_serializing_if = <span class="string">&quot;Option::is_none&quot;</span>)]</span></span><br><span class="line">    id: <span class="type">Option</span>&lt;mongodb::bson::oid::ObjectId&gt;,</span><br><span class="line">    username: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> mongodb::error::<span class="type">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 连接</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">client</span> = Client::<span class="title function_ invoke__">with_uri_str</span>(<span class="string">&quot;mongodb://localhost:27017&quot;</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">db</span> = client.<span class="title function_ invoke__">database</span>(<span class="string">&quot;mydb&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">collection</span>: Collection&lt;User&gt; = db.<span class="title function_ invoke__">collection</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ CREATE ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = User &#123;</span><br><span class="line">        id: <span class="literal">None</span>,</span><br><span class="line">        username: <span class="string">&quot;alice&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        email: <span class="string">&quot;alice@example.com&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">        age: <span class="number">25</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = collection.<span class="title function_ invoke__">insert_one</span>(user, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Inserted ID: &#123;:?&#125;&quot;</span>, result.inserted_id);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 批量插入</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">users</span> = <span class="built_in">vec!</span>[</span><br><span class="line">        User &#123; id: <span class="literal">None</span>, username: <span class="string">&quot;bob&quot;</span>.<span class="title function_ invoke__">into</span>(), email: <span class="string">&quot;bob@example.com&quot;</span>.<span class="title function_ invoke__">into</span>(), age: <span class="number">30</span> &#125;,</span><br><span class="line">        User &#123; id: <span class="literal">None</span>, username: <span class="string">&quot;carol&quot;</span>.<span class="title function_ invoke__">into</span>(), email: <span class="string">&quot;carol@example.com&quot;</span>.<span class="title function_ invoke__">into</span>(), age: <span class="number">28</span> &#125;,</span><br><span class="line">    ];</span><br><span class="line">    collection.<span class="title function_ invoke__">insert_many</span>(users, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ READ ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询单个</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user</span> = collection.<span class="title function_ invoke__">find_one</span>(doc! &#123; <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alice&quot;</span> &#125;, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查询多个</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = collection.<span class="title function_ invoke__">find</span>(doc! &#123; <span class="string">&quot;age&quot;</span>: &#123; <span class="string">&quot;$gte&quot;</span>: <span class="number">25</span> &#125; &#125;, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(user) = cursor.<span class="title function_ invoke__">try_next</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ UPDATE ============</span></span><br><span class="line">    collection.<span class="title function_ invoke__">update_one</span>(</span><br><span class="line">        doc! &#123; <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alice&quot;</span> &#125;,</span><br><span class="line">        doc! &#123; <span class="string">&quot;$set&quot;</span>: &#123; <span class="string">&quot;age&quot;</span>: <span class="number">26</span> &#125; &#125;,</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    ).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ DELETE ============</span></span><br><span class="line">    collection.<span class="title function_ invoke__">delete_one</span>(doc! &#123; <span class="string">&quot;username&quot;</span>: <span class="string">&quot;bob&quot;</span> &#125;, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 聚合 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pipeline</span> = <span class="built_in">vec!</span>[</span><br><span class="line">        doc! &#123; <span class="string">&quot;$match&quot;</span>: &#123; <span class="string">&quot;age&quot;</span>: &#123; <span class="string">&quot;$gte&quot;</span>: <span class="number">20</span> &#125; &#125; &#125;,</span><br><span class="line">        doc! &#123; <span class="string">&quot;$group&quot;</span>: &#123; <span class="string">&quot;_id&quot;</span>: null, <span class="string">&quot;avg_age&quot;</span>: &#123; <span class="string">&quot;$avg&quot;</span>: <span class="string">&quot;$age&quot;</span> &#125; &#125; &#125;,</span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">cursor</span> = collection.<span class="title function_ invoke__">aggregate</span>(pipeline, <span class="literal">None</span>).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">let</span> <span class="variable">Some</span>(doc) = cursor.<span class="title function_ invoke__">try_next</span>().<span class="keyword">await</span>? &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, doc);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="数据库迁移管理"><a href="#数据库迁移管理" class="headerlink" title="数据库迁移管理"></a>数据库迁移管理</h2><h3 id="SQLx-迁移"><a href="#SQLx-迁移" class="headerlink" title="SQLx 迁移"></a>SQLx 迁移</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建迁移</span></span><br><span class="line">sqlx migrate add create_users</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行迁移</span></span><br><span class="line">sqlx migrate run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line">sqlx migrate revert</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码中嵌入迁移</span></span><br><span class="line"><span class="keyword">use</span> sqlx::migrate::Migrator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> MIGRATOR: Migrator = sqlx::migrate!(<span class="string">&quot;./migrations&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">run_migrations</span>(pool: &amp;PgPool) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), sqlx::Error&gt; &#123;</span><br><span class="line">    MIGRATOR.<span class="title function_ invoke__">run</span>(pool).<span class="keyword">await</span>?;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Diesel-迁移"><a href="#Diesel-迁移" class="headerlink" title="Diesel 迁移"></a>Diesel 迁移</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">diesel migration generate create_users</span><br><span class="line">diesel migration run</span><br><span class="line">diesel migration revert</span><br><span class="line">diesel migration redo</span><br></pre></td></tr></table></figure></div>

<h2 id="总结对比-2"><a href="#总结对比-2" class="headerlink" title="总结对比"></a>总结对比</h2><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">SQLx</th>
<th align="left">Diesel</th>
<th align="left">SeaORM</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>异步支持</strong></td>
<td align="left">✅</td>
<td align="left">❌</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left"><strong>编译时检查</strong></td>
<td align="left">✅ 宏</td>
<td align="left">✅ 类型系统</td>
<td align="left">❌</td>
</tr>
<tr>
<td align="left"><strong>学习曲线</strong></td>
<td align="left">低</td>
<td align="left">中</td>
<td align="left">中</td>
</tr>
<tr>
<td align="left"><strong>原生SQL</strong></td>
<td align="left">✅</td>
<td align="left">部分</td>
<td align="left">部分</td>
</tr>
<tr>
<td align="left"><strong>ORM功能</strong></td>
<td align="left">❌</td>
<td align="left">✅</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left"><strong>动态查询</strong></td>
<td align="left">✅</td>
<td align="left">中等</td>
<td align="left">✅</td>
</tr>
<tr>
<td align="left"><strong>迁移工具</strong></td>
<td align="left">✅</td>
<td align="left">✅</td>
<td align="left">✅</td>
</tr>
</tbody></table>
<h1 id="Unsafe-编程"><a href="#Unsafe-编程" class="headerlink" title="Unsafe 编程"></a>Unsafe 编程</h1><h2 id="核心概念-4"><a href="#核心概念-4" class="headerlink" title="核心概念"></a>核心概念</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Rust 安全模型                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   Safe Rust          │  编译器保证内存安全、无数据竞争               │</span><br><span class="line">│   ─────────────────────────────────────────────────────────────     │</span><br><span class="line">│   Unsafe Rust        │  程序员承诺代码安全，编译器信任               │</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                    Unsafe 五大超能力                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  1. 解引用裸指针        *const T  /  *mut T                          │</span><br><span class="line">│  2. 调用 unsafe 函数    unsafe fn / extern &quot;C&quot; fn                   │</span><br><span class="line">│  3. 访问可变静态变量    static mut                                   │</span><br><span class="line">│  4. 实现 unsafe trait   Send / Sync 等                              │</span><br><span class="line">│  5. 访问 union 字段     union 类型                                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="unsafe-不意味着什么"><a href="#unsafe-不意味着什么" class="headerlink" title="unsafe 不意味着什么"></a>unsafe 不意味着什么</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unsafe 不会关闭借用检查器！</span></span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r1</span> = &amp;s;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r2</span> = &amp;<span class="keyword">mut</span> s;  <span class="comment">// ❌ 仍然报错！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unsafe 不会关闭类型检查！</span></span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">i32</span> = <span class="string">&quot;hello&quot;</span>;  <span class="comment">// ❌ 仍然报错！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="裸指针-Raw-Pointers"><a href="#裸指针-Raw-Pointers" class="headerlink" title="裸指针 (Raw Pointers)"></a>裸指针 (Raw Pointers)</h2><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ 创建裸指针（安全的）============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span> = &amp;x <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span>;      <span class="comment">// 不可变裸指针</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = &amp;x <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">i32</span>;  <span class="comment">// 可变裸指针（危险）</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">value</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr_mut</span> = &amp;<span class="keyword">mut</span> value <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">i32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 从引用创建</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reference</span> = &amp;value;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = reference <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 解引用裸指针（需要 unsafe）============</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;y = &#123;&#125;&quot;</span>, *y);</span><br><span class="line">      </span><br><span class="line">        *ptr_mut = <span class="number">20</span>;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;value = &#123;&#125;&quot;</span>, *ptr_mut);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 裸指针可以是空的 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">null_ptr</span>: *<span class="keyword">const</span> <span class="type">i32</span> = std::ptr::<span class="title function_ invoke__">null</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">null_mut</span>: *<span class="keyword">mut</span> <span class="type">i32</span> = std::ptr::<span class="title function_ invoke__">null_mut</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查是否为空</span></span><br><span class="line">    <span class="keyword">if</span> !null_ptr.<span class="title function_ invoke__">is_null</span>() &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, *null_ptr); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 裸指针可以指向任意地址 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">addr</span> = <span class="number">0x012345usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_ptr</span> = addr <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">i32</span>;  <span class="comment">// 创建是安全的，解引用是危险的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="指针算术"><a href="#指针算术" class="headerlink" title="指针算术"></a>指针算术</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = arr.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// 指针偏移</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;arr[0] = &#123;&#125;&quot;</span>, *ptr);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;arr[2] = &#123;&#125;&quot;</span>, *ptr.<span class="title function_ invoke__">add</span>(<span class="number">2</span>));      <span class="comment">// 向后移动2个元素</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;arr[4] = &#123;&#125;&quot;</span>, *ptr.<span class="title function_ invoke__">offset</span>(<span class="number">4</span>));   <span class="comment">// 同上，但参数是 isize</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 遍历数组</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..arr.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, *ptr.<span class="title function_ invoke__">add</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 可变指针操作 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = arr.<span class="title function_ invoke__">as_mut_ptr</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        *ptr.<span class="title function_ invoke__">add</span>(<span class="number">2</span>) = <span class="number">100</span>;  <span class="comment">// arr[2] = 100</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 写入值</span></span><br><span class="line">        ptr.<span class="title function_ invoke__">add</span>(<span class="number">3</span>).<span class="title function_ invoke__">write</span>(<span class="number">200</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 读取值（不移动所有权）</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">val</span> = ptr.<span class="title function_ invoke__">add</span>(<span class="number">1</span>).<span class="title function_ invoke__">read</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;val = &#123;&#125;&quot;</span>, val);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [1, 2, 100, 200, 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="指针与切片转换"><a href="#指针与切片转换" class="headerlink" title="指针与切片转换"></a>指针与切片转换</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::slice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ 从裸指针创建切片 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = arr.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = slice::<span class="title function_ invoke__">from_raw_parts</span>(ptr, <span class="number">3</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, slice);  <span class="comment">// [1, 2, 3]</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 可变切片 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = arr.<span class="title function_ invoke__">as_mut_ptr</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">slice</span> = slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(ptr, arr.<span class="title function_ invoke__">len</span>());</span><br><span class="line">        slice[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, arr);  <span class="comment">// [100, 2, 3, 4, 5]</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 实现 split_at_mut（标准库实现原理）============</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">split_at_mut</span>&lt;T&gt;(slice: &amp;<span class="keyword">mut</span> [T], mid: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> (&amp;<span class="keyword">mut</span> [T], &amp;<span class="keyword">mut</span> [T]) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = slice.<span class="title function_ invoke__">len</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = slice.<span class="title function_ invoke__">as_mut_ptr</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">assert!</span>(mid &lt;= len);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            (</span><br><span class="line">                slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(ptr, mid),</span><br><span class="line">                slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(ptr.<span class="title function_ invoke__">add</span>(mid), len - mid),</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">arr</span> = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">    <span class="keyword">let</span> (left, right) = <span class="title function_ invoke__">split_at_mut</span>(&amp;<span class="keyword">mut</span> arr, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;, &#123;:?&#125;&quot;</span>, left, right);  <span class="comment">// [1, 2], [3, 4, 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Unsafe-函数与方法"><a href="#Unsafe-函数与方法" class="headerlink" title="Unsafe 函数与方法"></a>Unsafe 函数与方法</h2><h3 id="定义和调用"><a href="#定义和调用" class="headerlink" title="定义和调用"></a>定义和调用</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 定义 unsafe 函数 ============</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dangerous</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;危险操作！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unsafe 函数体内部被视为 unsafe 块</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">process_raw_pointer</span>(ptr: *<span class="keyword">const</span> <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    *ptr  <span class="comment">// 可以直接解引用，无需再包装 unsafe</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 调用 unsafe 函数需要 unsafe 块</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">dangerous</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">42</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">val</span> = <span class="title function_ invoke__">process_raw_pointer</span>(&amp;x);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;val = &#123;&#125;&quot;</span>, val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 安全抽象包装 unsafe ============</span></span><br><span class="line"><span class="comment">/// 安全地获取向量指定位置的元素</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Panics</span></span><br><span class="line"><span class="comment">/// 如果索引越界</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">safe_get</span>(v: &amp;<span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;, index: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(index &lt; v.<span class="title function_ invoke__">len</span>(), <span class="string">&quot;索引越界&quot;</span>);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        *v.<span class="title function_ invoke__">as_ptr</span>().<span class="title function_ invoke__">add</span>(index)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="unsafe-trait"><a href="#unsafe-trait" class="headerlink" title="unsafe trait"></a>unsafe trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 定义 unsafe trait ============</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">trait</span> <span class="title class_">UnsafeTrait</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">do_something</span>(&amp;<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 unsafe trait 需要 unsafe impl</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">UnsafeTrait</span> <span class="keyword">for</span> <span class="title class_">i32</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">do_something</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;i32: &#123;&#125;&quot;</span>, <span class="keyword">self</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ Send 和 Sync（标准库中的 unsafe trait）============</span></span><br><span class="line"><span class="comment">// Send: 类型可以安全地在线程间转移所有权</span></span><br><span class="line"><span class="comment">// Sync: 类型可以安全地在线程间共享引用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 裸指针默认不是 Send/Sync</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyBox</span>(*<span class="keyword">mut</span> <span class="type">i32</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序员保证线程安全后可以手动实现</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">Send</span> <span class="keyword">for</span> <span class="title class_">MyBox</span> &#123;&#125;</span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">Sync</span> <span class="keyword">for</span> <span class="title class_">MyBox</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 自动实现规则 ============</span></span><br><span class="line"><span class="comment">// 如果类型的所有字段都是 Send，则类型自动 Send</span></span><br><span class="line"><span class="comment">// 如果类型的所有字段都是 Sync，则类型自动 Sync</span></span><br><span class="line"><span class="comment">// 使用 PhantomData 可以影响自动实现</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">NotSend</span> &#123;</span><br><span class="line">    _marker: PhantomData&lt;*<span class="title function_ invoke__">const</span> ()&gt;,  <span class="comment">// *const () 不是 Send</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NotSend 不会自动实现 Send</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="静态变量与内部可变性"><a href="#静态变量与内部可变性" class="headerlink" title="静态变量与内部可变性"></a>静态变量与内部可变性</h2><h3 id="可变静态变量"><a href="#可变静态变量" class="headerlink" title="可变静态变量"></a>可变静态变量</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 不可变静态变量（安全）============</span></span><br><span class="line"><span class="keyword">static</span> GREETING: &amp;<span class="type">str</span> = <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> COUNT: <span class="type">i32</span> = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 可变静态变量（unsafe）============</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> COUNTER: <span class="type">i32</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">increment</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        COUNTER += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_count</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; COUNTER &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, GREETING);</span><br><span class="line">  </span><br><span class="line">    <span class="title function_ invoke__">increment</span>();</span><br><span class="line">    <span class="title function_ invoke__">increment</span>();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Counter: &#123;&#125;&quot;</span>, <span class="title function_ invoke__">get_count</span>());  <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 更安全的替代方案 ============</span></span><br><span class="line"><span class="keyword">use</span> std::sync::atomic::&#123;AtomicI32, Ordering&#125;;</span><br><span class="line"><span class="keyword">use</span> std::sync::OnceLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原子类型（推荐）</span></span><br><span class="line"><span class="keyword">static</span> ATOMIC_COUNTER: AtomicI32 = AtomicI32::<span class="title function_ invoke__">new</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">safe_increment</span>() &#123;</span><br><span class="line">    ATOMIC_COUNTER.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OnceLock 用于延迟初始化</span></span><br><span class="line"><span class="keyword">static</span> CONFIG: OnceLock&lt;<span class="type">String</span>&gt; = OnceLock::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_config</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">String</span> &#123;</span><br><span class="line">    CONFIG.<span class="title function_ invoke__">get_or_init</span>(|| &#123;</span><br><span class="line">        <span class="comment">// 复杂的初始化逻辑</span></span><br><span class="line">        <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;default_config&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="外部静态变量"><a href="#外部静态变量" class="headerlink" title="外部静态变量"></a>外部静态变量</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> errno: <span class="type">i32</span>;           <span class="comment">// 外部不可变</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">mut</span> global: <span class="type">i32</span>;      <span class="comment">// 外部可变</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">check_errno</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Error: &#123;&#125;&quot;</span>, errno);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Union-类型"><a href="#Union-类型" class="headerlink" title="Union 类型"></a>Union 类型</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 定义 union ============</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">IntOrFloat</span> &#123;</span><br><span class="line">    i: <span class="type">i32</span>,</span><br><span class="line">    f: <span class="type">f32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">u</span> = IntOrFloat &#123; i: <span class="number">42</span> &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取 union 字段需要 unsafe</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;As int: &#123;&#125;&quot;</span>, u.i);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;As float: &#123;&#125;&quot;</span>, u.f);  <span class="comment">// 重新解释位模式</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入不需要 unsafe</span></span><br><span class="line">    u.f = <span class="number">3.14</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;As float: &#123;&#125;&quot;</span>, u.f);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;As int: &#123;&#125;&quot;</span>, u.i);  <span class="comment">// 查看 3.14 的位表示</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 实际用途：类型双关（Type Punning）============</span></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">FloatBits</span> &#123;</span><br><span class="line">    f: <span class="type">f32</span>,</span><br><span class="line">    bits: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">float_to_bits</span>(f: <span class="type">f32</span>) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fb</span> = FloatBits &#123; f &#125;;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; fb.bits &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bits_to_float</span>(bits: <span class="type">u32</span>) <span class="punctuation">-&gt;</span> <span class="type">f32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fb</span> = FloatBits &#123; bits &#125;;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123; fb.f &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 带 ManuallyDrop 的 union（存储非 Copy 类型）============</span></span><br><span class="line"><span class="keyword">use</span> std::mem::ManuallyDrop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">MaybeString</span> &#123;</span><br><span class="line">    none: (),</span><br><span class="line">    some: ManuallyDrop&lt;<span class="type">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MaybeString</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new_some</span>(s: <span class="type">String</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        MaybeString &#123;</span><br><span class="line">            some: ManuallyDrop::<span class="title function_ invoke__">new</span>(s),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new_none</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        MaybeString &#123; none: () &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">take</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">        ManuallyDrop::<span class="title function_ invoke__">take</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>.some)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="FFI（外部函数接口）"><a href="#FFI（外部函数接口）" class="headerlink" title="FFI（外部函数接口）"></a>FFI（外部函数接口）</h2><h3 id="调用-C-函数"><a href="#调用-C-函数" class="headerlink" title="调用 C 函数"></a>调用 C 函数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ffi::&#123;CStr, CString&#125;;</span><br><span class="line"><span class="keyword">use</span> std::os::raw::&#123;c_char, c_int, c_void&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 声明外部函数 ============</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">abs</span>(input: c_int) <span class="punctuation">-&gt;</span> c_int;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">strlen</span>(s: *<span class="keyword">const</span> c_char) <span class="punctuation">-&gt;</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">printf</span>(format: *<span class="keyword">const</span> c_char, ...) <span class="punctuation">-&gt;</span> c_int;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 系统调用</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">malloc</span>(size: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> c_void;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">free</span>(ptr: *<span class="keyword">mut</span> c_void);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// 调用 abs</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;abs(-5) = &#123;&#125;&quot;</span>, <span class="title function_ invoke__">abs</span>(-<span class="number">5</span>));</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 调用 strlen</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">s</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Hello&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;strlen = &#123;&#125;&quot;</span>, <span class="title function_ invoke__">strlen</span>(s.<span class="title function_ invoke__">as_ptr</span>()));</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 调用 printf</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">fmt</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Number: %d\n&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="title function_ invoke__">printf</span>(fmt.<span class="title function_ invoke__">as_ptr</span>(), <span class="number">42</span> <span class="keyword">as</span> c_int);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 字符串转换 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">rust_to_c_string</span>(s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> CString &#123;</span><br><span class="line">    CString::<span class="title function_ invoke__">new</span>(s).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;CString::new failed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">c_to_rust_string</span>(ptr: *<span class="keyword">const</span> c_char) <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        CStr::<span class="title function_ invoke__">from_ptr</span>(ptr)</span><br><span class="line">            .<span class="title function_ invoke__">to_string_lossy</span>()</span><br><span class="line">            .<span class="title function_ invoke__">into_owned</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="链接外部库"><a href="#链接外部库" class="headerlink" title="链接外部库"></a>链接外部库</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cargo.toml</span></span><br><span class="line"><span class="comment">// [build-dependencies]</span></span><br><span class="line"><span class="comment">// cc = &quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// build.rs</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 链接系统库</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=m&quot;</span>);        <span class="comment">// libm</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=ssl&quot;</span>);      <span class="comment">// libssl</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 链接静态库</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=static=mylib&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=native=/path/to/lib&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 使用 cc crate 编译 C 代码 ============</span></span><br><span class="line"><span class="comment">// build.rs</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    cc::Build::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">file</span>(<span class="string">&quot;src/native.c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">compile</span>(<span class="string">&quot;native&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/native.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">add</span><span class="params">(<span class="type">int32_t</span> a, <span class="type">int32_t</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;1 + 2 = &#123;&#125;&quot;</span>, <span class="title function_ invoke__">add</span>(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="暴露-Rust-函数给-C"><a href="#暴露-Rust-函数给-C" class="headerlink" title="暴露 Rust 函数给 C"></a>暴露 Rust 函数给 C</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 导出函数 ============</span></span><br><span class="line"><span class="meta">#[no_mangle]</span>  <span class="comment">// 防止名称修饰</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">rust_add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">rust_hello</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello from Rust!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 带回调的函数 ============</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Callback</span> = <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="title function_ invoke__">fn</span>(<span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">process_with_callback</span>(x: <span class="type">i32</span>, cb: Callback) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">cb</span>(x * <span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 返回字符串 ============</span></span><br><span class="line"><span class="keyword">use</span> std::ffi::CString;</span><br><span class="line"><span class="keyword">use</span> std::os::raw::c_char;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">get_greeting</span>() <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> c_char &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = CString::<span class="title function_ invoke__">new</span>(<span class="string">&quot;Hello from Rust!&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    s.<span class="title function_ invoke__">into_raw</span>()  <span class="comment">// 转移所有权给 C</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">free_string</span>(s: *<span class="keyword">mut</span> c_char) &#123;</span><br><span class="line">    <span class="keyword">if</span> !s.<span class="title function_ invoke__">is_null</span>() &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">drop</span>(CString::<span class="title function_ invoke__">from_raw</span>(s));  <span class="comment">// 收回所有权并释放</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="复杂数据结构传递"><a href="#复杂数据结构传递" class="headerlink" title="复杂数据结构传递"></a>复杂数据结构传递</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::os::raw::&#123;c_char, c_int&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 结构体布局 ============</span></span><br><span class="line"><span class="meta">#[repr(C)]</span>  <span class="comment">// 使用 C 的内存布局</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">f64</span>,</span><br><span class="line">    y: <span class="type">f64</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    name: *<span class="keyword">const</span> c_char,</span><br><span class="line">    age: c_int,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">process_point</span>(p: Point) <span class="punctuation">-&gt;</span> <span class="type">f64</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">process_point_ptr</span>(p: *<span class="keyword">const</span> Point) <span class="punctuation">-&gt;</span> <span class="type">f64</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 不透明类型（Opaque Type）============</span></span><br><span class="line"><span class="comment">// C 端无需知道内部结构</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">OpaqueHandle</span> &#123;</span><br><span class="line">    _private: [<span class="type">u8</span>; <span class="number">0</span>],  <span class="comment">// 零大小，阻止实例化</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RealData</span> &#123;</span><br><span class="line">    data: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt;,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">create_handle</span>() <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> OpaqueHandle &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(RealData &#123;</span><br><span class="line">        data: <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">        name: <span class="string">&quot;test&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Box</span>::<span class="title function_ invoke__">into_raw</span>(data) <span class="keyword">as</span> *<span class="keyword">mut</span> OpaqueHandle</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">destroy_handle</span>(handle: *<span class="keyword">mut</span> OpaqueHandle) &#123;</span><br><span class="line">    <span class="keyword">if</span> !handle.<span class="title function_ invoke__">is_null</span>() &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">drop</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(handle <span class="keyword">as</span> *<span class="keyword">mut</span> RealData));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h2><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::arch::asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ 基本语法 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;mov &#123;&#125;, 42&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">out</span>(reg) x,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x = &#123;&#125;&quot;</span>, x);  <span class="comment">// 42</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 输入输出 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: <span class="type">u64</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span>: <span class="type">u64</span> = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span>: <span class="type">u64</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;add &#123;0&#125;, &#123;1&#125;&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inout</span>(reg) a =&gt; result,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(reg) b,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;10 + 20 = &#123;&#125;&quot;</span>, result);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 多条指令 ============</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span>: <span class="type">u64</span>;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;mov &#123;tmp&#125;, &#123;x&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;add &#123;tmp&#125;, &#123;y&#125;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;mov &#123;out&#125;, &#123;tmp&#125;&quot;</span>,</span><br><span class="line">            x = <span class="title function_ invoke__">in</span>(reg) <span class="number">5u64</span>,</span><br><span class="line">            y = <span class="title function_ invoke__">in</span>(reg) <span class="number">6u64</span>,</span><br><span class="line">            tmp = <span class="title function_ invoke__">out</span>(reg) _,</span><br><span class="line">            out = <span class="title function_ invoke__">out</span>(reg) value,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;5 + 6 = &#123;&#125;&quot;</span>, value);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 调用系统调用（Linux x86_64）============</span></span><br><span class="line">    <span class="meta">#[cfg(target_os = <span class="string">&quot;linux&quot;</span>)]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">msg</span> = <span class="string">&quot;Hello from syscall!\n&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = msg.<span class="title function_ invoke__">len</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = msg.<span class="title function_ invoke__">as_ptr</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            asm!(</span><br><span class="line">                <span class="string">&quot;syscall&quot;</span>,</span><br><span class="line">                <span class="title function_ invoke__">in</span>(<span class="string">&quot;rax&quot;</span>) <span class="number">1</span>,       <span class="comment">// syscall number (write)</span></span><br><span class="line">                <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdi&quot;</span>) <span class="number">1</span>,       <span class="comment">// fd (stdout)</span></span><br><span class="line">                <span class="title function_ invoke__">in</span>(<span class="string">&quot;rsi&quot;</span>) ptr,     <span class="comment">// buffer</span></span><br><span class="line">                <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdx&quot;</span>) len,     <span class="comment">// count</span></span><br><span class="line">                <span class="title function_ invoke__">out</span>(<span class="string">&quot;rcx&quot;</span>) _,</span><br><span class="line">                <span class="title function_ invoke__">out</span>(<span class="string">&quot;r11&quot;</span>) _,</span><br><span class="line">                <span class="title function_ invoke__">options</span>(nostack),</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ CPUID 示例 ============</span></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="string">&quot;x86_64&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_cpu_vendor</span>() <span class="punctuation">-&gt;</span> <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ebx</span>: <span class="type">u32</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ecx</span>: <span class="type">u32</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">edx</span>: <span class="type">u32</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;cpuid&quot;</span>,</span><br><span class="line">            <span class="title function_ invoke__">inout</span>(<span class="string">&quot;eax&quot;</span>) <span class="number">0</span> =&gt; _,</span><br><span class="line">            <span class="title function_ invoke__">out</span>(<span class="string">&quot;ebx&quot;</span>) ebx,</span><br><span class="line">            <span class="title function_ invoke__">out</span>(<span class="string">&quot;ecx&quot;</span>) ecx,</span><br><span class="line">            <span class="title function_ invoke__">out</span>(<span class="string">&quot;edx&quot;</span>) edx,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vendor</span> = [ebx, edx, ecx];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span>: &amp;[<span class="type">u8</span>] = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        std::slice::<span class="title function_ invoke__">from_raw_parts</span>(vendor.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>, <span class="number">12</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">String</span>::<span class="title function_ invoke__">from_utf8_lossy</span>(bytes).<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="内存布局控制"><a href="#内存布局控制" class="headerlink" title="内存布局控制"></a>内存布局控制</h2><h3 id="repr-属性"><a href="#repr-属性" class="headerlink" title="repr 属性"></a>repr 属性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ #[repr(C)] - C 兼容布局 ============</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CStruct</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,    <span class="comment">// 偏移 0</span></span><br><span class="line">    b: <span class="type">u32</span>,   <span class="comment">// 偏移 4（填充3字节）</span></span><br><span class="line">    c: <span class="type">u16</span>,   <span class="comment">// 偏移 8</span></span><br><span class="line">&#125;               <span class="comment">// 总大小 12（填充2字节）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ #[repr(packed)] - 紧凑布局 ============</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PackedStruct</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,    <span class="comment">// 偏移 0</span></span><br><span class="line">    b: <span class="type">u32</span>,   <span class="comment">// 偏移 1（无填充）</span></span><br><span class="line">    c: <span class="type">u16</span>,   <span class="comment">// 偏移 5</span></span><br><span class="line">&#125;               <span class="comment">// 总大小 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ #[repr(align(N))] - 指定对齐 ============</span></span><br><span class="line"><span class="meta">#[repr(align(16))]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Aligned16</span> &#123;</span><br><span class="line">    data: [<span class="type">u8</span>; <span class="number">4</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 组合使用 ============</span></span><br><span class="line"><span class="meta">#[repr(C, packed)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CPackedStruct</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,</span><br><span class="line">    b: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C, align(8))]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CAligned8</span> &#123;</span><br><span class="line">    a: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ #[repr(transparent)] - 与内部类型相同布局 ============</span></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Wrapper</span>(<span class="type">u32</span>);  <span class="comment">// 与 u32 完全相同的布局</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">use</span> std::mem::&#123;size_of, align_of&#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;CStruct: size=&#123;&#125;, align=&#123;&#125;&quot;</span>, </span><br><span class="line">             size_of::&lt;CStruct&gt;(), align_of::&lt;CStruct&gt;());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;PackedStruct: size=&#123;&#125;, align=&#123;&#125;&quot;</span>, </span><br><span class="line">             size_of::&lt;PackedStruct&gt;(), align_of::&lt;PackedStruct&gt;());</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Aligned16: size=&#123;&#125;, align=&#123;&#125;&quot;</span>, </span><br><span class="line">             size_of::&lt;Aligned16&gt;(), align_of::&lt;Aligned16&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="手动内存管理"><a href="#手动内存管理" class="headerlink" title="手动内存管理"></a>手动内存管理</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::alloc::&#123;alloc, dealloc, realloc, Layout&#125;;</span><br><span class="line"><span class="keyword">use</span> std::ptr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// ============ 分配内存 ============</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">layout</span> = Layout::new::&lt;<span class="type">u32</span>&gt;();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="title function_ invoke__">alloc</span>(layout) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u32</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> ptr.<span class="title function_ invoke__">is_null</span>() &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;内存分配失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 写入值</span></span><br><span class="line">        ptr.<span class="title function_ invoke__">write</span>(<span class="number">42</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;value = &#123;&#125;&quot;</span>, ptr.<span class="title function_ invoke__">read</span>());</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 释放内存</span></span><br><span class="line">        <span class="title function_ invoke__">dealloc</span>(ptr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, layout);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 分配数组 ============</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">layout</span> = Layout::array::&lt;<span class="type">i32</span>&gt;(<span class="number">10</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">arr</span> = <span class="title function_ invoke__">alloc</span>(layout) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">i32</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 初始化数组</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">            arr.<span class="title function_ invoke__">add</span>(i).<span class="title function_ invoke__">write</span>(i <span class="keyword">as</span> <span class="type">i32</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 使用数组</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">10</span> &#123;</span><br><span class="line">            <span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125; &quot;</span>, arr.<span class="title function_ invoke__">add</span>(i).<span class="title function_ invoke__">read</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">println!</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="title function_ invoke__">dealloc</span>(arr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, layout);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 重新分配 ============</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">layout</span> = Layout::array::&lt;<span class="type">i32</span>&gt;(<span class="number">5</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="title function_ invoke__">alloc</span>(layout) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">i32</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 扩大数组</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_layout</span> = Layout::array::&lt;<span class="type">i32</span>&gt;(<span class="number">10</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">new_ptr</span> = <span class="title function_ invoke__">realloc</span>(ptr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, layout, new_layout.<span class="title function_ invoke__">size</span>()) <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">i32</span>;</span><br><span class="line">      </span><br><span class="line">        <span class="title function_ invoke__">dealloc</span>(new_ptr <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, new_layout);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 使用 Box 进行底层操作 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">box_operations</span>() &#123;</span><br><span class="line">    <span class="comment">// 从裸指针创建 Box</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="type">Box</span>::<span class="title function_ invoke__">into_raw</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(<span class="number">42</span>));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// 使用裸指针</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;value = &#123;&#125;&quot;</span>, *ptr);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 转回 Box 以自动释放</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = <span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带自定义布局分配</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">layout</span> = Layout::new::&lt;[<span class="type">u8</span>; <span class="number">1024</span>]&gt;();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">alloc</span>(layout) &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ... 使用内存 ...</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">dealloc</span>(ptr, layout) &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见-Unsafe-模式"><a href="#常见-Unsafe-模式" class="headerlink" title="常见 Unsafe 模式"></a>常见 Unsafe 模式</h2><h3 id="自引用结构"><a href="#自引用结构" class="headerlink" title="自引用结构"></a>自引用结构</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::pin::Pin;</span><br><span class="line"><span class="keyword">use</span> std::marker::PhantomPinned;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SelfReferential</span> &#123;</span><br><span class="line">    data: <span class="type">String</span>,</span><br><span class="line">    <span class="comment">// 指向 data 的指针</span></span><br><span class="line">    ptr: *<span class="keyword">const</span> <span class="type">String</span>,</span><br><span class="line">    _pin: PhantomPinned,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SelfReferential</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(data: <span class="type">String</span>) <span class="punctuation">-&gt;</span> Pin&lt;<span class="type">Box</span>&lt;<span class="keyword">Self</span>&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">boxed</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(SelfReferential &#123;</span><br><span class="line">            data,</span><br><span class="line">            ptr: std::ptr::<span class="title function_ invoke__">null</span>(),</span><br><span class="line">            _pin: PhantomPinned,</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置自引用</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = &amp;boxed.data <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">String</span>;</span><br><span class="line">        boxed.ptr = ptr;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// Pin 住，防止移动</span></span><br><span class="line">        <span class="type">Box</span>::<span class="title function_ invoke__">into_pin</span>(boxed)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_data</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">Self</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        &amp;<span class="keyword">self</span>.data</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_ptr_data</span>(<span class="keyword">self</span>: Pin&lt;&amp;<span class="keyword">Self</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; &amp;*<span class="keyword">self</span>.ptr &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内部可变性"><a href="#内部可变性" class="headerlink" title="内部可变性"></a>内部可变性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::cell::UnsafeCell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MyCell</span>&lt;T&gt; &#123;</span><br><span class="line">    value: UnsafeCell&lt;T&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T: <span class="built_in">Copy</span>&gt; MyCell&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(value: T) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        MyCell &#123;</span><br><span class="line">            value: UnsafeCell::<span class="title function_ invoke__">new</span>(value),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; *<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">self</span>, value: T) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            *<span class="keyword">self</span>.value.<span class="title function_ invoke__">get</span>() = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单线程安全，因此不实现 Sync</span></span><br><span class="line"><span class="comment">// impl&lt;T&gt; !Sync for MyCell&lt;T&gt; &#123;&#125;  // 自动的</span></span><br></pre></td></tr></table></figure></div>

<h3 id="侵入式链表"><a href="#侵入式链表" class="headerlink" title="侵入式链表"></a>侵入式链表</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ptr::NonNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line">    data: T,</span><br><span class="line">    next: <span class="type">Option</span>&lt;NonNull&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">    prev: <span class="type">Option</span>&lt;NonNull&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">LinkedList</span>&lt;T&gt; &#123;</span><br><span class="line">    head: <span class="type">Option</span>&lt;NonNull&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">    tail: <span class="type">Option</span>&lt;NonNull&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">    len: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; LinkedList&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        LinkedList &#123;</span><br><span class="line">            head: <span class="literal">None</span>,</span><br><span class="line">            tail: <span class="literal">None</span>,</span><br><span class="line">            len: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">push_back</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, data: T) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">node</span> = <span class="type">Box</span>::<span class="title function_ invoke__">new</span>(Node &#123;</span><br><span class="line">            data,</span><br><span class="line">            next: <span class="literal">None</span>,</span><br><span class="line">            prev: <span class="keyword">self</span>.tail,</span><br><span class="line">        &#125;);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">node_ptr</span> = NonNull::<span class="title function_ invoke__">new</span>(<span class="type">Box</span>::<span class="title function_ invoke__">into_raw</span>(node));</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span>.tail &#123;</span><br><span class="line">            <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">                <span class="keyword">self</span>.head = node_ptr;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="keyword">mut</span> tail) =&gt; <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                tail.<span class="title function_ invoke__">as_mut</span>().next = node_ptr;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">self</span>.tail = node_ptr;</span><br><span class="line">        <span class="keyword">self</span>.len += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pop_front</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.head.<span class="title function_ invoke__">map</span>(|node| <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">node</span> = <span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(node.<span class="title function_ invoke__">as_ptr</span>());</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">self</span>.head = node.next;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">match</span> <span class="keyword">self</span>.head &#123;</span><br><span class="line">                <span class="literal">None</span> =&gt; <span class="keyword">self</span>.tail = <span class="literal">None</span>,</span><br><span class="line">                <span class="title function_ invoke__">Some</span>(<span class="keyword">mut</span> head) =&gt; head.<span class="title function_ invoke__">as_mut</span>().prev = <span class="literal">None</span>,</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">self</span>.len -= <span class="number">1</span>;</span><br><span class="line">            node.data</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">LinkedList</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.<span class="title function_ invoke__">pop_front</span>().<span class="title function_ invoke__">is_some</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Unsafe-实践"><a href="#Unsafe-实践" class="headerlink" title="Unsafe 实践"></a>Unsafe 实践</h2><h3 id="最小化-unsafe-范围"><a href="#最小化-unsafe-范围" class="headerlink" title="最小化 unsafe 范围"></a>最小化 unsafe 范围</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 不好：整个函数是 unsafe</span></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">bad_approach</span>(data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span>;</span><br><span class="line">    <span class="comment">// ... 大量安全代码 ...</span></span><br><span class="line">    *ptr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 好：只在必要处使用 unsafe</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">good_approach</span>(data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(data.<span class="title function_ invoke__">len</span>() &gt;= <span class="number">4</span>, <span class="string">&quot;数据太短&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ... 安全代码 ...</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 只有这一行需要 unsafe</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ptr</span> = data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span>;</span><br><span class="line">        ptr.<span class="title function_ invoke__">read_unaligned</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="文档化安全约束"><a href="#文档化安全约束" class="headerlink" title="文档化安全约束"></a>文档化安全约束</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 从字节切片读取 u32</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Safety</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 调用者必须确保：</span></span><br><span class="line"><span class="comment">/// - `data` 至少有 4 个字节</span></span><br><span class="line"><span class="comment">/// - `data` 的起始地址对 u32 对齐（或使用 read_unaligned）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">read_u32</span>(data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">u32</span> &#123;</span><br><span class="line">    <span class="built_in">debug_assert!</span>(data.<span class="title function_ invoke__">len</span>() &gt;= <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = data.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u32</span>;</span><br><span class="line">    ptr.<span class="title function_ invoke__">read_unaligned</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 安全包装</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">safe_read_u32</span>(data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">u32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> data.<span class="title function_ invoke__">len</span>() &gt;= <span class="number">4</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">read_u32</span>(data) &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-debug-assert"><a href="#使用-debug-assert" class="headerlink" title="使用 debug_assert"></a>使用 debug_assert</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_unchecked</span>&lt;T&gt;(slice: &amp;[T], index: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> &amp;T &#123;</span><br><span class="line">    <span class="comment">// Release 模式下移除检查，Debug 模式保留</span></span><br><span class="line">    <span class="built_in">debug_assert!</span>(index &lt; slice.<span class="title function_ invoke__">len</span>(), <span class="string">&quot;索引越界&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        slice.<span class="title function_ invoke__">get_unchecked</span>(index)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="安全抽象模式"><a href="#安全抽象模式" class="headerlink" title="安全抽象模式"></a>安全抽象模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 一个安全的固定大小环形缓冲区</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">RingBuffer</span>&lt;T, <span class="keyword">const</span> N: <span class="type">usize</span>&gt; &#123;</span><br><span class="line">    buffer: [std::mem::MaybeUninit&lt;T&gt;; N],</span><br><span class="line">    head: <span class="type">usize</span>,</span><br><span class="line">    tail: <span class="type">usize</span>,</span><br><span class="line">    len: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T, <span class="keyword">const</span> N: <span class="type">usize</span>&gt; RingBuffer&lt;T, N&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            buffer: <span class="keyword">unsafe</span> &#123; std::mem::MaybeUninit::<span class="title function_ invoke__">uninit</span>().<span class="title function_ invoke__">assume_init</span>() &#125;,</span><br><span class="line">            head: <span class="number">0</span>,</span><br><span class="line">            tail: <span class="number">0</span>,</span><br><span class="line">            len: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 公共 API 都是安全的</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">push</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, item: T) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), T&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.len == N &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(item);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// unsafe 被封装在内部</span></span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.buffer[<span class="keyword">self</span>.tail].<span class="title function_ invoke__">as_mut_ptr</span>().<span class="title function_ invoke__">write</span>(item);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">self</span>.tail = (<span class="keyword">self</span>.tail + <span class="number">1</span>) % N;</span><br><span class="line">        <span class="keyword">self</span>.len += <span class="number">1</span>;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">pop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.len == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">item</span> = <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.buffer[<span class="keyword">self</span>.head].<span class="title function_ invoke__">as_ptr</span>().<span class="title function_ invoke__">read</span>()</span><br><span class="line">        &#125;;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">self</span>.head = (<span class="keyword">self</span>.head + <span class="number">1</span>) % N;</span><br><span class="line">        <span class="keyword">self</span>.len -= <span class="number">1</span>;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(item)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T, <span class="keyword">const</span> N: <span class="type">usize</span>&gt; <span class="built_in">Drop</span> <span class="keyword">for</span> <span class="title class_">RingBuffer</span>&lt;T, N&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.<span class="title function_ invoke__">pop</span>().<span class="title function_ invoke__">is_some</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="速查表-1"><a href="#速查表-1" class="headerlink" title="速查表"></a>速查表</h2><table>
<thead>
<tr>
<th>操作</th>
<th>是否需要 unsafe</th>
</tr>
</thead>
<tbody><tr>
<td>创建裸指针</td>
<td>❌ 安全</td>
</tr>
<tr>
<td>解引用裸指针</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>调用 unsafe fn</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>实现 unsafe trait</td>
<td>✅ unsafe impl</td>
</tr>
<tr>
<td>读写 static mut</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>读取 union 字段</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>FFI 函数调用</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>内联汇编</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>transmute</td>
<td>✅ unsafe</td>
</tr>
<tr>
<td>from_raw_parts</td>
<td>✅ unsafe</td>
</tr>
</tbody></table>
<h3 id="关键函数"><a href="#关键函数" class="headerlink" title="关键函数"></a>关键函数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类型转换</span></span><br><span class="line">std::mem::transmute::&lt;T, U&gt;(value)      <span class="comment">// 重新解释位模式</span></span><br><span class="line">std::mem::transmute_copy::&lt;T, U&gt;(&amp;val)  <span class="comment">// 复制并转换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存操作</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">read</span>(ptr)                     <span class="comment">// 从指针读取</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">write</span>(ptr, val)               <span class="comment">// 向指针写入</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">copy</span>(src, dst, count)         <span class="comment">// 复制内存（可重叠）</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">copy_nonoverlapping</span>(...)      <span class="comment">// 复制内存（不可重叠）</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">swap</span>(x, y)                    <span class="comment">// 交换</span></span><br><span class="line">std::ptr::<span class="title function_ invoke__">drop_in_place</span>(ptr)            <span class="comment">// 析构</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 切片</span></span><br><span class="line">std::slice::<span class="title function_ invoke__">from_raw_parts</span>(ptr, len)</span><br><span class="line">std::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(ptr, len)</span><br></pre></td></tr></table></figure></div>

<h1 id="Macro-宏编程"><a href="#Macro-宏编程" class="headerlink" title="Macro 宏编程"></a>Macro 宏编程</h1><h2 id="宏系统概览"><a href="#宏系统概览" class="headerlink" title="宏系统概览"></a>宏系统概览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Rust 宏系统                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   声明宏 (Declarative)          │    过程宏 (Procedural)            │</span><br><span class="line">│   macro_rules!                  │                                   │</span><br><span class="line">│   ─────────────────────────────────────────────────────────────     │</span><br><span class="line">│   • 模式匹配                     │    • 函数式宏  proc_macro         │</span><br><span class="line">│   • 代码模板替换                 │    • derive 宏  proc_macro_derive │</span><br><span class="line">│   • 编译时展开                   │    • 属性宏    proc_macro_attribute│</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  调用方式                                                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  macro!()        macro![]        macro!&#123;&#125;                           │</span><br><span class="line">│  #[derive(Mac)]  #[mac]          #[mac(...)]                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="宏-vs-函数"><a href="#宏-vs-函数" class="headerlink" title="宏 vs 函数"></a>宏 vs 函数</h3><table>
<thead>
<tr>
<th>特性</th>
<th>宏</th>
<th>函数</th>
</tr>
</thead>
<tbody><tr>
<td>执行时机</td>
<td>编译时</td>
<td>运行时</td>
</tr>
<tr>
<td>参数数量</td>
<td>可变</td>
<td>固定</td>
</tr>
<tr>
<td>类型检查</td>
<td>展开后检查</td>
<td>调用时检查</td>
</tr>
<tr>
<td>代码生成</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td>调试难度</td>
<td>较高</td>
<td>较低</td>
</tr>
</tbody></table>
<hr>
<h2 id="声明宏-macro-rules"><a href="#声明宏-macro-rules" class="headerlink" title="声明宏 (macro_rules!)"></a>声明宏 (macro_rules!)</h2><h3 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 最简单的宏 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> say_hello &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 带参数的宏 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> say &#123;</span><br><span class="line">    ($msg:expr) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, $msg);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 多个分支 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> greet &#123;</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    ($name:expr) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, $name);</span><br><span class="line">    &#125;;</span><br><span class="line">    ($name:expr, $times:expr) =&gt; &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..$times &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, $name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    say_hello!();           <span class="comment">// Hello!</span></span><br><span class="line">    say!(<span class="string">&quot;Hi there&quot;</span>);       <span class="comment">// Hi there</span></span><br><span class="line">  </span><br><span class="line">    greet!();               <span class="comment">// Hello, World!</span></span><br><span class="line">    greet!(<span class="string">&quot;Alice&quot;</span>);        <span class="comment">// Hello, Alice!</span></span><br><span class="line">    greet!(<span class="string">&quot;Bob&quot;</span>, <span class="number">3</span>);       <span class="comment">// Hello, Bob! (3次)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="元变量类型-Fragment-Specifiers"><a href="#元变量类型-Fragment-Specifiers" class="headerlink" title="元变量类型 (Fragment Specifiers)"></a>元变量类型 (Fragment Specifiers)</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> demo_fragments &#123;</span><br><span class="line">    <span class="comment">// ============ 常用类型 ============</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// expr - 表达式</span></span><br><span class="line">    (expr: $e:expr) =&gt; &#123; <span class="built_in">println!</span>(<span class="string">&quot;expr: &#123;:?&#125;&quot;</span>, $e) &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ident - 标识符</span></span><br><span class="line">    (ident: $i:ident) =&gt; &#123; <span class="keyword">let</span> $i = <span class="number">42</span>; &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ty - 类型</span></span><br><span class="line">    (ty: $t:ty) =&gt; &#123; <span class="keyword">let</span> <span class="variable">_</span>: $t; &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// pat - 模式</span></span><br><span class="line">    (pat: $p:pat) =&gt; &#123; <span class="keyword">let</span> $p = (<span class="number">1</span>, <span class="number">2</span>); &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// stmt - 语句</span></span><br><span class="line">    (stmt: $s:stmt) =&gt; &#123; $s &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// block - 代码块</span></span><br><span class="line">    (block: $b:block) =&gt; &#123; $b &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// item - 项（函数、结构体等）</span></span><br><span class="line">    (item: $i:item) =&gt; &#123; $i &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// path - 路径</span></span><br><span class="line">    (path: $p:path) =&gt; &#123; <span class="keyword">type</span> <span class="title class_">Alias</span> = $p; &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// tt - 单个 token tree</span></span><br><span class="line">    (tt: $t:tt) =&gt; &#123; $t &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// literal - 字面量</span></span><br><span class="line">    (lit: $l:literal) =&gt; &#123; <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, $l) &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// lifetime - 生命周期</span></span><br><span class="line">    (lt: $lt:lifetime) =&gt; &#123; <span class="keyword">fn</span> <span class="title function_">foo</span>&lt;$lt&gt;() &#123;&#125; &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// meta - 属性内容</span></span><br><span class="line">    (meta: $m:meta) =&gt; &#123; <span class="meta">#[$m]</span> <span class="keyword">struct</span> <span class="title class_">S</span>; &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// vis - 可见性</span></span><br><span class="line">    (vis: $v:vis) =&gt; &#123; $v <span class="keyword">fn</span> <span class="title function_">visible</span>() &#123;&#125; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    demo_fragments!(expr: <span class="number">1</span> + <span class="number">2</span>);</span><br><span class="line">    demo_fragments!(ident: my_var);</span><br><span class="line">    demo_fragments!(ty: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;);</span><br><span class="line">    demo_fragments!(pat: (a, b));</span><br><span class="line">    demo_fragments!(stmt: <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>);</span><br><span class="line">    demo_fragments!(block: &#123; <span class="built_in">println!</span>(<span class="string">&quot;block&quot;</span>); &#125;);</span><br><span class="line">    demo_fragments!(lit: <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="重复模式"><a href="#重复模式" class="headerlink" title="重复模式"></a>重复模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 基本重复 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> vec_of_strings &#123;</span><br><span class="line">    <span class="comment">// $(...),* 表示零次或多次，用逗号分隔</span></span><br><span class="line">    ($($x:expr),*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">vec!</span>[$($x.<span class="title function_ invoke__">to_string</span>()),*]</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 至少一次 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> sum &#123;</span><br><span class="line">    <span class="comment">// $(...),+ 表示一次或多次</span></span><br><span class="line">    ($($x:expr),+) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">total</span> = <span class="number">0</span>;</span><br><span class="line">            $(total += $x;)+</span><br><span class="line">            total</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 零次或一次 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> optional_param &#123;</span><br><span class="line">    <span class="comment">// $(...)? 表示零次或一次</span></span><br><span class="line">    ($name:ident $(: $ty:ty)?) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 如果提供了类型，使用它；否则使用默认类型</span></span><br><span class="line">        <span class="keyword">struct</span> $name &#123;</span><br><span class="line">            value: $($ty)?</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 复杂重复模式 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> hash_map &#123;</span><br><span class="line">    <span class="comment">// 键值对重复</span></span><br><span class="line">    ($($key:expr =&gt; $value:expr),* $(,)?) =&gt; &#123;&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span> = std::collections::HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        $(map.<span class="title function_ invoke__">insert</span>($key, $value);)*</span><br><span class="line">        map</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">v</span> = vec_of_strings![<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>];</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, v);  <span class="comment">// [&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">total</span> = sum!(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;sum: &#123;&#125;&quot;</span>, total);  <span class="comment">// 15</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">map</span> = hash_map! &#123;</span><br><span class="line">        <span class="string">&quot;one&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;two&quot;</span> =&gt; <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;three&quot;</span> =&gt; <span class="number">3</span>,  <span class="comment">// 尾随逗号也支持</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="实用宏示例"><a href="#实用宏示例" class="headerlink" title="实用宏示例"></a>实用宏示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 1. 简化 println! 调试 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> dbg_vars &#123;</span><br><span class="line">    ($($var:ident),+ $(,)?) =&gt; &#123;</span><br><span class="line">        $(</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125; = &#123;:?&#125;&quot;</span>, <span class="built_in">stringify!</span>($var), $var);</span><br><span class="line">        )+</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 2. 创建枚举及其字符串转换 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> define_enum &#123;</span><br><span class="line">    (</span><br><span class="line">        $(<span class="meta">#[$meta:meta]</span>)*</span><br><span class="line">        $vis:vis <span class="keyword">enum</span> $name:ident &#123;</span><br><span class="line">            $($variant:ident),* $(,)?</span><br><span class="line">        &#125;</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">        $(<span class="meta">#[$meta]</span>)*</span><br><span class="line">        $vis <span class="keyword">enum</span> $name &#123;</span><br><span class="line">            $($variant),*</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">impl</span> $name &#123;</span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">as_str</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">                <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">                    $(<span class="keyword">Self</span>::$variant =&gt; <span class="built_in">stringify!</span>($variant)),*</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">variants</span>() <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> [&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>] &#123;</span><br><span class="line">                &amp;[$(<span class="built_in">stringify!</span>($variant)),*]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">std</span>::fmt::Display <span class="keyword">for</span> $name &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">                <span class="built_in">write!</span>(f, <span class="string">&quot;&#123;&#125;&quot;</span>, <span class="keyword">self</span>.<span class="title function_ invoke__">as_str</span>())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define_enum! &#123;</span><br><span class="line">    <span class="meta">#[derive(Debug, Clone, Copy)]</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">        Red,</span><br><span class="line">        Green,</span><br><span class="line">        Blue,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 3. 构建器模式生成 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> builder &#123;</span><br><span class="line">    (</span><br><span class="line">        $struct_name:ident &#123;</span><br><span class="line">            $($field:ident : $<span class="keyword">type</span>:ty),* $(,)?</span><br><span class="line">        &#125;</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">struct</span> $struct_name &#123;</span><br><span class="line">            $($field: $<span class="keyword">type</span>),*</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        paste::paste! &#123;</span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">struct</span> [&lt;$struct_name Builder&gt;] &#123;</span><br><span class="line">                $($field: <span class="type">Option</span>&lt;$<span class="keyword">type</span>&gt;),*</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">impl</span> [&lt;$struct_name Builder&gt;] &#123;</span><br><span class="line">                <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">                    <span class="keyword">Self</span> &#123;</span><br><span class="line">                        $($field: <span class="literal">None</span>),*</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">                $(</span><br><span class="line">                    <span class="keyword">pub</span> <span class="keyword">fn</span> $<span class="title function_ invoke__">field</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, value: $<span class="keyword">type</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">                        <span class="keyword">self</span>.$field = <span class="title function_ invoke__">Some</span>(value);</span><br><span class="line">                        <span class="keyword">self</span></span><br><span class="line">                    &#125;</span><br><span class="line">                )*</span><br><span class="line">              </span><br><span class="line">                <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">build</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;$struct_name, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">                    <span class="title function_ invoke__">Ok</span>($struct_name &#123;</span><br><span class="line">                        $($field: <span class="keyword">self</span>.$field.<span class="title function_ invoke__">ok_or</span>(<span class="built_in">concat!</span>(<span class="built_in">stringify!</span>($field), <span class="string">&quot; is required&quot;</span>))?),*</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 4. 测试夹具 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> test_cases &#123;</span><br><span class="line">    ($test_fn:ident: $($name:ident =&gt; ($($input:expr),*) == $expected:expr);+ $(;)?) =&gt; &#123;</span><br><span class="line">        $(</span><br><span class="line">            <span class="meta">#[test]</span></span><br><span class="line">            <span class="keyword">fn</span> $<span class="title function_ invoke__">name</span>() &#123;</span><br><span class="line">                <span class="built_in">assert_eq!</span>($<span class="title function_ invoke__">test_fn</span>($($input),*), $expected);</span><br><span class="line">            &#125;</span><br><span class="line">        )+</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123; a + b &#125;</span><br><span class="line"></span><br><span class="line">test_cases! &#123;</span><br><span class="line">    add:</span><br><span class="line">    test_add_positive =&gt; (<span class="number">2</span>, <span class="number">3</span>) == <span class="number">5</span>;</span><br><span class="line">    test_add_negative =&gt; (-<span class="number">1</span>, -<span class="number">1</span>) == -<span class="number">2</span>;</span><br><span class="line">    test_add_zero =&gt; (<span class="number">0</span>, <span class="number">0</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = <span class="string">&quot;Alice&quot;</span>;</span><br><span class="line">    dbg_vars!(x, name);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">color</span> = Color::Red;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, color);  <span class="comment">// Red</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, Color::<span class="title function_ invoke__">variants</span>());  <span class="comment">// [&quot;Red&quot;, &quot;Green&quot;, &quot;Blue&quot;]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="递归宏"><a href="#递归宏" class="headerlink" title="递归宏"></a>递归宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 计算参数数量 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> count &#123;</span><br><span class="line">    () =&gt; &#123; <span class="number">0usize</span> &#125;;</span><br><span class="line">    ($head:tt $($tail:tt)*) =&gt; &#123; <span class="number">1usize</span> + count!($($tail)*) &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 元组索引生成 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> tuple_index &#123;</span><br><span class="line">    ($tuple:expr; $($idx:tt),+ $(,)?) =&gt; &#123;</span><br><span class="line">        ($($tuple.$idx),+)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 递归展开列表 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> nested_vec &#123;</span><br><span class="line">    <span class="comment">// 基础情况：单个元素</span></span><br><span class="line">    ($elem:expr) =&gt; &#123; $elem &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 递归情况：多个元素</span></span><br><span class="line">    ($head:expr, $($tail:expr),+) =&gt; &#123;</span><br><span class="line">        <span class="built_in">vec!</span>[nested_vec!($head), nested_vec!($($tail),+)]</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 实现 trait 给多个类型 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> impl_trait_for &#123;</span><br><span class="line">    ($trait_name:ident <span class="keyword">for</span> $($ty:ty),+ $(,)?) =&gt; &#123;</span><br><span class="line">        $(</span><br><span class="line">            <span class="keyword">impl</span> $trait_name <span class="keyword">for</span> $ty &#123;&#125;</span><br><span class="line">        )+</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Printable</span> &#123;&#125;</span><br><span class="line">impl_trait_for!(Printable <span class="keyword">for</span> <span class="title class_">i32</span>, <span class="type">i64</span>, <span class="type">f32</span>, <span class="type">f64</span>, <span class="type">String</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = count!(a b c d e);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;count: &#123;&#125;&quot;</span>, n);  <span class="comment">// 5</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tuple</span> = (<span class="number">1</span>, <span class="string">&quot;hello&quot;</span>, <span class="number">3.14</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">selected</span> = tuple_index!(tuple; <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, selected);  <span class="comment">// (1, 3.14)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="宏的卫生性-Hygiene"><a href="#宏的卫生性-Hygiene" class="headerlink" title="宏的卫生性 (Hygiene)"></a>宏的卫生性 (Hygiene)</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============ 标识符卫生性 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> using_a &#123;</span><br><span class="line">    ($e:expr) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">42</span>;  <span class="comment">// 这个 a 在宏内部，外部看不到</span></span><br><span class="line">            $e           <span class="comment">// $e 中的 a 不会被替换</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = using_a!(a * <span class="number">2</span>);  <span class="comment">// 使用外部的 a</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, result);  <span class="comment">// 20，不是 84</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 突破卫生性 ============</span></span><br><span class="line"><span class="built_in">macro_rules!</span> declare_var &#123;</span><br><span class="line">    ($name:ident, $value:expr) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> $name = $value;  <span class="comment">// $name 来自调用者，可被外部访问</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    declare_var!(x, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, x);  <span class="comment">// 100 - 可以访问</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="过程宏-Procedural-Macros"><a href="#过程宏-Procedural-Macros" class="headerlink" title="过程宏 (Procedural Macros)"></a>过程宏 (Procedural Macros)</h2><h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">my_macros/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    └── lib.rs</span><br><span class="line"></span><br><span class="line">my_app/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">└── src/</span><br><span class="line">    └── main.rs</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_macros/Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_macros&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[lib]</span></span><br><span class="line"><span class="attr">proc-macro</span> = <span class="literal">true</span>  <span class="comment"># 声明为过程宏 crate</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">syn</span> = &#123; version = <span class="string">&quot;2&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">quote</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="attr">proc-macro2</span> = <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="函数式过程宏"><a href="#函数式过程宏" class="headerlink" title="函数式过程宏"></a>函数式过程宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_macros/src/lib.rs</span></span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;parse_macro_input, LitStr&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 简单示例 ============</span></span><br><span class="line"><span class="meta">#[proc_macro]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">make_hello</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = parse_macro_input!(input <span class="keyword">as</span> LitStr);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name_value</span> = name.<span class="title function_ invoke__">value</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">hello</span>() &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, #name_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ SQL 查询生成器 ============</span></span><br><span class="line"><span class="meta">#[proc_macro]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sql</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input_str</span> = input.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 简单验证 SQL（实际应用中会更复杂）</span></span><br><span class="line">    <span class="keyword">if</span> !input_str.<span class="title function_ invoke__">to_uppercase</span>().<span class="title function_ invoke__">starts_with</span>(<span class="string">&quot;SELECT&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> syn::Error::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            proc_macro2::Span::<span class="title function_ invoke__">call_site</span>(),</span><br><span class="line">            <span class="string">&quot;SQL must start with SELECT&quot;</span></span><br><span class="line">        )</span><br><span class="line">        .<span class="title function_ invoke__">to_compile_error</span>()</span><br><span class="line">        .<span class="title function_ invoke__">into</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">query</span> = #input_str;</span><br><span class="line">            query</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 解析自定义语法 ============</span></span><br><span class="line"><span class="keyword">use</span> syn::parse::&#123;Parse, ParseStream&#125;;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;Ident, Token, Expr&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MathExpr</span> &#123;</span><br><span class="line">    left: Expr,</span><br><span class="line">    op: Ident,</span><br><span class="line">    right: Expr,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Parse</span> <span class="keyword">for</span> <span class="title class_">MathExpr</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">parse</span>(input: ParseStream) <span class="punctuation">-&gt;</span> syn::<span class="type">Result</span>&lt;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">left</span> = input.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">        input.parse::&lt;Token![,]&gt;()?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">op</span> = input.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">        input.parse::&lt;Token![,]&gt;()?;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">right</span> = input.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(MathExpr &#123; left, op, right &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">math</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">MathExpr</span> &#123; left, op, right &#125; = parse_macro_input!(input <span class="keyword">as</span> MathExpr);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">op_str</span> = op.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = <span class="keyword">match</span> op_str.<span class="title function_ invoke__">as_str</span>() &#123;</span><br><span class="line">        <span class="string">&quot;add&quot;</span> =&gt; quote! &#123; #left + #right &#125;,</span><br><span class="line">        <span class="string">&quot;sub&quot;</span> =&gt; quote! &#123; #left - #right &#125;,</span><br><span class="line">        <span class="string">&quot;mul&quot;</span> =&gt; quote! &#123; #left * #right &#125;,</span><br><span class="line">        <span class="string">&quot;div&quot;</span> =&gt; quote! &#123; #left / #right &#125;,</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> syn::Error::<span class="title function_ invoke__">new</span>(op.<span class="title function_ invoke__">span</span>(), <span class="string">&quot;Unknown operation&quot;</span>)</span><br><span class="line">                .<span class="title function_ invoke__">to_compile_error</span>()</span><br><span class="line">                .<span class="title function_ invoke__">into</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_app/src/main.rs</span></span><br><span class="line"><span class="keyword">use</span> my_macros::&#123;make_hello, sql, math&#125;;</span><br><span class="line"></span><br><span class="line">make_hello!(<span class="string">&quot;World&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">hello</span>();  <span class="comment">// Hello, World!</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">query</span> = sql!(SELECT * FROM users WHERE id = <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, query);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = math!(<span class="number">10</span>, add, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, result);  <span class="comment">// 15</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Derive-宏"><a href="#Derive-宏" class="headerlink" title="Derive 宏"></a>Derive 宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_macros/src/lib.rs</span></span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;parse_macro_input, DeriveInput, Data, Fields&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 基础 Derive 宏 ============</span></span><br><span class="line"><span class="meta">#[proc_macro_derive(HelloMacro)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">hello_macro_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = input.ident;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">HelloMacro</span> <span class="keyword">for</span> #name &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">hello_macro</span>() &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Hello, Macro! My name is &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>(#name));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 带属性的 Derive 宏 ============</span></span><br><span class="line"><span class="meta">#[proc_macro_derive(Builder, attributes(builder))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">builder_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = &amp;input.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">builder_name</span> = syn::Ident::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        &amp;<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;Builder&quot;</span>, name),</span><br><span class="line">        name.<span class="title function_ invoke__">span</span>()</span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fields</span> = <span class="keyword">match</span> &amp;input.data &#123;</span><br><span class="line">        Data::<span class="title function_ invoke__">Struct</span>(data) =&gt; <span class="keyword">match</span> &amp;data.fields &#123;</span><br><span class="line">            Fields::<span class="title function_ invoke__">Named</span>(fields) =&gt; &amp;fields.named,</span><br><span class="line">            _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Only named fields are supported&quot;</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Only structs are supported&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成 builder 字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">builder_fields</span> = fields.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ty</span> = &amp;f.ty;</span><br><span class="line">        quote! &#123; #name: <span class="type">Option</span>&lt;#ty&gt; &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成 setter 方法</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">setters</span> = fields.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ty</span> = &amp;f.ty;</span><br><span class="line">        quote! &#123;</span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">fn</span> #<span class="title function_ invoke__">name</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, value: #ty) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.#name = <span class="title function_ invoke__">Some</span>(value);</span><br><span class="line">                <span class="keyword">self</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成 build 方法</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">build_fields</span> = fields.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">        quote! &#123;</span><br><span class="line">            #name: <span class="keyword">self</span>.#name.<span class="title function_ invoke__">ok_or</span>(<span class="built_in">concat!</span>(<span class="built_in">stringify!</span>(#name), <span class="string">&quot; is not set&quot;</span>))?</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成初始化</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">init_fields</span> = fields.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">        quote! &#123; #name: <span class="literal">None</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">pub</span> <span class="keyword">struct</span> #builder_name &#123;</span><br><span class="line">            #(#builder_fields),*</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">impl</span> #builder_name &#123;</span><br><span class="line">            #(#setters)*</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">build</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;#name, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">                <span class="title function_ invoke__">Ok</span>(#name &#123;</span><br><span class="line">                    #(#build_fields),*</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">impl</span> #name &#123;</span><br><span class="line">            <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">builder</span>() <span class="punctuation">-&gt;</span> #builder_name &#123;</span><br><span class="line">                #builder_name &#123;</span><br><span class="line">                    #(#init_fields),*</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 自动实现 Debug（简化版）============</span></span><br><span class="line"><span class="meta">#[proc_macro_derive(MyDebug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">my_debug_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = &amp;input.ident;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fields</span> = <span class="keyword">match</span> &amp;input.data &#123;</span><br><span class="line">        Data::<span class="title function_ invoke__">Struct</span>(data) =&gt; <span class="keyword">match</span> &amp;data.fields &#123;</span><br><span class="line">            Fields::<span class="title function_ invoke__">Named</span>(fields) =&gt; fields.named.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">                quote! &#123;</span><br><span class="line">                    .<span class="title function_ invoke__">field</span>(<span class="built_in">stringify!</span>(#name), &amp;<span class="keyword">self</span>.#name)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).collect::&lt;<span class="type">Vec</span>&lt;_&gt;&gt;(),</span><br><span class="line">            Fields::<span class="title function_ invoke__">Unnamed</span>(fields) =&gt; fields.unnamed.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>().<span class="title function_ invoke__">map</span>(|(i, _)| &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">index</span> = syn::Index::<span class="title function_ invoke__">from</span>(i);</span><br><span class="line">                quote! &#123;</span><br><span class="line">                    .<span class="title function_ invoke__">field</span>(&amp;<span class="keyword">self</span>.#index)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).collect::&lt;<span class="type">Vec</span>&lt;_&gt;&gt;(),</span><br><span class="line">            Fields::Unit =&gt; <span class="built_in">vec!</span>[],</span><br><span class="line">        &#125;,</span><br><span class="line">        _ =&gt; <span class="built_in">panic!</span>(<span class="string">&quot;Only structs are supported&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">std</span>::fmt::<span class="built_in">Debug</span> <span class="keyword">for</span> #name &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">                f.<span class="title function_ invoke__">debug_struct</span>(<span class="built_in">stringify!</span>(#name))</span><br><span class="line">                    #(#fields)*</span><br><span class="line">                    .<span class="title function_ invoke__">finish</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">use</span> my_macros::&#123;HelloMacro, Builder, MyDebug&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">HelloMacro</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">hello_macro</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(HelloMacro)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Pancakes</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Builder)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Command</span> &#123;</span><br><span class="line">    executable: <span class="type">String</span>,</span><br><span class="line">    args: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">    current_dir: <span class="type">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(MyDebug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    Pancakes::<span class="title function_ invoke__">hello_macro</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cmd</span> = Command::<span class="title function_ invoke__">builder</span>()</span><br><span class="line">        .<span class="title function_ invoke__">executable</span>(<span class="string">&quot;cargo&quot;</span>.<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">        .<span class="title function_ invoke__">args</span>(<span class="built_in">vec!</span>[<span class="string">&quot;build&quot;</span>.<span class="title function_ invoke__">to_string</span>()])</span><br><span class="line">        .<span class="title function_ invoke__">current_dir</span>(<span class="string">&quot;.&quot;</span>.<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">        .<span class="title function_ invoke__">build</span>()</span><br><span class="line">        .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">point</span> = Point &#123; x: <span class="number">10</span>, y: <span class="number">20</span> &#125;;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, point);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="属性宏"><a href="#属性宏" class="headerlink" title="属性宏"></a>属性宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_macros/src/lib.rs</span></span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;parse_macro_input, ItemFn, AttributeArgs, NestedMeta, Lit, Meta&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 简单函数包装 ============</span></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">log_call</span>(_attr: TokenStream, item: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(item <span class="keyword">as</span> ItemFn);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_name</span> = &amp;input.sig.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_block</span> = &amp;input.block;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_sig</span> = &amp;input.sig;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_vis</span> = &amp;input.vis;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        #fn_vis #fn_sig &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[LOG] Entering &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>(#fn_name));</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">result</span> = (|| #fn_block)();</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;[LOG] Exiting &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>(#fn_name));</span><br><span class="line">            result</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 带参数的属性宏 ============</span></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">retry</span>(attr: TokenStream, item: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">args</span> = parse_macro_input!(attr <span class="keyword">as</span> AttributeArgs);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(item <span class="keyword">as</span> ItemFn);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 解析重试次数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">retries</span> = <span class="number">3usize</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">arg</span> <span class="keyword">in</span> args &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">NestedMeta</span>::<span class="title function_ invoke__">Meta</span>(Meta::<span class="title function_ invoke__">NameValue</span>(nv)) = arg &#123;</span><br><span class="line">            <span class="keyword">if</span> nv.path.<span class="title function_ invoke__">is_ident</span>(<span class="string">&quot;times&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Lit</span>::<span class="title function_ invoke__">Int</span>(lit) = nv.lit &#123;</span><br><span class="line">                    retries = lit.<span class="title function_ invoke__">base10_parse</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_name</span> = &amp;input.sig.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_block</span> = &amp;input.block;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_sig</span> = &amp;input.sig;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_vis</span> = &amp;input.vis;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        #fn_vis #fn_sig &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">attempts</span> = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">loop</span> &#123;</span><br><span class="line">                attempts += <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">result</span> = (|| #fn_block)();</span><br><span class="line">                <span class="keyword">if</span> result.<span class="title function_ invoke__">is_ok</span>() || attempts &gt;= #retries &#123;</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;[RETRY] &#123;&#125; attempt &#123;&#125; failed&quot;</span>, <span class="built_in">stringify!</span>(#fn_name), attempts);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 路由宏（Web 框架风格）============</span></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">route</span>(attr: TokenStream, item: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">attr_str</span> = attr.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(item <span class="keyword">as</span> ItemFn);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_name</span> = &amp;input.sig.ident;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 解析路由如: &quot;GET&quot;, &quot;/users&quot;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">parts</span>: <span class="type">Vec</span>&lt;&amp;<span class="type">str</span>&gt; = attr_str.<span class="title function_ invoke__">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">trim_matches</span>(<span class="string">&#x27;&quot;&#x27;</span>)).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">method</span> = parts.<span class="title function_ invoke__">get</span>(<span class="number">0</span>).<span class="title function_ invoke__">unwrap_or</span>(&amp;<span class="string">&quot;GET&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">path</span> = parts.<span class="title function_ invoke__">get</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap_or</span>(&amp;<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        #input</span><br><span class="line">      </span><br><span class="line">        inventory::submit! &#123;</span><br><span class="line">            Route &#123;</span><br><span class="line">                method: #method,</span><br><span class="line">                path: #path,</span><br><span class="line">                handler: #fn_name,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 测试标记宏 ============</span></span><br><span class="line"><span class="meta">#[proc_macro_attribute]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">test_case</span>(attr: TokenStream, item: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(item <span class="keyword">as</span> ItemFn);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_name</span> = &amp;input.sig.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fn_block</span> = &amp;input.block;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建测试函数</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">test_name</span> = syn::Ident::<span class="title function_ invoke__">new</span>(</span><br><span class="line">        &amp;<span class="built_in">format!</span>(<span class="string">&quot;test_&#123;&#125;&quot;</span>, fn_name),</span><br><span class="line">        fn_name.<span class="title function_ invoke__">span</span>()</span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        #input</span><br><span class="line">      </span><br><span class="line">        <span class="meta">#[test]</span></span><br><span class="line">        <span class="keyword">fn</span> #<span class="title function_ invoke__">test_name</span>() &#123;</span><br><span class="line">            #fn_block</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">use</span> my_macros::&#123;log_call, retry, route&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[log_call]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">compute</span>(x: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    x * <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[retry(times = 5)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fetch_data</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 可能失败的操作</span></span><br><span class="line">    <span class="title function_ invoke__">Err</span>(<span class="string">&quot;network error&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[route(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/users&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_users</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="built_in">vec!</span>[<span class="string">&quot;Alice&quot;</span>.<span class="title function_ invoke__">to_string</span>(), <span class="string">&quot;Bob&quot;</span>.<span class="title function_ invoke__">to_string</span>()]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">compute</span>(<span class="number">21</span>);</span><br><span class="line">    <span class="comment">// [LOG] Entering compute</span></span><br><span class="line">    <span class="comment">// [LOG] Exiting compute</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="syn-和-quote-深入"><a href="#syn-和-quote-深入" class="headerlink" title="syn 和 quote 深入"></a>syn 和 quote 深入</h2><h3 id="syn-解析-Rust-代码"><a href="#syn-解析-Rust-代码" class="headerlink" title="syn - 解析 Rust 代码"></a>syn - 解析 Rust 代码</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> syn::&#123;</span><br><span class="line">    parse_macro_input, DeriveInput, Data, Fields, Type,</span><br><span class="line">    Attribute, Expr, Lit, Meta, NestedMeta,</span><br><span class="line">    ItemStruct, ItemFn, ItemEnum,</span><br><span class="line">    Generics, GenericParam, TypeParam,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 解析结构体 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">parse_struct</span>(input: DeriveInput) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = input.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">generics</span> = input.generics;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">attrs</span> = input.attrs;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理泛型</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">param</span> <span class="keyword">in</span> generics.params &#123;</span><br><span class="line">        <span class="keyword">match</span> param &#123;</span><br><span class="line">            GenericParam::<span class="title function_ invoke__">Type</span>(TypeParam &#123; ident, .. &#125;) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Type param: &#123;&#125;&quot;</span>, ident);</span><br><span class="line">            &#125;</span><br><span class="line">            GenericParam::<span class="title function_ invoke__">Lifetime</span>(lt) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Lifetime: &#123;&#125;&quot;</span>, lt.lifetime);</span><br><span class="line">            &#125;</span><br><span class="line">            GenericParam::<span class="title function_ invoke__">Const</span>(c) =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Const: &#123;&#125;&quot;</span>, c.ident);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理字段</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Data</span>::<span class="title function_ invoke__">Struct</span>(data) = input.data &#123;</span><br><span class="line">        <span class="keyword">match</span> data.fields &#123;</span><br><span class="line">            Fields::<span class="title function_ invoke__">Named</span>(fields) =&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">field</span> <span class="keyword">in</span> fields.named &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">field_name</span> = field.ident.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">field_type</span> = field.ty;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Field: &#123;&#125; : &#123;:?&#125;&quot;</span>, field_name, field_type);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Fields::<span class="title function_ invoke__">Unnamed</span>(fields) =&gt; &#123;</span><br><span class="line">                <span class="title function_ invoke__">for</span> (i, field) <span class="keyword">in</span> fields.unnamed.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;Field &#123;&#125;: &#123;:?&#125;&quot;</span>, i, field.ty);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Fields::Unit =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Unit struct&quot;</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 解析属性 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">parse_attributes</span>(attrs: &amp;[Attribute]) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">attr</span> <span class="keyword">in</span> attrs &#123;</span><br><span class="line">        <span class="comment">// #[derive(...)]</span></span><br><span class="line">        <span class="keyword">if</span> attr.path.<span class="title function_ invoke__">is_ident</span>(<span class="string">&quot;derive&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Found derive attribute&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// #[my_attr(key = &quot;value&quot;)]</span></span><br><span class="line">        <span class="keyword">if</span> attr.path.<span class="title function_ invoke__">is_ident</span>(<span class="string">&quot;my_attr&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(Meta::<span class="title function_ invoke__">List</span>(list)) = attr.<span class="title function_ invoke__">parse_meta</span>() &#123;</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">nested</span> <span class="keyword">in</span> list.nested &#123;</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">NestedMeta</span>::<span class="title function_ invoke__">Meta</span>(Meta::<span class="title function_ invoke__">NameValue</span>(nv)) = nested &#123;</span><br><span class="line">                        <span class="keyword">if</span> nv.path.<span class="title function_ invoke__">is_ident</span>(<span class="string">&quot;key&quot;</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Lit</span>::<span class="title function_ invoke__">Str</span>(s) = nv.lit &#123;</span><br><span class="line">                                <span class="built_in">println!</span>(<span class="string">&quot;key = &#123;&#125;&quot;</span>, s.<span class="title function_ invoke__">value</span>());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 类型分析 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">analyze_type</span>(ty: &amp;Type) &#123;</span><br><span class="line">    <span class="keyword">match</span> ty &#123;</span><br><span class="line">        Type::<span class="title function_ invoke__">Path</span>(type_path) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(segment) = type_path.path.segments.<span class="title function_ invoke__">last</span>() &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;Type: &#123;&#125;&quot;</span>, segment.ident);</span><br><span class="line">              </span><br><span class="line">                <span class="comment">// 检查是否是 Option&lt;T&gt;</span></span><br><span class="line">                <span class="keyword">if</span> segment.ident == <span class="string">&quot;Option&quot;</span> &#123;</span><br><span class="line">                    <span class="built_in">println!</span>(<span class="string">&quot;This is an Option type&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Type::<span class="title function_ invoke__">Reference</span>(reference) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Reference type, mutable: &#123;&#125;&quot;</span>, reference.mutability.<span class="title function_ invoke__">is_some</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        Type::<span class="title function_ invoke__">Array</span>(array) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Array type&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _ =&gt; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="quote-生成代码"><a href="#quote-生成代码" class="headerlink" title="quote - 生成代码"></a>quote - 生成代码</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> quote::&#123;quote, quote_spanned, format_ident, ToTokens&#125;;</span><br><span class="line"><span class="keyword">use</span> proc_macro2::&#123;Span, TokenStream&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 基础用法 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">basic_quote</span>() <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = format_ident!(<span class="string">&quot;MyStruct&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">field</span> = format_ident!(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ty</span> = quote! &#123; <span class="type">i32</span> &#125;;</span><br><span class="line">  </span><br><span class="line">    quote! &#123;</span><br><span class="line">        <span class="keyword">struct</span> #name &#123;</span><br><span class="line">            #field: #ty,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 重复展开 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">quote_repetition</span>(names: &amp;[&amp;<span class="type">str</span>]) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fields</span> = names.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|name| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ident</span> = format_ident!(<span class="string">&quot;&#123;&#125;&quot;</span>, name);</span><br><span class="line">        quote! &#123; #ident: <span class="type">String</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">inits</span> = names.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">map</span>(|name| &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ident</span> = format_ident!(<span class="string">&quot;&#123;&#125;&quot;</span>, name);</span><br><span class="line">        quote! &#123; #ident: <span class="type">String</span>::<span class="title function_ invoke__">new</span>() &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    quote! &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">MyStruct</span> &#123;</span><br><span class="line">            #(#fields),*</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">Default</span> <span class="keyword">for</span> <span class="title class_">MyStruct</span> &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">default</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">                <span class="keyword">Self</span> &#123;</span><br><span class="line">                    #(#inits),*</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 条件生成 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">conditional_quote</span>(include_debug: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">debug_impl</span> = <span class="keyword">if</span> include_debug &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(quote! &#123;</span><br><span class="line">            <span class="keyword">impl</span> <span class="title class_">std</span>::fmt::<span class="built_in">Debug</span> <span class="keyword">for</span> <span class="title class_">MyStruct</span> &#123;</span><br><span class="line">                <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> std::fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> std::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">                    <span class="built_in">write!</span>(f, <span class="string">&quot;MyStruct&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    quote! &#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">MyStruct</span>;</span><br><span class="line">        #debug_impl</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 保留错误位置 ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">quote_with_span</span>(field_name: &amp;syn::Ident, field_type: &amp;syn::Type) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="comment">// 错误消息会指向原始代码位置</span></span><br><span class="line">    quote_spanned! &#123;field_name.<span class="title function_ invoke__">span</span>()=&gt;</span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">HasField</span> <span class="keyword">for</span> <span class="title class_">MyStruct</span> &#123;</span><br><span class="line">            <span class="keyword">type</span> <span class="title class_">FieldType</span> = #field_type;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">get_field</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">Self</span>::FieldType &#123;</span><br><span class="line">                &amp;<span class="keyword">self</span>.#field_name</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 嵌套 quote ============</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">nested_quote</span>() <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">inner</span> = quote! &#123; <span class="built_in">println!</span>(<span class="string">&quot;inner&quot;</span>) &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">outer</span> = quote! &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">wrapper</span>() &#123;</span><br><span class="line">            #inner</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    outer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="高级模式与技巧"><a href="#高级模式与技巧" class="headerlink" title="高级模式与技巧"></a>高级模式与技巧</h2><h3 id="TT-Muncher（Token-咀嚼器）"><a href="#TT-Muncher（Token-咀嚼器）" class="headerlink" title="TT Muncher（Token 咀嚼器）"></a>TT Muncher（Token 咀嚼器）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 逐个处理 token</span></span><br><span class="line"><span class="built_in">macro_rules!</span> parse_commands &#123;</span><br><span class="line">    <span class="comment">// 基础情况：空输入</span></span><br><span class="line">    () =&gt; &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// SET key = value</span></span><br><span class="line">    (SET $key:ident = $value:expr; $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Setting &#123;&#125; = &#123;:?&#125;&quot;</span>, <span class="built_in">stringify!</span>($key), $value);</span><br><span class="line">        parse_commands!($($rest)*);</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// GET key</span></span><br><span class="line">    (GET $key:ident; $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Getting &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>($key));</span><br><span class="line">        parse_commands!($($rest)*);</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// DELETE key</span></span><br><span class="line">    (DELETE $key:ident; $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Deleting &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>($key));</span><br><span class="line">        parse_commands!($($rest)*);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    parse_commands! &#123;</span><br><span class="line">        SET name = <span class="string">&quot;Alice&quot;</span>;</span><br><span class="line">        SET age = <span class="number">30</span>;</span><br><span class="line">        GET name;</span><br><span class="line">        DELETE age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Push-Down-Accumulator（下推累加器）"><a href="#Push-Down-Accumulator（下推累加器）" class="headerlink" title="Push-Down Accumulator（下推累加器）"></a>Push-Down Accumulator（下推累加器）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 累积处理结果</span></span><br><span class="line"><span class="built_in">macro_rules!</span> reverse &#123;</span><br><span class="line">    <span class="comment">// 入口</span></span><br><span class="line">    ([$($input:tt)*]) =&gt; &#123;</span><br><span class="line">        reverse!([$($input)*] <span class="punctuation">-&gt;</span> [])</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 基础情况：输入空，返回累积结果</span></span><br><span class="line">    ([] <span class="punctuation">-&gt;</span> [$($output:tt)*]) =&gt; &#123;</span><br><span class="line">        ($($output)*)</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 递归：从输入取一个，放到输出前面</span></span><br><span class="line">    ([$head:tt $($tail:tt)*] <span class="punctuation">-&gt;</span> [$($output:tt)*]) =&gt; &#123;</span><br><span class="line">        reverse!([$($tail)*] <span class="punctuation">-&gt;</span> [$head $($output)*])</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reversed</span> = reverse!([<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]);</span><br><span class="line">    <span class="comment">// 展开为 (5 4 3 2 1)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更实用的例子：生成嵌套结构</span></span><br><span class="line"><span class="built_in">macro_rules!</span> nested &#123;</span><br><span class="line">    <span class="comment">// 入口</span></span><br><span class="line">    ($($items:tt)*) =&gt; &#123;</span><br><span class="line">        nested!(@build [] $($items)*)</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 基础情况</span></span><br><span class="line">    (@build [$($acc:tt)*]) =&gt; &#123;</span><br><span class="line">        $($acc)*</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 递归</span></span><br><span class="line">    (@build [$($acc:tt)*] $item:tt $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        nested!(@build [&#123; $item $($acc)* &#125;] $($rest)*)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="内部规则模式"><a href="#内部规则模式" class="headerlink" title="内部规则模式"></a>内部规则模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> complex_macro &#123;</span><br><span class="line">    <span class="comment">// 公共入口</span></span><br><span class="line">    ($($input:tt)*) =&gt; &#123;</span><br><span class="line">        complex_macro!(@parse $($input)*)</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 内部规则：解析</span></span><br><span class="line">    (@parse <span class="keyword">struct</span> $name:ident &#123; $($fields:tt)* &#125;) =&gt; &#123;</span><br><span class="line">        complex_macro!(@gen_struct $name [] $($fields)*)</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 内部规则：生成结构体</span></span><br><span class="line">    (@gen_struct $name:ident [$($processed:tt)*]) =&gt; &#123;</span><br><span class="line">        <span class="keyword">struct</span> $name &#123;</span><br><span class="line">            $($processed)*</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 内部规则：处理字段</span></span><br><span class="line">    (@gen_struct $name:ident [$($processed:tt)*] $field:ident : $ty:ty, $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        complex_macro!(@gen_struct $name [$($processed)* $field: $ty,] $($rest)*)</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    (@gen_struct $name:ident [$($processed:tt)*] $field:ident : $ty:ty) =&gt; &#123;</span><br><span class="line">        complex_macro!(@gen_struct $name [$($processed)* $field: $ty,])</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">complex_macro! &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">        name: <span class="type">String</span>,</span><br><span class="line">        age: <span class="type">u32</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Callback-模式"><a href="#Callback-模式" class="headerlink" title="Callback 模式"></a>Callback 模式</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 宏调用另一个宏处理结果</span></span><br><span class="line"><span class="built_in">macro_rules!</span> call_with_result &#123;</span><br><span class="line">    ($callback:ident, $($input:tt)*) =&gt; &#123;</span><br><span class="line">        $callback!([ processed: $($input)* ])</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">macro_rules!</span> my_callback &#123;</span><br><span class="line">    ([ processed: $($data:tt)* ]) =&gt; &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Received: &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>($($data)*));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    call_with_result!(my_callback, hello world);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="调试宏"><a href="#调试宏" class="headerlink" title="调试宏"></a>调试宏</h2><h3 id="展开宏"><a href="#展开宏" class="headerlink" title="展开宏"></a>展开宏</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 cargo-expand</span></span><br><span class="line">cargo install cargo-expand</span><br><span class="line">cargo <span class="built_in">expand</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 展开特定模块</span></span><br><span class="line">cargo <span class="built_in">expand</span> module_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 展开特定测试</span></span><br><span class="line">cargo <span class="built_in">expand</span> --<span class="built_in">test</span> test_name</span><br></pre></td></tr></table></figure></div>

<h3 id="编译时调试"><a href="#编译时调试" class="headerlink" title="编译时调试"></a>编译时调试</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> debug_macro &#123;</span><br><span class="line">    ($($tokens:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 编译时打印输入</span></span><br><span class="line">        compile_error!(<span class="built_in">concat!</span>(<span class="string">&quot;Input: &quot;</span>, <span class="built_in">stringify!</span>($($tokens)*)));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 trace_macros（nightly）</span></span><br><span class="line"><span class="meta">#![feature(trace_macros)]</span></span><br><span class="line">trace_macros!(<span class="literal">true</span>);</span><br><span class="line">my_macro!(some input);</span><br><span class="line">trace_macros!(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 log_syntax（nightly）</span></span><br><span class="line"><span class="meta">#![feature(log_syntax)]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> debug &#123;</span><br><span class="line">    ($($t:tt)*) =&gt; &#123;</span><br><span class="line">        log_syntax!($($t)*);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="过程宏调试"><a href="#过程宏调试" class="headerlink" title="过程宏调试"></a>过程宏调试</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[proc_macro_derive(MyDerive)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">my_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="comment">// 打印输入</span></span><br><span class="line">    eprintln!(<span class="string">&quot;Input: &#123;:#?&#125;&quot;</span>, input);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打印解析后的 AST</span></span><br><span class="line">    eprintln!(<span class="string">&quot;Parsed: &#123;:#?&#125;&quot;</span>, input);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打印输出</span></span><br><span class="line">    eprintln!(<span class="string">&quot;Output: &#123;&#125;&quot;</span>, expanded);</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="实战示例"><a href="#实战示例" class="headerlink" title="实战示例"></a>实战示例</h2><h3 id="完整的-Derive-宏：自动实现-From"><a href="#完整的-Derive-宏：自动实现-From" class="headerlink" title="完整的 Derive 宏：自动实现 From"></a>完整的 Derive 宏：自动实现 From</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.rs</span></span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;parse_macro_input, DeriveInput, Data, Fields, Type, Path&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_derive(AutoFrom, attributes(from))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">auto_from_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = &amp;input.ident;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Data</span>::<span class="title function_ invoke__">Struct</span>(data) = &amp;input.data <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> syn::Error::<span class="title function_ invoke__">new_spanned</span>(&amp;input, <span class="string">&quot;AutoFrom only works on structs&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">to_compile_error</span>()</span><br><span class="line">            .<span class="title function_ invoke__">into</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">Fields</span>::<span class="title function_ invoke__">Named</span>(fields) = &amp;data.fields <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> syn::Error::<span class="title function_ invoke__">new_spanned</span>(&amp;input, <span class="string">&quot;AutoFrom requires named fields&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">to_compile_error</span>()</span><br><span class="line">            .<span class="title function_ invoke__">into</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 查找带有 #[from] 属性的字段</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">from_impls</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">field</span> <span class="keyword">in</span> &amp;fields.named &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">field_name</span> = field.ident.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">field_type</span> = &amp;field.ty;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 检查 #[from] 属性</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">has_from</span> = field.attrs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">any</span>(|attr| attr.path.<span class="title function_ invoke__">is_ident</span>(<span class="string">&quot;from&quot;</span>));</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> has_from &#123;</span><br><span class="line">            <span class="comment">// 生成所有其他字段的默认值</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">other_fields</span> = fields.named.<span class="title function_ invoke__">iter</span>()</span><br><span class="line">                .<span class="title function_ invoke__">filter</span>(|f| f.ident.<span class="title function_ invoke__">as_ref</span>() != <span class="title function_ invoke__">Some</span>(field_name))</span><br><span class="line">                .<span class="title function_ invoke__">map</span>(|f| &#123;</span><br><span class="line">                    <span class="keyword">let</span> <span class="variable">name</span> = &amp;f.ident;</span><br><span class="line">                    quote! &#123; #name: <span class="built_in">Default</span>::<span class="title function_ invoke__">default</span>() &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">          </span><br><span class="line">            from_impls.<span class="title function_ invoke__">push</span>(quote! &#123;</span><br><span class="line">                <span class="keyword">impl</span> <span class="title class_">From</span>&lt;#field_type&gt; <span class="keyword">for</span> #name &#123;</span><br><span class="line">                    <span class="keyword">fn</span> <span class="title function_">from</span>(value: #field_type) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">                        <span class="keyword">Self</span> &#123;</span><br><span class="line">                            #field_name: value,</span><br><span class="line">                            #(#other_fields),*</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">expanded</span> = quote! &#123;</span><br><span class="line">        #(#from_impls)*</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    expanded.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">use</span> my_macros::AutoFrom;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(AutoFrom, Default, Debug)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">#[from]</span></span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    <span class="meta">#[from]</span></span><br><span class="line">    age: <span class="type">u32</span>,</span><br><span class="line">    active: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user1</span>: User = <span class="string">&quot;Alice&quot;</span>.<span class="title function_ invoke__">to_string</span>().<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user2</span>: User = <span class="number">25u32</span>.<span class="title function_ invoke__">into</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user1);  <span class="comment">// User &#123; name: &quot;Alice&quot;, age: 0, active: false &#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, user2);  <span class="comment">// User &#123; name: &quot;&quot;, age: 25, active: false &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="DSL：查询构建器"><a href="#DSL：查询构建器" class="headerlink" title="DSL：查询构建器"></a>DSL：查询构建器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明宏版本</span></span><br><span class="line"><span class="built_in">macro_rules!</span> query &#123;</span><br><span class="line">    (</span><br><span class="line">        SELECT $($col:ident),+ </span><br><span class="line">        FROM $table:ident</span><br><span class="line">        $(WHERE $($cond:tt)+)?</span><br><span class="line">        $(ORDER BY $order_col:ident $order_dir:ident)?</span><br><span class="line">        $(LIMIT $limit:expr)?</span><br><span class="line">    ) =&gt; &#123;&#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">q</span> = <span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;SELECT &#123;&#125; FROM &#123;&#125;&quot;</span>,</span><br><span class="line">            <span class="built_in">vec!</span>[$(<span class="built_in">stringify!</span>($col)),+].<span class="title function_ invoke__">join</span>(<span class="string">&quot;, &quot;</span>),</span><br><span class="line">            <span class="built_in">stringify!</span>($table)</span><br><span class="line">        );</span><br><span class="line">      </span><br><span class="line">        $(</span><br><span class="line">            q.<span class="title function_ invoke__">push_str</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot; WHERE &#123;&#125;&quot;</span>, <span class="built_in">stringify!</span>($($cond)+)));</span><br><span class="line">        )?</span><br><span class="line">      </span><br><span class="line">        $(</span><br><span class="line">            q.<span class="title function_ invoke__">push_str</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot; ORDER BY &#123;&#125; &#123;&#125;&quot;</span>, </span><br><span class="line">                <span class="built_in">stringify!</span>($order_col), </span><br><span class="line">                <span class="built_in">stringify!</span>($order_dir)</span><br><span class="line">            ));</span><br><span class="line">        )?</span><br><span class="line">      </span><br><span class="line">        $(</span><br><span class="line">            q.<span class="title function_ invoke__">push_str</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot; LIMIT &#123;&#125;&quot;</span>, $limit));</span><br><span class="line">        )?</span><br><span class="line">      </span><br><span class="line">        q</span><br><span class="line">    &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">q1</span> = query!(</span><br><span class="line">        SELECT id, name, email</span><br><span class="line">        FROM users</span><br><span class="line">        WHERE id &gt; <span class="number">10</span> AND active = <span class="literal">true</span></span><br><span class="line">        ORDER BY name ASC</span><br><span class="line">        LIMIT <span class="number">10</span></span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, q1);</span><br><span class="line">    <span class="comment">// SELECT id, name, email FROM users WHERE id &gt; 10 AND active = true ORDER BY name ASC LIMIT 10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="类型安全的-HTML-构建器"><a href="#类型安全的-HTML-构建器" class="headerlink" title="类型安全的 HTML 构建器"></a>类型安全的 HTML 构建器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> html &#123;</span><br><span class="line">    <span class="comment">// 文本节点</span></span><br><span class="line">    ($text:literal) =&gt; &#123;</span><br><span class="line">        $text.<span class="title function_ invoke__">to_string</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 空元素</span></span><br><span class="line">    ($tag:ident) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&lt;&#123;&#125;&gt;&lt;/&#123;&#125;&gt;&quot;</span>, <span class="built_in">stringify!</span>($tag), <span class="built_in">stringify!</span>($tag))</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带属性的元素</span></span><br><span class="line">    ($tag:ident [$($attr:ident = $value:expr),* $(,)?]) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;&lt;&#123;&#125; &#123;&#125;&gt;&lt;/&#123;&#125;&gt;&quot;</span>,</span><br><span class="line">            <span class="built_in">stringify!</span>($tag),</span><br><span class="line">            <span class="built_in">vec!</span>[$(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;=\&quot;&#123;&#125;\&quot;&quot;</span>, <span class="built_in">stringify!</span>($attr), $value)),*].<span class="title function_ invoke__">join</span>(<span class="string">&quot; &quot;</span>),</span><br><span class="line">            <span class="built_in">stringify!</span>($tag)</span><br><span class="line">        )</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带子元素</span></span><br><span class="line">    ($tag:ident &#123; $($child:tt)* &#125;) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;&lt;&#123;&#125;&gt;&#123;&#125;&lt;/&#123;&#125;&gt;&quot;</span>,</span><br><span class="line">            <span class="built_in">stringify!</span>($tag),</span><br><span class="line">            html!(@children $($child)*),</span><br><span class="line">            <span class="built_in">stringify!</span>($tag)</span><br><span class="line">        )</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带属性和子元素</span></span><br><span class="line">    ($tag:ident [$($attr:ident = $value:expr),* $(,)?] &#123; $($child:tt)* &#125;) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(</span><br><span class="line">            <span class="string">&quot;&lt;&#123;&#125; &#123;&#125;&gt;&#123;&#125;&lt;/&#123;&#125;&gt;&quot;</span>,</span><br><span class="line">            <span class="built_in">stringify!</span>($tag),</span><br><span class="line">            <span class="built_in">vec!</span>[$(<span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;=\&quot;&#123;&#125;\&quot;&quot;</span>, <span class="built_in">stringify!</span>($attr), $value)),*].<span class="title function_ invoke__">join</span>(<span class="string">&quot; &quot;</span>),</span><br><span class="line">            html!(@children $($child)*),</span><br><span class="line">            <span class="built_in">stringify!</span>($tag)</span><br><span class="line">        )</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 内部规则：处理子元素</span></span><br><span class="line">    (@children) =&gt; &#123; <span class="type">String</span>::<span class="title function_ invoke__">new</span>() &#125;;</span><br><span class="line">  </span><br><span class="line">    (@children $tag:ident $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, html!($tag), html!(@children $($rest)*))</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    (@children $tag:ident [$($attr:tt)*] $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, html!($tag [$($attr)*]), html!(@children $($rest)*))</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    (@children $tag:ident &#123; $($inner:tt)* &#125; $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, html!($tag &#123; $($inner)* &#125;), html!(@children $($rest)*))</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    (@children $tag:ident [$($attr:tt)*] &#123; $($inner:tt)* &#125; $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, html!($tag [$($attr)*] &#123; $($inner)* &#125;), html!(@children $($rest)*))</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    (@children $text:literal $($rest:tt)*) =&gt; &#123;</span><br><span class="line">        <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;&#123;&#125;&quot;</span>, $text, html!(@children $($rest)*))</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">page</span> = html!(</span><br><span class="line">        html &#123;</span><br><span class="line">            head &#123;</span><br><span class="line">                title &#123; <span class="string">&quot;My Page&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            body &#123;</span><br><span class="line">                h1 [class = <span class="string">&quot;title&quot;</span>] &#123; <span class="string">&quot;Hello&quot;</span> &#125;</span><br><span class="line">                div [id = <span class="string">&quot;content&quot;</span>, class = <span class="string">&quot;container&quot;</span>] &#123;</span><br><span class="line">                    p &#123; <span class="string">&quot;Welcome to my page!&quot;</span> &#125;</span><br><span class="line">                    a [href = <span class="string">&quot;https://example.com&quot;</span>] &#123; <span class="string">&quot;Click here&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常用宏-Crate"><a href="#常用宏-Crate" class="headerlink" title="常用宏 Crate"></a>常用宏 Crate</h2><table>
<thead>
<tr>
<th>Crate</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>syn</code></td>
<td>解析 Rust 代码</td>
</tr>
<tr>
<td><code>quote</code></td>
<td>生成 Rust 代码</td>
</tr>
<tr>
<td><code>proc-macro2</code></td>
<td>TokenStream 处理</td>
</tr>
<tr>
<td><code>darling</code></td>
<td>简化属性解析</td>
</tr>
<tr>
<td><code>paste</code></td>
<td>标识符拼接</td>
</tr>
<tr>
<td><code>thiserror</code></td>
<td>错误类型派生</td>
</tr>
<tr>
<td><code>serde</code></td>
<td>序列化派生</td>
</tr>
</tbody></table>
<h3 id="darling-示例"><a href="#darling-示例" class="headerlink" title="darling 示例"></a>darling 示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> darling::&#123;FromDeriveInput, FromField&#125;;</span><br><span class="line"><span class="keyword">use</span> proc_macro::TokenStream;</span><br><span class="line"><span class="keyword">use</span> quote::quote;</span><br><span class="line"><span class="keyword">use</span> syn::&#123;parse_macro_input, DeriveInput&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(FromDeriveInput)]</span></span><br><span class="line"><span class="meta">#[darling(attributes(my_attr))]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyInputReceiver</span> &#123;</span><br><span class="line">    ident: syn::Ident,</span><br><span class="line">    data: darling::ast::Data&lt;(), MyFieldReceiver&gt;,</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[darling(default)]</span></span><br><span class="line">    rename: <span class="type">Option</span>&lt;<span class="type">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(FromField)]</span></span><br><span class="line"><span class="meta">#[darling(attributes(my_attr))]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyFieldReceiver</span> &#123;</span><br><span class="line">    ident: <span class="type">Option</span>&lt;syn::Ident&gt;,</span><br><span class="line">    ty: syn::Type,</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[darling(default)]</span></span><br><span class="line">    skip: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_derive(MyDerive, attributes(my_attr))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">my_derive</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = parse_macro_input!(input <span class="keyword">as</span> DeriveInput);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">receiver</span> = MyInputReceiver::<span class="title function_ invoke__">from_derive_input</span>(&amp;input).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 现在可以直接访问解析后的属性</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = &amp;receiver.ident;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">rename</span> = receiver.rename.<span class="title function_ invoke__">as_ref</span>().<span class="title function_ invoke__">map</span>(|r| quote! &#123; #r &#125;).<span class="title function_ invoke__">unwrap_or</span>(quote! &#123; <span class="built_in">stringify!</span>(#name) &#125;);</span><br><span class="line">  </span><br><span class="line">    quote! &#123;</span><br><span class="line">        <span class="keyword">impl</span> <span class="title class_">Named</span> <span class="keyword">for</span> #name &#123;</span><br><span class="line">            <span class="keyword">fn</span> <span class="title function_">name</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span> &#123;</span><br><span class="line">                #rename</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="速查表-2"><a href="#速查表-2" class="headerlink" title="速查表"></a>速查表</h2><h3 id="声明宏元变量"><a href="#声明宏元变量" class="headerlink" title="声明宏元变量"></a>声明宏元变量</h3><table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>expr</code></td>
<td>表达式</td>
<td><code>1 + 2</code>, <code>foo()</code></td>
</tr>
<tr>
<td><code>ident</code></td>
<td>标识符</td>
<td><code>foo</code>, <code>x</code></td>
</tr>
<tr>
<td><code>ty</code></td>
<td>类型</td>
<td><code>i32</code>, <code>Vec&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>pat</code></td>
<td>模式</td>
<td><code>Some(x)</code>, <code>_</code></td>
</tr>
<tr>
<td><code>stmt</code></td>
<td>语句</td>
<td><code>let x = 1;</code></td>
</tr>
<tr>
<td><code>block</code></td>
<td>代码块</td>
<td><code>&#123; ... &#125;</code></td>
</tr>
<tr>
<td><code>item</code></td>
<td>项</td>
<td><code>fn foo() &#123;&#125;</code></td>
</tr>
<tr>
<td><code>path</code></td>
<td>路径</td>
<td><code>std::io::Result</code></td>
</tr>
<tr>
<td><code>tt</code></td>
<td>Token Tree</td>
<td>任何单个 token</td>
</tr>
<tr>
<td><code>literal</code></td>
<td>字面量</td>
<td><code>&quot;hello&quot;</code>, <code>42</code></td>
</tr>
<tr>
<td><code>lifetime</code></td>
<td>生命周期</td>
<td><code>&#39;a</code></td>
</tr>
<tr>
<td><code>meta</code></td>
<td>属性元数据</td>
<td><code>derive(Debug)</code></td>
</tr>
<tr>
<td><code>vis</code></td>
<td>可见性</td>
<td><code>pub</code>, <code>pub(crate)</code></td>
</tr>
</tbody></table>
<h3 id="重复符号"><a href="#重复符号" class="headerlink" title="重复符号"></a>重复符号</h3><table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>$(...)*</code></td>
<td>零次或多次</td>
</tr>
<tr>
<td><code>$(...)+</code></td>
<td>一次或多次</td>
</tr>
<tr>
<td><code>$(...)?</code></td>
<td>零次或一次</td>
</tr>
</tbody></table>
<h3 id="过程宏类型"><a href="#过程宏类型" class="headerlink" title="过程宏类型"></a>过程宏类型</h3><table>
<thead>
<tr>
<th>类型</th>
<th>属性</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>函数式</td>
<td><code>#[proc_macro]</code></td>
<td>自定义语法</td>
</tr>
<tr>
<td>Derive</td>
<td><code>#[proc_macro_derive]</code></td>
<td>自动实现 trait</td>
</tr>
<tr>
<td>属性</td>
<td><code>#[proc_macro_attribute]</code></td>
<td>修改&#x2F;增强代码</td>
</tr>
</tbody></table>
<h1 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h1><h2 id="测试体系概览"><a href="#测试体系概览" class="headerlink" title="测试体系概览"></a>测试体系概览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Rust 测试金字塔                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│                         ┌─────────┐                                 │</span><br><span class="line">│                         │  E2E    │  ← 端到端测试（最少）            │</span><br><span class="line">│                       ┌─┴─────────┴─┐                               │</span><br><span class="line">│                       │  集成测试    │  ← tests/ 目录               │</span><br><span class="line">│                     ┌─┴─────────────┴─┐                             │</span><br><span class="line">│                     │    单元测试      │  ← #[cfg(test)] mod tests  │</span><br><span class="line">│                   ┌─┴─────────────────┴─┐                           │</span><br><span class="line">│                   │      文档测试        │  ← /// ``` 代码块         │</span><br><span class="line">│                   └─────────────────────┘                           │</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  项目结构                                                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  my_project/                                                        │</span><br><span class="line">│  ├── Cargo.toml                                                     │</span><br><span class="line">│  ├── src/                                                           │</span><br><span class="line">│  │   ├── lib.rs          ← 单元测试 + 文档测试                       │</span><br><span class="line">│  │   └── main.rs                                                    │</span><br><span class="line">│  ├── tests/              ← 集成测试                                  │</span><br><span class="line">│  │   ├── integration_test.rs                                        │</span><br><span class="line">│  │   └── common/mod.rs   ← 测试辅助模块                              │</span><br><span class="line">│  └── benches/            ← 基准测试                                  │</span><br><span class="line">│      └── benchmark.rs                                               │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="单元测试基础"><a href="#单元测试基础" class="headerlink" title="单元测试基础"></a>单元测试基础</h2><h3 id="基本语法-5"><a href="#基本语法-5" class="headerlink" title="基本语法"></a>基本语法</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 加法函数</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 除法函数，除数为零时返回 None</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">f64</span>, b: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0.0</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(a / b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============ 测试模块 ============</span></span><br><span class="line"><span class="meta">#[cfg(test)]</span>  <span class="comment">// 仅在 cargo test 时编译</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;  <span class="comment">// 导入父模块所有内容</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(<span class="number">2</span>, <span class="number">3</span>), <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add_negative</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(-<span class="number">1</span>, -<span class="number">1</span>), -<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">10.0</span>, <span class="number">2.0</span>), <span class="title function_ invoke__">Some</span>(<span class="number">5.0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide_by_zero</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">10.0</span>, <span class="number">0.0</span>), <span class="literal">None</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="断言宏"><a href="#断言宏" class="headerlink" title="断言宏"></a>断言宏</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_assertions</span>() &#123;</span><br><span class="line">        <span class="comment">// ============ 基本断言 ============</span></span><br><span class="line">        <span class="built_in">assert!</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">assert!</span>(<span class="number">1</span> + <span class="number">1</span> == <span class="number">2</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 相等性断言 ============</span></span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="number">4</span>, <span class="number">2</span> + <span class="number">2</span>);           <span class="comment">// 相等</span></span><br><span class="line">        <span class="built_in">assert_ne!</span>(<span class="number">4</span>, <span class="number">2</span> + <span class="number">1</span>);           <span class="comment">// 不相等</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 带自定义消息 ============</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">        <span class="built_in">assert!</span>(x &gt; <span class="number">0</span>, <span class="string">&quot;x should be positive, but got &#123;&#125;&quot;</span>, x);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(x, <span class="number">5</span>, <span class="string">&quot;Expected 5, got &#123;&#125;&quot;</span>, x);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 浮点数比较（注意精度问题）============</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">a</span> = <span class="number">0.1</span> + <span class="number">0.2</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">b</span> = <span class="number">0.3</span>;</span><br><span class="line">        <span class="comment">// assert_eq!(a, b);  // ❌ 可能失败</span></span><br><span class="line">        <span class="built_in">assert!</span>((a - b).<span class="title function_ invoke__">abs</span>() &lt; <span class="type">f64</span>::EPSILON);  <span class="comment">// ✅ 正确方式</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// ============ 使用 approx crate ============</span></span><br><span class="line">        <span class="comment">// assert_relative_eq!(a, b, epsilon = 1e-10);</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ debug_assert! 系列（仅 debug 模式）============</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_debug_assertions</span>() &#123;</span><br><span class="line">        <span class="built_in">debug_assert!</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">debug_assert_eq!</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">debug_assert_ne!</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="测试属性"><a href="#测试属性" class="headerlink" title="测试属性"></a>测试属性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="comment">// ============ 预期 panic ============</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_panic</span>() &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;This test should panic&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 指定 panic 消息</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[should_panic(expected = <span class="string">&quot;divide by zero&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_panic_message</span>() &#123;</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;divide by zero error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 忽略测试 ============</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[ignore]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">expensive_test</span>() &#123;</span><br><span class="line">        <span class="comment">// 耗时测试，默认跳过</span></span><br><span class="line">        std::thread::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 带原因的忽略</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[ignore = <span class="string">&quot;需要外部服务&quot;</span>]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_external_service</span>() &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 返回 Result ============</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_with_result</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="number">2</span> + <span class="number">2</span> == <span class="number">4</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(<span class="string">&quot;math is broken&quot;</span>.<span class="title function_ invoke__">to_string</span>())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用 ? 操作符</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_with_question_mark</span>() <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">Box</span>&lt;<span class="keyword">dyn</span> std::error::Error&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">value</span>: <span class="type">i32</span> = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>()?;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(value, <span class="number">42</span>);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="测试私有函数"><a href="#测试私有函数" class="headerlink" title="测试私有函数"></a>测试私有函数</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">internal_add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">public_add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">internal_add</span>(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ✅ 可以测试私有函数</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_internal_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">internal_add</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h2><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests/integration_test.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为外部 crate 使用，只能访问 pub 接口</span></span><br><span class="line"><span class="keyword">use</span> my_project::&#123;add, divide&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_add_integration</span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(<span class="number">10</span>, <span class="number">20</span>), <span class="number">30</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_divide_integration</span>() &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">divide</span>(<span class="number">100.0</span>, <span class="number">4.0</span>), <span class="title function_ invoke__">Some</span>(<span class="number">25.0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以有多个测试文件</span></span><br><span class="line"><span class="comment">// tests/another_test.rs</span></span><br><span class="line"><span class="comment">// tests/feature_a_test.rs</span></span><br></pre></td></tr></table></figure></div>

<h3 id="共享测试辅助代码"><a href="#共享测试辅助代码" class="headerlink" title="共享测试辅助代码"></a>共享测试辅助代码</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests/common/mod.rs（不会被当作测试文件）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TestContext</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> temp_dir: std::path::PathBuf,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">TestContext</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">temp_dir</span> = std::env::<span class="title function_ invoke__">temp_dir</span>().<span class="title function_ invoke__">join</span>(<span class="built_in">format!</span>(<span class="string">&quot;test_&#123;&#125;&quot;</span>, rand::random::&lt;<span class="type">u32</span>&gt;()));</span><br><span class="line">        std::fs::<span class="title function_ invoke__">create_dir_all</span>(&amp;temp_dir).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        TestContext &#123; temp_dir &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_file</span>(&amp;<span class="keyword">self</span>, name: &amp;<span class="type">str</span>, content: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> std::path::PathBuf &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">path</span> = <span class="keyword">self</span>.temp_dir.<span class="title function_ invoke__">join</span>(name);</span><br><span class="line">        std::fs::<span class="title function_ invoke__">write</span>(&amp;path, content).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        path</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">TestContext</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = std::fs::<span class="title function_ invoke__">remove_dir_all</span>(&amp;<span class="keyword">self</span>.temp_dir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">setup</span>() &#123;</span><br><span class="line">    <span class="comment">// 初始化日志等</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tests/file_test.rs</span></span><br><span class="line"><span class="keyword">mod</span> common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> common::TestContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_file_operations</span>() &#123;</span><br><span class="line">    common::<span class="title function_ invoke__">setup</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ctx</span> = TestContext::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">file</span> = ctx.<span class="title function_ invoke__">create_file</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">assert!</span>(file.<span class="title function_ invoke__">exists</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="子目录组织"><a href="#子目录组织" class="headerlink" title="子目录组织"></a>子目录组织</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tests/</span><br><span class="line">├── api/</span><br><span class="line">│   ├── mod.rs           ← 声明子模块</span><br><span class="line">│   ├── users_test.rs</span><br><span class="line">│   └── orders_test.rs</span><br><span class="line">├── common/</span><br><span class="line">│   └── mod.rs</span><br><span class="line">└── api_tests.rs         ← 入口文件</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests/api_tests.rs</span></span><br><span class="line"><span class="keyword">mod</span> common;</span><br><span class="line"><span class="keyword">mod</span> api;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tests/api/mod.rs</span></span><br><span class="line"><span class="keyword">mod</span> users_test;</span><br><span class="line"><span class="keyword">mod</span> orders_test;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tests/api/users_test.rs</span></span><br><span class="line"><span class="keyword">use</span> crate::common::TestContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_create_user</span>() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="文档测试"><a href="#文档测试" class="headerlink" title="文档测试"></a>文档测试</h2><h3 id="基本文档测试-1"><a href="#基本文档测试-1" class="headerlink" title="基本文档测试"></a>基本文档测试</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 计算两个数的和</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// use my_project::add;</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// let result = add(2, 3);</span></span><br><span class="line"><span class="comment">/// assert_eq!(result, 5);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 安全除法</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// use my_project::divide;</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// // 正常情况</span></span><br><span class="line"><span class="comment">/// assert_eq!(divide(10.0, 2.0), Some(5.0));</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// // 除以零</span></span><br><span class="line"><span class="comment">/// assert_eq!(divide(10.0, 0.0), None);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Panics</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 此函数不会 panic。</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">divide</span>(a: <span class="type">f64</span>, b: <span class="type">f64</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">f64</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0.0</span> &#123; <span class="literal">None</span> &#125; <span class="keyword">else</span> &#123; <span class="title function_ invoke__">Some</span>(a / b) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="文档测试属性"><a href="#文档测试属性" class="headerlink" title="文档测试属性"></a>文档测试属性</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 示例函数</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 基本用法：</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// assert_eq!(2 + 2, 4);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 隐藏设置代码（不显示在文档中）：</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// # fn setup() -&gt; i32 &#123; 42 &#125;</span></span><br><span class="line"><span class="comment">/// # let value = setup();</span></span><br><span class="line"><span class="comment">/// assert_eq!(value, 42);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 标记为应该 panic：</span></span><br><span class="line"><span class="comment">/// ```should_panic</span></span><br><span class="line"><span class="comment">/// panic!(&quot;This panics!&quot;);</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 编译但不运行：</span></span><br><span class="line"><span class="comment">/// ```no_run</span></span><br><span class="line"><span class="comment">/// loop &#123;</span></span><br><span class="line"><span class="comment">///     // 无限循环</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 忽略此代码块：</span></span><br><span class="line"><span class="comment">/// ```ignore</span></span><br><span class="line"><span class="comment">/// 这不是有效的 Rust 代码</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 标记为编译失败：</span></span><br><span class="line"><span class="comment">/// ```compile_fail</span></span><br><span class="line"><span class="comment">/// let x: i32 = &quot;hello&quot;;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 指定 Rust 版本：</span></span><br><span class="line"><span class="comment">/// ```edition2021</span></span><br><span class="line"><span class="comment">/// // Rust 2021 特性</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">example</span>() &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="文档测试中使用-操作符"><a href="#文档测试中使用-操作符" class="headerlink" title="文档测试中使用 ? 操作符"></a>文档测试中使用 ? 操作符</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 解析配置</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// # Examples</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// use std::error::Error;</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; &#123;</span></span><br><span class="line"><span class="comment">///     let config = my_project::parse_config(&quot;key=value&quot;)?;</span></span><br><span class="line"><span class="comment">///     assert_eq!(config.get(&quot;key&quot;), Some(&amp;&quot;value&quot;.to_string()));</span></span><br><span class="line"><span class="comment">///     Ok(())</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// 或者更简洁：</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="comment">/// # fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; &#123;</span></span><br><span class="line"><span class="comment">/// let config = my_project::parse_config(&quot;key=value&quot;)?;</span></span><br><span class="line"><span class="comment">/// assert_eq!(config.get(&quot;key&quot;), Some(&amp;&quot;value&quot;.to_string()));</span></span><br><span class="line"><span class="comment">/// # Ok(())</span></span><br><span class="line"><span class="comment">/// # &#125;</span></span><br><span class="line"><span class="comment">/// ```</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">parse_config</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;std::collections::HashMap&lt;<span class="type">String</span>, <span class="type">String</span>&gt;, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(std::collections::HashMap::<span class="title function_ invoke__">new</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><h3 id="cargo-test-命令"><a href="#cargo-test-命令" class="headerlink" title="cargo test 命令"></a>cargo test 命令</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行所有测试</span></span><br><span class="line">cargo <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定测试</span></span><br><span class="line">cargo <span class="built_in">test</span> test_name</span><br><span class="line">cargo <span class="built_in">test</span> test_add          <span class="comment"># 匹配名称包含 &quot;test_add&quot; 的测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定模块的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> tests::            <span class="comment"># 运行 tests 模块下的所有测试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定测试文件</span></span><br><span class="line">cargo <span class="built_in">test</span> --<span class="built_in">test</span> integration_test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行文档测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --doc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只运行单元测试（不运行集成测试和文档测试）</span></span><br><span class="line">cargo <span class="built_in">test</span> --lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行被忽略的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --ignored</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行所有测试（包括忽略的）</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --include-ignored</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示测试输出（默认隐藏成功测试的 println!）</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --nocapture</span><br><span class="line"></span><br><span class="line"><span class="comment"># 单线程运行（避免并发问题）</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --test-threads=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示测试列表</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只编译不运行</span></span><br><span class="line">cargo <span class="built_in">test</span> --no-run</span><br><span class="line"></span><br><span class="line"><span class="comment"># Release 模式测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示更多信息</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --show-output</span><br></pre></td></tr></table></figure></div>

<h3 id="测试过滤"><a href="#测试过滤" class="headerlink" title="测试过滤"></a>测试过滤</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_feature_a_basic</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_feature_a_advanced</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_feature_b_basic</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="meta">#[ignore]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_slow</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行包含 &quot;feature_a&quot; 的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> feature_a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行精确匹配的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --exact test_feature_a_basic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除某些测试</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --skip feature_b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 组合过滤</span></span><br><span class="line">cargo <span class="built_in">test</span> feature_a -- --skip advanced</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h2><h3 id="使用-tokio"><a href="#使用-tokio" class="headerlink" title="使用 tokio"></a>使用 tokio</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>, <span class="string">&quot;test-util&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 tokio::test 宏</span></span><br><span class="line"><span class="meta">#[tokio::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_async_function</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">async_add</span>(<span class="number">1</span>, <span class="number">2</span>).<span class="keyword">await</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">async_add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    tokio::time::<span class="title function_ invoke__">sleep</span>(std::time::Duration::<span class="title function_ invoke__">from_millis</span>(<span class="number">10</span>)).<span class="keyword">await</span>;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置运行时</span></span><br><span class="line"><span class="meta">#[tokio::test(flavor = <span class="string">&quot;multi_thread&quot;</span>, worker_threads = 2)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_multi_thread</span>() &#123;</span><br><span class="line">    <span class="comment">// 多线程运行时</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::test(flavor = <span class="string">&quot;current_thread&quot;</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_single_thread</span>() &#123;</span><br><span class="line">    <span class="comment">// 单线程运行时</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带超时</span></span><br><span class="line"><span class="meta">#[tokio::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_with_timeout</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = tokio::time::<span class="title function_ invoke__">timeout</span>(</span><br><span class="line">        std::time::Duration::<span class="title function_ invoke__">from_secs</span>(<span class="number">5</span>),</span><br><span class="line">        <span class="title function_ invoke__">async_operation</span>()</span><br><span class="line">    ).<span class="keyword">await</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">assert!</span>(result.<span class="title function_ invoke__">is_ok</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">async_operation</span>() <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="number">42</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-async-std"><a href="#使用-async-std" class="headerlink" title="使用 async-std"></a>使用 async-std</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">async-std</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;attributes&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[async_std::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_with_async_std</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="keyword">async</span> &#123; <span class="number">42</span> &#125;.<span class="keyword">await</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result, <span class="number">42</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="测试异步流"><a href="#测试异步流" class="headerlink" title="测试异步流"></a>测试异步流</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> tokio_stream::StreamExt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[tokio::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_stream</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">stream</span> = tokio_stream::<span class="title function_ invoke__">iter</span>(<span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sum</span>: <span class="type">i32</span> = stream.<span class="title function_ invoke__">fold</span>(<span class="number">0</span>, |acc, x| <span class="keyword">async</span> <span class="keyword">move</span> &#123; acc + x &#125;).<span class="keyword">await</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(sum, <span class="number">15</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="测试组织与模式"><a href="#测试组织与模式" class="headerlink" title="测试组织与模式"></a>测试组织与模式</h2><h3 id="Setup-和-Teardown"><a href="#Setup-和-Teardown" class="headerlink" title="Setup 和 Teardown"></a>Setup 和 Teardown</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> std::sync::Once;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> INIT: Once = Once::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 全局初始化（只执行一次）</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">setup</span>() &#123;</span><br><span class="line">        INIT.<span class="title function_ invoke__">call_once</span>(|| &#123;</span><br><span class="line">            <span class="comment">// 初始化日志、数据库等</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Global setup&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用 Drop 实现 teardown</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">TestGuard</span> &#123;</span><br><span class="line">        name: <span class="type">String</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">TestGuard</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>(name: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Setup: &#123;&#125;&quot;</span>, name);</span><br><span class="line">            TestGuard &#123; name: name.<span class="title function_ invoke__">to_string</span>() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">TestGuard</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Teardown: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_with_guard</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">setup</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_guard</span> = TestGuard::<span class="title function_ invoke__">new</span>(<span class="string">&quot;test_with_guard&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 测试逻辑</span></span><br><span class="line">        <span class="built_in">assert!</span>(<span class="literal">true</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// _guard 在这里自动 drop，执行清理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Test-Fixtures"><a href="#Test-Fixtures" class="headerlink" title="Test Fixtures"></a>Test Fixtures</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">DatabaseFixture</span> &#123;</span><br><span class="line">        connection: <span class="type">String</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">DatabaseFixture</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="comment">// 创建测试数据库连接</span></span><br><span class="line">            DatabaseFixture &#123;</span><br><span class="line">                connection: <span class="string">&quot;test_db&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">insert</span>(&amp;<span class="keyword">self</span>, data: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Inserting: &#123;&#125; into &#123;&#125;&quot;</span>, data, <span class="keyword">self</span>.connection);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">query</span>(&amp;<span class="keyword">self</span>, id: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="built_in">format!</span>(<span class="string">&quot;data_&#123;&#125;&quot;</span>, id))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">DatabaseFixture</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">            <span class="comment">// 清理测试数据</span></span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Cleaning up &#123;&#125;&quot;</span>, <span class="keyword">self</span>.connection);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_database_insert</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">db</span> = DatabaseFixture::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        db.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;test_data&quot;</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = db.<span class="title function_ invoke__">query</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">assert!</span>(result.<span class="title function_ invoke__">is_some</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Builder-模式测试数据"><a href="#Builder-模式测试数据" class="headerlink" title="Builder 模式测试数据"></a>Builder 模式测试数据</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, Clone)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    id: <span class="type">u64</span>,</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    email: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">u8</span>,</span><br><span class="line">    active: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 测试数据构建器</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">UserBuilder</span> &#123;</span><br><span class="line">        id: <span class="type">u64</span>,</span><br><span class="line">        name: <span class="type">String</span>,</span><br><span class="line">        email: <span class="type">String</span>,</span><br><span class="line">        age: <span class="type">u8</span>,</span><br><span class="line">        active: <span class="type">bool</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">UserBuilder</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            UserBuilder &#123;</span><br><span class="line">                id: <span class="number">1</span>,</span><br><span class="line">                name: <span class="string">&quot;Test User&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">                email: <span class="string">&quot;test@example.com&quot;</span>.<span class="title function_ invoke__">to_string</span>(),</span><br><span class="line">                age: <span class="number">25</span>,</span><br><span class="line">                active: <span class="literal">true</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">id</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, id: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.id = id;</span><br><span class="line">            <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">name</span>(<span class="keyword">mut</span> <span class="keyword">self</span>, name: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.name = name.<span class="title function_ invoke__">to_string</span>();</span><br><span class="line">            <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">inactive</span>(<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.active = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">build</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> User &#123;</span><br><span class="line">            User &#123;</span><br><span class="line">                id: <span class="keyword">self</span>.id,</span><br><span class="line">                name: <span class="keyword">self</span>.name,</span><br><span class="line">                email: <span class="keyword">self</span>.email,</span><br><span class="line">                age: <span class="keyword">self</span>.age,</span><br><span class="line">                active: <span class="keyword">self</span>.active,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_user_creation</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">user</span> = UserBuilder::<span class="title function_ invoke__">new</span>()</span><br><span class="line">            .<span class="title function_ invoke__">id</span>(<span class="number">42</span>)</span><br><span class="line">            .<span class="title function_ invoke__">name</span>(<span class="string">&quot;Alice&quot;</span>)</span><br><span class="line">            .<span class="title function_ invoke__">build</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">assert_eq!</span>(user.id, <span class="number">42</span>);</span><br><span class="line">        <span class="built_in">assert_eq!</span>(user.name, <span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">        <span class="built_in">assert!</span>(user.active);  <span class="comment">// 使用默认值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Mocking-和依赖注入"><a href="#Mocking-和依赖注入" class="headerlink" title="Mocking 和依赖注入"></a>Mocking 和依赖注入</h2><h3 id="Trait-抽象和手动-Mock"><a href="#Trait-抽象和手动-Mock" class="headerlink" title="Trait 抽象和手动 Mock"></a>Trait 抽象和手动 Mock</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 trait 接口</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">Database</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>, key: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: &amp;<span class="type">str</span>, value: &amp;<span class="type">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际实现</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RealDatabase</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Database</span> <span class="keyword">for</span> <span class="title class_">RealDatabase</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>, key: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// 真实数据库操作</span></span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: &amp;<span class="type">str</span>, value: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">        <span class="comment">// 真实数据库操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 trait 的业务逻辑</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UserService</span>&lt;D: Database&gt; &#123;</span><br><span class="line">    db: D,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;D: Database&gt; UserService&lt;D&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>(db: D) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        UserService &#123; db &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get_user</span>(&amp;<span class="keyword">self</span>, id: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.db.<span class="title function_ invoke__">get</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot;user:&#123;&#125;&quot;</span>, id))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">    <span class="keyword">use</span> std::collections::HashMap;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Mock 实现</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">MockDatabase</span> &#123;</span><br><span class="line">        data: HashMap&lt;<span class="type">String</span>, <span class="type">String</span>&gt;,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">MockDatabase</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            MockDatabase &#123; data: HashMap::<span class="title function_ invoke__">new</span>() &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">with_data</span>(data: HashMap&lt;<span class="type">String</span>, <span class="type">String</span>&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">            MockDatabase &#123; data &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">impl</span> <span class="title class_">Database</span> <span class="keyword">for</span> <span class="title class_">MockDatabase</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>, key: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">            <span class="keyword">self</span>.data.<span class="title function_ invoke__">get</span>(key).<span class="title function_ invoke__">cloned</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">set</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, key: &amp;<span class="type">str</span>, value: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">            <span class="keyword">self</span>.data.<span class="title function_ invoke__">insert</span>(key.<span class="title function_ invoke__">to_string</span>(), value.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_get_user</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = HashMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        data.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;user:1&quot;</span>.<span class="title function_ invoke__">to_string</span>(), <span class="string">&quot;Alice&quot;</span>.<span class="title function_ invoke__">to_string</span>());</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">mock_db</span> = MockDatabase::<span class="title function_ invoke__">with_data</span>(data);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">service</span> = UserService::<span class="title function_ invoke__">new</span>(mock_db);</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">assert_eq!</span>(service.<span class="title function_ invoke__">get_user</span>(<span class="string">&quot;1&quot;</span>), <span class="title function_ invoke__">Some</span>(<span class="string">&quot;Alice&quot;</span>.<span class="title function_ invoke__">to_string</span>()));</span><br><span class="line">        <span class="built_in">assert_eq!</span>(service.<span class="title function_ invoke__">get_user</span>(<span class="string">&quot;2&quot;</span>), <span class="literal">None</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-mockall-crate"><a href="#使用-mockall-crate" class="headerlink" title="使用 mockall crate"></a>使用 mockall crate</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">mockall</span> = <span class="string">&quot;0.12&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> mockall::&#123;automock, predicate::*&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[automock]</span></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">HttpClient</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>, url: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">post</span>(&amp;<span class="keyword">self</span>, url: &amp;<span class="type">str</span>, body: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ApiService</span>&lt;C: HttpClient&gt; &#123;</span><br><span class="line">    client: C,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;C: HttpClient&gt; ApiService&lt;C&gt; &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fetch_user</span>(&amp;<span class="keyword">self</span>, id: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">String</span>, <span class="type">String</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.client.<span class="title function_ invoke__">get</span>(&amp;<span class="built_in">format!</span>(<span class="string">&quot;/users/&#123;&#125;&quot;</span>, id))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_fetch_user</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mock</span> = MockHttpClient::<span class="title function_ invoke__">new</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 设置期望</span></span><br><span class="line">        mock.<span class="title function_ invoke__">expect_get</span>()</span><br><span class="line">            .<span class="title function_ invoke__">with</span>(<span class="title function_ invoke__">eq</span>(<span class="string">&quot;/users/42&quot;</span>))</span><br><span class="line">            .<span class="title function_ invoke__">times</span>(<span class="number">1</span>)</span><br><span class="line">            .<span class="title function_ invoke__">returning</span>(|_| <span class="title function_ invoke__">Ok</span>(<span class="string">r#&quot;&#123;&quot;name&quot;: &quot;Alice&quot;&#125;&quot;#</span>.<span class="title function_ invoke__">to_string</span>()));</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">service</span> = ApiService &#123; client: mock &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = service.<span class="title function_ invoke__">fetch_user</span>(<span class="number">42</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">assert!</span>(result.<span class="title function_ invoke__">is_ok</span>());</span><br><span class="line">        <span class="built_in">assert!</span>(result.<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">contains</span>(<span class="string">&quot;Alice&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_fetch_user_error</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mock</span> = MockHttpClient::<span class="title function_ invoke__">new</span>();</span><br><span class="line">      </span><br><span class="line">        mock.<span class="title function_ invoke__">expect_get</span>()</span><br><span class="line">            .<span class="title function_ invoke__">returning</span>(|_| <span class="title function_ invoke__">Err</span>(<span class="string">&quot;Network error&quot;</span>.<span class="title function_ invoke__">to_string</span>()));</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">let</span> <span class="variable">service</span> = ApiService &#123; client: mock &#125;;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">result</span> = service.<span class="title function_ invoke__">fetch_user</span>(<span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="built_in">assert!</span>(result.<span class="title function_ invoke__">is_err</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-mock-derive"><a href="#使用-mock-derive" class="headerlink" title="使用 mock_derive"></a>使用 mock_derive</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> mockall::mock;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为现有结构体创建 mock</span></span><br><span class="line">mock! &#123;</span><br><span class="line">    <span class="keyword">pub</span> Database &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">connect</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">query</span>(&amp;<span class="keyword">self</span>, sql: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">String</span>&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_with_mock_database</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">mock</span> = MockDatabase::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    mock.<span class="title function_ invoke__">expect_connect</span>()</span><br><span class="line">        .<span class="title function_ invoke__">returning</span>(|| <span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">    mock.<span class="title function_ invoke__">expect_query</span>()</span><br><span class="line">        .<span class="title function_ invoke__">with</span>(mockall::predicate::<span class="type">str</span>::<span class="title function_ invoke__">starts_with</span>(<span class="string">&quot;SELECT&quot;</span>))</span><br><span class="line">        .<span class="title function_ invoke__">returning</span>(|_| <span class="built_in">vec!</span>[<span class="string">&quot;row1&quot;</span>.<span class="title function_ invoke__">to_string</span>(), <span class="string">&quot;row2&quot;</span>.<span class="title function_ invoke__">to_string</span>()]);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">assert!</span>(mock.<span class="title function_ invoke__">connect</span>());</span><br><span class="line">    <span class="built_in">assert_eq!</span>(mock.<span class="title function_ invoke__">query</span>(<span class="string">&quot;SELECT * FROM users&quot;</span>).<span class="title function_ invoke__">len</span>(), <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="参数化测试"><a href="#参数化测试" class="headerlink" title="参数化测试"></a>参数化测试</h2><h3 id="使用-test-case-crate"><a href="#使用-test-case-crate" class="headerlink" title="使用 test-case crate"></a>使用 test-case crate</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">test-case</span> = <span class="string">&quot;3&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> test_case::test_case;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test_case(1, 1, 2; <span class="string">&quot;one plus one&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[test_case(2, 2, 4; <span class="string">&quot;two plus two&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[test_case(-1, 1, 0; <span class="string">&quot;negative plus positive&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[test_case(0, 0, 0; <span class="string">&quot;zeros&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>, expected: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(a, b), expected);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更复杂的示例</span></span><br><span class="line"><span class="meta">#[test_case(<span class="string">&quot;hello&quot;</span>, 5)]</span></span><br><span class="line"><span class="meta">#[test_case(<span class="string">&quot;&quot;</span>, 0)]</span></span><br><span class="line"><span class="meta">#[test_case(<span class="string">&quot;rust&quot;</span>, 4)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_string_length</span>(input: &amp;<span class="type">str</span>, expected: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(input.<span class="title function_ invoke__">len</span>(), expected);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 =&gt; 指定期望结果</span></span><br><span class="line"><span class="meta">#[test_case(4 =&gt; 2; <span class="string">&quot;sqrt of 4&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[test_case(9 =&gt; 3; <span class="string">&quot;sqrt of 9&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_sqrt</span>(input: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    (input <span class="keyword">as</span> <span class="type">f64</span>).<span class="title function_ invoke__">sqrt</span>() <span class="keyword">as</span> <span class="type">i32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 期望 panic</span></span><br><span class="line"><span class="meta">#[test_case(0 =&gt; panics <span class="string">&quot;divide by zero&quot;</span>)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_divide_panic</span>(divisor: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_</span> = <span class="number">100</span> / divisor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 matches!</span></span><br><span class="line"><span class="meta">#[test_case(<span class="string">&quot;42&quot;</span> =&gt; matches Ok(_))]</span></span><br><span class="line"><span class="meta">#[test_case(<span class="string">&quot;hello&quot;</span> =&gt; matches Err(_))]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_parse</span>(input: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">i32</span>, std::num::ParseIntError&gt; &#123;</span><br><span class="line">    input.<span class="title function_ invoke__">parse</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-rstest-crate"><a href="#使用-rstest-crate" class="headerlink" title="使用 rstest crate"></a>使用 rstest crate</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">rstest</span> = <span class="string">&quot;0.18&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> rstest::rstest;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数化测试</span></span><br><span class="line"><span class="meta">#[rstest]</span></span><br><span class="line"><span class="meta">#[case(1, 1, 2)]</span></span><br><span class="line"><span class="meta">#[case(2, 2, 4)]</span></span><br><span class="line"><span class="meta">#[case(0, 0, 0)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_add</span>(<span class="meta">#[case]</span> a: <span class="type">i32</span>, <span class="meta">#[case]</span> b: <span class="type">i32</span>, <span class="meta">#[case]</span> expected: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(a + b, expected);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fixtures</span></span><br><span class="line"><span class="meta">#[rstest]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_with_fixture</span>(<span class="meta">#[values(1, 2, 3)]</span> x: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="built_in">assert!</span>(x &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合测试</span></span><br><span class="line"><span class="meta">#[rstest]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_combinations</span>(</span><br><span class="line">    <span class="meta">#[values(1, 2)]</span> a: <span class="type">i32</span>,</span><br><span class="line">    <span class="meta">#[values(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;y&quot;</span>)]</span> b: &amp;<span class="type">str</span></span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">// 运行 2 * 2 = 4 个测试用例</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;a=&#123;&#125;, b=&#123;&#125;&quot;</span>, a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fixture 函数</span></span><br><span class="line"><span class="meta">#[rstest::fixture]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">database</span>() <span class="punctuation">-&gt;</span> MockDatabase &#123;</span><br><span class="line">    MockDatabase::<span class="title function_ invoke__">new</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[rstest]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_with_db_fixture</span>(database: MockDatabase) &#123;</span><br><span class="line">    <span class="comment">// 使用 fixture</span></span><br><span class="line">    <span class="built_in">assert!</span>(database.<span class="title function_ invoke__">is_connected</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步测试</span></span><br><span class="line"><span class="meta">#[rstest]</span></span><br><span class="line"><span class="meta">#[tokio::test]</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">fn</span> <span class="title function_">test_async_with_params</span>(<span class="meta">#[values(1, 2, 3)]</span> x: <span class="type">i32</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="keyword">async</span> &#123; x * <span class="number">2</span> &#125;.<span class="keyword">await</span>;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(result, x * <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="手动参数化"><a href="#手动参数化" class="headerlink" title="手动参数化"></a>手动参数化</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line">        input: <span class="type">i32</span>,</span><br><span class="line">        expected: <span class="type">i32</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_double</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">cases</span> = <span class="built_in">vec!</span>[</span><br><span class="line">            TestCase &#123; input: <span class="number">1</span>, expected: <span class="number">2</span> &#125;,</span><br><span class="line">            TestCase &#123; input: <span class="number">2</span>, expected: <span class="number">4</span> &#125;,</span><br><span class="line">            TestCase &#123; input: -<span class="number">1</span>, expected: -<span class="number">2</span> &#125;,</span><br><span class="line">            TestCase &#123; input: <span class="number">0</span>, expected: <span class="number">0</span> &#125;,</span><br><span class="line">        ];</span><br><span class="line">      </span><br><span class="line">        <span class="title function_ invoke__">for</span> (i, case) <span class="keyword">in</span> cases.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">result</span> = case.input * <span class="number">2</span>;</span><br><span class="line">            <span class="built_in">assert_eq!</span>(</span><br><span class="line">                result, case.expected,</span><br><span class="line">                <span class="string">&quot;Case &#123;&#125; failed: &#123;&#125; * 2 = &#123;&#125;, expected &#123;&#125;&quot;</span>,</span><br><span class="line">                i, case.input, result, case.expected</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="属性测试-Property-Based-Testing"><a href="#属性测试-Property-Based-Testing" class="headerlink" title="属性测试 (Property-Based Testing)"></a>属性测试 (Property-Based Testing)</h2><h3 id="使用-proptest"><a href="#使用-proptest" class="headerlink" title="使用 proptest"></a>使用 proptest</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">proptest</span> = <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> proptest::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本属性测试</span></span><br><span class="line">proptest! &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add_commutative</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) &#123;</span><br><span class="line">        <span class="comment">// 加法交换律</span></span><br><span class="line">        prop_assert_eq!(a.<span class="title function_ invoke__">wrapping_add</span>(b), b.<span class="title function_ invoke__">wrapping_add</span>(a));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_string_reverse_reverse</span>(s: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="comment">// 反转两次等于原始</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">reversed</span>: <span class="type">String</span> = s.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">rev</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">double_reversed</span>: <span class="type">String</span> = reversed.<span class="title function_ invoke__">chars</span>().<span class="title function_ invoke__">rev</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">        prop_assert_eq!(s, double_reversed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义生成策略</span></span><br><span class="line">proptest! &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_vec_sort</span>(<span class="keyword">mut</span> v: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) &#123;</span><br><span class="line">        v.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 排序后相邻元素有序</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">window</span> <span class="keyword">in</span> v.<span class="title function_ invoke__">windows</span>(<span class="number">2</span>) &#123;</span><br><span class="line">            prop_assert!(window[<span class="number">0</span>] &lt;= window[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 限制输入范围</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_percentage</span>(n <span class="keyword">in</span> <span class="number">0</span>..=<span class="number">100i32</span>) &#123;</span><br><span class="line">        prop_assert!(n &gt;= <span class="number">0</span> &amp;&amp; n &lt;= <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 自定义字符串策略</span></span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_email_like</span>(</span><br><span class="line">        local <span class="keyword">in</span> <span class="string">&quot;[a-z]&#123;1,10&#125;&quot;</span>,</span><br><span class="line">        domain <span class="keyword">in</span> <span class="string">&quot;[a-z]&#123;1,10&#125;&quot;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">email</span> = <span class="built_in">format!</span>(<span class="string">&quot;&#123;&#125;@&#123;&#125;.com&quot;</span>, local, domain);</span><br><span class="line">        prop_assert!(email.<span class="title function_ invoke__">contains</span>(<span class="string">&#x27;@&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂策略</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">user_strategy</span>() <span class="punctuation">-&gt;</span> <span class="keyword">impl</span> <span class="title class_">Strategy</span>&lt;Value = User&gt; &#123;</span><br><span class="line">    (</span><br><span class="line">        <span class="string">&quot;[a-zA-Z]&#123;1,20&#125;&quot;</span>,        <span class="comment">// name</span></span><br><span class="line">        <span class="string">&quot;[a-z]+@[a-z]+\\.[a-z]+&quot;</span>, <span class="comment">// email</span></span><br><span class="line">        <span class="number">18</span>..<span class="number">100u8</span>,               <span class="comment">// age</span></span><br><span class="line">    ).<span class="title function_ invoke__">prop_map</span>(|(name, email, age)| User &#123; name, email, age &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proptest! &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_user_serialization</span>(user <span class="keyword">in</span> <span class="title function_ invoke__">user_strategy</span>()) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">json</span> = serde_json::<span class="title function_ invoke__">to_string</span>(&amp;user).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">deserialized</span>: User = serde_json::<span class="title function_ invoke__">from_str</span>(&amp;json).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        prop_assert_eq!(user, deserialized);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-quickcheck"><a href="#使用-quickcheck" class="headerlink" title="使用 quickcheck"></a>使用 quickcheck</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">quickcheck</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="attr">quickcheck_macros</span> = <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> quickcheck_macros::quickcheck;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[quickcheck]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_reverse_reverse</span>(xs: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reversed</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = xs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">rev</span>().<span class="title function_ invoke__">cloned</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">double_reversed</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; = reversed.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">rev</span>().<span class="title function_ invoke__">cloned</span>().<span class="title function_ invoke__">collect</span>();</span><br><span class="line">    xs == double_reversed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[quickcheck]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_sort_length</span>(<span class="keyword">mut</span> xs: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">original_len</span> = xs.<span class="title function_ invoke__">len</span>();</span><br><span class="line">    xs.<span class="title function_ invoke__">sort</span>();</span><br><span class="line">    xs.<span class="title function_ invoke__">len</span>() == original_len</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="模糊测试-Fuzzing"><a href="#模糊测试-Fuzzing" class="headerlink" title="模糊测试 (Fuzzing)"></a>模糊测试 (Fuzzing)</h2><h3 id="使用-cargo-fuzz"><a href="#使用-cargo-fuzz" class="headerlink" title="使用 cargo-fuzz"></a>使用 cargo-fuzz</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">cargo install cargo-fuzz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">cargo fuzz init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 fuzz target</span></span><br><span class="line">cargo fuzz add my_target</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fuzz/fuzz_targets/my_target.rs</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> libfuzzer_sys::fuzz_target;</span><br><span class="line"><span class="keyword">use</span> my_project::parse_input;</span><br><span class="line"></span><br><span class="line">fuzz_target!(|data: &amp;[<span class="type">u8</span>]| &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(s) = std::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8</span>(data) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = <span class="title function_ invoke__">parse_input</span>(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行 fuzzing</span></span><br><span class="line">cargo +nightly fuzz run my_target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 限制时间</span></span><br><span class="line">cargo +nightly fuzz run my_target -- -max_total_time=60</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-arbitrary"><a href="#使用-arbitrary" class="headerlink" title="使用 arbitrary"></a>使用 arbitrary</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">arbitrary</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> arbitrary::&#123;Arbitrary, Unstructured&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Arbitrary)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyInput</span> &#123;</span><br><span class="line">    name: <span class="type">String</span>,</span><br><span class="line">    age: <span class="type">u8</span>,</span><br><span class="line">    scores: <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 fuzz target 中使用</span></span><br><span class="line">fuzz_target!(|input: MyInput| &#123;</span><br><span class="line">    <span class="title function_ invoke__">process</span>(input);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h2><h3 id="内置基准测试（nightly）"><a href="#内置基准测试（nightly）" class="headerlink" title="内置基准测试（nightly）"></a>内置基准测试（nightly）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![feature(test)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> test::Bencher;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[bench]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bench_add</span>(b: &amp;<span class="keyword">mut</span> Bencher) &#123;</span><br><span class="line">    b.<span class="title function_ invoke__">iter</span>(|| &#123;</span><br><span class="line">        <span class="comment">// 使用 black_box 防止优化</span></span><br><span class="line">        test::<span class="title function_ invoke__">black_box</span>(<span class="title function_ invoke__">add</span>(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-criterion"><a href="#使用-criterion" class="headerlink" title="使用 criterion"></a>使用 criterion</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">criterion</span> = &#123; version = <span class="string">&quot;0.5&quot;</span>, features = [<span class="string">&quot;html_reports&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[[bench]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_benchmark&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// benches/my_benchmark.rs</span></span><br><span class="line"><span class="keyword">use</span> criterion::&#123;black_box, criterion_group, criterion_main, Criterion, BenchmarkId&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fibonacci</span>(n: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    <span class="keyword">match</span> n &#123;</span><br><span class="line">        <span class="number">0</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        <span class="number">1</span> =&gt; <span class="number">1</span>,</span><br><span class="line">        n =&gt; <span class="title function_ invoke__">fibonacci</span>(n - <span class="number">1</span>) + <span class="title function_ invoke__">fibonacci</span>(n - <span class="number">2</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本基准测试</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bench_fibonacci</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    c.<span class="title function_ invoke__">bench_function</span>(<span class="string">&quot;fib 20&quot;</span>, |b| &#123;</span><br><span class="line">        b.<span class="title function_ invoke__">iter</span>(|| <span class="title function_ invoke__">fibonacci</span>(<span class="title function_ invoke__">black_box</span>(<span class="number">20</span>)))</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数化基准测试</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bench_fibonacci_group</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">group</span> = c.<span class="title function_ invoke__">benchmark_group</span>(<span class="string">&quot;Fibonacci&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> [<span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>].<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        group.<span class="title function_ invoke__">bench_with_input</span>(BenchmarkId::<span class="title function_ invoke__">new</span>(<span class="string">&quot;recursive&quot;</span>, i), i, |b, i| &#123;</span><br><span class="line">            b.<span class="title function_ invoke__">iter</span>(|| <span class="title function_ invoke__">fibonacci</span>(<span class="title function_ invoke__">black_box</span>(*i)))</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">finish</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 比较不同实现</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">fibonacci_iterative</span>(n: <span class="type">u64</span>) <span class="punctuation">-&gt;</span> <span class="type">u64</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">a</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">b</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..n &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">tmp</span> = a;</span><br><span class="line">        a = b;</span><br><span class="line">        b = tmp + b;</span><br><span class="line">    &#125;</span><br><span class="line">    a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bench_compare</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">group</span> = c.<span class="title function_ invoke__">benchmark_group</span>(<span class="string">&quot;Fibonacci Comparison&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">n</span> = <span class="number">20</span>;</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">bench_function</span>(<span class="string">&quot;recursive&quot;</span>, |b| &#123;</span><br><span class="line">        b.<span class="title function_ invoke__">iter</span>(|| <span class="title function_ invoke__">fibonacci</span>(<span class="title function_ invoke__">black_box</span>(n)))</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">bench_function</span>(<span class="string">&quot;iterative&quot;</span>, |b| &#123;</span><br><span class="line">        b.<span class="title function_ invoke__">iter</span>(|| <span class="title function_ invoke__">fibonacci_iterative</span>(<span class="title function_ invoke__">black_box</span>(n)))</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">finish</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 吞吐量测试</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">bench_throughput</span>(c: &amp;<span class="keyword">mut</span> Criterion) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span>: <span class="type">Vec</span>&lt;<span class="type">u8</span>&gt; = (<span class="number">0</span>..<span class="number">1024</span>).<span class="title function_ invoke__">map</span>(|i| i <span class="keyword">as</span> <span class="type">u8</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">group</span> = c.<span class="title function_ invoke__">benchmark_group</span>(<span class="string">&quot;Throughput&quot;</span>);</span><br><span class="line">    group.<span class="title function_ invoke__">throughput</span>(criterion::Throughput::<span class="title function_ invoke__">Bytes</span>(data.<span class="title function_ invoke__">len</span>() <span class="keyword">as</span> <span class="type">u64</span>));</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">bench_function</span>(<span class="string">&quot;process&quot;</span>, |b| &#123;</span><br><span class="line">        b.<span class="title function_ invoke__">iter</span>(|| &#123;</span><br><span class="line">            <span class="comment">// 处理数据</span></span><br><span class="line">            data.<span class="title function_ invoke__">iter</span>().sum::&lt;<span class="type">u8</span>&gt;()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    group.<span class="title function_ invoke__">finish</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">criterion_group!(</span><br><span class="line">    benches,</span><br><span class="line">    bench_fibonacci,</span><br><span class="line">    bench_fibonacci_group,</span><br><span class="line">    bench_compare,</span><br><span class="line">    bench_throughput</span><br><span class="line">);</span><br><span class="line">criterion_main!(benches);</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行基准测试</span></span><br><span class="line">cargo bench</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定基准</span></span><br><span class="line">cargo bench -- fibonacci</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存基准结果</span></span><br><span class="line">cargo bench -- --save-baseline main</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与基准比较</span></span><br><span class="line">cargo bench -- --baseline main</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="代码覆盖率"><a href="#代码覆盖率" class="headerlink" title="代码覆盖率"></a>代码覆盖率</h2><h3 id="使用-cargo-tarpaulin"><a href="#使用-cargo-tarpaulin" class="headerlink" title="使用 cargo-tarpaulin"></a>使用 cargo-tarpaulin</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">cargo install cargo-tarpaulin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行覆盖率</span></span><br><span class="line">cargo tarpaulin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 HTML 报告</span></span><br><span class="line">cargo tarpaulin --out Html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略测试代码</span></span><br><span class="line">cargo tarpaulin --ignore-tests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定输出格式</span></span><br><span class="line">cargo tarpaulin --out Xml --out Html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置覆盖率阈值</span></span><br><span class="line">cargo tarpaulin --fail-under 80</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-llvm-cov"><a href="#使用-llvm-cov" class="headerlink" title="使用 llvm-cov"></a>使用 llvm-cov</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">cargo install cargo-llvm-cov</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行覆盖率</span></span><br><span class="line">cargo llvm-cov</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 HTML 报告</span></span><br><span class="line">cargo llvm-cov --html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开报告</span></span><br><span class="line">cargo llvm-cov --open</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只显示摘要</span></span><br><span class="line">cargo llvm-cov --summary-only</span><br></pre></td></tr></table></figure></div>

<h3 id="CI-配置示例"><a href="#CI-配置示例" class="headerlink" title="CI 配置示例"></a>CI 配置示例</h3><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/coverage.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Coverage</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">pull_request</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">coverage:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@stable</span></span><br><span class="line">    </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">tarpaulin</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">install</span> <span class="string">cargo-tarpaulin</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">coverage</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">tarpaulin</span> <span class="string">--out</span> <span class="string">Xml</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">to</span> <span class="string">codecov</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">codecov/codecov-action@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">file:</span> <span class="string">cobertura.xml</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="CI-CD-集成"><a href="#CI-CD-集成" class="headerlink" title="CI&#x2F;CD 集成"></a>CI&#x2F;CD 集成</h2><h3 id="GitHub-Actions-完整配置"><a href="#GitHub-Actions-完整配置" class="headerlink" title="GitHub Actions 完整配置"></a>GitHub Actions 完整配置</h3><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/ci.yml</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">CARGO_TERM_COLOR:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># 格式检查</span></span><br><span class="line">  <span class="attr">fmt:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@stable</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">components:</span> <span class="string">rustfmt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">fmt</span> <span class="string">--all</span> <span class="string">--</span> <span class="string">--check</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Lint 检查</span></span><br><span class="line">  <span class="attr">clippy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@stable</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">components:</span> <span class="string">clippy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">clippy</span> <span class="string">--all-targets</span> <span class="string">--all-features</span> <span class="string">--</span> <span class="string">-D</span> <span class="string">warnings</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 测试</span></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">ubuntu-latest</span>, <span class="string">windows-latest</span>, <span class="string">macos-latest</span>]</span><br><span class="line">        <span class="attr">rust:</span> [<span class="string">stable</span>, <span class="string">beta</span>]</span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@master</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">toolchain:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.rust</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">test</span> <span class="string">--all-features</span> <span class="string">--verbose</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 文档测试</span></span><br><span class="line">  <span class="attr">doc:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@stable</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">doc</span> <span class="string">--no-deps</span> <span class="string">--all-features</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">RUSTDOCFLAGS:</span> <span class="string">-D</span> <span class="string">warnings</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 覆盖率</span></span><br><span class="line">  <span class="attr">coverage:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dtolnay/rust-toolchain@stable</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">taiki-e/install-action@cargo-llvm-cov</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">cargo</span> <span class="string">llvm-cov</span> <span class="string">--all-features</span> <span class="string">--lcov</span> <span class="string">--output-path</span> <span class="string">lcov.info</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">codecov/codecov-action@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">lcov.info</span></span><br><span class="line">          <span class="attr">fail_ci_if_error:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="测试命名规范"><a href="#测试命名规范" class="headerlink" title="测试命名规范"></a>测试命名规范</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="comment">// 格式：test_&lt;功能&gt;_&lt;场景&gt;_&lt;期望结果&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add_positive_numbers_returns_sum</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add_negative_numbers_returns_sum</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_divide_by_zero_returns_none</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_parse_valid_json_returns_ok</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_parse_invalid_json_returns_error</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="测试组织"><a href="#测试组织" class="headerlink" title="测试组织"></a>测试组织</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 按功能分组</span></span><br><span class="line">    <span class="keyword">mod</span> add &#123;</span><br><span class="line">        <span class="keyword">use</span> super::*;</span><br><span class="line">      </span><br><span class="line">        <span class="meta">#[test]</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">positive_numbers</span>() &#123;&#125;</span><br><span class="line">      </span><br><span class="line">        <span class="meta">#[test]</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">negative_numbers</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">mod</span> subtract &#123;</span><br><span class="line">        <span class="keyword">use</span> super::*;</span><br><span class="line">      </span><br><span class="line">        <span class="meta">#[test]</span></span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">positive_numbers</span>() &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 辅助函数</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">create_test_user</span>() <span class="punctuation">-&gt;</span> User &#123;</span><br><span class="line">        User::<span class="title function_ invoke__">new</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test@example.com&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="测试隔离"><a href="#测试隔离" class="headerlink" title="测试隔离"></a>测试隔离</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> std::sync::Mutex;</span><br><span class="line">    <span class="keyword">use</span> once_cell::sync::Lazy;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 需要串行执行的测试使用锁</span></span><br><span class="line">    <span class="keyword">static</span> TEST_MUTEX: Lazy&lt;Mutex&lt;()&gt;&gt; = Lazy::<span class="title function_ invoke__">new</span>(|| Mutex::<span class="title function_ invoke__">new</span>(()));</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_that_modifies_global_state</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_lock</span> = TEST_MUTEX.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="comment">// 测试逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 或者使用 serial_test crate</span></span><br><span class="line">    <span class="comment">// #[serial]</span></span><br><span class="line">    <span class="comment">// fn test_serial() &#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">test_with_good_error_message</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">input</span> = <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">result</span> = <span class="title function_ invoke__">process</span>(&amp;input);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">assert!</span>(</span><br><span class="line">        result.<span class="title function_ invoke__">len</span>() == <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;Expected result length 3, got &#123;&#125;. Input: &#123;:?&#125;, Result: &#123;:?&#125;&quot;</span>,</span><br><span class="line">        result.<span class="title function_ invoke__">len</span>(),</span><br><span class="line">        input,</span><br><span class="line">        result</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="速查表-3"><a href="#速查表-3" class="headerlink" title="速查表"></a>速查表</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cargo <span class="built_in">test</span>                      <span class="comment"># 运行所有测试</span></span><br><span class="line">cargo <span class="built_in">test</span> test_name            <span class="comment"># 运行匹配名称的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --nocapture       <span class="comment"># 显示 println! 输出</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --test-threads=1  <span class="comment"># 单线程运行</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --ignored         <span class="comment"># 运行忽略的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --doc                <span class="comment"># 只运行文档测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --lib                <span class="comment"># 只运行单元测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --<span class="built_in">test</span> name          <span class="comment"># 运行特定集成测试</span></span><br><span class="line">cargo bench                     <span class="comment"># 运行基准测试</span></span><br></pre></td></tr></table></figure></div>

<h3 id="测试属性-1"><a href="#测试属性-1" class="headerlink" title="测试属性"></a>测试属性</h3><table>
<thead>
<tr>
<th>属性</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>#[test]</code></td>
<td>标记测试函数</td>
</tr>
<tr>
<td><code>#[should_panic]</code></td>
<td>期望 panic</td>
</tr>
<tr>
<td><code>#[should_panic(expected = &quot;msg&quot;)]</code></td>
<td>期望特定 panic 消息</td>
</tr>
<tr>
<td><code>#[ignore]</code></td>
<td>跳过测试</td>
</tr>
<tr>
<td><code>#[ignore = &quot;reason&quot;]</code></td>
<td>带原因跳过</td>
</tr>
<tr>
<td><code>#[cfg(test)]</code></td>
<td>仅测试时编译</td>
</tr>
</tbody></table>
<h3 id="断言宏-1"><a href="#断言宏-1" class="headerlink" title="断言宏"></a>断言宏</h3><table>
<thead>
<tr>
<th>宏</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>assert!(expr)</code></td>
<td>断言为真</td>
</tr>
<tr>
<td><code>assert_eq!(a, b)</code></td>
<td>断言相等</td>
</tr>
<tr>
<td><code>assert_ne!(a, b)</code></td>
<td>断言不相等</td>
</tr>
<tr>
<td><code>debug_assert!</code></td>
<td>Debug 模式断言</td>
</tr>
<tr>
<td><code>panic!(&quot;msg&quot;)</code></td>
<td>触发 panic</td>
</tr>
</tbody></table>
<h3 id="常用测试-Crate"><a href="#常用测试-Crate" class="headerlink" title="常用测试 Crate"></a>常用测试 Crate</h3><table>
<thead>
<tr>
<th>Crate</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>mockall</code></td>
<td>Mock 对象</td>
</tr>
<tr>
<td><code>test-case</code></td>
<td>参数化测试</td>
</tr>
<tr>
<td><code>rstest</code></td>
<td>参数化 + Fixtures</td>
</tr>
<tr>
<td><code>proptest</code></td>
<td>属性测试</td>
</tr>
<tr>
<td><code>criterion</code></td>
<td>基准测试</td>
</tr>
<tr>
<td><code>fake</code></td>
<td>假数据生成</td>
</tr>
<tr>
<td><code>wiremock</code></td>
<td>HTTP Mock</td>
</tr>
<tr>
<td><code>tempfile</code></td>
<td>临时文件</td>
</tr>
<tr>
<td><code>serial_test</code></td>
<td>串行测试</td>
</tr>
</tbody></table>
<h1 id="Cargo"><a href="#Cargo" class="headerlink" title="Cargo"></a>Cargo</h1><h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Cargo 功能                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │</span><br><span class="line">│   │  包管理器   │  │  构建系统   │  │  任务运行器  │                │</span><br><span class="line">│   ├─────────────┤  ├─────────────┤  ├─────────────┤                │</span><br><span class="line">│   │ • 依赖解析  │  │ • 编译代码  │  │ • 运行测试  │                │</span><br><span class="line">│   │ • 版本管理  │  │ • 增量构建  │  │ • 运行示例  │                │</span><br><span class="line">│   │ • 发布包    │  │ • 多目标    │  │ • 基准测试  │                │</span><br><span class="line">│   │ • 下载依赖  │  │ • 构建脚本  │  │ • 文档生成  │                │</span><br><span class="line">│   └─────────────┘  └─────────────┘  └─────────────┘                │</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  项目结构                                                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   my_project/                                                       │</span><br><span class="line">│   ├── Cargo.toml          # 项目配置文件                            │</span><br><span class="line">│   ├── Cargo.lock          # 依赖锁定文件（自动生成）                 │</span><br><span class="line">│   ├── src/                                                          │</span><br><span class="line">│   │   ├── lib.rs          # 库入口                                  │</span><br><span class="line">│   │   ├── main.rs         # 二进制入口                              │</span><br><span class="line">│   │   └── bin/            # 多个二进制                              │</span><br><span class="line">│   │       └── other.rs                                              │</span><br><span class="line">│   ├── tests/              # 集成测试                                │</span><br><span class="line">│   ├── benches/            # 基准测试                                │</span><br><span class="line">│   ├── examples/           # 示例代码                                │</span><br><span class="line">│   └── build.rs            # 构建脚本（可选）                        │</span><br><span class="line">│                                                                     │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><h3 id="项目管理"><a href="#项目管理" class="headerlink" title="项目管理"></a>项目管理</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 创建项目 ============</span></span><br><span class="line">cargo new my_project          <span class="comment"># 创建二进制项目</span></span><br><span class="line">cargo new my_lib --lib        <span class="comment"># 创建库项目</span></span><br><span class="line">cargo new my_project --vcs none   <span class="comment"># 不初始化 git</span></span><br><span class="line"></span><br><span class="line">cargo init                    <span class="comment"># 在当前目录初始化</span></span><br><span class="line">cargo init --lib              <span class="comment"># 初始化为库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 构建 ============</span></span><br><span class="line">cargo build                   <span class="comment"># Debug 构建</span></span><br><span class="line">cargo build --release         <span class="comment"># Release 构建</span></span><br><span class="line">cargo build --target x86_64-unknown-linux-gnu  <span class="comment"># 交叉编译</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 运行 ============</span></span><br><span class="line">cargo run                     <span class="comment"># 构建并运行</span></span><br><span class="line">cargo run --release           <span class="comment"># Release 模式运行</span></span><br><span class="line">cargo run --bin my_bin        <span class="comment"># 运行指定二进制</span></span><br><span class="line">cargo run --example my_example <span class="comment"># 运行示例</span></span><br><span class="line">cargo run -- arg1 arg2        <span class="comment"># 传递命令行参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 检查（快速） ============</span></span><br><span class="line">cargo check                   <span class="comment"># 只检查，不生成代码</span></span><br><span class="line">cargo check --all-targets     <span class="comment"># 检查所有目标</span></span><br></pre></td></tr></table></figure></div>

<h3 id="测试和文档"><a href="#测试和文档" class="headerlink" title="测试和文档"></a>测试和文档</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 测试 ============</span></span><br><span class="line">cargo <span class="built_in">test</span>                    <span class="comment"># 运行所有测试</span></span><br><span class="line">cargo <span class="built_in">test</span> test_name          <span class="comment"># 运行匹配的测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --lib              <span class="comment"># 只测试库</span></span><br><span class="line">cargo <span class="built_in">test</span> --doc              <span class="comment"># 只运行文档测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --<span class="built_in">test</span> integration <span class="comment"># 运行特定集成测试</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --nocapture     <span class="comment"># 显示 println 输出</span></span><br><span class="line">cargo <span class="built_in">test</span> -- --test-threads=1 <span class="comment"># 单线程</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 文档 ============</span></span><br><span class="line">cargo doc                     <span class="comment"># 生成文档</span></span><br><span class="line">cargo doc --open              <span class="comment"># 生成并打开</span></span><br><span class="line">cargo doc --no-deps           <span class="comment"># 不包含依赖的文档</span></span><br><span class="line">cargo doc --document-private-items <span class="comment"># 包含私有项</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 基准测试 ============</span></span><br><span class="line">cargo bench                   <span class="comment"># 运行基准测试（nightly）</span></span><br><span class="line">cargo bench --bench my_bench  <span class="comment"># 运行特定基准</span></span><br></pre></td></tr></table></figure></div>

<h3 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 依赖操作 ============</span></span><br><span class="line">cargo add serde               <span class="comment"># 添加依赖</span></span><br><span class="line">cargo add serde --features derive  <span class="comment"># 添加带 feature</span></span><br><span class="line">cargo add tokio@1.0           <span class="comment"># 指定版本</span></span><br><span class="line">cargo add --dev pretty_assertions  <span class="comment"># 添加开发依赖</span></span><br><span class="line">cargo add --build cc          <span class="comment"># 添加构建依赖</span></span><br><span class="line"></span><br><span class="line">cargo remove serde            <span class="comment"># 移除依赖</span></span><br><span class="line"></span><br><span class="line">cargo update                  <span class="comment"># 更新所有依赖</span></span><br><span class="line">cargo update -p serde         <span class="comment"># 更新特定依赖</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 依赖信息 ============</span></span><br><span class="line">cargo tree                    <span class="comment"># 依赖树</span></span><br><span class="line">cargo tree -d                 <span class="comment"># 只显示重复依赖</span></span><br><span class="line">cargo tree -i serde           <span class="comment"># 显示谁依赖 serde</span></span><br><span class="line">cargo tree --format <span class="string">&quot;&#123;p&#125; &#123;f&#125;&quot;</span> <span class="comment"># 自定义格式</span></span><br><span class="line"></span><br><span class="line">cargo search serde            <span class="comment"># 搜索 crate</span></span><br><span class="line">cargo info serde              <span class="comment"># 查看 crate 信息</span></span><br></pre></td></tr></table></figure></div>

<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 发布准备 ============</span></span><br><span class="line">cargo login                   <span class="comment"># 登录 crates.io</span></span><br><span class="line">cargo package                 <span class="comment"># 打包（检查）</span></span><br><span class="line">cargo package --list          <span class="comment"># 列出将包含的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 发布 ============</span></span><br><span class="line">cargo publish                 <span class="comment"># 发布到 crates.io</span></span><br><span class="line">cargo publish --dry-run       <span class="comment"># 模拟发布</span></span><br><span class="line">cargo publish --allow-dirty   <span class="comment"># 允许未提交的更改</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 安装 ============</span></span><br><span class="line">cargo install ripgrep         <span class="comment"># 安装二进制</span></span><br><span class="line">cargo install --path .        <span class="comment"># 从本地安装</span></span><br><span class="line">cargo install --git https://github.com/user/repo</span><br><span class="line">cargo uninstall ripgrep       <span class="comment"># 卸载</span></span><br></pre></td></tr></table></figure></div>

<h3 id="其他实用命令"><a href="#其他实用命令" class="headerlink" title="其他实用命令"></a>其他实用命令</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 清理 ============</span></span><br><span class="line">cargo clean                   <span class="comment"># 清理 target 目录</span></span><br><span class="line">cargo clean -p my_crate       <span class="comment"># 清理特定 crate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 代码质量 ============</span></span><br><span class="line">cargo <span class="built_in">fmt</span>                     <span class="comment"># 格式化代码</span></span><br><span class="line">cargo <span class="built_in">fmt</span> -- --check          <span class="comment"># 检查格式</span></span><br><span class="line">cargo clippy                  <span class="comment"># 运行 linter</span></span><br><span class="line">cargo clippy -- -D warnings   <span class="comment"># 警告视为错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 审计 ============</span></span><br><span class="line">cargo audit                   <span class="comment"># 安全漏洞检查（需安装）</span></span><br><span class="line">cargo outdated                <span class="comment"># 检查过期依赖（需安装）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 其他 ============</span></span><br><span class="line">cargo locate-project          <span class="comment"># 显示 Cargo.toml 路径</span></span><br><span class="line">cargo metadata                <span class="comment"># 输出项目元数据（JSON）</span></span><br><span class="line">cargo version                 <span class="comment"># 显示版本</span></span><br><span class="line">cargo --list                  <span class="comment"># 列出所有子命令</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Cargo-toml-详解"><a href="#Cargo-toml-详解" class="headerlink" title="Cargo.toml 详解"></a>Cargo.toml 详解</h2><h3 id="基本结构-1"><a href="#基本结构-1" class="headerlink" title="基本结构"></a>基本结构</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 包信息 ============</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_project&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span>                    <span class="comment"># 2015, 2018, 2021, 2024</span></span><br><span class="line"><span class="attr">rust-version</span> = <span class="string">&quot;1.70&quot;</span>               <span class="comment"># 最低 Rust 版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 元数据</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Your Name &lt;email@example.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;A short description&quot;</span></span><br><span class="line"><span class="attr">documentation</span> = <span class="string">&quot;https://docs.rs/my_project&quot;</span></span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"><span class="attr">homepage</span> = <span class="string">&quot;https://example.com&quot;</span></span><br><span class="line"><span class="attr">repository</span> = <span class="string">&quot;https://github.com/user/my_project&quot;</span></span><br><span class="line"><span class="attr">license</span> = <span class="string">&quot;MIT OR Apache-2.0&quot;</span></span><br><span class="line"><span class="attr">license-file</span> = <span class="string">&quot;LICENSE&quot;</span></span><br><span class="line"><span class="attr">keywords</span> = [<span class="string">&quot;keyword1&quot;</span>, <span class="string">&quot;keyword2&quot;</span>]  <span class="comment"># 最多 5 个</span></span><br><span class="line"><span class="attr">categories</span> = [<span class="string">&quot;development-tools&quot;</span>]   <span class="comment"># 见 crates.io/category_slugs</span></span><br><span class="line"><span class="attr">exclude</span> = [<span class="string">&quot;tests/*&quot;</span>, <span class="string">&quot;benches/*&quot;</span>]   <span class="comment"># 发布时排除</span></span><br><span class="line"><span class="attr">include</span> = [<span class="string">&quot;src/**/*&quot;</span>, <span class="string">&quot;Cargo.toml&quot;</span>] <span class="comment"># 发布时包含（优先于 exclude）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建配置</span></span><br><span class="line"><span class="attr">build</span> = <span class="string">&quot;build.rs&quot;</span>                   <span class="comment"># 构建脚本</span></span><br><span class="line"><span class="attr">links</span> = <span class="string">&quot;foo&quot;</span>                        <span class="comment"># 链接的原生库名</span></span><br><span class="line"><span class="attr">autobins</span> = <span class="literal">true</span>                      <span class="comment"># 自动发现二进制</span></span><br><span class="line"><span class="attr">autoexamples</span> = <span class="literal">true</span>                  <span class="comment"># 自动发现示例</span></span><br><span class="line"><span class="attr">autotests</span> = <span class="literal">true</span>                     <span class="comment"># 自动发现测试</span></span><br><span class="line"><span class="attr">autobenches</span> = <span class="literal">true</span>                   <span class="comment"># 自动发现基准</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析器版本</span></span><br><span class="line"><span class="attr">resolver</span> = <span class="string">&quot;2&quot;</span>                       <span class="comment"># 推荐使用 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 库配置 ============</span></span><br><span class="line"><span class="section">[lib]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_lib&quot;</span>                      <span class="comment"># 库名（默认为包名）</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;src/lib.rs&quot;</span>                  <span class="comment"># 入口路径</span></span><br><span class="line"><span class="attr">crate-type</span> = [<span class="string">&quot;lib&quot;</span>]                 <span class="comment"># lib, rlib, dylib, cdylib, staticlib, proc-macro</span></span><br><span class="line"><span class="attr">doc</span> = <span class="literal">true</span>                           <span class="comment"># 是否生成文档</span></span><br><span class="line"><span class="attr">test</span> = <span class="literal">true</span>                          <span class="comment"># 是否测试</span></span><br><span class="line"><span class="attr">doctest</span> = <span class="literal">true</span>                       <span class="comment"># 是否运行文档测试</span></span><br><span class="line"><span class="attr">bench</span> = <span class="literal">true</span>                         <span class="comment"># 是否运行基准</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 二进制配置 ============</span></span><br><span class="line"><span class="section">[[bin]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_bin&quot;</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;src/main.rs&quot;</span></span><br><span class="line"><span class="attr">test</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">bench</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">doc</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[bin]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;another_bin&quot;</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;src/bin/another.rs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 示例 ============</span></span><br><span class="line"><span class="section">[[example]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_example&quot;</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;examples/my_example.rs&quot;</span></span><br><span class="line"><span class="attr">crate-type</span> = [<span class="string">&quot;bin&quot;</span>]                 <span class="comment"># 默认 bin</span></span><br><span class="line"><span class="attr">required-features</span> = [<span class="string">&quot;feature1&quot;</span>]     <span class="comment"># 需要的 feature</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 测试 ============</span></span><br><span class="line"><span class="section">[[test]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;integration_test&quot;</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;tests/integration.rs&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">true</span>                       <span class="comment"># 使用 libtest harness</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 基准测试 ============</span></span><br><span class="line"><span class="section">[[bench]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_bench&quot;</span></span><br><span class="line"><span class="attr">path</span> = <span class="string">&quot;benches/my_bench.rs&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span>                      <span class="comment"># 使用自定义 harness（如 criterion）</span></span><br></pre></td></tr></table></figure></div>

<h3 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="comment"># 简单版本</span></span><br><span class="line"><span class="attr">serde</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 带 features</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选依赖</span></span><br><span class="line"><span class="attr">serde_json</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Git 依赖</span></span><br><span class="line"><span class="attr">my_crate</span> = &#123; git = <span class="string">&quot;https://github.com/user/repo&quot;</span> &#125;</span><br><span class="line"><span class="attr">my_crate</span> = &#123; git = <span class="string">&quot;https://github.com/user/repo&quot;</span>, branch = <span class="string">&quot;main&quot;</span> &#125;</span><br><span class="line"><span class="attr">my_crate</span> = &#123; git = <span class="string">&quot;https://github.com/user/repo&quot;</span>, tag = <span class="string">&quot;v1.0&quot;</span> &#125;</span><br><span class="line"><span class="attr">my_crate</span> = &#123; git = <span class="string">&quot;https://github.com/user/repo&quot;</span>, rev = <span class="string">&quot;abc123&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地路径</span></span><br><span class="line"><span class="attr">my_crate</span> = &#123; path = <span class="string">&quot;../my_crate&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 路径 + 版本（发布时使用版本）</span></span><br><span class="line"><span class="attr">my_crate</span> = &#123; path = <span class="string">&quot;../my_crate&quot;</span>, version = <span class="string">&quot;1.0&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重命名</span></span><br><span class="line"><span class="attr">serde_json_renamed</span> = &#123; package = <span class="string">&quot;serde_json&quot;</span>, version = <span class="string">&quot;1.0&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用默认 features</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, default-features = <span class="literal">false</span>, features = [<span class="string">&quot;rt&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 平台特定依赖</span></span><br><span class="line"><span class="section">[target.&#x27;cfg(windows)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">winapi</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[target.&#x27;cfg(unix)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">libc</span> = <span class="string">&quot;0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[target.&#x27;cfg(target_arch = &quot;wasm32&quot;)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">wasm-bindgen</span> = <span class="string">&quot;0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发依赖</span></span><br><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">pretty_assertions</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">mockall</span> = <span class="string">&quot;0.11&quot;</span></span><br><span class="line"><span class="attr">criterion</span> = &#123; version = <span class="string">&quot;0.5&quot;</span>, features = [<span class="string">&quot;html_reports&quot;</span>] &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建依赖</span></span><br><span class="line"><span class="section">[build-dependencies]</span></span><br><span class="line"><span class="attr">cc</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"><span class="attr">bindgen</span> = <span class="string">&quot;0.69&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="版本规范"><a href="#版本规范" class="headerlink" title="版本规范"></a>版本规范</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="comment"># 语义化版本</span></span><br><span class="line"><span class="attr">exact</span> = <span class="string">&quot;=1.2.3&quot;</span>        <span class="comment"># 精确版本</span></span><br><span class="line"><span class="attr">caret</span> = <span class="string">&quot;^1.2.3&quot;</span>        <span class="comment"># 默认，&gt;=1.2.3 &lt;2.0.0</span></span><br><span class="line"><span class="attr">tilde</span> = <span class="string">&quot;~1.2.3&quot;</span>        <span class="comment"># &gt;=1.2.3 &lt;1.3.0</span></span><br><span class="line"><span class="attr">wildcard</span> = <span class="string">&quot;1.*&quot;</span>        <span class="comment"># &gt;=1.0.0 &lt;2.0.0</span></span><br><span class="line"><span class="attr">range</span> = <span class="string">&quot;&gt;=1.2, &lt;1.5&quot;</span>   <span class="comment"># 范围</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见模式</span></span><br><span class="line"><span class="attr">latest_1x</span> = <span class="string">&quot;1&quot;</span>         <span class="comment"># &gt;=1.0.0 &lt;2.0.0</span></span><br><span class="line"><span class="attr">patch_only</span> = <span class="string">&quot;~1.2&quot;</span>     <span class="comment"># &gt;=1.2.0 &lt;1.3.0</span></span><br></pre></td></tr></table></figure></div>

<h3 id="Features-配置"><a href="#Features-配置" class="headerlink" title="Features 配置"></a>Features 配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[features]</span></span><br><span class="line"><span class="comment"># 默认启用的 features</span></span><br><span class="line"><span class="attr">default</span> = [<span class="string">&quot;std&quot;</span>, <span class="string">&quot;derive&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义 features</span></span><br><span class="line"><span class="attr">std</span> = []</span><br><span class="line"><span class="attr">derive</span> = [<span class="string">&quot;serde/derive&quot;</span>]      <span class="comment"># 启用依赖的 feature</span></span><br><span class="line"><span class="attr">full</span> = [<span class="string">&quot;std&quot;</span>, <span class="string">&quot;derive&quot;</span>, <span class="string">&quot;async&quot;</span>]</span><br><span class="line"><span class="attr">async</span> = [<span class="string">&quot;tokio&quot;</span>, <span class="string">&quot;async-trait&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选依赖作为 feature</span></span><br><span class="line"><span class="attr">serde</span> = [<span class="string">&quot;dep:serde&quot;</span>]          <span class="comment"># 使用 dep: 前缀避免歧义</span></span><br><span class="line"><span class="attr">json</span> = [<span class="string">&quot;dep:serde_json&quot;</span>, <span class="string">&quot;serde&quot;</span>]  <span class="comment"># 依赖其他 feature</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="attr">serde_json</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="attr">async-trait</span> = &#123; version = <span class="string">&quot;0.1&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Profiles-配置"><a href="#Profiles-配置" class="headerlink" title="Profiles 配置"></a>Profiles 配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 内置配置 ============</span></span><br><span class="line"><span class="section">[profile.dev]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">0</span>           <span class="comment"># 优化级别 0-3, &quot;s&quot;, &quot;z&quot;</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">true</span>            <span class="comment"># 调试信息</span></span><br><span class="line"><span class="attr">split-debuginfo</span> = <span class="string">&quot;...&quot;</span>  <span class="comment"># 调试信息分离</span></span><br><span class="line"><span class="attr">debug-assertions</span> = <span class="literal">true</span>  <span class="comment"># 调试断言</span></span><br><span class="line"><span class="attr">overflow-checks</span> = <span class="literal">true</span>   <span class="comment"># 溢出检查</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">false</span>             <span class="comment"># 链接时优化: false, true/&quot;fat&quot;, &quot;thin&quot;</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;unwind&quot;</span>        <span class="comment"># panic 策略: &quot;unwind&quot;, &quot;abort&quot;</span></span><br><span class="line"><span class="attr">incremental</span> = <span class="literal">true</span>      <span class="comment"># 增量编译</span></span><br><span class="line"><span class="attr">codegen-units</span> = <span class="number">256</span>     <span class="comment"># 代码生成单元</span></span><br><span class="line"><span class="attr">rpath</span> = <span class="literal">false</span>           <span class="comment"># rpath</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">debug-assertions</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">overflow-checks</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br><span class="line"><span class="attr">incremental</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">codegen-units</span> = <span class="number">1</span></span><br><span class="line"><span class="attr">strip</span> = <span class="literal">true</span>            <span class="comment"># 去除符号: true, &quot;debuginfo&quot;, &quot;symbols&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 测试/基准配置 ============</span></span><br><span class="line"><span class="section">[profile.test]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">debug</span> = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.bench]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 自定义配置 ============</span></span><br><span class="line"><span class="section">[profile.release-with-debug]</span></span><br><span class="line"><span class="attr">inherits</span> = <span class="string">&quot;release&quot;</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用: cargo build --profile release-with-debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 依赖特定配置 ============</span></span><br><span class="line"><span class="section">[profile.dev.package.&quot;*&quot;]</span>  <span class="comment"># 所有依赖</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">2</span>              <span class="comment"># 依赖用 O2 优化</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.dev.package.serde]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">3</span>              <span class="comment"># serde 用 O3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建脚本配置</span></span><br><span class="line"><span class="section">[profile.dev.build-override]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="工作空间-Workspace"><a href="#工作空间-Workspace" class="headerlink" title="工作空间 (Workspace)"></a>工作空间 (Workspace)</h2><h3 id="基本结构-2"><a href="#基本结构-2" class="headerlink" title="基本结构"></a>基本结构</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">my_workspace/</span><br><span class="line">├── Cargo.toml           # 工作空间配置</span><br><span class="line">├── crates/</span><br><span class="line">│   ├── core/</span><br><span class="line">│   │   ├── Cargo.toml</span><br><span class="line">│   │   └── src/lib.rs</span><br><span class="line">│   ├── utils/</span><br><span class="line">│   │   ├── Cargo.toml</span><br><span class="line">│   │   └── src/lib.rs</span><br><span class="line">│   └── app/</span><br><span class="line">│       ├── Cargo.toml</span><br><span class="line">│       └── src/main.rs</span><br><span class="line">└── shared/</span><br><span class="line">    ├── Cargo.toml</span><br><span class="line">    └── src/lib.rs</span><br></pre></td></tr></table></figure></div>

<h3 id="工作空间配置"><a href="#工作空间配置" class="headerlink" title="工作空间配置"></a>工作空间配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根目录 Cargo.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="comment"># 成员列表</span></span><br><span class="line"><span class="attr">members</span> = [</span><br><span class="line">    <span class="string">&quot;crates/*&quot;</span>,        <span class="comment"># 通配符</span></span><br><span class="line">    <span class="string">&quot;shared&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除</span></span><br><span class="line"><span class="attr">exclude</span> = [</span><br><span class="line">    <span class="string">&quot;crates/experimental&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认成员（cargo build 时）</span></span><br><span class="line"><span class="attr">default-members</span> = [</span><br><span class="line">    <span class="string">&quot;crates/app&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析器版本</span></span><br><span class="line"><span class="attr">resolver</span> = <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 共享配置 ============</span></span><br><span class="line"><span class="section">[workspace.package]</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">&quot;Your Name &lt;email@example.com&gt;&quot;</span>]</span><br><span class="line"><span class="attr">license</span> = <span class="string">&quot;MIT&quot;</span></span><br><span class="line"><span class="attr">repository</span> = <span class="string">&quot;https://github.com/user/repo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[workspace.dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1.0&quot;</span>, features = [<span class="string">&quot;derive&quot;</span>] &#125;</span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br><span class="line"><span class="attr">thiserror</span> = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内部 crate（便于版本管理）</span></span><br><span class="line"><span class="attr">my_core</span> = &#123; path = <span class="string">&quot;crates/core&quot;</span>, version = <span class="string">&quot;0.1.0&quot;</span> &#125;</span><br><span class="line"><span class="attr">my_utils</span> = &#123; path = <span class="string">&quot;crates/utils&quot;</span>, version = <span class="string">&quot;0.1.0&quot;</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="成员-crate-配置"><a href="#成员-crate-配置" class="headerlink" title="成员 crate 配置"></a>成员 crate 配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crates/core/Cargo.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_core&quot;</span></span><br><span class="line"><span class="attr">version.workspace</span> = <span class="literal">true</span>       <span class="comment"># 继承工作空间版本</span></span><br><span class="line"><span class="attr">edition.workspace</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">authors.workspace</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">license.workspace</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde.workspace</span> = <span class="literal">true</span>         <span class="comment"># 继承工作空间依赖</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; workspace = <span class="literal">true</span>, features = [<span class="string">&quot;rt&quot;</span>] &#125;  <span class="comment"># 可覆盖 features</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># crates/app/Cargo.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_app&quot;</span></span><br><span class="line"><span class="attr">version.workspace</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">edition.workspace</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">my_core.workspace</span> = <span class="literal">true</span>       <span class="comment"># 使用内部 crate</span></span><br><span class="line"><span class="attr">my_utils</span> = &#123; workspace = <span class="literal">true</span>, optional = <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="工作空间命令"><a href="#工作空间命令" class="headerlink" title="工作空间命令"></a>工作空间命令</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建所有成员</span></span><br><span class="line">cargo build --workspace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建特定成员</span></span><br><span class="line">cargo build -p my_core</span><br><span class="line">cargo build -p my_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试所有成员</span></span><br><span class="line">cargo <span class="built_in">test</span> --workspace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行特定二进制</span></span><br><span class="line">cargo run -p my_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布（按依赖顺序）</span></span><br><span class="line">cargo publish -p my_core</span><br><span class="line">cargo publish -p my_utils</span><br><span class="line">cargo publish -p my_app</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="构建脚本-build-rs"><a href="#构建脚本-build-rs" class="headerlink" title="构建脚本 (build.rs)"></a>构建脚本 (build.rs)</h2><h3 id="基本结构-3"><a href="#基本结构-3" class="headerlink" title="基本结构"></a>基本结构</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.rs</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// 构建脚本代码</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 告诉 Cargo 何时重新运行</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=build.rs&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=src/wrapper.h&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 传递给 rustc 的配置</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cfg=feature=\&quot;special\&quot;&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 链接库</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=mylib&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=native=/usr/local/lib&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 传递给依赖此 crate 的构建脚本</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:root=/path/to/root&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 警告信息</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:warning=Something to note&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ============ 重新运行条件 ============</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=PATH&quot;</span>);      <span class="comment">// 文件变化时</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-env-changed=VAR&quot;</span>);   <span class="comment">// 环境变量变化时</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ Rustc 配置 ============</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=static=foo&quot;</span>);  <span class="comment">// 静态链接</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=dylib=bar&quot;</span>);   <span class="comment">// 动态链接</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=framework=CoreFoundation&quot;</span>); <span class="comment">// macOS</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=native=/path&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=framework=/path&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-arg=-fuse-ld=lld&quot;</span>);  <span class="comment">// 链接参数</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-arg-bins=-Wl,-rpath,/path&quot;</span>); <span class="comment">// 仅二进制</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-flags=-l foo -L /path&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cfg=my_cfg&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cfg=feature=\&quot;foo\&quot;&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-env=VAR=value&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cdylib-link-arg=-Wl,--version-script=exports.txt&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ============ 元数据 ============</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:KEY=VALUE&quot;</span>);                  <span class="comment">// 传递给依赖者</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="实用示例"><a href="#实用示例" class="headerlink" title="实用示例"></a>实用示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.rs - 编译 C 代码</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    cc::Build::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">file</span>(<span class="string">&quot;src/foo.c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">file</span>(<span class="string">&quot;src/bar.c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">include</span>(<span class="string">&quot;include&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">flag</span>(<span class="string">&quot;-Wall&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">compile</span>(<span class="string">&quot;mylib&quot;</span>);</span><br><span class="line">      </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=src/foo.c&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=src/bar.c&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.rs - 生成绑定</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bindings</span> = bindgen::Builder::<span class="title function_ invoke__">default</span>()</span><br><span class="line">        .<span class="title function_ invoke__">header</span>(<span class="string">&quot;wrapper.h&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">parse_callbacks</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(bindgen::CargoCallbacks::<span class="title function_ invoke__">new</span>()))</span><br><span class="line">        .<span class="title function_ invoke__">generate</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Unable to generate bindings&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_path</span> = std::path::PathBuf::<span class="title function_ invoke__">from</span>(std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OUT_DIR&quot;</span>).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    bindings</span><br><span class="line">        .<span class="title function_ invoke__">write_to_file</span>(out_path.<span class="title function_ invoke__">join</span>(<span class="string">&quot;bindings.rs&quot;</span>))</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Couldn&#x27;t write bindings!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在代码中使用</span></span><br><span class="line"><span class="comment">// include!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/bindings.rs&quot;));</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.rs - 条件编译</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;TARGET&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> target.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;windows&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cfg=windows_build&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> target.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;linux&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=pthread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查可用功能</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">has_avx2</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;CARGO_CFG_TARGET_FEATURE&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|f| f.<span class="title function_ invoke__">contains</span>(<span class="string">&quot;avx2&quot;</span>))</span><br><span class="line">        .<span class="title function_ invoke__">unwrap_or</span>(<span class="literal">false</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> has_avx2 &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-cfg=has_avx2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build.rs - 生成代码</span></span><br><span class="line"><span class="keyword">use</span> std::env;</span><br><span class="line"><span class="keyword">use</span> std::fs;</span><br><span class="line"><span class="keyword">use</span> std::path::Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_dir</span> = env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OUT_DIR&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dest_path</span> = Path::<span class="title function_ invoke__">new</span>(&amp;out_dir).<span class="title function_ invoke__">join</span>(<span class="string">&quot;generated.rs&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">code</span> = <span class="string">r#&quot;</span></span><br><span class="line"><span class="string">        pub const VERSION: &amp;str = env!(&quot;CARGO_PKG_VERSION&quot;);</span></span><br><span class="line"><span class="string">        pub const BUILD_TIME: &amp;str = &quot;2024-01-01&quot;;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">        pub fn generated_function() -&gt; i32 &#123;</span></span><br><span class="line"><span class="string">            42</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &quot;#</span>;</span><br><span class="line">  </span><br><span class="line">    fs::<span class="title function_ invoke__">write</span>(&amp;dest_path, code).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=build.rs&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在代码中使用</span></span><br><span class="line"><span class="comment">// include!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/generated.rs&quot;));</span></span><br></pre></td></tr></table></figure></div>

<h3 id="构建脚本环境变量"><a href="#构建脚本环境变量" class="headerlink" title="构建脚本环境变量"></a>构建脚本环境变量</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// Cargo 提供的环境变量</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pkg_name</span> = <span class="built_in">env!</span>(<span class="string">&quot;CARGO_PKG_NAME&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pkg_version</span> = <span class="built_in">env!</span>(<span class="string">&quot;CARGO_PKG_VERSION&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">manifest_dir</span> = <span class="built_in">env!</span>(<span class="string">&quot;CARGO_MANIFEST_DIR&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 运行时获取</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_dir</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OUT_DIR&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;TARGET&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">host</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;HOST&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">profile</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;PROFILE&quot;</span>).<span class="title function_ invoke__">unwrap</span>();  <span class="comment">// debug/release</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">opt_level</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OPT_LEVEL&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">num_jobs</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;NUM_JOBS&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 目标配置</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target_arch</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;CARGO_CFG_TARGET_ARCH&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target_os</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;CARGO_CFG_TARGET_OS&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">target_env</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;CARGO_CFG_TARGET_ENV&quot;</span>).<span class="title function_ invoke__">unwrap_or_default</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// features</span></span><br><span class="line">    <span class="comment">// CARGO_FEATURE_&lt;name&gt; 存在表示启用了该 feature</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">has_serde</span> = std::env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;CARGO_FEATURE_SERDE&quot;</span>).<span class="title function_ invoke__">is_ok</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="cargo-config-toml"><a href="#cargo-config-toml" class="headerlink" title=".cargo&#x2F;config.toml"></a>.cargo&#x2F;config.toml</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .cargo/config.toml（项目级或全局 ~/.cargo/config.toml）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 构建配置 ============</span></span><br><span class="line"><span class="section">[build]</span></span><br><span class="line"><span class="attr">jobs</span> = <span class="number">8</span>                          <span class="comment"># 并行任务数</span></span><br><span class="line"><span class="attr">rustc-wrapper</span> = <span class="string">&quot;sccache&quot;</span>         <span class="comment"># 编译缓存</span></span><br><span class="line"><span class="attr">target</span> = <span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span>  <span class="comment"># 默认目标</span></span><br><span class="line"><span class="attr">target-dir</span> = <span class="string">&quot;target&quot;</span>             <span class="comment"># 输出目录</span></span><br><span class="line"><span class="attr">incremental</span> = <span class="literal">true</span>                <span class="comment"># 增量编译</span></span><br><span class="line"><span class="attr">rustflags</span> = [<span class="string">&quot;-C&quot;</span>, <span class="string">&quot;target-cpu=native&quot;</span>]</span><br><span class="line"><span class="attr">rustdocflags</span> = [<span class="string">&quot;--cfg&quot;</span>, <span class="string">&quot;docsrs&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 目标配置 ============</span></span><br><span class="line"><span class="section">[target.x86_64-unknown-linux-gnu]</span></span><br><span class="line"><span class="attr">linker</span> = <span class="string">&quot;clang&quot;</span></span><br><span class="line"><span class="attr">rustflags</span> = [<span class="string">&quot;-C&quot;</span>, <span class="string">&quot;link-arg=-fuse-ld=lld&quot;</span>]</span><br><span class="line"><span class="attr">runner</span> = <span class="string">&quot;my_runner&quot;</span>              <span class="comment"># cargo run 使用的运行器</span></span><br><span class="line"></span><br><span class="line"><span class="section">[target.thumbv7em-none-eabihf]</span></span><br><span class="line"><span class="attr">runner</span> = <span class="string">&quot;probe-rs run --chip STM32F411CEUx&quot;</span></span><br><span class="line"><span class="attr">rustflags</span> = [</span><br><span class="line">    <span class="string">&quot;-C&quot;</span>, <span class="string">&quot;link-arg=-Tlink.x&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[target.&#x27;cfg(target_os = &quot;linux&quot;)&#x27;]</span></span><br><span class="line"><span class="attr">rustflags</span> = [<span class="string">&quot;-C&quot;</span>, <span class="string">&quot;target-feature=+crt-static&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 别名 ============</span></span><br><span class="line"><span class="section">[alias]</span></span><br><span class="line"><span class="attr">b</span> = <span class="string">&quot;build&quot;</span></span><br><span class="line"><span class="attr">c</span> = <span class="string">&quot;check&quot;</span></span><br><span class="line"><span class="attr">t</span> = <span class="string">&quot;test&quot;</span></span><br><span class="line"><span class="attr">r</span> = <span class="string">&quot;run&quot;</span></span><br><span class="line"><span class="attr">rr</span> = <span class="string">&quot;run --release&quot;</span></span><br><span class="line"><span class="attr">br</span> = <span class="string">&quot;build --release&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复杂命令</span></span><br><span class="line"><span class="attr">xtask</span> = <span class="string">&quot;run --package xtask --&quot;</span></span><br><span class="line"><span class="attr">coverage</span> = <span class="string">&quot;llvm-cov --html&quot;</span></span><br><span class="line"><span class="attr">ci</span> = [<span class="string">&quot;fmt -- --check&quot;</span>, <span class="string">&quot;clippy&quot;</span>, <span class="string">&quot;test&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 注册表 ============</span></span><br><span class="line"><span class="section">[registries]</span></span><br><span class="line"><span class="attr">my-registry</span> = &#123; index = <span class="string">&quot;https://my-registry.example.com/git/index&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">[registry]</span></span><br><span class="line"><span class="attr">default</span> = <span class="string">&quot;crates-io&quot;</span>             <span class="comment"># 默认注册表</span></span><br><span class="line"></span><br><span class="line"><span class="section">[source.crates-io]</span></span><br><span class="line"><span class="attr">replace-with</span> = <span class="string">&quot;ustc&quot;</span>             <span class="comment"># 镜像替换</span></span><br><span class="line"></span><br><span class="line"><span class="section">[source.ustc]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;https://mirrors.ustc.edu.cn/crates.io-index&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Git 替换</span></span><br><span class="line"><span class="section">[source.my-git]</span></span><br><span class="line"><span class="attr">git</span> = <span class="string">&quot;https://github.com/example/repo&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地替换（开发调试用）</span></span><br><span class="line"><span class="section">[source.crates-io.replace-with]</span></span><br><span class="line"><span class="attr">local-registry</span> = <span class="string">&quot;/path/to/local/registry&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 网络 ============</span></span><br><span class="line"><span class="section">[net]</span></span><br><span class="line"><span class="attr">retry</span> = <span class="number">2</span>                         <span class="comment"># 重试次数</span></span><br><span class="line"><span class="attr">git-fetch-with-cli</span> = <span class="literal">true</span>         <span class="comment"># 使用 git 命令</span></span><br><span class="line"><span class="attr">offline</span> = <span class="literal">false</span>                   <span class="comment"># 离线模式</span></span><br><span class="line"></span><br><span class="line"><span class="section">[http]</span></span><br><span class="line"><span class="attr">proxy</span> = <span class="string">&quot;http://proxy.example.com:8080&quot;</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">30</span></span><br><span class="line"><span class="attr">cainfo</span> = <span class="string">&quot;/path/to/cert.pem&quot;</span></span><br><span class="line"><span class="attr">check-revoke</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">ssl-version</span> = <span class="string">&quot;tlsv1.3&quot;</span></span><br><span class="line"><span class="attr">low-speed-limit</span> = <span class="number">5</span>               <span class="comment"># bytes/sec</span></span><br><span class="line"><span class="attr">multiplexing</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 终端 ============</span></span><br><span class="line"><span class="section">[term]</span></span><br><span class="line"><span class="attr">verbose</span> = <span class="literal">false</span>                   <span class="comment"># 详细输出</span></span><br><span class="line"><span class="attr">color</span> = <span class="string">&quot;auto&quot;</span>                    <span class="comment"># always, never, auto</span></span><br><span class="line"><span class="attr">progress.when</span> = <span class="string">&quot;auto&quot;</span></span><br><span class="line"><span class="attr">progress.width</span> = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============ 环境变量 ============</span></span><br><span class="line"><span class="section">[env]</span></span><br><span class="line"><span class="attr">MY_VAR</span> = <span class="string">&quot;value&quot;</span></span><br><span class="line"><span class="attr">MY_PATH</span> = &#123; value = <span class="string">&quot;/path&quot;</span>, relative = <span class="literal">true</span> &#125;</span><br><span class="line"><span class="attr">MY_FORCE</span> = &#123; value = <span class="string">&quot;forced&quot;</span>, force = <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常用环境变量</span></span><br><span class="line">CARGO_HOME=~/.cargo               <span class="comment"># Cargo 主目录</span></span><br><span class="line">CARGO_TARGET_DIR=./target         <span class="comment"># 构建输出目录</span></span><br><span class="line">CARGO_BUILD_JOBS=8                <span class="comment"># 并行任务数</span></span><br><span class="line">CARGO_INCREMENTAL=1               <span class="comment"># 增量编译</span></span><br><span class="line">CARGO_PROFILE_RELEASE_LTO=<span class="literal">true</span>    <span class="comment"># Profile 选项</span></span><br><span class="line"></span><br><span class="line">RUSTFLAGS=<span class="string">&quot;-C target-cpu=native&quot;</span>  <span class="comment"># Rustc 标志</span></span><br><span class="line">RUSTDOCFLAGS=<span class="string">&quot;--cfg docsrs&quot;</span>       <span class="comment"># Rustdoc 标志</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络</span></span><br><span class="line">CARGO_HTTP_TIMEOUT=30</span><br><span class="line">CARGO_NET_RETRY=3</span><br><span class="line">CARGO_NET_OFFLINE=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">RUST_TEST_THREADS=1</span><br><span class="line">RUST_BACKTRACE=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line">CARGO_LOG=debug</span><br><span class="line">RUST_LOG=cargo=debug</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Cargo-扩展工具"><a href="#Cargo-扩展工具" class="headerlink" title="Cargo 扩展工具"></a>Cargo 扩展工具</h2><h3 id="常用扩展"><a href="#常用扩展" class="headerlink" title="常用扩展"></a>常用扩展</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ============ 安装 ============</span></span><br><span class="line"><span class="comment"># 代码质量</span></span><br><span class="line">cargo install cargo-edit         <span class="comment"># cargo add/rm/upgrade</span></span><br><span class="line">cargo install cargo-watch        <span class="comment"># 文件变化自动运行</span></span><br><span class="line">cargo install cargo-audit        <span class="comment"># 安全审计</span></span><br><span class="line">cargo install cargo-outdated     <span class="comment"># 检查过期依赖</span></span><br><span class="line">cargo install cargo-deny         <span class="comment"># 依赖策略检查</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析</span></span><br><span class="line">cargo install cargo-bloat        <span class="comment"># 分析二进制大小</span></span><br><span class="line">cargo install cargo-expand       <span class="comment"># 展开宏</span></span><br><span class="line">cargo install cargo-flamegraph   <span class="comment"># 火焰图</span></span><br><span class="line">cargo install cargo-llvm-lines   <span class="comment"># LLVM IR 行数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">cargo install cargo-tarpaulin    <span class="comment"># 代码覆盖率</span></span><br><span class="line">cargo install cargo-llvm-cov     <span class="comment"># 代码覆盖率</span></span><br><span class="line">cargo install cargo-fuzz         <span class="comment"># 模糊测试</span></span><br><span class="line">cargo install cargo-nextest      <span class="comment"># 更快的测试运行器</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">cargo install cargo-release      <span class="comment"># 发布流程自动化</span></span><br><span class="line">cargo install cargo-semver-checks <span class="comment"># API 兼容性检查</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌入式</span></span><br><span class="line">cargo install cargo-binutils     <span class="comment"># 二进制工具</span></span><br><span class="line">cargo install cargo-flash        <span class="comment"># 烧录</span></span><br><span class="line">cargo install cargo-embed        <span class="comment"># 调试</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他</span></span><br><span class="line">cargo install cargo-make         <span class="comment"># 任务运行器</span></span><br><span class="line">cargo install cargo-generate     <span class="comment"># 项目模板</span></span><br><span class="line">cargo install cargo-udeps        <span class="comment"># 检查未使用依赖</span></span><br></pre></td></tr></table></figure></div>

<h3 id="cargo-watch"><a href="#cargo-watch" class="headerlink" title="cargo-watch"></a>cargo-watch</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件变化时自动运行</span></span><br><span class="line">cargo watch -x check             <span class="comment"># 自动检查</span></span><br><span class="line">cargo watch -x <span class="built_in">test</span>              <span class="comment"># 自动测试</span></span><br><span class="line">cargo watch -x <span class="string">&quot;run -- --arg&quot;</span>    <span class="comment"># 自动运行</span></span><br><span class="line">cargo watch -x clippy -x <span class="built_in">test</span>    <span class="comment"># 多命令</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义监视</span></span><br><span class="line">cargo watch -w src -w tests      <span class="comment"># 指定监视目录</span></span><br><span class="line">cargo watch --ignore <span class="string">&quot;*.txt&quot;</span>     <span class="comment"># 忽略文件</span></span><br><span class="line">cargo watch -c                   <span class="comment"># 运行前清屏</span></span><br><span class="line">cargo watch -d 2                 <span class="comment"># 延迟 2 秒</span></span><br></pre></td></tr></table></figure></div>

<h3 id="cargo-make"><a href="#cargo-make" class="headerlink" title="cargo-make"></a>cargo-make</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile.toml</span></span><br><span class="line"><span class="section">[env]</span></span><br><span class="line"><span class="attr">RUST_BACKTRACE</span> = <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.format]</span></span><br><span class="line"><span class="attr">command</span> = <span class="string">&quot;cargo&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;fmt&quot;</span>, <span class="string">&quot;--all&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.lint]</span></span><br><span class="line"><span class="attr">command</span> = <span class="string">&quot;cargo&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;clippy&quot;</span>, <span class="string">&quot;--all-targets&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;-D&quot;</span>, <span class="string">&quot;warnings&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.test]</span></span><br><span class="line"><span class="attr">command</span> = <span class="string">&quot;cargo&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;test&quot;</span>, <span class="string">&quot;--all-features&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.build-release]</span></span><br><span class="line"><span class="attr">command</span> = <span class="string">&quot;cargo&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;build&quot;</span>, <span class="string">&quot;--release&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.ci]</span></span><br><span class="line"><span class="attr">dependencies</span> = [<span class="string">&quot;format&quot;</span>, <span class="string">&quot;lint&quot;</span>, <span class="string">&quot;test&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tasks.dev]</span></span><br><span class="line"><span class="attr">run_task</span> = &#123; name = [<span class="string">&quot;format&quot;</span>, <span class="string">&quot;lint&quot;</span>, <span class="string">&quot;test&quot;</span>], parallel = <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带条件的任务</span></span><br><span class="line"><span class="section">[tasks.build-windows]</span></span><br><span class="line"><span class="attr">condition</span> = &#123; platforms = [<span class="string">&quot;windows&quot;</span>] &#125;</span><br><span class="line"><span class="attr">command</span> = <span class="string">&quot;cargo&quot;</span></span><br><span class="line"><span class="attr">args</span> = [<span class="string">&quot;build&quot;</span>, <span class="string">&quot;--target&quot;</span>, <span class="string">&quot;x86_64-pc-windows-msvc&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cargo make ci</span><br><span class="line">cargo make dev</span><br><span class="line">cargo make build-release</span><br></pre></td></tr></table></figure></div>

<h3 id="cargo-release"><a href="#cargo-release" class="headerlink" title="cargo-release"></a>cargo-release</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml 或 release.toml</span></span><br><span class="line"><span class="section">[package.metadata.release]</span></span><br><span class="line"><span class="attr">sign-commit</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">sign-tag</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">pre-release-commit-message</span> = <span class="string">&quot;Release &#123;&#123;version&#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">tag-message</span> = <span class="string">&quot;Release &#123;&#123;version&#125;&#125;&quot;</span></span><br><span class="line"><span class="attr">tag-prefix</span> = <span class="string">&quot;v&quot;</span></span><br><span class="line"><span class="attr">pre-release-replacements</span> = [</span><br><span class="line">    &#123; file = <span class="string">&quot;CHANGELOG.md&quot;</span>, search = <span class="string">&quot;Unreleased&quot;</span>, replace = <span class="string">&quot;&#123;&#123;version&#125;&#125;&quot;</span> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cargo release patch              <span class="comment"># 0.1.0 -&gt; 0.1.1</span></span><br><span class="line">cargo release minor              <span class="comment"># 0.1.0 -&gt; 0.2.0</span></span><br><span class="line">cargo release major              <span class="comment"># 0.1.0 -&gt; 1.0.0</span></span><br><span class="line">cargo release --dry-run          <span class="comment"># 模拟运行</span></span><br><span class="line">cargo release --execute          <span class="comment"># 实际执行</span></span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="发布到-crates-io"><a href="#发布到-crates-io" class="headerlink" title="发布到 crates.io"></a>发布到 crates.io</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml - 必需字段</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_crate&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"><span class="attr">license</span> = <span class="string">&quot;MIT OR Apache-2.0&quot;</span>     <span class="comment"># 必需</span></span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;A short description&quot;</span>  <span class="comment"># 必需</span></span><br><span class="line"><span class="attr">repository</span> = <span class="string">&quot;https://github.com/user/repo&quot;</span>  <span class="comment"># 推荐</span></span><br><span class="line"><span class="attr">documentation</span> = <span class="string">&quot;https://docs.rs/my_crate&quot;</span></span><br><span class="line"><span class="attr">readme</span> = <span class="string">&quot;README.md&quot;</span></span><br><span class="line"><span class="attr">keywords</span> = [<span class="string">&quot;keyword1&quot;</span>, <span class="string">&quot;keyword2&quot;</span>]</span><br><span class="line"><span class="attr">categories</span> = [<span class="string">&quot;development-tools&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 排除不必要的文件</span></span><br><span class="line"><span class="attr">exclude</span> = [</span><br><span class="line">    <span class="string">&quot;tests/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;benches/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.github/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;*.log&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<h3 id="发布前检查"><a href="#发布前检查" class="headerlink" title="发布前检查"></a>发布前检查</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查可发布性</span></span><br><span class="line">cargo publish --dry-run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查包内容</span></span><br><span class="line">cargo package --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地安装测试</span></span><br><span class="line">cargo install --path .</span><br><span class="line"></span><br><span class="line"><span class="comment"># API 兼容性（需要 cargo-semver-checks）</span></span><br><span class="line">cargo semver-checks check-release</span><br></pre></td></tr></table></figure></div>

<h3 id="发布流程"><a href="#发布流程" class="headerlink" title="发布流程"></a>发布流程</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 登录</span></span><br><span class="line">cargo login &lt;token&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 发布</span></span><br><span class="line">cargo publish</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Yanking（撤回版本，不能删除）</span></span><br><span class="line">cargo yank --version 0.1.0</span><br><span class="line">cargo yank --version 0.1.0 --undo  <span class="comment"># 恢复</span></span><br></pre></td></tr></table></figure></div>

<h3 id="文档发布"><a href="#文档发布" class="headerlink" title="文档发布"></a>文档发布</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docs.rs 自动从 crates.io 构建</span></span><br><span class="line"><span class="comment"># 配置 docs.rs 构建</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package.metadata.docs.rs]</span></span><br><span class="line"><span class="attr">all-features</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">rustdoc-args</span> = [<span class="string">&quot;--cfg&quot;</span>, <span class="string">&quot;docsrs&quot;</span>]</span><br><span class="line"><span class="attr">targets</span> = [<span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.rs</span></span><br><span class="line"><span class="meta">#![cfg_attr(docsrs, feature(doc_cfg))]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 仅在特定 feature 下显示</span></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;advanced&quot;</span>)]</span></span><br><span class="line"><span class="meta">#[cfg_attr(docsrs, doc(cfg(feature = <span class="string">&quot;advanced&quot;</span>)))]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">advanced_function</span>() &#123;&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常见模式-3"><a href="#常见模式-3" class="headerlink" title="常见模式"></a>常见模式</h2><h3 id="条件编译"><a href="#条件编译" class="headerlink" title="条件编译"></a>条件编译</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[features]</span></span><br><span class="line"><span class="attr">default</span> = [<span class="string">&quot;std&quot;</span>]</span><br><span class="line"><span class="attr">std</span> = []</span><br><span class="line"><span class="attr">alloc</span> = []</span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, optional = <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.rs</span></span><br><span class="line"><span class="meta">#![cfg_attr(not(feature = <span class="string">&quot;std&quot;</span>), no_std)]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;alloc&quot;</span>)]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;std&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">std_only</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(feature = <span class="string">&quot;serde&quot;</span>)]</span></span><br><span class="line"><span class="keyword">mod</span> serde_impl;</span><br></pre></td></tr></table></figure></div>

<h3 id="多平台支持"><a href="#多平台支持" class="headerlink" title="多平台支持"></a>多平台支持</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[target.&#x27;cfg(windows)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">winapi</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[target.&#x27;cfg(unix)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">libc</span> = <span class="string">&quot;0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[target.&#x27;cfg(target_arch = &quot;wasm32&quot;)&#x27;.dependencies]</span></span><br><span class="line"><span class="attr">wasm-bindgen</span> = <span class="string">&quot;0.2&quot;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="示例项目组织"><a href="#示例项目组织" class="headerlink" title="示例项目组织"></a>示例项目组织</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要特定依赖的示例</span></span><br><span class="line"><span class="section">[[example]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;async_example&quot;</span></span><br><span class="line"><span class="attr">required-features</span> = [<span class="string">&quot;tokio&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[[example]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;serde_example&quot;</span></span><br><span class="line"><span class="attr">required-features</span> = [<span class="string">&quot;serde&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">tokio</span> = &#123; version = <span class="string">&quot;1&quot;</span>, features = [<span class="string">&quot;full&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="xtask-模式"><a href="#xtask-模式" class="headerlink" title="xtask 模式"></a>xtask 模式</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── src/</span><br><span class="line">├── xtask/</span><br><span class="line">│   ├── Cargo.toml</span><br><span class="line">│   └── src/main.rs</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根 Cargo.toml</span></span><br><span class="line"><span class="section">[workspace]</span></span><br><span class="line"><span class="attr">members</span> = [<span class="string">&quot;.&quot;</span>, <span class="string">&quot;xtask&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># .cargo/config.toml</span></span><br><span class="line"><span class="section">[alias]</span></span><br><span class="line"><span class="attr">xtask</span> = <span class="string">&quot;run --package xtask --&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xtask/src/main.rs</span></span><br><span class="line"><span class="keyword">use</span> std::process::Command;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">args</span>: <span class="type">Vec</span>&lt;<span class="type">String</span>&gt; = std::env::<span class="title function_ invoke__">args</span>().<span class="title function_ invoke__">skip</span>(<span class="number">1</span>).<span class="title function_ invoke__">collect</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">match</span> args.<span class="title function_ invoke__">first</span>().<span class="title function_ invoke__">map</span>(|s| s.<span class="title function_ invoke__">as_str</span>()) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="string">&quot;dist&quot;</span>) =&gt; <span class="title function_ invoke__">dist</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="string">&quot;coverage&quot;</span>) =&gt; <span class="title function_ invoke__">coverage</span>(),</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(<span class="string">&quot;ci&quot;</span>) =&gt; <span class="title function_ invoke__">ci</span>(),</span><br><span class="line">        _ =&gt; &#123;</span><br><span class="line">            eprintln!(<span class="string">&quot;Usage: cargo xtask &lt;task&gt;&quot;</span>);</span><br><span class="line">            eprintln!(<span class="string">&quot;Tasks: dist, coverage, ci&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">dist</span>() &#123;</span><br><span class="line">    Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;cargo&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">args</span>([<span class="string">&quot;build&quot;</span>, <span class="string">&quot;--release&quot;</span>])</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to build&quot;</span>);</span><br><span class="line">    <span class="comment">// 打包逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">coverage</span>() &#123;</span><br><span class="line">    Command::<span class="title function_ invoke__">new</span>(<span class="string">&quot;cargo&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">args</span>([<span class="string">&quot;llvm-cov&quot;</span>, <span class="string">&quot;--html&quot;</span>])</span><br><span class="line">        .<span class="title function_ invoke__">status</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Failed to run coverage&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">ci</span>() &#123;</span><br><span class="line">    <span class="comment">// 运行所有 CI 检查</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cargo xtask dist</span><br><span class="line">cargo xtask coverage</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="速查表-4"><a href="#速查表-4" class="headerlink" title="速查表"></a>速查表</h2><h3 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>cargo new/init</code></td>
<td>创建项目</td>
</tr>
<tr>
<td><code>cargo build</code></td>
<td>构建</td>
</tr>
<tr>
<td><code>cargo run</code></td>
<td>构建并运行</td>
</tr>
<tr>
<td><code>cargo check</code></td>
<td>快速检查</td>
</tr>
<tr>
<td><code>cargo test</code></td>
<td>运行测试</td>
</tr>
<tr>
<td><code>cargo bench</code></td>
<td>运行基准测试</td>
</tr>
<tr>
<td><code>cargo doc</code></td>
<td>生成文档</td>
</tr>
<tr>
<td><code>cargo publish</code></td>
<td>发布</td>
</tr>
<tr>
<td><code>cargo add/remove</code></td>
<td>管理依赖</td>
</tr>
<tr>
<td><code>cargo update</code></td>
<td>更新依赖</td>
</tr>
<tr>
<td><code>cargo tree</code></td>
<td>依赖树</td>
</tr>
<tr>
<td><code>cargo fmt</code></td>
<td>格式化</td>
</tr>
<tr>
<td><code>cargo clippy</code></td>
<td>Lint</td>
</tr>
<tr>
<td><code>cargo clean</code></td>
<td>清理</td>
</tr>
</tbody></table>
<h3 id="常用标志"><a href="#常用标志" class="headerlink" title="常用标志"></a>常用标志</h3><table>
<thead>
<tr>
<th>标志</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>--release</code></td>
<td>Release 模式</td>
</tr>
<tr>
<td><code>--workspace</code></td>
<td>所有工作空间成员</td>
</tr>
<tr>
<td><code>-p &lt;name&gt;</code></td>
<td>指定包</td>
</tr>
<tr>
<td><code>--all-features</code></td>
<td>启用所有 features</td>
</tr>
<tr>
<td><code>--no-default-features</code></td>
<td>禁用默认 features</td>
</tr>
<tr>
<td><code>--features &quot;a b&quot;</code></td>
<td>启用指定 features</td>
</tr>
<tr>
<td><code>--target &lt;triple&gt;</code></td>
<td>指定目标</td>
</tr>
<tr>
<td><code>--verbose/-v</code></td>
<td>详细输出</td>
</tr>
<tr>
<td><code>--jobs/-j &lt;N&gt;</code></td>
<td>并行任务数</td>
</tr>
</tbody></table>
<h3 id="环境变量-1"><a href="#环境变量-1" class="headerlink" title="环境变量"></a>环境变量</h3><table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>CARGO_HOME</code></td>
<td>Cargo 主目录</td>
</tr>
<tr>
<td><code>CARGO_TARGET_DIR</code></td>
<td>输出目录</td>
</tr>
<tr>
<td><code>RUSTFLAGS</code></td>
<td>编译器标志</td>
</tr>
<tr>
<td><code>CARGO_INCREMENTAL</code></td>
<td>增量编译</td>
</tr>
<tr>
<td><code>RUST_BACKTRACE</code></td>
<td>错误回溯</td>
</tr>
</tbody></table>
<h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Cargo.toml</code></td>
<td>项目配置</td>
</tr>
<tr>
<td><code>Cargo.lock</code></td>
<td>依赖锁定</td>
</tr>
<tr>
<td><code>.cargo/config.toml</code></td>
<td>Cargo 配置</td>
</tr>
<tr>
<td><code>build.rs</code></td>
<td>构建脚本</td>
</tr>
<tr>
<td><code>rust-toolchain.toml</code></td>
<td>工具链配置</td>
</tr>
</tbody></table>
<h1 id="no-std-编程"><a href="#no-std-编程" class="headerlink" title="no_std 编程"></a>no_std 编程</h1><h2 id="概念概览"><a href="#概念概览" class="headerlink" title="概念概览"></a>概念概览</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Rust 标准库层次                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                     │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐       │</span><br><span class="line">│   │                      std                                │       │</span><br><span class="line">│   │  • 依赖操作系统（文件、网络、线程、时间...）             │       │</span><br><span class="line">│   │  • 自动链接，提供运行时                                  │       │</span><br><span class="line">│   ├─────────────────────────────────────────────────────────┤       │</span><br><span class="line">│   │                     alloc                               │       │</span><br><span class="line">│   │  • 堆内存分配（Box, Vec, String, Rc, Arc...）           │       │</span><br><span class="line">│   │  • 需要全局分配器                                        │       │</span><br><span class="line">│   ├─────────────────────────────────────────────────────────┤       │</span><br><span class="line">│   │                      core                               │       │</span><br><span class="line">│   │  • 无任何依赖（Option, Result, Iterator, 切片...）       │       │</span><br><span class="line">│   │  • 纯 Rust，可在任何环境运行                             │       │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘       │</span><br><span class="line">│                                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  no_std 应用场景                                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  • 嵌入式系统 (ARM Cortex-M, RISC-V, AVR...)                        │</span><br><span class="line">│  • 操作系统内核开发                                                  │</span><br><span class="line">│  • Bootloader                                                       │</span><br><span class="line">│  • WebAssembly (部分场景)                                            │</span><br><span class="line">│  • 驱动程序                                                          │</span><br><span class="line">│  • 实时系统                                                          │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></div>

<h3 id="std-vs-no-std-对比"><a href="#std-vs-no-std-对比" class="headerlink" title="std vs no_std 对比"></a>std vs no_std 对比</h3><table>
<thead>
<tr>
<th>特性</th>
<th>std</th>
<th>no_std</th>
<th>no_std + alloc</th>
</tr>
</thead>
<tbody><tr>
<td>堆内存</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>Vec&#x2F;String&#x2F;Box</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td>文件 I&#x2F;O</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>网络</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>线程</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>时间</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>HashMap</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>println!</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>panic 信息</td>
<td>✅</td>
<td>需实现</td>
<td>需实现</td>
</tr>
</tbody></table>
<hr>
<h2 id="基础-no-std-项目"><a href="#基础-no-std-项目" class="headerlink" title="基础 no_std 项目"></a>基础 no_std 项目</h2><h3 id="最小示例"><a href="#最小示例" class="headerlink" title="最小示例"></a>最小示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#![no_std]</span>  <span class="comment">// 不链接标准库</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果是二进制程序，还需要</span></span><br><span class="line"><span class="comment">// #![no_main]  // 不使用标准入口点</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须定义 panic 处理</span></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在可以使用 core 库的内容</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">find_max</span>(slice: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    slice.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">max</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;my_no_std_lib&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[lib]</span></span><br><span class="line"><span class="comment"># 可选：生成静态库</span></span><br><span class="line"><span class="comment"># crate-type = [&quot;staticlib&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span>    <span class="comment"># 减小二进制大小</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span>         <span class="comment"># 链接时优化</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="string">&quot;z&quot;</span>    <span class="comment"># 优化大小</span></span><br></pre></td></tr></table></figure></div>

<h2 id="core-库详解"><a href="#core-库详解" class="headerlink" title="core 库详解"></a>core 库详解</h2><h3 id="可用类型和-trait"><a href="#可用类型和-trait" class="headerlink" title="可用类型和 trait"></a>可用类型和 trait</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::&#123;</span><br><span class="line">    <span class="comment">// 基础类型操作</span></span><br><span class="line">    mem,</span><br><span class="line">    ptr,</span><br><span class="line">    slice,</span><br><span class="line">    <span class="type">str</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 常用 trait</span></span><br><span class="line">    cmp::&#123;<span class="built_in">Ord</span>, <span class="built_in">PartialOrd</span>, <span class="built_in">Eq</span>, <span class="built_in">PartialEq</span>, Ordering&#125;,</span><br><span class="line">    convert::&#123;<span class="built_in">From</span>, <span class="built_in">Into</span>, TryFrom, TryInto, <span class="built_in">AsRef</span>, <span class="built_in">AsMut</span>&#125;,</span><br><span class="line">    default::<span class="built_in">Default</span>,</span><br><span class="line">    fmt::&#123;<span class="built_in">Debug</span>, Display, Formatter, Write&#125;,</span><br><span class="line">    hash::&#123;Hash, Hasher&#125;,</span><br><span class="line">    iter::&#123;<span class="built_in">Iterator</span>, <span class="built_in">IntoIterator</span>, FromIterator&#125;,</span><br><span class="line">    marker::&#123;<span class="built_in">Copy</span>, <span class="built_in">Send</span>, <span class="built_in">Sync</span>, <span class="built_in">Sized</span>, PhantomData&#125;,</span><br><span class="line">    ops::&#123;Add, Sub, Mul, Div, Index, Deref, <span class="built_in">Drop</span>, <span class="built_in">Fn</span>, <span class="built_in">FnMut</span>, <span class="built_in">FnOnce</span>&#125;,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">    option::<span class="type">Option</span>,</span><br><span class="line">    result::<span class="type">Result</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 数值</span></span><br><span class="line">    num::Wrapping,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 同步原语</span></span><br><span class="line">    sync::atomic::&#123;AtomicBool, AtomicUsize, Ordering <span class="keyword">as</span> AtomicOrdering&#125;,</span><br><span class="line">    cell::&#123;Cell, RefCell, UnsafeCell&#125;,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 时间（无系统时钟）</span></span><br><span class="line">    time::Duration,</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 其他</span></span><br><span class="line">    any::Any,</span><br><span class="line">    borrow::&#123;Borrow, BorrowMut&#125;,</span><br><span class="line">    clone::<span class="built_in">Clone</span>,</span><br><span class="line">    hint,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：使用 core 实现功能</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sum_slice</span>(data: &amp;[<span class="type">i32</span>]) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    data.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">fold</span>(<span class="number">0</span>, |acc, x| acc.<span class="title function_ invoke__">wrapping_add</span>(*x))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">find_index</span>&lt;T: <span class="built_in">PartialEq</span>&gt;(slice: &amp;[T], target: &amp;T) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    slice.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">position</span>(|x| x == target)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="格式化输出（无-println-）"><a href="#格式化输出（无-println-）" class="headerlink" title="格式化输出（无 println!）"></a>格式化输出（无 println!）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::fmt::&#123;<span class="keyword">self</span>, Write&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义写入目标</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    data: [<span class="type">u8</span>; <span class="number">256</span>],</span><br><span class="line">    pos: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Buffer &#123;</span><br><span class="line">            data: [<span class="number">0</span>; <span class="number">256</span>],</span><br><span class="line">            pos: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">as_str</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">str</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::<span class="type">str</span>::<span class="title function_ invoke__">from_utf8_unchecked</span>(&amp;<span class="keyword">self</span>.data[..<span class="keyword">self</span>.pos]) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">clear</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">Buffer</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes</span> = s.<span class="title function_ invoke__">as_bytes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">remaining</span> = <span class="keyword">self</span>.data.<span class="title function_ invoke__">len</span>() - <span class="keyword">self</span>.pos;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">if</span> bytes.<span class="title function_ invoke__">len</span>() &gt; remaining &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(fmt::Error);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">self</span>.data[<span class="keyword">self</span>.pos..<span class="keyword">self</span>.pos + bytes.<span class="title function_ invoke__">len</span>()].<span class="title function_ invoke__">copy_from_slice</span>(bytes);</span><br><span class="line">        <span class="keyword">self</span>.pos += bytes.<span class="title function_ invoke__">len</span>();</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 write! 宏</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">format_number</span>(buf: &amp;<span class="keyword">mut</span> Buffer, n: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">    <span class="built_in">write!</span>(buf, <span class="string">&quot;Number: &#123;&#125;&quot;</span>, n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 Debug/Display</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    x: <span class="type">i32</span>,</span><br><span class="line">    y: <span class="type">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::<span class="built_in">Debug</span> <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;Point &#123;&#123; x: &#123;&#125;, y: &#123;&#125; &#125;&#125;&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">fmt</span>::Display <span class="keyword">for</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">fmt</span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">&quot;(&#123;&#125;, &#123;&#125;)&quot;</span>, <span class="keyword">self</span>.x, <span class="keyword">self</span>.y)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="原子操作-1"><a href="#原子操作-1" class="headerlink" title="原子操作"></a>原子操作</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::sync::atomic::&#123;AtomicUsize, AtomicBool, Ordering&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无锁计数器</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    value: AtomicUsize,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Counter &#123;</span><br><span class="line">            value: AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">increment</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.value.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.value.<span class="title function_ invoke__">load</span>(Ordering::SeqCst)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自旋锁</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    locked: AtomicBool,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        SpinLock &#123;</span><br><span class="line">            locked: AtomicBool::<span class="title function_ invoke__">new</span>(<span class="literal">false</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">lock</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.locked.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            <span class="literal">true</span>,</span><br><span class="line">            Ordering::Acquire,</span><br><span class="line">            Ordering::Relaxed</span><br><span class="line">        ).<span class="title function_ invoke__">is_err</span>() &#123;</span><br><span class="line">            <span class="comment">// 自旋等待</span></span><br><span class="line">            core::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unlock</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.locked.<span class="title function_ invoke__">store</span>(<span class="literal">false</span>, Ordering::Release);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">try_lock</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.locked</span><br><span class="line">            .<span class="title function_ invoke__">compare_exchange</span>(<span class="literal">false</span>, <span class="literal">true</span>, Ordering::Acquire, Ordering::Relaxed)</span><br><span class="line">            .<span class="title function_ invoke__">is_ok</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">static</span> COUNTER: Counter = Counter::<span class="title function_ invoke__">new</span>();</span><br><span class="line"><span class="keyword">static</span> LOCK: SpinLock = SpinLock::<span class="title function_ invoke__">new</span>();</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="alloc-库使用"><a href="#alloc-库使用" class="headerlink" title="alloc 库使用"></a>alloc 库使用</h2><h3 id="启用-alloc"><a href="#启用-alloc" class="headerlink" title="启用 alloc"></a>启用 alloc</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> alloc::&#123;</span><br><span class="line">    boxed::<span class="type">Box</span>,</span><br><span class="line">    vec::<span class="type">Vec</span>,</span><br><span class="line">    vec,</span><br><span class="line">    string::<span class="type">String</span>,</span><br><span class="line">    format,</span><br><span class="line">    rc::Rc,</span><br><span class="line">    sync::Arc,</span><br><span class="line">    collections::&#123;BTreeMap, BTreeSet, VecDeque, LinkedList, BinaryHeap&#125;,</span><br><span class="line">    borrow::Cow,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用堆分配类型</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">create_vector</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="built_in">vec!</span>[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">boxed_value</span>() <span class="punctuation">-&gt;</span> <span class="type">Box</span>&lt;[<span class="type">u8</span>; <span class="number">1024</span>]&gt; &#123;</span><br><span class="line">    <span class="type">Box</span>::<span class="title function_ invoke__">new</span>([<span class="number">0u8</span>; <span class="number">1024</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">use_btree_map</span>() <span class="punctuation">-&gt;</span> BTreeMap&lt;&amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>, <span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span> = BTreeMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;one&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;two&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    map</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="全局分配器"><a href="#全局分配器" class="headerlink" title="全局分配器"></a>全局分配器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![feature(alloc_error_handler)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::alloc::&#123;GlobalAlloc, Layout&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单的 bump 分配器</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">BumpAllocator</span> &#123;</span><br><span class="line">    heap_start: <span class="type">usize</span>,</span><br><span class="line">    heap_end: <span class="type">usize</span>,</span><br><span class="line">    next: core::sync::atomic::AtomicUsize,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">BumpAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        BumpAllocator &#123;</span><br><span class="line">            heap_start: <span class="number">0</span>,</span><br><span class="line">            heap_end: <span class="number">0</span>,</span><br><span class="line">            next: core::sync::atomic::AtomicUsize::<span class="title function_ invoke__">new</span>(<span class="number">0</span>),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/// 初始化分配器</span></span><br><span class="line">    <span class="comment">/// </span></span><br><span class="line">    <span class="comment">/// # Safety</span></span><br><span class="line">    <span class="comment">/// 调用者必须确保给定的内存区域有效且未被使用</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, heap_start: <span class="type">usize</span>, heap_size: <span class="type">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.heap_start = heap_start;</span><br><span class="line">        <span class="keyword">self</span>.heap_end = heap_start + heap_size;</span><br><span class="line">        <span class="keyword">self</span>.next.<span class="title function_ invoke__">store</span>(heap_start, core::sync::atomic::Ordering::SeqCst);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">GlobalAlloc</span> <span class="keyword">for</span> <span class="title class_">BumpAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">self</span>, layout: Layout) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> <span class="type">u8</span> &#123;</span><br><span class="line">        <span class="keyword">use</span> core::sync::atomic::Ordering;</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">loop</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">current</span> = <span class="keyword">self</span>.next.<span class="title function_ invoke__">load</span>(Ordering::Relaxed);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">aligned</span> = <span class="title function_ invoke__">align_up</span>(current, layout.<span class="title function_ invoke__">align</span>());</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_next</span> = aligned + layout.<span class="title function_ invoke__">size</span>();</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> new_next &gt; <span class="keyword">self</span>.heap_end &#123;</span><br><span class="line">                <span class="keyword">return</span> core::ptr::<span class="title function_ invoke__">null_mut</span>(); <span class="comment">// OOM</span></span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.next.<span class="title function_ invoke__">compare_exchange_weak</span>(</span><br><span class="line">                current,</span><br><span class="line">                new_next,</span><br><span class="line">                Ordering::SeqCst,</span><br><span class="line">                Ordering::Relaxed</span><br><span class="line">            ).<span class="title function_ invoke__">is_ok</span>() &#123;</span><br><span class="line">                <span class="keyword">return</span> aligned <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">self</span>, _ptr: *<span class="keyword">mut</span> <span class="type">u8</span>, _layout: Layout) &#123;</span><br><span class="line">        <span class="comment">// Bump 分配器不支持单独释放</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">align_up</span>(addr: <span class="type">usize</span>, align: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (addr + align - <span class="number">1</span>) &amp; !(align - <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册全局分配器</span></span><br><span class="line"><span class="meta">#[global_allocator]</span></span><br><span class="line"><span class="keyword">static</span> ALLOCATOR: BumpAllocator = BumpAllocator::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分配错误处理</span></span><br><span class="line"><span class="meta">#[alloc_error_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">alloc_error</span>(_layout: Layout) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用现有分配器"><a href="#使用现有分配器" class="headerlink" title="使用现有分配器"></a>使用现有分配器</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 linked_list_allocator crate</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![feature(alloc_error_handler)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> alloc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> linked_list_allocator::LockedHeap;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[global_allocator]</span></span><br><span class="line"><span class="keyword">static</span> ALLOCATOR: LockedHeap = LockedHeap::<span class="title function_ invoke__">empty</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在某处初始化</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_heap</span>(heap_start: <span class="type">usize</span>, heap_size: <span class="type">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        ALLOCATOR.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">init</span>(heap_start <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, heap_size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[alloc_error_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">alloc_error_handler</span>(layout: core::alloc::Layout) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;allocation error: &#123;:?&#125;&quot;</span>, layout)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在可以使用 Vec, Box 等</span></span><br><span class="line"><span class="keyword">use</span> alloc::vec::<span class="type">Vec</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">test_alloc</span>() <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">i32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>);</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">2</span>);</span><br><span class="line">    v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="Panic-处理"><a href="#Panic-处理" class="headerlink" title="Panic 处理"></a>Panic 处理</h2><h3 id="基本-panic-handler"><a href="#基本-panic-handler" class="headerlink" title="基本 panic handler"></a>基本 panic handler</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最简单的实现：无限循环</span></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带调试信息</span></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic_with_info</span>(info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// 获取 panic 位置</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(location) = info.<span class="title function_ invoke__">location</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_file</span> = location.<span class="title function_ invoke__">file</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_line</span> = location.<span class="title function_ invoke__">line</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_column</span> = location.<span class="title function_ invoke__">column</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取 panic 消息</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(message) = info.<span class="title function_ invoke__">message</span>() &#123;</span><br><span class="line">        <span class="comment">// 使用 message</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = message;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="输出-panic-信息"><a href="#输出-panic-信息" class="headerlink" title="输出 panic 信息"></a>输出 panic 信息</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"><span class="keyword">use</span> core::fmt::Write;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设我们有一个 UART 输出</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UartWriter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">UartWriter</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> core::fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">byte</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">bytes</span>() &#123;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="comment">// 写入 UART 寄存器（示例地址）</span></span><br><span class="line">                core::ptr::<span class="title function_ invoke__">write_volatile</span>(<span class="number">0x1000_0000</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, byte);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">writer</span> = UartWriter;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_</span> = <span class="built_in">writeln!</span>(writer, <span class="string">&quot;\n!!! PANIC !!!&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(location) = info.<span class="title function_ invoke__">location</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = <span class="built_in">writeln!</span>(</span><br><span class="line">            writer,</span><br><span class="line">            <span class="string">&quot;Location: &#123;&#125;:&#123;&#125;:&#123;&#125;&quot;</span>,</span><br><span class="line">            location.<span class="title function_ invoke__">file</span>(),</span><br><span class="line">            location.<span class="title function_ invoke__">line</span>(),</span><br><span class="line">            location.<span class="title function_ invoke__">column</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(message) = info.<span class="title function_ invoke__">message</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">_</span> = <span class="built_in">writeln!</span>(writer, <span class="string">&quot;Message: &#123;&#125;&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 停止执行</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        core::hint::<span class="title function_ invoke__">spin_loop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="panic-“abort”-配置"><a href="#panic-“abort”-配置" class="headerlink" title="panic &#x3D; “abort” 配置"></a>panic &#x3D; “abort” 配置</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.dev]</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 abort 时，可以更简单</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// abort 模式下不会进行栈展开</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="嵌入式开发"><a href="#嵌入式开发" class="headerlink" title="嵌入式开发"></a>嵌入式开发</h2><h3 id="项目结构-1"><a href="#项目结构-1" class="headerlink" title="项目结构"></a>项目结构</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">embedded_project/</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── .cargo/</span><br><span class="line">│   └── config.toml</span><br><span class="line">├── memory.x              # 链接脚本</span><br><span class="line">├── build.rs</span><br><span class="line">└── src/</span><br><span class="line">    ├── main.rs</span><br><span class="line">    └── lib.rs</span><br></pre></td></tr></table></figure></div>

<h3 id="Cortex-M-示例"><a href="#Cortex-M-示例" class="headerlink" title="Cortex-M 示例"></a>Cortex-M 示例</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;embedded_app&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">cortex-m</span> = <span class="string">&quot;0.7&quot;</span></span><br><span class="line"><span class="attr">cortex-m-rt</span> = <span class="string">&quot;0.7&quot;</span></span><br><span class="line"><span class="attr">panic-halt</span> = <span class="string">&quot;0.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体芯片 HAL（以 STM32F4 为例）</span></span><br><span class="line"><span class="comment"># stm32f4xx-hal = &#123; version = &quot;0.17&quot;, features = [&quot;stm32f411&quot;] &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="string">&quot;z&quot;</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">true</span>  <span class="comment"># 保留调试符号</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .cargo/config.toml</span></span><br><span class="line"><span class="section">[target.thumbv7em-none-eabihf]</span></span><br><span class="line"><span class="attr">runner</span> = <span class="string">&quot;probe-rs run --chip STM32F411CEUx&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rustflags</span> = [</span><br><span class="line">  <span class="string">&quot;-C&quot;</span>, <span class="string">&quot;link-arg=-Tlink.x&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[build]</span></span><br><span class="line"><span class="attr">target</span> = <span class="string">&quot;thumbv7em-none-eabihf&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memory.x</span></span><br><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">  FLASH : ORIGIN = <span class="number">0x08000000</span>, LENGTH = <span class="number">512</span>K</span><br><span class="line">  RAM   : ORIGIN = <span class="number">0x20000000</span>, LENGTH = <span class="number">128</span>K</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> cortex_m_rt::entry;</span><br><span class="line"><span class="keyword">use</span> panic_halt <span class="keyword">as</span> _;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[entry]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// 获取外设</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">peripherals</span> = cortex_m::Peripherals::<span class="title function_ invoke__">take</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 主循环</span></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// 延时</span></span><br><span class="line">        cortex_m::asm::<span class="title function_ invoke__">delay</span>(<span class="number">1_000_000</span>);</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 做些事情</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="RISC-V-示例"><a href="#RISC-V-示例" class="headerlink" title="RISC-V 示例"></a>RISC-V 示例</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;riscv_app&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">riscv</span> = <span class="string">&quot;0.10&quot;</span></span><br><span class="line"><span class="attr">riscv-rt</span> = <span class="string">&quot;0.11&quot;</span></span><br><span class="line"><span class="attr">panic-halt</span> = <span class="string">&quot;0.2&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .cargo/config.toml</span></span><br><span class="line"><span class="section">[target.riscv32imac-unknown-none-elf]</span></span><br><span class="line"><span class="attr">rustflags</span> = [</span><br><span class="line">  <span class="string">&quot;-C&quot;</span>, <span class="string">&quot;link-arg=-Tmemory.x&quot;</span>,</span><br><span class="line">  <span class="string">&quot;-C&quot;</span>, <span class="string">&quot;link-arg=-Tlink.x&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="section">[build]</span></span><br><span class="line"><span class="attr">target</span> = <span class="string">&quot;riscv32imac-unknown-none-elf&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> riscv_rt::entry;</span><br><span class="line"><span class="keyword">use</span> panic_halt <span class="keyword">as</span> _;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[entry]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        riscv::asm::<span class="title function_ invoke__">wfi</span>();  <span class="comment">// 等待中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="GPIO-操作示例（embedded-hal）"><a href="#GPIO-操作示例（embedded-hal）" class="headerlink" title="GPIO 操作示例（embedded-hal）"></a>GPIO 操作示例（embedded-hal）</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> cortex_m_rt::entry;</span><br><span class="line"><span class="keyword">use</span> panic_halt <span class="keyword">as</span> _;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 embedded-hal traits</span></span><br><span class="line"><span class="keyword">use</span> embedded_hal::digital::v2::&#123;OutputPin, InputPin&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设使用 STM32F4 HAL</span></span><br><span class="line"><span class="comment">// use stm32f4xx_hal::&#123;pac, prelude::*, gpio&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[entry]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// 伪代码示例</span></span><br><span class="line">    <span class="comment">// let dp = pac::Peripherals::take().unwrap();</span></span><br><span class="line">    <span class="comment">// let gpioa = dp.GPIOA.split();</span></span><br><span class="line">    <span class="comment">// let mut led = gpioa.pa5.into_push_pull_output();</span></span><br><span class="line">    <span class="comment">// let button = gpioa.pa0.into_pull_up_input();</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="comment">// if button.is_low().unwrap() &#123;</span></span><br><span class="line">        <span class="comment">//     led.set_high().unwrap();</span></span><br><span class="line">        <span class="comment">// &#125; else &#123;</span></span><br><span class="line">        <span class="comment">//     led.set_low().unwrap();</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="中断处理"><a href="#中断处理" class="headerlink" title="中断处理"></a>中断处理</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> cortex_m::peripheral::NVIC;</span><br><span class="line"><span class="keyword">use</span> cortex_m_rt::&#123;entry, exception&#125;;</span><br><span class="line"><span class="keyword">use</span> panic_halt <span class="keyword">as</span> _;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中断处理</span></span><br><span class="line"><span class="meta">#[exception]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">SysTick</span>() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">mut</span> COUNT: <span class="type">u32</span> = <span class="number">0</span>;</span><br><span class="line">    *COUNT += <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理定时器中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 硬件故障处理</span></span><br><span class="line"><span class="meta">#[exception]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">HardFault</span>(ef: &amp;cortex_m_rt::ExceptionFrame) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// 记录错误信息</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_</span> = ef;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义中断（设备特定）</span></span><br><span class="line"><span class="comment">// #[interrupt]</span></span><br><span class="line"><span class="comment">// fn EXTI0() &#123;</span></span><br><span class="line"><span class="comment">//     // 处理外部中断</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[entry]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">peripherals</span> = cortex_m::Peripherals::<span class="title function_ invoke__">take</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 配置 SysTick</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">sysclk</span> = <span class="number">8_000_000</span>; <span class="comment">// 8 MHz</span></span><br><span class="line">    peripherals.SYST.<span class="title function_ invoke__">set_reload</span>(sysclk / <span class="number">1000</span> - <span class="number">1</span>); <span class="comment">// 1ms</span></span><br><span class="line">    peripherals.SYST.<span class="title function_ invoke__">clear_current</span>();</span><br><span class="line">    peripherals.SYST.<span class="title function_ invoke__">enable_counter</span>();</span><br><span class="line">    peripherals.SYST.<span class="title function_ invoke__">enable_interrupt</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        cortex_m::asm::<span class="title function_ invoke__">wfi</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="裸机-OS-开发"><a href="#裸机-OS-开发" class="headerlink" title="裸机&#x2F;OS 开发"></a>裸机&#x2F;OS 开发</h2><h3 id="基本裸机程序（x86-64）"><a href="#基本裸机程序（x86-64）" class="headerlink" title="基本裸机程序（x86_64）"></a>基本裸机程序（x86_64）</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;bare_metal&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.dev]</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x86_64-bare_metal.json（自定义目标）</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;llvm-target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x86_64-unknown-none&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data-layout&quot;</span><span class="punctuation">:</span> <span class="string">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;arch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x86_64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target-endian&quot;</span><span class="punctuation">:</span> <span class="string">&quot;little&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target-pointer-width&quot;</span><span class="punctuation">:</span> <span class="string">&quot;64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;target-c-int-width&quot;</span><span class="punctuation">:</span> <span class="string">&quot;32&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;executables&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;linker-flavor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ld.lld&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;linker&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rust-lld&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;panic-strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;abort&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;disable-redzone&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-mmx,-sse,+soft-float&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="meta">#![feature(asm_const)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VGA 文本模式缓冲区</span></span><br><span class="line"><span class="keyword">const</span> VGA_BUFFER: *<span class="keyword">mut</span> <span class="type">u8</span> = <span class="number">0xb8000</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// 清屏</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..(<span class="number">80</span> * <span class="number">25</span> * <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            *VGA_BUFFER.<span class="title function_ invoke__">add</span>(i) = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 打印 &quot;Hello&quot;</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">hello</span> = <span class="string">b&quot;Hello, Bare Metal!&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">for</span> (i, &amp;byte) <span class="keyword">in</span> hello.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            *VGA_BUFFER.<span class="title function_ invoke__">add</span>(i * <span class="number">2</span>) = byte;</span><br><span class="line">            *VGA_BUFFER.<span class="title function_ invoke__">add</span>(i * <span class="number">2</span> + <span class="number">1</span>) = <span class="number">0x0f</span>; <span class="comment">// 白色前景</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            core::arch::asm!(<span class="string">&quot;hlt&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="VGA-文本缓冲区抽象"><a href="#VGA-文本缓冲区抽象" class="headerlink" title="VGA 文本缓冲区抽象"></a>VGA 文本缓冲区抽象</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::fmt::&#123;<span class="keyword">self</span>, Write&#125;;</span><br><span class="line"><span class="keyword">use</span> core::ptr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> VGA_WIDTH: <span class="type">usize</span> = <span class="number">80</span>;</span><br><span class="line"><span class="keyword">const</span> VGA_HEIGHT: <span class="type">usize</span> = <span class="number">25</span>;</span><br><span class="line"><span class="keyword">const</span> VGA_BUFFER_ADDR: <span class="type">usize</span> = <span class="number">0xb8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(u8)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">Color</span> &#123;</span><br><span class="line">    Black = <span class="number">0</span>,</span><br><span class="line">    Blue = <span class="number">1</span>,</span><br><span class="line">    Green = <span class="number">2</span>,</span><br><span class="line">    Cyan = <span class="number">3</span>,</span><br><span class="line">    Red = <span class="number">4</span>,</span><br><span class="line">    Magenta = <span class="number">5</span>,</span><br><span class="line">    Brown = <span class="number">6</span>,</span><br><span class="line">    LightGray = <span class="number">7</span>,</span><br><span class="line">    DarkGray = <span class="number">8</span>,</span><br><span class="line">    LightBlue = <span class="number">9</span>,</span><br><span class="line">    LightGreen = <span class="number">10</span>,</span><br><span class="line">    LightCyan = <span class="number">11</span>,</span><br><span class="line">    LightRed = <span class="number">12</span>,</span><br><span class="line">    Pink = <span class="number">13</span>,</span><br><span class="line">    Yellow = <span class="number">14</span>,</span><br><span class="line">    White = <span class="number">15</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(transparent)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ColorCode</span>(<span class="type">u8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ColorCode</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>(foreground: Color, background: Color) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">ColorCode</span>((background <span class="keyword">as</span> <span class="type">u8</span>) &lt;&lt; <span class="number">4</span> | (foreground <span class="keyword">as</span> <span class="type">u8</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ScreenChar</span> &#123;</span><br><span class="line">    ascii: <span class="type">u8</span>,</span><br><span class="line">    color: ColorCode,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">    col: <span class="type">usize</span>,</span><br><span class="line">    row: <span class="type">usize</span>,</span><br><span class="line">    color: ColorCode,</span><br><span class="line">    buffer: &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [[ScreenChar; VGA_WIDTH]; VGA_HEIGHT],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Writer &#123;</span><br><span class="line">            col: <span class="number">0</span>,</span><br><span class="line">            row: <span class="number">0</span>,</span><br><span class="line">            color: ColorCode::<span class="title function_ invoke__">new</span>(Color::White, Color::Black),</span><br><span class="line">            buffer: <span class="keyword">unsafe</span> &#123; &amp;<span class="keyword">mut</span> *(VGA_BUFFER_ADDR <span class="keyword">as</span> *<span class="keyword">mut</span> _) &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">write_byte</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, byte: <span class="type">u8</span>) &#123;</span><br><span class="line">        <span class="keyword">match</span> byte &#123;</span><br><span class="line">            <span class="string">b&#x27;\n&#x27;</span> =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">new_line</span>(),</span><br><span class="line">            byte =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.col &gt;= VGA_WIDTH &#123;</span><br><span class="line">                    <span class="keyword">self</span>.<span class="title function_ invoke__">new_line</span>();</span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">                <span class="keyword">self</span>.buffer[<span class="keyword">self</span>.row][<span class="keyword">self</span>.col] = ScreenChar &#123;</span><br><span class="line">                    ascii: byte,</span><br><span class="line">                    color: <span class="keyword">self</span>.color,</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">self</span>.col += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new_line</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.row &lt; VGA_HEIGHT - <span class="number">1</span> &#123;</span><br><span class="line">            <span class="keyword">self</span>.row += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 滚动</span></span><br><span class="line">            <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">1</span>..VGA_HEIGHT &#123;</span><br><span class="line">                <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..VGA_WIDTH &#123;</span><br><span class="line">                    <span class="keyword">self</span>.buffer[row - <span class="number">1</span>][col] = <span class="keyword">self</span>.buffer[row][col];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 清空最后一行</span></span><br><span class="line">            <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..VGA_WIDTH &#123;</span><br><span class="line">                <span class="keyword">self</span>.buffer[VGA_HEIGHT - <span class="number">1</span>][col] = ScreenChar &#123;</span><br><span class="line">                    ascii: <span class="string">b&#x27; &#x27;</span>,</span><br><span class="line">                    color: <span class="keyword">self</span>.color,</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.col = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">clear</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">row</span> <span class="keyword">in</span> <span class="number">0</span>..VGA_HEIGHT &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="variable">col</span> <span class="keyword">in</span> <span class="number">0</span>..VGA_WIDTH &#123;</span><br><span class="line">                <span class="keyword">self</span>.buffer[row][col] = ScreenChar &#123;</span><br><span class="line">                    ascii: <span class="string">b&#x27; &#x27;</span>,</span><br><span class="line">                    color: <span class="keyword">self</span>.color,</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.col = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.row = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Write</span> <span class="keyword">for</span> <span class="title class_">Writer</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">write_str</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, s: &amp;<span class="type">str</span>) <span class="punctuation">-&gt;</span> fmt::<span class="type">Result</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">byte</span> <span class="keyword">in</span> s.<span class="title function_ invoke__">bytes</span>() &#123;</span><br><span class="line">            <span class="keyword">match</span> byte &#123;</span><br><span class="line">                <span class="number">0x20</span>..=<span class="number">0x7e</span> | <span class="string">b&#x27;\n&#x27;</span> =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">write_byte</span>(byte),</span><br><span class="line">                _ =&gt; <span class="keyword">self</span>.<span class="title function_ invoke__">write_byte</span>(<span class="number">0xfe</span>), <span class="comment">// ■</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局写入器</span></span><br><span class="line"><span class="keyword">use</span> spin::Mutex;</span><br><span class="line"></span><br><span class="line">lazy_static::lazy_static! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> WRITER: Mutex&lt;Writer&gt; = Mutex::<span class="title function_ invoke__">new</span>(Writer::<span class="title function_ invoke__">new</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印宏</span></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> print &#123;</span><br><span class="line">    ($($arg:tt)*) =&gt; &#123;</span><br><span class="line">        $crate::vga::_print(<span class="built_in">format_args!</span>($($arg)*))</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> println &#123;</span><br><span class="line">    () =&gt; ($crate::<span class="built_in">print!</span>(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">    ($($arg:tt)*) =&gt; ($crate::<span class="built_in">print!</span>(<span class="string">&quot;&#123;&#125;\n&quot;</span>, <span class="built_in">format_args!</span>($($arg)*)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">_print</span>(args: fmt::Arguments) &#123;</span><br><span class="line">    <span class="keyword">use</span> core::fmt::Write;</span><br><span class="line">    WRITER.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">write_fmt</span>(args).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="简单内存管理"><a href="#简单内存管理" class="headerlink" title="简单内存管理"></a>简单内存管理</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::alloc::&#123;GlobalAlloc, Layout&#125;;</span><br><span class="line"><span class="keyword">use</span> core::ptr::NonNull;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单的固定块分配器</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">FixedBlockAllocator</span> &#123;</span><br><span class="line">    <span class="comment">// 不同大小的块</span></span><br><span class="line">    blocks_16: FreeList&lt;<span class="number">16</span>&gt;,</span><br><span class="line">    blocks_64: FreeList&lt;<span class="number">64</span>&gt;,</span><br><span class="line">    blocks_256: FreeList&lt;<span class="number">256</span>&gt;,</span><br><span class="line">    blocks_1024: FreeList&lt;<span class="number">1024</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FreeList</span>&lt;<span class="keyword">const</span> SIZE: <span class="type">usize</span>&gt; &#123;</span><br><span class="line">    head: <span class="type">Option</span>&lt;NonNull&lt;FreeNode&gt;&gt;,</span><br><span class="line">    area_start: <span class="type">usize</span>,</span><br><span class="line">    area_end: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FreeNode</span> &#123;</span><br><span class="line">    next: <span class="type">Option</span>&lt;NonNull&lt;FreeNode&gt;&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="keyword">const</span> SIZE: <span class="type">usize</span>&gt; FreeList&lt;SIZE&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        FreeList &#123;</span><br><span class="line">            head: <span class="literal">None</span>,</span><br><span class="line">            area_start: <span class="number">0</span>,</span><br><span class="line">            area_end: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, start: <span class="type">usize</span>, size: <span class="type">usize</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.area_start = start;</span><br><span class="line">        <span class="keyword">self</span>.area_end = start + size;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 初始化空闲链表</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">block_count</span> = size / SIZE;</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..block_count &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">block_addr</span> = start + i * SIZE;</span><br><span class="line">            <span class="keyword">self</span>.<span class="title function_ invoke__">push</span>(block_addr <span class="keyword">as</span> *<span class="keyword">mut</span> FreeNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">push</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, node: *<span class="keyword">mut</span> FreeNode) &#123;</span><br><span class="line">        (*node).next = <span class="keyword">self</span>.head;</span><br><span class="line">        <span class="keyword">self</span>.head = <span class="title function_ invoke__">Some</span>(NonNull::<span class="title function_ invoke__">new_unchecked</span>(node));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">pop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;*<span class="keyword">mut</span> <span class="type">u8</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.head.<span class="title function_ invoke__">map</span>(|node| &#123;</span><br><span class="line">            <span class="keyword">unsafe</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.head = node.<span class="title function_ invoke__">as_ref</span>().next;</span><br><span class="line">                node.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FixedBlockAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        FixedBlockAllocator &#123;</span><br><span class="line">            blocks_16: FreeList::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            blocks_64: FreeList::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            blocks_256: FreeList::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">            blocks_1024: FreeList::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_size_class</span>(size: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">match</span> size &#123;</span><br><span class="line">            <span class="number">0</span>..=<span class="number">16</span> =&gt; <span class="title function_ invoke__">Some</span>(<span class="number">16</span>),</span><br><span class="line">            <span class="number">17</span>..=<span class="number">64</span> =&gt; <span class="title function_ invoke__">Some</span>(<span class="number">64</span>),</span><br><span class="line">            <span class="number">65</span>..=<span class="number">256</span> =&gt; <span class="title function_ invoke__">Some</span>(<span class="number">256</span>),</span><br><span class="line">            <span class="number">257</span>..=<span class="number">1024</span> =&gt; <span class="title function_ invoke__">Some</span>(<span class="number">1024</span>),</span><br><span class="line">            _ =&gt; <span class="literal">None</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsafe</span> <span class="keyword">impl</span> <span class="title class_">GlobalAlloc</span> <span class="keyword">for</span> <span class="title class_">FixedBlockAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">self</span>, layout: Layout) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> <span class="type">u8</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">size</span> = layout.<span class="title function_ invoke__">size</span>().<span class="title function_ invoke__">max</span>(layout.<span class="title function_ invoke__">align</span>());</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 选择合适大小的块</span></span><br><span class="line">        <span class="comment">// 实际实现需要更复杂的逻辑</span></span><br><span class="line">        core::ptr::<span class="title function_ invoke__">null_mut</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">self</span>, ptr: *<span class="keyword">mut</span> <span class="type">u8</span>, layout: Layout) &#123;</span><br><span class="line">        <span class="comment">// 返回块到对应的空闲链表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="常用-no-std-Crate"><a href="#常用-no-std-Crate" class="headerlink" title="常用 no_std Crate"></a>常用 no_std Crate</h2><h3 id="核心工具"><a href="#核心工具" class="headerlink" title="核心工具"></a>核心工具</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">embassy-executor</span> = &#123; version = <span class="string">&quot;0.5&quot;</span>, features = [<span class="string">&quot;arch-cortex-m&quot;</span>, <span class="string">&quot;executor-thread&quot;</span>] &#125;</span><br><span class="line"><span class="attr">embassy-stm32</span> = &#123; version = <span class="string">&quot;0.1&quot;</span>, features = [<span class="string">&quot;stm32f411ce&quot;</span>, <span class="string">&quot;time-driver-any&quot;</span>] &#125;</span><br><span class="line"><span class="attr">embassy-time</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"><span class="attr">embassy-sync</span> = <span class="string">&quot;0.6&quot;</span></span><br><span class="line"><span class="attr">defmt</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"><span class="attr">defmt-rtt</span> = <span class="string">&quot;0.4&quot;</span></span><br><span class="line"><span class="attr">panic-probe</span> = &#123; version = <span class="string">&quot;0.3&quot;</span>, features = [<span class="string">&quot;print-defmt&quot;</span>] &#125;</span><br><span class="line"><span class="comment"># 数据结构</span></span><br><span class="line"><span class="attr">heapless</span> = <span class="string">&quot;0.8&quot;</span>           <span class="comment"># 固定容量集合</span></span><br><span class="line"><span class="attr">arrayvec</span> = &#123; version = <span class="string">&quot;0.7&quot;</span>, default-features = <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步原语</span></span><br><span class="line"><span class="attr">spin</span> = <span class="string">&quot;0.9&quot;</span>               <span class="comment"># 自旋锁</span></span><br><span class="line"><span class="attr">lock_api</span> = <span class="string">&quot;0.4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字符串处理</span></span><br><span class="line"><span class="attr">ufmt</span> = <span class="string">&quot;0.2&quot;</span>               <span class="comment"># 轻量级格式化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 位操作</span></span><br><span class="line"><span class="attr">bitflags</span> = <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attr">bitfield</span> = <span class="string">&quot;0.14&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化</span></span><br><span class="line"><span class="attr">serde</span> = &#123; version = <span class="string">&quot;1&quot;</span>, default-features = <span class="literal">false</span> &#125;</span><br><span class="line"><span class="attr">postcard</span> = <span class="string">&quot;1&quot;</span>             <span class="comment"># no_std 友好的序列化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 哈希</span></span><br><span class="line"><span class="attr">hashbrown</span> = &#123; version = <span class="string">&quot;0.14&quot;</span>, default-features = <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 错误处理</span></span><br><span class="line"><span class="attr">thiserror-no-std</span> = <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line"><span class="attr">log</span> = <span class="string">&quot;0.4&quot;</span></span><br><span class="line"><span class="attr">defmt</span> = <span class="string">&quot;0.3&quot;</span>              <span class="comment"># 嵌入式日志框架</span></span><br></pre></td></tr></table></figure></div>

<h3 id="heapless-示例"><a href="#heapless-示例" class="headerlink" title="heapless 示例"></a>heapless 示例</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> heapless::&#123;<span class="type">Vec</span>, <span class="type">String</span>, FnvIndexMap&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 固定容量 Vec</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">use_heapless_vec</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span>: <span class="type">Vec</span>&lt;<span class="type">i32</span>, <span class="number">16</span>&gt; = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();  <span class="comment">// 最多 16 个元素</span></span><br><span class="line">  </span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    v.<span class="title function_ invoke__">push</span>(<span class="number">2</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> <span class="variable">item</span> <span class="keyword">in</span> &amp;v &#123;</span><br><span class="line">        <span class="comment">// 使用 item</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 固定容量 String</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">use_heapless_string</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">s</span>: <span class="type">String</span>&lt;<span class="number">64</span>&gt; = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 使用 write! 宏</span></span><br><span class="line">    <span class="keyword">use</span> core::fmt::Write;</span><br><span class="line">    <span class="built_in">write!</span>(s, <span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, <span class="string">&quot;world&quot;</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 固定容量 HashMap</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">use_heapless_map</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map</span>: FnvIndexMap&lt;&amp;<span class="type">str</span>, <span class="type">i32</span>, <span class="number">16</span>&gt; = FnvIndexMap::<span class="title function_ invoke__">new</span>();</span><br><span class="line">  </span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;one&quot;</span>, <span class="number">1</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    map.<span class="title function_ invoke__">insert</span>(<span class="string">&quot;two&quot;</span>, <span class="number">2</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(val) = map.<span class="title function_ invoke__">get</span>(<span class="string">&quot;one&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用 val</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 队列</span></span><br><span class="line"><span class="keyword">use</span> heapless::spsc::Queue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">mut</span> QUEUE: Queue&lt;<span class="type">u32</span>, <span class="number">8</span>&gt; = Queue::<span class="title function_ invoke__">new</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">producer</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">producer</span> = QUEUE.<span class="title function_ invoke__">split</span>().<span class="number">0</span>;</span><br><span class="line">        producer.<span class="title function_ invoke__">enqueue</span>(<span class="number">42</span>).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">consumer</span>() &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">consumer</span> = QUEUE.<span class="title function_ invoke__">split</span>().<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(val) = consumer.<span class="title function_ invoke__">dequeue</span>() &#123;</span><br><span class="line">            <span class="comment">// 处理 val</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="embedded-hal-生态"><a href="#embedded-hal-生态" class="headerlink" title="embedded-hal 生态"></a>embedded-hal 生态</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> embedded_hal::&#123;</span><br><span class="line">    digital::&#123;InputPin, OutputPin, StatefulOutputPin&#125;,</span><br><span class="line">    delay::DelayNs,</span><br><span class="line">    spi::SpiDevice,</span><br><span class="line">    i2c::I2c,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型驱动（可在任何平台使用）</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">SensorDriver</span>&lt;SPI&gt; &#123;</span><br><span class="line">    spi: SPI,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;SPI, E&gt; SensorDriver&lt;SPI&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    SPI: SpiDevice&lt;Error = E&gt;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(spi: SPI) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        SensorDriver &#123; spi &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">read_value</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">u16</span>, E&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">buf</span> = [<span class="number">0u8</span>; <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">self</span>.spi.<span class="title function_ invoke__">transfer_in_place</span>(&amp;<span class="keyword">mut</span> buf)?;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(<span class="type">u16</span>::<span class="title function_ invoke__">from_be_bytes</span>(buf))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LED 驱动</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Led</span>&lt;PIN&gt; &#123;</span><br><span class="line">    pin: PIN,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;PIN: OutputPin&gt; Led&lt;PIN&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(pin: PIN) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        Led &#123; pin &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">on</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), PIN::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.pin.<span class="title function_ invoke__">set_high</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">off</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), PIN::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.pin.<span class="title function_ invoke__">set_low</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;PIN: StatefulOutputPin&gt; Led&lt;PIN&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">toggle</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), PIN::Error&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.pin.<span class="title function_ invoke__">toggle</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 延时闪烁</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">blink</span>&lt;PIN, DELAY&gt;(led: &amp;<span class="keyword">mut</span> Led&lt;PIN&gt;, delay: &amp;<span class="keyword">mut</span> DELAY, times: <span class="type">u32</span>)</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    PIN: OutputPin,</span><br><span class="line">    DELAY: DelayNs,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">_</span> <span class="keyword">in</span> <span class="number">0</span>..times &#123;</span><br><span class="line">        led.<span class="title function_ invoke__">on</span>().<span class="title function_ invoke__">ok</span>();</span><br><span class="line">        delay.<span class="title function_ invoke__">delay_ms</span>(<span class="number">500</span>);</span><br><span class="line">        led.<span class="title function_ invoke__">off</span>().<span class="title function_ invoke__">ok</span>();</span><br><span class="line">        delay.<span class="title function_ invoke__">delay_ms</span>(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="defmt-日志"><a href="#defmt-日志" class="headerlink" title="defmt 日志"></a>defmt 日志</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">defmt</span> = <span class="string">&quot;0.3&quot;</span></span><br><span class="line"><span class="attr">defmt-rtt</span> = <span class="string">&quot;0.4&quot;</span>  <span class="comment"># RTT 传输</span></span><br><span class="line"><span class="attr">panic-probe</span> = &#123; version = <span class="string">&quot;0.3&quot;</span>, features = [<span class="string">&quot;print-defmt&quot;</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> defmt::&#123;info, warn, error, debug, trace&#125;;</span><br><span class="line"><span class="keyword">use</span> defmt_rtt <span class="keyword">as</span> _;</span><br><span class="line"><span class="keyword">use</span> panic_probe <span class="keyword">as</span> _;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cortex_m_rt::entry]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    info!(<span class="string">&quot;Application started&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = <span class="number">42</span>;</span><br><span class="line">    debug!(<span class="string">&quot;Value: &#123;&#125;&quot;</span>, value);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 结构化日志</span></span><br><span class="line">    <span class="meta">#[derive(defmt::Format)]</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">SensorReading</span> &#123;</span><br><span class="line">        temperature: <span class="type">i16</span>,</span><br><span class="line">        humidity: <span class="type">u8</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">reading</span> = SensorReading &#123;</span><br><span class="line">        temperature: <span class="number">25</span>,</span><br><span class="line">        humidity: <span class="number">60</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  </span><br><span class="line">    info!(<span class="string">&quot;Sensor reading: &#123;:?&#125;&quot;</span>, reading);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        trace!(<span class="string">&quot;Loop iteration&quot;</span>);</span><br><span class="line">        cortex_m::asm::<span class="title function_ invoke__">wfi</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="测试-no-std-代码"><a href="#测试-no-std-代码" class="headerlink" title="测试 no_std 代码"></a>测试 no_std 代码</h2><h3 id="主机测试"><a href="#主机测试" class="headerlink" title="主机测试"></a>主机测试</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib.rs</span></span><br><span class="line"><span class="meta">#![cfg_attr(not(test), no_std)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">add</span>(a: <span class="type">i32</span>, b: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    a + b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="keyword">use</span> super::*;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">test_add</span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="title function_ invoke__">add</span>(<span class="number">1</span>, <span class="number">2</span>), <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="QEMU-测试"><a href="#QEMU-测试" class="headerlink" title="QEMU 测试"></a>QEMU 测试</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;no_std_tests&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[test]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;should_panic&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[test]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;integration&quot;</span></span><br><span class="line"><span class="attr">harness</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dev-dependencies]</span></span><br><span class="line"><span class="attr">x86_64</span> = <span class="string">&quot;0.14&quot;</span></span><br><span class="line"><span class="attr">uart_16550</span> = <span class="string">&quot;0.2&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tests/should_panic.rs</span></span><br><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"><span class="meta">#![feature(custom_test_frameworks)]</span></span><br><span class="line"><span class="meta">#![test_runner(test_runner)]</span></span><br><span class="line"><span class="meta">#![reexport_test_harness_main = <span class="string">&quot;test_main&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">test_main</span>();</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">test_runner</span>(tests: &amp;[&amp;<span class="keyword">dyn</span> <span class="title function_ invoke__">Fn</span>()]) &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">test</span> <span class="keyword">in</span> tests &#123;</span><br><span class="line">        <span class="title function_ invoke__">test</span>();</span><br><span class="line">        <span class="comment">// 如果没有 panic，测试失败</span></span><br><span class="line">        <span class="title function_ invoke__">exit_qemu</span>(QemuExitCode::Failed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">exit_qemu</span>(QemuExitCode::Success);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">exit_qemu</span>(exit_code: QemuExitCode) &#123;</span><br><span class="line">    <span class="keyword">use</span> x86_64::instructions::port::Port;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">port</span> = Port::<span class="title function_ invoke__">new</span>(<span class="number">0xf4</span>);</span><br><span class="line">        port.<span class="title function_ invoke__">write</span>(exit_code <span class="keyword">as</span> <span class="type">u32</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[repr(u32)]</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">QemuExitCode</span> &#123;</span><br><span class="line">    Success = <span class="number">0x10</span>,</span><br><span class="line">    Failed = <span class="number">0x11</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_info: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="title function_ invoke__">exit_qemu</span>(QemuExitCode::Success);</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[test_case]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">should_panic</span>() &#123;</span><br><span class="line">    <span class="built_in">panic!</span>(<span class="string">&quot;This should panic&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="使用-probe-rs-测试"><a href="#使用-probe-rs-测试" class="headerlink" title="使用 probe-rs 测试"></a>使用 probe-rs 测试</h3><div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">cargo install probe-rs --features cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行测试</span></span><br><span class="line">cargo <span class="built_in">test</span> --target thumbv7em-none-eabihf</span><br></pre></td></tr></table></figure></div>

<hr>
<h2 id="优化技巧"><a href="#优化技巧" class="headerlink" title="优化技巧"></a>优化技巧</h2><h3 id="减小二进制大小"><a href="#减小二进制大小" class="headerlink" title="减小二进制大小"></a>减小二进制大小</h3><div class="code-container" data-rel="Toml"><figure class="iseeu highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[profile.release]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="string">&quot;z&quot;</span>      <span class="comment"># 优化大小</span></span><br><span class="line"><span class="attr">lto</span> = <span class="literal">true</span>           <span class="comment"># 链接时优化</span></span><br><span class="line"><span class="attr">codegen-units</span> = <span class="number">1</span>    <span class="comment"># 单代码生成单元</span></span><br><span class="line"><span class="attr">panic</span> = <span class="string">&quot;abort&quot;</span>      <span class="comment"># 不需要展开</span></span><br><span class="line"><span class="attr">strip</span> = <span class="literal">true</span>         <span class="comment"># 去除符号</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile.release.build-override]</span></span><br><span class="line"><span class="attr">opt-level</span> = <span class="string">&quot;z&quot;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 避免泛型膨胀</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process</span>&lt;T: <span class="built_in">AsRef</span>&lt;[<span class="type">u8</span>]&gt;&gt;(data: T) &#123;</span><br><span class="line">    <span class="title function_ invoke__">process_inner</span>(data.<span class="title function_ invoke__">as_ref</span>())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非泛型内部实现</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">process_inner</span>(data: &amp;[<span class="type">u8</span>]) &#123;</span><br><span class="line">    <span class="comment">// 实际逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 #[inline(never)] 防止内联导致的膨胀</span></span><br><span class="line"><span class="meta">#[inline(never)]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">large_function</span>() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="零成本抽象"><a href="#零成本抽象" class="headerlink" title="零成本抽象"></a>零成本抽象</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译时常量</span></span><br><span class="line"><span class="keyword">const</span> BUFFER_SIZE: <span class="type">usize</span> = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 零开销类型状态</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Uart</span>&lt;STATE&gt; &#123;</span><br><span class="line">    _state: core::marker::PhantomData&lt;STATE&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Disabled</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Enabled</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Uart</span>&lt;Disabled&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">enable</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Uart&lt;Enabled&gt; &#123;</span><br><span class="line">        <span class="comment">// 配置硬件</span></span><br><span class="line">        Uart &#123; _state: core::marker::PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Uart</span>&lt;Enabled&gt; &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">send</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, byte: <span class="type">u8</span>) &#123;</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">disable</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> Uart&lt;Disabled&gt; &#123;</span><br><span class="line">        Uart &#123; _state: core::marker::PhantomData &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译时保证：只有 Enabled 状态可以 send</span></span><br></pre></td></tr></table></figure></div>

<h3 id="内存对齐优化"><a href="#内存对齐优化" class="headerlink" title="内存对齐优化"></a>内存对齐优化</h3><div class="code-container" data-rel="Rust"><figure class="iseeu highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动控制对齐</span></span><br><span class="line"><span class="meta">#[repr(align(4))]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Aligned4</span> &#123;</span><br><span class="line">    data: [<span class="type">u8</span>; <span class="number">3</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 紧凑结构体</span></span><br><span class="line"><span class="meta">#[repr(packed)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Packed</span> &#123;</span><br><span class="line">    a: <span class="type">u8</span>,</span><br><span class="line">    b: <span class="type">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C 兼容布局</span></span><br><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CCompatible</span> &#123;</span><br><span class="line">    field1: <span class="type">u32</span>,</span><br><span class="line">    field2: <span class="type">u16</span>,</span><br><span class="line">    field3: <span class="type">u8</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p><em>好了，你现在已经了解 Rust 的基本使用了，请用它来写一个操作系统吧！</em></p>
<h1 id="版本更新变化"><a href="#版本更新变化" class="headerlink" title="版本更新变化"></a>版本更新变化</h1>
		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Rust语言编程</li>
        <li><strong>Author:</strong> 韩乔落</li>
        <li><strong>Created at
                :</strong> 2025-01-23 14:48:23</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-12-31 16:45:59
            </li>
        
        <li>
            <strong>Link:</strong> https://jelasin.github.io/2025/01/23/Rust语言编程/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/01/23/CPP%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">CPP语言编程</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/01/23/C++%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A8%8B%E4%B9%8BSTL%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">C++语言编程之STL内部实现</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'jelasin/jelasin.github.io',
                'data-repo-id': 'R_kgDOKVydDA',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDOKVydDM4CZe2W',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'not-lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Rust语言编程</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rust%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-text">Rust中的变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E5%91%BD%E5%90%8D"><span class="nav-text">变量命名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E7%BB%91%E5%AE%9A"><span class="nav-text">变量绑定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-text">变量可变性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%BD%E7%95%A5%E6%9C%AA%E4%BD%BF%E7%94%A8%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-text">忽略未使用的变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E8%A7%A3%E6%9E%84"><span class="nav-text">变量解构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%84%E5%BC%8F%E8%B5%8B%E5%80%BC"><span class="nav-text">解构式赋值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B8%B8%E9%87%8F"><span class="nav-text">变量与常量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E9%81%AE%E8%94%BD"><span class="nav-text">变量遮蔽</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B"><span class="nav-text">基本类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="nav-text">数值类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E6%95%B0%E7%B1%BB%E5%9E%8B"><span class="nav-text">整数类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="nav-text">浮点类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E5%AD%97%E8%BF%90%E7%AE%97"><span class="nav-text">数字运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="nav-text">位运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97-Range"><span class="nav-text">序列(Range)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E7%B1%BB%E5%9E%8B"><span class="nav-text">字符类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B"><span class="nav-text">布尔类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E7%B1%BB%E5%9E%8B"><span class="nav-text">单元类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%AD%E5%8F%A5%E5%92%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">语句和表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E5%8F%A5"><span class="nav-text">语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">表达式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0"><span class="nav-text">函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0"><span class="nav-text">函数参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E"><span class="nav-text">函数返回</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E6%9D%83%E5%92%8C%E5%80%9F%E7%94%A8"><span class="nav-text">所有权和借用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E6%9D%83"><span class="nav-text">所有权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-text">变量作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E6%9D%83%E8%BD%AC%E7%A7%BB"><span class="nav-text">所有权转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%BC%A0%E5%80%BC%E5%92%8C%E8%BF%94%E5%9B%9E"><span class="nav-text">函数传值和返回</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E5%92%8C%E5%80%9F%E7%94%A8"><span class="nav-text">引用和借用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E4%B8%8E%E8%A7%A3%E5%BC%95%E7%94%A8"><span class="nav-text">引用与解引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8"><span class="nav-text">不可变引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E5%BC%95%E7%94%A8"><span class="nav-text">可变引用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NLL%EF%BC%88%E9%9D%9E%E8%AF%8D%E6%B3%95%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%89"><span class="nav-text">NLL（非词法生命周期）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="nav-text">复合类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">字符串</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E6%A0%B8%E5%BF%83%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="nav-text">两种核心字符串类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E5%AF%B9%E6%AF%94"><span class="nav-text">内存布局对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-text">String 常用操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UTF-8-%E7%BC%96%E7%A0%81%E7%89%B9%E6%80%A7"><span class="nav-text">UTF-8 编码特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="nav-text">类型转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deref-%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">Deref 强制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%B8%8E%E5%AE%9E%E8%B7%B5"><span class="nav-text">性能与实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%87%E7%89%87"><span class="nav-text">切片</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E7%89%87%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">切片基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E7%89%87%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">切片的内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E7%89%87%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="nav-text">切片语法详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%88%87%E7%89%87%E7%B1%BB%E5%9E%8B"><span class="nav-text">常见切片类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E7%89%87%E4%B8%8E%E6%89%80%E6%9C%89%E6%9D%83%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">切片与所有权类型的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E7%89%87%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">切片常用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E4%B8%AD%E7%9A%84%E5%88%87%E7%89%87"><span class="nav-text">函数参数中的切片</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%83%E7%BB%84"><span class="nav-text">元组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E7%BB%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">元组基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E7%BB%84%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E7%B1%BB%E5%9E%8B"><span class="nav-text">元组的创建与类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%85%83%E7%BB%84%E5%85%83%E7%B4%A0"><span class="nav-text">访问元组元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E7%B1%BB%E5%9E%8B-1"><span class="nav-text">单元类型 ()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E7%BB%84%E4%B8%8E%E5%87%BD%E6%95%B0"><span class="nav-text">元组与函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">结构体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%BD%A2%E5%BC%8F"><span class="nav-text">结构体形式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">创建与初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%AE%BF%E9%97%AE%E4%B8%8E%E4%BF%AE%E6%94%B9"><span class="nav-text">字段访问与修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%80%E6%9C%89%E6%9D%83%E4%B8%8E%E5%80%9F%E7%94%A8"><span class="nav-text">所有权与借用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80-1"><span class="nav-text">内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">打印结构体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE"><span class="nav-text">枚举</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%9E%9A%E4%B8%BE%E5%AE%9A%E4%B9%89"><span class="nav-text">基本枚举定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%88%A4%E5%88%AB%E5%80%BC"><span class="nav-text">枚举的判别值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%9E%9A%E4%B8%BE"><span class="nav-text">核心枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80-2"><span class="nav-text">内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E7%BB%84"><span class="nav-text">数组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%88%9B%E5%BB%BA"><span class="nav-text">基本定义与创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E7%B4%A0%E8%AE%BF%E9%97%AE"><span class="nav-text">元素访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84"><span class="nav-text">遍历数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">常用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84"><span class="nav-text">多维数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80-3"><span class="nav-text">内存布局</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="nav-text">流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="nav-text">条件判断</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#if-else-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">if&#x2F;else 表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if-let-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">if let 表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#let-else-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">let else 表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#matches-%E5%AE%8F"><span class="nav-text">matches! 宏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E6%8E%A7%E5%88%B6"><span class="nav-text">循环控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loop-%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF"><span class="nav-text">loop 无限循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#while-%E6%9D%A1%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="nav-text">while 条件循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#while-let-%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D%E5%BE%AA%E7%8E%AF"><span class="nav-text">while let 模式匹配循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#for-%E8%BF%AD%E4%BB%A3%E5%BE%AA%E7%8E%AF"><span class="nav-text">for 迭代循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E6%8E%A7%E5%88%B6"><span class="nav-text">跳转控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#break-%E9%80%80%E5%87%BA%E5%BE%AA%E7%8E%AF"><span class="nav-text">break 退出循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#continue-%E8%B7%B3%E8%BF%87%E8%BF%AD%E4%BB%A3"><span class="nav-text">continue 跳过迭代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#return-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E"><span class="nav-text">return 函数返回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E7%AD%BE%E5%9D%97%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">标签块表达式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="nav-text">模式匹配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#match-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">match 表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A"><span class="nav-text">@ 绑定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%BC%8F%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3"><span class="nav-text">模式语法详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-text">错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">? 运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#panic-%E5%AE%8F"><span class="nav-text">panic! 宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unwrap-%E5%92%8C-expect"><span class="nav-text">unwrap 和 expect</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9D%97%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">块表达式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%B9%E6%B3%95-Method"><span class="nav-text">方法 Method</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#self-%E7%9A%84%E4%B8%89%E7%A7%8D%E5%BD%A2%E5%BC%8F"><span class="nav-text">self 的三种形式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%BC%95%E7%94%A8%E5%92%8C%E8%A7%A3%E5%BC%95%E7%94%A8"><span class="nav-text">自动引用和解引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA-impl-%E5%9D%97"><span class="nav-text">多个 impl 块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E4%B8%8A%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-text">枚举上的方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-text">方法链式调用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%9B%E5%9E%8B-Generics"><span class="nav-text">泛型 Generics</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-1"><span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E6%B3%9B%E5%9E%8B"><span class="nav-text">函数泛型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E6%B3%9B%E5%9E%8B"><span class="nav-text">结构体泛型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E6%B3%9B%E5%9E%8B"><span class="nav-text">枚举泛型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E6%B3%9B%E5%9E%8B"><span class="nav-text">方法泛型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trait-Bounds%EF%BC%88%E7%89%B9%E5%BE%81%E7%BA%A6%E6%9D%9F%EF%BC%89"><span class="nav-text">Trait Bounds（特征约束）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-1"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%BA%A6%E6%9D%9F%E6%A8%A1%E5%BC%8F"><span class="nav-text">常见约束模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E7%A4%BA%E4%BE%8B"><span class="nav-text">实际示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#impl-Trait-%E8%AF%AD%E6%B3%95%E7%B3%96"><span class="nav-text">impl Trait 语法糖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#const-%E6%B3%9B%E5%9E%8B%EF%BC%88%E5%B8%B8%E9%87%8F%E6%B3%9B%E5%9E%8B%EF%BC%89"><span class="nav-text">const 泛型（常量泛型）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E7%B1%BB%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="nav-text">默认类型参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E6%80%81%E5%8C%96%EF%BC%88%E9%9B%B6%E6%88%90%E6%9C%AC%E6%8A%BD%E8%B1%A1%EF%BC%89"><span class="nav-text">单态化（零成本抽象）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">常见使用模式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%B9%E5%BE%81-Trait"><span class="nav-text">特征 Trait</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-2"><span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-2"><span class="nav-text">基本语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89-Trait"><span class="nav-text">定义 Trait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-Trait"><span class="nav-text">实现 Trait</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%AE%9E%E7%8E%B0"><span class="nav-text">默认实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trait-%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0"><span class="nav-text">Trait 作为参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E7%AD%89%E4%BB%B7%E5%86%99%E6%B3%95"><span class="nav-text">三种等价写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%87%8D%E7%BA%A6%E6%9D%9F"><span class="nav-text">多重约束</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trait-%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-text">Trait 作为返回值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%A0%87%E5%87%86%E5%BA%93-Trait"><span class="nav-text">常用标准库 Trait</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B4%BE%E7%94%9F%E5%AE%8F-derive"><span class="nav-text">派生宏 (derive)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E6%B4%BE%E7%94%9F%E7%9A%84-Trait"><span class="nav-text">可派生的 Trait</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E7%B1%BB%E5%9E%8B"><span class="nav-text">关联类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E7%B1%BB%E5%9E%8B-vs-%E6%B3%9B%E5%9E%8B%E5%8F%82%E6%95%B0"><span class="nav-text">关联类型 vs 泛型参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%A4%E5%84%BF%E8%A7%84%E5%88%99-Orphan-Rule"><span class="nav-text">孤儿规则 (Orphan Rule)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Supertraits%EF%BC%88%E7%89%B9%E5%BE%81%E7%BB%A7%E6%89%BF%EF%BC%89"><span class="nav-text">Supertraits（特征继承）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%AE%9A%E8%AF%AD%E6%B3%95"><span class="nav-text">完全限定语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E5%B8%B8%E9%87%8F"><span class="nav-text">关联常量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%AE%9E%E7%8E%B0-Blanket-Implementation"><span class="nav-text">条件实现 (Blanket Implementation)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="nav-text">集合类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97"><span class="nav-text">序列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Vec"><span class="nav-text">Vec&lt;T&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VecDeque"><span class="nav-text">VecDeque&lt;T&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LinkedList"><span class="nav-text">LinkedList&lt;T&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="nav-text">对比总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%A0%E5%B0%84"><span class="nav-text">映射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HashMap"><span class="nav-text">HashMap&lt;K, V&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BTreeMap"><span class="nav-text">BTreeMap&lt;K, V&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93-1"><span class="nav-text">对比总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E5%90%88"><span class="nav-text">集合</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HashSet"><span class="nav-text">HashSet&lt;T&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BTreeSet"><span class="nav-text">BTreeSet&lt;T&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E5%AF%B9%E6%AF%94"><span class="nav-text">集合对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BinaryHeap"><span class="nav-text">BinaryHeap&lt;T&gt;</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%AE%9A%E4%B9%89"><span class="nav-text">一句话定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%EF%BC%9F"><span class="nav-text">为什么需要生命周期？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B3%A8%E8%A7%A3%E8%AF%AD%E6%B3%95"><span class="nav-text">生命周期注解语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">函数中的生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF"><span class="nav-text">问题场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%90%86%E8%A7%A3-a-%E7%9A%84%E5%90%AB%E4%B9%89"><span class="nav-text">理解 &#39;a 的含义</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">结构体中的生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9C%81%E7%95%A5%E8%A7%84%E5%88%99"><span class="nav-text">生命周期省略规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E5%BF%85%E9%A1%BB%E6%89%8B%E5%8A%A8%E6%A0%87%E6%B3%A8%EF%BC%9F"><span class="nav-text">何时必须手动标注？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-static"><span class="nav-text">静态生命周期 &#39;static</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%BC%8F%E9%80%9F%E6%9F%A5"><span class="nav-text">常见模式速查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%AD%90%E7%B1%BB%E5%9E%8B"><span class="nav-text">生命周期子类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E4%BF%AE%E5%A4%8D"><span class="nav-text">常见错误与修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B"><span class="nav-text">心智模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97"><span class="nav-text">包和模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%82%E7%BA%A7%E5%85%B3%E7%B3%BB"><span class="nav-text">层级关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Package%EF%BC%88%E5%8C%85%EF%BC%89"><span class="nav-text">Package（包）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module%EF%BC%88%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="nav-text">Module（模块）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BC%8F"><span class="nav-text">定义方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E6%A0%91"><span class="nav-text">模块树</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E4%B8%8E%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="nav-text">路径与可见性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">路径类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7%E8%A7%84%E5%88%99"><span class="nav-text">可见性规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="nav-text">高级可见性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#use-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">use 关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%AF%E7%94%A8%E6%B3%95"><span class="nav-text">惯用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%BC%8F"><span class="nav-text">常见模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%BC%8F"><span class="nav-text">预导入模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AF%BC%E5%87%BA%E7%AE%80%E5%8C%96%E8%B7%AF%E5%BE%84"><span class="nav-text">重导出简化路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E6%A8%A1%E5%9D%97"><span class="nav-text">测试模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="nav-text">速查表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B-1"><span class="nav-text">心智模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA"><span class="nav-text">格式化输出</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%8F%E5%AE%B6%E6%97%8F"><span class="nav-text">核心宏家族</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%8D%A0%E4%BD%8D%E7%AC%A6"><span class="nav-text">基础占位符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E5%BC%95%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">参数引用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E5%80%BC%E6%A0%BC%E5%BC%8F"><span class="nav-text">数值格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%BD%E5%BA%A6%E4%B8%8E%E5%AF%B9%E9%BD%90"><span class="nav-text">宽度与对齐</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%BE%E5%BA%A6%E6%8E%A7%E5%88%B6"><span class="nav-text">精度控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E4%B8%8E%E7%89%B9%E6%AE%8A%E6%A0%BC%E5%BC%8F"><span class="nav-text">符号与特殊格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Debug-%E4%B8%8E-Display-Trait"><span class="nav-text">Debug 与 Display Trait</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%BC%E5%BC%8F%E5%8C%96%E7%BB%86%E8%8A%82"><span class="nav-text">自定义格式化细节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AC%E4%B9%89%E4%B8%8E%E5%8E%9F%E5%A7%8B%E8%BE%93%E5%87%BA"><span class="nav-text">转义与原始输出</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A%E4%B8%8E%E6%96%87%E6%A1%A3"><span class="nav-text">注释与文档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A%E7%B1%BB%E5%9E%8B%E6%80%BB%E8%A7%88"><span class="nav-text">注释类型总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E6%B3%A8%E9%87%8A"><span class="nav-text">普通注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%B3%A8%E9%87%8A"><span class="nav-text">文档注释</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E6%96%87%E6%A1%A3%EF%BC%88%E4%B8%BA%E4%B8%8B%E6%96%B9%E9%A1%B9%E7%94%9F%E6%88%90%E6%96%87%E6%A1%A3%EF%BC%89"><span class="nav-text">&#x2F;&#x2F;&#x2F; 外部文档（为下方项生成文档）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E6%96%87%E6%A1%A3%EF%BC%88%E4%B8%BA%E6%89%80%E5%9C%A8%E9%A1%B9%E7%94%9F%E6%88%90%E6%96%87%E6%A1%A3%EF%BC%89"><span class="nav-text">&#x2F;&#x2F;! 内部文档（为所在项生成文档）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Markdown-%E6%94%AF%E6%8C%81"><span class="nav-text">Markdown 支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%96%87%E6%A1%A3%E8%8A%82%EF%BC%88Sections%EF%BC%89"><span class="nav-text">常用文档节（Sections）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E8%8A%82%E5%90%8D%E7%A7%B0"><span class="nav-text">标准节名称</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%9D%97%E4%B8%8E%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95"><span class="nav-text">代码块与文档测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95"><span class="nav-text">基本文档测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%9D%97%E6%A0%87%E8%AE%B0"><span class="nav-text">代码块标记</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%90%E8%97%8F%E8%BE%85%E5%8A%A9%E4%BB%A3%E7%A0%81"><span class="nav-text">隐藏辅助代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E9%93%BE%E6%8E%A5"><span class="nav-text">文档链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">属性与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#doc-%E5%B1%9E%E6%80%A7"><span class="nav-text">#[doc] 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cargo-toml-%E6%96%87%E6%A1%A3%E9%85%8D%E7%BD%AE"><span class="nav-text">Cargo.toml 文档配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E4%B8%8E%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="nav-text">生成与查看文档</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="nav-text">函数式编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-3"><span class="nav-text">核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AD%E5%8C%85%EF%BC%88Closure%EF%BC%89"><span class="nav-text">闭包（Closure）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-3"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8D%95%E8%8E%B7%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">捕获环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%A7%8D%E6%8D%95%E8%8E%B7%E6%96%B9%E5%BC%8F"><span class="nav-text">三种捕获方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Trait-%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="nav-text">Trait 对应关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#move-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">move 关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AD%E5%8C%85%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0"><span class="nav-text">闭包作为参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AD%E5%8C%85%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-text">闭包作为返回值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8%EF%BC%88Iterator%EF%BC%89"><span class="nav-text">迭代器（Iterator）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Iterator-Trait"><span class="nav-text">Iterator Trait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">创建迭代器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%B0%E6%80%A7%E6%B1%82%E5%80%BC"><span class="nav-text">惰性求值</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8%E9%80%82%E9%85%8D%E5%99%A8%EF%BC%88Adapter%EF%BC%89"><span class="nav-text">迭代器适配器（Adapter）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E9%80%82%E9%85%8D%E5%99%A8"><span class="nav-text">常用适配器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88Consumer%EF%BC%89"><span class="nav-text">消费者（Consumer）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="nav-text">自定义迭代器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%EF%BC%9A%E9%9B%B6%E6%88%90%E6%9C%AC%E6%8A%BD%E8%B1%A1"><span class="nav-text">性能：零成本抽象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E8%BF%AD%E4%BB%A3%E5%99%A8%E6%9B%B4%E5%BF%AB"><span class="nav-text">何时迭代器更快</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%BC%8F-1"><span class="nav-text">常见模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E6%94%B6%E9%9B%86"><span class="nav-text">错误处理收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%BB%84"><span class="nav-text">分组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3-%E5%9D%97%E5%A4%84%E7%90%86"><span class="nav-text">窗口&#x2F;块处理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="nav-text">智能指针</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Box-%E2%80%94-%E5%A0%86%E4%B8%8A%E5%88%86%E9%85%8D"><span class="nav-text">Box&lt;T&gt; — 堆上分配</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Box-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">Box 内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rc-%E2%80%94-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="nav-text">Rc&lt;T&gt; — 引用计数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Rc-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">Rc 内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arc-%E2%80%94-%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="nav-text">Arc&lt;T&gt; — 原子引用计数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Arc-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">Arc 内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rc-vs-Arc-%E5%AF%B9%E6%AF%94"><span class="nav-text">Rc vs Arc 对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RefCell-%E2%80%94-%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-text">RefCell&lt;T&gt; — 内部可变性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RefCell-%E5%80%9F%E7%94%A8%E8%A7%84%E5%88%99"><span class="nav-text">RefCell 借用规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RefCell-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">RefCell 内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-text">线程安全性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cell-%E2%80%94-Copy-%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-text">Cell&lt;T&gt; — Copy 类型的内部可变性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cell-vs-RefCell-%E5%AF%B9%E6%AF%94"><span class="nav-text">Cell vs RefCell 对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Weak-%E2%80%94-%E5%BC%B1%E5%BC%95%E7%94%A8"><span class="nav-text">Weak&lt;T&gt; — 弱引用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#weak-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">weak 内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cow-%E2%80%94-%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6"><span class="nav-text">Cow&lt;T&gt; — 写时复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cow-%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80"><span class="nav-text">Cow 内存布局</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E4%B8%8E%E6%95%B0%E6%8D%AE%E9%87%8A%E6%94%BE"><span class="nav-text">引用计数与数据释放</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Rust-%E4%B8%AD%E7%94%A8%E5%88%B0%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">Rust 中用到引用计数的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80-4"><span class="nav-text">内存布局</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E6%95%B0%E5%8F%98%E5%8C%96%E8%A7%84%E5%88%99"><span class="nav-text">计数变化规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8A%E6%94%BE%E6%97%B6%E6%9C%BA"><span class="nav-text">释放时机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8A%E6%94%BE%E8%BF%87%E7%A8%8B%E6%BC%94%E7%A4%BA"><span class="nav-text">释放过程演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stong-0-weak-0"><span class="nav-text">stong&#x3D;0,weak&gt;0</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E5%AF%B9%E6%AF%94"><span class="nav-text">智能指针对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%86%B3%E7%AD%96%E6%B5%81%E7%A8%8B"><span class="nav-text">选择决策流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8-Cyclic-References"><span class="nav-text">循环引用 (Cyclic References)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%9C%AC%E8%B4%A8"><span class="nav-text">问题本质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Rc-%E5%AF%BC%E8%87%B4%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F"><span class="nav-text">Rc 导致的内存泄漏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9AWeak"><span class="nav-text">解决方案：Weak</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%BC%95%E7%94%A8-Self-Referential-Structs"><span class="nav-text">自引用 (Self-Referential Structs)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%9C%AC%E8%B4%A8-1"><span class="nav-text">问题本质</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-text">解决方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E7%B1%BB%E5%9E%8B"><span class="nav-text">深入类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#dyn-trait"><span class="nav-text">dyn trait</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E5%8F%91-vs-%E5%8A%A8%E6%80%81%E5%88%86%E5%8F%91"><span class="nav-text">静态分发 vs 动态分发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Trait-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-text">Trait 对象的内存结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-dyn-Trait"><span class="nav-text">为什么需要 dyn Trait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AE%89%E5%85%A8%EF%BC%88Object-Safety%EF%BC%89"><span class="nav-text">对象安全（Object Safety）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84-dyn-Trait-%E7%94%A8%E6%B3%95"><span class="nav-text">常见的 dyn Trait 用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sized-%E4%B8%8E%E5%8A%A8%E6%80%81%E5%A4%A7%E5%B0%8F%E7%B1%BB%E5%9E%8B-DST"><span class="nav-text">Sized 与动态大小类型 (DST)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sized-Trait-%E5%9F%BA%E7%A1%80"><span class="nav-text">Sized Trait 基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%A4%A7%E5%B0%8F%E5%88%86%E7%B1%BB"><span class="nav-text">类型大小分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DST-%E4%B8%8E%E8%83%96%E6%8C%87%E9%92%88"><span class="nav-text">DST 与胖指针</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sized-%E7%BA%A6%E6%9D%9F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">?Sized 约束的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E4%B8%AD%E7%9A%84-DST"><span class="nav-text">结构体中的 DST</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%B6%E5%A4%A7%E5%B0%8F%E7%B1%BB%E5%9E%8B-ZST"><span class="nav-text">零大小类型 (ZST)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZST-%E7%B1%BB%E5%9E%8B%E7%A4%BA%E4%BE%8B"><span class="nav-text">ZST 类型示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PhantomData-%E7%94%A8%E9%80%94"><span class="nav-text">PhantomData 用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PhantomData-%E5%8F%98%E4%BD%93"><span class="nav-text">PhantomData 变体</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Newtype-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Newtype 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9A%E4%B9%89"><span class="nav-text">基本定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%94%A8%E9%80%94"><span class="nav-text">核心用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Newtype-%E4%BE%BF%E6%8D%B7%E5%AE%9E%E7%8E%B0"><span class="nav-text">Newtype 便捷实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-derive-more-%E7%AE%80%E5%8C%96"><span class="nav-text">使用 derive_more 简化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D"><span class="nav-text">类型别名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-4"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%88%AB%E5%90%8D%E5%B8%B8%E8%A7%81%E7%94%A8%E9%80%94"><span class="nav-text">类型别名常见用途</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2-1"><span class="nav-text">类型转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#as-%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">as 强制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#From-Into-trait"><span class="nav-text">From&#x2F;Into trait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TryFrom-TryInto%EF%BC%88%E5%8F%AF%E8%83%BD%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%BD%AC%E6%8D%A2%EF%BC%89"><span class="nav-text">TryFrom&#x2F;TryInto（可能失败的转换）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AsRef-AsMut%EF%BC%88%E5%BB%89%E4%BB%B7%E5%BC%95%E7%94%A8%E8%BD%AC%E6%8D%A2%EF%BC%89"><span class="nav-text">AsRef&#x2F;AsMut（廉价引用转换）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Borrow-BorrowMut"><span class="nav-text">Borrow&#x2F;BorrowMut</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deref-%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2-1"><span class="nav-text">Deref 强制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E6%80%BB%E7%BB%93"><span class="nav-text">类型转换总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6%E6%A8%A1%E5%BC%8F"><span class="nav-text">进阶模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F%EF%BC%88Typestate-Pattern%EF%BC%89"><span class="nav-text">类型状态模式（Typestate Pattern）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%8F%E6%98%8E-Newtype"><span class="nav-text">透明 Newtype</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%8F%AF%E6%9E%84%E9%80%A0%E7%B1%BB%E5%9E%8B"><span class="nav-text">不可构造类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E5%AF%B9%E6%AF%94"><span class="nav-text">核心概念对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%EF%BC%9Aconst-vs-static"><span class="nav-text">基础：const vs static</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%EF%BC%88%E5%8D%B1%E9%99%A9%E5%8C%BA%E5%9F%9F%EF%BC%89"><span class="nav-text">可变全局变量（危险区域）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#static-mut%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">static mut（不推荐）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%A1%88"><span class="nav-text">安全的运行时初始化方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#std-sync-OnceLock"><span class="nav-text">std::sync::OnceLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lazy-static"><span class="nav-text">lazy_static!</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#once-cell"><span class="nav-text">once_cell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E5%8F%AF%E5%8F%98%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">线程安全的可变全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mutex-%E6%96%B9%E6%A1%88"><span class="nav-text">Mutex 方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RwLock"><span class="nav-text">RwLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E7%B1%BB%E5%9E%8B"><span class="nav-text">原子类型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-text">方案选择流程图</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="nav-text">多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%80%BB%E8%A7%88"><span class="nav-text">核心概念总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80"><span class="nav-text">线程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%8E%E7%AD%89%E5%BE%85"><span class="nav-text">创建与等待</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#move-%E9%97%AD%E5%8C%85-%E2%80%94%E2%80%94-%E8%BD%AC%E7%A7%BB%E6%89%80%E6%9C%89%E6%9D%83"><span class="nav-text">move 闭包 —— 转移所有权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E9%85%8D%E7%BD%AE"><span class="nav-text">线程配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92%EF%BC%88Channel%EF%BC%89"><span class="nav-text">消息传递（Channel）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85%E5%8D%95%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88mpsc%EF%BC%89"><span class="nav-text">多生产者单消费者（mpsc）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-text">多生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E9%80%9A%E9%81%93%EF%BC%88%E6%9C%89%E7%95%8C%EF%BC%89"><span class="nav-text">同步通道（有界）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Channel-%E6%96%B9%E6%B3%95%E5%AF%B9%E6%AF%94"><span class="nav-text">Channel 方法对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E7%8A%B6%E6%80%81"><span class="nav-text">共享状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Arc-Mutex"><span class="nav-text">Arc + Mutex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RwLock-1"><span class="nav-text">RwLock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%81%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">锁的注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-text">原子操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ordering-%E8%AF%B4%E6%98%8E"><span class="nav-text">Ordering 说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%8E%9F%E8%AF%AD"><span class="nav-text">同步原语</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Barrier%EF%BC%88%E5%B1%8F%E9%9A%9C%EF%BC%89"><span class="nav-text">Barrier（屏障）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Condvar%EF%BC%88%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%EF%BC%89"><span class="nav-text">Condvar（条件变量）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%88Rayon%EF%BC%89"><span class="nav-text">线程池（Rayon）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Send-%E5%92%8C-Sync"><span class="nav-text">Send 和 Sync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%BC%8F-2"><span class="nav-text">常见模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-text">生产者-消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%AA%83%E5%8F%96%E6%A8%A1%E5%BC%8F%EF%BC%88crossbeam%EF%BC%89"><span class="nav-text">工作窃取模式（crossbeam）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94"><span class="nav-text">总结对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="nav-text">多进程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%80%BB%E8%A7%88-1"><span class="nav-text">核心概念总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B"><span class="nav-text">创建子进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">简单执行命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BE%93%E5%87%BA"><span class="nav-text">获取输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3"><span class="nav-text">命令构建详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Stdio-%E6%8E%A7%E5%88%B6"><span class="nav-text">Stdio 控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91%E9%85%8D%E7%BD%AE"><span class="nav-text">重定向配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1%E9%81%93%E9%80%9A%E4%BF%A1"><span class="nav-text">管道通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%AE%A1%E9%81%93%E9%93%BE"><span class="nav-text">进程管道链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E7%AE%A1%E9%81%93%EF%BC%88%E7%B1%BB%E4%BC%BC-shell-%EF%BC%89"><span class="nav-text">命令管道（类似 shell |）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%81%E8%A3%85%E7%AE%A1%E9%81%93%E5%87%BD%E6%95%B0"><span class="nav-text">封装管道函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%90%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="nav-text">子进程管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Child-%E5%8F%A5%E6%9F%84%E6%93%8D%E4%BD%9C"><span class="nav-text">Child 句柄操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%89%A7%E8%A1%8C"><span class="nav-text">超时执行</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%EF%BC%88IPC%EF%BC%89"><span class="nav-text">进程间通信（IPC）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%BF%E5%90%8D%E7%AE%A1%E9%81%93%EF%BC%88%E7%88%B6%E5%AD%90%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="nav-text">匿名管道（父子进程）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%EF%BC%88FIFO%EF%BC%89-Unix"><span class="nav-text">命名管道（FIFO）- Unix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="nav-text">共享内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unix-Domain-Socket"><span class="nav-text">Unix Domain Socket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPC-%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="nav-text">IPC 方案对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86"><span class="nav-text">信号处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ctrlc-%E5%BA%93"><span class="nav-text">使用 ctrlc 库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-signal-hook-%E5%BA%93"><span class="nav-text">使用 signal-hook 库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7%E7%BB%99%E5%AD%90%E8%BF%9B%E7%A8%8B"><span class="nav-text">发送信号给子进程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">守护进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-daemonize-%E5%BA%93"><span class="nav-text">使用 daemonize 库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%B1%A0%E6%A8%A1%E5%BC%8F"><span class="nav-text">进程池模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="nav-text">实用工具函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94-1"><span class="nav-text">总结对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B"><span class="nav-text">异步编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%80%BB%E8%A7%88-2"><span class="nav-text">核心概念总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E5%BA%93%E5%86%85%E7%BD%AE%E6%94%AF%E6%8C%81"><span class="nav-text">标准库内置支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Future-Trait%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="nav-text">Future Trait（核心）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#async-await-%E8%AF%AD%E6%B3%95"><span class="nav-text">async&#x2F;await 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%83%B0%E6%80%A7%E6%89%A7%E8%A1%8C%E7%89%B9%E6%80%A7"><span class="nav-text">惰性执行特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Runtime"><span class="nav-text">为什么需要 Runtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tokio-%E8%AF%A6%E8%A7%A3"><span class="nav-text">Tokio 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E7%BD%AE"><span class="nav-text">基础设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="nav-text">入口点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%94%9F%E6%88%90-spawn"><span class="nav-text">任务生成 (spawn)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%BC%82%E6%AD%A5%E5%8E%9F%E8%AF%AD"><span class="nav-text">核心异步原语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5-I-O"><span class="nav-text">异步 I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="nav-text">文件操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%A8%A1%E5%BC%8F"><span class="nav-text">并发控制模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E5%8F%91-vs-%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C"><span class="nav-text">并发 vs 顺序执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Select-%E7%94%A8%E6%B3%95"><span class="nav-text">Select 用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1"><span class="nav-text">常见陷阱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E9%9C%80%E8%A6%81-Lock-%E5%92%8C-Mutex"><span class="nav-text">为什么异步编程需要 Lock 和 Mutex</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8E%9F%E5%9B%A0%E5%9B%BE%E8%A7%A3"><span class="nav-text">核心原因图解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E5%9C%BA%E6%99%AF%E6%BC%94%E7%A4%BA"><span class="nav-text">具体场景演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5%E5%8C%BA%E5%88%86"><span class="nav-text">关键概念区分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#await-%E7%9A%84%E5%8D%B1%E9%99%A9%E6%80%A7"><span class="nav-text">await 的危险性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E9%9C%80%E8%A6%81-%E4%B8%8D%E9%9C%80%E8%A6%81%E9%94%81"><span class="nav-text">何时需要&#x2F;不需要锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#std-sync-Mutex-vs-tokio-sync-Mutex"><span class="nav-text">std::sync::Mutex vs tokio::sync::Mutex</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94%E8%A1%A8"><span class="nav-text">总结对比表</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="nav-text">网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%9E%B6%E6%9E%84"><span class="nav-text">核心概念架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E5%BA%93%E5%90%8C%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-std-net"><span class="nav-text">标准库同步网络编程 (std::net)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">TCP 服务端&#x2F;客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UDP-%E9%80%9A%E4%BF%A1"><span class="nav-text">UDP 通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="nav-text">异步网络编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cargo-toml-%E9%85%8D%E7%BD%AE"><span class="nav-text">Cargo.toml 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5-TCP-%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">异步 TCP 服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5-TCP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">异步 TCP 客户端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">HTTP 客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">Web 服务器框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebSocket"><span class="nav-text">WebSocket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="nav-text">关键对比总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%80%81%E5%BA%93%E6%8E%A8%E8%8D%90"><span class="nav-text">生态库推荐</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C-1"><span class="nav-text">文件操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E6%9E%B6%E6%9E%84-1"><span class="nav-text">核心概念架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99"><span class="nav-text">快速文件读写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-%E7%BB%93%E6%9E%84%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="nav-text">File 结构体操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%BC%80%E5%92%8C%E5%88%9B%E5%BB%BA%E6%96%87%E4%BB%B6"><span class="nav-text">打开和创建文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96%E6%93%8D%E4%BD%9C"><span class="nav-text">读取操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E6%93%8D%E4%BD%9C"><span class="nav-text">写入操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8C%87%E9%92%88%E5%AE%9A%E4%BD%8D-Seek"><span class="nav-text">文件指针定位 (Seek)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84%E6%93%8D%E4%BD%9C-Path-PathBuf"><span class="nav-text">路径操作 (Path&#x2F;PathBuf)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="nav-text">目录操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%85%83%E6%95%B0%E6%8D%AE"><span class="nav-text">文件元数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%93%8D%E4%BD%9C"><span class="nav-text">文件系统操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C-Tokio"><span class="nav-text">异步文件操作 (Tokio)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E5%BA%93"><span class="nav-text">实用工具库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#walkdir-%E9%80%92%E5%BD%92%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="nav-text">walkdir - 递归目录遍历</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#glob-%E6%96%87%E4%BB%B6%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="nav-text">glob - 文件模式匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tempfile-%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6"><span class="nav-text">tempfile - 临时文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-1"><span class="nav-text">错误处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B"><span class="nav-text">数据库编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%94%9F%E6%80%81%E6%9E%B6%E6%9E%84"><span class="nav-text">核心生态架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQLx-%E5%BC%82%E6%AD%A5-SQL-%E5%B7%A5%E5%85%B7%E5%BA%93"><span class="nav-text">SQLx - 异步 SQL 工具库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE"><span class="nav-text">项目配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E4%B8%8E%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="nav-text">连接与连接池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC-CRUD-%E6%93%8D%E4%BD%9C"><span class="nav-text">基本 CRUD 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%97%B6%E6%A3%80%E6%9F%A5%E5%AE%8F"><span class="nav-text">编译时检查宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86"><span class="nav-text">事务处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Diesel-%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8-ORM"><span class="nav-text">Diesel - 类型安全 ORM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-1"><span class="nav-text">项目配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-text">初始化项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%81%E7%A7%BB%E6%96%87%E4%BB%B6"><span class="nav-text">迁移文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Schema-%E5%92%8C%E6%A8%A1%E5%9E%8B"><span class="nav-text">Schema 和模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRUD-%E6%93%8D%E4%BD%9C"><span class="nav-text">CRUD 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1"><span class="nav-text">事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SeaORM-%E5%BC%82%E6%AD%A5-ORM"><span class="nav-text">SeaORM - 异步 ORM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AE-2"><span class="nav-text">项目配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Entity-%E5%AE%9A%E4%B9%89"><span class="nav-text">Entity 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRUD-%E6%93%8D%E4%BD%9C-1"><span class="nav-text">CRUD 操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQLite"><span class="nav-text">SQLite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis"><span class="nav-text">Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MongoDB"><span class="nav-text">MongoDB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E7%AE%A1%E7%90%86"><span class="nav-text">数据库迁移管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQLx-%E8%BF%81%E7%A7%BB"><span class="nav-text">SQLx 迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Diesel-%E8%BF%81%E7%A7%BB"><span class="nav-text">Diesel 迁移</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E5%AF%B9%E6%AF%94-2"><span class="nav-text">总结对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Unsafe-%E7%BC%96%E7%A8%8B"><span class="nav-text">Unsafe 编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5-4"><span class="nav-text">核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafe-%E4%B8%8D%E6%84%8F%E5%91%B3%E7%9D%80%E4%BB%80%E4%B9%88"><span class="nav-text">unsafe 不意味着什么</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A3%B8%E6%8C%87%E9%92%88-Raw-Pointers"><span class="nav-text">裸指针 (Raw Pointers)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E9%92%88%E7%AE%97%E6%9C%AF"><span class="nav-text">指针算术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E9%92%88%E4%B8%8E%E5%88%87%E7%89%87%E8%BD%AC%E6%8D%A2"><span class="nav-text">指针与切片转换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafe-%E5%87%BD%E6%95%B0%E4%B8%8E%E6%96%B9%E6%B3%95"><span class="nav-text">Unsafe 函数与方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%92%8C%E8%B0%83%E7%94%A8"><span class="nav-text">定义和调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unsafe-trait"><span class="nav-text">unsafe trait</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F%E4%B8%8E%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-text">静态变量与内部可变性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E5%8F%98%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F"><span class="nav-text">可变静态变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%83%A8%E9%9D%99%E6%80%81%E5%8F%98%E9%87%8F"><span class="nav-text">外部静态变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Union-%E7%B1%BB%E5%9E%8B"><span class="nav-text">Union 类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FFI%EF%BC%88%E5%A4%96%E9%83%A8%E5%87%BD%E6%95%B0%E6%8E%A5%E5%8F%A3%EF%BC%89"><span class="nav-text">FFI（外部函数接口）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-C-%E5%87%BD%E6%95%B0"><span class="nav-text">调用 C 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E5%A4%96%E9%83%A8%E5%BA%93"><span class="nav-text">链接外部库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9A%B4%E9%9C%B2-Rust-%E5%87%BD%E6%95%B0%E7%BB%99-C"><span class="nav-text">暴露 Rust 函数给 C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%A0%E9%80%92"><span class="nav-text">复杂数据结构传递</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96"><span class="nav-text">内联汇编</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E6%8E%A7%E5%88%B6"><span class="nav-text">内存布局控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#repr-%E5%B1%9E%E6%80%A7"><span class="nav-text">repr 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">手动内存管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81-Unsafe-%E6%A8%A1%E5%BC%8F"><span class="nav-text">常见 Unsafe 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%BC%95%E7%94%A8%E7%BB%93%E6%9E%84"><span class="nav-text">自引用结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-text">内部可变性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%B5%E5%85%A5%E5%BC%8F%E9%93%BE%E8%A1%A8"><span class="nav-text">侵入式链表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unsafe-%E5%AE%9E%E8%B7%B5"><span class="nav-text">Unsafe 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96-unsafe-%E8%8C%83%E5%9B%B4"><span class="nav-text">最小化 unsafe 范围</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E5%8C%96%E5%AE%89%E5%85%A8%E7%BA%A6%E6%9D%9F"><span class="nav-text">文档化安全约束</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-debug-assert"><span class="nav-text">使用 debug_assert</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%8A%BD%E8%B1%A1%E6%A8%A1%E5%BC%8F"><span class="nav-text">安全抽象模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5%E8%A1%A8-1"><span class="nav-text">速查表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0"><span class="nav-text">关键函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Macro-%E5%AE%8F%E7%BC%96%E7%A8%8B"><span class="nav-text">Macro 宏编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8F%E7%B3%BB%E7%BB%9F%E6%A6%82%E8%A7%88"><span class="nav-text">宏系统概览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8F-vs-%E5%87%BD%E6%95%B0"><span class="nav-text">宏 vs 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%AE%8F-macro-rules"><span class="nav-text">声明宏 (macro_rules!)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-text">基础语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%83%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B-Fragment-Specifiers"><span class="nav-text">元变量类型 (Fragment Specifiers)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E6%A8%A1%E5%BC%8F"><span class="nav-text">重复模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E5%AE%8F%E7%A4%BA%E4%BE%8B"><span class="nav-text">实用宏示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%BD%92%E5%AE%8F"><span class="nav-text">递归宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8F%E7%9A%84%E5%8D%AB%E7%94%9F%E6%80%A7-Hygiene"><span class="nav-text">宏的卫生性 (Hygiene)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%E5%AE%8F-Procedural-Macros"><span class="nav-text">过程宏 (Procedural Macros)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%BC%8F%E8%BF%87%E7%A8%8B%E5%AE%8F"><span class="nav-text">函数式过程宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Derive-%E5%AE%8F"><span class="nav-text">Derive 宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%AE%8F"><span class="nav-text">属性宏</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#syn-%E5%92%8C-quote-%E6%B7%B1%E5%85%A5"><span class="nav-text">syn 和 quote 深入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#syn-%E8%A7%A3%E6%9E%90-Rust-%E4%BB%A3%E7%A0%81"><span class="nav-text">syn - 解析 Rust 代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quote-%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81"><span class="nav-text">quote - 生成代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E7%BA%A7%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%8A%80%E5%B7%A7"><span class="nav-text">高级模式与技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TT-Muncher%EF%BC%88Token-%E5%92%80%E5%9A%BC%E5%99%A8%EF%BC%89"><span class="nav-text">TT Muncher（Token 咀嚼器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Push-Down-Accumulator%EF%BC%88%E4%B8%8B%E6%8E%A8%E7%B4%AF%E5%8A%A0%E5%99%A8%EF%BC%89"><span class="nav-text">Push-Down Accumulator（下推累加器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E9%83%A8%E8%A7%84%E5%88%99%E6%A8%A1%E5%BC%8F"><span class="nav-text">内部规则模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Callback-%E6%A8%A1%E5%BC%8F"><span class="nav-text">Callback 模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E5%AE%8F"><span class="nav-text">调试宏</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%95%E5%BC%80%E5%AE%8F"><span class="nav-text">展开宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%97%B6%E8%B0%83%E8%AF%95"><span class="nav-text">编译时调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%E5%AE%8F%E8%B0%83%E8%AF%95"><span class="nav-text">过程宏调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B"><span class="nav-text">实战示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%9A%84-Derive-%E5%AE%8F%EF%BC%9A%E8%87%AA%E5%8A%A8%E5%AE%9E%E7%8E%B0-From"><span class="nav-text">完整的 Derive 宏：自动实现 From</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DSL%EF%BC%9A%E6%9F%A5%E8%AF%A2%E6%9E%84%E5%BB%BA%E5%99%A8"><span class="nav-text">DSL：查询构建器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%AE%89%E5%85%A8%E7%9A%84-HTML-%E6%9E%84%E5%BB%BA%E5%99%A8"><span class="nav-text">类型安全的 HTML 构建器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%AE%8F-Crate"><span class="nav-text">常用宏 Crate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#darling-%E7%A4%BA%E4%BE%8B"><span class="nav-text">darling 示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5%E8%A1%A8-2"><span class="nav-text">速查表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%AE%8F%E5%85%83%E5%8F%98%E9%87%8F"><span class="nav-text">声明宏元变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E7%AC%A6%E5%8F%B7"><span class="nav-text">重复符号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B%E5%AE%8F%E7%B1%BB%E5%9E%8B"><span class="nav-text">过程宏类型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-text">自动化测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%93%E7%B3%BB%E6%A6%82%E8%A7%88"><span class="nav-text">测试体系概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80"><span class="nav-text">单元测试基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-5"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%AD%E8%A8%80%E5%AE%8F"><span class="nav-text">断言宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%B1%9E%E6%80%A7"><span class="nav-text">测试属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%A7%81%E6%9C%89%E5%87%BD%E6%95%B0"><span class="nav-text">测试私有函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95"><span class="nav-text">集成测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E6%B5%8B%E8%AF%95%E8%BE%85%E5%8A%A9%E4%BB%A3%E7%A0%81"><span class="nav-text">共享测试辅助代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E7%9B%AE%E5%BD%95%E7%BB%84%E7%BB%87"><span class="nav-text">子目录组织</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95"><span class="nav-text">文档测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95-1"><span class="nav-text">基本文档测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95%E5%B1%9E%E6%80%A7"><span class="nav-text">文档测试属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E6%B5%8B%E8%AF%95%E4%B8%AD%E4%BD%BF%E7%94%A8-%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-text">文档测试中使用 ? 操作符</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-text">运行测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cargo-test-%E5%91%BD%E4%BB%A4"><span class="nav-text">cargo test 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%87%E6%BB%A4"><span class="nav-text">测试过滤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E6%B5%8B%E8%AF%95"><span class="nav-text">异步测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-tokio"><span class="nav-text">使用 tokio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-async-std"><span class="nav-text">使用 async-std</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%BC%82%E6%AD%A5%E6%B5%81"><span class="nav-text">测试异步流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%84%E7%BB%87%E4%B8%8E%E6%A8%A1%E5%BC%8F"><span class="nav-text">测试组织与模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Setup-%E5%92%8C-Teardown"><span class="nav-text">Setup 和 Teardown</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test-Fixtures"><span class="nav-text">Test Fixtures</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Builder-%E6%A8%A1%E5%BC%8F%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-text">Builder 模式测试数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mocking-%E5%92%8C%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="nav-text">Mocking 和依赖注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Trait-%E6%8A%BD%E8%B1%A1%E5%92%8C%E6%89%8B%E5%8A%A8-Mock"><span class="nav-text">Trait 抽象和手动 Mock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-mockall-crate"><span class="nav-text">使用 mockall crate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-mock-derive"><span class="nav-text">使用 mock_derive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95"><span class="nav-text">参数化测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-test-case-crate"><span class="nav-text">使用 test-case crate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-rstest-crate"><span class="nav-text">使用 rstest crate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E5%8F%82%E6%95%B0%E5%8C%96"><span class="nav-text">手动参数化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E6%B5%8B%E8%AF%95-Property-Based-Testing"><span class="nav-text">属性测试 (Property-Based Testing)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-proptest"><span class="nav-text">使用 proptest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-quickcheck"><span class="nav-text">使用 quickcheck</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95-Fuzzing"><span class="nav-text">模糊测试 (Fuzzing)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-cargo-fuzz"><span class="nav-text">使用 cargo-fuzz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-arbitrary"><span class="nav-text">使用 arbitrary</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-text">基准测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%EF%BC%88nightly%EF%BC%89"><span class="nav-text">内置基准测试（nightly）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-criterion"><span class="nav-text">使用 criterion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87"><span class="nav-text">代码覆盖率</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-cargo-tarpaulin"><span class="nav-text">使用 cargo-tarpaulin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-llvm-cov"><span class="nav-text">使用 llvm-cov</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CI-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-text">CI 配置示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CI-CD-%E9%9B%86%E6%88%90"><span class="nav-text">CI&#x2F;CD 集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GitHub-Actions-%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE"><span class="nav-text">GitHub Actions 完整配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-text">测试命名规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%84%E7%BB%87"><span class="nav-text">测试组织</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%9A%94%E7%A6%BB"><span class="nav-text">测试隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"><span class="nav-text">错误信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5%E8%A1%A8-3"><span class="nav-text">速查表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%B1%9E%E6%80%A7-1"><span class="nav-text">测试属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%AD%E8%A8%80%E5%AE%8F-1"><span class="nav-text">断言宏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%B5%8B%E8%AF%95-Crate"><span class="nav-text">常用测试 Crate</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cargo"><span class="nav-text">Cargo</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%A7%88"><span class="nav-text">概览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="nav-text">基础命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86"><span class="nav-text">项目管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%92%8C%E6%96%87%E6%A1%A3"><span class="nav-text">测试和文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="nav-text">依赖管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83"><span class="nav-text">发布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%AE%9E%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">其他实用命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cargo-toml-%E8%AF%A6%E8%A7%A3"><span class="nav-text">Cargo.toml 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84-1"><span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE"><span class="nav-text">依赖配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E8%A7%84%E8%8C%83"><span class="nav-text">版本规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Features-%E9%85%8D%E7%BD%AE"><span class="nav-text">Features 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Profiles-%E9%85%8D%E7%BD%AE"><span class="nav-text">Profiles 配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4-Workspace"><span class="nav-text">工作空间 (Workspace)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84-2"><span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E9%85%8D%E7%BD%AE"><span class="nav-text">工作空间配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E5%91%98-crate-%E9%85%8D%E7%BD%AE"><span class="nav-text">成员 crate 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E5%91%BD%E4%BB%A4"><span class="nav-text">工作空间命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC-build-rs"><span class="nav-text">构建脚本 (build.rs)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84-3"><span class="nav-text">基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="nav-text">常用指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">实用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E8%84%9A%E6%9C%AC%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">构建脚本环境变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cargo-config-toml"><span class="nav-text">.cargo&#x2F;config.toml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">环境变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cargo-%E6%89%A9%E5%B1%95%E5%B7%A5%E5%85%B7"><span class="nav-text">Cargo 扩展工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%89%A9%E5%B1%95"><span class="nav-text">常用扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cargo-watch"><span class="nav-text">cargo-watch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cargo-make"><span class="nav-text">cargo-make</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cargo-release"><span class="nav-text">cargo-release</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E5%88%B0-crates-io"><span class="nav-text">发布到 crates.io</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E5%89%8D%E6%A3%80%E6%9F%A5"><span class="nav-text">发布前检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B"><span class="nav-text">发布流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E5%8F%91%E5%B8%83"><span class="nav-text">文档发布</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E5%BC%8F-3"><span class="nav-text">常见模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91"><span class="nav-text">条件编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%B9%B3%E5%8F%B0%E6%94%AF%E6%8C%81"><span class="nav-text">多平台支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE%E7%BB%84%E7%BB%87"><span class="nav-text">示例项目组织</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xtask-%E6%A8%A1%E5%BC%8F"><span class="nav-text">xtask 模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9F%E6%9F%A5%E8%A1%A8-4"><span class="nav-text">速查表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-1"><span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%A0%87%E5%BF%97"><span class="nav-text">常用标志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-1"><span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6"><span class="nav-text">文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#no-std-%E7%BC%96%E7%A8%8B"><span class="nav-text">no_std 编程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E6%A6%82%E8%A7%88"><span class="nav-text">概念概览</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#std-vs-no-std-%E5%AF%B9%E6%AF%94"><span class="nav-text">std vs no_std 对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80-no-std-%E9%A1%B9%E7%9B%AE"><span class="nav-text">基础 no_std 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%B0%8F%E7%A4%BA%E4%BE%8B"><span class="nav-text">最小示例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#core-%E5%BA%93%E8%AF%A6%E8%A7%A3"><span class="nav-text">core 库详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%92%8C-trait"><span class="nav-text">可用类型和 trait</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA%EF%BC%88%E6%97%A0-println-%EF%BC%89"><span class="nav-text">格式化输出（无 println!）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C-1"><span class="nav-text">原子操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alloc-%E5%BA%93%E4%BD%BF%E7%94%A8"><span class="nav-text">alloc 库使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E7%94%A8-alloc"><span class="nav-text">启用 alloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-text">全局分配器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89%E5%88%86%E9%85%8D%E5%99%A8"><span class="nav-text">使用现有分配器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Panic-%E5%A4%84%E7%90%86"><span class="nav-text">Panic 处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC-panic-handler"><span class="nav-text">基本 panic handler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%87%BA-panic-%E4%BF%A1%E6%81%AF"><span class="nav-text">输出 panic 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#panic-%E2%80%9Cabort%E2%80%9D-%E9%85%8D%E7%BD%AE"><span class="nav-text">panic &#x3D; “abort” 配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91"><span class="nav-text">嵌入式开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84-1"><span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cortex-M-%E7%A4%BA%E4%BE%8B"><span class="nav-text">Cortex-M 示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RISC-V-%E7%A4%BA%E4%BE%8B"><span class="nav-text">RISC-V 示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPIO-%E6%93%8D%E4%BD%9C%E7%A4%BA%E4%BE%8B%EF%BC%88embedded-hal%EF%BC%89"><span class="nav-text">GPIO 操作示例（embedded-hal）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86"><span class="nav-text">中断处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A3%B8%E6%9C%BA-OS-%E5%BC%80%E5%8F%91"><span class="nav-text">裸机&#x2F;OS 开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%A3%B8%E6%9C%BA%E7%A8%8B%E5%BA%8F%EF%BC%88x86-64%EF%BC%89"><span class="nav-text">基本裸机程序（x86_64）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VGA-%E6%96%87%E6%9C%AC%E7%BC%93%E5%86%B2%E5%8C%BA%E6%8A%BD%E8%B1%A1"><span class="nav-text">VGA 文本缓冲区抽象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-text">简单内存管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8-no-std-Crate"><span class="nav-text">常用 no_std Crate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%B7%A5%E5%85%B7"><span class="nav-text">核心工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#heapless-%E7%A4%BA%E4%BE%8B"><span class="nav-text">heapless 示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#embedded-hal-%E7%94%9F%E6%80%81"><span class="nav-text">embedded-hal 生态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#defmt-%E6%97%A5%E5%BF%97"><span class="nav-text">defmt 日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-no-std-%E4%BB%A3%E7%A0%81"><span class="nav-text">测试 no_std 代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E6%9C%BA%E6%B5%8B%E8%AF%95"><span class="nav-text">主机测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QEMU-%E6%B5%8B%E8%AF%95"><span class="nav-text">QEMU 测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-probe-rs-%E6%B5%8B%E8%AF%95"><span class="nav-text">使用 probe-rs 测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-text">优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%8F%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%A4%A7%E5%B0%8F"><span class="nav-text">减小二进制大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%B6%E6%88%90%E6%9C%AC%E6%8A%BD%E8%B1%A1"><span class="nav-text">零成本抽象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90%E4%BC%98%E5%8C%96"><span class="nav-text">内存对齐优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E5%8F%98%E5%8C%96"><span class="nav-text">版本更新变化</span></a></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
            <div class="customize-info my-1">关山初度尘未洗，策马扬鞭再奋蹄。</div>
        
        <div class="text-center">
            &copy;
            
              <span>2023</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-circle-info fa-beat-fade" style="--fa-beat-fade-opacity: 0.67; --fa-beat-fade-scale: 1.075;" ></i>&nbsp;&nbsp;<a href="/">韩乔落</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        125 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Swup.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupSlideTheme.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScriptsPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupProgressPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupScrollPlugin.min.js" ></script><script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/SwupPreloadPlugin.min.js" ></script>
<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/imageViewer.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/utils.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/main.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/navbarShrink.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/scrollTopBottom.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/lightDarkSwitch.js" ></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/categoryList.js" ></script>


    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/localSearch.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/codeBlock.js" ></script>



    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/lazyload.js" ></script>



    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/runtime.js" ></script>
    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/odometer.min.js" ></script>
    <link rel="stylesheet" href="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/assets/odometer-theme-minimal.css">



  <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/Typed.min.js" ></script>
  <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/typed.js" ></script>







    <script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/anime.min.js" ></script>




    <script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/tools/tocToggle.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/toc.js" data-swup-reload-script></script><script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/plugins/tabs.js" data-swup-reload-script></script>


<script  src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/libs/moment-with-locales.min.js" data-swup-reload-script></script>
<script type="module" src="https://registry.npmmirror.com/hexo-theme-redefine/2.8.5/files/source/js/build/layouts/essays.js" data-swup-reload-script></script>




	
</body>

</html>